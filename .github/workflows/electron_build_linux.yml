name: Electron build linux
on: workflow_dispatch 
jobs:
  electron_build:
    timeout-minutes: 20
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-node@v3
      with:
        node-version: 20

    - name: Install dependencies, build and test
      run: |
        sudo apt-get update && \
        cd electron && npm run build-linux
      
    - name: Install dependencies for testing
      run: | 
        sudo apt-get update
        cd electron && sudo apt-get install -y x11-xserver-utils xterm imagemagick-6.q16 scrot libnotify4  libnss3-dev libatk1.0-0 libatk-bridge2.0-0 libgdk-pixbuf2.0-0 libgtk-3-0 gconf-service gconf2
        DEBIAN_FRONTEND=noninteractive sudo apt install -y x11-apps imagemagick xvfb gdebi-core lightdm ubuntu-desktop
        reboot
    - name: Install the app
      run: | 
        cd electron
        sudo dpkg -i ./dist/Prostgles\ Desktop-1.0.0-amd64.deb
    - name: Test installation file
      run: | 
        uname -a
        cd electron
        prostgles-desktop & \
        echo "Waiting for 10 seconds for the app to start" 
        sleep 10
        scrot ./dist/screenshot.png 
    - uses: actions/upload-artifact@v4
      if: always()
      with:
        name: installers
        path: electron/dist
        retention-days: 10