name: Electron build linux
on: workflow_dispatch 
jobs:
  electron_build:
    timeout-minutes: 20
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-node@v3
      with:
        node-version: 20

    - name: Install dependencies, build and test
      run: |
        sudo apt-get update && \
        cd electron && npm run build-linux
      
    - name: Install dependencies for testing
      run: | 
        sudo apt-get update && \
        cd electron && sudo apt-get install -y xterm imagemagick-6.q16 scrot libnotify4  libnss3-dev libatk1.0-0 libatk-bridge2.0-0 libgdk-pixbuf2.0-0 libgtk-3-0  && \
        DEBIAN_FRONTEND=noninteractive sudo apt install -y x11-apps imagemagick xvfb && \
        ls /tmp/.X11-unix/ && \
        sudo apt-get install gdebi-core
        
    - name: Install the app
      run: | 
        cd electron
        sudo dpkg -i ./dist/Prostgles\ Desktop-1.0.0-amd64.deb
    - name: Test installation file
      run: | 
        cd electron
        xhost +local:root
        XAUTHORITY=/tmp/xvfb.auth
        touch $XAUTHORITY
        xauth -f $XAUTHORITY generate :98 . trusted
        export XAUTHORITY
        DISPLAY=:0 xvfb-run --auto-servernum --server-args="-screen 0 1920x1080x24" -- prostgles-desktop && echo $DISPLAY & \
        echo "Waiting for 10 seconds for the app to start" 
        sleep 10
        scrot -D :99 ./dist/screenshot.png 
    - uses: actions/upload-artifact@v4
      if: always()
      with:
        name: installers
        path: electron/dist
        retention-days: 10