!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var n=t();for(var a in n)("object"==typeof exports?exports:e)[a]=n[a]}}(globalThis,(()=>(()=>{var e,t,n={51514:(e,t,n)=>{"use strict";n.r(t);var a=n(27378),l=n(31542),o=n(96740),i=n(31602),s=n(23438),r=n(89823),c=n.n(r),d=n(75121),m=n(52040);class RTComp extends a.Component{constructor(){super(...arguments),this.mounted=!1,this.state={},this.d={},this.componentDidUpdate=async(e,t)=>{try{let n,a;Object.keys({...e,...this.props}).map((t=>{e[t]!==this.props[t]&&(n={...n,[t]:this.props[t]})})),Object.keys({...t,...this.state}).map((e=>{t[e]!==this.state[e]&&(a={...a,[e]:this.state[e]})})),(a||n)&&await this.setDeltaPS(n,a),await this.onUpdated(e,t)}catch(e){this.logAsyncErr("onUpdated",e)}},this.setDeltaPS=(e,t)=>{this._onDelta(e,t,void 0)},this.logAsyncErr=(e,t)=>{console.error(`Uncaught promise within ${e} of <${this.constructor.name}/> component`,t)},this._onDelta=(e,t,n)=>{(async()=>{try{await this.onDelta(e,t,n);const a={...e,...t,...n};await this.onDeltaCombined(a,Object.keys(a))}catch(e){const t=e instanceof Error?e:new Error(e);throw this.logAsyncErr("onDelta",e),t}})()}}async componentDidMount(){this.mounted=!0;try{await this.onMount()}catch(e){this.logAsyncErr("onMount",e)}try{this.setDeltaPS({...this.props},{...this.state})}catch(e){this.logAsyncErr("setDeltaPS",e)}}onMount(){}componentWillUnmount(){this.mounted=!1,this.onUnmount()}onUnmount(){}onUpdated(e,t){}setData(e,t){this.d={...this.d,...e};try{this._onDelta(void 0,void 0,t||e)}catch(e){this.logAsyncErr("setData",e)}}onDelta(e,t,n){}onDeltaCombined(e,t){}setState(e,t){if(this.mounted)try{return super.setState(e,t)}catch(e){throw console.error("setState error within "+this.constructor.name,e),e}}}class ErrorComponent extends a.Component{constructor(){super(...arguments),this.scrollIntoView=()=>{const{error:e}=this.props;e&&this.ref&&this.ref.scrollIntoView&&(this.ref.scrollIntoViewIfNeeded?this.ref.scrollIntoViewIfNeeded():this.ref.scrollIntoView())}}componentDidMount(){this.scrollIntoView()}componentDidUpdate(){this.scrollIntoView()}render(){const{error:e,className:t="",style:n={},pre:l=!1,findMsg:o=!1,withIcon:i=!1}=this.props;return a.createElement("div",{ref:e=>{e&&(this.ref=e)},className:"flex-row ai-center text-red-800 p-1 o-auto min-w-0 min-h-0 o-auto "+(l?" ws-pre ":"")+t,style:{whiteSpace:"pre-line",textAlign:"left",display:e?"flex":"none",padding:"0 4px",...n,minWidth:"150px"}},i&&a.createElement(c(),{size:1,className:"mr-1",path:s._gM}),(ErrorComponent.parsedError(e,o)+"").slice(0,300))}}ErrorComponent.parsedError=(e,t)=>{let n="";return"string"==typeof e?n=e:Array.isArray(e)?n=ErrorComponent.parsedError(e):e&&!yo(e)&&Object.keys(e).length?(t&&(n=vo(e,"err.err_msg")||vo(e,"err.constraint")||vo(e,"err.txt")||e.err_msg||JSON.stringify(e)),n||(n=Object.keys(e).map((t=>`${t}: ${JSON.stringify(e[t],null,2)}`)).join("\n"))):n=vo(e,"toString")?e.toString():JSON.stringify(e),"string"==typeof n&&n.length&&(n=n.trim(),n.startsWith('"')&&n.endsWith('"')&&(n=n.slice(1,-1)),n.toLowerCase().startsWith("error: ")&&(n=n.slice(7)),n=n.replace(/\\"/g,'"')),n};class ErrorTrap extends a.Component{constructor(){super(...arguments),this.state={error:"",errorInfo:""}}componentDidCatch(e,t){this.setState({error:e,errorInfo:t})}render(){const{error:e,errorInfo:t}=this.state,n=vo(this.props,"children.type.name");let l={error:e,stack:vo(t,"componentStack")||t};return n&&(l={component:n,...l}),e?a.createElement(ErrorComponent,{error:l}):this.props.children}}class Checkbox extends a.Component{render(){let e={...this.props};const{id:t,className:n="",inputClassname:l="",label:o,checked:i,style:r={},onChange:d,readOnly:m,title:p,variant:u}=e,h=i?" text-blue-500 ":" text-gray-500 ",g=a.createElement("label",{className:l+" flex-row-wrap relative b b-gray-300 checkbox pointer ai-center jc-center w-fit w-fit h-fit "+("minimal"===u?" round focusable-inset ":" focusable "),tabIndex:0,style:"minimal"===u?{background:"transparent",border:"unset",outline:"none !important"}:{padding:"3px",borderRadius:"3px",position:"relative"},onKeyDown:e=>{var t;"Enter"!==e.key&&" "!==e.key||null===(t=this.inptRef)||void 0===t||t.click()}},a.createElement("input",{id:t,ref:e=>{e&&(this.inptRef=e)},className:"hidden",type:"checkbox",checked:i,onChange:d?e=>{d(e,e.target.checked)}:void 0,readOnly:m}),a.createElement(c(),{path:s.YKm,size:"minimal"===u?1:.75,className:"minimal"===u?h:"text-blue-500",style:"minimal"===u?{}:{opacity:i?1:0}}));return a.createElement("label",{style:{...r,..."minimal"===u?{background:"transparent",outline:"none !important"}:{}},htmlFor:t,className:"flex-row-wrap ai-center pointer w-fit h-fit "+n,title:p},g,o?a.createElement("div",{className:"ml-1 noselect f-1 text-ellipsis "+h+("minimal"===u?"ml-p25":"ml-p5"),style:{}},o):null)}}class Loading extends RTComp{constructor(){super(...arguments),this.state={ready:!1},this.mounted=!1,this.onDeltaCombined=(e,t)=>{t.includes("show")}}onMount(){if(this.mounted=!0,"show"in this.props)return;const{delay:e=500}=this.props;e?setTimeout((()=>{this.mounted&&this.setState({ready:!0})}),e):this.setState({ready:!0})}render(){const{style:e={},className:t="",variant:n,sizePx:l=30,message:o,colorAnimation:i=!0}=this.props,{show:s=this.state.ready}=this.props,r=l+"px";let c=o?a.createElement("div",null,o):null;const d={display:s?void 0:"none",cursor:"wait"},m=a.createElement("svg",{className:"spinner f-0",width:r,height:r,viewBox:"0 0 66 66",xmlns:"http://www.w3.org/2000/svg"},a.createElement("circle",{className:"path "+(i?" color-animation ":""),fill:"none",strokeWidth:"6",strokeLinecap:"round",cx:"33",cy:"33",r:"30"}));if("top-bar"===n)return a.createElement("div",{style:{position:"absolute",zIndex:2,top:0,left:0,right:0,width:"100%",height:"6px",...e,...d},className:"top-bar-loader "+t});if("cover"===n)return a.createElement(a.Fragment,null,a.createElement("div",{style:{position:"absolute",zIndex:2,inset:0,width:"100%",height:"100%",...d,...!t.includes("bg-")&&{background:"rgb(255 255 255 / 73%)"},...e},className:"cover-loader flex-row ai-center jc-center "+t},m));let p=c?{}:{width:r,height:r};return a.createElement("div",{style:{...e,...p,...d},className:"spinner-loader ws-nowrap flex-row gap-1 ai-center "+t},m,c)}}class ClickCatch extends a.Component{render(){const{onClick:e,children:t,style:n}=this.props;return a.createElement("div",{style:{display:"block",position:"fixed",backgroundColor:"rgb(0 0 0 / .5)",zIndex:0,...n},className:"clickcatchcomp fixed noselect inset-0 w-full h-full",ref:e=>{e&&(this.clickCatch=e)},onClick:t=>{t.target===this.clickCatch&&(null==e||e(t))},onContextMenu:t=>(t.preventDefault(),t.target===this.clickCatch&&(null==e||e(t)),!1)},t)}}let p=document.getElementById("modal-root");p||(p=document.createElement("div"),p.setAttribute("id","modal-root"),document.body.appendChild(p));const u="popup-component-root",h="POPUP-TITLE",g="POPUP-CONTENT",f={padding:0,top:0,right:0,bottom:0,width:"fit-content",maxHeight:"100%",borderRadius:0,maxWidth:"100vw"};class Popup extends RTComp{constructor(){super(...arguments),this.el=document.createElement("div"),this.state={stateStyle:{opacity:0},collapsed:!1},this.checkFocus=e=>{var t,n,a,l,o;const{onClose:i,focusTrap:s=!0,onKeyDown:r}=this.props;if(r&&r(e,(null===(t=document.activeElement)||void 0===t?void 0:t.closest("header.POPUP-TITLE"))?"header":"content"),s&&"Tab"===e.key){const t=null!==(a=null===(n=this.el.querySelector("."+u))||void 0===n?void 0:n.querySelectorAll("a[href], area[href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), button:not([disabled]), iframe, object, embed, *[tabindex], *[contenteditable]"))&&void 0!==a?a:[];e.shiftKey&&document.activeElement===t[0]&&(e.preventDefault(),t.length&&(null===(l=t[t.length-1])||void 0===l||l.focus())),e.shiftKey||document.activeElement!==t[t.length-1]&&this.el.contains(document.activeElement)||(e.preventDefault(),t.length&&(null===(o=t[0])||void 0===o||o.focus()))}"Escape"===e.key&&(null==i||i())},this.position={},this.checkPosition=()=>{var e;if(!this.mounted)return;const{anchorEl:t,anchorXY:n,positioning:a}=this.props,l=null===(e=this.ref)||void 0===e?void 0:e.getBoundingClientRect(),o={opacity:1,zIndex:4,position:"fixed"};if(a)if("as-is"!==a&&"right-panel"!==a){if(l){const e=window.innerWidth>900?10:0,i=window.innerWidth<l.width?0:e,s=window.innerHeight<l.height?0:e;let r,c=0,d=0,m=0,p=0;n?(c=n.x,d=n.y):t?(r=t.getBoundingClientRect(),c=r.x,d=r.y,p=r.height,m=r.width):(c=(window.innerWidth-l.width)/2,d=(window.innerHeight-l.height)/2,a&&"top-center"!==a&&console.warn("Popup positioning provided without an anchorEl or anchorXY"));let u,h,g=c,f=Math.max(0,r?r.x:n?n.x:c),E=Math.max(0,r?r.x+(Math.max(l.width,r.width)-Math.min(l.width,r.width))/2:n?n.x-l.width/2:c),v=d;"center"===a?(v=.5*(window.document.body.offsetHeight-l.height),g=.5*(window.document.body.offsetWidth-l.width)):"top-center"===a?(v=50,g=.5*(window.document.body.offsetWidth-l.width)):"top-fill"===a?(v=d,g=f):"beneath-fill"===a?(v=d+p,g=E):"beneath-center"===a||"beneath-left"===a||"beneath-left-minfill"===a?(v=d+p,g=f):"beneath-right"===a?(v=d+p,g=c+m-l.width):"tooltip"===a?(v=d+s,g=c-i-l.width):"inside-top-center"!==a&&"above-center"!==a||(g=E,v=(null==r?void 0:r.y)||0,"above-center"===a&&(v=d-l.height)),g+l.width+i>window.innerWidth?(g=Math.max(i,window.innerWidth-l.width-i),u=0):g<0&&(g=i);const b=v+l.height+s-window.innerHeight;if(b>0){if(a.includes("beneath")&&b<l.height/9)h=s;else if(v=Math.max(s,window.innerHeight-l.height-s),g===i&&v>s){const e=d-s-l.height;e>0&&(v=e)}}else v<0&&(v=s);if(this.position.x!==g||this.position.y!==v){if(this.position={x:g,y:v},!this.mounted||!this.el.isConnected)return;let e={stateStyle:{...o,...Number.isFinite(h)&&{bottom:`${h}px`},...Number.isFinite(u)?{right:u}:{left:`${Math.round(g)}px`},top:`${Math.round(v)}px`}};(null==a?void 0:a.endsWith("-minfill"))&&(null==r?void 0:r.width)&&l.width<(null==r?void 0:r.width)?e.stateStyle.width=`${null==r?void 0:r.width}px`:(null==a?void 0:a.endsWith("-fill"))&&(e.stateStyle.width=`${m}px`),this.setState(e)}}}else this.setState({stateStyle:{...o,..."right-panel"===a?f:{}}});else this.setState({stateStyle:{...o,transform:"translate(-50%, -50%)",left:"50%",top:"50%"}})}}onMount(){this.el.classList.add("w-fit","h-fit"),p&&p.appendChild(this.el),setTimeout((()=>{var e,t;this.checkPosition();const{autoFocusFirst:n}=this.props;if(this.ref&&n){const a="object"==typeof n?n.selector:"."+("header"===n?h:g),l=null!==(e=this.ref.querySelector(a))&&void 0!==e?e:this.ref,o=[...Array.from(l.querySelectorAll('input:not([type="hidden"]), textarea, button'))].find((e=>"none"!==getComputedStyle(e).display&&"0"!==getComputedStyle(e).opacity));null===(t=null!=o?o:l)||void 0===t||t.focus()}}),50),window.document.body.addEventListener("keydown",this.checkFocus),this.ref&&(this.rObserver=new ResizeObserver((()=>{this.checkPosition()})),this.rObserver.observe(this.ref))}onUnmount(){var e;if(p)try{p.removeChild(this.el)}catch(e){console.error(e)}window.document.body.removeEventListener("keydown",this.checkFocus),this.ref&&(null===(e=this.rObserver)||void 0===e||e.unobserve(this.ref))}onUpdated(){}render(){var e;const{onClose:t=(()=>{}),positioning:n,title:o,content:i,children:r,footerButtons:c=[],clickCatchStyle:d={},rootStyle:p={},onClickClose:h,contentClassName:g="p-1",footer:f,contentStyle:v={},collapsible:b,subTitle:y,showFullscreenToggle:N,headerRightContent:w}=this.props,{stateStyle:S,collapsed:T=!1,fullScreen:C}=this.state,_=()=>{this.setState({collapsed:!T})},x=c.filter(m.isDefined);let A={};"tooltip"===n&&(A={pointerEvents:"none",touchAction:"none"});let R={maxWidth:"100vw",maxHeight:"100vh",outline:"none",zIndex:4,padding:0,borderRadius:".5em",...A,...S,...p};C&&(R={...No(R,["top","left","right","bottom","position","inset","width","height"]),position:"fixed",inset:0,width:"100vw",height:"100vh"});const L=!(!o||!t),O=a.createElement(a.Fragment,null,t?a.createElement(ClickCatch,{style:{position:"fixed",zIndex:4,...d},className:"absolute inset-0 bg-gray-500 opacity-75 flex-col",onClick:()=>{t()}}):null,a.createElement("div",{className:u+" card m-auto bg-white flex-col shadow-xl  o-hidden",ref:e=>{e&&(this.ref=e)},onClick:h&&t?()=>{t()}:void 0,style:{...R,boxSizing:"content-box"},role:"dialog","aria-modal":"true","aria-labelledby":"modal-headline"},a.createElement("div",{className:"w-full min-h-0 text-center flex-col f-1",style:{...null===(e=null==N?void 0:N.getStyle)||void 0===e?void 0:e.call(N,!!C)}},L&&a.createElement("header",{className:"POPUP-TITLE flex-row ai-center bb b-gray-300"},b&&a.createElement(Btn_Btn,{className:"f-0",onClick:_,iconPath:T?s.VYU:s.f1y,title:"Collapse/Expand changes"}),a.createElement("div",{id:"modal-headline",className:"flex-col f-1 font-20 noselect font-medium text-gray-900 o-hidden text-ellipsis ta-left m-0 ws-nowrap p-p25 "+(b?" pl-0 pointer ":" pl-p5  "),onClick:b?_:void 0},a.createElement("h4",{className:"m-0",style:{...window.isMobileDevice?{margin:"8px",whiteSpace:"nowrap"}:{},...b?{paddingLeft:0}:{}},title:"string"==typeof o?o:void 0},o),y&&a.createElement("h6",{className:"font-14 m-0",style:{opacity:.7}},y)),w,N&&a.createElement(Btn_Btn,{className:"f-0",iconPath:s.h40,onClick:()=>{this.setState({fullScreen:!C})}}),a.createElement(Btn_Btn,{"data-close-popup":!0,className:"f-0",style:{margin:"1px"},iconPath:s.r5M,onClick:()=>t()})),!T&&a.createElement("div",{className:"POPUP-CONTENT flex-col f-1 min-h-0 o-auto "+g,style:{borderRadius:".5em",...v}},i||r)),(!!x.length||f)&&a.createElement(E,null,f,x.map(((e,n)=>"node"in e?a.createElement(a.Fragment,{key:n},e.node):a.createElement(Btn_Btn,{key:n,...No(e,["label","onClickClose","onClick"]),onClick:n=>{e.onClickClose&&t?t():e.onClick?e.onClick(n):console.error("Button is missing click handler")}},e.label))))));return l.createPortal(O,this.el)}}const E=e=>a.createElement("footer",{className:"popup-footer bg-gray-50 flex-row-wrap p-1 jc-end "+(window.isMobileDevice?" gap-p5 ":" gap-1 ")},e.children);class Chip extends a.Component{render(){const{className:e="",subValues:t,label:n,variant:l,onDelete:o,leftIcon:i,color:r="gray"}=this.props;let c=" chip lg ";return"naked"===l?c="":c+=` ${r} b b-${r}-300 `,a.createElement("div",{...No(this.props,["children","label","value","children","variant","onDelete","leftIcon","color","subValues"]),className:"chip-component flex-row ws-pre-wrap ai-center "+c+e},i&&a.createElement(Btn_Btn,{iconPath:i.path,onClick:i.onClick,className:"mr-p5 round",size:"medium",style:{padding:0,background:"transparent",color:"black",...i.style},variant:"filled"}),"string"!=typeof n?null:a.createElement("span",{className:"text-gray-600",style:{fontWeight:400}},n,": "),a.createElement("div",{className:"flex-col gap-p25"},"value"in this.props&&this.props.value?a.createElement("span",{className:"font-medium f-1 text-ellipsis",style:{padding:"2px"}},this.props.value):this.props.children,!!(null==t?void 0:t.length)&&t.map(((e,t)=>a.createElement("span",{key:t,className:" f-1 text-ellipsis",style:{opacity:.7,padding:"2px"}},e)))),o&&a.createElement(Btn_Btn,{iconPath:s.r5M,onClick:o,className:"ml-1 round",size:"medium",style:{padding:0},variant:"filled"}))}}const v=(e="generated")=>{let t="generated1";do{t=`${e}${Math.round(1e14*Math.random())}`}while(document.querySelector("#"+t));return t};class FileInput extends RTComp{constructor(){super(...arguments),this.state={focusedFile:void 0,isOverflowing:!1},this.onDelta=()=>{this.isViewerMode()?this.resizeObserver||(this.resizeObserver=new ResizeObserver((e=>{const t=this.refWrapper.scrollWidth>this.refWrapper.offsetWidth;this.state.isOverflowing!==t&&this.setState({isOverflowing:t})})),this.resizeObserver.observe(this.refWrapper)):this.resizeObserver&&this.resizeObserver.unobserve(this.refWrapper)},this.renderMedia=e=>{const{file:t,i:n,onDelete:l,style:o={},onClick:i,focused:r}=e;let c="url"in t?{...t,type:t.content_type}:{name:t.name,type:t.data.type,url:URL.createObjectURL(t.data),isLocalFile:!0};const{type:d,url:m,name:p}=c;let u=null,h=d.startsWith("image")||d.startsWith("video");if(m){const e={maxWidth:"100%"};if(d.startsWith("image"))u=a.createElement("img",{loading:"lazy",src:m,style:e});else if(d.startsWith("video"))u=a.createElement("video",{style:e,controls:!0,src:m});else{if(!d.startsWith("audio"))return a.createElement(Chip,{key:n,value:c.isLocalFile?c.name:m,leftIcon:{path:s.FA_},onDelete:l});u=a.createElement("audio",{style:e,controls:!0,src:m})}}const{minSize:g=150}=this.props;return a.createElement("div",{key:n,className:" relative flex-col o-hidden m-auto",style:{...o}},a.createElement("div",{className:(h?"bg-black ":"bg-white")+" relative flex-col f-0 w-fit ",style:{...r?{}:{maxWidth:`${g}px`,maxHeight:`${g}px`},minWidth:"100px",minHeight:"100px",...o}},i?a.createElement("div",{className:(h?"":" media-onclick-cover  ")+" absolute w-full h-full pointer",style:{zIndex:2},onClick:e=>{e.stopPropagation(),e.preventDefault(),i()}}):null,l?a.createElement(Btn_Btn,{className:"shadow  b b-gray-500",style:{position:"absolute",top:"10px",right:"10px",zIndex:2,color:"black",backdropFilter:"blur(5px)",backgroundColor:"white"},size:"small",iconPath:s.r5M,title:"Remove file",onClick:()=>{l()}}):null,a.createElement("div",{className:"f-1 min-w-0 min-h-0 flex-row ai-center"},u),r?null:p?a.createElement("div",{className:"f-0 noselect p-p5 text-gray-500 font-14 absolute w-full f-0",style:{position:h?"absolute":"relative",zIndex:1,bottom:0,color:h?"white":"black",background:h?"linear-gradient(to bottom, rgb(255 255 255 / 0%) 0%,#00000075 70%)":"white"}},p):a.createElement("a",{href:m,target:"_blank",className:"p-5 f-0"},m)))},this.isViewerMode=()=>{const{onAdd:e,onDelete:t}=this.props;return Boolean(!e&&!t)}}onMount(){this.setState({id:v()})}render(){var e,t,n;const{className:l="",style:o={},label:i,maxFileCount:r=100,accept:d,id:m=(null!==(e=this.state.id)&&void 0!==e?e:"empty"),onAdd:p,media:u=[],onDelete:h,minSize:g=150}=this.props,{focusedFile:f,isOverflowing:E}=this.state,v=this.isViewerMode();let b;if(f){let e="data"in f.file?f.file.data.type:f.file.content_type;b=a.createElement(Popup,{open:!0,rootStyle:{padding:0},contentClassName:"",onClose:()=>{this.setState({focusedFile:void 0})},title:f.file.name,onKeyDown:v?e=>{if("ArrowRight"===e.key){const e=f.index<u.length-1?f.index+1:0;this.setState({focusedFile:{file:u[e],index:e}})}else if("ArrowLeft"===e.key){const e=f.index?f.index-1:u.length-1;this.setState({focusedFile:{file:u[e],index:e}})}}:void 0},this.renderMedia({file:f.file,i:"focused",style:{width:"fit-content",height:"fit-content",border:"unset"},onClick:e.startsWith("image")?()=>{this.setState({focusedFile:void 0})}:void 0,focused:!0}))}const y=r<=u.length||!p?null:a.createElement("label",{htmlFor:m,className:"f-1 flex-row ai-center ml-1 bg-white pointer rounded text-blue-500 b b-active p-p25 gap-p25"},a.createElement(c(),{path:s.qX5,size:1,title:"Add files",className:" "}),a.createElement("div",null,"Choose a file"),a.createElement("input",{id:m,style:{width:0,height:0,position:"absolute"},type:"file",accept:d,multiple:r>1,onChange:e=>{var t,n,a;let l=Array.from(null!==(t=e.target.files)&&void 0!==t?t:[]).map((e=>({data:e,name:e.name})));null===(a=(n=this.props).onAdd)||void 0===a||a.call(n,l)}})),N=E&&v,w=Boolean(N&&(null===(t=this.refWrapper)||void 0===t?void 0:t.scrollLeft)),S=Boolean(N&&(!(null===(n=this.refWrapper)||void 0===n?void 0:n.scrollLeft)||this.refWrapper.scrollWidth-20>this.refWrapper.scrollLeft+this.refWrapper.clientWidth)),T=e=>{var t,n;if(this.refWrapper){const a=(null===(n=null===(t=this.refWrapper.children)||void 0===t?void 0:t[1])||void 0===n?void 0:n.offsetWidth)||g;this.refWrapper.scrollLeft+=e*a,this.forceUpdate()}},C="absolute h-full w-fit flex-row ai-center pointer noselect",_={zIndex:2,top:0,bottom:0};return a.createElement("div",{ref:e=>{e&&(this.ref=e)},className:"flex-col  min-w-0 min-h-0 "+l,style:{...o}},b,a.createElement("div",{className:"relative flex-col min-w-0 min-h-0 ",style:{}},y||i?a.createElement("div",{className:"flex-row-wrap ai-center f-0 ",style:{}},a.createElement("div",{className:"py-1 noselect text-gray-500",style:{textAlign:"start"}},i),y):null,a.createElement("div",{className:v?" f-1 flex-row o-auto min-w-0 min-h-0 o-auto ":" flex-row-wrap gap-p25 ",ref:e=>{e&&(this.refWrapper=e)},onScroll:e=>{const t=window;(!t.__lastMediaScroll||t.__lastMediaScroll<Date.now()-100)&&(this.forceUpdate(),t.__lastMediaScroll=Date.now())}},w&&a.createElement("div",{className:C,style:{..._,left:0,background:"linear-gradient( -90deg, transparent, white)"},onClick:()=>T(-1)},a.createElement(c(),{size:1.5,path:s.gAv})),u.map(((e,t)=>this.renderMedia({file:e,i:t+"media",onDelete:h?()=>{h(e)}:void 0,onClick:()=>{this.setState({focusedFile:{file:e,index:t}})},style:v?{width:"250px",height:"250px",minWidth:`${g}px`,minHeight:`${g}px`,margin:0}:{}}))),S&&a.createElement("div",{className:C,style:{..._,right:0,background:"linear-gradient( 90deg, transparent, white)"},onClick:()=>T(1)},a.createElement(c(),{size:1.5,path:s.zrb})))))}}const b=e=>["boolean","number"].includes(typeof e)?e.toString():e;class SearchList extends a.Component{constructor(){super(...arguments),this.state={searchTerm:"",searchItems:void 0,searchClosed:!0,searchingItems:!1,matchCase:!1,id:"id"},this.onClick=e=>{var t,n;const{variant:a,onSearchItems:l}=this.props,{searchClosed:o,dataSignature:i,term:s}=this.state;(null==a?void 0:a.startsWith("search"))&&this.refList&&e.target&&(o||this.refList.contains(e.target)||(null===(t=this.refInput)||void 0===t?void 0:t.contains(e.target))?o&&this.refInput&&this.refInput.contains(e.target)&&(s&&l&&i!==this.props.dataSignature?this.onSearchItems(s):this.setState({searchClosed:!1})):(this.setState({searchClosed:!0}),null===(n=this.cancelCurrentSearch)||void 0===n||n.call(this)))},this.focusInput=()=>{this.refInput&&this.refInput.focus()},this.onSetTerm=(e,t)=>{const{onSearch:n,onType:a}=this.props;this.focusedRowIndex=void 0,null==a||a(e,(t=>{e=t})),this.setState({searchTerm:e}),null==n||n(e,t),this.onSearchItems(e)},this.onSearchItems=async e=>{const{onSearchItems:t,searchEmpty:n,dataSignature:a}=this.props;if(t){if(this.searching){if(this.searching.term===e)return;clearTimeout(this.searching.timeout)}"string"!=typeof e||!n&&!e?this.setState({searchItems:[],searchingItems:!1}):(this.state.searchingItems||this.setState({searchingItems:!0}),this.searching={dataSignature:a,term:e,timeout:setTimeout((async()=>{var t,n,l,o;this.setState({searchingItems:!0});const i=null!==(n=null===(t=this.props.matchCase)||void 0===t?void 0:t.value)&&void 0!==n?n:this.state.matchCase;try{null===(o=(l=this.props).onSearchItems)||void 0===o||o.call(l,e,{matchCase:i},((t,n,l)=>{var o;this.cancelCurrentSearch=()=>{this.setState({searchingItems:!1,error:void 0}),l(),this.searching=void 0},e===(null===(o=this.searching)||void 0===o?void 0:o.term)?(this.setState({searchItems:t,searchClosed:!1,error:void 0,dataSignature:a,term:e}),n&&this.cancelCurrentSearch()):!this.searching&&this.state.searchingItems&&this.cancelCurrentSearch()}))}catch(e){this.setState({searchingItems:!1,error:e,searchClosed:!0})}}),400)})}}}componentDidMount(){const{autoFocus:e=!1,defaultSearch:t,defaultValue:n,id:a=v()}=this.props;e&&setTimeout(this.focusInput,5),this.setState({id:a});const l=b(n);"string"==typeof l&&l?this.setState({searchTerm:l}):"string"==typeof t&&t&&this.onSetTerm(t,{}),window.addEventListener("click",this.onClick)}componentWillUnmount(){window.removeEventListener("click",this.onClick)}componentDidUpdate(e,t){this.state.matchCase!==t.matchCase&&this.state.searchTerm&&this.onSetTerm(this.state.searchTerm)}render(){var e,t,n,l;const{className:o="",style:i={},items:r=[],placeholder:c="",onReorder:d,onSearch:m,noSearchLimit:p=5,onMultiToggle:u,inputEl:h,dontHighlight:g,variant:f,selectedKey:E,onSearchItems:v,rootStyle:N={},label:w,limit:S=34,onPressEnter:T,matchCase:C,searchStyle:_={},searchEmpty:x=!1,size:A=(window.isLowWidthScreen?"small":void 0),rowStyleVariant:R}=this.props,{searchTerm:L,searchItems:O=[],searchingItems:I=!1,searchClosed:D,selectPopup:k,error:M,id:F}=this.state,P=!!u,H=null!==(e=null==C?void 0:C.value)&&void 0!==e?e:this.state.matchCase;let B,W=L;"row-wrap"===R&&(B={subLabel:{flex:"none",textTransform:"uppercase"},labelRootWrapperStyle:{flexDirection:"row",flexWrap:"wrap",justifyContent:"space-between",columnGap:"1em"}});const $=e=>{var t,n,a;return{...e,...SearchList.getMatch({matchCase:H,term:W,style:null===(t=e.styles)||void 0===t?void 0:t.label,subLabelStyle:{...null==B?void 0:B.subLabel,...null===(n=e.styles)||void 0===n?void 0:n.subLabel},rootStyle:{...null==B?void 0:B.labelRootWrapperStyle,...null===(a=e.styles)||void 0===a?void 0:a.labelRootWrapperStyle},text:b(void 0!==e.label?e.label:e.key),key:e.key,subLabel:e.subLabel})}},U=v?O:g?r:m?r.map($):r.map($).filter(((e,t)=>e.rank!==1/0)).sort(((e,t)=>{var n,a;return W?(null!==(n=e.rank)&&void 0!==n?n:0)-(null!==(a=t.rank)&&void 0!==a?a:0)||(e.label||"").length-(t.label||"").length:0})).slice(0,S),q=r.filter((e=>e.checked)),j=!(!v&&r.length<p&&!W||h),z=null==f?void 0:f.startsWith("search"),Y=null==f?void 0:f.includes("no-shadow"),V="select"===f,G=()=>{var e;z&&!D&&(null===(e=this.cancelCurrentSearch)||void 0===e||e.call(this),this.setState({searchTerm:""}),this.setState({searchClosed:!0}))},J=!U.length&&!W||z&&D;let X=M?a.createElement(ErrorComponent,{error:M}):J?null:a.createElement("div",{className:"SearchList_Suggestions  relative w-full f-1  min-h-0 min-w-0 no-scroll-bar "+(z?" o-visible ":" o-auto ")},z&&!!U.length&&a.createElement("div",{style:{position:"fixed",inset:0,zIndex:1,background:"#ebebeb38",backdropFilter:"blur(1px)"}}),a.createElement("ul",{className:"f-1 o-auto min-h-0 min-w-0 ul-search-list "+(z?" no-scroll-bar shadow ":""),role:"list",ref:e=>{e&&(this.refList=e)},style:{padding:0,...z?{position:"absolute",background:"white",zIndex:1,left:0,right:0,maxHeight:"400px",...this.inputWrapper&&(()=>{const e=this.inputWrapper.getBoundingClientRect();return{position:"fixed",top:e.top+e.height,left:e.left,right:e.right,width:`${e.width}px`}})()}:{}}},m&&!this.props.items?null:U.length||I?U.map(((e,t)=>{var n,l,o;const i=!e.onPress||e.disabledInfo?void 0:t=>{e.onPress(t,this.state.searchTerm),G()};let s;if("content"in e)s=e.content;else{const{contentLeft:t,contentBottom:o,contentRight:i}=e;s=a.createElement("div",{className:"ROWINNER flex-row ai-center f-1 ",style:null===(n=e.styles)||void 0===n?void 0:n.rowInner},t||null,a.createElement("div",{className:"LABELWRAPPER flex-col ai-start f-1",style:null===(l=e.styles)||void 0===l?void 0:l.labelWrapper},a.createElement("label",{className:"ws-pre mr-p5 f-1 flex-row noselect min-w-0 w-full "+(e.disabledInfo?" not-allowed ":" pointer "),style:e.style},e.node),o),i||null,"boolean"==typeof e.checked?a.createElement(Checkbox,{id:F,className:"f-0 no-pointer-events",checked:e.checked,style:{marginRight:"12px"},onChange:()=>{}}):null)}return a.createElement("li",{key:t,role:"listitem",title:null!==(o=e.disabledInfo)&&void 0!==o?o:e.title,style:{...e.rowStyle,...e.disabledInfo?{cursor:"not-allowed",opacity:.4,touchAction:"none"}:{}},tabIndex:0,draggable:Boolean(d),onDrag:d?e=>{const t=e.currentTarget,n=t.parentElement;if(t.style.display="none",!n)throw"Not possible";Array.from(n.children).map(((t,a)=>{const l=t.getBoundingClientRect();let o=e.clientY>l.y&&e.clientY<l.y+l.height;const i=o?"35px":"";i!==t.style.paddingTop&&(t.style.paddingTop=i),o&&(n._targetIdx=a)}));const a=n.getBoundingClientRect();e.clientY>a.y+a.height?n.scrollTop+=10:e.clientY<a.y&&(n.scrollTop-=10)}:void 0,onDragEnd:d?async e=>{const n=e.currentTarget,a=n.parentElement;let l=a._targetIdx,o=r.slice(0);var i,s,c;i=t,s=l,c=o.splice(i,1)[0],o.splice(s,0,c),await d(o),setTimeout((()=>{Array.from(a.children).map((e=>{e.style.paddingTop=""})),n.style.display="flex"}),1)}:void 0,className:"flex-row ai-start p-p5 pl-1 min-w-0 "+(e.selected?" bg-gray-100 ":"")+(e.disabledInfo?" not-allowed ":" pointer ")+(e.onPress||this.props.onChange||this.props.onMultiToggle||this.props.onPressEnter?"":" no-hover "),onClick:e=>null==i?void 0:i(e,this.state.searchTerm),onKeyUp:i?e=>{"Enter"===e.key&&i(e,this.state.searchTerm)}:void 0},s)})):a.createElement("div",{className:"p-p5 text-gray-600 no-data"},null!==(l=null===(n=(t=this.props).onNoResultsContent)||void 0===n?void 0:n.call(t,W))&&void 0!==l?l:a.createElement("div",null,"No results"))));const K="search-list-comp-input",Q=a.createElement("div",{className:"SearchList list-comp ta-left flex-col bg-white min-h-0 rounded "+o,ref:e=>{e&&(this.refRoot=e)},style:{...i,...z?{}:N},onKeyDown:e=>{var t,n,a;if(!this.refList)return;if(!(null===(t=this.refRoot)||void 0===t?void 0:t.contains(document.activeElement)))return;const l=this.refList.lastChild,o=this.refList.firstChild,i=document.activeElement,s=i.previousElementSibling,r=i.nextElementSibling,c=!this.refList.contains(i),d=!!(null==i?void 0:i.closest("."+K));if("a"===e.key&&e.ctrlKey&&!d)return this.refInput&&(this.refInput.focus(),this.refInput.select()),void e.preventDefault();if("Enter"===e.key&&d&&o&&(e.preventDefault(),T&&void 0===this.focusedRowIndex?(T(W),G()):o.click()),c||1!==e.key.length||e.shiftKey||e.ctrlKey||e.altKey)switch(e.key){case"ArrowUp":i===o||c?l&&l.focus():this.refList.childElementCount&&s&&s.focus(),e.preventDefault(),this.focusedRowIndex=(null===(n=null==i?void 0:i.parentElement)||void 0===n?void 0:n.children)?Array.from(i.parentElement.children).indexOf(i):-1;break;case"ArrowDown":i===l||c?o&&o.focus():this.refList.childElementCount&&r&&r.focus(),e.preventDefault(),this.focusedRowIndex=(null===(a=null==i?void 0:i.parentElement)||void 0===a?void 0:a.children)?Array.from(i.parentElement.children).indexOf(i):-1}else this.focusInput()}},!!w&&a.createElement("div",{className:" noselect text-gray-500 "+(z?" pb-p25 ":" p-p75 "+(j?" pb-0 ":" ")),style:{}},w),a.createElement("div",{className:"f-0 min-h-0 min-w-0 flex-row jc-start relative "+(!j&&P?" bg-gray-100 ":"")+(z||V?" ":"  ai-center  ")+(j||P?"":" hidden"),style:_},j?a.createElement("div",{ref:e=>{e&&(this.inputWrapper=e)},className:"SearchList_InputWrapper flex-row h-fit f-1 relative o-hidden relative rounded focus-border b b-gray-300 "+(z&&!Y?" shadow ":" "),style:{...z?{zIndex:X?2:"unset"}:V?{margin:"8px",marginBottom:"2px"}:{margin:"8px"}},onClick:()=>{!X&&x&&this.onSetTerm(W||"",{})}},a.createElement(y,{ref:e=>{e&&(this.refInput=e)},type:"text",style:{...z&&!J?{borderBottomLeftRadius:0,borderBottomRightRadius:0,zIndex:3}:{},...this.props.inputStyle,..."small"!==A&&{padding:"8px 1em",paddingRight:0}},placeholder:c,autoComplete:"off",className:K+" f-1 w-full ",title:W,value:W,onChange:e=>{let t=e.currentTarget.value;this.onSetTerm(t,e)}}),a.createElement("div",{className:"relative rounded f-0 ai-center jc-center flex-row bg-white ",style:{borderRadius:"3px",overflow:"visible",margin:"0px"}},z&&I&&a.createElement(Loading,{className:"noselect mr-p5 bg-white",sizePx:24,variant:"cover"}),a.createElement(Btn_Btn,{title:"Match case",iconPath:s.nAh,color:H?"action":void 0,onClick:()=>{C?C.onChange(!H):this.setState({matchCase:!H})}}))):P?a.createElement("div",{className:"pl-1 py-p5 noselect text-gray-500"},q.length||0," selected"):null,P?a.createElement(Checkbox,{id:F,style:{paddingLeft:"1em",paddingRight:"20px",marginLeft:"auto"},className:U.length?"":"hidden",checked:Boolean(q.length),onChange:e=>{const t=e.currentTarget.checked;if(u){const n=r.map((e=>{const n=W?U.find((t=>t.key===e.key)):e;return{...e,checked:n?e.disabledInfo?e.checked:t:e.checked}}));u(n,e)}}}):null),X);return"select"===f?k?a.createElement(Popup,{open:!0,onClose:()=>{this.setState({selectPopup:!1})}},Q):a.createElement(Btn_Btn,{onClick:()=>{this.setState({selectPopup:!0})}},E):Q}}SearchList.getMatch=e=>{const t=e=>{var t;const{term:n,text:l,key:o,isSublabel:i=!1,matchCase:s=!1}=e,r=i?"text-gray-600":"text-gray-900",c={...i?{fontSize:"14px",marginTop:".25em"}:{fontSize:"18px"},...e.style};let d=0,m=l||"",p=i?m.split("\n").slice(0,3).join("\n"):m,u=a.createElement("span",{className:r+" text-ellipsis",style:c},p);if(n){const e=s?m:m.toLowerCase(),o=s?n:n.toLowerCase();let r=e.indexOf(o);if(d=r+1,r>-1){let e,d;if(i){const a=m.split("\n"),l=a.findIndex((e=>s?e.includes(n):e.toLowerCase().includes(n.toLowerCase())));m=null!==(t=a[l])&&void 0!==t?t:"",r=s?m.indexOf(n):m.toLowerCase().indexOf(n.toLowerCase()),l>2&&(e=a.slice(l-2,l-1)),d=a.slice(l+1,l+2)}else m=m.split("\n").join(" ");u=a.createElement("div",{className:"flex-col  f-1",style:c,title:l},void 0!==e&&e.length>0&&a.createElement("span",{className:"f-0 text-gray-400 text-ellipsis"},e.join("\n")),a.createElement("div",{className:"flex-row f-1"},a.createElement("span",{className:"f-1 ta-right text-gray-600 text-ellipsis",style:{maxWidth:"fit-content"}},m.slice(0,r)),a.createElement("strong",{className:"f-0"},m.slice(r,r+o.length)),a.createElement("span",{className:"f-1 text-gray-600 text-ellipsis"},m.slice(r+o.length))),void 0!==d&&d.length>0&&a.createElement("span",{className:"f-0 text-gray-400 text-ellipsis"},d.join("\n")))}else d=1/0}return m||(""===o&&(u=a.createElement("i",null,"[Empty]")),null===o&&(u=a.createElement("i",null,"[NULL]"))),{rank:d,node:u}},{term:n,text:l,key:o,subLabel:i,matchCase:s,style:r,subLabelStyle:c,rootStyle:d}=e;let m=t({term:n,text:l,key:o,matchCase:s,style:r}),p=m;if(i){let e=t({term:n,text:i,key:i,isSublabel:!0,matchCase:s,style:c});p.node=a.createElement("div",{className:"flex-col f-1",style:d},m.node,e.node);let l=Math.min(m.rank,e.rank+5);m.rank!==1/0&&e.rank!==1/0&&(l/=2),p.rank=l}return p};const y=a.forwardRef(((e,t)=>{const{className:n="",style:l={}}=e;return a.createElement("input",{ref:n=>{n&&(t&&t(n),setTimeout((()=>{e.autoFocus&&document.activeElement!==n&&(n.focus(),n.select())}),40))},...bo(e,[],["className","style"]),style:l,className:"custom-input rounded "+n})}));class ButtonGroup extends a.Component{render(){const{onChange:e,className:t="",value:n,id:l="",style:o={},options:i=[],size:s,variant:r}=this.props,c=".375rem",d=(e,t=!1)=>{let n={borderTopLeftRadius:0,borderBottomLeftRadius:0,borderTopRightRadius:0,borderBottomRightRadius:0,fontWeight:500};return e?e<i.length-1?{...n,marginRight:"-1px"}:{...n,borderTopRightRadius:c,borderBottomRightRadius:c}:{...n,borderTopLeftRadius:c,borderBottomLeftRadius:c,marginRight:"-1px"}};return"select"===r?a.createElement(Select_Select,{btnProps:{color:"default",variant:"faded"},className:"shadow",options:i,value:n,onChange:(t,n)=>e(t,n)}):a.createElement("div",{style:{...o},className:"bbutton-group flex-row o-auto  rounded-md w-fit "+t},i.map(((t,l)=>a.createElement(Btn_Btn,{key:t,color:"action",size:s,style:{...d(l,n===t)},variant:n===t?"filled":"outline",onClick:n=>e(t,n)},t))))}}const N=[{label:"CREATE TABLE",info:"Create a table within the current database",sql:"/* DROP TABLE IF EXISTS my_new_table; */\n  CREATE TABLE /* IF NOT EXISTS */ my_new_table (\n\n    /* Auto incrementing key */\n    id  SERIAL PRIMARY KEY\n\n    username    TEXT NOT NULL,\n    first_name  TEXT NOT NULL,\n    last_name   TEXT NOT NULL,\n    created     TIMESTAMP DEFAULT NOW()\n\n);\n/* \nAlternatively, you can use a UUID PRIMARY KEY. This requires pgcrypto extension to be installed:\n  CREATE EXTENSION IF NOT EXISTS pgcrypto;\n\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid()\n\nTo reference a (unique) column from another table:\n  user_id UUID NOT NULL REFERENCES users(id), \n*/"},{label:"INSERT ROWS",info:"Add data to a table",sql:"INSERT INTO my_new_table (col1, col2, col3)\nVALUES \n  (1, 1, 1),\n  (2, 2, 2),\n  (3, 3, 3);\n\n/* From select */\nINSERT INTO my_new_table (col1, col2, col3)\nSELECT col1, col2, col3 \nFROM my_other_table\nWHERE col3 = 33;\n"},{label:"DELETE ROWS",info:"Delete data from a table",sql:"DELETE FROM my_new_table\nWHERE col3 = 33;\n\n/* To delete matching records in a child table where a foreign key relationship is in place */\nDELETE FROM my_new_table CASCADE\nWHERE col3 = 33;\n"},{label:"UPDATE ROWS",info:"Update data in a table",sql:"UPDATE my_new_table\nSET status = 'active'\nWHERE username = 'me'\n\n/* From select */\nUPDATE my_new_table\nSET customer = subquery.customer,\n  address = subquery.address\nFROM (\n  SELECT customer, address, row_id\n  FROM ...\n) AS subquery\nWHERE my_new_table.row_id = subquery.row_id;\n"},{label:"DROP TABLE",info:"Drop a table",sql:"DROP TABLE /* IF EXISTS */ my_new_table;"},{label:"RENAME A TABLE",info:"Rename a table. Change table name",sql:"ALTER TABLE my_table\nRENAME TO my_new_table;"},{label:"VACUUM A TABLE",info:"Vacuum a table. Reclaims storage occupied by dead tuples",sql:"VACUUM /* FULL */ my_table;"},{label:"COMMENT A TABLE",info:"Comment on a table ",sql:"COMMENT ON TABLE my_table IS 'My comment';"},{label:"ADD NEW COLUMN",info:"Add a new column to an existing table",sql:"ALTER TABLE my_table ADD COLUMN new_colname INTEGER;"},{label:"RENAME COLUMN",info:"Add a new column to an existing table",sql:"ALTER TABLE my_table RENAME COLUMN colname TO new_colname;"},{label:"CHANGE COLUMN DATA TYPE",info:"Change an existing column data type",sql:"ALTER TABLE my_table ALTER COLUMN colname TYPE TIMESTAMP;\n\n/* To apply a function during conversion */\nALTER TABLE my_table ALTER COLUMN colname TYPE TIMESTAMP USING to_timestamp(colname, 'yyyy-mm-dd');\n"},{label:"ADD FOREIGN KEY",info:"Add a FOREIGN KEY/REFERENCES constraint to an existing column from table",sql:"ALTER TABLE my_table\nADD FOREIGN KEY (table2_id) \nREFERENCES table2 ( id );"},{label:"ADD PRIMARY KEY",info:"Add a PRIMARY KEY constraint to an existing column from table",sql:"ALTER TABLE my_table\n  ADD PRIMARY KEY (colname) \n  "},{label:"DROP COLUMN",info:"Drops/Removes column from a table",sql:"ALTER TABLE my_table\nDROP COLUMN colname "},{label:"CREATE USER",info:"Creates a user",sql:"CREATE USER new_user WITH ENCRYPTED PASSWORD 'the_password';\n\n/* To allow user access to a database */\nGRANT ALL PRIVILEGES ON DATABASE my_db TO new_user;\n\n/* To grant full control to user */\nALTER USER new_user WITH SUPERUSER \n"},{label:"CREATE DATABASE",info:"Creates a database",sql:"CREATE DATABASE my_db OWNER my_user /* OWNER is optional */ ;"},{label:"DROP DATABASE",info:"Drops/removes a database",sql:"\nDROP DATABASE my_db;\n\n/* If database is in use will need to close all connections to it except this */\nSELECT pg_terminate_backend(pg_stat_activity.pid) FROM pg_stat_activity \nWHERE pg_stat_activity.datname = 'my_db' AND pid <> pg_backend_pid();\n"},{label:"CREATE EXTENSION",info:"Creates/enables/installs an extension",sql:"/*** Some extensions are included in the default installation ***/\n/* Provides cryptographic functions  */\nCREATE EXTENSION pgcrypto;\n\n/* Track statistics on the queries executed by a Postgres database */\nCREATE EXTENSION pg_stat_statements;\n\n/* Allows using a Foreign Data Wrapper to access tables on remote Postgres servers */\nCREATE EXTENSION postgres_fdw;\n\n/*** Other extensions need to be installed first ***/  \n/* Adds support for geographic and geometric data types and functions */  \nCREATE EXTENSION IF NOT EXISTS postgis;\n\n"},{label:"CREATE TRIGGER",info:"Create trigger on data change",sql:"CREATE OR REPLACE FUNCTION order_on_insert\n  RETURNS trigger AS\n$$\n\nBEGIN\n\n  INSERT INTO orders_audit (id, customer_id, product_id, added)\n  VALUES(NEW.id, NEW.customer_id, NEW.product_id, now());\n\n  RETURN NEW;\n\nEND;\n\n$$\nLANGUAGE 'plpgsql';\n\nCREATE TRIGGER order_on_insert_trigger\nAFTER INSERT\nON orders\nFOR EACH ROW\nEXECUTE PROCEDURE order_on_insert();"},{label:"CREATE EXTENSION",info:"Creates/enables/installs an extension",sql:"/*** Some extensions are included in the default installation ***/\n/* Provides cryptographic functions  */\nCREATE EXTENSION pgcrypto;\n\n/* Track statistics on the queries executed by a Postgres database */\nCREATE EXTENSION pg_stat_statements;\n\n/* Allows using a Foreign Data Wrapper to access tables on remote Postgres servers */\nCREATE EXTENSION postgres_fdw;\n\n/*** Other extensions need to be installed first ***/  \n/* Adds support for geographic and geometric data types and functions */  \nCREATE EXTENSION IF NOT EXISTS postgis;\n\n"},{label:"Clone database",info:"Create a copy/clone of an existing database",sql:"/* originaldb must be idle/not accessed by other users */\nCREATE DATABASE newdb WITH TEMPLATE originaldb OWNER dbuser;\n\n/* To make originaldb idle */\nSELECT pg_terminate_backend(pg_stat_activity.pid) FROM pg_stat_activity \nWHERE pg_stat_activity.datname = 'originaldb' AND pid <> pg_backend_pid();\n  "}],w=[{key:"views and queries",label:"Tables/Queries"},{key:"rows",label:"Data"},{key:"commands",label:"SQL Snippets"}];class SearchAll extends RTComp{constructor(e){var t;super(e),this.onDeltaCombined=async(e,t)=>{t.includes("searchType")&&e.searchType&&this.setState({sType:e.searchType}),t.includes("sType")&&e.sType&&this.searchTerm},this.searchRows=(e="")=>{const{sType:t,tablesToSearch:n,matchCase:l}=this.state,{db:o,tables:i}=this.props;this.searchTerm=e,this.searching&&clearTimeout(this.searching),this.searching=setTimeout((async()=>{var e;const l=this.searchTerm+"";if("rows"===t&&o.sql){this.setState({loading:!0}),this.setState({items:void 0});for(const t of n){let n="*";const r=null===(e=i.find((e=>e.name===t)))||void 0===e?void 0:e.columns;r&&(n=r.filter((e=>e.select&&e.filter&&"geography"!==e.udt_name&&"geometry"!==e.udt_name&&(!/[a-z]/i.test(l)||"number"!==e.tsDataType))).map((e=>e.name)));const d=o[t];if((null==d?void 0:d.find)&&this.mounted&&n.length&&l===this.searchTerm){const{matchCase:e}=this.state;this.setState({currentSearchedTable:t});const i={$term_highlight:[n,l,{edgeTruncate:30,matchCase:e,returnType:"object"}]},r={$term_highlight:[n,l,{matchCase:e,returnType:"boolean"}]},m=(await d.find(r,{select:{$rowhash:1,s:i},limit:3})).filter((e=>e.s)).map((e=>{const n=Object.keys(e.s)[0];return{$rowhash:e.$rowhash,table:t,colName:n,match:e.s[n].map(((e,t)=>t?e:`${n}: ${e}`))}}));if(l===this.searchTerm&&"rows"===this.searchType){const{onOpen:e,onClose:t}=this.props,n=m.map(((n,i)=>{var r;return{...n,key:n.$rowhash+i,label:n.table,content:a.createElement("div",{className:"f-1 flex-row ai-start",title:"Open table at row"},a.createElement("div",{className:"flex-col ai-start f-0 mr-p5 text-gray-500"},a.createElement(c(),{path:(null===(r=null==o?void 0:o[n.table])||void 0===r?void 0:r.insert)?s.CKH:s._sG,size:1.5})),a.createElement("div",{className:"flex-col ai-start f-1"},a.createElement("div",{className:"font-18"},n.table),a.createElement("div",{style:{fontSize:"16px",opacity:.7,textAlign:"left",width:"100%",marginTop:".25em"},className:this.searchType?"":"text-gray-400"},SearchAll.renderRow(n.match,i)))),onPress:()=>{let a=[];n.colName&&a.push({fieldName:n.colName,type:"$term_highlight",value:l}),e({table:n.table,filter:a}),t()}}}));n.length&&this.setState({items:[...this.state.items||[],...n]})}else this.setState({loading:!1})}}this.setState({loading:!1,items:this.state.items||[]}),this.searching=null}else console.error("Unexpected option")}),600)},this.state={searchTerm:"",sType:null!==(t=e.searchType)&&void 0!==t?t:"rows",matches:[],loading:!1,rows:[],cols:[],db_objects:[],tablesToSearch:[],allTablesToSearch:[],matchCase:!1,objTypesToSearch:["tables","queries"]}}onMount(){const{defaultTerm:e="",db:t}=this.props,n=Object.keys(t).filter((e=>{var n;return null===(n=t[e])||void 0===n?void 0:n.find})),a=n.slice(0);this.setState({searchTerm:e,tablesToSearch:n,allTablesToSearch:a},(()=>{e&&this.searchRows(e)}))}getSearchListProps(){const{sType:e,objTypesToSearch:t}=this.state,{queries:n,onClose:l,suggestions:o}=this.props;this.searchType=e;let i,r,d=!1;return"views and queries"===e?i=o.slice(0).filter((e=>"table"===e.type&&"public"===e.schema&&t.includes("tables"))).map((e=>({key:e.label,label:e.escapedIdentifier,subLabel:e.subLabel,contentLeft:a.createElement("div",{className:"f-0"},a.createElement(c(),{className:"text-gray-500 p-p25",size:1.5,path:"table"===e.type?s._sG:"function"===e.type?s.oVB:s.ZVI})),onPress:()=>{this.props.onClose(),this.props.onOpenDBObject(e)}}))).concat(((null==t?void 0:t.includes("queries"))&&null!=n?n:[]).map((e=>({key:e.id,label:e.name,subLabel:e.sql||"",contentLeft:a.createElement("div",{className:"f-0"},a.createElement(c(),{className:"text-gray-500 p-p25",size:1.5,path:s.eY2})),onPress:(t,n)=>{var a;this.props.onClose();let l={};if(e.sql&&n&&e.sql.toLowerCase().includes(n.toLowerCase())){const t=e.sql.split("\n").map((e=>e.toLowerCase())),a=t.findIndex((e=>e.includes(n.toLowerCase()))),o={column:t[a].indexOf(n.toLowerCase())+1,lineNumber:a+1};l={options:{...e.options||{},cursorPosition:o}}}null===(a=e.$update)||void 0===a||a.call(e,{closed:!1,...l},{deepMerge:!0})}})))):"commands"===e?i=N.map((e=>({...e,key:e.label,label:e.label,subLabel:e.info+"\n"+e.sql,contentLeft:a.createElement(c(),{path:s.Giz,size:1.5,className:"mr-p5 text-gray-500"}),onPress:()=>{this.props.loadTable({type:"sql",name:e.label,sql:e.sql}),this.props.onClose()}}))):"rows"===e&&(r=this.searchRows,d=!0,i=this.state.items),{items:i,onSearch:r,onType:(t,n)=>{"commands"!==e&&">"===t&&(n(""),this.setState({sType:"commands",searchTerm:""}))},dontHighlight:d,placeholder:"Search..."}}render(){var e;const{loading:t=!1,sType:n,tablesToSearch:l,allTablesToSearch:o,currentSearchedTable:i,matchCase:s,objTypesToSearch:r}=this.state,{defaultTerm:c,onClose:d}=this.props,m=this.getSearchListProps(),p=window.innerWidth<600,u=p?0:"2em",h={marginTop:p?".5em":"68px",flex:"none"},g="f-0 "+(p?"":" px-1 "),f="commands"===n?null:"rows"!==n?a.createElement(Select_Select,{label:"Tables/Queries",style:h,className:g,limit:1e3,options:["tables","queries"],value:r,multiSelect:!0,onChange:e=>this.setState({objTypesToSearch:e})}):a.createElement(Select_Select,{label:"Tables",style:h,className:g,limit:1e3,options:o,value:l,multiSelect:!0,onChange:e=>this.setState({tablesToSearch:e})});let E=a.createElement(a.Fragment,null,a.createElement("div",{className:"flex-row aai-start w-full min-h-0",style:{width:"hh550px",maxWidth:"88vw",alignSelf:"center"}},!p&&f,a.createElement("div",{className:"flex-col min-w-0 min-h-0 f-1"},a.createElement(ButtonGroup,{size:"small",className:"o-auto",options:w.map((e=>e.label)),value:null===(e=w.find((e=>e.key===n)))||void 0===e?void 0:e.label,style:{marginRight:"40px",marginBottom:"1em"},onChange:e=>{var t;const n=null===(t=w.find((t=>t.label===e)))||void 0===t?void 0:t.key;n&&this.setState({sType:n})}}),p&&f,"commands"===n?null:t&&"rows"===n?a.createElement("div",{className:"flex-row f-0 min-h-0 ai-center h-fit "},a.createElement(Loading,{sizePx:18,className:"f-0 m-p5",show:t}),a.createElement("div",{className:"f-1 ta-left font-14"},`Searching ${i} (${l.indexOf(i)+1}/${l.length})`)):a.createElement("div",{style:{width:"34px",height:"34px"}}),a.createElement(SearchList,{matchCase:{value:s,onChange:e=>this.setState({matchCase:e})},id:"search-all-db",className:"f-1 min-w-0 flex-col ",searchStyle:{maxWidth:"500px"},defaultSearch:c,limit:1e3,noSearchLimit:0,...m}))));return a.createElement(Popup,{anchorXY:{x:20,y:20},positioning:"inside-top-center",title:"Quick search",contentClassName:" p-1",contentStyle:{overflow:"unset",paddingTop:"1em"},rootStyle:{minHeight:"50vh",top:u,right:u,left:u,maxHeight:"calc(100vh - 4em)"},open:!0,onClose:d,focusTrap:!0,autoFocusFirst:{selector:"input"}},E)}}SearchAll.renderRow=(e,t,n)=>e&&Array.isArray(e)?a.createElement("div",{key:t,className:"flex-row ws-pre f-1 "},e.map(((t,n)=>{if("string"==typeof t){const l=!e[2];let o=n?{flex:1}:{display:"flex",flex:l?void 0:1,justifyContent:l?"start":"end"};return 1===e.length&&(delete o.maxWidth,t=Gl(t.split("\n").join(" "),25)),a.createElement("span",{key:n,style:{...o,maxWidth:"fit-content"},className:"fs-1 min-w-0 text-gray-600 text-ellipsis"+(n?" ta-left":" ")},t)}return Array.isArray(t)&&"string"==typeof t[0]?a.createElement("strong",{key:n,className:"f-0"},t[0]):(console.warn("Unexpected $term_highlight item",t),null)}))):null;class SmartSearch extends RTComp{constructor(){super(...arguments),this.state={searchKey:Date.now()},this.onDelta=e=>{(null==e?void 0:e.defaultValue)&&this.setState({searchKey:Date.now()})},this.searchItems=[],this.onSearchItems=async(e,t,n)=>{var l;if("string"!=typeof e)return[];const o=null!==(l=null==t?void 0:t.matchCase)&&void 0!==l&&l,{db:i,tableName:s,columns:r,column:c,onType:d,tables:m,detailedFilter:p=[]}=this.props,u=m.find((e=>e.name===s)),h=this.filterableCols;null==u||u.columns.find((e=>e.name===c));if(!(null==h?void 0:h.length))throw"no cols ";null==d||d(e);let g=[];const f=(t="*",n=3,a=!1)=>{var l,r,d;const m=(n=!1)=>({[t]:{[`$${n?"n":""}${o?"":"i"}like`]:`${e}%`}});let u=[];u=a?[m()]:[m(!0),{$term_highlight:[[t],e,{matchCase:o,edgeTruncate:30,returnType:"boolean"}]}];let h={prgl_term_highlight:{$term_highlight:[[t],e,{matchCase:o,edgeTruncate:30,returnType:"object"}]}};return c&&(h[c]=1),(null==p?void 0:p.length)&&(u=[Vl(p,{filters:u})]),null===(r=null===(l=i[s])||void 0===l?void 0:l.find)||void 0===r?void 0:r.call(l,{$and:u.filter(Co).concat(null!==(d=this.props.extraFilters)&&void 0!==d?d:[])},{select:h,limit:n,groupBy:!0})},E=Boolean(e&&/[a-z]/i.test(e));let v=[],b=[],y=!1;for(let t=0;t<h.length;t++){const l=h[t];if(y||"number"===l.tsDataType&&E);else{try{const e=await f(l.name,void 0,!0),t=3-e.length;g=g.concat(e),t>0&&(g=g.concat(await f(l.name,t)))}catch(e){console.error(e)}b=g.filter((e=>null==e?void 0:e.prgl_term_highlight)).map(((t,n)=>{var l,o,i;const s=null===(l=Object.keys((null==t?void 0:t.prgl_term_highlight)||{}))||void 0===l?void 0:l[0],r="*"===c?s:null!=c?c:s;let d,m,p;return r&&(p=null===(o=null==t?void 0:t.prgl_term_highlight)||void 0===o?void 0:o[r].flat().join(""),m=c?null==t?void 0:t[c]:p,d=a.createElement("div",{className:"flex-col ws-pre f-1"},1!==(null==h?void 0:h.length)&&a.createElement("div",{className:"f-0 color-action font-14",style:{fontWeight:400}},r,": "),a.createElement("div",{className:"f-1 ",style:{marginTop:"4px"}},SearchAll.renderRow(null===(i=null==t?void 0:t.prgl_term_highlight)||void 0===i?void 0:i[r],n)))),{key:n,content:d,label:m,title:m+"",onPress:()=>{var t,n,a;const l={fieldName:r,type:"$term_highlight",value:null!=p?p:e};let o=[...null!==(t=this.props.detailedFilter)&&void 0!==t?t:[],l];const i={columnValue:m,columnTermValue:p,term:e,colName:r};null===(a=(n=this.props).onChange)||void 0===a||a.call(n,o,i)}}})),v=v.concat(b)}null==n||n(b,t===h.length-1,(()=>{y=!0}))}return v}}get filterableCols(){var e;const{tableName:t,columns:n,column:a,tables:l}=this.props,o=l.find((e=>e.name===t));return S(null!==(e=null==o?void 0:o.columns)&&void 0!==e?e:[]).filter((e=>"*"===a||a&&e.name===a||(null==n?void 0:n.length)&&n.includes(e.name)||!n&&!a))}render(){const{searchItems:e,searchKey:t=1}=this.state,{style:n,className:l,label:o,placeholder:i="Search ...",defaultValue:s,onPressEnter:r,variant:c,searchEmpty:d=!1,detailedFilter:m,extraFilters:p}=this.props;return this.filterableCols.length?a.createElement(SearchList,{key:(null!=s?s:"")+t,defaultValue:s,style:n,id:"search-all",className:l,items:e,variant:c||"search",searchEmpty:d,onSearchItems:this.onSearchItems,label:o,placeholder:i,onPressEnter:r?e=>r(e,this.searchItems):void 0,dataSignature:JSON.stringify([m,p]),matchCase:void 0}):null}}const S=e=>{var t;return null!==(t=e.filter((e=>e.filter&&e.select&&"geography"!==e.udt_name&&"geometry"!==e.udt_name&&"bytea"!==e.udt_name)))&&void 0!==t?t:[]},T=e=>null!=e,C=[{key:"=",label:"="},{key:"<>",label:"!="},{key:"not null",label:"IS NOT NULL"},{key:"null",label:"IS NULL"},{key:"$in",label:"IN"},{key:"$nin",label:"NOT IN"}],_=[{key:"@@.to_tsquery",label:"to_tsquery"},{key:"@@.plainto_tsquery",label:"plainto_tsquery"},{key:"@@.phraseto_tsquery",label:"phraseto_tsquery"},{key:"@@.websearch_to_tsquery",label:"websearch_to_tsquery"}],x=[{key:"$ilike",label:"ILIKE"},{key:"$like",label:"LIKE"},{key:"$term_highlight",label:"CONTAINS"}],A=[{key:"$between",label:"Between"},{key:">",label:">"},{key:">=",label:">="},{key:"<",label:"<"},{key:"<=",label:"<="}],R=[{key:"$age",label:"Age"},{key:"$ageNow",label:"Age exact"},{key:"$duration",label:"Duration"}],L=["$existsJoined","$notExistsJoined"],O=e=>Boolean(e.type&&L.includes(e.type)),I=e=>!O(e.type),D=(e,t,n=0)=>{var a;if(e){const l="$and"in e;if(l||"$or"in e){const a=e[l?"$and":"$or"].map((e=>D(e,t,n+1))).filter(T),o=a.join(l?" AND ":" OR ");return a.length>1&&n>1?`( ${o} )`:o}return null!==(a=(e=>{const n=k(e,t,{forInfoOnly:!0});if(!n)return;const a=Object.keys(n)[0];if("$term_highlight"===a){const[e,t,l]=n[a],{matchCase:o}=l;return`${e} contain ${o?"(case sensitive)":""} ${t}`}return`${a} ${JSON.stringify(n[a])}`.split(".$").join(" ")})(e))&&void 0!==a?a:""}return""},k=(e,t,n)=>{const{forInfoOnly:a=!1}=null!=n?n:{},l=(e,t)=>{if((null==t?void 0:t.length)&&!t.includes(e))throw new Error(`${e} is not a valid field name. \nExpecting one of: ${t.join(", ")}`);return e};if("fieldName"in e&&e.disabled||O(e)&&e.filter.disabled)return;const o=e=>{var n;return(t||a)&&e.contextValue?a?`{{${e.contextValue.objectName}.${e.contextValue.objectPropertyName}}}`:null===(n=t[e.contextValue.objectName])||void 0===n?void 0:n[e.contextValue.objectPropertyName]:Object.assign({},e).value},i=(e,t)=>{var n;const a=o(e),i=l(e.fieldName,t);if("$age"===e.type||"$duration"===e.type){const{comparator:t,argsLeftToRight:l=!0,otherField:o}=null!==(n=e.complexFilter)&&void 0!==n?n:{},s="$age"===e.type?[i]:[i,o].filter(T);return l||s.reverse(),{$filter:[{$age:s},t,a]}}return"not null"===e.type?{[i+".<>"]:null}:"null"===e.type?{[i]:null}:{[[i,"="===e.type?null:e.type].filter((e=>e)).join(".")]:a}};if(_.some((t=>t.key===e.type))&&"fieldName"in e){return{[`${l(e.fieldName,null==n?void 0:n.columns)}.${e.type}`]:[o(e)]}}if(O(e))return{[e.type]:{[`${e.path.join(".")}`]:i(e.filter)}};if("$term_highlight"===e.type){return{$term_highlight:[[e.fieldName?l(e.fieldName,null==n?void 0:n.columns):"*"],o(e),{matchCase:!1,edgeTruncate:30,returnType:"boolean"}]}}return i(e,null==n?void 0:n.columns)};class AgeFilter extends RTComp{render(){var e,t,n,l,o,i,s;const{filter:r,onChange:c,tables:d,column:m,tableName:p}=this.props,{error:u}=this.state,h=null===(e=d.find((e=>e.name===p)))||void 0===e?void 0:e.columns.filter((e=>e.name!==m.name&&"Date"===e.tsDataType));if(!r||!h)return a.createElement(a.Fragment,null,"Something went wrong. Could not find column ",null==m?void 0:m.name);const g={...null!==(t=r.complexFilter)&&void 0!==t?t:{},argsLeftToRight:null===(l=null===(n=null==r?void 0:r.complexFilter)||void 0===n?void 0:n.argsLeftToRight)||void 0===l||l,comparator:null!==(i=null===(o=null==r?void 0:r.complexFilter)||void 0===o?void 0:o.comparator)&&void 0!==i?i:">"},f=e=>{c({...r,complexFilter:{...g,...e}})},E=[{key:null,label:"NOW"},...h.map((e=>({key:e.name,label:e.label})))];return a.createElement("div",{className:"flex-col gap-p25"},"$age"!==(null==r?void 0:r.type)&&a.createElement("div",{className:"flex-row p-p25 gap-p25 ai-center"},a.createElement(Btn_Btn,{size:"small",color:"action",onClick:()=>{f({argsLeftToRight:!g.argsLeftToRight})}},!1===g.argsLeftToRight?"Up to":"Since"),a.createElement(Select_Select,{size:"small",value:null!==(s=g.otherField)&&void 0!==s?s:null,fullOptions:E,onChange:e=>{f({otherField:e})}})),a.createElement("div",{className:"flex-row p-p25 gap-p25"},a.createElement(Select_Select,{size:"small",className:"text-blue-400",value:g.comparator,fullOptions:[...A,...C.filter((({key:e})=>"<>"===e||"="===e))],onChange:e=>{f({comparator:e})}}),a.createElement(FormField,{asColumn:!0,type:"text",autoComplete:"off",value:r.value,inputStyle:{padding:window.isMobileDevice?"2px 6px":"8px"},hint:"Example: 1 month 2 days",error:u,onChange:e=>{c({...r,disabled:!1,value:`${e}`})}})))}}function M(e){const[t,n]=(0,a.useState)(),[l,o]=(0,a.useState)(),{render:i,content:s,style:r={},className:c="",onClickClose:d,initialState:m={},footer:p,onClose:u,raiseButton:h,...g}=e,[f,E]=(0,a.useState)(m),v=Boolean(t),b=()=>n(null);let y=null;return t&&(y=a.createElement(Popup,{positioning:"inside",...g,onClose:()=>{null==u||u(),n(null)},onClickClose:null!=d?d:!Boolean(i),open:v,content:i?i(b,f,(e=>E({...f,...e}))):s||e.children,footer:p?p(b):void 0,anchorEl:l})),a.createElement(a.Fragment,null,a.createElement("div",{ref:e=>{e&&o(e)},style:{...r,...h&&v&&{zIndex:5}},className:"h-fit w-fit "+c,onClick:e=>{(null==l?void 0:l.contains(e.nativeEvent.target))?n(e.nativeEvent.target):n(null)}},e.button),y)}AgeFilter.TYPES=["$age","$duration"];const F=["=","<>",">=","<=",">","<"];class FilterWrapper extends RTComp{constructor(){super(...arguments),this.state={searchTerm:""},this.onDelta=e=>{const{filter:t,db:n,tableName:a}=this.props,l=n[a];t&&(null==e?void 0:e.filter)&&"fieldName"in t&&void 0!==t.value&&(null==l?void 0:l.find)&&l.find(k(t),{limit:0}).then((()=>{this.setState({error:void 0})})).catch((e=>{this.setState({error:e})}))}}render(){var e,t,n;const{onChange:l,filter:o,column:i,children:r,className:c="",style:d={},label:m=(null==i?void 0:i.name),hideToggle:p=!1}=this.props,{error:u}=this.state,h=!!(null==o?void 0:o.minimised),g=null!==(e=null==o?void 0:o.fieldName)&&void 0!==e?e:i.name,f=e=>{l({...o,fieldName:g,minimised:!h})},E=[...(i.tsDataType,[...x,..._]),...["number","Date","string"].includes(i.tsDataType)?A:[],...["Date"].includes(i.tsDataType)?R:[]],v="$term_highlight"===(null==o?void 0:o.type)&&"*"===g?[x.find((e=>"$term_highlight"===e.key))]:[...C,...E],b=!p&&o&&a.createElement(Checkbox,{title:"Toggle filter",checked:!o.disabled,className:"FILTERTOGGLE bg-white mr-p5",variant:"minimal",onChange:e=>{l({...o,disabled:!e.target.checked})}}),y="Click to expand/collapse";if(h){const e=26,l=(t,n)=>{var s;if(o.contextValue)return`{{${o.contextValue.objectName}.${o.contextValue.objectPropertyName}}}`;if(Array.isArray(t)){if("$between"===o.type)return n?[l(o.value[0],n),"AND",l(o.value[1],n)].join(" "):a.createElement(a.Fragment,null,l(o.value[0],n),a.createElement("span",{className:"ws-pre text-gray-500 font-normal font-14"}," AND "),l(o.value[1],n));if(n)return"(\n"+t.map((e=>JSON.stringify(e))).join(", \n")+"\n)";return t.join().length>e&&t.length<5?`( ${t.map((e=>JSON.stringify(Gl(e,10)))).join(", ")} ) `:a.createElement(a.Fragment,null,"( ",Gl(JSON.stringify(t).slice(1,-1),e,"...")," )",t.length>2&&a.createElement("div",{className:"min-w-0 min-h-0 o-hidden text-gray-500 ml-p5 flex-row ai-center ",style:{fontWeight:600}}," (",t.length,")"))}const r=!x.some((({key:e})=>o.type===e))&&"Date"===i.tsDataType&&"string"==typeof t&&t;if(t&&t instanceof Date&&t.toLocaleDateString||r){const e=new Date(t);return"date"===i.udt_name||e.toISOString().endsWith("00:00:00.000Z")?null!==(s=e.toISOString().split("T")[0])&&void 0!==s?s:"":e.toLocaleDateString()}return JSON.stringify(t||"")},{disabled:s,value:r}=o,p=null!==(n=null===(t=null==v?void 0:v.find((e=>e.key===o.type)))||void 0===t?void 0:t.label)&&void 0!==n?n:o.type;let u=l(o.value,!1);const h=l(o.value,!0);return a.createElement("div",{title:y,className:"FilterWrapper_MinimisedRoot flex-row ai-center noselect pointer relative o-hidden "+c,style:{...d,background:"rgb(236, 247, 255)",border:"1px solid rgb(226, 226, 226)",borderRadius:"1em",padding:"2px 6px"}},b,a.createElement("button",{style:{background:"transparent",padding:"0"},onClick:f},a.createElement("div",{className:"flex-row ai-center noselect pointer relative o-hidden "},a.createElement("div",{className:"FILTERLABEL text-blue-800 font-18 mr-p25 "+(void 0===r||s?" text-gray-500 ":""),style:{fontWeight:600}},m),a.createElement("div",{className:"FILTERTYPELABEL mr-p25 font-14 ",style:{color:"rgb(126 126 126)",textTransform:"uppercase",height:"18px"}},p),"not null"!==o.type&&"null"!==(null==o?void 0:o.type)&&a.createElement(a.Fragment,null,a.createElement("div",{className:"min-w-0 min-h-0 o-hidden font-16 flex-row ai-center ",title:h,style:{whiteSpace:"nowrap",fontWeight:600,color:s?"gray":"string"===i.tsDataType?"#810909":"Date"===i.tsDataType?"#0000ad":"number"===i.tsDataType?"rgb(0, 110, 0)":"black"}},u)))))}const N=void 0!==(null==o?void 0:o.value)||!!(null==o?void 0:o.contextValue);return a.createElement("div",{className:"FilterWrapper flex-col bg-white relative "+c,style:{maxWidth:"400px",maxHeight:"50vh",...d}},a.createElement("div",{className:"flex-row ai-start p-p5 "},a.createElement("div",{title:y,className:"flex-row-wrap gap-p5 f-1 font-medium noselect mr-p5 pointer noselect  ai-center"},b,a.createElement(Btn_Btn,{className:"FilterWrapper_Field flex-row "+(N?" text-blue-800 ":" text-gray-400  "),style:{background:"aliceblue"},onClick:f},m),!!v&&a.createElement(Select_Select,{className:"FilterWrapper_Type",title:"Choose filter type",fullOptions:v.map((e=>({...e}))),value:(null==o?void 0:o.type)||"",onChange:e=>{var t,n;let a={...o,type:e,fieldName:g};"Date"===i.tsDataType||Array.isArray(null==o?void 0:o.value)&&"$between"!==e&&"$in"!==e&&"$nin"!==e||("$between"===e||"$in"===e||"$nin"===e)&&!Array.isArray(null==o?void 0:o.value)?(delete a.value,a.disabled=!0):"string"!=typeof a.value&&x.some((t=>t.key===e))&&(a.value=(null!==(t=a.value)&&void 0!==t?t:"")+"",a.disabled=!0),a.contextValue&&!F.includes(a.type)&&(delete a.contextValue,null!==(n=a.value)&&void 0!==n||(a.value="")),l(a)}})),a.createElement(Btn_Btn,{iconPath:s.x9U,title:"Delete filter",onClick:()=>{l()}})),r,a.createElement(ErrorComponent,{error:u}))}}class ListFilter extends RTComp{constructor(){super(...arguments),this.state={searchTerm:""},this.setTerm=async e=>{if(this.searching){if(this.searching.term===e)return;clearTimeout(this.searching.timeout)}"string"!=typeof e?this.setState({searchingItems:!1}):(this.state.searchingItems||this.setState({searchingItems:!0}),this.searching={term:e,timeout:setTimeout((async()=>{var t,n,a,l,o,i,s,r,c,d;this.setState({searchingItems:!0});try{const{db:m,column:p,tableName:u,tables:h,otherFilters:g}=this.props;let f=(null===(n=null===(t=null==p?void 0:p.references)||void 0===t?void 0:t[0])||void 0===n?void 0:n.ftable)||u,E=(null===(o=null===(l=null===(a=null==p?void 0:p.references)||void 0===a?void 0:a[0])||void 0===l?void 0:l.fcols)||void 0===o?void 0:o[0])||p.name,v=Boolean(null===(s=null===(i=null==p?void 0:p.references)||void 0===i?void 0:i[0])||void 0===s?void 0:s.ftable),b=!0,y={};if(f&&(null===(r=null==m?void 0:m[f])||void 0===r?void 0:r.find)){const t=null===(c=h.find((e=>e.name===f)))||void 0===c?void 0:c.columns.find((e=>e.name===E));if(!t)throw new Error("Column not found: "+E);"jsonb"===t.udt_name&&(b=!1);const n=Vl(g),a=v?{$existsJoined:{[u]:n}}:n;let l=await SmartFormField.getSuggestions({db:m,col:t,table:f,term:e,groupBy:b,filter:a});v&&p.is_nullable&&!l.includes(null)&&l.unshift(null);let o=l.map((e=>({raw:e,display:"jsonb"===t.udt_name?JSON.stringify(e):null===e?"NULL":e})));y={options:o,searchingItems:!1,error:void 0},this.state.options||(y={...y,allOptionsCount:o.length})}e===(null===(d=this.searching)||void 0===d?void 0:d.term)?(this.setState(y),this.searching=void 0):this.setState({searchingItems:!1,error:void 0})}catch(e){this.setState({error:e})}}),400)})},this.onDelta=async(e,t={},n)=>{const{db:a,column:l,tableName:o,tables:i,otherFilters:s}=this.props,{searchTerm:r=""}=this.state;this.state.options&&!("searchTerm"in t)||this.setTerm(r)}}render(){const{filter:e,onChange:t,tables:n,column:l,tableName:o}=this.props,{error:i,options:s,searchTerm:r,searchingItems:c,allOptionsCount:d}=this.state;if(!e)return a.createElement(a.Fragment,null,"Something went wrong. Could not find column ",null==l?void 0:l.name);if(!s)return a.createElement("div",{className:"p-1 relative f-1"},a.createElement(Loading,{delay:0}));let m=[];!r&&Array.isArray(null==e?void 0:e.value)&&(null==e?void 0:e.value.length)&&(m=null==e?void 0:e.value.filter((e=>!s.includes(e))));let p=Array.from(new Set([...m,...s.map((e=>e.raw))])).map((e=>{var t,n;return{raw:e,display:null!==(n=null===(t=s.find((t=>t.raw===e)))||void 0===t?void 0:t.display)&&void 0!==n?n:e}})).map((({display:n,raw:a})=>({key:a,label:null===n?"NULL":n,title:`${n}`,style:null===a?{fontStyle:"italic",opacity:.7}:void 0,onPress:()=>{let n=Array.isArray(e.value)?e.value.slice(0):[];n.includes(a)?n=n.filter((e=>e!==a)):n.push(a),n.length||(n=void 0),t({...e,disabled:!1,value:n})},checked:Boolean((null==e?void 0:e.value)&&Array.isArray(null==e?void 0:e.value)&&(null==e?void 0:e.value.includes(a)))})));return a.createElement(a.Fragment,null,c&&a.createElement(Loading,{variant:"cover"}),a.createElement(SearchList,{onSearch:e=>{this.setState({searchTerm:e})},noSearchLimit:8,id:"values",items:p,onMultiToggle:n=>{const a=n.filter((e=>e.checked));t({...e,value:(null==a?void 0:a.length)?a.map((e=>e.key)):void 0})},onChange:n=>{t({...e,value:(null==n?void 0:n.length)?n:void 0})}}))}}ListFilter.TYPES=["$in","$nin"];class NumberOrDateFilter extends RTComp{constructor(){super(...arguments),this.state={},this.onDelta=async(e,t,n)=>{const{db:a,column:l,tableName:o}=this.props,i=null==a?void 0:a[o];if(!this.state.limits&&o&&(null==i?void 0:i.findOne)){const e=await i.findOne({},{select:{min:{$min:[l.name]},max:{$max:[l.name]}}});this.setState({limits:e}),this.setValue(e)}},this.setValue=(e,t=!1)=>{var n,a,l,o;const{column:i,filter:s}=this.props;let{min:r=(null===(n=null==s?void 0:s.value)||void 0===n?void 0:n[0]),max:c=(null===(a=null==s?void 0:s.value)||void 0===a?void 0:a[1]),_val:d=(null==s?void 0:s.value)}=e;const m="Date"===i.tsDataType;m&&(r=new Date(r),c=new Date(c),d=new Date(d));let p=null!==(o=null===(l=this.props.filter)||void 0===l?void 0:l.type)&&void 0!==o?o:"$between",u=[r,c];if("time"===i.udt_name)"$between"===p?(r&&c&&r>c&&(r=c),u=[r,c]):u=d;else if(null===d)u=d;else if(d&&Number.isFinite(+d))u=+d;else if(r&&Number.isFinite(+r)&&c&&Number.isFinite(+c))+r>+c&&(r=+c),u=[+r,+c];else if(r&&Number.isFinite(+r)&&"$between"===p)u=[+r,+r+1];else{if(!c||!Number.isFinite(+c)||"$between"!==p)return void console.warn("Invalid filter value");u=[+c-1,+c]}m&&null!==u&&(u=Array.isArray(u)?u.map((e=>new Date(e))):new Date(u)),this.props.onChange({fieldName:i.name,type:p,value:u,disabled:!1})}}render(){var e,t,n;const{filter:l,column:o,type:i,inputType:s,tables:r,onChange:c}=this.props;if(!o)return null;const d=null!==(e=null==l?void 0:l.type)&&void 0!==e?e:"=";let m="$between"===d?null===(t=null==l?void 0:l.value)||void 0===t?void 0:t[0]:">="===d?null==l?void 0:l.value:null,p="$between"===d?null===(n=null==l?void 0:l.value)||void 0===n?void 0:n[1]:"<="===d?null==l?void 0:l.value:null;const u={className:"p-p25 mr-p5",style:"date"===i?{}:{maxWidth:"125px"},inputStyle:{padding:"4px"},type:s,asColumn:!0};return a.createElement("div",{className:"flex-row-wrap f-1 p-p5",style:{minWidth:"150px"}},a.createElement(FormField,{...u,value:SmartFormField.parseValue(o,m),label:"Min",onChange:e=>{this.setValue({min:e})}}),a.createElement(FormField,{...u,value:SmartFormField.parseValue(o,p),label:"Max",onChange:e=>{this.setValue({max:e})}}))}}NumberOrDateFilter.TYPES=["$between"];const P=({className:e,onChange:t,value:n,contextData:l,column:o})=>{var i;const r=l.flatMap((e=>e.columns.filter((e=>e.tsDataType===o.tsDataType)).map((t=>({id:e.name+"."+t.name,tableName:e.name,...t}))))),c=n?`${n.objectName}.${n.objectPropertyName}`:void 0;return a.createElement("div",{className:null!==(i="ContextDataSelector flex-row ai-center "+e)&&void 0!==i?i:""},a.createElement(Select_Select,{title:"From context data",emptyLabel:"",btnProps:n?void 0:{iconPath:s.JEH},value:c,className:e,style:{maxHeight:"unset"},fullOptions:r.map((e=>({key:e.id,label:`${e.tableName}.${e.name}`,subLabel:e.data_type}))),onChange:e=>{const n=r.find((t=>t.id===e));n&&t({objectName:n.tableName,objectPropertyName:n.name})}}),n&&a.createElement(Btn_Btn,{iconPath:s.r5M,title:"Remove context value",onClick:()=>{t(void 0)}}))};let H=0;a.forwardRef((({title:e=null,description:t=null,size:n=null,color:l="currentColor",horizontal:o=null,vertical:i=null,rotate:s=null,spin:r=null,style:c={},children:d,...m},p)=>{H++;let u=null!==r&&r;const h=a.Children.map(d,(e=>{const t=e;!0!==u&&(u=!0===(null===r?t.props.spin:r));let c=t.props.size;"number"==typeof n&&"number"==typeof t.props.size&&(c=t.props.size/n);const d={size:c,color:null===l?t.props.color:l,horizontal:null===o?t.props.horizontal:o,vertical:null===i?t.props.vertical:i,rotate:null===s?t.props.rotate:s,spin:null===r?t.props.spin:r,inStack:!0};return a.cloneElement(t,d)}));let g;null!==n&&(c.width="string"==typeof n?n:1.5*n+"rem");let f,E=`stack_labelledby_${H}`,v=`stack_describedby_${H}`;if(e)g=t?`${E} ${v}`:E;else if(f="presentation",t)throw new Error("title attribute required when description is set");return a.createElement("svg",{ref:p,viewBox:"0 0 24 24",style:c,role:f,"aria-labelledby":g,...m},e&&a.createElement("title",{id:E},e),t&&a.createElement("desc",{id:v},t),u&&a.createElement("style",null,"@keyframes spin { from { transform: rotate(0deg) } to { transform: rotate(360deg) } }","@keyframes spin-inverse { from { transform: rotate(0deg) } to { transform: rotate(-360deg) } }"),h)}));let B=0;const W=a.forwardRef((({path:e,id:t=++B,title:n=null,description:l=null,size:o=1,color:i="currentColor",horizontal:s=!1,vertical:r=!1,rotate:c=0,spin:d=!1,style:m={},inStack:p=!1,...u},h)=>{const g={...m},f={},E=[];null!==o&&(p?E.push(`scale(${o})`):(g.width="string"==typeof o?o:1.5*o+"rem",g.height=g.width)),s&&E.push("scaleX(-1)"),r&&E.push("scaleY(-1)"),0!==c&&E.push(`rotate(${c}deg)`),null!==i&&(f.fill=i);let v=a.createElement("path",{d:e,style:f,...p?u:{}}),b=v;E.length>0&&(g.transform=E.join(" "),g.transformOrigin="center",p&&(b=a.createElement("g",{style:g},v,a.createElement("rect",{width:"24",height:"24",fill:"transparent"}))));let y=b;const N=!0===d||"number"!=typeof d?2:d;let w,S=!p&&(s||r);if(N<0&&(S=!S),d&&(y=a.createElement("g",{style:{animation:`spin${S?"-inverse":""} linear ${Math.abs(N)}s infinite`,transformOrigin:"center"}},b,!(s||r||0!==c)&&a.createElement("rect",{width:"24",height:"24",fill:"transparent"}))),p)return y;let T,C=`icon_labelledby_${t}`,_=`icon_describedby_${t}`;if(n)w=l?`${C} ${_}`:C;else if(T="presentation",l)throw new Error("title attribute required when description is set");return a.createElement("svg",{ref:h,viewBox:"0 0 24 24",style:g,role:T,"aria-labelledby":w,...u},n&&a.createElement("title",{id:C},n),l&&a.createElement("desc",{id:_},l),!p&&d&&(S?a.createElement("style",null,"@keyframes spin-inverse { from { transform: rotate(0deg) } to { transform: rotate(-360deg) } }"):a.createElement("style",null,"@keyframes spin { from { transform: rotate(0deg) } to { transform: rotate(360deg) } }")),y)}));class MenuList extends a.Component{constructor(){super(...arguments),this.state={collapsed:!1},this.renderItem=(e,t,n=!1)=>{const l=!(!e.onPress||e.disabledText||n);return a.createElement("li",{key:t,role:"listitem",tabIndex:l?0:void 0,title:e.disabledText||e.title,style:{...e.style||{},...e.disabledText?{cursor:"not-allowed",opacity:.5}:{}},className:"flex-row  p-p5  text-gray-700 "+(!e.disabledText&&e.onPress?" pointer ":" "),onClick:l?()=>{var t;null===(t=e.onPress)||void 0===t||t.call(e)}:void 0,onKeyUp:l?t=>{var n;"Enter"===t.key&&(null===(n=e.onPress)||void 0===n||n.call(e))}:void 0},a.createElement("label",{className:"mr-p5 f-1 flex-row ai-center ",style:{cursor:"inherit"}},!!e.leftIconPath&&a.createElement(W,{className:"mr-p5 f-0",path:e.leftIconPath,size:1,style:e.iconStyle}),e.label?a.createElement("div",{style:e.labelStyle},e.label):e.label," ",e.contentRight||null))}}render(){var e,t;const{className:n="",style:l={},items:o=[],activeKey:i=(null===(e=this.props.items[0])||void 0===e?void 0:e.key)}=this.props,r="dropdown"===this.props.variant,c=this.props.variant&&!r?this.props.variant:"vertical",d=a.createElement("div",{className:" menu list-comp bg-white rounded "+("vertical"===c?" f-1 max-w-fit min-w-fit ":"")+n,style:{maxHeight:"99vh",padding:0,...l},onKeyDown:e=>{var t,n;if(!this.refList)return;const a=this.refList.lastChild,l=this.refList.firstChild,o=null===(t=document.activeElement)||void 0===t?void 0:t.previousElementSibling,i=null===(n=document.activeElement)||void 0===n?void 0:n.nextElementSibling;switch(e.key){case"ArrowUp":document.activeElement===l?a.focus():this.refList.childElementCount&&o.focus();break;case"ArrowDown":document.activeElement===a?l.focus():this.refList.childElementCount&&i.focus()}}},a.createElement("ul",{className:"f-1 o-auto min-h-0 min-w-0 "+("vertical"===c?" flex-col ws-nowrap ":"flex-row "),role:"list",ref:e=>{e&&(this.refList=e)},style:{padding:0}},o.filter((e=>!e.hide)).map(((e,t)=>this.renderItem(e,t)))));if(r){const e=null!==(t=o.find((e=>{var t;return i===(null!==(t=e.key)&&void 0!==t?t:e.label)})))&&void 0!==t?t:o[0];return a.createElement(M,{style:{width:"100%"},positioning:"beneath-left",button:a.createElement("button",{className:"bg-blue-300-hover:hover",style:{width:"100%",borderRadius:0}},a.createElement("div",{className:"flex-row ai-center"},this.renderItem(e,0,!0),a.createElement(W,{path:s.$Qi,className:"f-0 ml-auto",size:1}))),onClickClose:!0,contentStyle:{padding:0},render:e=>d})}return d}}var $=function(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,n=e[Symbol.asyncIterator];return n?n.call(e):(e="function"==typeof __values?__values(e):e[Symbol.iterator](),t={},a("next"),a("throw"),a("return"),t[Symbol.asyncIterator]=function(){return this},t);function a(n){t[n]=e[n]&&function(t){return new Promise((function(a,l){(function(e,t,n,a){Promise.resolve(a).then((function(t){e({value:t,done:n})}),t)})(a,l,(t=e[n](t)).done,t.value)}))}}};function U(e){return Boolean(e&&"object"==typeof e&&!Array.isArray(e))}const q=e=>{const{columns:t,fieldFilter:n}=e;if(!n)return[];if("*"===n)return t.slice();if(Array.isArray(n))return n.length?t.filter((e=>n.includes(e.toString()))):[];if(U(n)&&Object.keys(n).length){const e=Object.keys(n),a=!Object.values(n)[0];return t.filter((t=>a?!e.includes(t):e.includes(t)))}return[]},j=(e,t,n)=>{const a="$and"in e,l=(a?e.$and:e.$or).map((e=>k(e,t,{columns:n}))).filter(T);return a?{$and:l}:{$or:l}},z=(e,t,n)=>{if(U(e)&&"forcedFilterDetailed"in e&&e.forcedFilterDetailed){const a=j(e.forcedFilterDetailed,t,n);if(a)return{forcedFilter:a}}},Y=(e,t,n=!0)=>{if("*"===e)return e;const a=Object.values(e),l=Object.keys(e);if(!l.length&&n)throw new Error("Must select at least a field");if(a.some((e=>e))&&a.some((e=>!e)))throw new Error("Invalid field filter: must have only include or exclude. Cannot have both");if(!a.every((e=>[0,1,!0,!1].includes(e))))throw new Error("Invalid field filter: field values can only be one of 0,1,true,false");const o=l.filter((e=>!t.includes(e)));if(o.length)throw new Error(`Invalid columns provided: ${o}`);return e},V=(e,t,n)=>{if(!(null==e?void 0:e.forcedDataDetail))return;let a={};return null==e||e.forcedDataDetail.forEach((l=>{if(n.includes(l.fieldName)||new Error(`Invalid fieldName in forced data ${l.fieldName}`),l.fieldName in a)throw new Error(`Duplicate forced data (${l.fieldName}) found in ${JSON.stringify(e)}`);if("fixed"===l.type)a[l.fieldName]=l.value;else{const e=t[l.objectName];if(!e)throw new Error(`Missing objectName (${l.objectName}) in forcedData`);if(!(l.objectPropertyName in e))throw new Error(`Invalid/missing objectPropertyName (${l.objectPropertyName}) found in forcedData`);a[l.fieldName]=e[l.objectPropertyName]}})),{forcedData:a}},G=(e,t,n)=>e&&!0!==e?Object.assign(Object.assign(Object.assign({fields:Y(e.fields,t)},z(e,n,t)),e.orderByFields&&{orderByFields:Y(e.orderByFields,t,!1)}),e.filterFields&&{filterFields:Y(e.filterFields,t,!1)}):e,J=(e,t,n)=>{var a;return e&&!0!==e?Object.assign(Object.assign(Object.assign(Object.assign({fields:Y(e.fields,t)},z(e,n,t)),V(e,n,t)),e.filterFields&&{filterFields:Y(e.filterFields,t,!1)}),(null===(a=e.dynamicFields)||void 0===a?void 0:a.length)&&{dynamicFields:e.dynamicFields.map((e=>({fields:Y(e.fields,t),filter:j(e.filterDetailed,n,t)})))}):e},X=(e,t,n)=>e&&!0!==e?Object.assign({fields:Y(e.fields,t)},V(e,n,t)):e,K=(e,t,n)=>e&&!0!==e?Object.assign(Object.assign({},z(e,n,t)),{filterFields:Y(e.filterFields,t)}):e,Q=async(e,t,n)=>{let a={};return await Promise.all(Object.keys(e).map((async l=>{const o=l,i=e[o];try{((e,t=!1,n,a)=>{!![!0,"*"].includes(e)||!!U(e)&&Object.assign({select:G(e.select,n,a)},t?{}:{insert:X(e.insert,n,a),update:J(e.update,n,a),delete:K(e.delete,n,a)})})({[o]:i},!1,t,n)}catch(e){a[o]=e}}))),a};class Tabs extends RTComp{constructor(){super(...arguments),this.state={controlsCollapsed:!1},this.checkVariant=()=>{if(!this.mounted)return;const{variant:e="horizontal"}=this.props;if(this.rootDiv&&U(e)){const{contentBreakpoint:t,controlsBreakpoint:n,controlsCollapseWidth:a}=e;let l=this.state.variant,o=this.rootDiv.offsetWidth<a;l=this.rootDiv.offsetWidth<t+n?"horizontal":"vertical",l!==this.state.variant&&this.setState({variant:l}),o!==this.state.controlsCollapsed&&this.setState({controlsCollapsed:o})}}}onUnmount(){var e;this.rootDiv&&(null===(e=this.sizeObeserver)||void 0===e||e.unobserve(this.rootDiv))}onDelta(e,t,n){var a,l;const{variant:o="horizontal"}=this.props;(null==e?void 0:e.variant)&&this.rootDiv&&(null===(a=this.sizeObeserver)||void 0===a||a.unobserve(this.rootDiv),U(o)&&(this.sizeObeserver=new ResizeObserver(this.checkVariant),null===(l=this.sizeObeserver)||void 0===l||l.observe(this.rootDiv))),this.state.variant||U(o)||o!==this.state.variant&&this.setState({variant:o})}render(){var e,t,n,l;const{className:o="",style:i={},contentClass:r="",onChange:d,compactMode:m,onRender:p}=this.props,{variant:u,controlsCollapsed:h}=this.state,g=this.props.items||{},f=null!==(t=null!==(e=this.props.activeKey)&&void 0!==e?e:this.state.activeKey)&&void 0!==t?t:this.props.defaultActiveKey;let E=null;"string"==typeof f&&(null===(n=g[f])||void 0===n?void 0:n.content)&&(E=p?p(g[f]):g[f].content);let v={borderColor:"transparent",borderRightStyle:"solid",borderRightWidth:"2px"},b="flex-row ";"horizontal"===u&&(b="flex-col ",v={borderColor:"transparent",borderBottomStyle:"solid",borderBottomWidth:"2px"}),m&&(v={borderColor:"transparent"});let y={...v,color:"var(--blue-600)"},N=!1;m&&f&&(b="flex-col ",N=!0);const w=f?null===(l=null==g?void 0:g[f])||void 0===l?void 0:l.leftIconPath:void 0;return a.createElement("div",{ref:e=>{e&&(this.rootDiv=e)},style:{...i,...!u&&{opacity:0}},className:"TABSROOT "+b+" min-w-0 min-h-0 f-1 "+o},N?a.createElement("div",{className:"flex-row ai-center",style:{backgroundColor:"aliceblue"}},a.createElement(Btn_Btn,{iconPath:s.J3k,onClick:()=>{this.setState({activeKey:void 0}),d&&d(void 0)}},f),w&&a.createElement(c(),{className:"text-gray-400 mr-1",path:w,size:1})):a.createElement(MenuList,{style:{zIndex:1},className:"f-0 w-full noselect shadow ",variant:h?"dropdown":u,activeKey:f,items:Object.keys(g).filter((e=>!g[e].hide)).map((e=>{var t,n,a,l,o;return{key:e,label:(null===(t=g[e])||void 0===t?void 0:t.label)||e,leftIconPath:null===(n=g[e])||void 0===n?void 0:n.leftIconPath,disabledText:null===(a=g[e])||void 0===a?void 0:a.disabledText,style:{...e===f?y:v,...(null===(l=g[e])||void 0===l?void 0:l.style)||{}},onPress:(null===(o=g[e])||void 0===o?void 0:o.disabledText)?void 0:()=>{d&&d(e),this.setState({activeKey:e})}}}))}),E?a.createElement("div",{className:"f-1 "+r},E):null)}}const Z=Math.round;function ee(e){const t=e.length,n={};return"rgb"===e.slice(0,3).toLowerCase()?(e=e.replace(" ","").split(","),n[0]=parseInt(e[0].slice("a"===e[3].toLowerCase()?5:4),10),n[1]=parseInt(e[1],10),n[2]=parseInt(e[2],10),n[3]=e[3]?parseFloat(e[3]):-1):(e=t<6?parseInt(String(e[1])+e[1]+e[2]+e[2]+e[3]+e[3]+(t>4?String(e[4])+e[4]:""),16):parseInt(e.slice(1),16),n[0]=e>>16&255,n[1]=e>>8&255,n[2]=255&e,n[3]=9===t||5===t?Z((e>>24&255)/255*1e4)/1e4:-1),n}function te(e,t,n=.5){e=e.trim(),t=t.trim();n=n<0?-1*n:n;const a=ee(e),l=ee(t);if("r"===t[0]){const e=a[3]>-1&&l[3]>-1?Z(1e4*((l[3]-a[3])*n+a[3]))/1e4:l[3]<0?a[3]:l[3];return"rgb"+("a"===t[3]?"a(":"(")+Z((l[0]-a[0])*n+a[0])+","+Z((l[1]-a[1])*n+a[1])+","+Z((l[2]-a[2])*n+a[2])+(a[3]<0&&l[3]<0?"":","+e)+")"}return"#"+(4294967296+16777216*(a[3]>-1&&l[3]>-1?Z(255*((l[3]-a[3])*n+a[3])):l[3]>-1?Z(255*l[3]):a[3]>-1?Z(255*a[3]):255)+65536*Z((l[0]-a[0])*n+a[0])+256*Z((l[1]-a[1])*n+a[1])+Z((l[2]-a[2])*n+a[2])).toString(16).slice(a[3]>-1||l[3]>-1?1:3)}var ne=n(64926),ae=n.n(ne);const le=["image","video","audio"];class MediaViewer extends RTComp{constructor(){super(...arguments),this.state={isFocused:!1,url:void 0},this.onKeyDown=e=>{const{onPrevOrNext:t}=this.props;"ArrowRight"===e.key?(e.preventDefault(),null==t||t(1)):"ArrowLeft"===e.key&&(e.preventDefault(),null==t||t(-1))},this.setURL=async e=>{var t,n,a,l;if(!e)return;let o;if("allowedContentTypes"in this.props||!("content_type"in this.props))if("allowedContentTypes"in this.props&&1===(null===(t=this.props.allowedContentTypes)||void 0===t?void 0:t.length))o=this.props.allowedContentTypes[0];else{const t=await function(e){return new Promise(((t,n)=>{var a=new XMLHttpRequest;a.open("GET",e,!0),a.setRequestHeader("Range","bytes=0"),a.onreadystatechange=function(){this.readyState==this.DONE?t(this.getResponseHeader("Content-Type")):n(a.statusText)},a.send()}))}(e),i=null===(a=null===(n=null==t?void 0:t.split(";"))||void 0===n?void 0:n[0])||void 0===a?void 0:a.trim();if("allowedContentTypes"in this.props&&!(null===(l=this.props.allowedContentTypes)||void 0===l?void 0:l.find((e=>null==i?void 0:i.startsWith(e)))))throw`ContentType ${i} is not allowed. Allowed ContentTypes: ${this.props.allowedContentTypes}`;o=i}else"content_type"in this.props&&(o=this.props.content_type);const i=le.find((e=>null==o?void 0:o.startsWith(e)));if(o&&!i)throw`ContentType prefix ${o} is not recognised/supported. Supported ContentTypes preffixes ${le}`;this.setState({url:{raw:e,validated:e,content_type:o}})},this.renderMedia=()=>{if(!this.state.url)return null;const{isFocused:e}=this.state,{validated:t,content_type:n}=this.state.url;let l=null;if(t){const o={style:{minHeight:0,flex:1,maxWidth:"100%",maxHeight:"100%",objectFit:"contain",...this.props.style},className:"b b-gray-300 "};(null==n?void 0:n.startsWith("image"))?l=a.createElement("img",{loading:"lazy",src:t,...o}):(null==n?void 0:n.startsWith("video"))?l=a.createElement("video",{...o,controls:!0,src:t,preload:"metadata"}):(null==n?void 0:n.startsWith("audio"))?l=a.createElement("audio",{...o,controls:!0,src:t}):!e&&t&&(l=a.createElement("a",{href:t,target:"_blank",className:"p-1 f-0"},t))}return e?l:a.createElement("div",{className:"relative f-1 noselect flex-row",style:this.props.style},l,a.createElement("div",{className:"absolute w-full h-full pointer",style:{zIndex:1,inset:0},onClick:e=>{e.stopPropagation(),e.preventDefault(),this.setState({isFocused:!0})}}))}}static getMimeFromURL(e){var t,n;if(e&&"string"==typeof e){const a={jpg:1,jpeg:1,png:1,tiff:1,gif:1,svg:1,ico:1},l={mp3:1,wav:1},o={mp4:1,avi:1,ogg:1,webm:1,mov:1},i=null===(n=null===(t=e.split(".").slice(-1))||void 0===t?void 0:t[0])||void 0===n?void 0:n.toLowerCase();if(!i)return;if(a[i])return"image";if(l[i])return"audio";if(o[i])return"video"}}onDelta(e){const{url:t,allowedHostnames:n}=this.props;if((null==e?void 0:e.url)&&t&&this.rawURL!==t)if(this.rawURL=t,n)try{const e=new URL(t);if(!n.includes(e.hostname))throw`Hostname ${e.hostname} is not allowed. Allowed hostnames: ${n}`;this.setURL(t)}catch(e){console.error("Could check media URL",e)}else this.setURL(t)}render(){const{url:e,isFocused:t}=this.state,{onPrevOrNext:n}=this.props;if(t){const t=n?e=>{const{url:t}=n(e);t&&this.setURL(t)}:void 0;return a.createElement(a.Fragment,null,this.renderMedia(),a.createElement(Popup,{open:!0,rootStyle:{padding:0,borderRadius:0},contentClassName:"o-hidden",onClose:()=>{this.setState({isFocused:!1})},autoFocusFirst:"content",focusTrap:!0,title:e?a.createElement("a",{href:e.validated,target:"_blank",className:"p-1 f-0 text-gray-500",style:{fontWeight:400}},e.validated):"",onKeyDown:n?this.onKeyDown:void 0},a.createElement("div",{className:"MEDIAVIEWER relative flex-col f-1 o-auto noselect"},t&&oe(!0,(()=>t(-1))),this.renderMedia(),t&&oe(!1,(()=>t(1))))))}return this.renderMedia()}}const oe=(e,t)=>a.createElement("div",{className:"h-full w-fit absolute text-white flex-row ai-center px-1 pointer",onClick:t,style:{top:0,bottom:0,...e?{left:0}:{right:0},zIndex:2,color:"white",background:`linear-gradient(to ${e?"right":"left"}, black, transparent)`}},a.createElement(c(),{path:s.gAv,style:{color:"white",transform:e?void 0:"rotate(180deg)"},size:"34px"})),ie=(e,t,n,a)=>({key:e,name:t,label:t,sortable:["string","number","boolean","Date"].includes(n),tsDataType:n,udt_name:"text",filter:!0,computed:a}),se=(e,t,n,l)=>{const o=!t.update,i=o?"View row":"View/Edit row",r=o?s.fOx:s.I$6;return{...ie("edit_row"," ","any",!0),filter:!1,sortable:!1,className:"ai-center jc-center",label:"",hidden:!1,width:50,getCellStyle:()=>({padding:0}),onRender:({row:n,nextRow:o,prevRow:s,rowIndex:c})=>a.createElement(Btn_Btn,{className:"h-full h-fit w-fit"+(window.isMobileDevice?" text-gray-300 ":" show-on-row-hover  "),title:i,iconPath:r,style:{padding:"12px"},color:"action",onClick:async a=>{if(a.stopPropagation(),!e)return;const{error:i,filter:r}=await ce(n,e,t);if(i)alert(i);else if(r){const a=await re([s,n,o],1,e,t);l(r,a,c)}}})}},re=async(e,t,n,a)=>{const l=e[t-1],o=e[t+1];let i,s;try{l&&(i=(await ce(l,n,a)).filter),o&&(s=(await ce(o,n,a)).filter)}catch(e){console.error(e)}return{nextRow:o,prevRow:l,prevRowFilter:i,nextRowFilter:s}},ce=async(e,t,n)=>{var a,l;let o;const i=t.filter((e=>e.filter&&e.is_pkey));if(i.length)i.map((t=>{null!=o||(o=[]),o.push({fieldName:t.name,value:e[t.name]})}));else{const n=t.filter((e=>e.filter&&["number","string","boolean"].includes(e.tsDataType))),a=e=>"string"==typeof e&&e.length>400?{">=":`${e.slice(0,625)}%`}:e;o=n.map((t=>({fieldName:t.name,value:a(e[t.name])})))}const s=Vl(o);return yo(s)?{filter:void 0,error:"No filter provided"}:0===await(null===(a=n.count)||void 0===a?void 0:a.call(n,s))?{filter:void 0,error:"Could not create a single row filter. Record was not found"}:1!==await(null===(l=n.count)||void 0===l?void 0:l.call(n,s))?{filter:void 0,error:"Could not create a single row filter. More than one record returned"}:{filter:null!=o?o:[],error:void 0}};var de=n(43215),me=n(69640);const pe=({size:e,url:t,variant:n})=>{const l=(0,a.useRef)(null);if((0,a.useEffect)((()=>{const n=l.current;if(n)if(t){const a=Number.isFinite(e)?{width:e}:{width:Math.min(n.offsetWidth,n.offsetHeight)};me.toCanvas(n,t,a)}else{const e=n.getContext("2d");null==e||e.clearRect(0,0,n.width,n.height)}}),[e,t,l.current]),!t)return null;const o=a.createElement("canvas",{ref:l,style:{}});if("canvas-only"===n)return o;const i=a.createElement("a",{href:t,target:"_blank"},o);return"href-wrapped"===n?i:a.createElement(M,{positioning:"center",title:t,button:o,contentClassName:"ai-center",render:()=>a.createElement(pe,{size:400,url:t,variant:"canvas-only"})})},ue=async({w:e,db:t,tables:n,dbs:l,data:o,windowWidth:i,onSetColumnPopup:r,onClickEditRow:d,onSetFilterPopup:m,barchartVals:p,allowMediaSkip:u})=>{var h;let g=[];if(!e)return g;const f=e.table_name,E=n.find((e=>e.name===f)),v=null==E?void 0:E.columns;if(v){const d=e=>{var t,n;return["'",'"'].includes(null!==(t=e.at(0))&&void 0!==t?t:"")&&["'",'"'].includes(null!==(n=e.at(-1))&&void 0!==n?n:"")?e.slice(1,-1):e};g=$l(n,e,o,i).filter((e=>e.show)).map((e=>{var t;const n=(0,de.quickClone)(e),{tsDataType:a="any",udt_name:l="text"}=null!==(t=n.computedConfig?n.computedConfig.funcDef.outType:n.info)&&void 0!==t?t:{};return{...n,tsDataType:a,udt_name:l}})).map((i=>{var p,h,g,E,v,b,y,N,w,S,T,C,_,x,A,R;const L=a.createElement("div",{className:"flex-row ai-center"},i.computedConfig||i.format?a.createElement(c(),{path:s.oVB,size:.75,className:"color-action ml-p25"}):null,(null===(p=i.info)||void 0===p?void 0:p.is_pkey)?a.createElement("div",{title:"Primary key",className:"flex-row ai-center"},a.createElement(c(),{path:s.FCR,size:.75,className:"mr-p25"}),null===(h=i.info)||void 0===h?void 0:h.udt_name):null===(g=i.info)||void 0===g?void 0:g.udt_name,i.computedConfig&&(null!==(v=null===(E=i.computedConfig)||void 0===E?void 0:E.funcDef.outType.udt_name)&&void 0!==v?v:null===(b=i.computedConfig)||void 0===b?void 0:b.funcDef.outType.tsDataType),(null===(y=null==e?void 0:e.filter)||void 0===y?void 0:y.some((e=>"fieldName"in e&&e.fieldName===i.name&&!e.disabled)))?a.createElement(Btn_Btn,{title:"Has active filter",iconPath:s.k0z,style:{padding:0},size:"micro",className:"color-action ml-p25",onClick:t=>{t.stopPropagation(),t.preventDefault();const n=e;n.$update({options:{showFilters:!(null==n?void 0:n.options.showFilters)}},{deepMerge:!0})}}):null),O=["$duration","$age"].includes(null===(N=i.computedConfig)||void 0===N?void 0:N.funcDef.key)?({row:e})=>{var t;return Object.keys(null!==(t=e[i.name])&&void 0!==t?t:{}).map((t=>`${e[i.name][t]} ${t}`)).join(", ")}:"UNIX Timestamp"===i.format?({row:e})=>e[i.name]&&(+e[i.name]).toString()===e[i.name]?(new Date).toISOString():e[i.name]:"QR Code"===i.format?({value:t})=>(null==t?void 0:t.toString().trim().length)?a.createElement(pe,{url:t,size:90,variant:"table-cell"}):SmartFormField.renderValue(i,t,void 0,e.options.maxCellChars):"HTML"===i.format?({row:e})=>{var t;return a.createElement("div",{className:"relative min-w-0 min-h-0",dangerouslySetInnerHTML:{__html:i.noSanitize?null!==(t=e[i.name])&&void 0!==t?t:"":ae()(e[i.name],{allowedTags:ae().defaults.allowedTags.concat(i.allowedHTMLTags||[]),parser:{lowerCaseAttributeNames:!1}})}})}:["URL","Email","Tel"].includes(i.format)?({row:e})=>a.createElement("a",{href:("Email"===i.format?"mailto:":"Tel"===i.format?"tel:":"")+d(e[i.name]),target:"_blank"},d(e[i.name])):"Media"===i.format&&i.contentConfig?({row:e,rowIndex:t,nextRow:n,prevRow:l})=>{var s;return e[i.name]&&a.createElement(MediaViewer,{url:e[i.name],allowedContentTypes:"fixed"in i.contentConfig?[null!==(s=i.contentConfig.fixed)&&void 0!==s?s:"image"]:"fromColumn"in i.contentConfig?[e[i.contentConfig.fromColumn]]:[MediaViewer.getMimeFromURL(e[i.name])],onPrevOrNext:u?e=>{console.error("MUST HAVE A PARENT VIEWER MANAGING NEXT AND PREV URLS");const n=null==o?void 0:o[t+e];return{url:null==n?void 0:n[i.name]}}:void 0})}:({row:t})=>{var n;return SmartFormField.renderValue(i.tsDataType?i:i.info||(null===(n=i.computedConfig)||void 0===n?void 0:n.funcDef.outType),t[i.name],void 0,e.options.maxCellChars)},I={...i,filter:null!==(S=null===(w=i.info)||void 0===w?void 0:w.filter)&&void 0!==S&&S,sortable:!!i.computedConfig||!!(null===(T=i.info)||void 0===T?void 0:T.orderBy)&&"json"!==(null===(C=i.info)||void 0===C?void 0:C.udt_name),computed:!!i.computedConfig,key:i.name,label:i.name+((null===(_=i.info)||void 0===_?void 0:_.references)?` (${null===(x=i.info)||void 0===x?void 0:x.references.map((e=>e.ftable)).join(", ")})`:""),subLabelTitle:"Data type",subLabel:L,title:`${i.name}\n(${i.udt_name})\n${(null===(A=i.info)||void 0===A?void 0:A.comment)||""}`,hidden:"$rowhash"===i.name,width:null!==(R=i.width)&&void 0!==R?R:100,onRender:O,getCellStyle:()=>"Media"===i.format?{display:"flex"}:{},onContextMenu:(o,s)=>{o.preventDefault();let c={key:"columnMenu",style:{padding:0},anchorEl:o.currentTarget,positioning:"beneath-left",content:a.createElement(ColumnMenu,{onAddFilter:m,db:t,dbs:l,tableName:f,colName:i.name,tables:n,w:e,onClose:()=>{r(void 0)}})};return r(c),!1}};return I}))}e&&e.columns&&(Array.isArray(e.columns)?g=g.map((e=>{const t=e;if(t&&t.style&&t.style.type&&"None"!==t.style.type){if("Barchart"===t.style.type||"Scale"===t.style.type){let{minValue:n,maxValue:a}=(null==p?void 0:p[e.name])||{};t.style.minValue=null!=n?n:0,t.style.maxValue=null!=a?a:0}e.getCellStyle=(n,a,l)=>{var o;const i=StyleColumn.getStyle(t,e.tsDataType,n);let s={};return(null==i?void 0:i.cellColor)&&(s={...s,background:i.cellColor}),(null==i?void 0:i.textColor)&&(s={...s,color:i.textColor}),"Barchart"===(null===(o=t.style)||void 0===o?void 0:o.type)&&(s={...s,border:"1px solid var(--gray-200)"}),s},e.onRender=({row:n,renderedVal:l})=>{const o=StyleColumn.getStyle(t,e.tsDataType,n);return a.createElement(he,{style:o,renderedVal:l})}}return e})):console.warn("Bad w.columns format",e.columns));const b=t[f];if(b&&!(null===(h=e.options)||void 0===h?void 0:h.hideEditRow)){const t=(null!=v?v:[]).filter((t=>{var n;return!e.columns||(null===(n=e.columns)||void 0===n?void 0:n.some((e=>e.name===t.name&&!1!==e.show)))})),n=se(t,b,null==e||e.options.showSubLabel,d);g.unshift(n)}return g},he=({style:e,renderedVal:t,className:n=""})=>e&&e.chipColor?a.createElement("div",{className:n,style:{backgroundColor:e.chipColor,padding:"6px 8px",borderRadius:"1em",width:"fit-content",...e.textColor&&{color:e.textColor},...e.borderColor&&{border:`1px solid ${e.borderColor}`}}},t):t,ge=["=","<=","<",">",">=","!=","in","not in","contains","not null","null"],fe=[{color:"#E91E63",borderColor:void 0,textColor:"#ffffff"},{color:"#9C27B0",borderColor:void 0,textColor:"#ffffff"},{color:"#673AB7",borderColor:void 0,textColor:"#ffffff"},{color:"#2196F3",borderColor:void 0,textColor:"#ffffff"},{color:"#00BCD4",borderColor:void 0,textColor:"#ffffff"},{color:"rgb(57 185 121)",borderColor:void 0,textColor:"#ffffff"},{color:"rgb(189 171 0)",borderColor:void 0,textColor:"#ffffff"},{color:"rgb(156 156 156)",borderColor:void 0,textColor:"#ffffff"}],Ee=[{color:"#ffd0cd",borderColor:"rgb(216 71 71)",textColor:"#940000"},{color:"#f6beff",borderColor:"rgb(172 64 211)",textColor:"#490063"},{color:"#e5e9ff",borderColor:"rgb(108 130 231)",textColor:"#002fff"},{color:"#c9e7ff7d",borderColor:"rgb(120 189 243)",textColor:"#0075d2"},{color:"#00bcd42e",borderColor:"rgb(93 186 198)",textColor:"#009aad"},{color:"#01d4002e",borderColor:"#01d4002e",textColor:"#00ad44"},{color:"#d4b7002e",borderColor:"rgb(227 217 41)",textColor:"#716400"},{color:"#b4b4b42e",borderColor:"rgb(169 169 169)",textColor:"#4b4b4b"}],ve=Ee.map((e=>({...e,borderColor:void 0})));class StyleColumn extends RTComp{constructor(){super(...arguments),this.state={minValue:void 0,maxValue:void 0}}render(){const{column:e,onUpdate:t,tsDataType:n,tableName:l,db:o,tables:i}=this.props;let r=["None","Fixed","Conditional"];const{style:c={type:"None",textColor:"",chipColor:"",cellColor:""}}=e;e&&["number","Date"].includes(n)&&(r.push("Scale"),r.push("Barchart"));const d=c.type||"None",m=e=>{if((null==e?void 0:e.type)&&e.type!==c.type){let n={...e};"Barchart"===e.type&&(n={barColor:"rgba(0,246,96,1)",textColor:"black",...n}),t({style:n})}else t({style:{...c,...e}})},p=vo(c,"conditions")||[],u=(e,t)=>{let n=p.map((e=>({...e})));e?void 0===t?n.push({color:"red",operator:"=",condition:""}):n=p.map(((n,a)=>a===t?{...n,...e}:n)):n=n.filter(((e,n)=>n!==t)),m({conditions:n})};return a.createElement("div",{className:"StyleColumn flex-col p-p5 gap-1"},a.createElement(Select_Select,{label:"Style mode",value:d,variant:"div",options:r,onChange:e=>{m({type:e})}}),"Fixed"===c.type?a.createElement(a.Fragment,null,a.createElement(ColorPicker,{label:"Text",className:"m-p5",value:c.textColor||"black",onChange:e=>{m({textColor:e})}}),a.createElement(ColorPicker,{label:"Chip",className:"m-p5",value:c.chipColor,onChange:e=>{m({chipColor:e})}}),a.createElement(ColorPicker,{label:"Cell",className:"m-p5",value:c.cellColor||"white",onChange:e=>{m({cellColor:e})}})):"Conditional"===c.type?a.createElement("div",{className:"flex-col gap-1"},(p||[]).map(((t,n)=>{var r;return a.createElement("div",{key:n,className:"flex-col gap-1 p-p5 ai-start card  ",style:{padding:"1em",alignItems:"stretch"}},a.createElement("div",{className:"flex-row-wrap gap-1 ai-center"},a.createElement(Btn_Btn,{color:"action",variant:"faded"},e.name),a.createElement(Select_Select,{className:" ",value:t.operator,variant:"div",options:ge,onChange:e=>u({operator:e},n)}),"not null"!==t.operator&&"null"!==t.operator&&a.createElement(SmartSearch,{className:" ",key:t.condition||"",db:o,tableName:l,style:{padding:".5em"},variant:"search-no-shadow",tables:i,defaultValue:t.condition||"",column:e.name,onPressEnter:e=>{u({condition:e},n)},onChange:(e,{columnValue:t,term:a})=>{const l=null!=t?t:a;l&&u({condition:l},n)}}),a.createElement(Btn_Btn,{title:"Remove style",iconPath:s.r5M,onClick:e=>{u(null,n)}})),a.createElement(M,{button:a.createElement("div",{className:"flex-row ai-center gap-1 pointer noselect"},a.createElement("div",null,"Chip style"),a.createElement(he,{style:{chipColor:t.color,textColor:null!==(r=t.textColor)&&void 0!==r?r:c.textColor,borderColor:t.borderColor},renderedVal:"Result"})),render:()=>{var e,l,o;return a.createElement("div",{className:"flex-col"},a.createElement("div",{className:"flex-row jc-start ai-center  gap-1 o-auto f-1"},a.createElement(ColorPicker,{label:"Text:",value:null!==(e=t.textColor)&&void 0!==e?e:c.textColor,onChange:e=>{m({textColor:e}),u({textColor:e},n)}}),a.createElement(ColorPicker,{label:"Chip",value:t.color,onChange:e=>{u({color:e},n)}}),a.createElement(ColorPicker,{label:"Border:",className:"mr-auto",value:null!==(l=t.borderColor)&&void 0!==l?l:"transparent",onChange:e=>{u({borderColor:e},n)}}),a.createElement("div",{className:"flex-row ai-center gap-1"},a.createElement("div",null,"Chip style"),a.createElement(he,{style:{chipColor:t.color,textColor:null!==(o=t.textColor)&&void 0!==o?o:c.textColor,borderColor:t.borderColor},renderedVal:"Result"}))),a.createElement("div",{className:"flex-col flex-row gap-1 o-auto mt-1 pt-1 bt b-gray-300 noselect pointer"},[fe,Ee,ve].map(((e,l)=>a.createElement("div",{key:l,className:"flex-row gap-1 o-auto "},e.map((({color:e,textColor:l,borderColor:o})=>{var i,s;return a.createElement("div",{key:e,onClick:()=>{u({color:e,textColor:l,borderColor:o},n)}},a.createElement(he,{style:{chipColor:e,textColor:null!==(s=null!==(i=null!=l?l:t.textColor)&&void 0!==i?i:c.textColor)&&void 0!==s?s:"white",borderColor:null!=o?o:"transparent"},renderedVal:"Lorem"}))})))))))}}))})),a.createElement(Btn_Btn,{title:"Add condition style",className:"w-fit h-fit mt-1",color:"action",variant:"faded",iconPath:s.qX5,onClick:()=>{u({},void 0)}},"Add condition"),a.createElement("div",{className:"flex-row p-p5 ai-center"},a.createElement(ColorPicker,{label:"Default chip color:",className:"mr-p5",value:vo(c,"defaultStyle.color"),onChange:e=>{m({defaultStyle:{color:e}})}}))):"Scale"===c.type?a.createElement(a.Fragment,null,a.createElement(ColorPicker,{className:"mr-p5",label:"Min color",value:c.minColor,onChange:e=>{m({minColor:e})}}),a.createElement(ColorPicker,{className:"mr-p5",label:"Max color",value:c.maxColor,onChange:e=>{m({maxColor:e})}})):"Barchart"===c.type?a.createElement(a.Fragment,null,a.createElement("div",{className:"flex-col p-p5 ai-center"},a.createElement(ColorPicker,{label:"Bar",className:"m-p5",value:c.barColor,onChange:e=>{m({barColor:e})}}),a.createElement(ColorPicker,{label:"Text",className:"m-p5",value:c.textColor,onChange:e=>{m({textColor:e})}}))):null)}}StyleColumn.getStyle=(e,t,n,a)=>{var l,o;const{style:i,name:s}=e;let r={};if(i&&i.type){if("Fixed"===i.type)r={textColor:i.textColor,chipColor:i.chipColor,cellColor:i.cellColor};else if("Conditional"===i.type){let a=n[e.name];const s=(i.conditions||[]).find((({operator:e,condition:n})=>{let l="number"===t?+n:n;if("contains"===e)return a&&`${JSON.stringify(a)}`.includes(l+"");if("="===e)return a==l;if(">"===e)return a>l;if(">="===e)return a>=l;if("<="===e)return a<=l;if("<"===e)return a<l;if("!="===e)return a!=l;if(["in","not in"].includes(e)){const l=n.split(",").map((e=>"number"===t?+e.trim():e.trim())).includes(a);return"in"===e?l:!l}})),c=null===(l=null==i?void 0:i.defaultStyle)||void 0===l?void 0:l.color;!s&&c&&(r={textColor:i.textColor,chipColor:c}),s&&(r={textColor:null!==(o=s.textColor)&&void 0!==o?o:i.textColor,chipColor:s.color,borderColor:s.borderColor})}else if("Barchart"===i.type){const{minValue:a,maxValue:l,barColor:o="rgba(0,246,96,1)",textColor:s="black"}=i,c="Date"===t?+new Date(n[e.name]):+n[e.name];if(![c,a,l].find((e=>"number"!=typeof e||isNaN(e)))){const e=Math.round(100*(c-a)/(l-a));r={textColor:s,cellColor:`linear-gradient(90deg, ${o} 0%, ${o} ${e}%, rgba(0,0,0,0) ${e}%)`}}}else if("Scale"===i.type){const{minValue:a,maxValue:l,textColor:o="black",minColor:s="#63f717",maxColor:c="#46b5d5"}=i,d="Date"===t?+new Date(n[e.name]):+n[e.name];if(![d,a,l].find((e=>"number"!=typeof e||isNaN(e)))){r={textColor:o,cellColor:te(s,c,(d-a)/(l-a))}}}}else r={};return r};class ColorPicker extends a.Component{constructor(){super(...arguments),this.state={anchorEl:null},this.asRGB=e=>[parseInt(e.substr(1,2),16),parseInt(e.substr(3,2),16),parseInt(e.substr(5,2),16)],this.lastChanged=Date.now(),this.onChange=(e,t)=>{this.color=e;const{onChange:n}=this.props,a=Date.now();this.willChange||a-this.lastChanged<500?(clearTimeout(this.willChange),this.willChange=setTimeout((()=>{this.willChange=null,this.onChange(this.color)}),500)):(n(this.color,this.asRGB(this.color)),this.lastChanged=a)}}render(){const{anchorEl:e}=this.state,{value:t,style:n={},className:l="",onChange:o,label:i}=this.props;return a.createElement("div",{className:"flex-row gap-p5 ai-center "+l,style:n},i?a.createElement("div",{className:" noselect f-1"},i):null,a.createElement("div",{className:"round pointer shadow ",style:{width:"24px",height:"24px",backgroundColor:t},onClick:e=>{this.setState({anchorEl:e.currentTarget})}}),e?a.createElement(Popup,{open:!0,anchorEl:e,positioning:"beneath-left",onClose:()=>this.setState({anchorEl:null}),contentClassName:"p-1"},a.createElement("div",{className:"flex-row-wrap"},["#ffffff","#174CFA","#7430F0","#0AA1FA","#CB11F0","#F79800","#36E00B"].map(((e,t)=>a.createElement("div",{key:t,className:"round pointer mr-1 mb-1 shadow",style:{width:"24px",height:"24px",backgroundColor:e},onClick:t=>{o(e,this.asRGB(e)),this.setState({anchorEl:null})}})))),a.createElement(FormField,{className:"mt-1",label:"Other",type:"color",value:t,onChange:e=>this.onChange(e)}),a.createElement(Btn_Btn,{className:"mt-1",onClick:()=>{this.onChange("")}},"None")):null)}}var be=n(84901);const ye=e=>""===e.trim()||e.trim().endsWith(";"),Ne=(e,t)=>{var n,a,l,o,i,s,r,c;const{lineNumber:m}=t,p=e.getLinesContent().map(((e,t)=>({v:e,n:t+1})));let u=null!==(o=null!==(a=null===(n=p.slice(m-1).find((e=>e.n>m&&ye(e.v))))||void 0===n?void 0:n.n)&&void 0!==a?a:null===(l=p.at(-1))||void 0===l?void 0:l.n)&&void 0!==o?o:0,h=null!==(c=null!==(s=null===(i=p.slice(0,m-1).reverse().find((e=>e.n<m&&ye(e.v))))||void 0===i?void 0:i.n)&&void 0!==s?s:null===(r=p.at(0))||void 0===r?void 0:r.n)&&void 0!==c?c:0;const g=p.find((e=>e.n===h)),f=p.find((e=>e.n===u));g&&h>0&&(h>1||!g.v)&&h++,f&&!(null==f?void 0:f.v.trim())&&u--;const E=p.slice(h?h-1:0,u||0),v=e.getOffsetAt({column:0,lineNumber:h}),b=e.getOffsetAt(t),y=E.map((e=>e.v)).join("\n"),N=((e,t,n)=>{let a=[];const l=e.join("\n")+" ",o=d.j6.tokenize(l,Al);let i=t;return o.forEach(((t,l)=>{var o,s,r,c,d;l&&(i+=1+(null!==(s=null===(o=e[l-1])||void 0===o?void 0:o.length)&&void 0!==s?s:0));for(let o=0;o<t.length-1;o++){const s=e[l],m=t[o],p=t[o+1],u=null!==(r=null==p?void 0:p.offset)&&void 0!==r?r:null==s?void 0:s.length,h=null!==(c=null==m?void 0:m.offset)&&void 0!==c?c:0,g=null!==(d=null==s?void 0:s.slice(h,u))&&void 0!==d?d:"",f=h+i,E={offset:f,end:f+(null==g?void 0:g.length),text:g,lineNumber:l+n,textLC:g.toLowerCase(),type:null==m?void 0:m.type};if(a.push(E),o===t.length-2&&p&&"white.sql"!==(null==p?void 0:p.type)){const e=s.slice(p.offset),t=p.offset+i,n={offset:t,end:t+e.length,text:e,lineNumber:E.lineNumber,textLC:e.toLowerCase(),type:p.type};a.push(n)}}})),a=a.map(((e,t)=>{if(t){const n=a[t-1],l=a[t+1];if("identifier.sql"===e.type&&'"'===(null==n?void 0:n.text)&&"identifier.quote.sql"===(null==n?void 0:n.type)&&'"'===(null==l?void 0:l.text)&&"identifier.quote.sql"===(null==l?void 0:l.type))return{...e,offset:e.offset-1,end:e.end+1,text:`"${e.text}"`,textLC:`"${e.textLC}"`}}return e})),a})(E.map((e=>e.v)),v,h).filter((e=>"white.sql"!==e.type&&"identifier.quote.sql"!==e.type)),w=N.map((e=>e.textLC)).join(" ").toLowerCase().trim(),S=N.filter((e=>e.end<b)).sort(((e,t)=>e.offset-t.offset)),T=N.filter((e=>e.offset>b)).sort(((e,t)=>e.offset-t.offset)),C=N.find((e=>e.offset<b&&e.end>=b)),_=N.filter((e=>e.lineNumber===t.lineNumber)).sort(((e,t)=>e.offset-t.offset)),x=_.filter((e=>e.end<b)),A=S.map((e=>e.textLC)).join(" ").toLowerCase().trim(),R=T.map((e=>e.textLC)).join(" ").toLowerCase().trim(),L=_.map((e=>e.textLC)).join(" ").toLowerCase().trim(),O=S.at(0),I=S.at(-1),D=S.at(-2),k=S.at(-3),M=S.at(-4),F=S.at(-5),P=e.getValueInRange({startColumn:0,startLineNumber:h,endLineNumber:t.lineNumber,endColumn:t.column}),H=S.filter((e=>"identifier.sql"===e.type)).map((e=>e.text)),B=N.filter((e=>"identifier.sql"===e.type)).map((e=>e.text));return{prevText:P,endLine:u,startLine:h,text:y,textLC:w,prevLC:A,nextLC:R,thisLineLC:L,thisLinePrevTokens:x,lines:E,tokens:N,prevTokens:S,nextTokens:T,currToken:C,ftoken:O,l4token:F,l3token:M,l2token:k,l1token:D,ltoken:I,prevIdentifiers:H,identifiers:B,getPrevTokensNoParantheses:(e=!1)=>{const t=structuredClone(S);let n=[],a=!1;return t.slice(0).reverse().forEach((t=>{const l={...t,type:"white.sql",text:" ",textLC:" "};if(e&&"()"===t.text)return void n.push(l);const o=Array.from(new Set(t.text.split(""))).join(""),i=()=>{t.text.split("").map(((a,o)=>{n.push({...e?l:t,text:a,offset:t.offset-o,end:t.end-o})}))};return"("===o&&a?(a=!1,void i()):")"===o?(a=!0,void i()):void n.push(a?l:t)})),n.slice(0).reverse()}}},we=["JOIN","SELECT","ON","CREATE","TABLE","SET","UPDATE","INTO","FROM","WHERE",";","\n","ALTER","COPY","REFRESH","REINDEX","GRANT","REVOKE"],Se=(e,t)=>{const{range:n,cb:a}=null!=t?t:{};return{suggestions:e.map((({label:e,insertText:t,docs:l,sortText:o,kind:i,commitCharacters:s})=>({label:e,name:e,range:null!=n?n:void 0,insertText:((null==a?void 0:a.prevLC)&&!a.prevText.endsWith(" ")?" ":"")+(null!=t?t:e+" "),documentation:"string"==typeof l?{value:l}:l,kind:null!=i?i:27,insertTextRules:4,...o&&{sortText:o},commitCharacters:s,type:"snippet"})))}},Te=["ABORT","ALTER","ANALYZE","BEGIN","CALL","CHECKPOINT","CLOSE","CLUSTER","COMMENT","COMMIT","COPY","CREATE","DEALLOCATE","DECLARE","DELETE FROM","DISCARD","DO","DROP","END","EXECUTE","EXPLAIN","FETCH","GRANT","IMPORT FOREIGN SCHEMA","INSERT INTO","LISTEN","LOAD","LOCK","MERGE INTO","MOVE","NOTIFY","PREPARE","REASSIGN","REFRESH MATERIALIZED VIEW","REINDEX","RELEASE","RESET","REVOKE","ROLLBACK","SAVEPOINT","SECURITY LABEL","SELECT","SET","SHOW","START","TABLE","TRUNCATE","UNLISTEN","UPDATE","VACUUM","VALUES","WITH"],Ce=["ACCESS METHOD","AGGREGATE","CAST","COLLATION","CONFIGURATION","CONVERSION","DATABASE","DEFAULT PRIVILEGES","DICTIONARY","DOMAIN","EVENT TRIGGER","EXTENSION","FOREIGN DATA WRAPPER","FOREIGN TABLE","FUNCTION","GROUP","INDEX","LANGUAGE","LARGE OBJECT","MATERIALIZED VIEW","OPERATOR","OR REPLACE","OWNED","PARSER","POLICY","PROCEDURE","PUBLICATION","ROLE","ROUTINE","RULE","SCHEMA","SEQUENCE","SERVER","STATISTICS","SUBSCRIPTION","SYSTEM","TABLE","TABLESPACE","TEMP","TEMPLATE","TEMPORARY","TEXT SEARCH","TRANSFORM","TRIGGER","TYPE","UNIQUE","UNLOGGED","USER","USER MAPPING FOR","VIEW"],_e=["FUNCTION","PROCEDURE","LANGUAGE","RULE","VIEW","AGGREGATE","TRANSFORM","TRIGGER"],xe=(e,t)=>e.flatMap((e=>({label:e+" ...",insertText:e+" "+t}))),Ae={TABLE:"${1:table_name} (\n  id SERIAL PRIMARY KEY,\n  $0\n);",VIEW:"${1:view_name} AS\n  SELECT ",FUNCTION:"${1:new_func_name} (${2:input_arguments})\n RETURNS VOID AS $$\nBEGIN\n\n $3\n\nEND;\n$$ LANGUAGE plpgsql;",TRIGGER:["${1:trigger_name}","${2|AFTER,BEFORE,INSTEAD OF|} ${3|INSERT,UPDATE,DELETE|}","ON ${4:table_name}","FOR EACH ${5|ROW,STATEMENT|}","EXECUTE PROCEDURE ${6:trigger_func_name}();"].join("\n"),INDEX:["${1|CONCURRENTLY, |} ${2|IF NOT EXISTS, |} ${3:index_name} ","ON ${4:table_name} ","USING ${5|btree,hash,gist,spgist,gin,brin|} (${6:column_names})","${7|WHERE condition, |}"].join("\n")},Re=[...xe(["TABLE","TABLE IF NOT EXISTS"],Ae.TABLE),...xe(["VIEW","MATERIALIZED VIEW"],Ae.VIEW),..._e.flatMap((e=>`OR REPLACE ${e}`)).map((e=>({label:e,insertText:e+" "}))),...xe(["FUNCTION"],Ae.FUNCTION),...xe(["TRIGGER"],Ae.TRIGGER),...xe(["INDEX","UNIQUE INDEX"],Ae.INDEX),...xe(["EXTENSION","EXTENSION IF NOT EXISTS"],""),{label:"PUBLICATION ...",insertText:"PUBLICATION ${1:publication_name} \nFOR TABLE ${2:table_name} \nWHERE (${3:condition});",docs:"Adds a new publication into the current database. The publication name must be distinct from the name of any existing publication in the current database. A publication is essentially a group of tables whose data changes are intended to be replicated through logical replication."},{label:"SUBSCRIPTION ...",insertText:"CREATE SUBSCRIPTION ${1:sub_name}\nCONNECTION 'host=localhost dbname=test_pub application_name=sub1' \nPUBLICATION ${2:pub_name};",docs:"Adds a new logical-replication subscription. The subscription name must be distinct from the name of any existing subscription in the current database. A subscription represents a replication connection to the publisher. Hence, in addition to adding definitions in the local catalogs, this command normally creates a replication slot on the publisher. A logical replication worker will be started to replicate data for the new subscription at the commit of the transaction where this command is run, unless the subscription is initially disabled."},{label:"POLICY ...",insertText:"POLICY ${1:policy_name}\nON $2\nFOR $3\nTO $4\nUSING($5 = CURRENT_USER)",docs:"Define how a user interacts with rows within a given table\n\nNote that row-level security must be enabled on the table (using ALTER TABLE ... ENABLE ROW LEVEL SECURITY) in order for created policies to be applied."},...Ce.filter((e=>!["PUBLICATION","POLICY","EXTENSION","MATERIALIZED VIEW","UNIQUE",...(0,m.getKeys)(Ae)].includes(e))).map((e=>({label:e,insertText:e+" "})))],Le=[...["users","products","sessions","orders","bookings","locations","customers","refunds","payments","transactions","logs","files","chats","messages","notifications","events"].flatMap((e=>["INTEGER","BIGINT","UUID"].map((t=>({label:`${e.slice(0,-1)}_id  ${t}  REFERENCES ${e}`,docs:""}))))),{label:"username TEXT NOT NULL",docs:""},{label:"username  VARCHAR(50) UNIQUE NOT NULL",docs:""},{label:"first_name  VARCHAR(150) NOT NULL",docs:""},{label:"last_name  VARCHAR(150) NOT NULL",docs:""},{label:"age  INTEGER CHECK(age > 0)",docs:""},{label:"birthdate DATE NOT NULL CHECK(birthdate < now())",docs:""},{label:"dob  DATE NOT NULL CHECK(dob < now())",docs:""},{label:"date_of_birth  DATE NOT NULL CHECK(date_of_birth < now())",docs:""},{label:"password  VARCHAR(50) NOT NULL",docs:""},{label:"address_line1  VARCHAR(250)",docs:""},{label:"address_line2  VARCHAR(250)",docs:""},{label:"postcode  VARCHAR(20) NOT NULL",docs:""},{label:"status  VARCHAR(50)",docs:""},{label:"phone  VARCHAR(50) NOT NULL",docs:""},{label:"country  VARCHAR(50) NOT NULL",docs:""},{label:"city  VARCHAR(150) NOT NULL",docs:""},{label:"organization  VARCHAR(150) NOT NULL",docs:""},{label:"zip_code  VARCHAR(20) NOT NULL",docs:""},{label:"email  VARCHAR(255) UNIQUE NOT NULL",docs:""},{label:"created_on  TIMESTAMP NOT NULL DEFAULT now()",docs:""},{label:"last_login TIMESTAMP",docs:""},{label:"order_timestamo TIMESTAMP",docs:""},{label:"quantity INTEGER CHECK(quantity > 1)",docs:""},{label:"notes  VARCHAR(200)",docs:""},{label:"id  PRIMARY KEY",docs:""},{label:"id  PRIMARY KEY DEFAULT gen_random_uuid()",docs:""},{label:"id  PRIMARY KEY DEFAULT uuid_generate_v1()",docs:""},{label:"id  INTEGER PRIMARY KEY GENERATED ALWAYS AS IDENTITY",docs:""},{label:"name  VARCHAR(150)",docs:""},{label:"type  VARCHAR(150) NOT NULL",docs:""},{label:"url  TEXT",docs:""},{label:"description  VARCHAR(250)",docs:""},{label:"title  VARCHAR(250)",docs:""},{label:"label  VARCHAR(250)",docs:""},{label:"message  VARCHAR(450) NOT NULL",docs:""},{label:"price  DECIMAL(12,2) CHECK(price > 0)",docs:""},{label:"location GEOMETRY",docs:""},{label:"geom GEOMETRY",docs:""},{label:"location GEOMETRY(point, 4326)",docs:""},{label:"latlong  GEOMETRY(point, 4326)",docs:""},{label:"route  GEOMETRY(linestring, 4326)",docs:""},{label:"path GEOMETRY(linestring, 4326)",docs:""},{label:"line GEOMETRY(linestring, 4326)",docs:""},{label:"track  GEOMETRY(linestring, 4326)",docs:""},{label:"geom GEOMETRY(linestring, 4326)",docs:""},{label:"geom GEOMETRY(polygon, 4326)",docs:""},{label:"preferences JSONB default '{}'",docs:""},{label:"description  VARCHAR(450)",docs:""}].map((e=>({...e}))),Oe=[{label:"ALL",docs:"Using ALL for a policy means that it will apply to all commands, regardless of the type of command. If an ALL policy exists and more specific policies exist, then both the ALL policy and the more specific policy (or policies) will be applied. Additionally, ALL policies will be applied to both the selection side of a query and the modification side, using the USING expression for both cases if only a USING expression has been defined.  As an example, if an UPDATE is issued, then the ALL policy will be applicable both to what the UPDATE will be able to select as rows to be updated (applying the USING expression), and to the resulting updated rows, to check if they are permitted to be added to the table (applying the WITH CHECK expression, if defined, and the USING expression otherwise). If an INSERT or UPDATE command attempts to add rows to the table that do not pass the ALL policy's WITH CHECK expression, the entire command will be aborted."},{label:"SELECT",docs:"Using SELECT for a policy means that it will apply to SELECT queries and whenever SELECT permissions are required on the relation the policy is defined for. The result is that only those records from the relation that pass the SELECT policy will be returned during a SELECT query, and that queries that require SELECT permissions, such as UPDATE, will also only see those records that are allowed by the SELECT policy. A SELECT policy cannot have a WITH CHECK expression, as it only applies in cases where records are being retrieved from the relation."},{label:"INSERT",docs:"Using INSERT for a policy means that it will apply to INSERT commands and MERGE commands that contain INSERT actions. Rows being inserted that do not pass this policy will result in a policy violation error, and the entire INSERT command will be aborted. An INSERT policy cannot have a USING expression, as it only applies in cases where records are being added to the relation. Note that INSERT with ON CONFLICT DO UPDATE checks INSERT policies' WITH CHECK expressions only for rows appended to the relation by the INSERT path."},{label:"UPDATE",docs:"Using UPDATE for a policy means that it will apply to UPDATE, SELECT FOR UPDATE and SELECT FOR SHARE commands, as well as auxiliary ON CONFLICT DO UPDATE clauses of INSERT commands. MERGE commands containing UPDATE actions are affected as well. Since UPDATE involves pulling an existing record and replacing it with a new modified record, UPDATE policies accept both a USING expression and a WITH CHECK expression. The USING expression determines which records the UPDATE command will see to operate against, while the WITH CHECK expression defines which modified rows are allowed to be stored back into the relation. Any rows whose updated values do not pass the WITH CHECK expression will cause an error, and the entire command will be aborted. If only a USING clause is specified, then that clause will be used for both USING and WITH CHECK cases. Typically an UPDATE command also needs to read data from columns in the relation being updated (e.g., in a WHERE clause or a RETURNING clause, or in an expression on the right hand side of the SET clause). In this case, SELECT rights are also required on the relation being updated, and the appropriate SELECT or ALL policies will be applied in addition to the UPDATE policies. Thus the user must have access to the row(s) being updated through a SELECT or ALL policy in addition to being granted permission to update the row(s) via an UPDATE or ALL policy. When an INSERT command has an auxiliary ON CONFLICT DO UPDATE clause, if the UPDATE path is taken, the row to be updated is first checked against the USING expressions of any UPDATE policies, and then the new updated row is checked against the WITH CHECK expressions. Note, however, that unlike a standalone UPDATE command, if the existing row does not pass the USING expressions, an error will be thrown (the UPDATE path will never be silently avoided)."},{label:"DELETE",docs:"Using DELETE for a policy means that it will apply to DELETE commands. Only rows that pass this policy will be seen by a DELETE command. There can be rows that are visible through a SELECT that are not available for deletion, if they do not pass the USING expression for the DELETE policy. In most cases a DELETE command also needs to read data from columns in the relation that it is deleting from (e.g., in a WHERE clause or a RETURNING clause). In this case, SELECT rights are also required on the relation, and the appropriate SELECT or ALL policies will be applied in addition to the DELETE policies. Thus the user must have access to the row(s) being deleted through a SELECT or ALL policy in addition to being granted permission to delete the row(s) via a DELETE or ALL policy. A DELETE policy cannot have a WITH CHECK expression, as it only applies in cases where records are being deleted from the relation, so that there is no new row to check."}],Ie=[{label:"ON DELETE",documentation:"When the data in the referenced columns is deleted: "},{label:"ON UPDATE",documentation:"When the data in the referenced columns is updated: "}],De=[{label:"CASCADE",getInfo:e=>{const t="DELETE any rows referencing the deleted row",n="UPDATE the values of the referencing column(s) to the new values of the referenced columns";return e?"DELETE"===e?t:n:[t,n].join(" OR ")}},{label:"SET NULL",getInfo:e=>"Set the referencing column(s) to null"},{label:"RESTRICT",getInfo:e=>"Produce an error indicating that the deletion or update would create a foreign key constraint violation. This is the same as NO ACTION except that the check is not deferrable."},{label:"SET DEFAULT",getInfo:e=>"Set the referencing column(s) to their default values. (There must be a row in the referenced table matching the default values, if they are not null, or the operation will fail.)"}];const ke=e=>"```sql\n"+e+"\n```",Me=e=>Object.entries(e).map((([e,t])=>({label:e,value:t}))).filter((({value:e})=>void 0!==e)).map((({label:e,value:t})=>`${e}: ${`**${t}**`.replace("****","")}  `)).join("\n");async function Fe(e){let t=[];try{const n=await e.sql("\n      SELECT conname,\n      conkey ,confkey ,\n      pg_get_constraintdef(c.oid) as definition, contype, \n      relname as table_name ,\n      format('%I', conname) as escaped_identifier,\n      format('%I', relname) as escaped_table_name,\n      nspname as schema,\n      c.conrelid as table_oid\n      FROM pg_catalog.pg_constraint c\n      INNER JOIN pg_catalog.pg_class rel\n      ON rel.oid = c.conrelid\n      INNER JOIN pg_catalog.pg_namespace nsp\n      ON nsp.oid = connamespace\n    ",{},{returnType:"rows"});t=t.concat(n.map((e=>({label:{label:e.conname,description:e.table_name},name:e.conname,type:"constraint",detail:"(constraint)",schema:e.schema,parentName:e.table_name,escapedIdentifier:e.escaped_identifier,insertText:e.escaped_identifier,constraintInfo:e,documentation:`Table: **${e.table_name}**  \nDefinition:\n ${ke(`ALTER TABLE ${e.table_name} ADD CONSTRAINT \n`+e.definition)}`}))));const a=await e.sql("select *, format('%I', indexname) as escaped_identifier from pg_indexes",{},{returnType:"rows"}),l=e=>{var t,n,a;return null===(a=null===(n=null===(t=e.split("USING")[1])||void 0===t?void 0:t.split("(")[1])||void 0===n?void 0:n.split(")"))||void 0===a?void 0:a[0]};t=t.concat(a.map((e=>({detail:"(index)",label:{label:e.indexname,description:l(e.indexdef)},name:e.indexname,type:"index",insertText:e.escaped_identifier,indexInfo:e,documentation:`**Definition**: \n${ke(e.indexdef).split(" ON ").join(" \nON ").split(" USING ").join(" \nUSING ").split(" WHERE ").join(" \nWHERE ")}`}))));const o=await async function(e){let t="";t="ELSE ARRAY( \n    SELECT pg_roles.rolname\n    FROM pg_roles\n    WHERE pg_roles.oid = ANY (pol.polroles)\n    ORDER BY pg_roles.rolname\n  )::text[]";return(await e.sql(`SELECT \n      CASE WHEN current_schema() = nspname THEN format('%I', polname) ELSE format('%I.%I', nspname, polname) END as escaped_identifier,\n      n.nspname AS schemaname,\n      c.relname AS tablename,\n      pol.polname AS policyname,\n      CASE\n          WHEN pol.polpermissive THEN 'PERMISSIVE'::text\n          ELSE 'RESTRICTIVE'::text\n      END AS type,\n      CASE\n            WHEN pol.polroles = '{0}'::oid[] THEN string_to_array('public'::text, ''::text)::text[]\n            ${t}\n        END AS roles,\n      CASE pol.polcmd\n          WHEN 'r'::"char" THEN 'SELECT'::text\n          WHEN 'a'::"char" THEN 'INSERT'::text\n          WHEN 'w'::"char" THEN 'UPDATE'::text\n          WHEN 'd'::"char" THEN 'DELETE'::text\n          WHEN '*'::"char" THEN 'ALL'::text\n          ELSE NULL::text\n      END AS cmd,\n  pg_get_expr(pol.polqual, pol.polrelid) AS "using",\n  pg_get_expr(pol.polwithcheck, pol.polrelid) AS with_check\n FROM pg_policy pol\n   JOIN pg_class c ON c.oid = pol.polrelid\n   LEFT JOIN pg_namespace n ON n.oid = c.relnamespace;`,{},{returnType:"rows"})).map((e=>({...e,definition:`CREATE POLICY ${e.escaped_identifier}\nON ${e.tablename}\nFOR ${e.cmd}\nTO ${e.roles}\n${[e.using?`USING ${e.using}`:"",e.with_check?`WITH CHECK ${e.with_check}`:""].filter((e=>e)).join("\n")}`})))}(e);t=t.concat(o.map((e=>({detail:"(policy)",label:e.policyname,name:e.policyname,type:"policy",insertText:e.escaped_identifier,policyInfo:e,documentation:`**Definition**: \n${ke(e.definition)}\n      `}))));let i=await async function(e){const t="(SELECT schema_name FROM information_schema.schemata)";return(await e.sql(`\n    SELECT\n    c.oid,\n    relkind,\n    nspname as schema, \n    relname as name,\n    format('%I', relname) as escaped_name,\n    relkind IN ('v', 'm') AS is_view,\n    CASE WHEN relkind IN ('v', 'm') THEN pg_get_viewdef(format('%I.%I', nspname, relname), true) END AS view_definition ,\n    obj_description((nspname || '.' || quote_ident(relname))::REGCLASS) as comment,\n    CASE WHEN current_schema() = nspname THEN format('%I', relname) ELSE format('%I.%I', nspname, relname) END as escaped_identifier,\n    json_agg((\n      SELECT x FROM (\n        SELECT column_name as name,\n        format('%I', COALESCE(column_name, '')) as escaped_identifier,\n        data_type, \n        udt_name, \n        is_nullable <> 'NO' as nullable,\n        column_default IS NOT NULL as has_default,\n        column_default,\n        ordinal_position,\n        numeric_precision ,\n        numeric_scale ,\n        character_maximum_length,\n        col_description((nspname || '.' || quote_ident(relname))::REGCLASS, ordinal_position) as comment\n      ) as x\n    ) ORDER BY ordinal_position ) AS cols\n    -- cols\n    FROM pg_catalog.pg_class AS c\n    JOIN pg_catalog.pg_namespace AS ns\n      ON c.relnamespace = ns.oid\n    LEFT JOIN information_schema.columns cols /* FOR SOME REASON MAT VIEW COLS ARE NOT HERE (relkind=m)*/\n    ON (cols.table_schema, cols.table_name) IN ((nspname, relname))\n    WHERE relkind IN ('r', 'v', 'm' ) AND nspname IN ${t}\n    GROUP BY c.oid, relkind, nspname, relname;\n    `,{},{returnType:"rows"})).map((e=>(e.cols=e.cols.filter((e=>e.udt_name)),e)))}(e);i.map((e=>{const l="r"===e.relkind?"table":"v"===e.relkind?"view":"mview",i=n.filter((t=>t.table_oid===e.oid)),s=a.filter((t=>t.tablename===e.name&&t.schemaname===e.schema)),r=e.cols.map((e=>{const t=i.find((t=>{var n;return["p","f","c"].includes(t.contype)&&(null===(n=t.conkey)||void 0===n?void 0:n.includes(e.ordinal_position))})),n=["USER-DEFINED"].includes(e.data_type.toUpperCase())?e.udt_name.toUpperCase():e.data_type.toUpperCase();return{...e,cConstraint:t,definition:[e.escaped_identifier,n+("numeric"===e.udt_name.toLowerCase()&&null!==e.numeric_precision?`(${[e.numeric_precision,e.numeric_scale].join(", ")})`:null!==e.character_maximum_length?`(${e.character_maximum_length})`:""),e.nullable?"":"NOT NULL",null!==e.column_default?`DEFAULT ${e.column_default}`:"",t?`, \n ${t.definition}`:""].filter((e=>e.trim())).join(" ")}})),c=o.filter((t=>t.tablename===e.name&&t.schemaname===e.schema)),d=e.is_view?`**Definition:**  \n\n${ke(e.view_definition||"")}`:`${e.comment?`Comment: ${e.comment}`:""}\n\n**Columns**  \n${ke(r.map((e=>e.definition)).join(",  \n"))} \n\n**Constraints:** \n ${ke(i.map((e=>e.definition)).join("\n"))} \n**Indexes:** \n ${ke(s.map((e=>e.indexdef)).join("\n"))}  \n**Policies:** \n ${ke(c.map((e=>e.definition)).join("\n"))}`;t.push({type:l,label:{label:e.name,description:e.schema},name:e.name,subLabel:`(${e.cols.map((e=>`${e.escaped_identifier} ${e.udt_name.toUpperCase()}`)).join(", ")})`,escapedIdentifier:e.escaped_identifier,escapedName:e.escaped_name,schema:e.schema,insertText:e.escaped_identifier,detail:"m"===e.relkind?"(materialized view)":e.is_view?"(view)":"(table)",view:e.is_view?{definition:e.view_definition}:void 0,relkind:e.relkind,documentation:d,cols:r}),t=t.concat(r.map((t=>({label:{label:t.name,detail:"  "+t.data_type.toUpperCase(),description:e.name},name:t.name,detail:"(column) ",escapedParentName:e.escaped_identifier,schema:e.schema,parentName:e.name,parentOID:e.oid,escapedIdentifier:t.escaped_identifier,insertText:t.escaped_identifier,documentation:`${Me({Table:e.escaped_identifier,Schema:e.schema,Comment:t.comment})}  \n`+ke(t.definition),filterText:`${t.name} ${t.udt_name}`,type:"column",colInfo:t}))))}));const s=await async function(e){return await e.sql('\n\n  /* psql l+ --list databases */\n  SELECT d.datname as "Name",\n        format(\'%I\', datname) as escaped_identifier ,\n         pg_catalog.pg_get_userbyid(d.datdba) as "Owner",\n         pg_catalog.pg_encoding_to_char(d.encoding) as "Encoding",\n         d.datcollate as "Collate",\n         d.datctype as "Ctype",\n         pg_catalog.array_to_string(d.datacl, E\'\n\') AS "Access privileges",\n         CASE WHEN pg_catalog.has_database_privilege(d.datname, \'CONNECT\')\n              THEN pg_catalog.pg_size_pretty(pg_catalog.pg_database_size(d.datname))\n              ELSE \'No Access\'\n         END as "Size",\n         t.spcname as "Tablespace",\n         pg_catalog.shobj_description(d.oid, \'pg_database\') as "Description"\n  FROM pg_catalog.pg_database d\n    JOIN pg_catalog.pg_tablespace t on d.dattablespace = t.oid\n  ORDER BY 1;\n\n',{},{returnType:"rows"})}(e);t=t.concat(s.map((e=>({label:e.Name,name:e.Name,escapedIdentifier:e.escaped_identifier,insertText:e.escaped_identifier,detail:"(database) ",documentation:Me(e),type:"database"}))));const r=await async function(e){return await e.sql("\n  SELECT format('%I', rolname ) as escaped_identifier,\n  rolname as usename,  \n  rolsuper  as usesuper, rolcreatedb as usecreatedb, rolbypassrls as usebypassrls, \n  rolreplication  as userepl, rolconfig, rolcanlogin,\n  lpad(ROW_NUMBER () OVER (ORDER BY sort_text)::text, 2, '0') as priority,\n  rolname = CURRENT_USER AS is_current_user\n  FROM (\n    SELECT *, replace(format('%I', rolname ), 'pg_', 'Ω') as sort_text\n    FROM pg_catalog.pg_roles \n  ) t\n  ORDER BY sort_text\n  ",{},{returnType:"rows"})}(e);t=t.concat(r.map((e=>({label:{label:e.usename,description:[e.is_current_user?"CURRENT_USER":"",e.usesuper?"usesuper":""].join(" ")},name:e.usename,userInfo:e,escapedIdentifier:e.escaped_identifier,insertText:e.escaped_identifier,detail:"(role)",documentation:Me(No(e,["escaped_identifier","usename","is_current_user","priority"])),type:"role"}))));const c=await Be({db:e,minArgs:0,limit:4e3,distinct:!0});t=t.concat(c.map((e=>({type:"function",name:e.name,label:{label:`${e.name}(${e.args.map((e=>e.data_type)).join(",")})`,description:e.extension},subLabel:e.func_signature,schema:e.schema,args:e.args,funcInfo:e,escapedIdentifier:e.escaped_identifier,insertText:e.escaped_identifier+(e.arg_list_str?"":"()"),detail:`(${e.is_aggregate?"agg ":""}function) \n${e.name}(${e.arg_list_str}) => ${e.restype}`,documentation:`Schema: \`${e.schema}\`  \n\n${(e.description||"").trim()}`,definition:e.definition,funcCallDefinition:`${e.name}(${e.arg_list_str}) => ${e.restype}`,filterText:`${e.name} ${e.args.map((e=>e.data_type)).join(", ")}`}))));const d=await async function(e){const t="\n  SELECT n.nspname as schema,\n    pg_catalog.format_type(t.oid, NULL) AS name,\n    t.typname,\n    pg_catalog.obj_description(t.oid, 'pg_type') as desc\n  FROM pg_catalog.pg_type t\n    LEFT JOIN pg_catalog.pg_namespace n ON n.oid = t.typnamespace\n  WHERE (t.typrelid = 0 OR (SELECT c.relkind = 'c' FROM pg_catalog.pg_class c WHERE c.oid = t.typrelid))\n    AND NOT EXISTS(SELECT 1 FROM pg_catalog.pg_type el WHERE el.oid = t.typelem AND el.typarray = t.oid)\n    AND pg_catalog.pg_type_is_visible(t.oid)\n  ORDER BY 1, 2;\n/*\n  SELECT *\nFROM pg_catalog.pg_type \nWHERE typcategory <> 'C'\nAND typnamespace IN (SELECT oid FROM pg_catalog.pg_namespace WHERE nspname = 'pg_catalog')\n*/\n\n  ";return(await e.sql(t,{},{returnType:"rows"})).map((e=>{const t=Pe.indexOf(e.name.toLowerCase());return{...e,name:e.name.startsWith('"')?e.name:e.name.toUpperCase(),priority:t>-1?(t+"").padStart(2,"0"):"z"}}))}(e);t=t.concat(d.map((e=>({label:{label:e.name,description:e.desc},name:e.name,detail:"(data type)",documentation:e.desc+`  \n\nSchema:  \`${e.schema}\`  \n Type: \`${e.typname}\`  \n\n https://www.postgresql.org/docs/current/datatype.html`,schema:e.schema,dataTypeInfo:e,insertText:e.name,type:"dataType"}))));const p=await async function(e){return(await e.sql("select upper(word) as word from pg_get_keywords();",{},{returnType:"rows"})).map((e=>e.word)).concat(["RAISE","NOTICE","IF NOT EXISTS","INSERT INTO","DELETE FROM"]).map((e=>{var t;const n=Ue.find((t=>t.label===e));let a=null!==(t=je[e])&&void 0!==t?t:e;const l=["BEGIN","COMMIT"].includes(e)?e+";\n":e;return(null==n?void 0:n.info)&&(a=n.info),{label:e,topKwd:n,documentation:a,insertText:l}}))}(e);t=t.concat(p.map((e=>({detail:"(keyword)",type:"keyword",...e,name:e.label}))));const u=await async function(e){return await e.sql("SELECT *, format('%I', COALESCE(name, '')) as escaped_identifier, installed_version IS NOT NULL as installed  FROM pg_available_extensions;",{},{returnType:"rows"})}(e);t=t.concat(u.map((e=>({label:{label:e.name,description:e.installed?"Installed":""},name:e.name,detail:`(extension) \nv${e.default_version}  ${e.installed?"Installed":"Not installed"} `,documentation:e.comment,type:"extension",insertText:e.escaped_identifier,extensionInfo:{installed:e.installed}}))));const h=(await async function(e){return await e.sql("\n    SELECT schema_name as name \n    FROM information_schema.schemata\n  ",{},{returnType:"rows"})}(e)).map((({name:e})=>({label:e,name:e,detail:"(schema)",type:"schema"})));t=t.concat(h);const g=await He(e);t=t.concat(g.map((e=>({type:"operator",detail:"(operator)",name:e.name,label:{label:e.name,detail:`   ${e.description||""}`,description:e.left_arg_type||""},operatorInfo:e,documentation:e.description,filterText:`${e.name} ${e.left_arg_type} ${e.description}`}))));const f=e=>(0,m.getKeys)(e).filter((e=>"escaped_identifier"!==e)).map((t=>`  ${t}: **${e[t]}**   `)).join("\n"),E=await function(e){return e.sql("\n  SELECT p.*, t.tables,\n  format('%I', p.pubname) as escaped_identifier \nFROM pg_catalog.pg_publication p\nLEFT JOIN (\n  SELECT pubname, string_agg(tablename::TEXT, ', ') as tables\n  FROM pg_catalog.pg_publication_tables \n  GROUP BY pubname\n) t\nON p.pubname = t.pubname \n",{},{returnType:"rows"})}(e);t=t.concat(E.map((e=>({detail:"(publication)",label:e.pubname,name:e.pubname,type:"publication",insertText:e.escaped_identifier,documentation:f(e)}))));const v=await async function(e){try{return await e.sql("SELECT *, format('%I', subname) as escaped_identifier FROM pg_catalog.pg_subscription ",{},{returnType:"rows"})}catch(e){console.error("Could not getSubscriptions: ",e)}return[]}(e);t=t.concat(v.map((e=>({detail:"(subscription)",label:e.subname,name:e.subname,type:"subscription",insertText:e.escaped_identifier,documentation:f(e)}))));const b=await function(e){return e.sql("\n    --SHOW ALL;\n\n    SELECT name, setting, unit, short_desc as description, min_val, max_val, reset_val\n    ,format('%I', name) as escaped_identifier\n    FROM pg_catalog.pg_settings \n    order by name \n\n  ",{},{returnType:"rows"})}(e),y=b.map((e=>({label:{label:e.name,description:e.setting},name:e.name,detail:"(setting)",type:"setting",insertText:e.name,documentation:`**${e.description}**  \n\n${Me(wo(e,["setting","min_val","max_val","reset_val"]))} `})));return{suggestions:t,settingSuggestions:y}}catch(e){return console.error("Failed getting sql suggestions: ",e),{settingSuggestions:[],suggestions:[]}}}const Pe=["numeric","integer","real","bigint","serial","boolean","geography","geometry","uuid","text","varchar","json","jsonb","text","tsvector","timestamp","timestamptz"];const He=async e=>{let t=await e.sql("\n    SELECT *\n    FROM (\n      SELECT n.nspname as schema,\n        o.oprname AS name,\n        CASE WHEN o.oprkind='l' THEN NULL ELSE pg_catalog.format_type(o.oprleft, NULL) END AS \"left_arg_type\",\n        CASE WHEN o.oprkind='r' THEN NULL ELSE pg_catalog.format_type(o.oprright, NULL) END AS \"right_arg_type\",\n        pg_catalog.format_type(o.oprresult, NULL) AS \"result_type\",\n        coalesce(pg_catalog.obj_description(o.oid, 'pg_operator'),\n                pg_catalog.obj_description(o.oprcode, 'pg_proc')) AS \"description\"\n      FROM pg_catalog.pg_operator o\n          LEFT JOIN pg_catalog.pg_namespace n ON n.oid = o.oprnamespace\n      WHERE TRUE --n.nspname = 'pg_catalog'\n            AND n.nspname <> 'information_schema'\n        AND pg_catalog.pg_operator_is_visible(o.oid)\n      ORDER BY 1, 2, 3, 4\n    ) t\n    WHERE result_type = 'boolean'\n  ",{},{returnType:"rows"});const n=t.find((e=>"~~"===e.name&&e.description.toLowerCase().includes(" like "))),a=t.find((e=>"!~~"===e.name&&e.description.toLowerCase().includes(" like ")));n&&a&&(t.push({...n,name:"LIKE",description:n.description+`.\n\n Same as ${n.name} operator`}),t.push({...a,name:"NOT LIKE",description:a.description+`.\n\n Same as ${a.name} operator`}));const l=t.find((e=>"~~*"===e.name&&e.description.toLowerCase().includes(" like "))),o=t.find((e=>"!~~*"===e.name&&e.description.toLowerCase().includes(" like ")));return l&&o&&(t.push({...l,name:"ILIKE",description:l.description+`.\n\n Same as ${l.name} operator`}),t.push({...o,name:"NOT ILIKE",description:o.description+`.\n\nSame as ${o.name} operator`})),t};async function Be(e){let{db:t,name:n,minArgs:a=0,limit:l=10,distinct:o=!1,searchTerm:i}=e;if(i);else if(void 0===n)n="";else if(""===n)return[];let s=" LIMIT ${limit}",r="\n        SELECT *\n          , upper(name) || '(' || concat_ws(',', arg_list_str) || ')' || ' => ' || restype || E'\n' || description as func_signature\n          , CASE WHEN is_aggregate THEN 'Could not get aggregate function definition' ELSE pg_get_functiondef(oid) END as definition\n          , CASE WHEN schema IS NULL OR current_schema() = schema OR schema = 'pg_catalog' THEN format('%I', name) ELSE format('%I.%I', schema, name) END as escaped_identifier\n        FROM (\n          SELECT p.proname AS name\n                , pg_get_function_identity_arguments(p.oid) AS arg_list_str\n                , pg_catalog.pg_get_function_result(p.oid) as restype\n                , d.description\n                , n.nspname as schema\n                , pronargs as args_length\n                , prokind = 'a' as is_aggregate\n                , p.oid\n                , ext.extension\n          FROM   pg_proc p\n          LEFT JOIN pg_description d ON d.objoid = p.oid\n          LEFT JOIN pg_catalog.pg_namespace n ON n.oid = p.pronamespace\n          LEFT JOIN (\n            SELECT p.oid , (array_agg(e.extname))[1] as extension\n            FROM pg_catalog.pg_extension AS e\n                INNER JOIN pg_catalog.pg_depend AS d ON (d.refobjid = e.oid)\n                INNER JOIN pg_catalog.pg_proc AS p ON (p.oid = d.objid)\n                INNER JOIN pg_catalog.pg_namespace AS ne ON (ne.oid = e.extnamespace)\n                INNER JOIN pg_catalog.pg_namespace AS np ON (np.oid = p.pronamespace)\n            WHERE d.deptype = 'e'\n            GROUP BY  p.oid\n          ) ext\n          ON ext.oid = p.oid\n          WHERE TRUE\n           AND pronargs >= ${minArgs} \n           AND p.proname ilike ${name} \n        ) tt\n      ";const c=o?`\n    SELECT DISTINCT ON (length(name::text), name) \n      name, arg_list_str, description, args_length, is_aggregate, restype, \n      schema, func_signature, definition, escaped_identifier, extension\n    FROM (\n      SELECT * \n      FROM (\n        ${r}  \n      ) t\n      WHERE TRUE\n      ORDER BY arg_list_str ILIKE '%cstring%' OR arg_list_str = 'cstring'\n    ) t     \n    ORDER BY length(name::text), name, arg_list_str, description \n    ${s}\n  `:"\n        SELECT *\n          , upper(name) || '(' || concat_ws(',', arg_list_str) || ')' || ' => ' || restype || E'\n' || description as func_signature\n          , CASE WHEN is_aggregate THEN 'Could not get aggregate function definition' ELSE pg_get_functiondef(oid) END as definition\n          , CASE WHEN schema IS NULL OR current_schema() = schema OR schema = 'pg_catalog' THEN format('%I', name) ELSE format('%I.%I', schema, name) END as escaped_identifier\n        FROM (\n          SELECT p.proname AS name\n                , pg_get_function_identity_arguments(p.oid) AS arg_list_str\n                , pg_catalog.pg_get_function_result(p.oid) as restype\n                , d.description\n                , n.nspname as schema\n                , pronargs as args_length\n                , prokind = 'a' as is_aggregate\n                , p.oid\n                , ext.extension\n          FROM   pg_proc p\n          LEFT JOIN pg_description d ON d.objoid = p.oid\n          LEFT JOIN pg_catalog.pg_namespace n ON n.oid = p.pronamespace\n          LEFT JOIN (\n            SELECT p.oid , (array_agg(e.extname))[1] as extension\n            FROM pg_catalog.pg_extension AS e\n                INNER JOIN pg_catalog.pg_depend AS d ON (d.refobjid = e.oid)\n                INNER JOIN pg_catalog.pg_proc AS p ON (p.oid = d.objid)\n                INNER JOIN pg_catalog.pg_namespace AS ne ON (ne.oid = e.extnamespace)\n                INNER JOIN pg_catalog.pg_namespace AS np ON (np.oid = p.pronamespace)\n            WHERE d.deptype = 'e'\n            GROUP BY  p.oid\n          ) ext\n          ON ext.oid = p.oid\n          WHERE TRUE\n           AND pronargs >= ${minArgs} \n           AND p.proname ilike ${name} \n        ) tt\n      \n LIMIT ${limit}";return await t.sql(c,{name:n||"%",limit:l,minArgs:a}).then((e=>e.rows.map((e=>{const t=(e.arg_list_str?e.arg_list_str.split(","):[]).map(((e,t)=>({label:`arg${t}: `+e.trim(),data_type:e.trim()})));return e.arg_list_str=t.map((e=>e.label)).join(", "),{...e,args:t}}))))}let We=["A","ABORT","ABS","ABSENT","ABSOLUTE","ACCESS","ACCORDING","ACTION","ADA","ADD","ADMIN","AFTER","AGGREGATE","ALL","ALLOCATE","ALSO","ALTER","ALWAYS","ANALYSE","ANALYZE","AND","ANY","ARE","ARRAY","ARRAY_AGG","ARRAY_MAX_CARDINALITY","AS","ASC","ASENSITIVE","ASSERTION","ASSIGNMENT","ASYMMETRIC","AT","ATOMIC","ATTRIBUTE","ATTRIBUTES","AUTHORIZATION","AVG","BACKWARD","BASE64","BEFORE","BEGIN","BEGIN_FRAME","BEGIN_PARTITION","BERNOULLI","BETWEEN","BIGINT","BINARY","BIT","BIT_LENGTH","BLOB","BLOCKED","BOM","BOOLEAN","BOTH","BREADTH","BY","C","CACHE","CALL","CALLED","CARDINALITY","CASCADE","CASCADED","CASE","CAST","CATALOG","CATALOG_NAME","CEIL","CEILING","CHAIN","CHAR","CHARACTER","CHARACTERISTICS","CHARACTERS","CHARACTER_LENGTH","CHARACTER_SET_CATALOG","CHARACTER_SET_NAME","CHARACTER_SET_SCHEMA","CHAR_LENGTH","CHECK","CHECKPOINT","CLASS","CLASS_ORIGIN","CLOB","CLOSE","CLUSTER","COALESCE","COBOL","COLLATE","COLLATION","COLLATION_CATALOG","COLLATION_NAME","COLLATION_SCHEMA","COLLECT","COLUMN","COLUMNS","COLUMN_NAME","COMMAND_FUNCTION","COMMAND_FUNCTION_CODE","COMMENT","COMMENTS","COMMIT","COMMITTED","CONCURRENTLY","CONDITION","CONDITION_NUMBER","CONFIGURATION","CONFLICT","CONNECT","CONNECTION","CONNECTION_NAME","CONSTRAINT","CONSTRAINTS","CONSTRAINT_CATALOG","CONSTRAINT_NAME","CONSTRAINT_SCHEMA","CONSTRUCTOR","CONTAINS","CONTENT","CONTINUE","CONTROL","CONVERSION","CONVERT","COPY","CORR","CORRESPONDING","COST","COUNT","COVAR_POP","COVAR_SAMP","CREATE","CROSS","CSV","CUBE","CUME_DIST","CURRENT","CURRENT_CATALOG","CURRENT_DATE","CURRENT_DEFAULT_TRANSFORM_GROUP","CURRENT_PATH","CURRENT_ROLE","CURRENT_ROW","CURRENT_SCHEMA","CURRENT_TIME","CURRENT_TIMESTAMP","CURRENT_TRANSFORM_GROUP_FOR_TYPE","CURRENT_USER","CURSOR","CURSOR_NAME","CYCLE","DATA","DATABASE","DATALINK","DATE","DATETIME_INTERVAL_CODE","DATETIME_INTERVAL_PRECISION","DAY","DB","DEALLOCATE","DEC","DECIMAL","DECLARE","DEFAULT","DEFAULTS","DEFERRABLE","DEFERRED","DEFINED","DEFINER","DEGREE","DELETE","DELIMITER","DELIMITERS","DENSE_RANK","DEPTH","DEREF","DERIVED","DESC","DESCRIBE","DESCRIPTOR","DETERMINISTIC","DIAGNOSTICS","DICTIONARY","DISABLE","DISCARD","DISCONNECT","DISPATCH","DISTINCT","DLNEWCOPY","DLPREVIOUSCOPY","DLURLCOMPLETE","DLURLCOMPLETEONLY","DLURLCOMPLETEWRITE","DLURLPATH","DLURLPATHONLY","DLURLPATHWRITE","DLURLSCHEME","DLURLSERVER","DLVALUE","DO","DOCUMENT","DOMAIN","DOUBLE","DROP","DYNAMIC","DYNAMIC_FUNCTION","DYNAMIC_FUNCTION_CODE","EACH","ELEMENT","ELSE","EMPTY","ENABLE","ENCODING","ENCRYPTED","END","END-EXEC","END_FRAME","END_PARTITION","ENFORCED","ENUM","EQUALS","ESCAPE","EVENT","EVERY","EXCEPT","EXCEPTION","EXCLUDE","EXCLUDING","EXCLUSIVE","EXEC","EXECUTE","EXISTS","EXP","EXPLAIN","EXPRESSION","EXTENSION","EXTERNAL","EXTRACT","FALSE","FAMILY","FETCH","FILE","FILTER","FINAL","FIRST","FIRST_VALUE","FLAG","FLOAT","FLOOR","FOLLOWING","FOR","FORCE","FOREIGN","FORTRAN","FORWARD","FOUND","FRAME_ROW","FREE","FREEZE","FROM","FS","FULL","FUNCTION","FUNCTIONS","FUSION","G","GENERAL","GENERATED","GET","GLOBAL","GO","GOTO","GRANT","GRANTED","GREATEST","GROUP","GROUPING","GROUPS","HANDLER","HAVING","HEADER","HEX","HIERARCHY","HOLD","HOUR","ID","IDENTITY","IF","IGNORE","ILIKE","IMMEDIATE","IMMEDIATELY","IMMUTABLE","IMPLEMENTATION","IMPLICIT","IMPORT","IN","INCLUDING","INCREMENT","INDENT","INDEX","INDEXES","INDICATOR","INHERIT","INHERITS","INITIALLY","INLINE","INNER","INOUT","INPUT","INSENSITIVE","INSERT","INSTANCE","INSTANTIABLE","INSTEAD","INT","INTEGER","INTEGRITY","INTERSECT","INTERSECTION","INTERVAL","INTO","INVOKER","IS","ISNULL","ISOLATION","JOIN","K","KEY","KEY_MEMBER","KEY_TYPE","LABEL","LAG","LANGUAGE","LARGE","LAST","LAST_VALUE","LATERAL","LEAD","LEADING","LEAKPROOF","LEAST","LEFT","LENGTH","LEVEL","LIBRARY","LIKE","LIKE_REGEX","LIMIT","LINK","LISTEN","LN","LOAD","LOCAL","LOCALTIME","LOCALTIMESTAMP","LOCATION","LOCATOR","LOCK","LOCKED","LOGGED","LOWER","M","MAP","MAPPING","MATCH","MATCHED","MATERIALIZED","MAX","MAXVALUE","MAX_CARDINALITY","MEMBER","MERGE","MESSAGE_LENGTH","MESSAGE_OCTET_LENGTH","MESSAGE_TEXT","METHOD","MIN","MINUTE","MINVALUE","MOD","MODE","MODIFIES","MODULE","MONTH","MORE","MOVE","MULTISET","MUMPS","NAME","NAMES","NAMESPACE","NATIONAL","NATURAL","NCHAR","NCLOB","NESTING","NEW","NEXT","NFC","NFD","NFKC","NFKD","NIL","NO","NONE","NORMALIZE","NORMALIZED","NOT","NOTHING","NOTIFY","NOTNULL","NOWAIT","NTH_VALUE","NTILE","NULL","NULLABLE","NULLIF","NULLS","NUMBER","NUMERIC","OBJECT","OCCURRENCES_REGEX","OCTETS","OCTET_LENGTH","OF","OFF","OFFSET","OIDS","OLD","ON","ONLY","OPEN","OPERATOR","OPTION","OPTIONS","OR","ORDER","ORDERING","ORDINALITY","OTHERS","OUT","OUTER","OUTPUT","OVER","OVERLAPS","OVERLAY","OVERRIDING","OWNED","OWNER","P","PAD","PARAMETER","PARAMETER_MODE","PARAMETER_NAME","PARAMETER_ORDINAL_POSITION","PARAMETER_SPECIFIC_CATALOG","PARAMETER_SPECIFIC_NAME","PARAMETER_SPECIFIC_SCHEMA","PARSER","PARTIAL","PARTITION","PASCAL","PASSING","PASSTHROUGH","PASSWORD","PATH","PERCENT","PERCENTILE_CONT","PERCENTILE_DISC","PERCENT_RANK","PERIOD","PERMISSION","PLACING","PLANS","PLI","POLICY","PORTION","POSITION","POSITION_REGEX","POWER","PRECEDES","PRECEDING","PRECISION","PREPARE","PREPARED","PRESERVE","PRIMARY","PRIOR","PRIVILEGES","PROCEDURAL","PROCEDURE","PROGRAM","PUBLIC","QUOTE","RANGE","RANK","READ","READS","REAL","REASSIGN","RECHECK","RECOVERY","RECURSIVE","REF","REFERENCES","REFERENCING","REFRESH","REGR_AVGX","REGR_AVGY","REGR_COUNT","REGR_INTERCEPT","REGR_R2","REGR_SLOPE","REGR_SXX","REGR_SXY","REGR_SYY","REINDEX","RELATIVE","RELEASE","RENAME","REPEATABLE","REPLACE","REPLICA","REQUIRING","RESET","RESPECT","RESTART","RESTORE","RESTRICT","RESULT","RETURN","RETURNED_CARDINALITY","RETURNED_LENGTH","RETURNED_OCTET_LENGTH","RETURNED_SQLSTATE","RETURNING","RETURNS","REVOKE","RIGHT","ROLE","ROLLBACK","ROLLUP","ROUTINE","ROUTINE_CATALOG","ROUTINE_NAME","ROUTINE_SCHEMA","ROW","ROWS","ROW_COUNT","ROW_NUMBER","RULE","SAVEPOINT","SCALE","SCHEMA","SCHEMA_NAME","SCOPE","SCOPE_CATALOG","SCOPE_NAME","SCOPE_SCHEMA","SCROLL","SEARCH","SECOND","SECTION","SECURITY","SELECT","SELECTIVE","SELF","SENSITIVE","SEQUENCE","SEQUENCES","SERIALIZABLE","SERVER","SERVER_NAME","SESSION","SESSION_USER","SET","SETOF","SETS","SHARE","SHOW","SIMILAR","SIMPLE","SIZE","SKIP","SMALLINT","SNAPSHOT","SOME","SOURCE","SPACE","SPECIFIC","SPECIFICTYPE","SPECIFIC_NAME","SQL","SQLCODE","SQLERROR","SQLEXCEPTION","SQLSTATE","SQLWARNING","SQRT","STABLE","STANDALONE","START","STATE","STATEMENT","STATIC","STATISTICS","STDDEV_POP","STDDEV_SAMP","STDIN","STDOUT","STORAGE","STRICT","STRIP","STRUCTURE","STYLE","SUBCLASS_ORIGIN","SUBMULTISET","SUBSTRING","SUBSTRING_REGEX","SUCCEEDS","SUM","SYMMETRIC","SYSID","SYSTEM","SYSTEM_TIME","SYSTEM_USER","T","TABLE","TABLES","TABLESAMPLE","TABLESPACE","TABLE_NAME","TEMP","TEMPLATE","TEMPORARY","TEXT","THEN","TIES","TIME","TIMESTAMP","TIMEZONE_HOUR","TIMEZONE_MINUTE","TO","TOKEN","TOP_LEVEL_COUNT","TRAILING","TRANSACTION","TRANSACTIONS_COMMITTED","TRANSACTIONS_ROLLED_BACK","TRANSACTION_ACTIVE","TRANSFORM","TRANSFORMS","TRANSLATE","TRANSLATE_REGEX","TRANSLATION","TREAT","TRIGGER","TRIGGER_CATALOG","TRIGGER_NAME","TRIGGER_SCHEMA","TRIM","TRIM_ARRAY","TRUE","TRUNCATE","TRUSTED","TYPE","TYPES","UESCAPE","UNBOUNDED","UNCOMMITTED","UNDER","UNENCRYPTED","UNION","UNIQUE","UNKNOWN","UNLINK","UNLISTEN","UNLOGGED","UNNAMED","UNNEST","UNTIL","UNTYPED","UPDATE","UPPER","URI","USAGE","USER","USER_DEFINED_TYPE_CATALOG","USER_DEFINED_TYPE_CODE","USER_DEFINED_TYPE_NAME","USER_DEFINED_TYPE_SCHEMA","USING","VACUUM","VALID","VALIDATE","VALIDATOR","VALUE","VALUES","VALUE_OF","VARBINARY","VARCHAR","VARIADIC","VARYING","VAR_POP","VAR_SAMP","VERBOSE","VERSION","VERSIONING","VIEW","VIEWS","VOLATILE","WHEN","WHENEVER","WHERE","WHITESPACE","WIDTH_BUCKET","WINDOW","WITH","WITHIN","WITHOUT","WORK","WRAPPER","WRITE","XML","XMLAGG","XMLATTRIBUTES","XMLBINARY","XMLCAST","XMLCOMMENT","XMLCONCAT","XMLDECLARATION","XMLDOCUMENT","XMLELEMENT","XMLEXISTS","XMLFOREST","XMLITERATE","XMLNAMESPACES","XMLPARSE","XMLPI","XMLQUERY","XMLROOT","XMLSCHEMA","XMLSERIALIZE","XMLTABLE","XMLTEXT","XMLVALIDATE","YEAR","YES","ZONE","IF NOT EXISTS"];const $e=Array.from(new Set([...[{key:"SELECT",type:"column"},{key:"RETURNING",type:"column"},{key:"FROM",type:"table"},{key:"INTO",type:"table"},{key:"JOIN",type:"table"},{key:"ON",type:"column"},{key:"WHERE",type:"column"},{key:"ORDER BY",type:"column"},{key:"UPDATE",type:"table"},{key:"DELETE",type:"table"},{key:"TABLE",type:"table"}].map((e=>e.key)),...qe()]));We=We.sort(((e,t)=>+$e.includes(t)-+$e.includes(e)));const Ue=qe();function qe(){return Te.map((e=>{let t,n=!1,a=99;return"REASSIGN"===e?(a=0,n=!0,t=`REASSIGN OWNED instructs the system to change the ownership of database objects owned by any of the old_roles to new_role.\nhttps://www.postgresql.org/docs/current/sql-reassign-owned.html\n\n${ke("REASSIGN OWNED \nBY { old_role | CURRENT_ROLE | CURRENT_USER | SESSION_USER } [, ...]\nTO { new_role | CURRENT_ROLE | CURRENT_USER | SESSION_USER }")}`):"TRUNCATE"===e?(a=14,n=!0,t="TRUNCATE quickly removes all rows from a set of tables. It has the same effect as an unqualified DELETE on each table, but since it does not actually scan the tables it is faster. \nFurthermore, it reclaims disk space immediately, rather than requiring a subsequent VACUUM operation. This is most useful on large tables.\n\nhttps://www.postgresql.org/docs/current/sql-truncate.html\n"):"SELECT"===e?(a=0,n=!0,t="Retrieves data from tables, functions or other objects   \nhttps://www.postgresql.org/docs/current/sql-select.html\n```sql\nSELECT * FROM users;\n\nSELECT version();\n\nSELECT  f1, f2, MAX(f12)\nFROM table_name \nWHERE f1 = 2 \nGROUP BY col2\nHAVING MAX(f12) < 10\nORDER BY f1 DESC\nLIMIT 1\nOFFSET 2\n\n-- Create table from select\nCREATE TABLE archived_users AS\nSELECT * FROM users \n```\n"):"SHOW"===e?(n=!0,t="Show the value of a run-time parameter. These variables can be set using the SET statement\n  https://www.postgresql.org/docs/current/sql-show.html\n```sql\nSHOW datestyle\n\nSHOW ALL\n```\n"):"TABLE"===e?(n=!0,t="\n```sql\n```\n"):"LISTEN"===e?(n=!0,t="Listen to NOTIFY notifications on a channel\nhttps://www.postgresql.org/docs/current/sql-listen.html\n```sql\nLISTEN my_channel;\n\n/* To push a message */\nNOTIFY my_channel, 'hello';\n```\n"):"NOTIFY"===e?(n=!0,t="Send a notification to a channel\nhttps://www.postgresql.org/docs/current/sql-notify.html\n```sql\nNOTIFY my_channel, 'hello';\n\n\n/* To listen to this channel */\nLISTEN my_channel;\n```\n"):"DELETE FROM"===e?(a=4,n=!0,t="Delete data from a table    \nhttps://www.postgresql.org/docs/current/sql-delete.html\n```sql\nDELETE FROM table_name;\n\nDELETE FROM users\nWHERE last_active < now() - interval'1 month'\nRETURNING *\n```\n"):"INSERT INTO"===e?(a=1,n=!0,t="Insert data into a table  \nhttps://www.postgresql.org/docs/current/sql-insert.html\n```sql\nINSERT INTO some_table \nDEFAULT VALUES;\n\nINSERT INTO users(age, name, added)\nVALUES(112, 'a', now())\nRETURNING *;\n\nINSERT INTO users(age, name, added)\nSELECT age, name, added\nFROM archived_users\n```\n"):"UPDATE"===e?(a=2,n=!0,t="Updates data in a table\nhttps://www.postgresql.org/docs/current/sql-update.html\n```sql\nUPDATE users SET status = 'active';\n\nUPDATE books \nSET title = books || 'active'\nWHERE title NOT ILIKE 'title%';\n\n```\n"):"CREATE"===e?(a=3,n=!0,t="Create an object\n```sql\nCREATE TABLE users(\n  age INTEGER,  \n  name TEXT,  \n  type TEXT,  \n  added TIMESTAMP  \n);\n\nCREATE OR REPLACE VIEW admin_users AS \n  SELECT * FROM users WHERE type = 'admin';\n\nCREATE OR REPLACE FUNCTION log_message(VARIADIC args TEXT[]) RETURNS VOID AS $$     \nBEGIN\n\n  IF to_regclass('logs') IS NULL THEN\n    CREATE TABLE IF NOT EXISTS logs(m TEXT);\n  END IF;\n\n  INSERT INTO logs(m) \n  VALUES(concat_ws(' ', args));\n\nEND;\n$$ LANGUAGE plpgsql;\n\n```\n"):"DROP"===e?(n=!0,a=5,t="Drop an object  \n```sql\nDROP TABLE users;\n\nDROP TABLE IF EXISTS books;\n\nDROP VIEW admin_users;\n```\n"):"COMMENT"===e?(n=!0,t="Adds a comment to an object\nhttps://www.postgresql.org/docs/current/sql-comment.html\n```sql\nCOMMENT ON FUNCTION log_message \nIS 'Concat and insert arguments into logs table';\n\n--To view a table comment\nSELECT obj_description('table_name'::REGCLASS)\n\n--To view a column comment (1 is col position)\nSELECT col_description('public.dwadwad'::REGCLASS, 1)\n\n```\n"):"BEGIN"===e?(n=!0,t="Initiates a transaction block where all statements will be executed in a single transaction until an explicit COMMIT or ROLLBACK is given\nhttps://www.postgresql.org/docs/current/sql-begin.html\n```sql\nBEGIN;\nUPDATE orders SET price = 2;\nCOMMIT;\n\nBEGIN ISOLATION LEVEL SERIALIZABLE;\nUPDATE orders SET price = 2;\nCOMMIT;\n```\n"):"DO"===e?(n=!0,t="Execute an anonymous code block\nhttps://www.postgresql.org/docs/current/sql-do.html\n```sql\nDO $$ \n  DECLARE r regclass;\nBEGIN\n\n  r := to_regclass('my_table');\n  IF r IS NOT NULL THEN\n    UPDATE my_table SET last_check = NOW();\n  END IF;\n\nEND $$;\n```\n"):"SET"===e?(n=!0,a=7,t=`\nUsed in updating column data:  \nhttps://www.postgresql.org/docs/current/sql-update.html\n\n\n${ke("SET datestyle TO postgres, dmy;")}\n\nOr in changing a run-time parameter:\nhttps://www.postgresql.org/docs/current/sql-set.html  \n\n${ke("UPDATE mytable SET mycolumn = 1;")}\n\n`):"ALTER"===e?(a=7,n=!0,t='Change an object\n```sql\nALTER TABLE users \nADD COLUMN deleted BOOLEAN;\n\nALTER DATABASE database_name \nSET datestyle TO "ISO, DMY";\n\n```\n'):"WITH"===e?(n=!0,a=6,t="Specifies a temporary named result set\nhttps://www.postgresql.org/docs/current/queries-with.html\n```sql\nWITH cte1 AS (SELECT * FROM orders)\n, cte2 AS (SELECT * FROM customers)\n\nSELECT *\nFROM\n  cte1 c1\n  INNER JOIN cte2 c2\n  ON ........\n\n```\n"):"REINDEX"===e?(n=!0,t="Rebuild indexes\nhttps://www.postgresql.org/docs/current/sql-reindex.html\n```sql\nREINDEX TABLE CONCURRENTLY my_broken_table;\n```\n"):"COPY"===e?(n=!0,t="Export or import data\nhttps://www.postgresql.org/docs/current/sql-copy.html\n```sql\n-- Export to csv\nCOPY my_table TO '/tmp/my_table.csv' \nWITH (FORMAT CSV, HEADER);\n\n-- Import from csv (Must create table beforehand)\nCOPY zip_codes \nFROM '/path/to/ZIP_CODES.txt' \nDELIMITER ',' CSV HEADER;\n```\n"):"VALUES"===e?t="VALUES provides a way to generate a “constant table” that can be used in a query\nhttps://www.postgresql.org/docs/current/queries-values.html\n```sql\nINSERT INTO cities(name)\nVALUES ('London'), ('Vilnius');\n```\n":"EXPLAIN"===e?(n=!0,a=10,t="Get query plan of a query\nhttps://www.postgresql.org/docs/current/sql-explain.html\n```sql\nEXPLAIN SELECT * FROM weather;\n\nEXPLAIN ANALYZE SELECT * FROM weather;\n```\n"):"VACUUM"===e?(a=11,n=!0,t="Garbage-collect and optionally analyze a database\nhttps://www.postgresql.org/docs/current/sql-vacuum.html\n```sql\nVACUUM (VERBOSE, ANALYZE) my_database;\n```\n"):"GRANT"===e?(a=9,n=!0,t="The GRANT command has two basic variants: \n  1. one that grants privileges on a database object (table, column, view, sequence, database, foreign-data wrapper, foreign server, function, procedural language, schema, or tablespace),\n  2. one that grants membership in a role\n  https://www.postgresql.org/docs/current/sql-grant.html\n\n```sql\nGRANT INSERT, UPDATE ON films TO PUBLIC;\n```\n"):"REVOKE"===e&&(a=10,n=!0,t="The REVOKE command revokes previously granted privileges from one or more roles. The key word PUBLIC refers to the implicitly defined group of all roles.\nhttps://www.postgresql.org/docs/current/sql-revoke.html\n\n```sql\nREVOKE INSERT, UPDATE ON films TO PUBLIC;\n\n/* Revoke membership in role admins from user joe */\nREVOKE admins FROM joe;\n\n```\n"),{label:e,info:t,start_kwd:n,priority:a}})).sort(((e,t)=>e.priority-t.priority))}const je={IN:`The right-hand side is a parenthesized list of scalar expressions. The result is "true" if the left-hand expression's result is equal to any of the right-hand expressions. This is a shorthand notation for: \n\n${ke("expression = value1\nOR\nexpression = value2\nOR\n\n--Example usage:\nvalue IN (value1,value2,...)\nvalue IN (SELECT column_name FROM table_name);\n")}`,RAISE:"Report messages and raise errors. Can only be used in PL/pgSQL\nhttps://www.postgresql.org/docs/current/plpgsql-errors-and-messages.html\n\n"+ke("RAISE EXCEPTION 'something not right';\n\nRAISE NOTICE 'Calling cs_create_job(%)', v_job_id;\n"),REFRESH:"Replace the contents of a materialized view\nhttps://www.postgresql.org/docs/current/sql-refreshmaterializedview.html\n\n"+ke("REFRESH MATERIALIZED VIEW CONCURRENTLY mv_view;"),ORDER:"Sepcify how rows will be ordered\nhttps://www.postgresql.org/docs/current/queries-order.html\n\n"+ke("\nORDER BY col_name, col_name DESC\n\nORDER BY col_name DESC NULLS FIRST\nORDER BY col_name ASC NULLS LAST"),JOIN:"Combine two or more result sets into one\nhttps://www.postgresql.org/docs/current/tutorial-join.html\n\n"+ke("\nSELECT *\nFROM weather w\nINNER JOIN cities c\nON w.city = c.name;"),FROM:"Precedes a table or expression\n"+ke("\nSELECT ... FROM table_name;\n\nDELETE FROM table_name;\n\nSELECT * FROM (SELECT max(a), ... FROM ...)"),FOR:"Iterate through data. Can only be executed within a function or code block\n\n"+ke("\nDO $$ \nDECLARE usr RECORD;\nBEGIN\n\nFOR usr IN SELECT * FROM users\nLOOP\n\n  DELETE FROM sessions \n  WHERE user_id = usr.id;\nEND LOOP;\n\nEND $$;\n"),INTO:"SELECT INTO creates a new table and fills it with data computed by a query. The new table's columns have the names and data types associated with the output columns of the SELECT. The data is not returned to the client, as it is with a normal SELECT. \n\n"+ke("SELECT * \nINTO films_recent \nFROM films WHERE date_prod >= '2002-01-01';"),LIMIT:"If a limit count is given, no more than that many rows will be returned (but possibly fewer, if the query itself yields fewer rows). \n\nLIMIT ALL is the same as omitting the LIMIT clause, as is LIMIT with a NULL argument.\nWhen using LIMIT, it is important to use an ORDER BY clause that constrains the result rows into a unique order. Otherwise you will get an unpredictable subset of the query's rows. You might be asking for the tenth through twentieth rows, but tenth through twentieth in what ordering? The ordering is unknown, unless you specified ORDER BY.\n\n"+ke("\nSELECT select_list\nFROM table_expression\nLIMIT 10"),OFFSET:"OFFSET says to skip that many rows before beginning to return rows.   \n\nOFFSET 0 is the same as omitting the OFFSET clause, as is OFFSET with a NULL argument.\nThe rows skipped by an OFFSET clause still have to be computed inside the server; therefore a large OFFSET might be inefficient.\n\n"+ke("\nSELECT select_list\nFROM table_expression\nOFFSET 3"),HAVING:"The fundamental difference between WHERE and HAVING is this: \n\n**WHERE** selects input rows **before** groups and **aggregates are computed** (thus, it controls which rows go into the aggregate computation), whereas  \n\n**HAVING** selects group rows **after** groups and **aggregates are computed.**  \n\n"+ke("\nSELECT \n  city, \n  max(temp_lo), \n  count(*) FILTER (WHERE temp_lo < 30)\nFROM weather\nGROUP BY city\nHAVING max(temp_lo) < 40;\n  "),FILTER:"If FILTER is specified, then only the input rows for which the filter_clause evaluates to true are fed to the aggregate function; other rows are discarded. For example:\n\n"+ke("\nSELECT\n  count(*) AS unfiltered,\n  count(*) FILTER (WHERE i < 5) AS filtered\nFROM generate_series(1,10) AS s(i);\n unfiltered | filtered\n------------+----------\n         10 |        4\n(1 row)\n"),WHERE:"Where condition is any expression that evaluates to a result of type boolean. Any row that does not satisfy this condition will be eliminated from the output. A row satisfies the condition if it returns true when the actual row values are substituted for any variable references.\n",RETURNING:"Obtain data from modified rows while they are being manipulated.\n\nhttps://www.postgresql.org/docs/current/dml-returning.html\nThe allowed contents of a RETURNING clause are the same as a SELECT command's output list (see Section 7.3). It can contain column names of the command's target table, or value expressions using those columns.\n",DISTINCT:`If SELECT DISTINCT is specified, all duplicate rows are removed from the result set (one row is kept from each group of duplicates). \n\nSELECT DISTINCT ON ( expression [, ...] ) keeps only the first row of each set of rows where the given expressions evaluate to equal. The DISTINCT ON expressions are interpreted using the same rules as for ORDER BY (see above). Note that the “first row” of each set is unpredictable unless ORDER BY is used to ensure that the desired row appears first\nExample:\n${ke("\n--list locations\nSELECT DISTINCT location\nFROM weather_reports\n\n--most recent weather report for each location\nSELECT DISTINCT ON (location) location, time, report\nFROM weather_reports\nORDER BY location, time DESC;\n")}`,COALESCE:"The COALESCE function returns the first of its arguments that is not null. Null is returned only if all arguments are null.",NULLIF:`The NULLIF function returns a null value if value1 equals value2: \n\n${ke("NULLIF(value1, value2)")}`,GREATEST:`The GREATEST and LEAST functions select the largest or smallest value from a list of any number of expressions. ${ke("GREATEST(value1, value2, ...)")}`,LEAST:`The GREATEST and LEAST functions select the largest or smallest value from a list of any number of expressions. ${ke("LEAST(value1, value2, ...)")}`,CASE:`The SQL CASE expression is a generic conditional expression, similar to if/else statements in other programming languages:\n${ke("SELECT CASE WHEN 1 THEN 'one' ELSE 'none' END  ")}`},ze=Se([{label:"*",docs:"All columns"}]).suggestions,Ye=(e,t,n)=>{if(!e)return{suggestions:[]};const a=Array.isArray(e)?e:Ve(e),l="column"===(null==a?void 0:a.join())?ze:"role"===(null==a?void 0:a.join())?Se([{label:"CURRENT_USER",docs:"Name of current execution context"},{label:"SESSION_USER",docs:"Session user name"}]).suggestions:[],o=n.filter((e=>null==a?void 0:a.includes(e.type))).map((e=>({...e,sortText:e.userInfo?e.userInfo.priority:e.dataTypeInfo?e.dataTypeInfo.priority:("public"===e.schema?"a":"b")+e.name}))).concat(l.map((e=>({...e,sortText:"a"})))),i=t.prevTokens.filter((e=>"identifier.sql"===e.type)).map((e=>e.text));if(i.length){const e=o.filter((e=>i.includes(e.escapedParentName)));if(e.length)return{suggestions:e}}return!o.length&&Rl.some((e=>null==a?void 0:a.includes(e)))?Se([{label:`No ${a} found`}]):{suggestions:o}},Ve=e=>{if(e)return"MATERIALIZED"===e.toUpperCase()?["mview"]:["user","group","owner","authorization"].includes(e)?["role"]:"datatype"===e?["dataType"]:"tableOrView"===e?["view","table","mview"]:[Rl.find((t=>t.toLowerCase()===e.toLowerCase().trim()))].filter(m.isDefined)},Ge=(e,t,n,a,l=!1)=>{var o;const{prevTokens:i,prevText:s,currToken:r,tokens:c,textLC:d,getPrevTokensNoParantheses:p}=t,u=p(),h=u.slice().reverse().filter((t=>"keyword.sql"===t.type||"operator.sql"===t.type||e.some((e=>e.kwd===t.text.toUpperCase())))),g=h.flatMap(((t,n)=>e.map(((e,a)=>{let l=!1;if(e.kwd.split(" ").length>1){const a=h[n+1];l=!!(e.kwd.endsWith(t.text.toUpperCase())&&a&&e.kwd.startsWith(a.text.toUpperCase()))}else l=t.text.toUpperCase()===e.kwd;if(l)return{kwd:e,kwdIdx:a,token:t}})))).filter(m.isDefined),f=g[0],E=null==f?void 0:f.token,v=u.findIndex((e=>e.offset===(null==E?void 0:E.offset))),b=u.slice(v).filter((e=>"identifier.sql"===e.type)).map((e=>e.text)),y=null==f?void 0:f.kwd,N=null!==(o=null==f?void 0:f.kwdIdx)&&void 0!==o?o:-1,w=e.findIndex(((e,t)=>N>-1&&t>N&&c.some(((t,n)=>n>v&&t.text.toUpperCase()===e.kwd)))),S=(e,t)=>Se(e.map(((e,a)=>({label:e,sortText:null!=t?t:a+"",insertText:e+" ",kind:n("keyword")}))));let T=(l?e:e.slice(N+1,w>N?w:e.length)).filter((e=>e.canRepeat||!c.some((t=>t.text.toUpperCase()===e.kwd))));return T=T.filter((e=>{var n,a;let l=!0;return e.justAfter&&(l=l&&u.some((t=>{var n;return null===(n=e.justAfter)||void 0===n?void 0:n.includes(t.text.toUpperCase())}))),e.dependsOn&&(l=l&&u.some((t=>t.text===e.dependsOn))),e.excludeIf&&(l=l&&!u.some((t=>{var n;return null===(n=e.excludeIf)||void 0===n?void 0:n.includes(t.text)}))),(null===(n=e.exactlyAfter)||void 0===n?void 0:n.length)&&(l=(null===(a=t.ltoken)||void 0===a?void 0:a.textLC)===e.kwd.toLowerCase()),l})),T.some((e=>{var t;return(null==y?void 0:y.kwd)&&(null===(t=e.justAfter)||void 0===t?void 0:t.includes(null==y?void 0:y.kwd))}))&&(T=T.filter((e=>e.justAfter&&!g.some((t=>{var n;return null===(n=t.kwd.justAfter)||void 0===n?void 0:n.some((t=>{var n;return null===(n=e.justAfter)||void 0===n?void 0:n.includes(t)}))}))))),{suggestKWD:S,prevKWD:y,prevIdentifiers:b,remainingKWDS:T,getSuggestion:(l,o)=>{if((null==y?void 0:y.expects)&&t.prevLC.trim().endsWith(null==y?void 0:y.kwd.toLowerCase())){if((null==y?void 0:y.expects)&&Array.isArray(y.expects))return S(y.expects);if(Rl.includes(y.expects)){return Ye(null==y?void 0:y.expects,t,a)}}return Se(T.map((t=>{var i;const r=(l&&![...null!=o?o:[],l].some((e=>s.trim().endsWith(e)))?`${l} `:"")+t.kwd+" ";return{label:t.kwd,docs:t.docs||(null===(i=null==a?void 0:a.find((e=>e.name===t.kwd&&e.documentation)))||void 0===i?void 0:i.documentation),insertText:r,kind:n("keyword"),sortText:e.findIndex((e=>e.kwd===t.kwd)).toString().padStart(2,"0")}})))}}},Je=["DEFAULT","BIG5","EUC_CN","EUC_JP","EUC_JIS_2004","EUC_KR","EUC_TW","GB18030","GBK","ISO_8859_5","ISO_8859_6","ISO_8859_7","ISO_8859_8","JOHAB","KOI8R","KOI8U","LATIN1","LATIN2","LATIN3","LATIN4","LATIN5","LATIN6","LATIN7","LATIN8","LATIN9","LATIN10","MULE_INTERNAL","SJIS","SHIFT_JIS_2004","SQL_ASCII","UHC","UTF8","WIN866","WIN874","WIN1250","WIN1251","WIN1252","WIN1253","WIN1254","WIN1255","WIN1256","WIN1257","WIN1258"],Xe={match:e=>{var t;return"create"===(null===(t=e.tokens[0])||void 0===t?void 0:t.textLC)},result:async(e,t,n,a,l)=>{var o,i,s;const r=null===(o=e.tokens[1])||void 0===o?void 0:o.textLC,c=e.prevTokens.at(-1),d=e.prevTokens.at(-2),m=e.tokens[0],p=e.tokens[1],{prevLC:u,prevTokens:h,thisLinePrevTokens:g}=e,f=g.map((e=>e.textLC)).join(" ");if("extension"===r)return{suggestions:t.filter((e=>"extension"===e.type)).map((e=>{var t;return{...e,sortText:(null===(t=e.extensionInfo)||void 0===t?void 0:t.installed)?"b":"a"}}))};if("create"===(null==m?void 0:m.textLC)&&"database"===(null==p?void 0:p.textLC)){if("database"===(null==c?void 0:c.textLC))return Se([{label:"$new_datebase_name"}]);if("database"===(null==d?void 0:d.textLC))return Se([{label:"WITH"}]);const{getSuggestion:n}=Ge(Qe,e,l,t,!0);return n()}if(e.prevLC.endsWith("for table")||"keyword.sql"===(null==c?void 0:c.type)&&"on"===c.textLC)return{suggestions:t.filter((e=>"table"===e.type)).map((e=>({...e,sortText:"public"===e.schema?"a":"b"})))};if("procedure"===(null==c?void 0:c.textLC))return Ye("function",e,t);if("create or replace"===u)return Se(_e.map((e=>({label:e}))));const E=u.startsWith("create or replace")&&Ce.filter((e=>u.endsWith(e.toLowerCase()))).sort(((e,t)=>t.length-e.length))[0];if(E){if("FUNCTION"===E)return{suggestions:t.filter((e=>"function"===e.type)).map((e=>{var t;return{...e,sortText:"public"===e.schema?"a":"b",insertText:null===(t=e.definition)||void 0===t?void 0:t.slice(27),insertTextRules:1}}))};if("VIEW"===E)return{suggestions:t.filter((e=>e.view&&("VIEW"===E||"m"===e.relkind))).map((e=>{var t;return{...e,sortText:"public"===e.schema?"a":"b",insertText:`${e.escapedIdentifier}  AS \n ${null===(t=e.view)||void 0===t?void 0:t.definition}`,insertTextRules:1}})).concat(Se([{label:"$name",insertText:Ae.VIEW}]).suggestions)}}if(u.includes("create policy")){if(u.endsWith("on"))return{suggestions:t.filter((e=>"table"===e.type)).map((e=>({...e,sortText:"public"===e.schema?"a":"b"})))};if(u.endsWith("to"))return Ye("user",e,t);if(u.endsWith("for"))return Se(Oe.map((e=>({...e,kind:l("keyword")}))));if(u.includes("using")){const n=e.tokens.findIndex((e=>"on"===e.textLC)),a=e.tokens[n+1];return{suggestions:t.filter((e=>"column"===e.type&&a&&e.escapedParentName===a.text))}}}if(u.startsWith("create table")){if(u.endsWith("references"))return Ye("table",e,t);if(f.includes("references")){if("references"!==(null==c?void 0:c.text))return Se(Ie.flatMap((e=>De.map((t=>({label:e.label+" "+t.label,docs:`${e.documentation} \n\n${t.getInfo(e.label.split(" ")[1])}`,kind:l("keyword")}))))));if("on"===(null===(i=h.at(-2))||void 0===i?void 0:i.textLC)&&["DELETE","UPDATE"].includes(c.text.toUpperCase())){const e=c.text.toUpperCase();return Se(De.flatMap((t=>De.map((n=>({label:t.label+" "+n.label,docs:`${n.getInfo(e)}`,kind:l("keyword")}))))))}}if(","===(null==c?void 0:c.textLC)||"("===(null==c?void 0:c.textLC)){let e=Le.filter((({label:e})=>!h.some((t=>t.text===e.split(" ")[0])))).concat([{label:"$column_name",docs:""}]).concat([{label:"${1:col_name} ${2:data_type} ${3:PRIMARY_KEY?} ${4:NOT NULL?} ${5:REFERENCES table_name?} ${6:CHECK(col1 > col2)?}",docs:""}]);return Se(e)}if(1===e.thisLinePrevTokens.length)return Ye("dataType",e,t);let n=[];if(e.thisLinePrevTokens.length&&(n=Ze.filter((e=>!f.includes(e.kwd.toLowerCase()))),f.includes("references")&&(n=[...et,...n])),u.endsWith(" default")){return{suggestions:Ye("function",e,t).suggestions.map((e=>{var t,n;return{...e,sortText:g.some((t=>{var n;return null===(n=e.funcInfo)||void 0===n?void 0:n.restype.includes(t.textLC)}))?(null===(t=e.funcInfo)||void 0===t?void 0:t.args.length)?"aa":"a":null!==(n=e.sortText)&&void 0!==n?n:"b"}}))}}return Se(n.map((e=>({label:e.kwd,docs:e.docs,kind:l("keyword")}))))}if(u.includes("create role")||u.includes("create user"))return h.length<=2?Se([{label:"$user_name"}]):mt(u,t,l("keyword"));if("create"===e.prevLC)return Se(Re);if(2===e.prevTokens.length||e.prevLC.endsWith("exists")&&"operator.sql"===(null===(s=e.ltoken)||void 0===s?void 0:s.type))return Se([{label:`$${r}_name`}]);if("identifier.sql"===(null==c?void 0:c.type)){const e=t.find((e=>e.name.includes(c.text)));if("function"===r&&(null==e?void 0:e.definition))return Se([{label:e.definition.slice("CREATE OR REPLACE FUNCTION ".length)}])}const v=[...h].reverse().find((e=>"keyword.sql"===e.type));if("where"===(null==v?void 0:v.textLC)){if("identifier.sql"===(null==c?void 0:c.type))return Ye("operator",e,t);const n=e.tokens.filter((e=>"identifier.sql"===e.type)),a=t.filter((e=>"column"===e.type&&n.some((t=>t.text===e.parentName))));return a.length?{suggestions:a}:Ye("column",e,t)}return{suggestions:[]}}},Ke=["en_US.UTF-8","C.UTF-8"],Qe=[{kwd:"OWNER",expects:"role",docs:"The role name of the user who will own the new database, or DEFAULT to use the default (namely, the user executing the command). To create a database owned by another role, you must be a direct or indirect member of that role, or be a superuser."},{kwd:"TEMPLATE",expects:"database",docs:"The name of the template from which to create the new database, or DEFAULT to use the default template (template1)."},{kwd:"ENCODING",expects:Je,docs:"Character set encoding to use in the new database. Specify a string constant (e.g., 'SQL_ASCII'), or an integer encoding number, or DEFAULT to use the default encoding (namely, the encoding of the template database). The character sets supported by the PostgreSQL server are described in Section 24.3.1. See below for additional restrictions."},{kwd:"STRATEGY",expects:["wal_log","file_copy"],docs:"Strategy to be used in creating the new database. If the WAL_LOG strategy is used, the database will be copied block by block and each block will be separately written to the write-ahead log. This is the most efficient strategy in cases where the template database is small, and therefore it is the default. The older FILE_COPY strategy is also available. This strategy writes a small record to the write-ahead log for each tablespace used by the target database. Each such record represents copying an entire directory to a new location at the filesystem level. While this does reduce the write-ahead log volume substantially, especially if the template database is large, it also forces the system to perform a checkpoint both before and after the creation of the new database. In some situations, this may have a noticeable negative impact on overall system performance."},{kwd:"LOCALE",expects:Ke,docs:"This is a shortcut for setting LC_COLLATE and LC_CTYPE at once."},{kwd:"LC_COLLATE",expects:Ke,docs:"Collation order (LC_COLLATE) to use in the new database. This affects the sort order applied to strings, e.g., in queries with ORDER BY, as well as the order used in indexes on text columns. The default is to use the collation order of the template database. See below for additional restrictions."},{kwd:"LC_CTYPE",expects:Ke,docs:"Character classification (LC_CTYPE) to use in the new database. This affects the categorization of characters, e.g., lower, upper and digit. The default is to use the character classification of the template database. See below for additional restrictions."},{kwd:"ICU_LOCALE",expects:Ke,docs:"Specifies the ICU locale ID if the ICU locale provider is used."},{kwd:"LOCALE_PROVIDER",expects:["icu","libc"],docs:"Specifies the provider to use for the default collation in this database. Possible values are: icu, libc. libc is the default. The available choices depend on the operating system and build options."},{kwd:"COLLATION_VERSION",expects:"number",docs:"Specifies the collation version string to store with the database. Normally, this should be omitted, which will cause the version to be computed from the actual version of the database collation as provided by the operating system. This option is intended to be used by pg_upgrade for copying the version from an existing installation."},{kwd:"TABLESPACE",expects:"schema",docs:"The name of the tablespace that will be associated with the new database, or DEFAULT to use the template database's tablespace. This tablespace will be the default tablespace used for objects created in this database. See CREATE TABLESPACE for more information."},{kwd:"ALLOW_CONNECTIONS",expects:["10","20"],docs:"If false then no one can connect to this database. The default is true, allowing connections (except as restricted by other mechanisms, such as GRANT/REVOKE CONNECT)."},{kwd:"CONNECTION LIMIT",expects:["10","20","100","200"],docs:"How many concurrent connections can be made to this database. -1 (the default) means no limit."},{kwd:"IS_TEMPLATE",expects:["TRUE","FALSE"],docs:"If true, then this database can be cloned by any user with CREATEDB privileges; if false (the default), then only superusers or the owner of the database can clone it."},{kwd:"OID",expects:"number"}],Ze=[{kwd:"NOT NULL",docs:"Constraint ensuring this column cannot be NULL. By default columns can have NULL values if no constraints are specified."},{kwd:"REFERENCES",docs:"A foreign key constraint specifies that the values in a column (or a group of columns) must match the values appearing in some row of another table. We say this maintains the referential integrity between two related tables. The referenced column/s must be unique.\nhttps://www.postgresql.org/docs/current/tutorial-fk.html\n\n"+ke("product_id INTEGER REFERENCES products (id) ")},{kwd:"PRIMARY KEY",docs:"A primary key constraint indicates that a column, or group of columns, can be used as a unique identifier for rows in the table. This requires that the values be both unique and not null."},{kwd:"DEFAULT",docs:"A column can be assigned a default value. When a new row is created and no values are specified for some of the columns, those columns will be filled with their respective default values. If no default value is declared explicitly, the default value is the null value. \n"+ke("created_at TIMESTAMP DEFAULT now()")},{kwd:"CHECK",docs:"Specify that the value in a certain column must satisfy a Boolean (truth-value) expression. For instance, to require positive product prices, you could use: \n"+ke("CHECK (price > 0)")},{kwd:"UNIQUE",docs:"The UNIQUE constraint specifies that a group of one or more columns of a table can contain only unique values. For the purpose of a unique constraint, null values are not considered equal, unless NULLS NOT DISTINCT is specified.Adding a unique constraint will automatically create a unique btree index on the column or group of columns used in the constraint."}],et=[{kwd:"ON DELETE CASCADE",docs:"When a referenced row is deleted, row(s) referencing it should be automatically deleted as well"},{kwd:"ON DELETE SET NULL",docs:"When a referenced row is deleted referencing column(s) in the referencing row(s) to be set to NULL"},{kwd:"ON DELETE SET DEFAULT",docs:"When a referenced row is deleted referencing column(s) in the referencing row(s) to be set to their DEFAULT values"},{kwd:"ON UPDATE CASCADE",docs:"When a referenced row is updated referencing column(s) in the referencing row(s) should be automatically updated as well"},{kwd:"ON UPDATE SET NULL",docs:"When a referenced row is updated referencing column(s) in the referencing row(s) should be automatically set to NULL"},{kwd:"ON UPDATE SET DEFAULT",docs:"When a referenced row is updated referencing column(s) in the referencing row(s) should be automatically set to their DEFAULT values"}];var tt,nt,at,lt;const ot={match:e=>e.tokens.some((e=>"alter"===e.textLC)),result:async(e,t,n,a,l)=>{var o,i,s,r;const{prevLC:c,prevTokens:d}=e,m=d.at(-1),p=d.at(-2),u=(d.at(-3),null!==(i=null===(o=d[d.findIndex((e=>"alter"===e.textLC))+1])||void 0===o?void 0:o.textLC)&&void 0!==i?i:"");let h=null!==(s=Ve(u))&&void 0!==s?s:"";const g=e.tokens.at(-1),f=e.tokens.filter((e=>"identifier.sql"===e.type)).map((e=>e.text));if(c.includes("add constraint")&&c.includes("("))return Ye("column",e,t);if(("alter"===(null==p?void 0:p.textLC)||"drop"===(null==p?void 0:p.textLC))&&"constraint"===(null==m?void 0:m.textLC)||e.prevLC.includes(" constraint "))return{suggestions:t.filter((e=>{var t;return"constraint"===e.type&&f.includes(null===(t=e.constraintInfo)||void 0===t?void 0:t.escaped_table_name)}))};if(c.endsWith("rename to"))return Se([{label:"$new_name"}]);const E=e.prevTokens.findIndex(((e,t,n)=>{var a;return"column"===e.textLC&&"add"===(null===(a=n[t-1])||void 0===a?void 0:a.textLC)}));if(E>-1){const n=e.prevTokens.slice(E+1);return n.length?1===n.length?Ye("dataType",e,t):Se(Ze.filter((t=>!e.prevLC.includes(t.kwd.toLowerCase()))).map((({kwd:e,docs:t})=>({label:e,docs:t})))):Se(Le.concat([{label:"$new_column_name",docs:""}]))}if(c.includes("alter table")&&"identifier.sql"===(null==m?void 0:m.type)&&"table"===(null==p?void 0:p.textLC))return Se(it);if(c.endsWith("set storage"))return Se(["PLAIN","EXTERNAL","EXTENDED","MAIN"].map((e=>({label:e}))));if(c.endsWith(" set")||c.endsWith(" reset"))return{suggestions:n.map((e=>({...e,insertText:`${e.insertText} TO $1`})))};const v=["role","user"];if(v.some((e=>c.endsWith(e))))return{suggestions:t.filter((e=>"role"===e.type))};if(v.some((e=>c.includes("alter "+e))))return mt(c,t,l("keyword"));if(c.endsWith("alter database"))return Se(t.filter((e=>"database"===e.type)).flatMap((e=>rt.map((t=>({label:`${e.label} ${t}`}))))));if(c.endsWith("data type"))return{suggestions:t.filter((e=>"dataType"===e.type))};if(c.endsWith("owner to")){const e=t.filter((e=>v.includes(e.type)));return Se(e.map((e=>({label:e.name}))))}if(c.endsWith("column")){return{suggestions:t.filter((e=>"column"===e.type&&f.includes(e.escapedParentName)))}}if(c.includes("alter column"))return Se(st.map((({kwd:e,docs:t})=>({label:e,insertText:`\n${e}`,docs:t,kind:l("keyword")}))));if(c.includes("drop column"))return Se(["CASCADE","RESTRICT"].map((e=>({label:e}))));if(c.includes("alter system"))return c.includes("set")&&"set"!==(null==m?void 0:m.textLC)?d.some((e=>"to"===e.textLC))?Se(["DEFAULT"].map((e=>({label:e})))):Se(["TO"].map((e=>({label:e})))):Se(["SET","RESET","RESET ALL"].map((e=>({label:e}))));if(c.endsWith("alter"))return Se(Ce.flatMap((e=>["IF EXISTS",""].map((t=>({label:`${e}${t}`}))))));if(2===e.tokens.length||e.textLC.endsWith("exists")&&"operator.sql"===(null===(r=e.tokens.at(-1))||void 0===r?void 0:r.type)){if(Ce.some((e=>h.includes(e.toLowerCase())))){t.filter((e=>e.type===h&&e.schema));return{suggestions:Ye(h,e,t).suggestions.map((e=>({...e,insertText:e.insertText||e.label,..."function"===e.type&&e.args&&{label:`${e.escapedIdentifier}(${e.args.map((e=>e.data_type)).join(", ")}) `,insertText:`${e.escapedIdentifier}(${e.args.map((e=>e.data_type)).join(", ")}) `}})))}}}else if(e.prevText.endsWith(" ")&&("identifier.sql"===(null==g?void 0:g.type)||"delimiter.parenthesis.sql"===(null==g?void 0:g.type)||"identifier.quote.sql"===(null==g?void 0:g.type))){if(e.prevText.includes("(")&&e.prevLC.includes("constraint")){const e=t.filter((e=>"column"===e.type&&f.includes(e.parentName)));return{suggestions:e.length?e:t.filter((e=>"column"===e.type||"operator"===e.type))}}const n=Se([]);return"function"!==h&&"table"!==h||(n.suggestions=n.suggestions.concat(Se([`RENAME TO $new_${h}_name`,"OWNER TO ","SET SCHEMA $1","SET search_path = $1","DEPENDS ON EXTENSION "].map((e=>({label:e,kind:l("keyword")})))).suggestions)),"table"===h&&(n.suggestions=n.suggestions.concat(Se(it.map((e=>({...e,kind:l("keyword")})))).suggestions)),n}return Ye(h,e,t)}},it=[{label:"ADD COLUMN",docs:"This form adds a new column to the table, using the same syntax as CREATE TABLE. If IF NOT EXISTS is specified and a column already exists with this name, no error is thrown."},{label:"DROP COLUMN",docs:"This form drops a column from a table. Indexes and table constraints involving the column will be automatically dropped as well. Multivariate statistics referencing the dropped column will also be removed if the removal of the column would cause the statistics to contain data for only a single column. You will need to say CASCADE if anything outside the table depends on the column, for example, foreign key references or views. If IF EXISTS is specified and the column does not exist, no error is thrown. In this case a notice is issued instead."},{label:"ALTER COLUMN",docs:"This form alters a table column"},{label:"RENAME COLUMN $1 TO $2",docs:"The RENAME forms change the name of a table (or an index, sequence, view, materialized view, or foreign table), the name of an individual column in a table, or the name of a constraint of the table. When renaming a constraint that has an underlying index, the index is renamed as well. There is no effect on the stored data."},{label:"RENAME TO",docs:"The RENAME forms change the name of a table (or an index, sequence, view, materialized view, or foreign table), the name of an individual column in a table, or the name of a constraint of the table. When renaming a constraint that has an underlying index, the index is renamed as well. There is no effect on the stored data."},{label:"ADD CONSTRAINT ${1:constraint_name} ${2|UNIQUE,CHECK,PRIMARY KEY,FOREIGN KEY|} ($0)",docs:"This form adds a new constraint to a table using the same constraint syntax as CREATE TABLE, plus the option NOT VALID, which is currently only allowed for foreign key and CHECK constraints.\n\nNormally, this form will cause a scan of the table to verify that all existing rows in the table satisfy the new constraint. But if the NOT VALID option is used, this potentially-lengthy scan is skipped. The constraint will still be enforced against subsequent inserts or updates (that is, they'll fail unless there is a matching row in the referenced table, in the case of foreign keys, or they'll fail unless the new row matches the specified check condition). But the database will not assume that the constraint holds for all rows in the table, until it is validated by using the VALIDATE CONSTRAINT option. See Notes below for more information about using the NOT VALID option.\n\nAlthough most forms of ADD table_constraint require an ACCESS EXCLUSIVE lock, ADD FOREIGN KEY requires only a SHARE ROW EXCLUSIVE lock. Note that ADD FOREIGN KEY also acquires a SHARE ROW EXCLUSIVE lock on the referenced table, in addition to the lock on the table on which the constraint is declared.\n\nAdditional restrictions apply when unique or primary key constraints are added to partitioned tables; see CREATE TABLE. Also, foreign key constraints on partitioned tables may not be declared NOT VALID at present."},{label:"ALTER CONSTRAINT ${1:table_constraint} ${2|DEFERRABLE,NOT DEFERRABLE|} ${3|INITIALLY DEFERRED,INITIALLY IMMEDIATE|}",docs:"This form alters the attributes of a constraint that was previously created. Currently only foreign key constraints may be altered."},{label:"VALIDATE CONSTRAINT ${1:table_constraint}",docs:"This form validates a foreign key or check constraint that was previously created as NOT VALID, by scanning the table to ensure there are no rows for which the constraint is not satisfied. Nothing happens if the constraint is already marked valid. (See Notes below for an explanation of the usefulness of this command.)\n\nThis command acquires a SHARE UPDATE EXCLUSIVE lock.\n    "},{label:"DROP CONSTRAINT",docs:"This form drops the specified constraint on a table, along with any index underlying the constraint. If IF EXISTS is specified and the constraint does not exist, no error is thrown. In this case a notice is issued instead."},...["DISABLE TRIGGER ${1|$trigger_name,ALL,USER|}","ENABLE TRIGGER ${1|$trigger_name,ALL,USER|}","ENABLE REPLICA TRIGGER trigger_name","ENABLE ALWAYS TRIGGER trigger_name"].map((e=>({label:e,docs:"These forms configure the firing of trigger(s) belonging to the table. A disabled trigger is still known to the system, but is not executed when its triggering event occurs. For a deferred trigger, the enable status is checked when the event occurs, not when the trigger function is actually executed. One can disable or enable a single trigger specified by name, or all triggers on the table, or only user triggers (this option excludes internally generated constraint triggers such as those that are used to implement foreign key constraints or deferrable uniqueness and exclusion constraints). Disabling or enabling internally generated constraint triggers requires superuser privileges; it should be done with caution since of course the integrity of the constraint cannot be guaranteed if the triggers are not executed.\n\nThe trigger firing mechanism is also affected by the configuration variable session_replication_role. Simply enabled triggers (the default) will fire when the replication role is “origin” (the default) or “local”. Triggers configured as ENABLE REPLICA will only fire if the session is in “replica” mode, and triggers configured as ENABLE ALWAYS will fire regardless of the current replication role.\n\nThe effect of this mechanism is that in the default configuration, triggers do not fire on replicas. This is useful because if a trigger is used on the origin to propagate data between tables, then the replication system will also replicate the propagated data, and the trigger should not fire a second time on the replica, because that would lead to duplication. However, if a trigger is used for another purpose such as creating external alerts, then it might be appropriate to set it to ENABLE ALWAYS so that it is also fired on replicas.\n\nThis command acquires a SHARE ROW EXCLUSIVE lock."}))),...["DISABLE RULE $rewrite_rule_name;","ENABLE RULE $rewrite_rule_name;","ENABLE REPLICA RULE ${1:rewrite_rule_name}","ENABLE ALWAYS RULE ${1:rewrite_rule_name}"].map((e=>({label:e,docs:"These forms configure the firing of rewrite rules belonging to the table. A disabled rule is still known to the system, but is not applied during query rewriting. The semantics are as for disabled/enabled triggers. This configuration is ignored for ON SELECT rules, which are always applied in order to keep views working even if the current session is in a non-default replication role.\n\nThe rule firing mechanism is also affected by the configuration variable session_replication_role, analogous to triggers as described above."}))),...["ENABLE ROW LEVEL SECURITY;","DISABLE ROW LEVEL SECURITY;","FORCE ROW LEVEL SECURITY;","NO FORCE ROW LEVEL SECURITY;"].map((e=>({label:e,docs:"These forms control the application of row security policies belonging to the table. If enabled and no policies exist for the table, then a default-deny policy is applied. Note that policies can exist for a table even if row-level security is disabled. In this case, the policies will not be applied and the policies will be ignored. See also CREATE POLICY."}))),{label:"CLUSTER ON index_name",docs:"This form selects the default index for future CLUSTER operations. It does not actually re-cluster the table.\n\nChanging cluster options acquires a SHARE UPDATE EXCLUSIVE lock."},{label:"SET WITHOUT CLUSTER",docs:"This form removes the most recently used CLUSTER index specification from the table. This affects future cluster operations that don't specify an index.\n\nChanging cluster options acquires a SHARE UPDATE EXCLUSIVE lock."},{label:"SET WITHOUT OIDS",docs:"Backward-compatible syntax for removing the oid system column. As oid system columns cannot be added anymore, this never has an effect."},{label:"SET ACCESS METHOD ${1:new_access_method}",docs:"This form changes the access method of the table by rewriting it"},{label:"SET TABLESPACE ${1:new_tablespace}",docs:"This form changes the table's tablespace to the specified tablespace and moves the data file(s) associated with the table to the new tablespace. Indexes on the table, if any, are not moved; but they can be moved separately with additional SET TABLESPACE commands. When applied to a partitioned table, nothing is moved, but any partitions created afterwards with CREATE TABLE PARTITION OF will use that tablespace, unless overridden by a TABLESPACE clause.\n\nAll tables in the current database in a tablespace can be moved by using the ALL IN TABLESPACE form, which will lock all tables to be moved first and then move each one. This form also supports OWNED BY, which will only move tables owned by the roles specified. If the NOWAIT option is specified then the command will fail if it is unable to acquire all of the locks required immediately. Note that system catalogs are not moved by this command; use ALTER DATABASE or explicit ALTER TABLE invocations instead if desired. The information_schema relations are not considered part of the system catalogs and will be moved. See also CREATE TABLESPACE."},{label:"SET ${1|LOGGED,UNLOGGED|}",docs:"This form changes the table from unlogged to logged or vice-versa (see UNLOGGED). It cannot be applied to a temporary table.\n\nThis also changes the persistence of any sequences linked to the table (for identity or serial columns). However, it is also possible to change the persistence of such sequences separately."},{label:"SET ( storage_parameter [= value] [, ... ] )",docs:"This form changes one or more storage parameters for the table. See Storage Parameters in the CREATE TABLE documentation for details on the available parameters. Note that the table contents will not be modified immediately by this command; depending on the parameter you might need to rewrite the table to get the desired effects. That can be done with VACUUM FULL, CLUSTER or one of the forms of ALTER TABLE that forces a table rewrite. For planner related parameters, changes will take effect from the next time the table is locked so currently executing queries will not be affected.\n\nSHARE UPDATE EXCLUSIVE lock will be taken for fillfactor, toast and autovacuum storage parameters, as well as the planner parameter parallel_workers."},{label:"RESET ( storage_parameter [, ... ] )",docs:"This form resets one or more storage parameters to their defaults. As with SET, a table rewrite might be needed to update the table entirely."},{label:"INHERIT $parent_table",docs:"This form adds the target table as a new child of the specified parent table. Subsequently, queries against the parent will include records of the target table. To be added as a child, the target table must already contain all the same columns as the parent (it could have additional columns, too). The columns must have matching data types, and if they have NOT NULL constraints in the parent then they must also have NOT NULL constraints in the child.\n\nThere must also be matching child-table constraints for all CHECK constraints of the parent, except those marked non-inheritable (that is, created with ALTER TABLE ... ADD CONSTRAINT ... NO INHERIT) in the parent, which are ignored; all child-table constraints matched must not be marked non-inheritable. Currently UNIQUE, PRIMARY KEY, and FOREIGN KEY constraints are not considered, but this might change in the future."},{label:"NO INHERIT $parent_table",docs:"This form removes the target table from the list of children of the specified parent table. Queries against the parent table will no longer include records drawn from the target table. "},{label:"OF $type_name",docs:"This form links the table to a composite type as though CREATE TABLE OF had formed it. The table's list of column names and types must precisely match that of the composite type. The table must not inherit from any other table. These restrictions ensure that CREATE TABLE OF would permit an equivalent table definition."},{label:"NOT OF",docs:"This form dissociates a typed table from its type."},{label:"OWNER TO ${1|$new_owner,CURRENT_ROLE,CURRENT_USER,SESSION_USER|}",docs:""},{label:"REPLICA IDENTITY ${1|DEFAULT,USING INDEX $index_name,FULL,NOTHING|}",docs:""}],st=[{kwd:"SET DATA TYPE $data_type",docs:"This form changes the type of a column of a table. \n  \nIndexes and simple table constraints involving the column will be automatically converted to use the new column type by reparsing the originally supplied expression. The optional COLLATE clause specifies a collation for the new column; if omitted, the collation is the default for the new column type. The optional USING clause specifies how to compute the new column value from the old; if omitted, the default conversion is the same as an assignment cast from old data type to new. A USING clause must be provided if there is no implicit or assignment cast from old to new type.\n\nWhen this form is used, the column's statistics are removed, so running ANALYZE on the table afterwards is recommended."},{kwd:"SET DEFAULT $expression",docs:null===(tt=Ze.find((e=>"DEFAULT"===e.kwd)))||void 0===tt?void 0:tt.docs},{kwd:"DROP DEFAULT",docs:null===(nt=Ze.find((e=>"DEFAULT"===e.kwd)))||void 0===nt?void 0:nt.docs},{kwd:"SET NOT NULL",docs:null===(at=Ze.find((e=>"NOT NULL"===e.kwd)))||void 0===at?void 0:at.docs},{kwd:"DROP NOT NULL",docs:null===(lt=Ze.find((e=>"NOT NULL"===e.kwd)))||void 0===lt?void 0:lt.docs},{kwd:"DROP EXPRESSION $1",docs:"This form turns a stored generated column into a normal base column. Existing data in the columns is retained, but future changes will no longer apply the generation expression.\n\nIf DROP EXPRESSION IF EXISTS is specified and the column is not a stored generated column, no error is thrown. In this case a notice is issued instead.\n"},...["ADD GENERATED ${1|ALWAYS,BY DEFAULT|} AS IDENTITY ( sequence_options )","DROP IDENTITY [ IF EXISTS ]"].map((e=>({kwd:e,docs:"These forms change whether a column is an identity column or change the generation attribute of an existing identity column. See CREATE TABLE for details. Like SET DEFAULT, these forms only affect the behavior of subsequent INSERT and UPDATE commands; they do not cause rows already in the table to change.\n\nIf DROP IDENTITY IF EXISTS is specified and the column is not an identity column, no error is thrown. In this case a notice is issued instead."}))),{kwd:"SET STATISTICS $integer",docs:"This form sets the per-column statistics-gathering target for subsequent ANALYZE operations. The target can be set in the range 0 to 10000; alternatively, set it to -1 to revert to using the system default statistics target (default_statistics_target). For more information on the use of statistics by the PostgreSQL query planner, refer to Section 14.2.\n\nSET STATISTICS acquires a SHARE UPDATE EXCLUSIVE lock."},...["SET ( attribute_option = value [, ... ] )","RESET ( attribute_option [, ... ] )"].map((e=>({kwd:e,docs:"This form sets or resets per-attribute options. Currently, the only defined per-attribute options are n_distinct and n_distinct_inherited, which override the number-of-distinct-values estimates made by subsequent ANALYZE operations. n_distinct affects the statistics for the table itself, while n_distinct_inherited affects the statistics gathered for the table plus its inheritance children. When set to a positive value, ANALYZE will assume that the column contains exactly the specified number of distinct nonnull values. When set to a negative value, which must be greater than or equal to -1, ANALYZE will assume that the number of distinct nonnull values in the column is linear in the size of the table; the exact count is to be computed by multiplying the estimated table size by the absolute value of the given number. For example, a value of -1 implies that all values in the column are distinct, while a value of -0.5 implies that each value appears twice on the average. This can be useful when the size of the table changes over time, since the multiplication by the number of rows in the table is not performed until query planning time. Specify a value of 0 to revert to estimating the number of distinct values normally. For more information on the use of statistics by the PostgreSQL query planner, refer to Section 14.2.\n\nChanging per-attribute options acquires a SHARE UPDATE EXCLUSIVE lock."}))),{kwd:"SET STORAGE ${1|PLAIN,EXTERNAL,EXTENDED,MAIN|}",docs:"This form sets the storage mode for a column. This controls whether this column is held inline or in a secondary TOAST table, and whether the data should be compressed or not. PLAIN must be used for fixed-length values such as integer and is inline, uncompressed. MAIN is for inline, compressible data. EXTERNAL is for external, uncompressed data, and EXTENDED is for external, compressed data. EXTENDED is the default for most data types that support non-PLAIN storage. Use of EXTERNAL will make substring operations on very large text and bytea values run faster, at the penalty of increased storage space. Note that SET STORAGE doesn't itself change anything in the table, it just sets the strategy to be pursued during future table updates. See Section 73.2 for more information."},{kwd:"SET COMPRESSION $compression_method",docs:"This form sets the compression method for a column, determining how values inserted in future will be compressed (if the storage mode permits compression at all). This does not cause the table to be rewritten, so existing data may still be compressed with other compression methods. If the table is restored with pg_restore, then all values are rewritten with the configured compression method. However, when data is inserted from another relation (for example, by INSERT ... SELECT), values from the source table are not necessarily detoasted, so any previously compressed data may retain its existing compression method, rather than being recompressed with the compression method of the target column. The supported compression methods are pglz and lz4. (lz4 is available only if --with-lz4 was used when building PostgreSQL.) In addition, compression_method can be default, which selects the default behavior of consulting the default_toast_compression setting at the time of data insertion to determine the method to use."}],rt=["RENAME TO $new_name","OWNER TO ","SET TABLESPACE new_tablespace","REFRESH COLLATION VERSION","SET","RESET configuration_parameter","RESET ALL"],ct=[{params:["name"],docs:"The name of the new role."},{params:["SUPERUSER","NOSUPERUSER"],docs:"These clauses determine whether the new role is a “superuser”, who can override all access restrictions within the database. Superuser status is dangerous and should be used only when really needed. You must yourself be a superuser to create a new superuser. If not specified, NOSUPERUSER is the default."},{params:["LOGIN","NOLOGIN"],docs:"These clauses determine whether a role is allowed to log in; that is, whether the role can be given as the initial session authorization name during client connection. A role having the LOGIN attribute can be thought of as a user. Roles without this attribute are useful for managing database privileges, but are not users in the usual sense of the word. If not specified, NOLOGIN is the default, except when CREATE ROLE is invoked through its alternative spelling CREATE USER."},{params:["ENCRYPTED PASSWORD 'password'"],docs:"Sets the role's password. (A password is only of use for roles having the LOGIN attribute, but you can nonetheless define one for roles without it.) If you do not plan to use password authentication you can omit this option. If no password is specified, the password will be set to null and password authentication will always fail for that user. A null password can optionally be written explicitly as PASSWORD NULL.\n\nNote\n\nSpecifying an empty string will also set the password to null, but that was not the case before PostgreSQL version 10. In earlier versions, an empty string could be used, or not, depending on the authentication method and the exact version, and libpq would refuse to use it in any case. To avoid the ambiguity, specifying an empty string should be avoided.\n\nThe password is always stored encrypted in the system catalogs. The ENCRYPTED keyword has no effect, but is accepted for backwards compatibility. The method of encryption is determined by the configuration parameter password_encryption. If the presented password string is already in MD5-encrypted or SCRAM-encrypted format, then it is stored as-is regardless of password_encryption (since the system cannot decrypt the specified encrypted password string, to encrypt it in a different format). This allows reloading of encrypted passwords during dump/restore."},{params:["CREATEDB","NOCREATEDB"],docs:"These clauses define a role's ability to create databases. If CREATEDB is specified, the role being defined will be allowed to create new databases. Specifying NOCREATEDB will deny a role the ability to create databases. If not specified, NOCREATEDB is the default."},{params:["CREATEROLE","NOCREATEROLE"],docs:"These clauses determine whether a role will be permitted to create new roles (that is, execute CREATE ROLE). A role with CREATEROLE privilege can also alter and drop other roles. If not specified, NOCREATEROLE is the default."},{params:["INHERIT","NOINHERIT"],docs:"These clauses determine whether a role “inherits” the privileges of roles it is a member of. A role with the INHERIT attribute can automatically use whatever database privileges have been granted to all roles it is directly or indirectly a member of. Without INHERIT, membership in another role only grants the ability to SET ROLE to that other role; the privileges of the other role are only available after having done so. If not specified, INHERIT is the default."},{params:["REPLICATION","NOREPLICATION"],docs:"These clauses determine whether a role is a replication role. A role must have this attribute (or be a superuser) in order to be able to connect to the server in replication mode (physical or logical replication) and in order to be able to create or drop replication slots. A role having the REPLICATION attribute is a very highly privileged role, and should only be used on roles actually used for replication. If not specified, NOREPLICATION is the default. You must be a superuser to create a new role having the REPLICATION attribute."},{params:["BYPASSRLS","NOBYPASSRLS"],docs:"These clauses determine whether a role bypasses every row-level security (RLS) policy. NOBYPASSRLS is the default. You must be a superuser to create a new role having the BYPASSRLS attribute.\n\nNote that pg_dump will set row_security to OFF by default, to ensure all contents of a table are dumped out. If the user running pg_dump does not have appropriate permissions, an error will be returned. However, superusers and the owner of the table being dumped always bypass RLS."},{params:["CONNECTION LIMIT $connlimit"],docs:"If role can log in, this specifies how many concurrent connections the role can make. -1 (the default) means no limit. Note that only normal connections are counted towards this limit. Neither prepared transactions nor background worker connections are counted towards this limit."},{params:["VALID UNTIL 'timestamp'"],docs:"The VALID UNTIL clause sets a date and time after which the role's password is no longer valid. If this clause is omitted the password will be valid for all time."},{params:["IN ROLE"],docs:"The IN ROLE clause lists one or more existing roles to which the new role will be immediately added as a new member. (Note that there is no option to add the new role as an administrator; use a separate GRANT command to do that.)"},{params:["IN GROUP"],docs:"IN GROUP is an obsolete spelling of IN ROLE."},{params:["ROLE"],docs:"The ROLE clause lists one or more existing roles which are automatically added as members of the new role. (This in effect makes the new role a “group”.)"},{params:["ADMIN"],docs:"The ADMIN clause is like ROLE, but the named roles are added to the new role WITH ADMIN OPTION, giving them the right to grant membership in this role to others."},{params:["USER"],docs:"The USER clause is an obsolete spelling of the ROLE clause."},{params:["SYSID uid"],docs:"The SYSID clause is ignored, but is accepted for backwards compatibility."}],dt=[...ct.filter((e=>e.params.some((e=>"CREATEDB"===e||"VALID UNTIL 'timestamp'"===e||"SYSID uid"===e||"ENCRYPTED PASSWORD 'password'"===e||"IN GROUP"===e)))),{params:["CREATEUSER","NOCREATEUSER"],docs:"These clauses determine whether a user will be permitted to create new users himself. CREATEUSER will also make the user a superuser, who can override all access restrictions. If not specified, NOCREATEUSER is the default."}],mt=(e,t,n)=>{const a=e.split(" ");if(e.endsWith("role")||e.endsWith("admin")||e.endsWith("group"))return{suggestions:t.filter((e=>"role"===e.type))};let l=(e.includes("create user")||e.includes("alter user")?dt:ct).filter((e=>!a.some((t=>e.params.includes(t.toUpperCase()))))).flatMap((e=>e.params.map((t=>({label:a.includes("with")?`${t} `:`WITH ${t} `,docs:e.docs})))));return Se(l.map(((e,t)=>({...e,kind:n,sortText:t.toString().padStart(2,"0")}))))},pt=[{kwd:"FORMAT",expects:["TEXT","CSV","BINARY"],docs:"Selects the data format to be read or written: text, csv (Comma Separated Values), or binary. The default is text."},{kwd:"FREEZE",expects:["true","false"],docs:"Requests copying the data with rows already frozen, just as they would be after running the VACUUM FREEZE command. This is intended as a performance option for initial data loading. Rows will be frozen only if the table being loaded has been created or truncated in the current subtransaction, there are no cursors open and there are no older snapshots held by this transaction. It is currently not possible to perform a COPY FREEZE on a partitioned table."},{kwd:"DELIMITER",expects:["E'\\t'","','"],docs:"Specifies the character that separates columns within each row (line) of the file. The default is a tab character in text format, a comma in CSV format. This must be a single one-byte character. This option is not allowed when using binary format."},{kwd:"NULL",expects:[""],docs:"Specifies the string that represents a null value. The default is N (backslash-N) in text format, and an unquoted empty string in CSV format. You might prefer an empty string even in text format for cases where you don't want to distinguish nulls from empty strings. This option is not allowed when using binary format."},{kwd:"HEADER",expects:["TRUE","FALSE","MATCH"],docs:"Specifies that the file contains a header line with the names of each column in the file. On output, the first line contains the column names from the table. On input, the first line is discarded when this option is set to true (or equivalent Boolean value). If this option is set to MATCH, the number and names of the columns in the header line must match the actual column names of the table, in order; otherwise an error is raised. This option is not allowed when using binary format. The MATCH option is only valid for COPY FROM commands."},{kwd:"QUOTE",expects:['"',"'"],docs:"Specifies the quoting character to be used when a data value is quoted. The default is double-quote. This must be a single one-byte character. This option is allowed only when using CSV format."},{kwd:"ESCAPE",dependsOn:"CSV",expects:['"',"'"],docs:"Specifies the character that should appear before a data character that matches the QUOTE value. The default is the same as the QUOTE value (so that the quoting character is doubled if it appears in the data). This must be a single one-byte character. This option is allowed only when using CSV format."},{kwd:"FORCE_QUOTE",expects:["*"],dependsOn:"CSV",docs:"Forces quoting to be used for all non-NULL values in each specified column. NULL output is never quoted. If * is specified, non-NULL values will be quoted in all columns. This option is allowed only in COPY TO, and only when using CSV format."},{kwd:"FORCE_NOT_NULL",expects:["*"],dependsOn:"CSV",docs:"Do not match the specified columns' values against the null string. In the default case where the null string is empty, this means that empty values will be read as zero-length strings rather than nulls, even when they are not quoted. This option is allowed only in COPY FROM, and only when using CSV format."},{kwd:"FORCE_NULL",expects:["*"],dependsOn:"CSV",docs:"Match the specified columns' values against the null string, even if it has been quoted, and if a match is found set the value to NULL. In the default case where the null string is empty, this converts a quoted empty string into NULL. This option is allowed only in COPY FROM, and only when using CSV format."},{kwd:"ENCODING",expects:Je,docs:"Specifies that the file is encoded in the encoding_name. If this option is omitted, the current client encoding is used. See the Notes below for more details."},{kwd:"WHERE",docs:"where condition is any expression that evaluates to a result of type boolean. Any row that does not satisfy this condition will not be inserted to the table. A row satisfies the condition if it returns true when the actual row values are substituted for any variable references.     Currently, subqueries are not allowed in WHERE expressions, and the evaluation does not see any changes made by the COPY itself (this matters when the expression contains calls to VOLATILE functions)."}],ut={match:e=>e.prevLC.startsWith("copy"),result:async(e,t,n,a,l)=>{var o;const{prevLC:i,currToken:s,ltoken:r,prevTokens:c,prevText:d}=e;d.split(" ");if(c.some((e=>"string.sql"===e.type))||d.endsWith("'")){if(!d.includes("("))return Se([{label:"( $0 )"}]);const{getSuggestion:n}=Ge(pt,e,l,t);return n(",",["(",")"])}if(i.endsWith("(")||i.endsWith(",")){const e=(null===(o=d.split("(")[1])||void 0===o?void 0:o.split(")")[0])||"";return{suggestions:t.filter((t=>"column"===t.type&&!e.includes(t.name)&&d.includes(t.escapedParentName))).map((e=>({...e,insertText:e.label+", "})))}}if("copy"===i)return{suggestions:t.filter((e=>"table"===e.type)).map((e=>({...e,sortText:"public"===e.schema?"a":"b"})))};if(!c.some((e=>"from"===e.textLC)))return Se(["FROM ",...d.includes("(")?[]:["( $1 )"]].map((e=>({label:e}))));if(e.prevTokens.length>2){if(!a)return{suggestions:[]};const e=await ht(a,null==s?void 0:s.text);return Se(e&&"label"in e?[{label:e.label,docs:e.hint,insertText:"",kind:l("folder")}]:e.map((e=>{var t;return{label:e.path,insertText:e.insertText,docs:e.documentation,commitCharacters:e.commitCharacters,kind:!1===(null===(t=e.info)||void 0===t?void 0:t.isdir)?l("file"):l("folder")}})))}return{suggestions:[]}}},ht=async(e,t="")=>{var n;const a=t.includes("'")||t.startsWith("/");let l=a?t:"/";if(l.startsWith("'")&&(l=l.slice(1)),l.endsWith("'")&&(l=l.slice(0,-1)),l.length>1&&l.endsWith("/")){const e=l.slice(1).split("/");e.length>2&&(null===(n=e.at(-1))||void 0===n?void 0:n.length)&&(l=e.slice(0,-1).join("/"))}let o,i=[];try{try{i=await e("set statement_timeout to 200; SELECT pg_ls_dir(${baseDir}) as path",{baseDir:l},{returnType:"rows"})}catch(e){i=[{path:"",insertText:"",documentation:""}]}i=await Promise.all(i.filter((e=>!["swapfile.sys","pagefile.sys","DumpStack.log.tmp"].includes(e.path)&&!e.path.endsWith(".sys"))).map((async t=>{let n={...t,insertText:a?t.path:`'${l}${t.path}'`};try{const a=`${l}${t.path}`,o=await e("set statement_timeout to 200; SELECT *, pg_size_pretty(size::bigint) as size_pretty from pg_stat_file(${baseDir})",{baseDir:a},{returnType:"row"});let i=o.isdir;const s=t.path.split("."),r=s.at(-1);let c="";if(!i&&s.length>1&&r.length<4&&"csv"===(null==r?void 0:r.toLowerCase())){const n="                 /* prostgles internal query that should be excluded from  */                 DROP TABLE IF EXISTS prostgles.temp_dir_suggestions;                  CREATE table prostgles.temp_dir_suggestions(val text);                  COPY prostgles.temp_dir_suggestions (val) FROM PROGRAM ${command};                  SELECT * FROM prostgles.temp_dir_suggestions;                ",a=await e(n,{command:`head -n 1 ${l}${t.path}`},{returnType:"row"});(null==a?void 0:a.val)&&(c=null==a?void 0:a.val)}n.info={...o,isdir:i,firstRow:c,size:o.size_pretty,access:new Date(o.access),change:new Date(o.change),creation:new Date(o.creation),modification:new Date(o.modification)}}catch(e){console.warn(e)}return n}))),await e("set statement_timeout to DEFAULT")}catch(t){return await e("set statement_timeout to DEFAULT"),o=t instanceof Error?t.message:U(t)?t.err_msg:JSON.stringify(t),{label:o}}return i.length?(i=i.map((e=>{var t,n,a,l,o,i;let s="";return e.info&&(s+=`  Type: \`${(null===(t=e.info)||void 0===t?void 0:t.isdir)?"Folder":"File"}\`    `,s+=`  \nSize: \`${null===(n=e.info)||void 0===n?void 0:n.size_pretty}\`    `,s+=`  \nModified: \`${null===(a=e.info)||void 0===a?void 0:a.modification}\`    `),(null===(l=e.info)||void 0===l?void 0:l.firstRow)&&(s+="  \n\n**Headers:**  \n\n"+(null===(o=e.info)||void 0===o?void 0:o.firstRow.split(",").map((e=>`${e}   \`TEXT\``)).join(",    \n"))),{...e,commitCharacters:(null===(i=e.info)||void 0===i?void 0:i.isdir)?["/"]:void 0,documentation:s}})),i):{label:"Directory is empty"}},gt={match:e=>e.prevLC.endsWith("extension"),result:async(e,t,n)=>{var a;const{prevLC:l}=e;null===(a=e.tokens[1])||void 0===a||a.textLC,e.tokens.at(-1),e.tokens.filter((e=>"identifier.sql"===e.type)).map((e=>e.text));return{suggestions:t.filter((e=>"extension"===e.type))}}},ft=JSON.parse('[{"cmd":"\\\\d","opts":"[S+]","desc":"list tables, views, and sequences","query":"\\nSELECT n.nspname as \\"Schema\\",\\n  c.relname as \\"Name\\",\\n  CASE c.relkind WHEN \'r\' THEN \'table\' WHEN \'v\' THEN \'view\' WHEN \'m\' THEN \'materialized view\' WHEN \'i\' THEN \'index\' WHEN \'S\' THEN \'sequence\' WHEN \'s\' THEN \'special\' WHEN \'t\' THEN \'TOAST table\' WHEN \'f\' THEN \'foreign table\' WHEN \'p\' THEN \'partitioned table\' WHEN \'I\' THEN \'partitioned index\' END as \\"Type\\",\\n  pg_catalog.pg_get_userbyid(c.relowner) as \\"Owner\\"\\nFROM pg_catalog.pg_class c\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace\\n     LEFT JOIN pg_catalog.pg_am am ON am.oid = c.relam\\nWHERE c.relkind IN (\'r\',\'p\',\'v\',\'m\',\'S\',\'f\',\'\')\\n      AND n.nspname <> \'pg_catalog\'\\n      AND n.nspname !~ \'^pg_toast\'\\n      AND n.nspname <> \'information_schema\'\\n  AND pg_catalog.pg_table_is_visible(c.oid)\\nORDER BY 1,2;\\n"},{"cmd":"\\\\dS","opts":"[S+]","desc":"list tables, views, and sequences","query":"\\nSELECT n.nspname as \\"Schema\\",\\n  c.relname as \\"Name\\",\\n  CASE c.relkind WHEN \'r\' THEN \'table\' WHEN \'v\' THEN \'view\' WHEN \'m\' THEN \'materialized view\' WHEN \'i\' THEN \'index\' WHEN \'S\' THEN \'sequence\' WHEN \'s\' THEN \'special\' WHEN \'t\' THEN \'TOAST table\' WHEN \'f\' THEN \'foreign table\' WHEN \'p\' THEN \'partitioned table\' WHEN \'I\' THEN \'partitioned index\' END as \\"Type\\",\\n  pg_catalog.pg_get_userbyid(c.relowner) as \\"Owner\\"\\nFROM pg_catalog.pg_class c\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace\\n     LEFT JOIN pg_catalog.pg_am am ON am.oid = c.relam\\nWHERE c.relkind IN (\'r\',\'p\',\'t\',\'v\',\'m\',\'S\',\'s\',\'f\',\'\')\\n  AND pg_catalog.pg_table_is_visible(c.oid)\\nORDER BY 1,2;\\n"},{"cmd":"\\\\dS+","opts":"[S+]","desc":"list tables, views, and sequences","query":"\\nSELECT n.nspname as \\"Schema\\",\\n  c.relname as \\"Name\\",\\n  CASE c.relkind WHEN \'r\' THEN \'table\' WHEN \'v\' THEN \'view\' WHEN \'m\' THEN \'materialized view\' WHEN \'i\' THEN \'index\' WHEN \'S\' THEN \'sequence\' WHEN \'s\' THEN \'special\' WHEN \'t\' THEN \'TOAST table\' WHEN \'f\' THEN \'foreign table\' WHEN \'p\' THEN \'partitioned table\' WHEN \'I\' THEN \'partitioned index\' END as \\"Type\\",\\n  pg_catalog.pg_get_userbyid(c.relowner) as \\"Owner\\",\\n  CASE c.relpersistence WHEN \'p\' THEN \'permanent\' WHEN \'t\' THEN \'temporary\' WHEN \'u\' THEN \'unlogged\' END as \\"Persistence\\",\\n  am.amname as \\"Access method\\",\\n  pg_catalog.pg_size_pretty(pg_catalog.pg_table_size(c.oid)) as \\"Size\\",\\n  pg_catalog.obj_description(c.oid, \'pg_class\') as \\"Description\\"\\nFROM pg_catalog.pg_class c\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace\\n     LEFT JOIN pg_catalog.pg_am am ON am.oid = c.relam\\nWHERE c.relkind IN (\'r\',\'p\',\'t\',\'v\',\'m\',\'S\',\'s\',\'f\',\'\')\\n  AND pg_catalog.pg_table_is_visible(c.oid)\\nORDER BY 1,2;\\n"},{"cmd":"\\\\d","opts":"[S+]","desc":"describe table, view, sequence, or index","query":"\\nSELECT n.nspname as \\"Schema\\",\\n  c.relname as \\"Name\\",\\n  CASE c.relkind WHEN \'r\' THEN \'table\' WHEN \'v\' THEN \'view\' WHEN \'m\' THEN \'materialized view\' WHEN \'i\' THEN \'index\' WHEN \'S\' THEN \'sequence\' WHEN \'s\' THEN \'special\' WHEN \'t\' THEN \'TOAST table\' WHEN \'f\' THEN \'foreign table\' WHEN \'p\' THEN \'partitioned table\' WHEN \'I\' THEN \'partitioned index\' END as \\"Type\\",\\n  pg_catalog.pg_get_userbyid(c.relowner) as \\"Owner\\"\\nFROM pg_catalog.pg_class c\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace\\n     LEFT JOIN pg_catalog.pg_am am ON am.oid = c.relam\\nWHERE c.relkind IN (\'r\',\'p\',\'v\',\'m\',\'S\',\'f\',\'\')\\n      AND n.nspname <> \'pg_catalog\'\\n      AND n.nspname !~ \'^pg_toast\'\\n      AND n.nspname <> \'information_schema\'\\n  AND pg_catalog.pg_table_is_visible(c.oid)\\nORDER BY 1,2;\\n"},{"cmd":"\\\\dS","opts":"[S+]","desc":"describe table, view, sequence, or index","query":"\\nSELECT n.nspname as \\"Schema\\",\\n  c.relname as \\"Name\\",\\n  CASE c.relkind WHEN \'r\' THEN \'table\' WHEN \'v\' THEN \'view\' WHEN \'m\' THEN \'materialized view\' WHEN \'i\' THEN \'index\' WHEN \'S\' THEN \'sequence\' WHEN \'s\' THEN \'special\' WHEN \'t\' THEN \'TOAST table\' WHEN \'f\' THEN \'foreign table\' WHEN \'p\' THEN \'partitioned table\' WHEN \'I\' THEN \'partitioned index\' END as \\"Type\\",\\n  pg_catalog.pg_get_userbyid(c.relowner) as \\"Owner\\"\\nFROM pg_catalog.pg_class c\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace\\n     LEFT JOIN pg_catalog.pg_am am ON am.oid = c.relam\\nWHERE c.relkind IN (\'r\',\'p\',\'t\',\'v\',\'m\',\'S\',\'s\',\'f\',\'\')\\n  AND pg_catalog.pg_table_is_visible(c.oid)\\nORDER BY 1,2;\\n"},{"cmd":"\\\\dS+","opts":"[S+]","desc":"describe table, view, sequence, or index","query":"\\nSELECT n.nspname as \\"Schema\\",\\n  c.relname as \\"Name\\",\\n  CASE c.relkind WHEN \'r\' THEN \'table\' WHEN \'v\' THEN \'view\' WHEN \'m\' THEN \'materialized view\' WHEN \'i\' THEN \'index\' WHEN \'S\' THEN \'sequence\' WHEN \'s\' THEN \'special\' WHEN \'t\' THEN \'TOAST table\' WHEN \'f\' THEN \'foreign table\' WHEN \'p\' THEN \'partitioned table\' WHEN \'I\' THEN \'partitioned index\' END as \\"Type\\",\\n  pg_catalog.pg_get_userbyid(c.relowner) as \\"Owner\\",\\n  CASE c.relpersistence WHEN \'p\' THEN \'permanent\' WHEN \'t\' THEN \'temporary\' WHEN \'u\' THEN \'unlogged\' END as \\"Persistence\\",\\n  am.amname as \\"Access method\\",\\n  pg_catalog.pg_size_pretty(pg_catalog.pg_table_size(c.oid)) as \\"Size\\",\\n  pg_catalog.obj_description(c.oid, \'pg_class\') as \\"Description\\"\\nFROM pg_catalog.pg_class c\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace\\n     LEFT JOIN pg_catalog.pg_am am ON am.oid = c.relam\\nWHERE c.relkind IN (\'r\',\'p\',\'t\',\'v\',\'m\',\'S\',\'s\',\'f\',\'\')\\n  AND pg_catalog.pg_table_is_visible(c.oid)\\nORDER BY 1,2;\\n"},{"cmd":"\\\\da","opts":"[S]","desc":"list aggregates","query":"\\nSELECT n.nspname as \\"Schema\\",\\n  p.proname AS \\"Name\\",\\n  pg_catalog.format_type(p.prorettype, NULL) AS \\"Result data type\\",\\n  CASE WHEN p.pronargs = 0\\n    THEN CAST(\'*\' AS pg_catalog.text)\\n    ELSE pg_catalog.pg_get_function_arguments(p.oid)\\n  END AS \\"Argument data types\\",\\n  pg_catalog.obj_description(p.oid, \'pg_proc\') as \\"Description\\"\\nFROM pg_catalog.pg_proc p\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = p.pronamespace\\nWHERE p.prokind = \'a\'\\n      AND n.nspname <> \'pg_catalog\'\\n      AND n.nspname <> \'information_schema\'\\n  AND pg_catalog.pg_function_is_visible(p.oid)\\nORDER BY 1, 2, 4;\\n"},{"cmd":"\\\\daS","opts":"[S]","desc":"list aggregates","query":"\\nSELECT n.nspname as \\"Schema\\",\\n  p.proname AS \\"Name\\",\\n  pg_catalog.format_type(p.prorettype, NULL) AS \\"Result data type\\",\\n  CASE WHEN p.pronargs = 0\\n    THEN CAST(\'*\' AS pg_catalog.text)\\n    ELSE pg_catalog.pg_get_function_arguments(p.oid)\\n  END AS \\"Argument data types\\",\\n  pg_catalog.obj_description(p.oid, \'pg_proc\') as \\"Description\\"\\nFROM pg_catalog.pg_proc p\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = p.pronamespace\\nWHERE p.prokind = \'a\'\\n  AND pg_catalog.pg_function_is_visible(p.oid)\\nORDER BY 1, 2, 4;\\n"},{"cmd":"\\\\dA","opts":"[+]","desc":"list access methods","query":"\\nSELECT amname AS \\"Name\\",\\n  CASE amtype WHEN \'i\' THEN \'Index\' WHEN \'t\' THEN \'Table\' END AS \\"Type\\"\\nFROM pg_catalog.pg_am\\nORDER BY 1;\\n"},{"cmd":"\\\\dA+","opts":"[+]","desc":"list access methods","query":"\\nSELECT amname AS \\"Name\\",\\n  CASE amtype WHEN \'i\' THEN \'Index\' WHEN \'t\' THEN \'Table\' END AS \\"Type\\",\\n  amhandler AS \\"Handler\\",\\n  pg_catalog.obj_description(oid, \'pg_am\') AS \\"Description\\"\\nFROM pg_catalog.pg_am\\nORDER BY 1;\\n"},{"cmd":"\\\\dAc","opts":"[+]","desc":"list operator classes","query":"\\nSELECT\\n  am.amname AS \\"AM\\",\\n  pg_catalog.format_type(c.opcintype, NULL) AS \\"Input type\\",\\n  CASE\\n    WHEN c.opckeytype <> 0 AND c.opckeytype <> c.opcintype\\n    THEN pg_catalog.format_type(c.opckeytype, NULL)\\n    ELSE NULL\\n  END AS \\"Storage type\\",\\n  CASE\\n    WHEN pg_catalog.pg_opclass_is_visible(c.oid)\\n    THEN pg_catalog.format(\'%I\', c.opcname)\\n    ELSE pg_catalog.format(\'%I.%I\', n.nspname, c.opcname)\\n  END AS \\"Operator class\\",\\n  (CASE WHEN c.opcdefault\\n    THEN \'yes\'\\n    ELSE \'no\'\\n  END) AS \\"Default?\\"\\nFROM pg_catalog.pg_opclass c\\n  LEFT JOIN pg_catalog.pg_am am on am.oid = c.opcmethod\\n  LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.opcnamespace\\n  LEFT JOIN pg_catalog.pg_type t ON t.oid = c.opcintype\\n  LEFT JOIN pg_catalog.pg_namespace tn ON tn.oid = t.typnamespace\\nORDER BY 1, 2, 4;\\n"},{"cmd":"\\\\dAc+","opts":"[+]","desc":"list operator classes","query":"\\nSELECT\\n  am.amname AS \\"AM\\",\\n  pg_catalog.format_type(c.opcintype, NULL) AS \\"Input type\\",\\n  CASE\\n    WHEN c.opckeytype <> 0 AND c.opckeytype <> c.opcintype\\n    THEN pg_catalog.format_type(c.opckeytype, NULL)\\n    ELSE NULL\\n  END AS \\"Storage type\\",\\n  CASE\\n    WHEN pg_catalog.pg_opclass_is_visible(c.oid)\\n    THEN pg_catalog.format(\'%I\', c.opcname)\\n    ELSE pg_catalog.format(\'%I.%I\', n.nspname, c.opcname)\\n  END AS \\"Operator class\\",\\n  (CASE WHEN c.opcdefault\\n    THEN \'yes\'\\n    ELSE \'no\'\\n  END) AS \\"Default?\\",\\n  CASE\\n    WHEN pg_catalog.pg_opfamily_is_visible(of.oid)\\n    THEN pg_catalog.format(\'%I\', of.opfname)\\n    ELSE pg_catalog.format(\'%I.%I\', ofn.nspname, of.opfname)\\n  END AS \\"Operator family\\",\\n pg_catalog.pg_get_userbyid(c.opcowner) AS \\"Owner\\"\\n\\nFROM pg_catalog.pg_opclass c\\n  LEFT JOIN pg_catalog.pg_am am on am.oid = c.opcmethod\\n  LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.opcnamespace\\n  LEFT JOIN pg_catalog.pg_type t ON t.oid = c.opcintype\\n  LEFT JOIN pg_catalog.pg_namespace tn ON tn.oid = t.typnamespace\\n  LEFT JOIN pg_catalog.pg_opfamily of ON of.oid = c.opcfamily\\n  LEFT JOIN pg_catalog.pg_namespace ofn ON ofn.oid = of.opfnamespace\\nORDER BY 1, 2, 4;\\n"},{"cmd":"\\\\dAf","opts":"[+]","desc":"list operator families","query":"\\nSELECT\\n  am.amname AS \\"AM\\",\\n  CASE\\n    WHEN pg_catalog.pg_opfamily_is_visible(f.oid)\\n    THEN pg_catalog.format(\'%I\', f.opfname)\\n    ELSE pg_catalog.format(\'%I.%I\', n.nspname, f.opfname)\\n  END AS \\"Operator family\\",\\n  (SELECT\\n     pg_catalog.string_agg(pg_catalog.format_type(oc.opcintype, NULL), \', \')\\n   FROM pg_catalog.pg_opclass oc\\n   WHERE oc.opcfamily = f.oid) \\"Applicable types\\"\\nFROM pg_catalog.pg_opfamily f\\n  LEFT JOIN pg_catalog.pg_am am on am.oid = f.opfmethod\\n  LEFT JOIN pg_catalog.pg_namespace n ON n.oid = f.opfnamespace\\nORDER BY 1, 2;\\n"},{"cmd":"\\\\dAf+","opts":"[+]","desc":"list operator families","query":"\\nSELECT\\n  am.amname AS \\"AM\\",\\n  CASE\\n    WHEN pg_catalog.pg_opfamily_is_visible(f.oid)\\n    THEN pg_catalog.format(\'%I\', f.opfname)\\n    ELSE pg_catalog.format(\'%I.%I\', n.nspname, f.opfname)\\n  END AS \\"Operator family\\",\\n  (SELECT\\n     pg_catalog.string_agg(pg_catalog.format_type(oc.opcintype, NULL), \', \')\\n   FROM pg_catalog.pg_opclass oc\\n   WHERE oc.opcfamily = f.oid) \\"Applicable types\\",\\n  pg_catalog.pg_get_userbyid(f.opfowner) AS \\"Owner\\"\\n\\nFROM pg_catalog.pg_opfamily f\\n  LEFT JOIN pg_catalog.pg_am am on am.oid = f.opfmethod\\n  LEFT JOIN pg_catalog.pg_namespace n ON n.oid = f.opfnamespace\\nORDER BY 1, 2;\\n"},{"cmd":"\\\\dAo","opts":"[+]","desc":"list operators of operator families","query":"\\nSELECT\\n  am.amname AS \\"AM\\",\\n  CASE\\n    WHEN pg_catalog.pg_opfamily_is_visible(of.oid)\\n    THEN pg_catalog.format(\'%I\', of.opfname)\\n    ELSE pg_catalog.format(\'%I.%I\', nsf.nspname, of.opfname)\\n  END AS \\"Operator family\\",\\n  o.amopopr::pg_catalog.regoperator AS \\"Operator\\"\\n,  o.amopstrategy AS \\"Strategy\\",\\n  CASE o.amoppurpose\\n    WHEN \'o\' THEN \'ordering\'\\n    WHEN \'s\' THEN \'search\'\\n  END AS \\"Purpose\\"\\nFROM pg_catalog.pg_amop o\\n  LEFT JOIN pg_catalog.pg_opfamily of ON of.oid = o.amopfamily\\n  LEFT JOIN pg_catalog.pg_am am ON am.oid = of.opfmethod AND am.oid = o.amopmethod\\n  LEFT JOIN pg_catalog.pg_namespace nsf ON of.opfnamespace = nsf.oid\\nORDER BY 1, 2,\\n  o.amoplefttype = o.amoprighttype DESC,\\n  pg_catalog.format_type(o.amoplefttype, NULL),\\n  pg_catalog.format_type(o.amoprighttype, NULL),\\n  o.amopstrategy;\\n"},{"cmd":"\\\\dAo+","opts":"[+]","desc":"list operators of operator families","query":"\\nSELECT\\n  am.amname AS \\"AM\\",\\n  CASE\\n    WHEN pg_catalog.pg_opfamily_is_visible(of.oid)\\n    THEN pg_catalog.format(\'%I\', of.opfname)\\n    ELSE pg_catalog.format(\'%I.%I\', nsf.nspname, of.opfname)\\n  END AS \\"Operator family\\",\\n  o.amopopr::pg_catalog.regoperator AS \\"Operator\\"\\n,  o.amopstrategy AS \\"Strategy\\",\\n  CASE o.amoppurpose\\n    WHEN \'o\' THEN \'ordering\'\\n    WHEN \'s\' THEN \'search\'\\n  END AS \\"Purpose\\"\\n, ofs.opfname AS \\"Sort opfamily\\"\\nFROM pg_catalog.pg_amop o\\n  LEFT JOIN pg_catalog.pg_opfamily of ON of.oid = o.amopfamily\\n  LEFT JOIN pg_catalog.pg_am am ON am.oid = of.opfmethod AND am.oid = o.amopmethod\\n  LEFT JOIN pg_catalog.pg_namespace nsf ON of.opfnamespace = nsf.oid\\n  LEFT JOIN pg_catalog.pg_opfamily ofs ON ofs.oid = o.amopsortfamily\\nORDER BY 1, 2,\\n  o.amoplefttype = o.amoprighttype DESC,\\n  pg_catalog.format_type(o.amoplefttype, NULL),\\n  pg_catalog.format_type(o.amoprighttype, NULL),\\n  o.amopstrategy;\\n"},{"cmd":"\\\\dAp","opts":"[+]","desc":"list support functions of operator families","query":"\\nSELECT\\n  am.amname AS \\"AM\\",\\n  CASE\\n    WHEN pg_catalog.pg_opfamily_is_visible(of.oid)\\n    THEN pg_catalog.format(\'%I\', of.opfname)\\n    ELSE pg_catalog.format(\'%I.%I\', ns.nspname, of.opfname)\\n  END AS \\"Operator family\\",\\n  pg_catalog.format_type(ap.amproclefttype, NULL) AS \\"Registered left type\\",\\n  pg_catalog.format_type(ap.amprocrighttype, NULL) AS \\"Registered right type\\",\\n  ap.amprocnum AS \\"Number\\"\\n, p.proname AS \\"Function\\"\\nFROM pg_catalog.pg_amproc ap\\n  LEFT JOIN pg_catalog.pg_opfamily of ON of.oid = ap.amprocfamily\\n  LEFT JOIN pg_catalog.pg_am am ON am.oid = of.opfmethod\\n  LEFT JOIN pg_catalog.pg_namespace ns ON of.opfnamespace = ns.oid\\n  LEFT JOIN pg_catalog.pg_proc p ON ap.amproc = p.oid\\nORDER BY 1, 2,\\n  ap.amproclefttype = ap.amprocrighttype DESC,\\n  3, 4, 5;\\n"},{"cmd":"\\\\dAp+","opts":"[+]","desc":"list support functions of operator families","query":"\\nSELECT\\n  am.amname AS \\"AM\\",\\n  CASE\\n    WHEN pg_catalog.pg_opfamily_is_visible(of.oid)\\n    THEN pg_catalog.format(\'%I\', of.opfname)\\n    ELSE pg_catalog.format(\'%I.%I\', ns.nspname, of.opfname)\\n  END AS \\"Operator family\\",\\n  pg_catalog.format_type(ap.amproclefttype, NULL) AS \\"Registered left type\\",\\n  pg_catalog.format_type(ap.amprocrighttype, NULL) AS \\"Registered right type\\",\\n  ap.amprocnum AS \\"Number\\"\\n, ap.amproc::pg_catalog.regprocedure AS \\"Function\\"\\nFROM pg_catalog.pg_amproc ap\\n  LEFT JOIN pg_catalog.pg_opfamily of ON of.oid = ap.amprocfamily\\n  LEFT JOIN pg_catalog.pg_am am ON am.oid = of.opfmethod\\n  LEFT JOIN pg_catalog.pg_namespace ns ON of.opfnamespace = ns.oid\\n  LEFT JOIN pg_catalog.pg_proc p ON ap.amproc = p.oid\\nORDER BY 1, 2,\\n  ap.amproclefttype = ap.amprocrighttype DESC,\\n  3, 4, 5;\\n"},{"cmd":"\\\\db","opts":"[+]","desc":"list tablespaces","query":"\\nSELECT spcname AS \\"Name\\",\\n  pg_catalog.pg_get_userbyid(spcowner) AS \\"Owner\\",\\n  pg_catalog.pg_tablespace_location(oid) AS \\"Location\\"\\nFROM pg_catalog.pg_tablespace\\nORDER BY 1;\\n"},{"cmd":"\\\\db+","opts":"[+]","desc":"list tablespaces","query":"\\nSELECT spcname AS \\"Name\\",\\n  pg_catalog.pg_get_userbyid(spcowner) AS \\"Owner\\",\\n  pg_catalog.pg_tablespace_location(oid) AS \\"Location\\",\\n  pg_catalog.array_to_string(spcacl, E\'\\\\n\') AS \\"Access privileges\\",\\n  spcoptions AS \\"Options\\",\\n  pg_catalog.pg_size_pretty(pg_catalog.pg_tablespace_size(oid)) AS \\"Size\\",\\n  pg_catalog.shobj_description(oid, \'pg_tablespace\') AS \\"Description\\"\\nFROM pg_catalog.pg_tablespace\\nORDER BY 1;\\n"},{"cmd":"\\\\dc","opts":"[S+]","desc":"list conversions","query":"\\nSELECT n.nspname AS \\"Schema\\",\\n       c.conname AS \\"Name\\",\\n       pg_catalog.pg_encoding_to_char(c.conforencoding) AS \\"Source\\",\\n       pg_catalog.pg_encoding_to_char(c.contoencoding) AS \\"Destination\\",\\n       CASE WHEN c.condefault THEN \'yes\'\\n       ELSE \'no\' END AS \\"Default?\\"\\nFROM pg_catalog.pg_conversion c\\n     JOIN pg_catalog.pg_namespace n ON n.oid = c.connamespace\\nWHERE true\\n  AND n.nspname <> \'pg_catalog\'\\n  AND n.nspname <> \'information_schema\'\\n  AND pg_catalog.pg_conversion_is_visible(c.oid)\\nORDER BY 1, 2;\\n"},{"cmd":"\\\\dcS","opts":"[S+]","desc":"list conversions","query":"\\nSELECT n.nspname AS \\"Schema\\",\\n       c.conname AS \\"Name\\",\\n       pg_catalog.pg_encoding_to_char(c.conforencoding) AS \\"Source\\",\\n       pg_catalog.pg_encoding_to_char(c.contoencoding) AS \\"Destination\\",\\n       CASE WHEN c.condefault THEN \'yes\'\\n       ELSE \'no\' END AS \\"Default?\\"\\nFROM pg_catalog.pg_conversion c\\n     JOIN pg_catalog.pg_namespace n ON n.oid = c.connamespace\\nWHERE true\\n  AND pg_catalog.pg_conversion_is_visible(c.oid)\\nORDER BY 1, 2;\\n"},{"cmd":"\\\\dcS+","opts":"[S+]","desc":"list conversions","query":"\\nSELECT n.nspname AS \\"Schema\\",\\n       c.conname AS \\"Name\\",\\n       pg_catalog.pg_encoding_to_char(c.conforencoding) AS \\"Source\\",\\n       pg_catalog.pg_encoding_to_char(c.contoencoding) AS \\"Destination\\",\\n       CASE WHEN c.condefault THEN \'yes\'\\n       ELSE \'no\' END AS \\"Default?\\",\\n       d.description AS \\"Description\\"\\nFROM pg_catalog.pg_conversion c\\n     JOIN pg_catalog.pg_namespace n ON n.oid = c.connamespace\\nLEFT JOIN pg_catalog.pg_description d ON d.classoid = c.tableoid\\n          AND d.objoid = c.oid AND d.objsubid = 0\\nWHERE true\\n  AND pg_catalog.pg_conversion_is_visible(c.oid)\\nORDER BY 1, 2;\\n"},{"cmd":"\\\\dC","opts":"[+]","desc":"list casts","query":"\\nSELECT pg_catalog.format_type(castsource, NULL) AS \\"Source type\\",\\n       pg_catalog.format_type(casttarget, NULL) AS \\"Target type\\",\\n       CASE WHEN c.castmethod = \'b\' THEN \'(binary coercible)\'\\n            WHEN c.castmethod = \'i\' THEN \'(with inout)\'\\n            ELSE p.proname\\n       END AS \\"Function\\",\\n       CASE WHEN c.castcontext = \'e\' THEN \'no\'\\n            WHEN c.castcontext = \'a\' THEN \'in assignment\'\\n            ELSE \'yes\'\\n       END AS \\"Implicit?\\"\\nFROM pg_catalog.pg_cast c LEFT JOIN pg_catalog.pg_proc p\\n     ON c.castfunc = p.oid\\n     LEFT JOIN pg_catalog.pg_type ts\\n     ON c.castsource = ts.oid\\n     LEFT JOIN pg_catalog.pg_namespace ns\\n     ON ns.oid = ts.typnamespace\\n     LEFT JOIN pg_catalog.pg_type tt\\n     ON c.casttarget = tt.oid\\n     LEFT JOIN pg_catalog.pg_namespace nt\\n     ON nt.oid = tt.typnamespace\\nWHERE ( (true  AND pg_catalog.pg_type_is_visible(ts.oid)\\n) OR (true  AND pg_catalog.pg_type_is_visible(tt.oid)\\n) )\\nORDER BY 1, 2;\\n"},{"cmd":"\\\\dC+","opts":"[+]","desc":"list casts","query":"\\nSELECT pg_catalog.format_type(castsource, NULL) AS \\"Source type\\",\\n       pg_catalog.format_type(casttarget, NULL) AS \\"Target type\\",\\n       CASE WHEN c.castmethod = \'b\' THEN \'(binary coercible)\'\\n            WHEN c.castmethod = \'i\' THEN \'(with inout)\'\\n            ELSE p.proname\\n       END AS \\"Function\\",\\n       CASE WHEN c.castcontext = \'e\' THEN \'no\'\\n            WHEN c.castcontext = \'a\' THEN \'in assignment\'\\n            ELSE \'yes\'\\n       END AS \\"Implicit?\\",\\n       d.description AS \\"Description\\"\\nFROM pg_catalog.pg_cast c LEFT JOIN pg_catalog.pg_proc p\\n     ON c.castfunc = p.oid\\n     LEFT JOIN pg_catalog.pg_type ts\\n     ON c.castsource = ts.oid\\n     LEFT JOIN pg_catalog.pg_namespace ns\\n     ON ns.oid = ts.typnamespace\\n     LEFT JOIN pg_catalog.pg_type tt\\n     ON c.casttarget = tt.oid\\n     LEFT JOIN pg_catalog.pg_namespace nt\\n     ON nt.oid = tt.typnamespace\\n     LEFT JOIN pg_catalog.pg_description d\\n     ON d.classoid = c.tableoid AND d.objoid = c.oid AND d.objsubid = 0\\nWHERE ( (true  AND pg_catalog.pg_type_is_visible(ts.oid)\\n) OR (true  AND pg_catalog.pg_type_is_visible(tt.oid)\\n) )\\nORDER BY 1, 2;\\n"},{"cmd":"\\\\dd","opts":"[S]","desc":"show object descriptions not displayed elsewhere","query":"\\nSELECT DISTINCT tt.nspname AS \\"Schema\\", tt.name AS \\"Name\\", tt.object AS \\"Object\\", d.description AS \\"Description\\"\\nFROM (\\n  SELECT pgc.oid as oid, pgc.tableoid AS tableoid,\\n  n.nspname as nspname,\\n  CAST(pgc.conname AS pg_catalog.text) as name,  CAST(\'table constraint\' AS pg_catalog.text) as object\\n  FROM pg_catalog.pg_constraint pgc\\n    JOIN pg_catalog.pg_class c ON c.oid = pgc.conrelid\\n    LEFT JOIN pg_catalog.pg_namespace n     ON n.oid = c.relnamespace\\nWHERE n.nspname <> \'pg_catalog\'\\n      AND n.nspname <> \'information_schema\'\\n  AND pg_catalog.pg_table_is_visible(c.oid)\\nUNION ALL\\n  SELECT pgc.oid as oid, pgc.tableoid AS tableoid,\\n  n.nspname as nspname,\\n  CAST(pgc.conname AS pg_catalog.text) as name,  CAST(\'domain constraint\' AS pg_catalog.text) as object\\n  FROM pg_catalog.pg_constraint pgc\\n    JOIN pg_catalog.pg_type t ON t.oid = pgc.contypid\\n    LEFT JOIN pg_catalog.pg_namespace n     ON n.oid = t.typnamespace\\nWHERE n.nspname <> \'pg_catalog\'\\n      AND n.nspname <> \'information_schema\'\\n  AND pg_catalog.pg_type_is_visible(t.oid)\\nUNION ALL\\n  SELECT o.oid as oid, o.tableoid as tableoid,\\n  n.nspname as nspname,\\n  CAST(o.opcname AS pg_catalog.text) as name,\\n  CAST(\'operator class\' AS pg_catalog.text) as object\\n  FROM pg_catalog.pg_opclass o\\n    JOIN pg_catalog.pg_am am ON o.opcmethod = am.oid\\n    JOIN pg_catalog.pg_namespace n ON n.oid = o.opcnamespace\\n      AND n.nspname <> \'pg_catalog\'\\n      AND n.nspname <> \'information_schema\'\\n  AND pg_catalog.pg_opclass_is_visible(o.oid)\\nUNION ALL\\n  SELECT opf.oid as oid, opf.tableoid as tableoid,\\n  n.nspname as nspname,\\n  CAST(opf.opfname AS pg_catalog.text) AS name,\\n  CAST(\'operator family\' AS pg_catalog.text) as object\\n  FROM pg_catalog.pg_opfamily opf\\n    JOIN pg_catalog.pg_am am ON opf.opfmethod = am.oid\\n    JOIN pg_catalog.pg_namespace n ON opf.opfnamespace = n.oid\\n      AND n.nspname <> \'pg_catalog\'\\n      AND n.nspname <> \'information_schema\'\\n  AND pg_catalog.pg_opfamily_is_visible(opf.oid)\\nUNION ALL\\n  SELECT r.oid as oid, r.tableoid as tableoid,\\n  n.nspname as nspname,\\n  CAST(r.rulename AS pg_catalog.text) as name,  CAST(\'rule\' AS pg_catalog.text) as object\\n  FROM pg_catalog.pg_rewrite r\\n       JOIN pg_catalog.pg_class c ON c.oid = r.ev_class\\n       LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace\\n  WHERE r.rulename != \'_RETURN\'\\n      AND n.nspname <> \'pg_catalog\'\\n      AND n.nspname <> \'information_schema\'\\n  AND pg_catalog.pg_table_is_visible(c.oid)\\nUNION ALL\\n  SELECT t.oid as oid, t.tableoid as tableoid,\\n  n.nspname as nspname,\\n  CAST(t.tgname AS pg_catalog.text) as name,  CAST(\'trigger\' AS pg_catalog.text) as object\\n  FROM pg_catalog.pg_trigger t\\n       JOIN pg_catalog.pg_class c ON c.oid = t.tgrelid\\n       LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace\\nWHERE n.nspname <> \'pg_catalog\'\\n      AND n.nspname <> \'information_schema\'\\n  AND pg_catalog.pg_table_is_visible(c.oid)\\n) AS tt\\n  JOIN pg_catalog.pg_description d ON (tt.oid = d.objoid AND tt.tableoid = d.classoid AND d.objsubid = 0)\\nORDER BY 1, 2, 3;\\n"},{"cmd":"\\\\ddS","opts":"[S]","desc":"show object descriptions not displayed elsewhere","query":"\\nSELECT DISTINCT tt.nspname AS \\"Schema\\", tt.name AS \\"Name\\", tt.object AS \\"Object\\", d.description AS \\"Description\\"\\nFROM (\\n  SELECT pgc.oid as oid, pgc.tableoid AS tableoid,\\n  n.nspname as nspname,\\n  CAST(pgc.conname AS pg_catalog.text) as name,  CAST(\'table constraint\' AS pg_catalog.text) as object\\n  FROM pg_catalog.pg_constraint pgc\\n    JOIN pg_catalog.pg_class c ON c.oid = pgc.conrelid\\n    LEFT JOIN pg_catalog.pg_namespace n     ON n.oid = c.relnamespace\\nWHERE pg_catalog.pg_table_is_visible(c.oid)\\nUNION ALL\\n  SELECT pgc.oid as oid, pgc.tableoid AS tableoid,\\n  n.nspname as nspname,\\n  CAST(pgc.conname AS pg_catalog.text) as name,  CAST(\'domain constraint\' AS pg_catalog.text) as object\\n  FROM pg_catalog.pg_constraint pgc\\n    JOIN pg_catalog.pg_type t ON t.oid = pgc.contypid\\n    LEFT JOIN pg_catalog.pg_namespace n     ON n.oid = t.typnamespace\\nWHERE pg_catalog.pg_type_is_visible(t.oid)\\nUNION ALL\\n  SELECT o.oid as oid, o.tableoid as tableoid,\\n  n.nspname as nspname,\\n  CAST(o.opcname AS pg_catalog.text) as name,\\n  CAST(\'operator class\' AS pg_catalog.text) as object\\n  FROM pg_catalog.pg_opclass o\\n    JOIN pg_catalog.pg_am am ON o.opcmethod = am.oid\\n    JOIN pg_catalog.pg_namespace n ON n.oid = o.opcnamespace\\n  AND pg_catalog.pg_opclass_is_visible(o.oid)\\nUNION ALL\\n  SELECT opf.oid as oid, opf.tableoid as tableoid,\\n  n.nspname as nspname,\\n  CAST(opf.opfname AS pg_catalog.text) AS name,\\n  CAST(\'operator family\' AS pg_catalog.text) as object\\n  FROM pg_catalog.pg_opfamily opf\\n    JOIN pg_catalog.pg_am am ON opf.opfmethod = am.oid\\n    JOIN pg_catalog.pg_namespace n ON opf.opfnamespace = n.oid\\n  AND pg_catalog.pg_opfamily_is_visible(opf.oid)\\nUNION ALL\\n  SELECT r.oid as oid, r.tableoid as tableoid,\\n  n.nspname as nspname,\\n  CAST(r.rulename AS pg_catalog.text) as name,  CAST(\'rule\' AS pg_catalog.text) as object\\n  FROM pg_catalog.pg_rewrite r\\n       JOIN pg_catalog.pg_class c ON c.oid = r.ev_class\\n       LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace\\n  WHERE r.rulename != \'_RETURN\'\\n  AND pg_catalog.pg_table_is_visible(c.oid)\\nUNION ALL\\n  SELECT t.oid as oid, t.tableoid as tableoid,\\n  n.nspname as nspname,\\n  CAST(t.tgname AS pg_catalog.text) as name,  CAST(\'trigger\' AS pg_catalog.text) as object\\n  FROM pg_catalog.pg_trigger t\\n       JOIN pg_catalog.pg_class c ON c.oid = t.tgrelid\\n       LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace\\nWHERE pg_catalog.pg_table_is_visible(c.oid)\\n) AS tt\\n  JOIN pg_catalog.pg_description d ON (tt.oid = d.objoid AND tt.tableoid = d.classoid AND d.objsubid = 0)\\nORDER BY 1, 2, 3;\\n"},{"cmd":"\\\\dD","opts":"[S+]","desc":"list domains","query":"\\nSELECT n.nspname as \\"Schema\\",\\n       t.typname as \\"Name\\",\\n       pg_catalog.format_type(t.typbasetype, t.typtypmod) as \\"Type\\",\\n       (SELECT c.collname FROM pg_catalog.pg_collation c, pg_catalog.pg_type bt\\n        WHERE c.oid = t.typcollation AND bt.oid = t.typbasetype AND t.typcollation <> bt.typcollation) as \\"Collation\\",\\n       CASE WHEN t.typnotnull THEN \'not null\' END as \\"Nullable\\",\\n       t.typdefault as \\"Default\\",\\n       pg_catalog.array_to_string(ARRAY(\\n         SELECT pg_catalog.pg_get_constraintdef(r.oid, true) FROM pg_catalog.pg_constraint r WHERE t.oid = r.contypid\\n       ), \' \') as \\"Check\\"\\nFROM pg_catalog.pg_type t\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = t.typnamespace\\nWHERE t.typtype = \'d\'\\n      AND n.nspname <> \'pg_catalog\'\\n      AND n.nspname <> \'information_schema\'\\n  AND pg_catalog.pg_type_is_visible(t.oid)\\nORDER BY 1, 2;\\n"},{"cmd":"\\\\dDS","opts":"[S+]","desc":"list domains","query":"\\nSELECT n.nspname as \\"Schema\\",\\n       t.typname as \\"Name\\",\\n       pg_catalog.format_type(t.typbasetype, t.typtypmod) as \\"Type\\",\\n       (SELECT c.collname FROM pg_catalog.pg_collation c, pg_catalog.pg_type bt\\n        WHERE c.oid = t.typcollation AND bt.oid = t.typbasetype AND t.typcollation <> bt.typcollation) as \\"Collation\\",\\n       CASE WHEN t.typnotnull THEN \'not null\' END as \\"Nullable\\",\\n       t.typdefault as \\"Default\\",\\n       pg_catalog.array_to_string(ARRAY(\\n         SELECT pg_catalog.pg_get_constraintdef(r.oid, true) FROM pg_catalog.pg_constraint r WHERE t.oid = r.contypid\\n       ), \' \') as \\"Check\\"\\nFROM pg_catalog.pg_type t\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = t.typnamespace\\nWHERE t.typtype = \'d\'\\n  AND pg_catalog.pg_type_is_visible(t.oid)\\nORDER BY 1, 2;\\n"},{"cmd":"\\\\dDS+","opts":"[S+]","desc":"list domains","query":"\\nSELECT n.nspname as \\"Schema\\",\\n       t.typname as \\"Name\\",\\n       pg_catalog.format_type(t.typbasetype, t.typtypmod) as \\"Type\\",\\n       (SELECT c.collname FROM pg_catalog.pg_collation c, pg_catalog.pg_type bt\\n        WHERE c.oid = t.typcollation AND bt.oid = t.typbasetype AND t.typcollation <> bt.typcollation) as \\"Collation\\",\\n       CASE WHEN t.typnotnull THEN \'not null\' END as \\"Nullable\\",\\n       t.typdefault as \\"Default\\",\\n       pg_catalog.array_to_string(ARRAY(\\n         SELECT pg_catalog.pg_get_constraintdef(r.oid, true) FROM pg_catalog.pg_constraint r WHERE t.oid = r.contypid\\n       ), \' \') as \\"Check\\",\\n  pg_catalog.array_to_string(t.typacl, E\'\\\\n\') AS \\"Access privileges\\",\\n       d.description as \\"Description\\"\\nFROM pg_catalog.pg_type t\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = t.typnamespace\\n     LEFT JOIN pg_catalog.pg_description d ON d.classoid = t.tableoid AND d.objoid = t.oid AND d.objsubid = 0\\nWHERE t.typtype = \'d\'\\n  AND pg_catalog.pg_type_is_visible(t.oid)\\nORDER BY 1, 2;\\n"},{"cmd":"\\\\ddp","desc":"list default privileges","query":"\\nSELECT pg_catalog.pg_get_userbyid(d.defaclrole) AS \\"Owner\\",\\n  n.nspname AS \\"Schema\\",\\n  CASE d.defaclobjtype WHEN \'r\' THEN \'table\' WHEN \'S\' THEN \'sequence\' WHEN \'f\' THEN \'function\' WHEN \'T\' THEN \'type\' WHEN \'n\' THEN \'schema\' END AS \\"Type\\",\\n  pg_catalog.array_to_string(d.defaclacl, E\'\\\\n\') AS \\"Access privileges\\"\\nFROM pg_catalog.pg_default_acl d\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = d.defaclnamespace\\nORDER BY 1, 2, 3;\\n"},{"cmd":"\\\\dE","opts":"[S+]","desc":"list foreign tables","query":"\\nSELECT n.nspname as \\"Schema\\",\\n  c.relname as \\"Name\\",\\n  CASE c.relkind WHEN \'r\' THEN \'table\' WHEN \'v\' THEN \'view\' WHEN \'m\' THEN \'materialized view\' WHEN \'i\' THEN \'index\' WHEN \'S\' THEN \'sequence\' WHEN \'s\' THEN \'special\' WHEN \'t\' THEN \'TOAST table\' WHEN \'f\' THEN \'foreign table\' WHEN \'p\' THEN \'partitioned table\' WHEN \'I\' THEN \'partitioned index\' END as \\"Type\\",\\n  pg_catalog.pg_get_userbyid(c.relowner) as \\"Owner\\"\\nFROM pg_catalog.pg_class c\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace\\nWHERE c.relkind IN (\'f\',\'\')\\n      AND n.nspname <> \'pg_catalog\'\\n      AND n.nspname !~ \'^pg_toast\'\\n      AND n.nspname <> \'information_schema\'\\n  AND pg_catalog.pg_table_is_visible(c.oid)\\nORDER BY 1,2;\\n"},{"cmd":"\\\\dES","opts":"[S+]","desc":"list foreign tables","query":"\\nSELECT n.nspname as \\"Schema\\",\\n  c.relname as \\"Name\\",\\n  CASE c.relkind WHEN \'r\' THEN \'table\' WHEN \'v\' THEN \'view\' WHEN \'m\' THEN \'materialized view\' WHEN \'i\' THEN \'index\' WHEN \'S\' THEN \'sequence\' WHEN \'s\' THEN \'special\' WHEN \'t\' THEN \'TOAST table\' WHEN \'f\' THEN \'foreign table\' WHEN \'p\' THEN \'partitioned table\' WHEN \'I\' THEN \'partitioned index\' END as \\"Type\\",\\n  pg_catalog.pg_get_userbyid(c.relowner) as \\"Owner\\"\\nFROM pg_catalog.pg_class c\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace\\nWHERE c.relkind IN (\'s\',\'f\',\'\')\\n  AND pg_catalog.pg_table_is_visible(c.oid)\\nORDER BY 1,2;\\n"},{"cmd":"\\\\dES+","opts":"[S+]","desc":"list foreign tables","query":"\\nSELECT n.nspname as \\"Schema\\",\\n  c.relname as \\"Name\\",\\n  CASE c.relkind WHEN \'r\' THEN \'table\' WHEN \'v\' THEN \'view\' WHEN \'m\' THEN \'materialized view\' WHEN \'i\' THEN \'index\' WHEN \'S\' THEN \'sequence\' WHEN \'s\' THEN \'special\' WHEN \'t\' THEN \'TOAST table\' WHEN \'f\' THEN \'foreign table\' WHEN \'p\' THEN \'partitioned table\' WHEN \'I\' THEN \'partitioned index\' END as \\"Type\\",\\n  pg_catalog.pg_get_userbyid(c.relowner) as \\"Owner\\",\\n  CASE c.relpersistence WHEN \'p\' THEN \'permanent\' WHEN \'t\' THEN \'temporary\' WHEN \'u\' THEN \'unlogged\' END as \\"Persistence\\",\\n  pg_catalog.pg_size_pretty(pg_catalog.pg_table_size(c.oid)) as \\"Size\\",\\n  pg_catalog.obj_description(c.oid, \'pg_class\') as \\"Description\\"\\nFROM pg_catalog.pg_class c\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace\\nWHERE c.relkind IN (\'s\',\'f\',\'\')\\n  AND pg_catalog.pg_table_is_visible(c.oid)\\nORDER BY 1,2;\\n"},{"cmd":"\\\\des","opts":"[+]","desc":"list foreign servers","query":"\\nSELECT s.srvname AS \\"Name\\",\\n  pg_catalog.pg_get_userbyid(s.srvowner) AS \\"Owner\\",\\n  f.fdwname AS \\"Foreign-data wrapper\\"\\nFROM pg_catalog.pg_foreign_server s\\n     JOIN pg_catalog.pg_foreign_data_wrapper f ON f.oid=s.srvfdw\\nORDER BY 1;\\n"},{"cmd":"\\\\des+","opts":"[+]","desc":"list foreign servers","query":"\\nSELECT s.srvname AS \\"Name\\",\\n  pg_catalog.pg_get_userbyid(s.srvowner) AS \\"Owner\\",\\n  f.fdwname AS \\"Foreign-data wrapper\\",\\n  pg_catalog.array_to_string(s.srvacl, E\'\\\\n\') AS \\"Access privileges\\",\\n  s.srvtype AS \\"Type\\",\\n  s.srvversion AS \\"Version\\",\\n  CASE WHEN srvoptions IS NULL THEN \'\' ELSE   \'(\' || pg_catalog.array_to_string(ARRAY(SELECT   pg_catalog.quote_ident(option_name) ||  \' \' ||   pg_catalog.quote_literal(option_value)  FROM   pg_catalog.pg_options_to_table(srvoptions)),  \', \') || \')\'   END AS \\"FDW options\\",\\n  d.description AS \\"Description\\"\\nFROM pg_catalog.pg_foreign_server s\\n     JOIN pg_catalog.pg_foreign_data_wrapper f ON f.oid=s.srvfdw\\nLEFT JOIN pg_catalog.pg_description d\\n       ON d.classoid = s.tableoid AND d.objoid = s.oid AND d.objsubid = 0\\nORDER BY 1;\\n"},{"cmd":"\\\\det","opts":"[+]","desc":"list foreign tables","query":"\\nSELECT n.nspname AS \\"Schema\\",\\n  c.relname AS \\"Table\\",\\n  s.srvname AS \\"Server\\"\\nFROM pg_catalog.pg_foreign_table ft\\n  INNER JOIN pg_catalog.pg_class c ON c.oid = ft.ftrelid\\n  INNER JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace\\n  INNER JOIN pg_catalog.pg_foreign_server s ON s.oid = ft.ftserver\\nWHERE pg_catalog.pg_table_is_visible(c.oid)\\nORDER BY 1, 2;\\n"},{"cmd":"\\\\det+","opts":"[+]","desc":"list foreign tables","query":"\\nSELECT n.nspname AS \\"Schema\\",\\n  c.relname AS \\"Table\\",\\n  s.srvname AS \\"Server\\",\\n CASE WHEN ftoptions IS NULL THEN \'\' ELSE   \'(\' || pg_catalog.array_to_string(ARRAY(SELECT   pg_catalog.quote_ident(option_name) ||  \' \' ||   pg_catalog.quote_literal(option_value)  FROM   pg_catalog.pg_options_to_table(ftoptions)),  \', \') || \')\'   END AS \\"FDW options\\",\\n  d.description AS \\"Description\\"\\nFROM pg_catalog.pg_foreign_table ft\\n  INNER JOIN pg_catalog.pg_class c ON c.oid = ft.ftrelid\\n  INNER JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace\\n  INNER JOIN pg_catalog.pg_foreign_server s ON s.oid = ft.ftserver\\n   LEFT JOIN pg_catalog.pg_description d\\n          ON d.classoid = c.tableoid AND d.objoid = c.oid AND d.objsubid = 0\\nWHERE pg_catalog.pg_table_is_visible(c.oid)\\nORDER BY 1, 2;\\n"},{"cmd":"\\\\deu","opts":"[+]","desc":"list user mappings","query":"\\nSELECT um.srvname AS \\"Server\\",\\n  um.usename AS \\"User name\\"\\nFROM pg_catalog.pg_user_mappings um\\nORDER BY 1, 2;\\n"},{"cmd":"\\\\deu+","opts":"[+]","desc":"list user mappings","query":"\\nSELECT um.srvname AS \\"Server\\",\\n  um.usename AS \\"User name\\",\\n CASE WHEN umoptions IS NULL THEN \'\' ELSE   \'(\' || pg_catalog.array_to_string(ARRAY(SELECT   pg_catalog.quote_ident(option_name) ||  \' \' ||   pg_catalog.quote_literal(option_value)  FROM   pg_catalog.pg_options_to_table(umoptions)),  \', \') || \')\'   END AS \\"FDW options\\"\\nFROM pg_catalog.pg_user_mappings um\\nORDER BY 1, 2;\\n"},{"cmd":"\\\\dew","opts":"[+]","desc":"list foreign-data wrappers","query":"\\nSELECT fdw.fdwname AS \\"Name\\",\\n  pg_catalog.pg_get_userbyid(fdw.fdwowner) AS \\"Owner\\",\\n  fdw.fdwhandler::pg_catalog.regproc AS \\"Handler\\",\\n  fdw.fdwvalidator::pg_catalog.regproc AS \\"Validator\\"\\nFROM pg_catalog.pg_foreign_data_wrapper fdw\\nORDER BY 1;\\n"},{"cmd":"\\\\dew+","opts":"[+]","desc":"list foreign-data wrappers","query":"\\nSELECT fdw.fdwname AS \\"Name\\",\\n  pg_catalog.pg_get_userbyid(fdw.fdwowner) AS \\"Owner\\",\\n  fdw.fdwhandler::pg_catalog.regproc AS \\"Handler\\",\\n  fdw.fdwvalidator::pg_catalog.regproc AS \\"Validator\\",\\n  pg_catalog.array_to_string(fdwacl, E\'\\\\n\') AS \\"Access privileges\\",\\n CASE WHEN fdwoptions IS NULL THEN \'\' ELSE   \'(\' || pg_catalog.array_to_string(ARRAY(SELECT   pg_catalog.quote_ident(option_name) ||  \' \' ||   pg_catalog.quote_literal(option_value)  FROM   pg_catalog.pg_options_to_table(fdwoptions)),  \', \') || \')\'   END AS \\"FDW options\\",\\n  d.description AS \\"Description\\" \\nFROM pg_catalog.pg_foreign_data_wrapper fdw\\nLEFT JOIN pg_catalog.pg_description d\\n       ON d.classoid = fdw.tableoid AND d.objoid = fdw.oid AND d.objsubid = 0\\nORDER BY 1;\\n"},{"cmd":"\\\\df","opts":"[anptw]","desc":"list [only agg/normal/procedure/trigger/window]","query":"\\nSELECT n.nspname as \\"Schema\\",\\n  p.proname as \\"Name\\",\\n  pg_catalog.pg_get_function_result(p.oid) as \\"Result data type\\",\\n  pg_catalog.pg_get_function_arguments(p.oid) as \\"Argument data types\\",\\n CASE p.prokind\\n  WHEN \'a\' THEN \'agg\'\\n  WHEN \'w\' THEN \'window\'\\n  WHEN \'p\' THEN \'proc\'\\n  ELSE \'func\'\\n END as \\"Type\\"\\nFROM pg_catalog.pg_proc p\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = p.pronamespace\\nWHERE pg_catalog.pg_function_is_visible(p.oid)\\n      AND n.nspname <> \'pg_catalog\'\\n      AND n.nspname <> \'information_schema\'\\nORDER BY 1, 2, 4;\\n"},{"cmd":"\\\\dfa","opts":"[anptw]","desc":"list [only agg/normal/procedure/trigger/window]","query":"\\nSELECT n.nspname as \\"Schema\\",\\n  p.proname as \\"Name\\",\\n  pg_catalog.pg_get_function_result(p.oid) as \\"Result data type\\",\\n  pg_catalog.pg_get_function_arguments(p.oid) as \\"Argument data types\\",\\n CASE p.prokind\\n  WHEN \'a\' THEN \'agg\'\\n  WHEN \'w\' THEN \'window\'\\n  WHEN \'p\' THEN \'proc\'\\n  ELSE \'func\'\\n END as \\"Type\\"\\nFROM pg_catalog.pg_proc p\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = p.pronamespace\\nWHERE (\\n       p.prokind = \'a\'\\n      )\\n  AND pg_catalog.pg_function_is_visible(p.oid)\\n      AND n.nspname <> \'pg_catalog\'\\n      AND n.nspname <> \'information_schema\'\\nORDER BY 1, 2, 4;\\n"},{"cmd":"\\\\dfan","opts":"[anptw]","desc":"list [only agg/normal/procedure/trigger/window]","query":"\\nSELECT n.nspname as \\"Schema\\",\\n  p.proname as \\"Name\\",\\n  pg_catalog.pg_get_function_result(p.oid) as \\"Result data type\\",\\n  pg_catalog.pg_get_function_arguments(p.oid) as \\"Argument data types\\",\\n CASE p.prokind\\n  WHEN \'a\' THEN \'agg\'\\n  WHEN \'w\' THEN \'window\'\\n  WHEN \'p\' THEN \'proc\'\\n  ELSE \'func\'\\n END as \\"Type\\"\\nFROM pg_catalog.pg_proc p\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = p.pronamespace\\nWHERE p.prokind <> \'p\'\\n      AND p.prorettype <> \'pg_catalog.trigger\'::pg_catalog.regtype\\n      AND p.prokind <> \'w\'\\n  AND pg_catalog.pg_function_is_visible(p.oid)\\n      AND n.nspname <> \'pg_catalog\'\\n      AND n.nspname <> \'information_schema\'\\nORDER BY 1, 2, 4;\\n"},{"cmd":"\\\\dfanp","opts":"[anptw]","desc":"list [only agg/normal/procedure/trigger/window]","query":"\\nSELECT n.nspname as \\"Schema\\",\\n  p.proname as \\"Name\\",\\n  pg_catalog.pg_get_function_result(p.oid) as \\"Result data type\\",\\n  pg_catalog.pg_get_function_arguments(p.oid) as \\"Argument data types\\",\\n CASE p.prokind\\n  WHEN \'a\' THEN \'agg\'\\n  WHEN \'w\' THEN \'window\'\\n  WHEN \'p\' THEN \'proc\'\\n  ELSE \'func\'\\n END as \\"Type\\"\\nFROM pg_catalog.pg_proc p\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = p.pronamespace\\nWHERE p.prorettype <> \'pg_catalog.trigger\'::pg_catalog.regtype\\n      AND p.prokind <> \'w\'\\n  AND pg_catalog.pg_function_is_visible(p.oid)\\n      AND n.nspname <> \'pg_catalog\'\\n      AND n.nspname <> \'information_schema\'\\nORDER BY 1, 2, 4;\\n"},{"cmd":"\\\\dfanpt","opts":"[anptw]","desc":"list [only agg/normal/procedure/trigger/window]","query":"\\nSELECT n.nspname as \\"Schema\\",\\n  p.proname as \\"Name\\",\\n  pg_catalog.pg_get_function_result(p.oid) as \\"Result data type\\",\\n  pg_catalog.pg_get_function_arguments(p.oid) as \\"Argument data types\\",\\n CASE p.prokind\\n  WHEN \'a\' THEN \'agg\'\\n  WHEN \'w\' THEN \'window\'\\n  WHEN \'p\' THEN \'proc\'\\n  ELSE \'func\'\\n END as \\"Type\\"\\nFROM pg_catalog.pg_proc p\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = p.pronamespace\\nWHERE p.prokind <> \'w\'\\n  AND pg_catalog.pg_function_is_visible(p.oid)\\n      AND n.nspname <> \'pg_catalog\'\\n      AND n.nspname <> \'information_schema\'\\nORDER BY 1, 2, 4;\\n"},{"cmd":"\\\\dfanptw","opts":"[anptw]","desc":"list [only agg/normal/procedure/trigger/window]","query":"\\nSELECT n.nspname as \\"Schema\\",\\n  p.proname as \\"Name\\",\\n  pg_catalog.pg_get_function_result(p.oid) as \\"Result data type\\",\\n  pg_catalog.pg_get_function_arguments(p.oid) as \\"Argument data types\\",\\n CASE p.prokind\\n  WHEN \'a\' THEN \'agg\'\\n  WHEN \'w\' THEN \'window\'\\n  WHEN \'p\' THEN \'proc\'\\n  ELSE \'func\'\\n END as \\"Type\\"\\nFROM pg_catalog.pg_proc p\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = p.pronamespace\\nWHERE pg_catalog.pg_function_is_visible(p.oid)\\n      AND n.nspname <> \'pg_catalog\'\\n      AND n.nspname <> \'information_schema\'\\nORDER BY 1, 2, 4;\\n"},{"cmd":"\\\\dF","opts":"[+]","desc":"list text search configurations","query":"\\nSELECT\\n   n.nspname as \\"Schema\\",\\n   c.cfgname as \\"Name\\",\\n   pg_catalog.obj_description(c.oid, \'pg_ts_config\') as \\"Description\\"\\nFROM pg_catalog.pg_ts_config c\\nLEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.cfgnamespace\\nWHERE pg_catalog.pg_ts_config_is_visible(c.oid)\\nORDER BY 1, 2;\\n"},{"cmd":"\\\\dF+","opts":"[+]","desc":"list text search configurations","query":"\\nSELECT c.oid, c.cfgname,\\n   n.nspname,\\n   p.prsname,\\n   np.nspname as pnspname\\nFROM pg_catalog.pg_ts_config c\\n   LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.cfgnamespace,\\n pg_catalog.pg_ts_parser p\\n   LEFT JOIN pg_catalog.pg_namespace np ON np.oid = p.prsnamespace\\nWHERE  p.oid = c.cfgparser\\n  AND pg_catalog.pg_ts_config_is_visible(c.oid)\\nORDER BY 3, 2;\\n"},{"cmd":"\\\\dFd","opts":"[+]","desc":"list text search dictionaries","query":"\\nSELECT\\n  n.nspname as \\"Schema\\",\\n  d.dictname as \\"Name\\",\\n  pg_catalog.obj_description(d.oid, \'pg_ts_dict\') as \\"Description\\"\\nFROM pg_catalog.pg_ts_dict d\\nLEFT JOIN pg_catalog.pg_namespace n ON n.oid = d.dictnamespace\\nWHERE pg_catalog.pg_ts_dict_is_visible(d.oid)\\nORDER BY 1, 2;\\n"},{"cmd":"\\\\dFd+","opts":"[+]","desc":"list text search dictionaries","query":"\\nSELECT\\n  n.nspname as \\"Schema\\",\\n  d.dictname as \\"Name\\",\\n  ( SELECT COALESCE(nt.nspname, \'(null)\')::pg_catalog.text || \'.\' || t.tmplname FROM\\n    pg_catalog.pg_ts_template t\\n    LEFT JOIN pg_catalog.pg_namespace nt ON nt.oid = t.tmplnamespace\\n    WHERE d.dicttemplate = t.oid ) AS  \\"Template\\",\\n  d.dictinitoption as \\"Init options\\",\\n  pg_catalog.obj_description(d.oid, \'pg_ts_dict\') as \\"Description\\"\\nFROM pg_catalog.pg_ts_dict d\\nLEFT JOIN pg_catalog.pg_namespace n ON n.oid = d.dictnamespace\\nWHERE pg_catalog.pg_ts_dict_is_visible(d.oid)\\nORDER BY 1, 2;\\n"},{"cmd":"\\\\dFp","opts":"[+]","desc":"list text search parsers","query":"\\nSELECT\\n  n.nspname as \\"Schema\\",\\n  p.prsname as \\"Name\\",\\n  pg_catalog.obj_description(p.oid, \'pg_ts_parser\') as \\"Description\\"\\nFROM pg_catalog.pg_ts_parser p\\nLEFT JOIN pg_catalog.pg_namespace n ON n.oid = p.prsnamespace\\nWHERE pg_catalog.pg_ts_parser_is_visible(p.oid)\\nORDER BY 1, 2;\\n"},{"cmd":"\\\\dFp+","opts":"[+]","desc":"list text search parsers","query":"\\nSELECT p.oid,\\n  n.nspname,\\n  p.prsname\\nFROM pg_catalog.pg_ts_parser p\\nLEFT JOIN pg_catalog.pg_namespace n ON n.oid = p.prsnamespace\\nWHERE pg_catalog.pg_ts_parser_is_visible(p.oid)\\nORDER BY 1, 2;\\n"},{"cmd":"\\\\dFt","opts":"[+]","desc":"list text search templates","query":"\\nSELECT\\n  n.nspname AS \\"Schema\\",\\n  t.tmplname AS \\"Name\\",\\n  pg_catalog.obj_description(t.oid, \'pg_ts_template\') AS \\"Description\\"\\nFROM pg_catalog.pg_ts_template t\\nLEFT JOIN pg_catalog.pg_namespace n ON n.oid = t.tmplnamespace\\nWHERE pg_catalog.pg_ts_template_is_visible(t.oid)\\nORDER BY 1, 2;\\n"},{"cmd":"\\\\dFt+","opts":"[+]","desc":"list text search templates","query":"\\nSELECT\\n  n.nspname AS \\"Schema\\",\\n  t.tmplname AS \\"Name\\",\\n  t.tmplinit::pg_catalog.regproc AS \\"Init\\",\\n  t.tmpllexize::pg_catalog.regproc AS \\"Lexize\\",\\n  pg_catalog.obj_description(t.oid, \'pg_ts_template\') AS \\"Description\\"\\nFROM pg_catalog.pg_ts_template t\\nLEFT JOIN pg_catalog.pg_namespace n ON n.oid = t.tmplnamespace\\nWHERE pg_catalog.pg_ts_template_is_visible(t.oid)\\nORDER BY 1, 2;\\n"},{"cmd":"\\\\dg","opts":"[S+]","desc":"list roles","query":"\\nSELECT r.rolname, r.rolsuper, r.rolinherit,\\n  r.rolcreaterole, r.rolcreatedb, r.rolcanlogin,\\n  r.rolconnlimit, r.rolvaliduntil,\\n  ARRAY(SELECT b.rolname\\n        FROM pg_catalog.pg_auth_members m\\n        JOIN pg_catalog.pg_roles b ON (m.roleid = b.oid)\\n        WHERE m.member = r.oid) as memberof\\n, r.rolreplication\\n, r.rolbypassrls\\nFROM pg_catalog.pg_roles r\\nWHERE r.rolname !~ \'^pg_\'\\nORDER BY 1;\\n"},{"cmd":"\\\\dgS","opts":"[S+]","desc":"list roles","query":"\\nSELECT r.rolname, r.rolsuper, r.rolinherit,\\n  r.rolcreaterole, r.rolcreatedb, r.rolcanlogin,\\n  r.rolconnlimit, r.rolvaliduntil,\\n  ARRAY(SELECT b.rolname\\n        FROM pg_catalog.pg_auth_members m\\n        JOIN pg_catalog.pg_roles b ON (m.roleid = b.oid)\\n        WHERE m.member = r.oid) as memberof\\n, r.rolreplication\\n, r.rolbypassrls\\nFROM pg_catalog.pg_roles r\\nORDER BY 1;\\n"},{"cmd":"\\\\dgS+","opts":"[S+]","desc":"list roles","query":"\\nSELECT r.rolname, r.rolsuper, r.rolinherit,\\n  r.rolcreaterole, r.rolcreatedb, r.rolcanlogin,\\n  r.rolconnlimit, r.rolvaliduntil,\\n  ARRAY(SELECT b.rolname\\n        FROM pg_catalog.pg_auth_members m\\n        JOIN pg_catalog.pg_roles b ON (m.roleid = b.oid)\\n        WHERE m.member = r.oid) as memberof\\n, pg_catalog.shobj_description(r.oid, \'pg_authid\') AS description\\n, r.rolreplication\\n, r.rolbypassrls\\nFROM pg_catalog.pg_roles r\\nORDER BY 1;\\n"},{"cmd":"\\\\di","opts":"[S+]","desc":"list indexes","query":"\\nSELECT n.nspname as \\"Schema\\",\\n  c.relname as \\"Name\\",\\n  CASE c.relkind WHEN \'r\' THEN \'table\' WHEN \'v\' THEN \'view\' WHEN \'m\' THEN \'materialized view\' WHEN \'i\' THEN \'index\' WHEN \'S\' THEN \'sequence\' WHEN \'s\' THEN \'special\' WHEN \'t\' THEN \'TOAST table\' WHEN \'f\' THEN \'foreign table\' WHEN \'p\' THEN \'partitioned table\' WHEN \'I\' THEN \'partitioned index\' END as \\"Type\\",\\n  pg_catalog.pg_get_userbyid(c.relowner) as \\"Owner\\",\\n  c2.relname as \\"Table\\"\\nFROM pg_catalog.pg_class c\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace\\n     LEFT JOIN pg_catalog.pg_am am ON am.oid = c.relam\\n     LEFT JOIN pg_catalog.pg_index i ON i.indexrelid = c.oid\\n     LEFT JOIN pg_catalog.pg_class c2 ON i.indrelid = c2.oid\\nWHERE c.relkind IN (\'i\',\'I\',\'\')\\n      AND n.nspname <> \'pg_catalog\'\\n      AND n.nspname !~ \'^pg_toast\'\\n      AND n.nspname <> \'information_schema\'\\n  AND pg_catalog.pg_table_is_visible(c.oid)\\nORDER BY 1,2;\\n"},{"cmd":"\\\\diS","opts":"[S+]","desc":"list indexes","query":"\\nSELECT n.nspname as \\"Schema\\",\\n  c.relname as \\"Name\\",\\n  CASE c.relkind WHEN \'r\' THEN \'table\' WHEN \'v\' THEN \'view\' WHEN \'m\' THEN \'materialized view\' WHEN \'i\' THEN \'index\' WHEN \'S\' THEN \'sequence\' WHEN \'s\' THEN \'special\' WHEN \'t\' THEN \'TOAST table\' WHEN \'f\' THEN \'foreign table\' WHEN \'p\' THEN \'partitioned table\' WHEN \'I\' THEN \'partitioned index\' END as \\"Type\\",\\n  pg_catalog.pg_get_userbyid(c.relowner) as \\"Owner\\",\\n  c2.relname as \\"Table\\"\\nFROM pg_catalog.pg_class c\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace\\n     LEFT JOIN pg_catalog.pg_am am ON am.oid = c.relam\\n     LEFT JOIN pg_catalog.pg_index i ON i.indexrelid = c.oid\\n     LEFT JOIN pg_catalog.pg_class c2 ON i.indrelid = c2.oid\\nWHERE c.relkind IN (\'i\',\'I\',\'s\',\'\')\\n  AND pg_catalog.pg_table_is_visible(c.oid)\\nORDER BY 1,2;\\n"},{"cmd":"\\\\diS+","opts":"[S+]","desc":"list indexes","query":"\\nSELECT n.nspname as \\"Schema\\",\\n  c.relname as \\"Name\\",\\n  CASE c.relkind WHEN \'r\' THEN \'table\' WHEN \'v\' THEN \'view\' WHEN \'m\' THEN \'materialized view\' WHEN \'i\' THEN \'index\' WHEN \'S\' THEN \'sequence\' WHEN \'s\' THEN \'special\' WHEN \'t\' THEN \'TOAST table\' WHEN \'f\' THEN \'foreign table\' WHEN \'p\' THEN \'partitioned table\' WHEN \'I\' THEN \'partitioned index\' END as \\"Type\\",\\n  pg_catalog.pg_get_userbyid(c.relowner) as \\"Owner\\",\\n  c2.relname as \\"Table\\",\\n  CASE c.relpersistence WHEN \'p\' THEN \'permanent\' WHEN \'t\' THEN \'temporary\' WHEN \'u\' THEN \'unlogged\' END as \\"Persistence\\",\\n  am.amname as \\"Access method\\",\\n  pg_catalog.pg_size_pretty(pg_catalog.pg_table_size(c.oid)) as \\"Size\\",\\n  pg_catalog.obj_description(c.oid, \'pg_class\') as \\"Description\\"\\nFROM pg_catalog.pg_class c\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace\\n     LEFT JOIN pg_catalog.pg_am am ON am.oid = c.relam\\n     LEFT JOIN pg_catalog.pg_index i ON i.indexrelid = c.oid\\n     LEFT JOIN pg_catalog.pg_class c2 ON i.indrelid = c2.oid\\nWHERE c.relkind IN (\'i\',\'I\',\'s\',\'\')\\n  AND pg_catalog.pg_table_is_visible(c.oid)\\nORDER BY 1,2;\\n"},{"cmd":"\\\\dl","desc":"list large objects, same as lo_list","query":"\\nSELECT oid as \\"ID\\",\\n  pg_catalog.pg_get_userbyid(lomowner) as \\"Owner\\",\\n  pg_catalog.obj_description(oid, \'pg_largeobject\') as \\"Description\\"\\n  FROM pg_catalog.pg_largeobject_metadata   ORDER BY oid\\n"},{"cmd":"\\\\dL","opts":"[S+]","desc":"list procedural languages","query":"\\nSELECT l.lanname AS \\"Name\\",\\n       pg_catalog.pg_get_userbyid(l.lanowner) as \\"Owner\\",\\n       l.lanpltrusted AS \\"Trusted\\",\\n       d.description AS \\"Description\\"\\nFROM pg_catalog.pg_language l\\nLEFT JOIN pg_catalog.pg_description d\\n  ON d.classoid = l.tableoid AND d.objoid = l.oid\\n  AND d.objsubid = 0\\nWHERE l.lanplcallfoid != 0\\nORDER BY 1;\\n"},{"cmd":"\\\\dLS","opts":"[S+]","desc":"list procedural languages","query":"\\nSELECT l.lanname AS \\"Name\\",\\n       pg_catalog.pg_get_userbyid(l.lanowner) as \\"Owner\\",\\n       l.lanpltrusted AS \\"Trusted\\",\\n       d.description AS \\"Description\\"\\nFROM pg_catalog.pg_language l\\nLEFT JOIN pg_catalog.pg_description d\\n  ON d.classoid = l.tableoid AND d.objoid = l.oid\\n  AND d.objsubid = 0\\nORDER BY 1;\\n"},{"cmd":"\\\\dLS+","opts":"[S+]","desc":"list procedural languages","query":"\\nSELECT l.lanname AS \\"Name\\",\\n       pg_catalog.pg_get_userbyid(l.lanowner) as \\"Owner\\",\\n       l.lanpltrusted AS \\"Trusted\\",\\n       NOT l.lanispl AS \\"Internal language\\",\\n       l.lanplcallfoid::pg_catalog.regprocedure AS \\"Call handler\\",\\n       l.lanvalidator::pg_catalog.regprocedure AS \\"Validator\\",\\n       l.laninline::pg_catalog.regprocedure AS \\"Inline handler\\",\\n       pg_catalog.array_to_string(l.lanacl, E\'\\\\n\') AS \\"Access privileges\\",\\n       d.description AS \\"Description\\"\\nFROM pg_catalog.pg_language l\\nLEFT JOIN pg_catalog.pg_description d\\n  ON d.classoid = l.tableoid AND d.objoid = l.oid\\n  AND d.objsubid = 0\\nORDER BY 1;\\n"},{"cmd":"\\\\dm","opts":"[S+]","desc":"list materialized views","query":"\\nSELECT n.nspname as \\"Schema\\",\\n  c.relname as \\"Name\\",\\n  CASE c.relkind WHEN \'r\' THEN \'table\' WHEN \'v\' THEN \'view\' WHEN \'m\' THEN \'materialized view\' WHEN \'i\' THEN \'index\' WHEN \'S\' THEN \'sequence\' WHEN \'s\' THEN \'special\' WHEN \'t\' THEN \'TOAST table\' WHEN \'f\' THEN \'foreign table\' WHEN \'p\' THEN \'partitioned table\' WHEN \'I\' THEN \'partitioned index\' END as \\"Type\\",\\n  pg_catalog.pg_get_userbyid(c.relowner) as \\"Owner\\"\\nFROM pg_catalog.pg_class c\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace\\n     LEFT JOIN pg_catalog.pg_am am ON am.oid = c.relam\\nWHERE c.relkind IN (\'m\',\'\')\\n      AND n.nspname <> \'pg_catalog\'\\n      AND n.nspname !~ \'^pg_toast\'\\n      AND n.nspname <> \'information_schema\'\\n  AND pg_catalog.pg_table_is_visible(c.oid)\\nORDER BY 1,2;\\n"},{"cmd":"\\\\dmS","opts":"[S+]","desc":"list materialized views","query":"\\nSELECT n.nspname as \\"Schema\\",\\n  c.relname as \\"Name\\",\\n  CASE c.relkind WHEN \'r\' THEN \'table\' WHEN \'v\' THEN \'view\' WHEN \'m\' THEN \'materialized view\' WHEN \'i\' THEN \'index\' WHEN \'S\' THEN \'sequence\' WHEN \'s\' THEN \'special\' WHEN \'t\' THEN \'TOAST table\' WHEN \'f\' THEN \'foreign table\' WHEN \'p\' THEN \'partitioned table\' WHEN \'I\' THEN \'partitioned index\' END as \\"Type\\",\\n  pg_catalog.pg_get_userbyid(c.relowner) as \\"Owner\\"\\nFROM pg_catalog.pg_class c\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace\\n     LEFT JOIN pg_catalog.pg_am am ON am.oid = c.relam\\nWHERE c.relkind IN (\'m\',\'s\',\'\')\\n  AND pg_catalog.pg_table_is_visible(c.oid)\\nORDER BY 1,2;\\n"},{"cmd":"\\\\dmS+","opts":"[S+]","desc":"list materialized views","query":"\\nSELECT n.nspname as \\"Schema\\",\\n  c.relname as \\"Name\\",\\n  CASE c.relkind WHEN \'r\' THEN \'table\' WHEN \'v\' THEN \'view\' WHEN \'m\' THEN \'materialized view\' WHEN \'i\' THEN \'index\' WHEN \'S\' THEN \'sequence\' WHEN \'s\' THEN \'special\' WHEN \'t\' THEN \'TOAST table\' WHEN \'f\' THEN \'foreign table\' WHEN \'p\' THEN \'partitioned table\' WHEN \'I\' THEN \'partitioned index\' END as \\"Type\\",\\n  pg_catalog.pg_get_userbyid(c.relowner) as \\"Owner\\",\\n  CASE c.relpersistence WHEN \'p\' THEN \'permanent\' WHEN \'t\' THEN \'temporary\' WHEN \'u\' THEN \'unlogged\' END as \\"Persistence\\",\\n  am.amname as \\"Access method\\",\\n  pg_catalog.pg_size_pretty(pg_catalog.pg_table_size(c.oid)) as \\"Size\\",\\n  pg_catalog.obj_description(c.oid, \'pg_class\') as \\"Description\\"\\nFROM pg_catalog.pg_class c\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace\\n     LEFT JOIN pg_catalog.pg_am am ON am.oid = c.relam\\nWHERE c.relkind IN (\'m\',\'s\',\'\')\\n  AND pg_catalog.pg_table_is_visible(c.oid)\\nORDER BY 1,2;\\n"},{"cmd":"\\\\dn","opts":"[S+]","desc":"list schemas","query":"\\nSELECT n.nspname AS \\"Name\\",\\n  pg_catalog.pg_get_userbyid(n.nspowner) AS \\"Owner\\"\\nFROM pg_catalog.pg_namespace n\\nWHERE n.nspname !~ \'^pg_\' AND n.nspname <> \'information_schema\'\\nORDER BY 1;\\n"},{"cmd":"\\\\dnS","opts":"[S+]","desc":"list schemas","query":"\\nSELECT n.nspname AS \\"Name\\",\\n  pg_catalog.pg_get_userbyid(n.nspowner) AS \\"Owner\\"\\nFROM pg_catalog.pg_namespace n\\nORDER BY 1;\\n"},{"cmd":"\\\\dnS+","opts":"[S+]","desc":"list schemas","query":"\\nSELECT n.nspname AS \\"Name\\",\\n  pg_catalog.pg_get_userbyid(n.nspowner) AS \\"Owner\\",\\n  pg_catalog.array_to_string(n.nspacl, E\'\\\\n\') AS \\"Access privileges\\",\\n  pg_catalog.obj_description(n.oid, \'pg_namespace\') AS \\"Description\\"\\nFROM pg_catalog.pg_namespace n\\nORDER BY 1;\\n"},{"cmd":"\\\\do","opts":"[S+]","desc":"list operators","query":"\\nSELECT n.nspname as \\"Schema\\",\\n  o.oprname AS \\"Name\\",\\n  CASE WHEN o.oprkind=\'l\' THEN NULL ELSE pg_catalog.format_type(o.oprleft, NULL) END AS \\"Left arg type\\",\\n  CASE WHEN o.oprkind=\'r\' THEN NULL ELSE pg_catalog.format_type(o.oprright, NULL) END AS \\"Right arg type\\",\\n  pg_catalog.format_type(o.oprresult, NULL) AS \\"Result type\\",\\n  coalesce(pg_catalog.obj_description(o.oid, \'pg_operator\'),\\n           pg_catalog.obj_description(o.oprcode, \'pg_proc\')) AS \\"Description\\"\\nFROM pg_catalog.pg_operator o\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = o.oprnamespace\\nWHERE n.nspname <> \'pg_catalog\'\\n      AND n.nspname <> \'information_schema\'\\n  AND pg_catalog.pg_operator_is_visible(o.oid)\\nORDER BY 1, 2, 3, 4;\\n"},{"cmd":"\\\\doS","opts":"[S+]","desc":"list operators","query":"\\nSELECT n.nspname as \\"Schema\\",\\n  o.oprname AS \\"Name\\",\\n  CASE WHEN o.oprkind=\'l\' THEN NULL ELSE pg_catalog.format_type(o.oprleft, NULL) END AS \\"Left arg type\\",\\n  CASE WHEN o.oprkind=\'r\' THEN NULL ELSE pg_catalog.format_type(o.oprright, NULL) END AS \\"Right arg type\\",\\n  pg_catalog.format_type(o.oprresult, NULL) AS \\"Result type\\",\\n  coalesce(pg_catalog.obj_description(o.oid, \'pg_operator\'),\\n           pg_catalog.obj_description(o.oprcode, \'pg_proc\')) AS \\"Description\\"\\nFROM pg_catalog.pg_operator o\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = o.oprnamespace\\nWHERE pg_catalog.pg_operator_is_visible(o.oid)\\nORDER BY 1, 2, 3, 4;\\n"},{"cmd":"\\\\doS+","opts":"[S+]","desc":"list operators","query":"\\nSELECT n.nspname as \\"Schema\\",\\n  o.oprname AS \\"Name\\",\\n  CASE WHEN o.oprkind=\'l\' THEN NULL ELSE pg_catalog.format_type(o.oprleft, NULL) END AS \\"Left arg type\\",\\n  CASE WHEN o.oprkind=\'r\' THEN NULL ELSE pg_catalog.format_type(o.oprright, NULL) END AS \\"Right arg type\\",\\n  pg_catalog.format_type(o.oprresult, NULL) AS \\"Result type\\",\\n  o.oprcode AS \\"Function\\",\\n  coalesce(pg_catalog.obj_description(o.oid, \'pg_operator\'),\\n           pg_catalog.obj_description(o.oprcode, \'pg_proc\')) AS \\"Description\\"\\nFROM pg_catalog.pg_operator o\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = o.oprnamespace\\nWHERE pg_catalog.pg_operator_is_visible(o.oid)\\nORDER BY 1, 2, 3, 4;\\n"},{"cmd":"\\\\dO","opts":"[S+]","desc":"list collations","query":"\\nSELECT n.nspname AS \\"Schema\\",\\n       c.collname AS \\"Name\\",\\n       c.collcollate AS \\"Collate\\",\\n       c.collctype AS \\"Ctype\\",\\n       CASE c.collprovider WHEN \'d\' THEN \'default\' WHEN \'c\' THEN \'libc\' WHEN \'i\' THEN \'icu\' END AS \\"Provider\\",\\n       CASE WHEN c.collisdeterministic THEN \'yes\' ELSE \'no\' END AS \\"Deterministic?\\"\\nFROM pg_catalog.pg_collation c, pg_catalog.pg_namespace n\\nWHERE n.oid = c.collnamespace\\n      AND n.nspname <> \'pg_catalog\'\\n      AND n.nspname <> \'information_schema\'\\n      AND c.collencoding IN (-1, pg_catalog.pg_char_to_encoding(pg_catalog.getdatabaseencoding()))\\n  AND pg_catalog.pg_collation_is_visible(c.oid)\\nORDER BY 1, 2;\\n"},{"cmd":"\\\\dOS","opts":"[S+]","desc":"list collations","query":"\\nSELECT n.nspname AS \\"Schema\\",\\n       c.collname AS \\"Name\\",\\n       c.collcollate AS \\"Collate\\",\\n       c.collctype AS \\"Ctype\\",\\n       CASE c.collprovider WHEN \'d\' THEN \'default\' WHEN \'c\' THEN \'libc\' WHEN \'i\' THEN \'icu\' END AS \\"Provider\\",\\n       CASE WHEN c.collisdeterministic THEN \'yes\' ELSE \'no\' END AS \\"Deterministic?\\"\\nFROM pg_catalog.pg_collation c, pg_catalog.pg_namespace n\\nWHERE n.oid = c.collnamespace\\n      AND c.collencoding IN (-1, pg_catalog.pg_char_to_encoding(pg_catalog.getdatabaseencoding()))\\n  AND pg_catalog.pg_collation_is_visible(c.oid)\\nORDER BY 1, 2;\\n"},{"cmd":"\\\\dOS+","opts":"[S+]","desc":"list collations","query":"\\nSELECT n.nspname AS \\"Schema\\",\\n       c.collname AS \\"Name\\",\\n       c.collcollate AS \\"Collate\\",\\n       c.collctype AS \\"Ctype\\",\\n       CASE c.collprovider WHEN \'d\' THEN \'default\' WHEN \'c\' THEN \'libc\' WHEN \'i\' THEN \'icu\' END AS \\"Provider\\",\\n       CASE WHEN c.collisdeterministic THEN \'yes\' ELSE \'no\' END AS \\"Deterministic?\\",\\n       pg_catalog.obj_description(c.oid, \'pg_collation\') AS \\"Description\\"\\nFROM pg_catalog.pg_collation c, pg_catalog.pg_namespace n\\nWHERE n.oid = c.collnamespace\\n      AND c.collencoding IN (-1, pg_catalog.pg_char_to_encoding(pg_catalog.getdatabaseencoding()))\\n  AND pg_catalog.pg_collation_is_visible(c.oid)\\nORDER BY 1, 2;\\n"},{"cmd":"\\\\dp","desc":"list table, view, and sequence access privileges","query":"\\nSELECT n.nspname as \\"Schema\\",\\n  c.relname as \\"Name\\",\\n  CASE c.relkind WHEN \'r\' THEN \'table\' WHEN \'v\' THEN \'view\' WHEN \'m\' THEN \'materialized view\' WHEN \'S\' THEN \'sequence\' WHEN \'f\' THEN \'foreign table\' WHEN \'p\' THEN \'partitioned table\' END as \\"Type\\",\\n  pg_catalog.array_to_string(c.relacl, E\'\\\\n\') AS \\"Access privileges\\",\\n  pg_catalog.array_to_string(ARRAY(\\n    SELECT attname || E\':\\\\n  \' || pg_catalog.array_to_string(attacl, E\'\\\\n  \')\\n    FROM pg_catalog.pg_attribute a\\n    WHERE attrelid = c.oid AND NOT attisdropped AND attacl IS NOT NULL\\n  ), E\'\\\\n\') AS \\"Column privileges\\",\\n  pg_catalog.array_to_string(ARRAY(\\n    SELECT polname\\n    || CASE WHEN NOT polpermissive THEN\\n       E\' (RESTRICTIVE)\'\\n       ELSE \'\' END\\n    || CASE WHEN polcmd != \'*\' THEN\\n           E\' (\' || polcmd || E\'):\'\\n       ELSE E\':\'\\n       END\\n    || CASE WHEN polqual IS NOT NULL THEN\\n           E\'\\\\n  (u): \' || pg_catalog.pg_get_expr(polqual, polrelid)\\n       ELSE E\'\'\\n       END\\n    || CASE WHEN polwithcheck IS NOT NULL THEN\\n           E\'\\\\n  (c): \' || pg_catalog.pg_get_expr(polwithcheck, polrelid)\\n       ELSE E\'\'\\n       END    || CASE WHEN polroles <> \'{0}\' THEN\\n           E\'\\\\n  to: \' || pg_catalog.array_to_string(\\n               ARRAY(\\n                   SELECT rolname\\n                   FROM pg_catalog.pg_roles\\n                   WHERE oid = ANY (polroles)\\n                   ORDER BY 1\\n               ), E\', \')\\n       ELSE E\'\'\\n       END\\n    FROM pg_catalog.pg_policy pol\\n    WHERE polrelid = c.oid), E\'\\\\n\')\\n    AS \\"Policies\\"\\nFROM pg_catalog.pg_class c\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace\\nWHERE c.relkind IN (\'r\',\'v\',\'m\',\'S\',\'f\',\'p\')\\n  AND n.nspname !~ \'^pg_\' AND pg_catalog.pg_table_is_visible(c.oid)\\nORDER BY 1, 2;\\n"},{"cmd":"\\\\dP","opts":"[itn+]","desc":"list [only index/table] partitioned relations [n=nested]","query":"\\nSELECT n.nspname as \\"Schema\\",\\n  c.relname as \\"Name\\",\\n  pg_catalog.pg_get_userbyid(c.relowner) as \\"Owner\\",\\n  CASE c.relkind WHEN \'p\' THEN \'partitioned table\' WHEN \'I\' THEN \'partitioned index\' END as \\"Type\\",\\n c2.oid::pg_catalog.regclass as \\"Table\\"\\nFROM pg_catalog.pg_class c\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace\\n     LEFT JOIN pg_catalog.pg_index i ON i.indexrelid = c.oid\\n     LEFT JOIN pg_catalog.pg_class c2 ON i.indrelid = c2.oid\\nWHERE c.relkind IN (\'p\',\'I\',\'\')\\n AND NOT c.relispartition\\n      AND n.nspname <> \'pg_catalog\'\\n      AND n.nspname !~ \'^pg_toast\'\\n      AND n.nspname <> \'information_schema\'\\n  AND pg_catalog.pg_table_is_visible(c.oid)\\nORDER BY \\"Schema\\", \\"Type\\" DESC, \\"Name\\";\\n"},{"cmd":"\\\\dPi","opts":"[itn+]","desc":"list [only index/table] partitioned relations [n=nested]","query":"\\nSELECT n.nspname as \\"Schema\\",\\n  c.relname as \\"Name\\",\\n  pg_catalog.pg_get_userbyid(c.relowner) as \\"Owner\\",\\n c2.oid::pg_catalog.regclass as \\"Table\\"\\nFROM pg_catalog.pg_class c\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace\\n     LEFT JOIN pg_catalog.pg_index i ON i.indexrelid = c.oid\\n     LEFT JOIN pg_catalog.pg_class c2 ON i.indrelid = c2.oid\\nWHERE c.relkind IN (\'I\',\'\')\\n AND NOT c.relispartition\\n      AND n.nspname <> \'pg_catalog\'\\n      AND n.nspname !~ \'^pg_toast\'\\n      AND n.nspname <> \'information_schema\'\\n  AND pg_catalog.pg_table_is_visible(c.oid)\\nORDER BY \\"Schema\\", \\"Name\\";\\n"},{"cmd":"\\\\dPit","opts":"[itn+]","desc":"list [only index/table] partitioned relations [n=nested]","query":"\\nSELECT n.nspname as \\"Schema\\",\\n  c.relname as \\"Name\\",\\n  pg_catalog.pg_get_userbyid(c.relowner) as \\"Owner\\",\\n  CASE c.relkind WHEN \'p\' THEN \'partitioned table\' WHEN \'I\' THEN \'partitioned index\' END as \\"Type\\",\\n c2.oid::pg_catalog.regclass as \\"Table\\"\\nFROM pg_catalog.pg_class c\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace\\n     LEFT JOIN pg_catalog.pg_index i ON i.indexrelid = c.oid\\n     LEFT JOIN pg_catalog.pg_class c2 ON i.indrelid = c2.oid\\nWHERE c.relkind IN (\'p\',\'I\',\'\')\\n AND NOT c.relispartition\\n      AND n.nspname <> \'pg_catalog\'\\n      AND n.nspname !~ \'^pg_toast\'\\n      AND n.nspname <> \'information_schema\'\\n  AND pg_catalog.pg_table_is_visible(c.oid)\\nORDER BY \\"Schema\\", \\"Type\\" DESC, \\"Name\\";\\n"},{"cmd":"\\\\dPitn","opts":"[itn+]","desc":"list [only index/table] partitioned relations [n=nested]","query":"\\nSELECT n.nspname as \\"Schema\\",\\n  c.relname as \\"Name\\",\\n  pg_catalog.pg_get_userbyid(c.relowner) as \\"Owner\\",\\n  CASE c.relkind WHEN \'p\' THEN \'partitioned table\' WHEN \'I\' THEN \'partitioned index\' END as \\"Type\\",\\n  inh.inhparent::pg_catalog.regclass as \\"Parent name\\",\\n c2.oid::pg_catalog.regclass as \\"Table\\"\\nFROM pg_catalog.pg_class c\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace\\n     LEFT JOIN pg_catalog.pg_index i ON i.indexrelid = c.oid\\n     LEFT JOIN pg_catalog.pg_class c2 ON i.indrelid = c2.oid\\n     LEFT JOIN pg_catalog.pg_inherits inh ON c.oid = inh.inhrelid\\nWHERE c.relkind IN (\'p\',\'I\',\'\')\\n      AND n.nspname <> \'pg_catalog\'\\n      AND n.nspname !~ \'^pg_toast\'\\n      AND n.nspname <> \'information_schema\'\\n  AND pg_catalog.pg_table_is_visible(c.oid)\\nORDER BY \\"Schema\\", \\"Type\\" DESC, \\"Parent name\\" NULLS FIRST, \\"Name\\";\\n"},{"cmd":"\\\\dPitn+","opts":"[itn+]","desc":"list [only index/table] partitioned relations [n=nested]","query":"\\nSELECT n.nspname as \\"Schema\\",\\n  c.relname as \\"Name\\",\\n  pg_catalog.pg_get_userbyid(c.relowner) as \\"Owner\\",\\n  CASE c.relkind WHEN \'p\' THEN \'partitioned table\' WHEN \'I\' THEN \'partitioned index\' END as \\"Type\\",\\n  inh.inhparent::pg_catalog.regclass as \\"Parent name\\",\\n c2.oid::pg_catalog.regclass as \\"Table\\",\\n  s.dps as \\"Leaf partition size\\",\\n  s.tps as \\"Total size\\",\\n  pg_catalog.obj_description(c.oid, \'pg_class\') as \\"Description\\"\\nFROM pg_catalog.pg_class c\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace\\n     LEFT JOIN pg_catalog.pg_index i ON i.indexrelid = c.oid\\n     LEFT JOIN pg_catalog.pg_class c2 ON i.indrelid = c2.oid\\n     LEFT JOIN pg_catalog.pg_inherits inh ON c.oid = inh.inhrelid,\\n     LATERAL (SELECT pg_catalog.pg_size_pretty(sum(\\n                 CASE WHEN ppt.isleaf AND ppt.level = 1\\n                      THEN pg_catalog.pg_table_size(ppt.relid) ELSE 0 END)) AS dps,\\n                     pg_catalog.pg_size_pretty(sum(pg_catalog.pg_table_size(ppt.relid))) AS tps\\n              FROM pg_catalog.pg_partition_tree(c.oid) ppt) s\\nWHERE c.relkind IN (\'p\',\'I\',\'\')\\n      AND n.nspname <> \'pg_catalog\'\\n      AND n.nspname !~ \'^pg_toast\'\\n      AND n.nspname <> \'information_schema\'\\n  AND pg_catalog.pg_table_is_visible(c.oid)\\nORDER BY \\"Schema\\", \\"Type\\" DESC, \\"Parent name\\" NULLS FIRST, \\"Name\\";\\n"},{"cmd":"\\\\drds","desc":"list per-database role settings","query":"\\nSELECT rolname AS \\"Role\\", datname AS \\"Database\\",\\npg_catalog.array_to_string(setconfig, E\'\\\\n\') AS \\"Settings\\"\\nFROM pg_catalog.pg_db_role_setting s\\nLEFT JOIN pg_catalog.pg_database d ON d.oid = setdatabase\\nLEFT JOIN pg_catalog.pg_roles r ON r.oid = setrole\\nORDER BY 1, 2;\\n"},{"cmd":"\\\\dRp","opts":"[+]","desc":"list replication publications","query":"\\nSELECT pubname AS \\"Name\\",\\n  pg_catalog.pg_get_userbyid(pubowner) AS \\"Owner\\",\\n  puballtables AS \\"All tables\\",\\n  pubinsert AS \\"Inserts\\",\\n  pubupdate AS \\"Updates\\",\\n  pubdelete AS \\"Deletes\\",\\n  pubtruncate AS \\"Truncates\\"\\nFROM pg_catalog.pg_publication\\nORDER BY 1;\\n"},{"cmd":"\\\\dRs","opts":"[+]","desc":"list replication subscriptions","query":"\\nSELECT subname AS \\"Name\\"\\n,  pg_catalog.pg_get_userbyid(subowner) AS \\"Owner\\"\\n,  subenabled AS \\"Enabled\\"\\n,  subpublications AS \\"Publication\\"\\nFROM pg_catalog.pg_subscription\\nWHERE subdbid = (SELECT oid\\n                 FROM pg_catalog.pg_database\\n                 WHERE datname = pg_catalog.current_database())ORDER BY 1;\\n"},{"cmd":"\\\\dRs+","opts":"[+]","desc":"list replication subscriptions","query":"\\nSELECT subname AS \\"Name\\"\\n,  pg_catalog.pg_get_userbyid(subowner) AS \\"Owner\\"\\n,  subenabled AS \\"Enabled\\"\\n,  subpublications AS \\"Publication\\"\\n,  subsynccommit AS \\"Synchronous commit\\"\\n,  subconninfo AS \\"Conninfo\\"\\nFROM pg_catalog.pg_subscription\\nWHERE subdbid = (SELECT oid\\n                 FROM pg_catalog.pg_database\\n                 WHERE datname = pg_catalog.current_database())ORDER BY 1;\\n"},{"cmd":"\\\\ds","opts":"[S+]","desc":"list sequences","query":"\\nSELECT n.nspname as \\"Schema\\",\\n  c.relname as \\"Name\\",\\n  CASE c.relkind WHEN \'r\' THEN \'table\' WHEN \'v\' THEN \'view\' WHEN \'m\' THEN \'materialized view\' WHEN \'i\' THEN \'index\' WHEN \'S\' THEN \'sequence\' WHEN \'s\' THEN \'special\' WHEN \'t\' THEN \'TOAST table\' WHEN \'f\' THEN \'foreign table\' WHEN \'p\' THEN \'partitioned table\' WHEN \'I\' THEN \'partitioned index\' END as \\"Type\\",\\n  pg_catalog.pg_get_userbyid(c.relowner) as \\"Owner\\"\\nFROM pg_catalog.pg_class c\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace\\nWHERE c.relkind IN (\'S\',\'\')\\n      AND n.nspname <> \'pg_catalog\'\\n      AND n.nspname !~ \'^pg_toast\'\\n      AND n.nspname <> \'information_schema\'\\n  AND pg_catalog.pg_table_is_visible(c.oid)\\nORDER BY 1,2;\\n"},{"cmd":"\\\\dsS","opts":"[S+]","desc":"list sequences","query":"\\nSELECT n.nspname as \\"Schema\\",\\n  c.relname as \\"Name\\",\\n  CASE c.relkind WHEN \'r\' THEN \'table\' WHEN \'v\' THEN \'view\' WHEN \'m\' THEN \'materialized view\' WHEN \'i\' THEN \'index\' WHEN \'S\' THEN \'sequence\' WHEN \'s\' THEN \'special\' WHEN \'t\' THEN \'TOAST table\' WHEN \'f\' THEN \'foreign table\' WHEN \'p\' THEN \'partitioned table\' WHEN \'I\' THEN \'partitioned index\' END as \\"Type\\",\\n  pg_catalog.pg_get_userbyid(c.relowner) as \\"Owner\\"\\nFROM pg_catalog.pg_class c\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace\\nWHERE c.relkind IN (\'S\',\'s\',\'\')\\n  AND pg_catalog.pg_table_is_visible(c.oid)\\nORDER BY 1,2;\\n"},{"cmd":"\\\\dsS+","opts":"[S+]","desc":"list sequences","query":"\\nSELECT n.nspname as \\"Schema\\",\\n  c.relname as \\"Name\\",\\n  CASE c.relkind WHEN \'r\' THEN \'table\' WHEN \'v\' THEN \'view\' WHEN \'m\' THEN \'materialized view\' WHEN \'i\' THEN \'index\' WHEN \'S\' THEN \'sequence\' WHEN \'s\' THEN \'special\' WHEN \'t\' THEN \'TOAST table\' WHEN \'f\' THEN \'foreign table\' WHEN \'p\' THEN \'partitioned table\' WHEN \'I\' THEN \'partitioned index\' END as \\"Type\\",\\n  pg_catalog.pg_get_userbyid(c.relowner) as \\"Owner\\",\\n  CASE c.relpersistence WHEN \'p\' THEN \'permanent\' WHEN \'t\' THEN \'temporary\' WHEN \'u\' THEN \'unlogged\' END as \\"Persistence\\",\\n  pg_catalog.pg_size_pretty(pg_catalog.pg_table_size(c.oid)) as \\"Size\\",\\n  pg_catalog.obj_description(c.oid, \'pg_class\') as \\"Description\\"\\nFROM pg_catalog.pg_class c\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace\\nWHERE c.relkind IN (\'S\',\'s\',\'\')\\n  AND pg_catalog.pg_table_is_visible(c.oid)\\nORDER BY 1,2;\\n"},{"cmd":"\\\\dt","opts":"[S+]","desc":"list tables","query":"\\nSELECT n.nspname as \\"Schema\\",\\n  c.relname as \\"Name\\",\\n  CASE c.relkind WHEN \'r\' THEN \'table\' WHEN \'v\' THEN \'view\' WHEN \'m\' THEN \'materialized view\' WHEN \'i\' THEN \'index\' WHEN \'S\' THEN \'sequence\' WHEN \'s\' THEN \'special\' WHEN \'t\' THEN \'TOAST table\' WHEN \'f\' THEN \'foreign table\' WHEN \'p\' THEN \'partitioned table\' WHEN \'I\' THEN \'partitioned index\' END as \\"Type\\",\\n  pg_catalog.pg_get_userbyid(c.relowner) as \\"Owner\\"\\nFROM pg_catalog.pg_class c\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace\\n     LEFT JOIN pg_catalog.pg_am am ON am.oid = c.relam\\nWHERE c.relkind IN (\'r\',\'p\',\'\')\\n      AND n.nspname <> \'pg_catalog\'\\n      AND n.nspname !~ \'^pg_toast\'\\n      AND n.nspname <> \'information_schema\'\\n  AND pg_catalog.pg_table_is_visible(c.oid)\\nORDER BY 1,2;\\n"},{"cmd":"\\\\dtS","opts":"[S+]","desc":"list tables","query":"\\nSELECT n.nspname as \\"Schema\\",\\n  c.relname as \\"Name\\",\\n  CASE c.relkind WHEN \'r\' THEN \'table\' WHEN \'v\' THEN \'view\' WHEN \'m\' THEN \'materialized view\' WHEN \'i\' THEN \'index\' WHEN \'S\' THEN \'sequence\' WHEN \'s\' THEN \'special\' WHEN \'t\' THEN \'TOAST table\' WHEN \'f\' THEN \'foreign table\' WHEN \'p\' THEN \'partitioned table\' WHEN \'I\' THEN \'partitioned index\' END as \\"Type\\",\\n  pg_catalog.pg_get_userbyid(c.relowner) as \\"Owner\\"\\nFROM pg_catalog.pg_class c\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace\\n     LEFT JOIN pg_catalog.pg_am am ON am.oid = c.relam\\nWHERE c.relkind IN (\'r\',\'p\',\'t\',\'s\',\'\')\\n  AND pg_catalog.pg_table_is_visible(c.oid)\\nORDER BY 1,2;\\n"},{"cmd":"\\\\dtS+","opts":"[S+]","desc":"list tables","query":"\\nSELECT n.nspname as \\"Schema\\",\\n  c.relname as \\"Name\\",\\n  CASE c.relkind WHEN \'r\' THEN \'table\' WHEN \'v\' THEN \'view\' WHEN \'m\' THEN \'materialized view\' WHEN \'i\' THEN \'index\' WHEN \'S\' THEN \'sequence\' WHEN \'s\' THEN \'special\' WHEN \'t\' THEN \'TOAST table\' WHEN \'f\' THEN \'foreign table\' WHEN \'p\' THEN \'partitioned table\' WHEN \'I\' THEN \'partitioned index\' END as \\"Type\\",\\n  pg_catalog.pg_get_userbyid(c.relowner) as \\"Owner\\",\\n  CASE c.relpersistence WHEN \'p\' THEN \'permanent\' WHEN \'t\' THEN \'temporary\' WHEN \'u\' THEN \'unlogged\' END as \\"Persistence\\",\\n  am.amname as \\"Access method\\",\\n  pg_catalog.pg_size_pretty(pg_catalog.pg_table_size(c.oid)) as \\"Size\\",\\n  pg_catalog.obj_description(c.oid, \'pg_class\') as \\"Description\\"\\nFROM pg_catalog.pg_class c\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace\\n     LEFT JOIN pg_catalog.pg_am am ON am.oid = c.relam\\nWHERE c.relkind IN (\'r\',\'p\',\'t\',\'s\',\'\')\\n  AND pg_catalog.pg_table_is_visible(c.oid)\\nORDER BY 1,2;\\n"},{"cmd":"\\\\dT","opts":"[S+]","desc":"list data types","query":"\\nSELECT n.nspname as \\"Schema\\",\\n  pg_catalog.format_type(t.oid, NULL) AS \\"Name\\",\\n  pg_catalog.obj_description(t.oid, \'pg_type\') as \\"Description\\"\\nFROM pg_catalog.pg_type t\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = t.typnamespace\\nWHERE (t.typrelid = 0 OR (SELECT c.relkind = \'c\' FROM pg_catalog.pg_class c WHERE c.oid = t.typrelid))\\n  AND NOT EXISTS(SELECT 1 FROM pg_catalog.pg_type el WHERE el.oid = t.typelem AND el.typarray = t.oid)\\n      AND n.nspname <> \'pg_catalog\'\\n      AND n.nspname <> \'information_schema\'\\n  AND pg_catalog.pg_type_is_visible(t.oid)\\nORDER BY 1, 2;\\n"},{"cmd":"\\\\dTS","opts":"[S+]","desc":"list data types","query":"\\nSELECT n.nspname as \\"Schema\\",\\n  pg_catalog.format_type(t.oid, NULL) AS \\"Name\\",\\n  pg_catalog.obj_description(t.oid, \'pg_type\') as \\"Description\\"\\nFROM pg_catalog.pg_type t\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = t.typnamespace\\nWHERE (t.typrelid = 0 OR (SELECT c.relkind = \'c\' FROM pg_catalog.pg_class c WHERE c.oid = t.typrelid))\\n  AND NOT EXISTS(SELECT 1 FROM pg_catalog.pg_type el WHERE el.oid = t.typelem AND el.typarray = t.oid)\\n  AND pg_catalog.pg_type_is_visible(t.oid)\\nORDER BY 1, 2;\\n"},{"cmd":"\\\\dTS+","opts":"[S+]","desc":"list data types","query":"\\nSELECT n.nspname as \\"Schema\\",\\n  pg_catalog.format_type(t.oid, NULL) AS \\"Name\\",\\n  t.typname AS \\"Internal name\\",\\n  CASE WHEN t.typrelid != 0\\n      THEN CAST(\'tuple\' AS pg_catalog.text)\\n    WHEN t.typlen < 0\\n      THEN CAST(\'var\' AS pg_catalog.text)\\n    ELSE CAST(t.typlen AS pg_catalog.text)\\n  END AS \\"Size\\",\\n  pg_catalog.array_to_string(\\n      ARRAY(\\n          SELECT e.enumlabel\\n          FROM pg_catalog.pg_enum e\\n          WHERE e.enumtypid = t.oid\\n          ORDER BY e.enumsortorder\\n      ),\\n      E\'\\\\n\'\\n  ) AS \\"Elements\\",\\n  pg_catalog.pg_get_userbyid(t.typowner) AS \\"Owner\\",\\npg_catalog.array_to_string(t.typacl, E\'\\\\n\') AS \\"Access privileges\\",\\n    pg_catalog.obj_description(t.oid, \'pg_type\') as \\"Description\\"\\nFROM pg_catalog.pg_type t\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = t.typnamespace\\nWHERE (t.typrelid = 0 OR (SELECT c.relkind = \'c\' FROM pg_catalog.pg_class c WHERE c.oid = t.typrelid))\\n  AND NOT EXISTS(SELECT 1 FROM pg_catalog.pg_type el WHERE el.oid = t.typelem AND el.typarray = t.oid)\\n  AND pg_catalog.pg_type_is_visible(t.oid)\\nORDER BY 1, 2;\\n"},{"cmd":"\\\\du","opts":"[S+]","desc":"list roles","query":"\\nSELECT r.rolname, r.rolsuper, r.rolinherit,\\n  r.rolcreaterole, r.rolcreatedb, r.rolcanlogin,\\n  r.rolconnlimit, r.rolvaliduntil,\\n  ARRAY(SELECT b.rolname\\n        FROM pg_catalog.pg_auth_members m\\n        JOIN pg_catalog.pg_roles b ON (m.roleid = b.oid)\\n        WHERE m.member = r.oid) as memberof\\n, r.rolreplication\\n, r.rolbypassrls\\nFROM pg_catalog.pg_roles r\\nWHERE r.rolname !~ \'^pg_\'\\nORDER BY 1;\\n"},{"cmd":"\\\\duS","opts":"[S+]","desc":"list roles","query":"\\nSELECT r.rolname, r.rolsuper, r.rolinherit,\\n  r.rolcreaterole, r.rolcreatedb, r.rolcanlogin,\\n  r.rolconnlimit, r.rolvaliduntil,\\n  ARRAY(SELECT b.rolname\\n        FROM pg_catalog.pg_auth_members m\\n        JOIN pg_catalog.pg_roles b ON (m.roleid = b.oid)\\n        WHERE m.member = r.oid) as memberof\\n, r.rolreplication\\n, r.rolbypassrls\\nFROM pg_catalog.pg_roles r\\nORDER BY 1;\\n"},{"cmd":"\\\\duS+","opts":"[S+]","desc":"list roles","query":"\\nSELECT r.rolname, r.rolsuper, r.rolinherit,\\n  r.rolcreaterole, r.rolcreatedb, r.rolcanlogin,\\n  r.rolconnlimit, r.rolvaliduntil,\\n  ARRAY(SELECT b.rolname\\n        FROM pg_catalog.pg_auth_members m\\n        JOIN pg_catalog.pg_roles b ON (m.roleid = b.oid)\\n        WHERE m.member = r.oid) as memberof\\n, pg_catalog.shobj_description(r.oid, \'pg_authid\') AS description\\n, r.rolreplication\\n, r.rolbypassrls\\nFROM pg_catalog.pg_roles r\\nORDER BY 1;\\n"},{"cmd":"\\\\dv","opts":"[S+]","desc":"list views","query":"\\nSELECT n.nspname as \\"Schema\\",\\n  c.relname as \\"Name\\",\\n  CASE c.relkind WHEN \'r\' THEN \'table\' WHEN \'v\' THEN \'view\' WHEN \'m\' THEN \'materialized view\' WHEN \'i\' THEN \'index\' WHEN \'S\' THEN \'sequence\' WHEN \'s\' THEN \'special\' WHEN \'t\' THEN \'TOAST table\' WHEN \'f\' THEN \'foreign table\' WHEN \'p\' THEN \'partitioned table\' WHEN \'I\' THEN \'partitioned index\' END as \\"Type\\",\\n  pg_catalog.pg_get_userbyid(c.relowner) as \\"Owner\\"\\nFROM pg_catalog.pg_class c\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace\\nWHERE c.relkind IN (\'v\',\'\')\\n      AND n.nspname <> \'pg_catalog\'\\n      AND n.nspname !~ \'^pg_toast\'\\n      AND n.nspname <> \'information_schema\'\\n  AND pg_catalog.pg_table_is_visible(c.oid)\\nORDER BY 1,2;\\n"},{"cmd":"\\\\dvS","opts":"[S+]","desc":"list views","query":"\\nSELECT n.nspname as \\"Schema\\",\\n  c.relname as \\"Name\\",\\n  CASE c.relkind WHEN \'r\' THEN \'table\' WHEN \'v\' THEN \'view\' WHEN \'m\' THEN \'materialized view\' WHEN \'i\' THEN \'index\' WHEN \'S\' THEN \'sequence\' WHEN \'s\' THEN \'special\' WHEN \'t\' THEN \'TOAST table\' WHEN \'f\' THEN \'foreign table\' WHEN \'p\' THEN \'partitioned table\' WHEN \'I\' THEN \'partitioned index\' END as \\"Type\\",\\n  pg_catalog.pg_get_userbyid(c.relowner) as \\"Owner\\"\\nFROM pg_catalog.pg_class c\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace\\nWHERE c.relkind IN (\'v\',\'s\',\'\')\\n  AND pg_catalog.pg_table_is_visible(c.oid)\\nORDER BY 1,2;\\n"},{"cmd":"\\\\dvS+","opts":"[S+]","desc":"list views","query":"\\nSELECT n.nspname as \\"Schema\\",\\n  c.relname as \\"Name\\",\\n  CASE c.relkind WHEN \'r\' THEN \'table\' WHEN \'v\' THEN \'view\' WHEN \'m\' THEN \'materialized view\' WHEN \'i\' THEN \'index\' WHEN \'S\' THEN \'sequence\' WHEN \'s\' THEN \'special\' WHEN \'t\' THEN \'TOAST table\' WHEN \'f\' THEN \'foreign table\' WHEN \'p\' THEN \'partitioned table\' WHEN \'I\' THEN \'partitioned index\' END as \\"Type\\",\\n  pg_catalog.pg_get_userbyid(c.relowner) as \\"Owner\\",\\n  CASE c.relpersistence WHEN \'p\' THEN \'permanent\' WHEN \'t\' THEN \'temporary\' WHEN \'u\' THEN \'unlogged\' END as \\"Persistence\\",\\n  pg_catalog.pg_size_pretty(pg_catalog.pg_table_size(c.oid)) as \\"Size\\",\\n  pg_catalog.obj_description(c.oid, \'pg_class\') as \\"Description\\"\\nFROM pg_catalog.pg_class c\\n     LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace\\nWHERE c.relkind IN (\'v\',\'s\',\'\')\\n  AND pg_catalog.pg_table_is_visible(c.oid)\\nORDER BY 1,2;\\n"},{"cmd":"\\\\dx","opts":"[+]","desc":"list extensions","query":"\\nSELECT e.extname AS \\"Name\\", e.extversion AS \\"Version\\", n.nspname AS \\"Schema\\", c.description AS \\"Description\\"\\nFROM pg_catalog.pg_extension e LEFT JOIN pg_catalog.pg_namespace n ON n.oid = e.extnamespace LEFT JOIN pg_catalog.pg_description c ON c.objoid = e.oid AND c.classoid = \'pg_catalog.pg_extension\'::pg_catalog.regclass\\nORDER BY 1;\\n"},{"cmd":"\\\\dx+","opts":"[+]","desc":"list extensions","query":"\\nSELECT e.extname, e.oid\\nFROM pg_catalog.pg_extension e\\nORDER BY 1;\\n"},{"cmd":"\\\\dX","desc":"list extended statistics","query":"\\nSELECT \\nes.stxnamespace::pg_catalog.regnamespace::pg_catalog.text AS \\"Schema\\", \\nes.stxname AS \\"Name\\", \\npg_catalog.format(\'%s FROM %s\', \\n  (SELECT pg_catalog.string_agg(pg_catalog.quote_ident(a.attname),\', \') \\n   FROM pg_catalog.unnest(es.stxkeys) s(attnum) \\n   JOIN pg_catalog.pg_attribute a \\n   ON (es.stxrelid = a.attrelid \\n   AND a.attnum = s.attnum \\n   AND NOT a.attisdropped)), \\nes.stxrelid::pg_catalog.regclass) AS \\"Definition\\",\\nCASE WHEN \'d\' = any(es.stxkind) THEN \'defined\' \\nEND AS \\"Ndistinct\\", \\nCASE WHEN \'f\' = any(es.stxkind) THEN \'defined\' \\nEND AS \\"Dependencies\\",\\nCASE WHEN \'m\' = any(es.stxkind) THEN \'defined\' \\nEND AS \\"MCV\\"  \\nFROM pg_catalog.pg_statistic_ext es \\nWHERE pg_catalog.pg_statistics_obj_is_visible(es.oid)\\nORDER BY 1, 2;\\n"},{"cmd":"\\\\dy","opts":"[+]","desc":"list event triggers","query":"\\nSELECT evtname as \\"Name\\", evtevent as \\"Event\\", pg_catalog.pg_get_userbyid(e.evtowner) as \\"Owner\\",\\n case evtenabled when \'O\' then \'enabled\'  when \'R\' then \'replica\'  when \'A\' then \'always\'  when \'D\' then \'disabled\' end as \\"Enabled\\",\\n e.evtfoid::pg_catalog.regproc as \\"Function\\", pg_catalog.array_to_string(array(select x from pg_catalog.unnest(evttags) as t(x)), \', \') as \\"Tags\\"\\nFROM pg_catalog.pg_event_trigger e ORDER BY 1\\n"},{"cmd":"\\\\dy+","opts":"[+]","desc":"list event triggers","query":"\\nSELECT evtname as \\"Name\\", evtevent as \\"Event\\", pg_catalog.pg_get_userbyid(e.evtowner) as \\"Owner\\",\\n case evtenabled when \'O\' then \'enabled\'  when \'R\' then \'replica\'  when \'A\' then \'always\'  when \'D\' then \'disabled\' end as \\"Enabled\\",\\n e.evtfoid::pg_catalog.regproc as \\"Function\\", pg_catalog.array_to_string(array(select x from pg_catalog.unnest(evttags) as t(x)), \', \') as \\"Tags\\",\\npg_catalog.obj_description(e.oid, \'pg_event_trigger\') as \\"Description\\"\\nFROM pg_catalog.pg_event_trigger e ORDER BY 1\\n"},{"cmd":"\\\\l","opts":"[+]","desc":"list databases","query":"\\nSELECT d.datname as \\"Name\\",\\n       pg_catalog.pg_get_userbyid(d.datdba) as \\"Owner\\",\\n       pg_catalog.pg_encoding_to_char(d.encoding) as \\"Encoding\\",\\n       d.datcollate as \\"Collate\\",\\n       d.datctype as \\"Ctype\\",\\n       pg_catalog.array_to_string(d.datacl, E\'\\\\n\') AS \\"Access privileges\\"\\nFROM pg_catalog.pg_database d\\nORDER BY 1;\\n"},{"cmd":"\\\\l+","opts":"[+]","desc":"list databases","query":"\\nSELECT d.datname as \\"Name\\",\\n       pg_catalog.pg_get_userbyid(d.datdba) as \\"Owner\\",\\n       pg_catalog.pg_encoding_to_char(d.encoding) as \\"Encoding\\",\\n       d.datcollate as \\"Collate\\",\\n       d.datctype as \\"Ctype\\",\\n       pg_catalog.array_to_string(d.datacl, E\'\\\\n\') AS \\"Access privileges\\",\\n       CASE WHEN pg_catalog.has_database_privilege(d.datname, \'CONNECT\')\\n            THEN pg_catalog.pg_size_pretty(pg_catalog.pg_database_size(d.datname))\\n            ELSE \'No Access\'\\n       END as \\"Size\\",\\n       t.spcname as \\"Tablespace\\",\\n       pg_catalog.shobj_description(d.oid, \'pg_database\') as \\"Description\\"\\nFROM pg_catalog.pg_database d\\n  JOIN pg_catalog.pg_tablespace t on d.dattablespace = t.oid\\nORDER BY 1;\\n"}]'),Et=({identifiers:e,prevIdentifiers:t,ltoken:n,nextTokens:a},l)=>{var o,i;const s="select"===(null==n?void 0:n.textLC)&&(!a.some((e=>"from"===e.textLC))||")"===(null===(o=a[0])||void 0===o?void 0:o.text)),r=")"===(null===(i=a[0])||void 0===i?void 0:i.text),c=l.filter((t=>{return n=t.type,["table","view","mview"].includes(n)&&e.includes(t.escapedName);var n}));let d=[...l.filter((e=>"column"===e.type&&(!c.length||c.some((t=>t.escapedIdentifier===e.escapedParentName)))||"function"===e.type)).map((e=>{const n="column"===e.type&&c.length&&c.some((t=>t.escapedIdentifier===e.escapedParentName))&&!t.includes(e.name),a=("function"===e.type?"c":n?"a":"b")+("public"===e.schema?"a":"b");if("column"===e.type){const t=r?" ":"\n";return{...e,sortText:a,...s&&{label:{..."object"==typeof e.label?e.label:{},label:e.name+" ..."},insertText:e.insertText+`$0${t}FROM ${e.escapedParentName}${t}LIMIT 200 `}}}return{...e,sortText:a}}))];const m=l.filter((e=>"keyword"===e.type&&["select"===(null==n?void 0:n.textLC)?"DISTINCT":"","COALESCE","CASE","NULLIF","LEAST","GREATEST"].includes(e.name))).map((e=>({...e,sortText:"c"})));return m&&(d=[...m,...d]),{suggestions:d}},vt=["=",">","LIKE","ILIKE"],bt=async(e,t,n,a,l)=>{const{tokens:o,prevText:i,thisLineLC:s,prevTokens:r,currToken:c}=e,d=o[0],p=r.at(-1),u=(r.at(-2),((e,t)=>{const{prevTokens:n,ltoken:a,l1token:l,prevText:o,thisLineLC:i}=e,s=[...n].reverse().find((e=>["keyword.choice.sql","keyword.sql"].includes(e.type)));if(["where","when"].includes(null==s?void 0:s.textLC)&&((null==s?void 0:s.offset)===(null==a?void 0:a.offset)||["and","or"].includes(null==a?void 0:a.textLC)||"operator.sql"===(null==a?void 0:a.type)))return Et(e,t);const r=n.filter((e=>"identifier.sql"===e.type)).map((e=>e.text));if(i&&["where","when"].includes(null==s?void 0:s.textLC)&&("identifier.sql"===(null==a?void 0:a.type)||"operator.sql"===(null==l?void 0:l.type))){const e=t.find((e=>"column"===e.type&&e.name===(null==a?void 0:a.text)&&r.includes(e.parentName))),n=t.filter((e=>"operator"===e.type)),i=t.filter((e=>"keyword"===e.type&&"keyword.sql"!==(null==a?void 0:a.type)&&["AND","OR"].includes(e.name)));if("operator.sql"===(null==l?void 0:l.type)&&!["and","or"].includes(l.textLC)&&o.endsWith(" "))return{suggestions:i};if(e){const l=n.filter((t=>{var n,a,l,o,i,s,r,c;return(null===(n=e.colInfo)||void 0===n?void 0:n.data_type.startsWith(null===(a=t.operatorInfo)||void 0===a?void 0:a.left_arg_type))||(null===(l=t.operatorInfo)||void 0===l?void 0:l.left_arg_type)===(null===(o=e.colInfo)||void 0===o?void 0:o.udt_name)||(null===(i=t.operatorInfo)||void 0===i?void 0:i.left_arg_type)===(null===(s=e.colInfo)||void 0===s?void 0:s.data_type)||(null===(r=e.colInfo)||void 0===r?void 0:r.udt_name.endsWith(null===(c=t.operatorInfo)||void 0===c?void 0:c.left_arg_type))})).concat("identifier.sql"===(null==a?void 0:a.type)?[]:i).concat(t.filter((e=>["IN","NOT"].includes(e.name)))).map((e=>({...e,sortText:vt.includes(e.name)?"a":"b"})));return{suggestions:l}}return{suggestions:n.concat(i)}}})(e,t));if(u)return u;if("table"===(null==d?void 0:d.textLC))return Ye("tableOrView",e,t);if(i.trim().startsWith("\\"))return{suggestions:ft.map((t=>({label:{label:t.cmd+"   "+t.desc},insertText:`/* psql ${t.cmd} --${t.desc} */${t.query}`,kind:l("snippet"),range:{startColumn:0,startLineNumber:e.startLine,endColumn:132,endLineNumber:e.endLine},filterText:`${t.cmd} ${t.desc}`})))};if("show"===(null==d?void 0:d.textLC)||"set"===(null==d?void 0:d.textLC))return 2===r.length?"set"===d.textLC?Se([{label:"TO"}]):{suggestions:[]}:{suggestions:n.concat((h=["ALL"],Se(h.map((e=>({label:e,sortText:g,insertText:e+" ",kind:l("keyword")}))))).suggestions)};var h,g;if([p,c].some((e=>"::"===(null==e?void 0:e.text))))return{suggestions:t.filter((e=>"dataType"===e.type)).map((e=>{var t;return{...e,sortText:null===(t=e.dataTypeInfo)||void 0===t?void 0:t.priority}}))};if("refresh"===(null==d?void 0:d.textLC))return e.tokens.some((e=>"view"===e.textLC))?{suggestions:t.filter((e=>"m"===e.relkind))}:Se([{label:"MATERIALIZED VIEW",insertText:"MATERIALIZED VIEW ",docs:"Replace the contents of a materialized view"},{label:"REFRESH MATERIALIZED VIEW CONCURRENTLY",insertText:"REFRESH MATERIALIZED VIEW CONCURRENTLY ",docs:"Replace the contents of a materialized view"}]);if("reindex"===(null==d?void 0:d.textLC))return Se(["INDEX","TABLE","SCHEMA","DATABASE","SYSTEM"].map((e=>({label:e,insertText:e+" $0",docs:"Rebuilds an index using the data stored in the index's table, replacing the old copy of the index. There are several scenarios in which to use "}))));const f=[...r].reverse().filter((e=>"keyword.sql"===e.type)),E=["GRANT","REVOKE"],v=E.some((e=>(null==p?void 0:p.text)===e)),b=!v&&(null==f?void 0:f.some((e=>E.includes(e.text.toUpperCase()))));if(v)return Se((0,m.getKeys)(yt).map((e=>({label:e,docs:yt[e],kind:l("keyword")}))));if(b){let e;return s.endsWith(" on")?{suggestions:t.filter((e=>"table"===e.type))}:s.includes(" to ")&&!s.endsWith(" to")||s.includes(" to")&&s.endsWith(" to")||s.includes(" from")&&s.endsWith(" from")?{suggestions:t.filter((e=>"role"===e.type))}:(s.includes(" on ")||!s.endsWith(" on")?e=s.includes("revoke")?["FROM"]:["TO"]:s.endsWith(",")||v||(e=["ON"]),e=e.filter((e=>!s.toUpperCase().includes(e))),Se(e.map((e=>({label:e})))))}return"inner"!==(null==p?void 0:p.textLC)&&"left"!==(null==p?void 0:p.textLC)&&"right"!==(null==p?void 0:p.textLC)||"identifier.sql"!==p.type?void 0:Se(["join"].map((e=>({label:e}))))},yt={ALL:"Allows all privileges",SELECT:"Allows SELECT from any column, or specific column(s), of a table, view, materialized view, or other table-like object. Also allows use of COPY TO. This privilege is also needed to reference existing column values in UPDATE or DELETE. For sequences, this privilege also allows use of the currval function. For large objects, this privilege allows the object to be read.",INSERT:"Allows INSERT of a new row into a table, view, etc. Can be granted on specific column(s), in which case only those columns may be assigned to in the INSERT command (other columns will therefore receive default values). Also allows use of COPY FROM.\n  ",UPDATE:"Allows UPDATE of any column, or specific column(s), of a table, view, etc. (In practice, any nontrivial UPDATE command will require SELECT privilege as well, since it must reference table columns to determine which rows to update, and/or to compute new values for columns.) SELECT ... FOR UPDATE and SELECT ... FOR SHARE also require this privilege on at least one column, in addition to the SELECT privilege. For sequences, this privilege allows use of the nextval and setval functions. For large objects, this privilege allows writing or truncating the object.\n  ",DELETE:"Allows DELETE of a row from a table, view, etc. (In practice, any nontrivial DELETE command will require SELECT privilege as well, since it must reference table columns to determine which rows to delete.)",TRUNCATE:"Allows TRUNCATE on a table.",REFERENCES:"Allows creation of a foreign key constraint referencing a table, or specific column(s) of a table.",TRIGGER:"Allows creation of a trigger on a table, view, etc.\n  ",CREATE:"For databases, allows new schemas and publications to be created within the database, and allows trusted extensions to be installed within the database.\n  For schemas, allows new objects to be created within the schema. To rename an existing object, you must own the object and have this privilege for the containing schema.\n  For tablespaces, allows tables, indexes, and temporary files to be created within the tablespace, and allows databases to be created that have the tablespace as their default tablespace.\n  Note that revoking this privilege will not alter the existence or location of existing objects.",CONNECT:"Allows the grantee to connect to the database. This privilege is checked at connection startup (in addition to checking any restrictions imposed by pg_hba.conf).",TEMPORARY:"Allows temporary tables to be created while using the database.",EXECUTE:"Allows calling a function or procedure, including use of any operators that are implemented on top of the function. This is the only type of privilege that is applicable to functions and procedures.\n  ",USAGE:"For procedural languages, allows use of the language for the creation of functions in that language. This is the only type of privilege that is applicable to procedural languages.\n  For schemas, allows access to objects contained in the schema (assuming that the objects' own privilege requirements are also met). Essentially this allows the grantee to “look up” objects within the schema. Without this permission, it is still possible to see the object names, e.g., by querying system catalogs. Also, after revoking this permission, existing sessions might have statements that have previously performed this lookup, so this is not a completely secure way to prevent object access.\n  For sequences, allows use of the currval and nextval functions.\n  For types and domains, allows use of the type or domain in the creation of tables, functions, and other schema objects. (Note that this privilege does not control all “usage” of the type, such as values of the type appearing in queries. It only prevents objects from being created that depend on the type. The main purpose of this privilege is controlling which users can create dependencies on a type, which could prevent the owner from changing the type later.)\n  For foreign-data wrappers, allows creation of new servers using the foreign-data wrapper.\n  For foreign servers, allows creation of foreign tables using the server. Grantees may also create, alter, or drop their own user mappings associated with that server.\n  ",SET:"Allows a server configuration parameter to be set to a new value within the current session. (While this privilege can be granted on any parameter, it is meaningless except for parameters that would normally require superuser privilege to set.)\n  ","ALTER SYSTEM":"Allows a server configuration parameter to be configured to a new value using the ALTER SYSTEM command."},Nt={match:e=>{const t=e.prevText.toLowerCase().trim();if(t.startsWith("select")||t.startsWith("with"))return!0;const n=e.prevTokens.at(-1);return"keyword.sql"===(null==n?void 0:n.type)&&"select"===n.textLC},result:async(e,t,n,a,l)=>{var o;const{identifiers:i,thisLineLC:s,prevLC:r,nextTokens:c,prevText:d,currToken:m,thisLinePrevTokens:p}=e;if("string.sql"===(null==m?void 0:m.type))return{suggestions:[]};if("with"===r)return Se([{label:"cte...",insertText:"\n  cte1 AS (SELECT 1 FROM $1)\n ,cte2 AS (SELECT 2 FROM $2)\nSELECT * $3\nFROM cte1"}]);const{ltoken:u,l1token:h}=e;if("("===(null==u?void 0:u.textLC)&&"join"===(null==h?void 0:h.textLC))return Se([{label:"SELECT"}]);const g="identifier.quote.sql"===(null==u?void 0:u.type)||"identifier.sql"===(null==u?void 0:u.type)||"*"===(null==u?void 0:u.textLC);if(d.trim().endsWith(".")&&(g||"public"===(null==u?void 0:u.textLC))&&"from"===(null==h?void 0:h.textLC)){const e=t.filter((e=>{return t=e.type,["table","view","mview"].includes(t)&&e.schema===u.text;var t}));return e.length?{suggestions:e.map((e=>{var t;return{...e,insertText:null!==(t=e.escapedName)&&void 0!==t?t:e.name}}))}:Se([{label:"No views/tables found for this schema",insertText:""}])}const{prevKWD:f,suggestKWD:E,prevIdentifiers:v,remainingKWDS:b,getSuggestion:y}=Ge(wt,e,l,t),N=()=>Et(e,t);if(r.trim().endsWith("group by")||r.trim().endsWith("order by")||r.trim().endsWith("having")||r.trim().endsWith("where")||r.trim().endsWith("when"))return N();const w=_t(e);if(w&&"from"!==(null===(o=w.funcName)||void 0===o?void 0:o.textLC)){const n=Ct(e,t),a=N().suggestions.map((e=>({...e,sortText:"function"===e.type?e.sortText:(null==n?void 0:n.some((t=>{var n;return null===(n=t.args)||void 0===n?void 0:n.some((({data_type:t})=>{var n;return"any"===t||t.includes(null===(n=e.colInfo)||void 0===n?void 0:n.data_type)}))})))?"a":e.colInfo?d.includes(e.colInfo.escaped_identifier)?"b":"a":e.sortText})));return{suggestions:a}}if(s.trim().endsWith(")")){const n=Ct(e,t);if(n.some((e=>"rank"===e.name)))return Se([{label:"OVER (PARTITION BY $0 ORDER BY $1 DESC)",kind:l("function"),docs:St}]);if(n.some((e=>{var t;return null===(t=e.funcInfo)||void 0===t?void 0:t.is_aggregate})))return Se([{label:"FILTER ( WHERE $0 )",docs:je.FILTER,kind:l("function")}])}if("number"===(null==f?void 0:f.expects)&&(null==u?void 0:u.text.toUpperCase())===(null==f?void 0:f.kwd))return Se(["10","50","100"].map((e=>({label:e}))));if("using"===(null==u?void 0:u.textLC))return Se([{label:"( join_column_list )",insertText:"( $0 )"}]);const S=["SELECT","DISTINCT"];if(b.length&&(S.includes(null==f?void 0:f.kwd)&&","!==(null==u?void 0:u.text)&&(!p.length||!S.includes(null==u?void 0:u.text.toUpperCase()))||"INTO"===(null==f?void 0:f.kwd)&&g||"FROM"===(null==f?void 0:f.kwd)&&g||"JOIN"===(null==f?void 0:f.kwd)&&g||"LIMIT"===(null==f?void 0:f.kwd)&&"number.sql"===(null==u?void 0:u.type)||"OFFSET"===(null==f?void 0:f.kwd)&&"number.sql"===(null==u?void 0:u.type)||("GROUP BY"===(null==f?void 0:f.kwd)||"ORDER BY"===(null==f?void 0:f.kwd))&&","!==(null==u?void 0:u.text)&&"by"!==(null==u?void 0:u.textLC)||"ON"===(null==f?void 0:f.kwd)&&!s))return"SELECT"!==(null==f?void 0:f.kwd)&&"DISTINCT"!==(null==f?void 0:f.kwd)||p.length?y():E(b.map((e=>e.kwd)));if(!s&&"FROM"===(null==f?void 0:f.kwd)&&"from"!==(null==u?void 0:u.textLC)){const n=E(b.map((e=>e.kwd)),"0"),a=Ye("tableOrView",e,t).suggestions;return{suggestions:[...n.suggestions,...a]}}if("table"===(null==f?void 0:f.expects)){const n=Ye("tableOrView",e,t).suggestions,a=t.filter((e=>{var t;return null===(t=e.funcInfo)||void 0===t?void 0:t.restype.toLowerCase().includes("setof")})).map((e=>({...e,sortText:"c"})));return{suggestions:[...n,...a]}}return N()}},wt=[{kwd:"SELECT",expects:"column"},{kwd:"DISTINCT",expects:"column",exactlyAfter:["SELECT"]},{kwd:"WHEN",expects:"column",justAfter:["CASE"]},{kwd:"INTO",expects:"table",justAfter:["SELECT"],docs:"Creates a table from the result of the select statement"},{kwd:"FILTER",expects:"column",dependsOn:"SELECT"},{kwd:"FROM",expects:"table",justAfter:["SELECT"],docs:"Specifies a table/view or function with returns a table-like result"},{kwd:"JOIN",expects:"table",docs:"Combine rows from one table with rows from a second table"},{kwd:"INNER JOIN",expects:"table",docs:"Combine rows from one table with rows from a second table. Only matching records from both tables are returned"},{kwd:"LEFT JOIN",expects:"table",docs:"Combine rows from one table with rows from a second table. Records from first table AND matching records are returned"},{kwd:"ON",expects:"column",justAfter:["JOIN"],docs:"Join condition"},{kwd:"USING",expects:"column",justAfter:["JOIN"],docs:"Join condition"},{kwd:"WHERE",expects:"column",docs:"Condition/filter applied to the data"},{kwd:"GROUP BY",expects:"column",docs:"Used with aggregate functions to split data into groups (or buckets).\n\nA group is defined by the combination of unique values of the columns from GROUP BY "},{kwd:"HAVING",expects:"column"},{kwd:"ORDER BY",expects:"column"},{kwd:"LIMIT",expects:"number"},{kwd:"OFFSET",expects:"number"},{kwd:";",expects:"number"}],St="\nrank function produces a numerical rank for each distinct ORDER BY value in the current row's partition, using the order defined by the ORDER BY clause. rank needs no explicit parameter, because its behavior is entirely determined by the OVER clause.",Tt=e=>{const{currToken:t,prevTokens:n}=e,a=[t,...n.slice(0).reverse()].find(((e,t,n)=>{var a;return null===(a=n[t-1])||void 0===a?void 0:a.text.includes("(")}));return a},Ct=(e,t)=>{const n=Tt(e);return n?t.filter((e=>"function"===e.type&&e.escapedIdentifier===n.text)):[]},_t=e=>{var t;const{getPrevTokensNoParantheses:n}=e,a=n(!0).map((e=>e.text)).join(" ");if("()"===(null===(t=e.currToken)||void 0===t?void 0:t.text)||a.trim().lastIndexOf("(")>a.trim().lastIndexOf(")")){const t=Tt(e),n=t?e.prevTokens.find(((e,n,a)=>{var l;return(null===(l=a[n+1])||void 0===l?void 0:l.offset)===t.offset})):void 0;return{funcName:t,prevToken:n}}},xt={match:e=>e.prevLC.startsWith("drop"),result:async(e,t,n,a,l)=>{var o;const{prevLC:i,prevTokens:s}=e,r=null===(o=e.tokens[1])||void 0===o?void 0:o.textLC;if("drop"===i)return Se(Ce.flatMap((e=>[" IF EXISTS",""].map((t=>({label:`${e}${t}`,docs:Ll[e.toUpperCase()]}))))));if(r){if("table"===r.toLowerCase())return Ge(At,e,l,t).getSuggestion();const n=Ye(r,e,t).suggestions,a=e=>"/* If cannot drop due to it being in use then run this query close all connections before droping \nSELECT pg_terminate_backend(pg_stat_activity.pid) FROM pg_stat_activity \nWHERE pg_stat_activity.datname = '"+e+"' AND pid <> pg_backend_pid();\nDROP DATABASE "+e+";\n */";return{suggestions:n.filter((e=>{var t;return"extension"!==e.type||(null===(t=e.extensionInfo)||void 0===t?void 0:t.installed)})).map((e=>{var t;return{...e,insertText:"policy"===e.type?`${e.insertText} ON ${null===(t=e.policyInfo)||void 0===t?void 0:t.tablename}`:"database"===e.type?`${e.insertText}\n${a(e.name)}`:e.insertText}}))}}return{suggestions:[]}}},At=[{kwd:"TABLE",expects:"table"},{kwd:"EXISTS",expects:"table"},{kwd:"CASCADE",dependsOn:"TABLE",docs:"Automatically drop objects that depend on the table (such as views), and in turn all objects that depend on those objects.\n\nhttps://www.postgresql.org/docs/current/sql-droptable.html"},{kwd:";",dependsOn:"TABLE"}],Rt=[{kwd:"UPDATE",expects:"table"},{kwd:"SET",expects:"column",justAfter:["UPDATE"],dependsOn:"UPDATE"},{kwd:",",expects:"column",dependsOn:"SET",canRepeat:!0},{kwd:"WHERE",expects:"column",dependsOn:"SET"},{kwd:"RETURNING",expects:"column",dependsOn:"SET"}],Lt={match:e=>{var t;return"update"===(null===(t=e.tokens[0])||void 0===t?void 0:t.textLC)},result:async(e,t,n,a,l)=>{const{prevTokens:o,thisLineLC:i}=e,{getSuggestion:s,prevKWD:r}=Ge(Rt,e,l,t);if(1===o.length)return{suggestions:Ye("table",e,t).suggestions.map((e=>({...e,label:`${e.name}...`,insertText:e.insertText+"\nSET "})))};const c=["update","set","where","returning"],d=([...o].reverse().filter((e=>c.includes(e.textLC))).map((e=>e.textLC)),o.findIndex((e=>"keyword.sql"===e.type&&"set"===e.textLC))),m=o.filter(((e,t)=>(d<0||t<d)&&"identifier.sql"===e.type)),p=o.filter(((e,t)=>t>d&&"identifier.sql"===e.type)).map((e=>e.text));if(m.length){const{suggestions:e}=s();return{suggestions:"SET"===(null==r?void 0:r.kwd.replace(",","SET"))?e.filter((e=>"*"!==e.name)).map((e=>({...e,insertText:"column"===e.type?e.insertText+"= ":e.insertText}))):e}}const u=t.filter((e=>"column"===e.type&&m.some((t=>e.parentName===t.text))));return u.length?{suggestions:u.map((e=>({...e,insertText:`${e.escapedIdentifier} = `,sortText:p.includes(e.name)?"b":"a"})))}:Ye("column",e,t)}},Ot=[{kwd:"INTO",justAfter:["INSERT"],expects:"keyword"},{kwd:"VALUES",justAfter:["INTO"],expects:"column"},{kwd:"DEFAULT VALUES",justAfter:["INTO"],expects:"column",excludeIf:["("]},{kwd:"SELECT",justAfter:["INTO"],expects:"column"},{kwd:"FROM",justAfter:["SELECT"],expects:"table"},{kwd:"WHERE",justAfter:["FROM"],expects:"condition"},{kwd:"ON CONFLICT",justAfter:["VALUES","SELECT"],expects:["DO NOTHING","DO UPDATE"],docs:"The optional ON CONFLICT clause specifies an alternative action to raising a unique violation or exclusion constraint violation error. For each individual row proposed for insertion, either the insertion proceeds, or, if an arbiter constraint or index specified by conflict_target is violated, the alternative conflict_action is taken. \n    \n    ON CONFLICT DO NOTHING \n    --simply avoids inserting a row as its alternative action. \n    \n    ON CONFLICT DO UPDATE \n    --updates the existing row that conflicts with the row proposed for insertion as its alternative action."},{kwd:"RETURNING",expects:"column",justAfter:["VALUES"]}],It={match:e=>{var t;return"insert"===(null===(t=e.tokens[0])||void 0===t?void 0:t.textLC)},result:async(e,t,n,a,l)=>{var o;const{tokens:i,prevLC:s,prevTokens:r,prevIdentifiers:c}=e,{remainingKWDS:d,suggestKWD:m,getSuggestion:p,prevKWD:u}=(i[0],r.at(-1),Ge(Ot,e,l,t)),h=_t(e);if(h){if("into"===(null===(o=h.prevToken)||void 0===o?void 0:o.textLC)){return{suggestions:Ye("column",e,t).suggestions.filter((e=>{var t;return!c.includes(null===(t=e.colInfo)||void 0===t?void 0:t.escaped_identifier)}))}}const n=Ye("function",e,t).suggestions.filter((e=>{var t,n;return!(null===(t=e.funcInfo)||void 0===t?void 0:t.args.length)&&(null===(n=e.funcInfo)||void 0===n?void 0:n.restype)}));return{suggestions:[...Se([{label:"DEFAULT"}]).suggestions,...n]}}if(null==s?void 0:s.trim().toLowerCase().endsWith("insert into")){const e=t.filter((e=>"table"===e.type));return{suggestions:Dt(e).map((e=>{var t;return e.label={...U(e.label)&&e.label,label:e.name+" (..."},e.insertText+=` (${null===(t=e.cols)||void 0===t?void 0:t.filter((e=>{var t;return!(e.has_default&&["u","p"].includes(null===(t=e.cConstraint)||void 0===t?void 0:t.contype))})).map((e=>e.escaped_identifier)).join(", ")})\nVALUES`,e.kind=l("table"),e.sortText="public"===e.schema?"0a":"a",e})).concat(e)}}return p()}},Dt=e=>structuredClone(e),kt={match:e=>{var t;return"comment"===(null===(t=e.tokens[0])||void 0===t?void 0:t.textLC)},result:async(e,t,n)=>{const{prevLC:a,prevTokens:l}=e,o=(l[0],l.at(-1));if("identifier.sql"===(null==o?void 0:o.type)&&!["comment","on","is"].includes(o.textLC))return Se([{label:"IS 'your comment$0'"}]);if("comment"===(null==o?void 0:o.textLC))return Se([{label:"ON "}]);if("on"===(null==o?void 0:o.textLC))return Se(Mt.map((e=>({label:e}))));if(a.startsWith("comment on")){const n=null==o?void 0:o.textLC;return"column"===n?{suggestions:t.filter((e=>"column"===e.type)).map((e=>({...e,insertText:`${e.escapedParentName}.${e.escapedIdentifier} `})))}:Ye(n,e,t)}return{suggestions:[]}}},Mt=["ACCESS METHOD ${1:object_name}","AGGREGATE ${1:aggregate_name}","CAST","COLUMN ${1:column_name}","CONSTRAINT ${1:constraint_name} ON ${2:table_name}","CONSTRAINT ${1:constraint_name} ON DOMAIN ${2:domain_name}","CONVERSION ${1:object_name}","COLLATION ${1:object_name}","DATABASE ${1:object_name}","DOMAIN ${1:object_name}","EXTENSION ${1:object_name}","EVENT TRIGGER ${1:object_name}","FOREIGN DATA WRAPPER ${1:object_name}","FOREIGN TABLE ${1:object_name}","FUNCTION ${1:function_name} ","INDEX ${1:object_name}","LARGE OBJECT ${1:large_object_oid}","MATERIALIZED VIEW ${1:object_name}","OPERATOR ${1:operator_name} ","OPERATOR CLASS ${1:object_name} USING ${2:index_method}","OPERATOR FAMILY ${1:object_name} USING ${2:index_method}","POLICY ${1:policy_name} ON ${2:table_name}","LANGUAGE ${1:object_name}","PROCEDURE ${1:procedure_name} ","PUBLICATION ${1:object_name}","ROLE ${1:object_name}","ROUTINE ${1:routine_name} ","RULE ${1:rule_name} ON ${2:table_name}","SCHEMA ${1:object_name}","SEQUENCE ${1:object_name}","SERVER ${1:object_name}","STATISTICS ${1:object_name}","SUBSCRIPTION ${1:object_name}","TABLE ${1:object_name}","TABLESPACE ${1:object_name}","TEXT SEARCH CONFIGURATION ${1:object_name}","TEXT SEARCH DICTIONARY ${1:object_name}","TEXT SEARCH PARSER ${1:object_name}","TEXT SEARCH TEMPLATE ${1:object_name}","TRANSFORM FOR ${1:type_name} LANGUAGE ${2:lang_name}","TRIGGER ${1:trigger_name} ON ${2:table_name}","TYPE ${1:object_name}","VIEW ${1:object_name}"].map((e=>e+" IS '${3:your_comment}' ")),Ft=[{kwd:"DELETE",expects:"keyword"},{kwd:"FROM",expects:"table"},{kwd:"WHERE",expects:"column",justAfter:["FROM"]},{kwd:"RETURNING",expects:"column",dependsOn:"FROM"}],Pt={match:e=>e.prevLC.startsWith("delete"),result:async(e,t,n,a,l)=>{const{getSuggestion:o}=Ge(Ft,e,l,t);return o()}},Ht={match:e=>{const{l1token:t,ltoken:n,currToken:a}=e;return"?"===(null==t?void 0:t.text)||"?"===(null==n?void 0:n.text)||"?"===(null==a?void 0:a.text)},result:async(e,t,n)=>{const{currToken:a,l1token:l,ltoken:o}=e;if("?"===(null==o?void 0:o.text)||"?"===(null==a?void 0:a.text))return Se(Rl.filter((e=>!["file","folder"].includes(e))).map((e=>{var t;return{label:e,insertText:e+" ",docs:null!==(t=Ll[e])&&void 0!==t?t:""}})));const i=o.text;return"setting"===i?{suggestions:n}:Ye(i,e,t)}},Bt=[{kwd:"REASSIGN"},{kwd:"OWNED",justAfter:["REASSIGN"]},{kwd:"BY",expects:"role",justAfter:["OWNED"]},{kwd:"TO",expects:"role",dependsOn:"BY"},{kwd:";",dependsOn:"TO"}],Wt={match:e=>e.prevLC.startsWith("reassign"),result:async(e,t,n,a,l)=>{const{getSuggestion:o,remainingKWDS:i,prevKWD:s}=Ge(Bt,e,l,t),r=o();if("TO"===(null==s?void 0:s.kwd)&&r.suggestions.length){const t=e.tokens.find(((e,t,n)=>{var a;return"by"===(null===(a=n[t-1])||void 0===a?void 0:a.textLC)}));if(t)return{suggestions:r.suggestions.filter((e=>e.name!==t.text))}}return r}};let $t,Ut;const qt=e=>e.replaceAll(")"," ").replaceAll("\n"," ").replaceAll("("," ").replaceAll(","," ").replaceAll(";"," ").replaceAll("="," ");const jt=[5,10,15,20,25,50,100,200];class Table extends a.Component{constructor(){super(...arguments),this.state={}}static parseCell(e,t=100,n){let l,o;return"string"==typeof e?o=Gl(e,t):"number"==typeof e?o=e.toString():null===e?(o="NULL",l=a.createElement("i",{className:"text-gray-300"},"NULL")):o=void 0===e?"":e&&Array.isArray(e)?Gl(`[${e.map((e=>Table.parseCell(e))).join(", \n")}]`,t):e&&"function"==typeof e.toISOString?e.toISOString():e&&"[object Object]"===Object.prototype.toString.call(e)?Gl(JSON.stringify(e,null,2),t):e&&e.toString?Gl(e.toString(),t):`${e}`,n?o:l||o}render(){var e,t;const{rows:n=[],cols:l=[],whiteHeader:o=!1,onSort:i,sort:s=[],onRowClick:r,onRowHover:c,tableStyle:d={},maxCharsPerCell:m=100,maxRowsPerPage:p=200,pagination:u,activeRowIndex:h=-1,bodyClass:g="",activeRowStyle:f={},className:E="",rowClass:v="",rowStyle:b={},maxRowHeight:y,onColumnReorder:N}=this.props,{draggedCol:w}=this.state,S="string"==typeof m&&Number.isFinite(parseInt(m))?parseInt(m):100;let T=l.filter((e=>!e.hidden)),{page:C=1,pageSize:_=15}=u||{};_=Yt(_||25,jt)||25;let x=0,A=n.map((e=>({...e})));u&&!u.onPageChange&&(x=C*_,A=A.slice(x,(C+1)*_)),A.length>p&&(console.warn("Exceeded maxRowsPerPage"),A=A.slice(0,p));let R=[];Array.isArray(s)&&(R=s.map((e=>({...e}))));const L=(e,t)=>{let n=e.width?{flex:"none",width:`${e.width}px`}:{flex:1};return void 0!==t&&(null==w?void 0:w.idx)===t&&(n.opacity=.5),void 0!==t&&(null==w?void 0:w.targetIdx)===t&&(n.paddingLeft="2em",n.background="var(--blue-100)"),n};return a.createElement("div",{key:T.map((e=>`${e.key}${e.width}`)).join(),className:"table-component o-auto flex-col f-1 min-h-0 min-w-0 "+E,ref:e=>{e&&(this.ref=e)}},a.createElement("div",{role:"table",className:"min-w-fit min-h-0 b border-gray-200 flex-col h-full bg-white ",style:d},a.createElement("div",{role:"row",className:"noselect f-0 flex-row shadow bg-gray-50",onWheel:e=>{var t;if(e.shiftKey||e.ctrlKey)return;function n(e){return e&&e.scrollWidth>e.clientWidth}let a,l=5,o=null===(t=e.currentTarget.parentElement)||void 0===t?void 0:t.closest(".table-component");for(;l>0;)n(o)?(a=o,l=0):(o=null==o?void 0:o.parentElement,l--);a&&(a.scrollLeft-=e.nativeEvent.wheelDeltaY||-e.deltaY)}},T.map(((e,t)=>{var n;let l=null==R?void 0:R.find((t=>t.key===e.key)),s="flex-col h-full min-w-0 px-p5 py-p5 text-left text-xs leading-4 relative  font-medium text-gray-500 uppercase tracking-wider to-ellipsis"+(i&&e.sortable?" pointer ":"")+(o?" ":" bg-gray-50  ")+(e.onContextMenu?" contextmenu ":"")+(e.width?" f-0 ":" f-1 ");return a.createElement("div",{key:t,className:s,...e.onContextMenu?zt():{},onContextMenu:e.onContextMenu?t=>{if(e.onContextMenu&&!t.currentTarget.classList.contains("resizing-ew"))return Qa(25),e.onContextMenu(t,t.nativeEvent.target,e)}:void 0,role:"columnheader",style:{...L(e,t),borderRight:"1px solid var(--gray-100)"},draggable:!0,onDragStart:n=>{n.dataTransfer.setData("text/plain",e.name+""),N&&this.setState({draggedCol:{idx:t,node:n.currentTarget}})},onDragOver:N?e=>(w&&w.idx!==t&&w.targetIdx!==t&&this.setState({draggedCol:{...w,targetIdx:t}}),e.preventDefault(),!1):void 0,onDragLeave:N?e=>{e.target===e.currentTarget&&this.setState({draggedCol:{...w,targetIdx:void 0}})}:void 0,onDragEnd:N?e=>{this.setState({draggedCol:void 0})}:void 0,onDrop:N?n=>{const a=(null==w?void 0:w.idx)!==t;if(w&&a){let t=T.slice(0);const n=t[w.idx],a=e;if(!n)return;t=t.filter((e=>e.key!==n.key));const l=t.findIndex((e=>e.key===a.key));t.splice(l+(w.idx<l+1?1:0),0,n),N(t)}this.setState({draggedCol:void 0})}:void 0,onClick:i&&e.sortable?t=>{t.button||t.target.classList.contains("resize-handle")||(l?l.asc?l.asc=!1:l=void 0:l={key:e.key,asc:!0},i((t.shiftKey?R.filter((t=>t.key!==e.key)):[]).concat(l?[l]:[])))}:void 0},a.createElement("div",{className:"flex-row fs-1 h-fit "+(e.sortable?"boolean"!=typeof(null==l?void 0:l.asc)?" sort-none ":[!1].includes(l.asc)?"sort-desc":"sort-asc":"")+(e.headerClassname||"")},a.createElement("div",{className:"flex-col min-w-0 f-shrink"},a.createElement("div",{className:"table-column-label text-ellipsis ",title:null!==(n=e.title)&&void 0!==n?n:"string"==typeof e.label?e.label:void 0},e.label),void 0!==e.subLabel&&this.props.showSubLabel?a.createElement("div",{className:"table-column-sublabel text-gray-400 mt-p25 font-normal ws-nowrap text-ellipsis ",title:e.subLabelTitle},e.subLabel):null)),t<=T.length-1?a.createElement(Pan,{className:"resize-handle noselect",style:{position:"absolute",right:0,top:0,bottom:0,width:"30px",cursor:"ew-resize",zIndex:123,marginRight:t===T.length-1?0:"-15px"},onDoubleTap:e=>{var n;const a=null===(n=this.ref)||void 0===n?void 0:n.querySelector('[role="rowgroup"]');console.log("resize to fit content please",t,a)},threshold:0,onPanStart:(e,t)=>{const n=e.node.closest('[role="columnheader"]');n&&(e.node._w=n.offsetWidth)},onPan:(e,n)=>{var a;const l=e.node.closest('[role="columnheader"]');if(l){const{xDiff:n}=e,o=Math.max(30,e.node._w+n);l.style.width=`${o}px`,l.style.flex="none";const i=null===(a=this.ref)||void 0===a?void 0:a.querySelector('[role="rowgroup"]'),s=null==i?void 0:i.querySelectorAll(`[role="row"] > *:nth-child(${t+1})`);null==s||s.forEach((e=>{e.style.width=`${o}px`,e.style.flex="none"}))}},onPanEnd:(t,n)=>{const a=t.node.closest('[role="columnheader"]');a&&e.onResize&&e.onResize(a.offsetWidth)},onPress:e=>{var t,n;const a=null===(n=null===(t=e.target)||void 0===t?void 0:t.closest)||void 0===n?void 0:n.call(t,'[role="columnheader"]');a&&(a.classList.toggle("resizing-ew",!0),Qa(15),e.preventDefault(),e.stopPropagation())},onRelease:e=>{var t,n;const a=null===(n=null===(t=e.target)||void 0===t?void 0:t.closest)||void 0===n?void 0:n.call(t,'[role="columnheader"]');a&&a.classList.toggle("resizing-ew",!1)}}):null)}))),a.createElement("div",{className:"b-y border-gray-200 f-1 oy-auto ox-hidden no-scroll-bar flex-col min-w-fit "+g,role:"rowgroup",onPointerUp:r?e=>{e.target===e.currentTarget&&r(void 0,e)}:void 0},A.length?A.map(((e,t)=>a.createElement("div",{key:t+" "+Date.now(),role:"row",className:"d-row flex-row f-0 "+(v||" ")+(r?" pointer ":"")+(c||r?" hover ":""),style:{...h===t?f:{},...b,maxHeight:`${y||100}px`},onClick:r?t=>{var n;t.currentTarget.contains(t.target)&&!(null===(n=window.getSelection())||void 0===n?void 0:n.toString().trim())&&r(e,t)}:void 0},T.map(((l,o)=>{var i;if(l.onRenderNode)return l.onRenderNode(e,e[l.key]);const s=t+x,r=Table.parseCell(e[l.key],S,!0),c=l.onRender?null:Table.parseCell(e[l.key],S);return a.createElement("div",{key:o,className:"text-sm leading-5 text-gray-900 o-auto no-scroll-bar ta-left br b-gray-100 "+(t<A.length-1?"bt":"bt bb")+" "+(l.className||"")+(l.blur?" blur ":" ")+(l.width?" f-0 ":" f-1 ")+(l.onClick?"  ":" p-p5 "),style:{...L(l),...(null===(i=l.getCellStyle)||void 0===i?void 0:i.call(l,e,e[l.key],r))||{}},role:"cell",title:r},l.onClick?a.createElement(Btn_Btn,{onClick:t=>{l.onClick&&l.onClick(e,l,t)},className:"text-indigo-600 hover:text-indigo-900 h-fit w-fit b-gray-400"},c):l.onRender?l.onRender({row:e,value:e[l.key],renderedVal:r,rowIndex:s,prevRow:n[s-1],nextRow:n[s+1]}):c)}))))):a.createElement("div",{className:"text-gray-300 p-2 noselect"},"No data"),u?a.createElement(Pagination,{...this.props.pagination,totalRows:null!==(t=null===(e=this.props.pagination)||void 0===e?void 0:e.totalRows)&&void 0!==t?t:n.length}):null)))}}class Pagination extends a.Component{render(){const{onPageChange:e,page:t=1,onPageSizeChange:n,pageSize:l=jt[0],totalRows:o}=this.props,i=n=>{t!==n&&(null==e||e(n))};let r=0;if(o&&(r=Math.floor(o/l)),!r)return null;const c=1===t?"Already at first page":void 0,d=t===r?"Already at last page":void 0;return c&&d?null:a.createElement("div",{className:"flex-row p-p5 mt-auto ai-center"},a.createElement(Btn_Btn,{iconPath:s.lTc,disabledInfo:c,onClick:e=>{i(1)}}),a.createElement(Btn_Btn,{iconPath:s.gAv,disabledInfo:c,onClick:e=>{i(Math.max(1,t-1))}}),a.createElement("input",{type:"number",key:Date.now(),className:"h-fit min-w-0 p-p5",style:{width:`${(t||0).toString().length+5}ch`},value:t,onChange:e=>{let t=+e.target.value;t>0&&t<=r&&i(t)}}),a.createElement(Btn_Btn,{iconPath:s.zrb,disabledInfo:d,onClick:e=>{i(Math.min(r,t+1))}}),a.createElement(Btn_Btn,{iconPath:s.DEh,disabledInfo:d,onClick:e=>{i(r)}}),n?a.createElement(FormField,{title:"Page size",asColumn:!0,value:l,options:jt.map((e=>`${e}`)),onChange:e=>{n(+e)}}):null,a.createElement("div",{className:"text-gray-400 text-sm p-p5 noselect"},(+r).toLocaleString()," pages ",` (${(+(null!=o?o:0)).toLocaleString()} rows)`))}}function zt(){const e=e=>{if(window.isIOSDevice){const t=e.currentTarget;t._isPressed&&clearTimeout(t._isPressed),t._isPressed=null}};return{onTouchStart:e=>{if(window.isIOSDevice){const t=e.currentTarget;e.preventDefault(),t._isPressed=setTimeout((()=>{if(t._isPressed){var e=new MouseEvent("contextmenu",{bubbles:!0,cancelable:!1,view:window,button:2,buttons:0,clientX:t.getBoundingClientRect().x,clientY:t.getBoundingClientRect().y});t.dispatchEvent(e)}}),500)}},onTouchMove:e,onTouchEnd:e}}class Pan extends a.Component{constructor(){super(...arguments),this.setListeners=()=>{this.ref&&Nl(this.ref,{onPanStart:this.props.onPanStart,onPan:this.props.onPan,onPanEnd:this.props.onPanEnd,onRelease:this.props.onRelease,onPress:this.props.onPress,threshold:this.props.threshold,onDoubleTap:this.props.onDoubleTap})}}componentDidMount(){this.setListeners()}render(){const{style:e={},className:t="",children:n}=this.props;return a.createElement("div",{ref:e=>{e&&(this.ref=e)},style:e,className:t},n)}}function Yt(e,t){var n;return null===(n=t.map((t=>({av:t,diff:Math.abs(e-t)}))).sort(((e,t)=>e.diff-t.diff))[0])||void 0===n?void 0:n.av}var Vt=n(42330);const Gt=["Function","Aggregate Function"];class AddColMenu extends RTComp{constructor(){super(...arguments),this.state={args:{},addTo:"Start"}}onMount(){console.error("Fix bug: test functions before displaying")}onDelta(e,t,n){(null==e?void 0:e.selectedColumn)&&!this.state.column&&this.setState({column:e.selectedColumn})}render(){var e,t,n,l,o,i,r,d,m;const{cols:p,onClose:u,onAdd:h,columns:g,tableHandler:f,selectedColumn:E}=this.props,{colType:v="Function",column:b,func:y,args:N,template_string_hint:w,template_string_error:S,addTo:T}=this.state,C=(null===(e=this.state)||void 0===e?void 0:e.name)||((null===(t=null==y?void 0:y.def)||void 0===t?void 0:t.label)?`${null===(n=null==y?void 0:y.def)||void 0===n?void 0:n.label.toUpperCase()}(${b||""}${(null===(l=null==N?void 0:N.$duration)||void 0===l?void 0:l.otherColumn)?` TO ${null===(o=null==N?void 0:N.$duration)||void 0===o?void 0:o.otherColumn}`:""})`:"")||"col_name";let _=g;y&&(y.def.tsDataTypeCol||y.def.udtDataTypeCol)&&(_=g.filter((e=>"any"===y.def.tsDataTypeCol||"any"===y.def.udtDataTypeCol||(y.def.tsDataTypeCol?y.def.tsDataTypeCol.includes(e.tsDataType):!!y.def.udtDataTypeCol&&y.def.udtDataTypeCol.includes(e.udt_name)))));const x=y&&!(null==y?void 0:y.def.tsDataTypeCol)&&!(null==y?void 0:y.def.udtDataTypeCol),A="$template_string"===(null==y?void 0:y.def.key)?!S:"$duration"===(null===(i=null==y?void 0:y.def)||void 0===i?void 0:i.key)?!!(null===(r=null==N?void 0:N.$duration)||void 0===r?void 0:r.otherColumn):Boolean(y&&(b||x));return a.createElement(Popup,{open:!0,title:"Add computed column",positioning:"as-is",rootStyle:{top:window.isMobileDevice?0:"2em",left:window.isMobileDevice?0:"2em",maxHeight:window.isIOSDevice?"100%":"calc(100vh - 4em)",maxWidth:"calc(100vw - 4em)"},clickCatchStyle:{opacity:.25,backdropFilter:"blur(1px)"},footerButtons:[{label:"Add",variant:"filled",color:"action",iconPath:s.qX5,disabledInfo:A?void 0:"Some function inputs are missing",onClick:()=>{if(C)if(null==p?void 0:p.find((e=>e.name===C)))alert("Column name already in use: "+C);else{if(!y)return void alert("Something went wrong");h({name:C,show:!0,width:130,computedConfig:{funcDef:y.def,column:b,...y.def.outType,args:yo(N)?void 0:N}},T),null==u||u()}else alert("Provide a column name")}},{onClickClose:!0,label:"Cancel",variant:"outline"}],onClose:u},a.createElement(Select_Select,{className:"mt-1",label:"Column type",variant:"pill",options:Gt,value:v,onChange:e=>{this.setState({colType:e,func:void 0,column:void 0})}}),a.createElement("div",{className:"flex-row  f-1 min-h-0 mt-1"},b?a.createElement("div",{className:"flex-col f-1 min-h-0 mt-1 mr-1"},a.createElement("label",{className:"noselect f-0 text-gray-500 ta-left  mb-p5 "},"Column"),a.createElement(Btn_Btn,{variant:"filled",style:{backgroundColor:"rgb(0, 183, 255)"},onClick:()=>{this.setState({column:void 0})}},b)):x?null:a.createElement(SearchList,{id:"cols-elect",className:"mt-1 mr-1 f-1",label:"Columns "+(y?`for ${y.key}`:""),items:_.map((e=>({key:e.name,label:e.name,subLabel:e.udt_name,onPress:()=>{this.setState({column:e.name})}})))}),y?a.createElement("div",{className:"flex-col mt-1"},a.createElement("label",{className:"noselect f-0 text-gray-500 ta-left  mb-p5 "},"Function"),a.createElement(Btn_Btn,{variant:"filled",style:{backgroundColor:"rgb(0, 183, 255)"},onClick:()=>{this.setState({func:void 0})}},y.def.label)):a.createElement(SearchList,{className:"mt-1 f-1",id:"func_type",label:"Functions "+(b?`for ${b}`:""),items:("Aggregate Function"===v?Qt.map((e=>({...e,label:e.name,subLabel:e.label}))):Xt()).filter((e=>{var t,n;let a=_;return b&&(a=g.filter((e=>e.name===b))),!e.tsDataTypeCol&&!e.udtDataTypeCol||"any"===e.tsDataTypeCol||"any"===e.udtDataTypeCol||Array.isArray(e.udtDataTypeCol)&&(null===(t=e.udtDataTypeCol)||void 0===t?void 0:t.find((e=>a.some((t=>t.udt_name===e)))))||Array.isArray(e.tsDataTypeCol)&&(null===(n=e.tsDataTypeCol)||void 0===n?void 0:n.find((e=>a.some((t=>t.tsDataType===e)))))})).map((e=>({...e,contentLeft:a.createElement(c(),{size:1.25,path:s.oVB}),onPress:()=>{this.setState({func:{def:e,key:e.key,isAgg:"Aggregate Function"===v},args:{}})}})))})),y&&"$template_string"===y.def.key&&a.createElement(a.Fragment,null,a.createElement(FormField,{className:"mt-1",asColumn:!0,value:null!==(d=null==N?void 0:N.$template_string)&&void 0!==d?d:"",label:"Template string",hint:null!=w?w:"Use column names. E.g.: Dear {FirstName} {LastName}",error:S,onChange:async e=>{let t;if(f&&f.find)try{t=await f.find({},{returnType:"value",limit:1,select:{val:{$template_string:[e]}}}),this.setState({args:{$template_string:e},template_string_error:void 0,template_string_hint:t})}catch(e){this.setState({template_string_error:e})}else this.setState({args:{$template_string:e},template_string_error:void 0})}}),a.createElement("div",{className:"flex-row-wrap"},g.map(((e,t)=>a.createElement("div",{key:t,className:"p-p25"},`{${e.name}}`))))),"$duration"===(null==y?void 0:y.key)&&((null===(m=null==N?void 0:N.$duration)||void 0===m?void 0:m.otherColumn)?a.createElement("div",{className:"flex-col mt-1"},a.createElement("label",{className:"noselect f-0 text-gray-500 ta-left  mb-p5 "},"Compare to"),a.createElement(Btn_Btn,{variant:"filled",style:{backgroundColor:"rgb(0, 183, 255)"},onClick:()=>{this.setState({args:{}})}},N.$duration.otherColumn)):a.createElement(SearchList,{id:"duration_othercolumn",label:"Compare to column",items:g.filter((e=>e.name!==b&&"Date"===e.tsDataType)).map((e=>({key:e.name,label:e.label,onPress:()=>{this.setState({args:{$duration:{otherColumn:e.name}}})}})))})),A&&a.createElement(a.Fragment,null,a.createElement(FormField,{label:"Name",type:"text",className:"mt-1",asColumn:!0,value:C,onChange:e=>{this.setState({name:e})}}),a.createElement(Select_Select,{className:"mt-1",value:T,label:"Add to",options:["Start","End"],onChange:e=>this.setState({addTo:e})})))}}const Jt={string:{udt_name:"text",tsDataType:"string"},number:{udt_name:"numeric",tsDataType:"number"},date:{udt_name:"date",tsDataType:"Date"},interval:{udt_name:"interval",tsDataType:"any"},geo:{udt_name:"geography",tsDataType:"any"}};function Xt(){return[...[{key:"$ST_Length",label:"ST_Length",subLabel:"returns the 2D Cartesian length of the geometry if it is a LineString, MultiLineString, ST_Curve, ST_MultiCurve."},{key:"$ST_AsText",label:"ST_AsText",subLabel:"Returns the OGC Well-Known Text (WKT) representation of the geometry/geography"},{key:"$ST_AsGeoJSON",label:"ST_AsGeoJSON",subLabel:"Returns a geometry as a GeoJSON 'geometry', or a row as a GeoJSON 'feature'"},{key:"$ST_SnapToGrid",label:"ST_SnapToGrid",subLabel:"Snap all points of the input geometry to the grid defined by its origin and cell size. Remove consecutive points falling on the same cell"}].map((e=>({...e,outType:Jt.geo,udtDataTypeCol:["geography","geometry"]}))),...[{key:"$datetime",label:"Date and time",subLabel:"timestamp formated as YYYY-MM-DD HH24:MI"},{key:"$timedate",label:"Time and date",subLabel:"timestamp formated as HH24:MI YYYY-MM-DD"},{key:"$D",label:"Day of week number",subLabel:"timestamp formated as D. Day of the week, Sunday (1) to Saturday (7)"},{key:"$dy",label:"Day name short",subLabel:"timestamp formated as dy. Abbreviated lower case day name (3 chars in English, localized lengths vary)"},{key:"$Dy",label:"Day Name short",subLabel:"timestamp formated as Dy. Abbreviated capitalized day name (3 chars in English, localized lengths vary)"},{key:"$DD",label:"Day of month",subLabel:"timestamp formated as DD. Day of month (01-31)"},{key:"$ID",label:"ISO 8601 day of the week",subLabel:"timestamp formated as ID. Monday (1) to Sunday (7)"},{key:"$MM",label:"Month number",subLabel:"timestamp formated as MM. Month number (01-12)"},{key:"$yy",label:"Year short",subLabel:"timestamp formated as YY. Last 2 digits of year"},{key:"$day",label:"Day name",subLabel:"timestamp formated as day. Full lower case day name"},{key:"$Day",label:"Day Name",subLabel:"timestamp formated as Day. Full capitalized day name"},{key:"$mon",label:"Month name short",subLabel:"timestamp formated as mon. Abbreviated lower case month name (3 chars in English, localized lengths vary)"},{key:"$Mon",label:"Month Name short",subLabel:"timestamp formated as Mon. Abbreviated capitalized month name (3 chars in English, localized lengths vary)"},{key:"$month",label:"Month name",subLabel:"timestamp formated as month. Full lower case month name "},{key:"$Month",label:"Month Name",subLabel:"timestamp formated as Month. Full capitalized month name "},{key:"$date",label:"Date",subLabel:"timestamp formated as YYYY-MM-DD"},{key:"$time",label:"Time",subLabel:"timestamp formated as HH24:MI. 24 Hour time format"},{key:"$yyyy",label:"Year full",subLabel:"timestamp formated as yyyy. Year (4 or more digits)"},{key:"$time12",label:"Time 12H",subLabel:"timestamp formated as HH:MI. 12 Hour time format"},{key:"$timeAM",label:"Time AM/PM",subLabel:"timestamp formated as HH:MI AM. 24 Hour time format with AM/PM meridiem indicators"},{key:"$age",label:"AGE",subLabel:"Age of timestamp compared to start of today"},{key:"$ageNow",label:"Age exact",subLabel:"Age of timestamp compared to now"},{key:"$duration",label:"Duration",subLabel:"Duration between another date field. Expressed as an interval of years, months, days, minutes"}].map((e=>({...e,outType:e.key.includes("$age")||e.key.includes("duration")?Jt.interval:Jt.string,tsDataTypeCol:["Date"],udtDataTypeCol:["int8"]}))),...[{key:"$trim",label:"TRIM",subLabel:"Remove spaces or set of characters from the leading or trailing or both side from a string"},{key:"$upper",label:"Uppercase",subLabel:"Convert all characters to uppercase"},{key:"$lower",label:"Lowercase",subLabel:"Convert all characters to lowercase"},{key:"$length",label:"Length",subLabel:"Number of characters in the string"},{key:"$reverse",label:"Reverse",subLabel:"Arrange a string in reverse order"},{key:"$initcap",label:"Capitalise Initials",subLabel:"Convert the first letter of each word to upper case and the remaining to lower case"},{key:"$unnest_words",label:"Split into words",subLabel:"Split text from a column at spaces"}].map((e=>({...e,outType:Jt.string,tsDataTypeCol:["string"]}))),...[{key:"$ceil",label:"Ceil",subLabel:"Smallest integer which is greater than, or equal to, the specified numeric expression"},{key:"$floor",label:"Floor",subLabel:"Smallest integer which is lower than, or equal to, the specified numeric expression"},{key:"$sign",label:"Sign",subLabel:"Returns -1 0 or 1 depending of the column value. Returns null if null is provided"},{key:"$round",label:"Round",subLabel:"Round to nearest integer"}].map((e=>({...e,outType:Jt.number,tsDataTypeCol:["number"]}))),...[{key:"$template_string",label:"Template string",subLabel:"Create a string based on column values. E.g.: Dear {FirstName} {LastName}, ..."}].map((e=>({...e,outType:Jt.string})))].map((e=>({...e})))}const Kt=["number","Date"],Qt=[{key:"$countAll",name:"COUNT ALL",label:"Count all rows",tsDataTypeCol:void 0,outType:Jt.number},{key:"$count",name:"COUNT",label:"Count of rows for which the column value is not null",tsDataTypeCol:"any",outType:Jt.number},{key:"$max",name:"MAX",label:"Maximum value",tsDataTypeCol:Kt,outType:Jt.number},{key:"$min",name:"MIN",label:"Minimum value",tsDataTypeCol:Kt,outType:Jt.number},{key:"$avg",name:"AVERAGE",label:"Average value",tsDataTypeCol:Kt,outType:Jt.number},{key:"$sum",name:"SUM",label:"Sum of all non-null input values",tsDataTypeCol:Kt,outType:Jt.number},{key:"$string_agg",name:"AGGREGATE STRING",label:"Non-null string/text values concatenated into a string, separated by delimiter",tsDataTypeCol:["string"],outType:Jt.string}];function Zt(e){const{className:t,iconPath:n=s.EaN,style:l={},variant:o,children:i,color:r="warning",iconSize:d=1.25}=e;let m="";const p="warning"===r?"yellow":"action"===r?"blue":"danger"===r?"red":"gray";return m="filled"===o?`b b-${p}-300 text-${p}-700 bg-${p}-10 px-1 py-p75`:"naked"===o?`text-${p}-700 `:`b b-${p}-300 text-${p}-700 px-1 py-p75`,a.createElement("div",{className:` rounded flex-row ai-start ta-left ${m} `+t,style:l},n&&n.length>0&&a.createElement(c(),{path:n,size:d,className:"f-0",style:{marginRight:"10px"}}),a.createElement("div",{className:"min-s-0 f-1 as-center",style:{whiteSpace:"pre-line"}},i))}const en=({query:e,sql:t,hint:n,onSuccess:l,onCancel:o})=>{const[i,r]=(0,a.useState)(),[c,d]=(0,a.useState)(!1),[m,p]=(0,a.useState)(e),u=Io(),h=async(e=m)=>{try{if(d(!0),await t(m),!u())return;null==l||l(),r(void 0)}catch(e){if(!u())return;r(e)}d(!1)};return a.createElement("div",{className:"flex-col gap-1"},a.createElement(SQLEditor,{className:"b b-gray-300 rounded o-hidden mt-1",autoFocus:!1,value:m,style:{minHeight:"200px",minWidth:"350px"},sql:t,onChange:e=>{p(e),r(void 0)},onRun:h,sqlOptions:{executeOptions:"full",errorMessageDisplay:"both"}}),i&&a.createElement(ErrorComponent,{error:i}),!!n&&a.createElement(Zt,{color:"info"},n),a.createElement(E,null,!!o&&a.createElement(Btn_Btn,{variant:"outline",onClick:o},"Cancel"),a.createElement(Btn_Btn,{style:{alignSelf:"flex-end"},color:"action",iconPath:s._86,variant:"outline",title:"Run rename query",loading:c,onClick:()=>h()},"RUN")))};class ColumnsMenu extends RTComp{constructor(){super(...arguments),this.state={addColMenu:void 0,query:void 0},this.onDelta=async(e,t,n)=>{const a=this.props.w;a&&a.$cloneSync&&!this.wSub&&(this.wSub=await a.$cloneSync(((e,t)=>{this.setState({w:e})})))}}render(){var e;const{w:t,addColMenu:n,query:l}=this.state,{db:o,tables:i,tableName:r,nestedTable:d,onClose:m,showAddCompute:p}=this.props,u=null==t?void 0:t.columns;if(!t||!u)return null;let h=i.find((e=>e.name===r)),g=$l(i,t),f=e=>{if(d){let n={...t.nested_tables[d]};return n.cols=e,t.$update({nested_tables:{...t.nested_tables,[d]:n}})}return t.$update({columns:e})};if(d&&t.nested_tables[d]&&(h=i.find((e=>e.name===d)),g=null!==(e=t.nested_tables[d].cols)&&void 0!==e?e:$l(i,{table_name:d})),!h)return a.createElement("div",null,"table ",d||r," not found");let E=null;return(n||p)&&(E=a.createElement(AddColMenu,{tableHandler:o[r],selectedColumn:null==p?void 0:p.colName,columns:h.columns,onAdd:(e,n)=>{if(d){let n={...t.nested_tables[d]};n.cols=n.cols.concat([e]),t.$update({sort:[],nested_tables:{...t.nested_tables,[d]:n}})}else{let a=(null==u?void 0:u.map((e=>({...e}))))||[];"Start"===n?a.unshift(e):a.push(e),t.$update({sort:[],columns:a})}},anchorEl:n,cols:g,onClose:m})),l?a.createElement("div",{className:"flex-col f-1 min-h-0 p-1"},a.createElement(en,{sql:o.sql,query:l.sql,hint:l.hint})):a.createElement("div",{className:"flex-col f-1 min-h-0"},E,a.createElement(SearchList,{id:"cols",onReorder:async e=>{await f(e.map((e=>({...e.data,show:e.checked}))))},limit:200,className:"f-1",onMultiToggle:e=>{let t=u.slice(0).map((t=>{var n,a;return{...t,show:null!==(a=null===(n=e.find((e=>e.key===t.name)))||void 0===n?void 0:n.checked)&&void 0!==a?a:t.show}}));f(t)},items:g.sort(((e,t)=>+Boolean(t.show)-+Boolean(e.show))).map((e=>{var t,n,l,o,i,r,d,m,p,h,g,E;return{key:e.name,label:e.name+((null===(t=e.info)||void 0===t?void 0:t.references)?`    (${null===(n=e.info)||void 0===n?void 0:n.references.map((e=>e.ftable)).join(", ")})`:""),subLabel:null===(l=e.info)||void 0===l?void 0:l.udt_name,data:e,title:(null===(o=e.info)||void 0===o?void 0:o.udt_name)||"computed",contentLeft:a.createElement(c(),{size:1,className:"mr-p5 text-gray-400",style:{color:oo(e.info,"var(--gray-400)")},path:e.computedConfig?s.WiQ:["geometry","geography"].includes(null!==(r=null===(i=e.info)||void 0===i?void 0:i.udt_name)&&void 0!==r?r:"")?s.bTi:"any"===(null===(d=e.info)||void 0===d?void 0:d.tsDataType)?s.UgG:"string"===(null===(m=e.info)||void 0===m?void 0:m.tsDataType)?s.H3X:"Date"===(null===(p=e.info)||void 0===p?void 0:p.tsDataType)?s.xnT:"number"===(null===(h=e.info)||void 0===h?void 0:h.tsDataType)?s.tkb:"boolean"===(null===(g=e.info)||void 0===g?void 0:g.tsDataType)?s.$hB:(null===(E=e.info)||void 0===E?void 0:E.tsDataType.startsWith("Array"))?s.Nqu:s.NJC}),contentRight:e.computedConfig?a.createElement(Btn_Btn,{className:"text-red-700",color:"inherit",title:e.format?"Remove formatting":"Remove computed field",iconPath:s.x9U,onClick:t=>{let n;t.stopPropagation(),n=e.format?u.map((t=>{if(t.name===e.name){let e={...t,computed:!1};return delete e.format,e}return t})):u.filter((t=>t.name!==e.name)),f(n)}}):void 0,onPress:()=>{let t=u.slice(0).map((e=>({...e}))).map((t=>(t.name===e.name&&(t.show=!e.show),t)));f(t)},checked:e.show}}))}),a.createElement("div",{className:"flex-col p-1"},a.createElement(Btn_Btn,{className:"mt-1",iconPath:s.qX5,variant:"outline",size:"small",onClick:e=>{this.setState({addColMenu:e.currentTarget})}},"Add computed column"),a.createElement(Btn_Btn,{className:"my-1 ",disabledInfo:o.sql?(null==h?void 0:h.info.is_view)?"This is a view. Cannot create columns, must recreate":void 0:"Not enough privileges",iconPath:s.qX5,variant:"outline",size:"small",onClick:e=>{this.setState({query:{sql:`ALTER TABLE ${(0,Vt.asName)(r)} \nADD COLUMN new_colname INTEGER`,hint:"New column will not appear instantly in the menu"}})}},"Create column")))}}const tn=({columns:e,onChange:t,label:n,value:l})=>{const o=e.map((e=>{var t;return{key:e.name,label:e.name+((null==e?void 0:e.references)?`    (${null==e?void 0:e.references.map((e=>e.ftable)).join(", ")})`:""),subLabel:null==e?void 0:e.udt_name,data:e,title:(null==e?void 0:e.udt_name)||"computed",contentLeft:a.createElement(W,{size:1,className:"mr-p5 text-gray-400",style:{color:oo(e,"var(--gray-400)")},path:["geometry","geography"].includes(null!==(t=null==e?void 0:e.udt_name)&&void 0!==t?t:"")?s.bTi:"any"===(null==e?void 0:e.tsDataType)?s.UgG:"string"===(null==e?void 0:e.tsDataType)?s.H3X:"Date"===(null==e?void 0:e.tsDataType)?s.xnT:"number"===(null==e?void 0:e.tsDataType)?s.tkb:"boolean"===(null==e?void 0:e.tsDataType)?s.$hB:(null==e?void 0:e.tsDataType.startsWith("Array"))?s.Nqu:s.NJC})}}));return a.createElement("div",{className:"flex-row ai-end"},a.createElement(FormField,{asColumn:!0,label:n,value:l,fullOptions:o,onChange:t}),a.createElement(Btn_Btn,{iconPath:s.r5M,onClick:()=>{t()}}))};const nn=["Realtime","Interval","None"];class ProstglesTableMenu extends RTComp{constructor(){super(...arguments),this.state={l1Key:void 0,l2Key:void 0,query:void 0,running:void 0,error:void 0,initError:void 0,hint:void 0,indexes:void 0,columnsConfig:void 0,infoQuery:void 0,autoRefreshSeconds:void 0,tableMeta:void 0},this.d={w:void 0},this.onUnmount=async()=>{this.wSub&&await this.wSub.$unsync()},this.loading=!1,this.onDelta=async(e,t,n)=>{const{db:a,tableName:l,cols:o,dbs:i}=this.props,s=this.d.w||this.props.w;l&&(null==s?void 0:s.$cloneSync)&&!this.loading&&(this.loading=!0,this.wSub=await s.$cloneSync(((e,t)=>{this.setData({w:e},{w:t})})),this.getTableInfo()),t&&"query"in t&&this.setState({error:void 0})}}getTableInfo(){const{db:e,tableName:t}=this.props;t&&e.sql&&async function(e,t){if(!e.sql)throw"db.sql not allowed";try{const n=await e.sql("\n      SELECT conname, pg_get_constraintdef(c.oid) as definition \n      FROM pg_catalog.pg_constraint c\n        INNER JOIN pg_catalog.pg_class rel\n        ON rel.oid = c.conrelid\n        INNER JOIN pg_catalog.pg_namespace nsp\n        ON nsp.oid = connamespace\n        WHERE nsp.nspname = 'public'\n            AND rel.relname = ${tableName};",{tableName:t},{returnType:"rows"}),a=await e.sql("\n      SELECT tablename, indexname, indexdef\n      FROM pg_indexes\n      WHERE schemaname = 'public' AND tablename=${tableName}",{tableName:t},{returnType:"rows"}),l=await e.sql('\n      SELECT\n        relname  as table_name,\n        pg_size_pretty(pg_total_relation_size(relid)) As "Total Size",\n        pg_size_pretty(pg_total_relation_size(relid) - pg_relation_size(relid)) as "Index Size",\n        pg_size_pretty(pg_relation_size(relid)) as "Actual Size",\n        (SELECT COUNT(*) FROM ${tableName:name}) as "Row count"\n      FROM pg_catalog.pg_statio_user_tables \n      WHERE relname=${tableName}\n      ORDER BY pg_total_relation_size(relid) DESC;\n    ',{tableName:t},{returnType:"row"})||{},o=await e.sql("SELECT obj_description(format('%I', $1)::regclass::oid) as c FROM pg_class LIMIT 1",[t],{returnType:"value"}),i=await e.sql("\n      SELECT event_object_table\n        ,trigger_name\n        ,event_manipulation\n        ,action_statement\n        ,action_timing\n        ,CASE WHEN pg_catalog.starts_with(action_statement, 'EXECUTE FUNCTION ') THEN pg_get_functiondef(RIGHT(action_statement, -17 )::regprocedure) ELSE '' END as function_def\n      FROM  information_schema.triggers\n      WHERE event_object_table = ${tableName}\n      ORDER BY event_object_table\n      ,event_manipulation\n    ",{tableName:t},{returnType:"rows"}),s=await e.sql("\n      SELECT CASE WHEN  c.relkind = 'm' THEN 'Materialized view' \n              WHEN  c.relkind = 'v' THEN 'View' ELSE 'Table' END as vtype\n      FROM pg_catalog.pg_class c\n      JOIN pg_namespace n ON n.oid = c.relnamespace\n      WHERE c.relkind in ('m', 'v')\n      AND n.nspname = \"current_schema\"()\n      AND c.relname = ${tableName}",{tableName:t},{returnType:"row"});return{constraints:n,indexes:a,sizeInfo:l,comment:o,triggers:i,type:(null==s?void 0:s.vtype)||"Table"}}catch(e){throw console.error(e),e}}(e,t).then((async e=>{this.setState({tableMeta:e})})).catch((e=>{this.setState({initError:e})}))}render(){var e,t,n,l,o,i,r,c,d,p,u,h,g,f,E,v,b;const{tableName:y,db:N,workspace:w,onClose:S,w:T,tables:C}=this.props,{infoQuery:_,l1Key:x,query:A,initError:R,tableMeta:L,linkTablePath:O}=this.state;if(R)return a.createElement("div",{className:"p-1 relative"},a.createElement(ErrorComponent,{error:R}));const I=C.find((e=>e.name===y));let D,k=null;if(A&&(k=a.createElement(en,{key:A.sql,sql:N.sql,query:A.sql,hint:A.hint,onSuccess:()=>{this.setState({query:void 0}),this.getTableInfo()},onCancel:()=>{this.setState({query:void 0})}})),T.table_name){const _=$l(C,T);D={Columns:{leftIconPath:s.B9t,content:a.createElement(ColumnsMenu,{w:T,db:N,tableName:y,tables:C,onClose:S})},"Data Refresh":{leftIconPath:s.vqH,style:"None"===((null===(t=null===(e=T.options)||void 0===e?void 0:e.refresh)||void 0===t?void 0:t.type)||"None")?{}:{color:"var(--blue-600)"},content:an(T)},Triggers:{label:L?"Triggers "+L.triggers.length:void 0,disabledText:N.sql?void 0:"Not enough privileges",leftIconPath:s.Ake,content:L?a.createElement("div",{className:"flex-col  ws-pre gap-1"},!!L.triggers.length&&a.createElement("div",{className:"flex-row ai-center mb-1"},a.createElement(Btn_Btn,{iconPath:s.qX5,className:"f-0 mr-1 ",variant:"outline",onClick:()=>{this.setState({query:{sql:`ALTER TABLE ${(0,m.asName)(y)} DISABLE TRIGGER ALL`}})}},"Disable all triggers"),a.createElement(Btn_Btn,{iconPath:s.qX5,className:"  f-0",variant:"outline",onClick:()=>{this.setState({query:{sql:`ALTER TABLE ${(0,m.asName)(y)} ENABLE TRIGGER ALL`}})}},"Enable all triggers")),a.createElement("div",{className:"flex-col f-1 min-h-0 o-auto"},L.triggers.map(((e,t)=>a.createElement("div",{key:t,className:"flex-row ai-center"},a.createElement("div",{className:"flex-row mr-1 "},a.createElement(Btn_Btn,{iconPath:s.x9U,title:"Drop trigger",onClick:()=>{this.setState({query:{sql:`DROP TRIGGER ${(0,m.asName)(e.trigger_name)} ON ${(0,m.asName)(y)} ;`}})}}),a.createElement(Btn_Btn,{iconPath:s.oVB,title:"View trigger function",onClick:()=>{this.setState({query:{sql:e.function_def}})}})),a.createElement(Chip,{variant:"naked",label:e.trigger_name,value:`${e.action_timing} ${e.event_manipulation} ${e.action_statement}`}))))),k,!k&&a.createElement(Btn_Btn,{iconPath:s.qX5,color:"action",variant:"filled",onClick:()=>{this.setState({query:{sql:ln(y)}})}},"Add trigger")):null},Constraints:{label:L?"Constraints "+L.constraints.length:void 0,leftIconPath:s.cU4,disabledText:N.sql?void 0:"Not enough privileges",content:L?a.createElement("div",{className:"flex-col ai-start o-auto ws-pre"},a.createElement(Btn_Btn,{iconPath:s.qX5,className:"mb-1 f-0",variant:"outline",onClick:()=>{this.setState({query:{sql:`ALTER TABLE ${(0,m.asName)(y)} \nADD CONSTRAINT "my_constraint" \nPRIMARY KEY (\n${_.slice(0,2).map((e=>(0,m.asName)(e.name))).join(", \n")}\n);`}})}},"Add"),a.createElement("div",{className:"flex-col f-1 min-h-0 o-auto gap-p25"},L.constraints.map(((e,t)=>a.createElement(Chip,{key:t,style:{alignItems:"start",textAlign:"left"},label:e.conname,value:e.definition,onDelete:()=>{this.setState({query:{sql:`ALTER TABLE ${(0,m.asName)(y)} DROP CONSTRAINT ${(0,m.asName)(e.conname)};`}})}})))),k):null},Indexes:{label:L?"Indexes "+L.indexes.length:void 0,leftIconPath:s.Iv1,disabledText:N.sql?void 0:"Not enough privileges",content:L?a.createElement("div",{className:"flex-col ws-pre"},a.createElement("div",{className:"flex-row ai-center mb-1 f-0"},a.createElement(Btn_Btn,{iconPath:s.qX5,className:"mr-1",variant:"outline",onClick:()=>{this.setState({query:{sql:`CREATE INDEX ON public.${(0,m.asName)(y)} (${_.map((e=>e.name)).join(", ")})`,hint:"Add new index"}})}},"Add"),a.createElement(Btn_Btn,{iconPath:s.B9W,variant:"outline",onClick:()=>{this.setState({query:{sql:`REINDEX TABLE  ${(0,m.asName)(y)}`,hint:"REINDEX is similar to a drop and recreate of the index in that the index contents are rebuilt from scratch"}})}},"Reindex table")),a.createElement("div",{className:"flex-col f-1 min-h-0 o-auto"},L.indexes.map(((e,t)=>a.createElement("div",{key:t,className:"flex-row ai-center"},a.createElement("div",{className:"flex-row mr-1 "},a.createElement(Btn_Btn,{iconPath:s.x9U,onClick:()=>{this.setState({query:{sql:`DROP INDEX ${(0,m.asName)(e.indexname)}`}})}}),a.createElement(Btn_Btn,{iconPath:s.B9W,onClick:()=>{this.setState({query:{sql:`REINDEX INDEX  ${(0,m.asName)(e.indexname)}`,hint:"REINDEX is similar to a drop and recreate of the index in that the index contents are rebuilt from scratch"}})}})),a.createElement(Chip,{variant:"naked",value:e.indexdef}))))),k):null},"Table info":{label:(null==I?void 0:I.info.is_view)?"View info":void 0,leftIconPath:s.EaN,disabledText:N.sql?void 0:"Not enough privileges",content:L?a.createElement("div",{className:"flex-col ai-start o-auto"},a.createElement(Chip,{className:" ",variant:"naked",label:"Type",value:L.type}),a.createElement("div",{className:"flex-row mr-1 ai-center"},a.createElement(Chip,{className:" ",variant:"naked",label:"Name",value:y}),a.createElement(Btn_Btn,{iconPath:s.r9,variant:"text",onClick:()=>{this.setState({query:{sql:`ALTER TABLE ${(0,m.asName)(y)} \nRENAME TO new_table_name`}})}})),a.createElement(Chip,{className:" ",variant:"naked",label:"OID",value:null==T?void 0:T.table_oid}),a.createElement("div",{className:"flex-row mr-1 ai-center"},a.createElement(Chip,{className:" ",variant:"naked",label:"Comment",value:null==L?void 0:L.comment}),a.createElement(Btn_Btn,{iconPath:s.r9,variant:"text",onClick:()=>{this.setState({query:{sql:`COMMENT ON TABLE ${(0,m.asName)(y)} IS 'My comment';`}})}})),a.createElement("h4",{className:""},"Size on disk"),a.createElement(Chip,{className:"mb-p5",variant:"naked",label:"Actual Size",value:null===(n=L.sizeInfo)||void 0===n?void 0:n["Actual Size"]}),a.createElement(Chip,{className:"mb-p5",variant:"naked",label:"Index Size",value:null===(l=L.sizeInfo)||void 0===l?void 0:l["Index Size"]}),a.createElement(Chip,{className:"mb-p5",variant:"naked",label:"Total Size",value:null===(o=L.sizeInfo)||void 0===o?void 0:o["Total Size"]}),a.createElement(Chip,{className:"mb-p5",variant:"naked",label:"Row count",value:(+((null===(i=L.sizeInfo)||void 0===i?void 0:i["Row count"])||0)).toLocaleString()}),a.createElement("div",{className:"flex-row-wrap gap-p5 mr-1 ai-center mt-1 "},a.createElement(Btn_Btn,{className:"mr-1",iconPath:s.B9W,variant:"outline",onClick:()=>{this.setState({query:{sql:`VACUUM ${(0,m.asName)(y)} `,hint:"Garbage-collect and optionally analyze a database"}})}},"Vacuum"),a.createElement(Btn_Btn,{className:"mr-1",iconPath:s.B9W,variant:"outline",onClick:()=>{this.setState({query:{sql:`VACUUM FULL ${(0,m.asName)(y)} `,hint:'Selects "full" vacuum, which can reclaim more space, but takes much longer and exclusively locks the table'}})}},"Vacuum Full"),a.createElement(Btn_Btn,{iconPath:s.vTx,color:"danger",variant:"outline",onClick:()=>{this.setState({query:{sql:`-DROP TABLE ${(0,m.asName)(y)} `,hint:'Table will be deleted from the database. Remove "-" and then run the query'}})}},"Drop")),k):null},"Display options":{leftIconPath:s.Shd,content:a.createElement("div",{className:"flex-col gap-1 ai-start mb-1 f-1 o-auto p-p25 "},a.createElement(FormField,{className:" w-fit f-0",asColumn:!0,type:"checkbox",label:"View as card",value:!!(null==T?void 0:T.options.viewAsCard),onChange:e=>{var t,n,a,l;T.$update({options:{viewAsCard:e,maxCardWidth:null!==(n=null===(t=this.d.w)||void 0===t?void 0:t.options.maxCardWidth)&&void 0!==n?n:window.isLowWidthScreen?"100%":"700px",hideEmptyCardCells:null===(l=null===(a=this.d.w)||void 0===a?void 0:a.options.hideEmptyCardCells)||void 0===l||l}},{deepMerge:!0})}}),(null==T?void 0:T.options.viewAsCard)&&I&&a.createElement(a.Fragment,null,a.createElement(FormField,{className:"w-fit f-0",asColumn:!0,type:"number",label:"Cards per row",inputProps:{step:1,min:1,max:8},value:(null==T?void 0:T.options.cardRows)||1,onChange:e=>{T.$update({options:{cardRows:Math.round(+e)}},{deepMerge:!0})}}),a.createElement(tn,{label:"Cards group by column",columns:I.columns,value:T.options.cardGroupBy,onChange:e=>{T.$update({options:{cardGroupBy:e}},{deepMerge:!0})}}),a.createElement(FormField,{className:"w-fit f-0",asColumn:!0,type:"checkbox",label:"Hide card column names",value:!!(null==T?void 0:T.options.hideCardFieldNames),onChange:e=>{T.$update({options:{hideCardFieldNames:e}},{deepMerge:!0})}}),a.createElement(Select_Select,{label:"Max card cell height in pixels",className:"w-fit f-0",value:null!==(c=null===(r=T.options)||void 0===r?void 0:r.maxCardRowHeight)&&void 0!==c?c:800,variant:"div",options:[25,50,100,150,200,300,400,500,600,700,800],onChange:e=>{T.$update({options:{maxCardRowHeight:e}},{deepMerge:!0})}}),a.createElement(Select_Select,{label:"Card width",className:"w-fit f-0",value:null!==(p=null===(d=T.options)||void 0===d?void 0:d.maxCardWidth)&&void 0!==p?p:"100%",variant:"div",options:["100%","100px","200px","300px","400px","500px","600px","700px","900px"],onChange:e=>{T.$update({options:{maxCardWidth:e}},{deepMerge:!0})}}),a.createElement(Select_Select,{label:"Card cell min width",className:"w-fit f-0",value:null!==(h=null===(u=T.options)||void 0===u?void 0:u.cardCellMinWidth)&&void 0!==h?h:"",variant:"div",options:["",...[10,20,25,30,33,40,50,60,70,80,90,100].map((e=>e+"%"))],onChange:e=>{T.$update({options:{cardCellMinWidth:e}},{deepMerge:!0})}}),a.createElement(FormField,{className:"w-fit f-0",asColumn:!0,type:"checkbox",label:"Hide empty card cells",value:!!(null==T?void 0:T.options.hideEmptyCardCells),onChange:e=>{T.$update({options:{hideEmptyCardCells:e}},{deepMerge:!0})}})),a.createElement(FormField,{className:"w-fit f-0",asColumn:!0,type:"checkbox",label:"Hide show row panel button",value:!!(null==T?void 0:T.options.hideEditRow),onChange:e=>{T.$update({options:{hideEditRow:e}},{deepMerge:!0})}}),a.createElement(FormField,{className:"w-fit f-0",asColumn:!0,type:"checkbox",label:"Hide top count",value:null!==(f=null!==(g=null==T?void 0:T.options.hideCount)&&void 0!==g?g:null==w?void 0:w.options.hideCounts)&&void 0!==f&&f,onChange:e=>{T.$update({options:{hideCount:e}},{deepMerge:!0})},hint:"If false will show the number of rows in the table header. Disable to improve performance"}),a.createElement(FormField,{className:"w-fit f-0",asColumn:!0,type:"checkbox",label:"Show data type sub headers",value:!!(null==T?void 0:T.options.showSubLabel),onChange:e=>{T.$update({options:{showSubLabel:e}},{deepMerge:!0})}}),a.createElement(FormField,{className:"w-fit f-0",asColumn:!0,type:"number",label:"Maximum number of characters per column",value:null!==(E=null==T?void 0:T.options.maxCellChars)&&void 0!==E?E:500,onChange:e=>{T.$update({options:{maxCellChars:e}},{deepMerge:!0})}}),!(null==T?void 0:T.options.viewAsCard)&&a.createElement(Select_Select,{label:"Max table row height in pixels",className:"w-fit f-0",value:null!==(b=null===(v=T.options)||void 0===v?void 0:v.maxRowHeight)&&void 0!==b?b:100,variant:"div",options:[25,50,100,150,200,300,400,500,600,700,800],onChange:e=>{T.$update({options:{maxRowHeight:e}},{deepMerge:!0})}}))}}}return a.createElement("div",{className:"table-menu c-s-fit flex-col",style:{maxHeight:"calc(100vh - 65px)",maxWidth:"100vw"}},a.createElement(Tabs,{variant:"vertical",contentClass:" min-h-0 max-h-100v flex-col "+("Columns"!==x?" p-1 ":"")+" ",items:null!=D?D:{},compactMode:window.isMobileDevice,activeKey:x,onChange:async e=>{var t,n;if(this.setState({l1Key:e,query:void 0,infoQuery:void 0}),this.d.w)if("View as card"===e)this.d.w.$update({options:{viewAsCard:!0,maxCardWidth:null!==(n=null===(t=this.d.w)||void 0===t?void 0:t.options.maxCardWidth)&&void 0!==n?n:"700px"}},{deepMerge:!0});else if("Columns"===e){const e=await ProstglesTableMenu.getWCols(N[y],T,!0);this.setState({columnsConfig:e})}else if("Filter"===e){let e={show_menu:!1};this.d.w.filter||(e.filter=[]),this.d.w.$update(e)}}}),"Columns"!==x?null:a.createElement("div",{className:"flex-col o-auto p-1"},y&&N.sql?a.createElement(a.Fragment,null,_?a.createElement(a.Fragment,null,a.createElement(FormField,{className:"mb-1",asColumn:!0,label:_.label,readOnly:!0,asTextArea:!0,value:_.query})):null):null))}}function an(e){const{refresh:t}=e.options||{},{type:n="None",intervalSeconds:l=3,throttleSeconds:o=0}=t||{},i=n=>{e.$update({options:{...e.options,refresh:{...t,...n}}})};return a.createElement("div",{className:"flex-col ai-start"},a.createElement(ButtonGroup,{options:nn,value:n,style:{marginRight:"40px",marginBottom:"1em"},onChange:e=>{i({type:e,throttleSeconds:0,intervalSeconds:3})}}),a.createElement("p",{className:"text-gray-600 noselect mt-0"},"Realtime"===n?"Changes shown as received from database. Needs super user to create triggers":"Interval"===n?"Run the query every N seconds":"Data will not be refreshed"),"Interval"===n&&a.createElement(FormField,{label:"Seconds",type:"number",value:l,asColumn:!0,hint:"0 to disable",onChange:e=>{const t=+e;i(!t||e<0?{type:"None"}:{intervalSeconds:t})}}),"Realtime"===n&&a.createElement(FormField,{label:"Throttle seconds",type:"number",asColumn:!0,value:o,onChange:e=>{i({throttleSeconds:e})}}))}ProstglesTableMenu.getWCols=async(e,t,n=!1)=>{try{if(!e||!e.getColumns)return[];let a=(await e.getColumns()).map((e=>({name:e.name,show:!0,tsDataType:e.tsDataType,computed:!1}))),l=a;if((null==t?void 0:t.columns)&&Array.isArray(t.columns)){if(t.columns.map((e=>e.name)).sort().join()!==a.map((e=>e.name)).sort().join()){let e=t.columns.map((e=>({...e}))).filter((e=>a.find((t=>t.name===e.name))));const o=a.filter((t=>!e.find((e=>e.name===t.name)))).map((e=>({name:e.name,show:!0})));e=e.concat(o),n&&await t.$update({columns:e}),l=e}}else t&&n&&await t.$update({columns:a});return l}catch(e){throw console.error(e),e}};const ln=e=>`CREATE FUNCTION ${(0,m.asName)("trig_func_"+e)}() RETURNS TRIGGER AS $$\nDECLARE\n  name1 varchar(30);\n  name2 varchar(30);\nBEGIN\n\nRETURN NULL;    \nEND;\n$$ LANGUAGE plpgsql;\n\nCREATE TRIGGER ${(0,m.asName)("trig_"+e)}\nAFTER INSERT ON ${(0,m.asName)(e)}\nFOR EACH ROW \nEXECUTE PROCEDURE ${(0,m.asName)("trig_func_"+e)}();\n`,on=(e,t)=>{const{columns:n,table_name:a}=t;let l=n||[];const o=e.find((e=>e.name===a));if(!o)return console.error("Table not found:",a),[];const i=e=>e.computedConfig;l=l.map((e=>({...e,info:i(e)?void 0:o.columns.find((t=>t.select&&t.name===e.name))}))).filter((e=>!(!e.computedConfig&&!e.info)));const s=o.columns.filter((e=>e.select&&!l.find((t=>t.info&&t.name===e.name))));return structuredClone(l.concat(s.map((e=>({info:e,name:e.name,show:!0})))))};class AddChartMenu extends a.Component{constructor(){super(...arguments),this.state={chartType:void 0}}static getChartCols(e,t){var n,a,l,o,i;let s=[],r="";if("sql"===e.type){const t=e;s=(null===(a=null===(n=t.options)||void 0===n?void 0:n.sqlResultCols)||void 0===a?void 0:a.map((e=>({...e,name:e.key}))))||[],r=null!==(o=null===(l=t.options)||void 0===l?void 0:l.lastSQL)&&void 0!==o?o:""}else{s=(null===(i=on(t,e))||void 0===i?void 0:i.map((e=>{var t,n;return{...e,udt_name:(null===(t=e.info)||void 0===t?void 0:t.udt_name)||(null===(n=e.computedInfo)||void 0===n?void 0:n.udt_name)}})))||[]}return{geoCols:s.filter((e=>["geography","geometry"].includes(e.udt_name))),dateCols:s.filter((e=>(e.udt_name||"").startsWith("timestamp")||"date"===e.udt_name)),cols:s,sql:r}}render(){const{w:e,onAddChart:t,tables:n}=this.props,{chartType:l}=this.state;if(!e)return null;const{geoCols:o,dateCols:i,cols:r,sql:c}=AddChartMenu.getChartCols(e,n),d=e.table_name,m=(n,a,l)=>{t({type:n,tableName:d,name:`${d||""} (${a})`,linkOpts:{[l]:a,sql:c,fromSelected:Boolean(e.selected_sql)}})},p=[{label:"Map",iconPath:s.dfL,cols:o,onAdd:e=>{m("map",e,"geomColumn")}},{label:"Timechart",iconPath:s.Cst,cols:i,onAdd:e=>{m("timechart",e,"dateColumn")}}];let u={};return p.map((e=>{e.cols.length&&(u[e.label]={leftIconPath:e.iconPath,label:e.label,content:a.createElement(SearchList,{label:"Choose column",id:"chart-col",items:e.cols.map((t=>({key:t.name,label:t.name,subLabel:t.udt_name,onPress:()=>{e.onAdd(t.name)}})))})})})),a.createElement("div",{className:"flex-row ",style:{}},a.createElement(Tabs,{activeKey:l,variant:"vertical",onChange:e=>{this.setState({chartType:e});const t=p.find((t=>t.label===e));1===(null==t?void 0:t.cols.length)&&t.onAdd(t.cols[0].name)},contentClass:"p-1 flex-row ai-center",items:u}))}}class ProstglesQuickMenu extends RTComp{constructor(){super(...arguments),this.state={showChartMenu:!1,myLinks:[]},this.d={},this.onDelta=async()=>{var e,t;const{dbs:n,w:a}=this.props;if((null==a?void 0:a.workspace_id)&&n&&!this.d.linksSync){const l=await(null===(t=(e=n.links).sync)||void 0===t?void 0:t.call(e,{workspace_id:a.workspace_id},{handlesOnData:!0},((e,t)=>{var n;if(!this.mounted||!a)return;const l=e.filter((e=>[e.w1_id,e.w2_id].includes(a.id)));(null===(n=this.state.myLinks)||void 0===n?void 0:n.map((e=>e.id)).sort().join())!==(null==l?void 0:l.map((e=>e.id)).sort().join())&&this.setState({myLinks:l}),this.setData({links:e},{links:t})})));this.setData({linksSync:l},{linksSync:l})}},this.getMenu=()=>null}async onUnmount(){var e,t;await(null===(t=null===(e=this.d)||void 0===e?void 0:e.linksSync)||void 0===t?void 0:t.$unsync()),this.d.linksSync=void 0}render(){var e,t,n,l,o,i,r;const{w:c,setLinkMenu:d,tables:m,onAddChart:p}=this.props,{showChartMenu:u,myLinks:h}=this.state;if(!c)return null;const g=null==m?void 0:m.find((e=>e.name===c.table_name)),f=Boolean(d&&c&&c.table_name&&(null===(e=null==g?void 0:g.joins)||void 0===e?void 0:e.length))||!!(null==h?void 0:h.length);let E,v=Boolean(null==g?void 0:g.columns.some((e=>"Date"===e.tsDataType||"geography"===e.udt_name||"geometry"===e.udt_name)));if("sql"===c.type){const e=c;v=Boolean((null===(t=null==e?void 0:e.options)||void 0===t?void 0:t.lastSQL)&&(null===(l=null===(n=null==e?void 0:e.options)||void 0===n?void 0:n.sqlResultCols)||void 0===l?void 0:l.some((e=>"timestamp"===e.udt_name||"timestamptz"===e.udt_name||"geography"===e.udt_name||"geometry"===e.udt_name))))}return g||f||v?(u&&v&&m&&p&&(E=a.createElement(AddChartMenu,{w:c,tables:m,onAddChart:p})),a.createElement(a.Fragment,null,a.createElement("div",{className:"flex-row ai-center bg-gray-300 rounded b b-gray-300 h-fit w-fit m-auto f-1 min-w-0",style:{maxWidth:"fit-content",margin:"2px 0"},ref:e=>{e&&(this.ref=e)}},f&&!!d&&a.createElement(Btn_Btn,{title:"Cross filter tables",className:"prostgles-link-btn",size:"small",iconPath:s.AvA,style:(null==h?void 0:h.length)?{color:null===(i=null===(o=null==h?void 0:h[0])||void 0===o?void 0:o.options)||void 0===i?void 0:i.color}:{},onClick:async e=>{d({w:c,anchorEl:e.target})}}),v&&a.createElement(Btn_Btn,{title:"Add chart",className:"prostgles-chart-btn",size:"small",iconPath:s.J$v,style:{},onClick:async e=>{this.setState({showChartMenu:!0})}}),g&&a.createElement(Btn_Btn,{title:"Show/Hide filtering",className:"prostgles-filter-btn",size:"small",iconPath:s.k0z,color:(null===(r=c.filter)||void 0===r?void 0:r.some((e=>{var t;return!e.disabled||"not null"===e.type||"null"===e.type||(O(e)?void 0!==(null===(t=e.filter)||void 0===t?void 0:t.value):void 0!==e.value)})))?"action":void 0,style:{},onClick:async e=>{var t;const n=c;n.$update({options:{showFilters:!(null===(t=null==n?void 0:n.options)||void 0===t?void 0:t.showFilters)}},{deepMerge:!0})}})),E&&a.createElement(Popup,{open:!0,title:"Add chart",anchorEl:this.ref,positioning:"inside",rootStyle:{padding:0},clickCatchStyle:{opacity:.5,backdropFilter:"blur(1px)"},contentClassName:"",onClose:()=>{this.setState({showChartMenu:!1})}},E))):null}}class Window extends RTComp{constructor(){super(...arguments),this.state={showMenu:!1},this.d={},this.onDelta=e=>{var t,n,a,l,o;const{w:i}=this.d,{onWChange:s}=this.props;if(this.ref&&i){const e=null!==(a=null===(n=null===(t=this.ref)||void 0===t?void 0:t.parentElement)||void 0===n?void 0:n.querySelector(":scope > .silver-grid-item-header > div > .silver-grid-item-header--title"))&&void 0!==a?a:void 0,l=Window.getTitle(i);e&&e.innerText!==l&&(e.innerText=l,e.title=l)}if((null==e?void 0:e.onWChange)&&(null===(l=this.d)||void 0===l?void 0:l.w)&&(null==s||s(this.d.w,this.d.w)),(null===(o=this.props)||void 0===o?void 0:o.w)&&!this.d.wSync){let e=this.props.w.$cloneSync(((e,t)=>{const n=e;this.setData({w:n},{w:t}),null==s||s(n,t),this.setState({w:n})}));this.setData({wSync:e})}},this.onUnmount=async()=>{var e,t;await(null===(t=null===(e=this.d)||void 0===e?void 0:e.wSync)||void 0===t?void 0:t.$unsync()),this.d.wSync=void 0}}static getTitle(e){return e.name||e.table_name||e.id||"Empty"}getTitleIcon(){const{quickMenuProps:e}=this.props,{w:t}=this.d;if(!e)return null;const{setLinkMenu:n,dbs:l,tables:o,onAddChart:i}=e;return a.createElement(ProstglesQuickMenu,{tables:o,w:t,dbs:l,setLinkMenu:n,onAddChart:i})}render(){var e,t;const{children:n,getMenu:o}=this.props,{showMenu:i}=this.state,{w:r}=this.state;if(!r)return null;let c;const d=null===(t=null===(e=this.ref)||void 0===e?void 0:e.parentElement)||void 0===t?void 0:t.querySelector(":scope > .silver-grid-item-header > .silver-grid-item-header--icon");o&&d&&(c=l.createPortal(a.createElement(a.Fragment,null,a.createElement(Btn_Btn,{className:"f-0",iconPath:s.SXi,title:"Open menu",onClick:()=>{this.setState({showMenu:!i})}}),this.getTitleIcon()),d));const m=()=>{this.setState({showMenu:!1})};return a.createElement(a.Fragment,null,c,a.createElement("div",{key:r.id+"-content",className:"flex-col f-1 min-h-0 min-w-0",ref:e=>{if(e){let t;this.ref||(t=!0),this.ref=e,t&&this.forceUpdate()}}},a.createElement(ErrorTrap,null,n)),i&&o&&a.createElement(Popup,{open:!0,anchorEl:this.ref,positioning:"inside",rootStyle:{padding:0},clickCatchStyle:{opacity:.5,backdropFilter:"blur(1px)"},contentClassName:"",onClose:m},a.createElement(ErrorTrap,null,o(r,m))))}}class JoinPathSelector extends RTComp{constructor(){super(...arguments),this.state={jpath:[]}}static hasJoins(e,t){return Boolean(t.find((t=>t.name===e&&t.columns.find((e=>e.references))||t.name!==e&&t.columns.find((t=>{var n;return null===(n=t.references)||void 0===n?void 0:n.some((t=>t.ftable===e))})))))}onDelta(){const{tables:e,tableName:t}=this.props;e&&t&&!this.state.joins&&this.setState({joins:Jl({tables:e,tableName:t})||[]})}render(){const{jpath:e,joins:t,j:n}=this.state,{onSelect:l,className:o="",style:i={},tableName:r,onLinkTable:c}=this.props;let d=t;if(n&&(d=n.joins),!t)return a.createElement(Loading,null);const m=(e,t)=>{this.setState({jpath:e,j:t}),l(e.map((e=>e.table)),e)},p=e.map(((t,n)=>a.createElement("div",{key:n,className:"flex-col ",style:{marginLeft:5*n+"px"}},a.createElement("div",{className:"flex-row p-p25 text-gray-500",style:{marginLeft:5*(n-1)+"px"}},"(",t.on.map((e=>e.join(" = "))).join(" AND"),")"),a.createElement("div",{className:"flex-row p-p25 "+(n===e.length-1?"":" pointer  text-hover ")+(n===e.length-1?" font-bold ":"  "),style:{marginLeft:5*(n+1)+"px"},onClick:n===e.length-1?void 0:()=>{const n=e.findIndex((e=>e.table===t.table)),a=e.slice(0,n+1);m(a,t)}},t.table)))),u=e.length?a.createElement("div",{className:"flex-col ta-left bg-gray-100 mb-1"},a.createElement("div",{className:"flex-row p-p5 text-gray-500"},"Current path:"),a.createElement("div",{className:"flex-row p-p25 pointer text-hover",onClick:()=>{m([],void 0)}},r),p):null;let h=null;(null==d?void 0:d.length)&&(h=a.createElement(SearchList,{style:{backgroundColor:"transparent"},className:"",id:"link-menu",noSearchLimit:15,items:d.map((t=>({key:t.table,label:t.table,subLabel:` (${t.on.flatMap((e=>e[0]+" = "+e[1])).join(", ")})`,onPress:()=>{const n=[...e,t];m(n,t)}})))}));const g=e.map((e=>e.table)),f=null==g?void 0:g[g.length-1];let E=null;return c&&f&&(E=a.createElement("div",{className:"flex-col w-fit"},a.createElement(Btn_Btn,{iconPath:s.oL1,variant:"filled",color:"action",size:"small",className:" ",onClick:()=>{c(f,g)}},"Join to ",JSON.stringify(f)),h&&a.createElement("div",{className:"mt-p5"},"or"))),a.createElement("div",{className:"flex-col noselect "+o,style:i},u,E,h&&a.createElement("div",{className:"flex-col  bg-bldue-50  mt-1"},a.createElement("div",{className:"flex-row p-p5 text-blue-500 p-1"},"Choose next table"),h))}}class SmartAddFilter extends RTComp{constructor(){super(...arguments),this.state={searchTerm:"",existsFilterType:"$existsJoined"}}render(){var e,t,n,l,o;const{addFilter:i,existsFilterType:r,popupAnchor:c}=this.state,{tableName:d,onChange:m,detailedFilter:p,className:u="",style:h={},tables:g,filterFields:f,defaultType:E}=this.props,v=p||[],b=S(null!==(t=null===(e=g.find((e=>e.name===d)))||void 0===e?void 0:e.columns)&&void 0!==t?t:[]).filter((e=>!f||f.includes(e.name))),y=e=>{var t;return Boolean((null===(t=null==e?void 0:e.references)||void 0===t?void 0:t.length)||!["number","Date"].includes(null==e?void 0:e.tsDataType))},N=JoinPathSelector.hasJoins(d,g);let w;(null===(n=null==i?void 0:i.path)||void 0===n?void 0:n.length)&&(w=null==i?void 0:i.path[(null==i?void 0:i.path.length)-1]);let T=null!==(o=(null==i?void 0:i.path)?(null==i?void 0:i.path.length)?null===(l=g.find((e=>e.name===w)))||void 0===l?void 0:l.columns:[]:b)&&void 0!==o?o:[];const C=g.filter((e=>S(e.columns).length));if(!b.length&&!C.length)return null;let _;return i&&(_=a.createElement(Popup,{open:!0,positioning:"beneath-left",clickCatchStyle:{opacity:0},anchorEl:c,onClose:()=>{this.setState({addFilter:void 0})},contentStyle:{padding:0}},N?a.createElement(Btn_Btn,{title:((null==i?void 0:i.path)?"Disable":"Enable")+" Join filter",className:"w-full",style:{width:"100%"},iconPath:s.pWx,color:(null==i?void 0:i.path)?"action":void 0,onClick:()=>{this.setState({addFilter:{...i||{},path:(null==i?void 0:i.path)?void 0:[]}})}},((null==i?void 0:i.path)?"Disable":"Enable")+" Join filter"):null,(null==i?void 0:i.path)&&a.createElement(Select_Select,{className:"my-p5 m-auto",title:"Filter type",fullOptions:[{key:"$existsJoined",label:"Exists"},{key:"$notExistsJoined",label:"Not Exists"}],value:r,onChange:e=>{this.setState({existsFilterType:e})}}),a.createElement("div",{className:"min-s-0 "+(window.isMobileDevice?" flex-col ":" flex-row ")+"  bt b-gray-200",style:{maxHeight:"90vh"}},!!N&&!!(null==i?void 0:i.path)&&a.createElement("div",{className:"flex-col f-1 o-auto br b-gray-200"},a.createElement(JoinPathSelector,{tables:C,tableName:d,onSelect:e=>{this.setState({addFilter:{...i||{},path:e}})}})),T.length?a.createElement(SearchList,{label:"Choose column"+(w?` (${w})`:""),className:"search-list-cols f-1",style:{maxHeight:"unset"},rowStyleVariant:"row-wrap",autoFocus:!0,items:T.filter((e=>e.filter)).map((e=>({key:e.name,label:e.name,subLabel:e.data_type,styles:{subLabel:{color:oo(e),fontWeight:300}},onPress:()=>{const t=e.name,n=T.find((e=>e.name===t));if(!n)return;let a,l={fieldName:t,type:null!=E?E:(null==i?void 0:i.path)?"not null":y(n)?"$in":"$between",filter:void 0};a=(null==i?void 0:i.path)?{type:r,path:null==i?void 0:i.path,filter:l}:l,null==m||m([...v,a]),this.setState({addFilter:void 0})}})))}):null))),a.createElement(a.Fragment,null,a.createElement(Btn_Btn,{title:"Add filter",className:"shadow bg-white "+u,style:{borderRadius:"6px",...h},color:"action",iconPath:s.pFm,onClick:e=>{this.setState({addFilter:{},popupAnchor:e.currentTarget})},children:"full"===this.props.variant?"Add filter":void 0}),_)}}function sn({button:e,confirmButton:t,message:n,show:l,topContent:o,className:i,style:s,contentClassName:r="",contentStyle:c,hideConfirm:d=!1,title:m,positioning:p="center"}){if(l)return"button"===l?a.createElement(a.Fragment,null,e," "):a.createElement(a.Fragment,null,t((()=>{}))," ");const[u,h]=(0,a.useState)();(0,a.useEffect)((()=>{"function"==typeof n?(async()=>{h(await n())})():h(n)}),[n]);const g=Io(),f=()=>Math.random().toFixed(3).slice(2,5),[E,v]=(0,a.useState)(f()),[b,y]=(0,a.useState)(!1);return a.createElement(M,{key:E,title:m,className:i,style:s,button:e,initialState:{ok:!1,code:E,confirmCode:""},positioning:p,onClose:()=>{v(f())},render:e=>{const n=()=>{g()&&v(f())};return a.createElement("div",{className:"flex-col gap-1 ai-start o-auto "+r,style:c},null==o?void 0:o(n),!d&&a.createElement(a.Fragment,null,null!=u?u:a.createElement(Loading,null),a.createElement(rn,{key:E,onChange:y}),a.createElement("div",{className:"flex-row gap-1 ai-center mt-1"},a.createElement(Btn_Btn,{onClick:n,variant:"outline"},"Close"),b&&t(n))))}})}function rn({className:e,style:t,onChange:n}){var l;const[o,i]=(0,a.useState)(Math.random().toFixed(3).slice(2,5)),[s,r]=(0,a.useState)("");return a.createElement("div",{className:null!==(l="flex-col "+e)&&void 0!==l?l:"",style:t},a.createElement("p",null,a.createElement("span",{className:"noselect"},"Confirm by typing this code: "),a.createElement("strong",null,o)),a.createElement(FormField,{asColumn:!0,value:s,onChange:e=>{r(e),n(e===o)}}))}const cn=({expanded:e=!1,children:t,className:n="",style:l,title:o="Expand",label:i,iconPath:r,collapsible:c=!1,buttonProps:d})=>{const[m,p]=(0,a.useState)(!e),u=null!=r?r:s.CW,h=a.createElement(Btn_Btn,{iconPosition:"right",className:n+" flex-row gap-1",style:l,variant:"text",title:o,iconPath:"string"==typeof u?u:u(m),...d,onClick:()=>{p(!m)},children:i});return m&&!c?h:a.createElement(a.Fragment,null,!m&&t,c&&h)},dn=({buttonProps:e,db:t,tableName:n,tables:l,onSuccess:o})=>{var i;const[r,c]=(0,a.useState)(!1),[d,m]=(0,a.useState)();if(!(null===(i=t[n])||void 0===i?void 0:i.insert))return null;const p=l.find((e=>e.name===n));return(null==p?void 0:p.info.is_media)&&!d?a.createElement(FileInput,{maxFileCount:1,onAdd:e=>{e.length&&(m(e[0]),c(!0))}}):a.createElement(a.Fragment,null,a.createElement(Btn_Btn,{iconPath:s.qX5,...e,title:"Insert row",color:"action",variant:"filled",onClick:()=>c(!r)}),r&&a.createElement(SmartForm,{asPopup:!0,confirmUpdates:!0,hideChangesOptions:!0,defaultData:d,db:t,tables:l,tableName:n,onSuccess:o,onClose:()=>c(!1)}))};class SmartFilterBar extends a.Component{constructor(){super(...arguments),this.state={}}render(){var e,t,n,l,o;const{db:i,tables:r,leftContent:c,filterFields:d,style:m,className:p,rightContent:u,hideSort:h,showInsertUpdateDelete:g={},rowCount:f}=this.props,{filter:v=[]}="w"in this.props?this.props.w:this.props,{table_name:b}="w"in this.props?this.props.w:this.props,y="w"in this.props?e=>{"w"in this.props&&this.props.w.$update({filter:e},{deepMerge:!0})}:this.props.onChange,N="w"in this.props&&this.props.w?this.props.w:void 0,{updateAllRow:w}=this.state,S=r.find((e=>e.name===b)),T=v.map((e=>({...e}))),C=Vl(T);if(!b||!S)return null;const _=null==T?void 0:T.some((e=>!e.minimised));let x=null;if(!h){const i=(e,t=!0)=>{if(!e)return;const n={key:e,asc:null==t||t};"w"in this.props?N&&N.$update({sort:[n]}):this.props.onSortChange&&(this.setState({orderByKey:e,orderAsc:t}),this.props.onSortChange(n))},r=S.columns.filter((e=>e.filter));let c,d=!0;"w"in this.props?(c=null===(e=null==N?void 0:N.sort[0])||void 0===e?void 0:e.key,d=null===(n=null===(t=null==N?void 0:N.sort[0])||void 0===t?void 0:t.asc)||void 0===n||n):"string"==typeof(null===(l=this.props.sort)||void 0===l?void 0:l.key)&&(c=this.props.sort.key,d=null===(o=this.props.sort.asc)||void 0===o||o),x=a.createElement("div",{className:" flex-row min-h-0 f-0 relative ai-center "},a.createElement(Select_Select,{id:"orderbycomp",buttonClassName:"shadow bg-white",style:{background:"white"},emptyLabel:"Sort by...",asRow:!0,value:c,fullOptions:r.map((e=>({key:e.name,label:e.label||e.name}))),onChange:e=>{i(e,d)}}),c&&a.createElement(Btn_Btn,{color:"action",iconPath:d?s.O0z:s.q5T,onClick:()=>{i(c,!d)}}))}const A={variant:"outline",className:"shadow w-fit h-fit bg-white"},R=i[b],L=T.map((e=>D(e))),O=(null==R?void 0:R.delete)||(null==R?void 0:R.update);return a.createElement("div",{className:"SmartFilterBar flex-col min-h-0 min-w-0 relative  "+p,style:m},c,a.createElement("div",{className:"flex-row-wrap min-h-0 f-0 relative ai-center px-1 gap-p5"},a.createElement(SmartAddFilter,{tableName:b,filterFields:d,db:i,tables:r,detailedFilter:T,onChange:y}),Boolean(null==T?void 0:T.length)&&a.createElement(Btn_Btn,{title:"Expand/Collapse filters",iconPath:window.isMobileDevice?_?s.f1y:s.VYU:void 0,onClick:()=>{const e=mn(T);y(e)}},window.isMobileDevice?null:(_?"Collapse":"Expand")+" filters"),a.createElement("div",{className:"flex-row f-1 mx-p5 jc-center mr-p5 ai-center"},a.createElement(SmartSearch,{tables:r,db:i,style:{alignSelf:"center",width:"500px",maxWidth:"80vw"},className:"m-auto",tableName:b,detailedFilter:T,extraFilters:this.props.extraFilters,onPressEnter:e=>{let t=T.slice(0);const n={fieldName:"*",type:"$term_highlight",value:e,minimised:!0};t=[...T,n],y(t)},onChange:(e,{colName:t,columnValue:n,term:a})=>{const l=S.columns.find((e=>e.name===t));if(!t)throw"Unexpected: colName missing";let o=e.slice(0);if((null==n?void 0:n.toString().length)&&l&&("Date"===l.tsDataType||"number"===l.tsDataType)){const e={fieldName:t,minimised:!0,..."Date"===l.tsDataType?{type:"$term_highlight",value:a}:{type:"=",value:n}};o=[...T,e]}y(o)}}),Boolean(x||u||g)&&a.createElement("div",{className:"ml-auto pl-1 flex-row ai-center"},x,u,!!g&&a.createElement("div",{className:"flex-row ai-center gap-p5 ml-1"},!!O&&a.createElement(cn,{label:"",className:"",iconPath:e=>e?s.gAv:s.zrb,collapsible:!0},!!(null==R?void 0:R.delete)&&a.createElement(sn,{positioning:"beneath-right",button:a.createElement(Btn_Btn,{iconPath:s.x9U,title:"Delete rows...",...A,color:"danger"},"Delete"),message:async()=>{var e;const t=await(null===(e=null==R?void 0:R.count)||void 0===e?void 0:e.call(R,C));return a.createElement("div",{className:"flex-col gap-1",style:{maxWidth:"100%"}},a.createElement("div",{className:"font-20 bold "},"You are about to delete ",t," records ",L.length?"matching the current filter:":""),!!L.length&&a.createElement(Zt,{iconPath:s.k0z,color:"action",className:" rounded p-p5 bg-gray-100 shadow"},a.createElement("div",{className:"flex-col gap-1 ai-start  p-p5 text-ellipsis"},L.map(((e,t)=>a.createElement("div",{key:t,className:"font-18 bold"},e," ",t<L.length-1?"AND":""))))))},confirmButton:e=>a.createElement(Btn_Btn,{iconPath:s.x9U,...A,color:"danger",title:"Delete rows",onClickPromise:async()=>{var t;await R.delete(C),null===(t=g.onSuccess)||void 0===t||t.call(g),e()}},"Delete rows")}),!!(null==R?void 0:R.update)&&a.createElement(M,{positioning:"beneath-right",button:a.createElement(Btn_Btn,{...A,iconPath:s.I$6,title:"Update rows",color:"action"},"Update"),contentStyle:{padding:0},render:e=>a.createElement(a.Fragment,null,a.createElement(SmartForm,{label:`Update ${f} rows`,db:i,tableName:b,tables:r,onChange:e=>{this.setState({updateAllRow:e})},showJoinedTables:!1,columnFilter:e=>{var t;return!(e.is_pkey||!e.is_nullable&&(null===(t=e.references)||void 0===t?void 0:t.length))}}),w&&a.createElement(E,null,a.createElement(Btn_Btn,{onClick:()=>{this.setState({updateAllRow:void 0})}},"Cancel"),a.createElement(Btn_Btn,{color:"action",variant:"filled",onClickPromise:async()=>{var e;await R.update(C,w),this.setState({updateAllRow:void 0}),null===(e=null==g?void 0:g.onSuccess)||void 0===e||e.call(g)}},"Update")))})),a.createElement(dn,{buttonProps:A,db:i,tables:r,tableName:b,onSuccess:g.onSuccess}))))),!!(null==T?void 0:T.length)&&a.createElement("div",{className:"flex-row-wrap min-h-0 f-0 relative ai-start px-1 my-p5"},a.createElement(SmartFilter,{className:"mr-1 mt-p5",tables:r,db:i,tableName:b,detailedFilter:T,onChange:y,operand:Za(N)&&"OR"===N.options.filterOperand?"OR":"AND",onOperandChange:(null==N?void 0:N.$update)?e=>{N.$update({options:{filterOperand:e}},{deepMerge:!0})}:void 0})))}}const mn=(e,t)=>{const n=null!=t?t:e.some((e=>!e.minimised));return e.map((e=>(O(e)&&(e.filter.minimised=n),{...e,minimised:n})))};be._m.config({paths:{vs:"/vs"}});const pn={storageService:{get(){},remove(e,t){},getBoolean:e=>"expandSuggestionDocs"===e,store(){},onWillSaveState(){},onDidChangeStorage(){}}};be._m.init().then((e=>{})).catch((e=>console.error("An error occurred during initialization of Monaco: ",e)));class CodeEditor extends a.Component{constructor(){super(...arguments),this.state={},this.getMonaco=async()=>{var e;return null!==(e=this._monaco)&&void 0!==e||(this._monaco=await be._m.init()),this._monaco},this.getSchemas=()=>{const{jsonSchemas:e}=this.props,t=this._monaco;if(!e||!t)return;const n=null==e?void 0:e.map((e=>{const{id:n,schema:a}=e,l=n+".json",o=t.Uri.parse("internal://server/"+l),i=o.toString();return{id:n,fileId:l,theUri:o,uri:i,schema:No(a,["$id","$schema"]),fileMatch:[i]}}));return n},this.setSchema=e=>{var t,n,a,l;const o=this._monaco;if(!o)return;const i=this.getSchemas();if(!i||!e)return;const s=o.languages.json.jsonDefaults.diagnosticsOptions.schemas,r=[...null!==(t=null==s?void 0:s.filter((e=>!i.some((t=>t.uri===e.uri)))))&&void 0!==t?t:[],...i],c=e.getModel();(null==c?void 0:c.uri.path)!==(null===(n=i[0])||void 0===n?void 0:n.theUri.path)&&(e.setModel(o.editor.createModel(null!==(a=this.props.value)&&void 0!==a?a:e.getValue(),"json",null===(l=i[0])||void 0===l?void 0:l.theUri)),o.languages.json.jsonDefaults.setDiagnosticsOptions({enableSchemaRequest:!0,validate:!0,schemas:r}))},this.loadedActions=!1,this.setTSOpts=!1,this.loadedJsonSchema=!1,this.onUpdate=async e=>{const{error:t,language:n,markers:a,tsLibraries:l,jsonSchemas:o,value:i}=this.props,s=await this.getMonaco();if(this.editor&&o&&!this.loadedJsonSchema&&(this.loadedJsonSchema=!0,this.setSchema(this.editor)),this.editor&&!this.loadedActions&&(this.loadedActions=!0,this.editor.addAction({id:"googleSearch",label:"Search with Google",contextMenuGroupId:"navigation",run:e=>{window.open("https://www.google.com/search?q="+(e=>e.getModel().getValueInRange(e.getSelection()))(e))}})),this.editor&&"typescript"===n&&!this.setTSOpts&&(this.setTSOpts=!0,function(e){e.languages.typescript.typescriptDefaults.setCompilerOptions({target:e.languages.typescript.ScriptTarget.ES2016,allowNonTsExtensions:!0,moduleResolution:e.languages.typescript.ModuleResolutionKind.NodeJs,module:e.languages.typescript.ModuleKind.CommonJS,noEmit:!0,typeRoots:["node_modules/@types"]}),e.languages.typescript.typescriptDefaults.addExtraLib("export declare function next() : string","node_modules/@types/external/index.d.ts"),e.languages.typescript.typescriptDefaults.setDiagnosticsOptions({noSemanticValidation:!1,noSyntaxValidation:!1})}(s),(null==l?void 0:l.length)&&l.forEach((({path:e,content:t})=>{s.languages.typescript.typescriptDefaults.addExtraLib(t,e),s.editor.createModel(t,"typescript",s.Uri.parse(e))}))),s&&this.editor&&JSON.stringify(this.error||{})!==JSON.stringify(t||{})){this.error=t;const e=this.editor.getModel();if(!t&&e)s.editor.setModelMarkers(e,"test",[]);else if(t&&e){let n={};if("number"==typeof t.position){let a=t.position-1||1,l=t.length||10;const o=this.editor.getSelection(),i=o?e.getValueInRange(o):void 0;i&&o&&(l=Math.max(1,Math.min(l,i.length)),a+=e.getOffsetAt({column:o.startColumn,lineNumber:o.startLineNumber}));const s=e.getPositionAt(a),r=e.getPositionAt(a+l);n={startLineNumber:s.lineNumber,startColumn:s.column,endLineNumber:r.lineNumber,endColumn:r.column},this.editor.setPosition(s),this.editor.revealLine(s.lineNumber),this.editor.revealLineInCenter(s.lineNumber)}s.editor.setModelMarkers(e,"test",[{severity:0,message:"error.message",startLineNumber:0,startColumn:0,endLineNumber:0,endColumn:5,code:"error.code",...t,...n}])}}else if(s&&this.editor&&Array.isArray(a)){const e=this.editor.getModel();e&&(s.editor.setModelMarkers(e,"test2",[]),s.editor.setModelMarkers(e,"test2",a))}},this.onKeyDown=e=>{var t,n;const a=null!==(n=null===(t=this.editor)||void 0===t?void 0:t._domElement)&&void 0!==n?n:{};this.props.onSave&&this.editor&&e.ctrlKey&&"s"===e.key&&(null==a?void 0:a.contains(e.target))&&(e.preventDefault(),this.props.onSave(this.editor.getValue()))},this.firstRender=!0}componentDidMount(){document.addEventListener("keydown",this.onKeyDown,!1),this.onUpdate()}componentDidUpdate(e){this.onUpdate(e)}componentWillUnmount(){document.removeEventListener("keydown",this.onKeyDown,!1)}render(){const{value:e="",onChange:t,language:n,options:l={},style:o,className:i=""}=this.props;return this.firstRender=!1,a.createElement("div",{className:"f-1 min-h-0 min-w-0 flex-col relative "+i,style:o},a.createElement(be.ZP,{wrapperProps:{className:"f-1 min-h-0"},className:"f-1 min-h-0",language:n,value:e,overrideServices:pn,options:{readOnly:!t,renderValidationDecorations:"on",parameterHints:{enabled:!0},fixedOverflowWidgets:!0,..."json"===n&&{formatOnType:!0,autoIndent:"full"},...pn,...l},onMount:(e,n)=>{this.editor=e,t&&e.onDidChangeModelContent((n=>{const a=e.getValue();this.props.value!==a&&(null==t||t(a))})),this.forceUpdate()}}))}}const un=({label:e,keys:t})=>a.createElement("div",{className:"flex-row-wrap ai-center gap-p5 noselect "},a.createElement("div",{className:"mr-p25"},e,":"),a.createElement("div",{className:"flex-row ai-center gap-p25"},t.map(((e,t)=>a.createElement(a.Fragment,{key:t},!!t&&a.createElement("span",null,"+"),a.createElement("div",{className:"hotkey"},e)))))),hn=()=>a.createElement("div",{className:"flex-col ai-start gap-1 "},a.createElement(un,{label:"Show autocomplete suggestions",keys:["ctrl","space"]}),a.createElement(un,{label:"Execute current statement",keys:["alt","e"]}),a.createElement(un,{label:"Select current statement",keys:["ctrl","b"]}),a.createElement(un,{label:"Show all suggestions",keys:["?"]}),a.createElement(un,{label:"Show PSQL command queries",keys:["\\"]}));class ProstglesSQLMenu extends RTComp{constructor(){super(...arguments),this.state={l1Key:void 0,l2Key:void 0,query:void 0,running:void 0,error:void 0,initError:void 0,hint:void 0,indexes:void 0,columnsConfig:void 0,infoQuery:void 0,autoRefreshSeconds:void 0},this.onUnmount=async()=>{this.wSub&&await this.wSub.$unsync()},this.loading=!1,this.onDelta=async(e,t,n)=>{var a;t&&"query"in t&&this.setState({error:void 0}),(null===(a=null==e?void 0:e.w)||void 0===a?void 0:a.sql_options)&&JSON.stringify(this.props.w.sql_options)===JSON.stringify(this.state.newOptions)&&this.setState({newOptions:void 0})},this.saveQuery=async()=>{var e,t;const n=this.props.w,a=(null===(e=null==n?void 0:n.$get())||void 0===e?void 0:e.sql)||"";On(a,((null===(t=null==n?void 0:n.$get())||void 0===t?void 0:t.name)||`Query_${await async function(e){const t=(new TextEncoder).encode(e),n=await crypto.subtle.digest("SHA-256",t),a=Array.from(new Uint8Array(n));return a.map((e=>e.toString(16).padStart(2,"0"))).join("")}(a)}`)+".sql","text/sql")}}render(){var e,t;const{onAddChart:n,w:l,dbs:o,dbsTables:i,tables:r}=this.props,{l1Key:d,initError:m,error:p,newOptions:u}=this.state;if(m)return a.createElement("div",{className:"p-1"},a.createElement(ErrorComponent,{error:m}));if(!l)return null;const h=JSON.stringify(u||l.sql_options,null,2),g=i.find((e=>"windows"===e.name)),f=null==g?void 0:g.columns.find((e=>"sql_options"===e.name)),E=AddChartMenu.getChartCols(l,r),v={leftIconPath:s.$0f,disabledText:E.dateCols.length||E.geoCols.length?void 0:"No date or geo columns to chart",content:a.createElement("div",{className:"text-gray-800 noselect flex-row ai-center"},n?a.createElement(AddChartMenu,{w:l,tables:r,onAddChart:e=>{n(e),this.props.w.$update({show_menu:!1})}}):a.createElement(Zt,null,"Not allowed"))},b={General:{leftIconPath:s.weJ,content:a.createElement("div",{className:"flex-col ai-start gap-1"},a.createElement(FormField,{label:"Edit name",className:"ml-1 mb-1",value:l.name,asColumn:!0,type:"text",onChange:e=>{l.$update({name:e,options:{...l.options||{},sqlWasSaved:!0}},{deepMerge:!0})}}),a.createElement(Btn_Btn,{title:"Save query as file",iconPath:s.OGU,onClick:this.saveQuery},"Download query"),a.createElement("label",{title:"Open SQL file",htmlFor:"sql-open",className:"btn btn-default btn-color-default f-0 bg-transparent text-gray-400  rounded pointer flex-row ai-center",style:{padding:"8px 12px"}},a.createElement(c(),{size:1,path:s.xyB}),a.createElement("input",{id:"sql-open",name:"sql-open",title:"Open query from file",type:"file",accept:"text/*, .sql, .txt",style:{display:"none"},onChange:e=>{e.currentTarget.files&&e.currentTarget.files[0]&&gn(e.currentTarget.files[0]).then((e=>{l.$update({sql:e,show_menu:!1})}))}}),a.createElement("div",{className:" text-gray-500  ml-p5",style:{fontWeight:500,fontSize:".875rem"}},"Open SQL file")),a.createElement(Btn_Btn,{title:"Delete this query",color:"danger",iconPath:s.x9U,onClick:()=>{l.$update({closed:!0,deleted:!0})}},"Delete query"),a.createElement(FormField,{className:"ml-1",label:"Result display mode",fullOptions:[{key:"table",label:"Table"},{key:"JSON",label:"JSON"}],value:null!==(e=null==l?void 0:l.sql_options.renderMode)&&void 0!==e?e:"table",onChange:e=>null==l?void 0:l.$update({sql_options:{renderMode:e}},{deepMerge:!0})}))},"Add chart":v,Options:{leftIconPath:s.Shd,content:a.createElement("div",{className:"flex-col ai-start gap-1",key:JSON.stringify(l.sql_options)},a.createElement("div",null,"SQL Editor settings"),a.createElement(CodeEditor,{language:"json",className:"b b-gray-400",style:{minHeight:"200px",minWidth:"400px",flex:1,resize:"vertical",overflow:"auto",width:"100%"},value:h,onChange:e=>{try{this.setState({newOptions:JSON.parse(e)})}catch(e){}},jsonSchemas:[{id:"sql_options",schema:null!==(t=null==f?void 0:f.jsonSchema)&&void 0!==t?t:{}}]}),a.createElement(Zt,{color:"info"},"Press ",a.createElement("strong",null,"ctrl")," + ",a.createElement("strong",null,"space")," to get a list of possible options"),!!p&&a.createElement(ErrorComponent,{error:p}),a.createElement(Btn_Btn,{color:"action",variant:"filled",iconPath:s.Tls,disabledInfo:p?"Cannot save due to error":u&&JSON.stringify(u)!==JSON.stringify(l.sql_options)?void 0:"Nothing to update",onClickPromise:async()=>{const e={...u};this.setState({error:void 0});try{await o.windows.update({id:l.id},{sql_options:e})}catch(t){this.setState({error:t,newOptions:e})}}},"Update options"))},Hotkeys:{leftIconPath:s.ese,content:a.createElement(hn,null)}};return a.createElement("div",{className:"table-menu c--fit flex-row",style:{maxHeight:"100vh",maxWidth:"100vw"}},a.createElement(Tabs,{variant:"vertical",contentClass:" o-auto min-h-0 max-h-100v "+("Alter"===d?" ":" p-1"),items:b,compactMode:window.isMobileDevice,defaultActiveKey:"General"}))}}function gn(e){return new Promise(((t,n)=>{var a=new FileReader;a.addEventListener("load",(function(e){e.target?t(e.target.result):n("e.target is null")})),a.readAsBinaryString(e)}))}const fn=(e,t=[],n,a)=>{let l=e;if(t&&!(null==e?void 0:e.some((e=>Number.isFinite(e.width))))){const e=100,o=300;let i=0,s=0;if(l=l.map((a=>{let l={...a};return t.map((t=>{const a=8*JSON.stringify(t[l[n]]||"").length,i=Number.isFinite(l.width)?l.width:a;l.width=Math.min(Math.max(a,e,i),o)})),l.width=l.width||e,l.width>=o&&s++,i+=l.width,l})),a&&a>i){const e=a-i-25;l=l.map((t=>{var n;return null!==(n=t.width)&&void 0!==n||(t.width=20),s?t.width>=o&&(t.width+=e/s):t.width+=e/l.length,t}))}}return l.slice(0)};async function En(e,t,n){var a,l,o,i,s,r,c,m,p,u,h,g,f,E,v,b,y,N;void 0===e&&(e=null!==(o=this.state.selected_sql||(null===(l=null===(a=this.d)||void 0===a?void 0:a.w)||void 0===l?void 0:l.sql))&&void 0!==o?o:""),void 0===t&&(t=[]),void 0===n&&(n=!1);const{runningQuery:w,page:S}=this.state;if(w)return;this.setState({runningQuery:!0});const{db:T}=this.props,C=null===(i=this.d)||void 0===i?void 0:i.w;if(!C||!T.sql)return void this.setState({error:T.sql?"Internal error (w is missing). Try refreshing the page":Ln});let _=e.trimEnd(),x=!1;const A=`${e}`.trim().toLowerCase().split("\n").filter(((e,t)=>t||!((null==e?void 0:e.trim().startsWith("/*"))&&(null==e?void 0:e.trim().endsWith("*/"))))).map((e=>e.split("--")[0])).join("\n").trim(),R=["select","update","insert","delete","create","drop","show","notify","listen","vacuum","set","explain","analyze","alter"].find((e=>A===e||A.startsWith(e)));if(R)x="select"===R&&!A.slice(0,-1).includes(";")&&!A.replaceAll("\n"," ").includes(" into ");else try{if(e)try{const t=await T.sql("EXPLAIN "+e);x="SELECT"===t.command}catch(e){x=!1,console.error(e)}}catch(e){}let L;x&&_.endsWith(";")&&(_=_.slice(0,-1)),this.hashedSQL=e,null===(r=null===(s=this.state.notifEventSub)||void 0===s?void 0:s.removeListener)||void 0===r||r.call(s);let O={runningQuery:!1,queryStartDate:void 0};const I=new Date;try{const n=C.options||{};n&&n.hideTable&&C.$update({options:{...n,hideTable:!1}});const a=null===C.limit?null:null!==(c=C.limit)&&void 0!==c?c:100;this.setState({sqlError:void 0});let l=_;if(x){this.hashedSQL=`EXPLAIN ${l}`,await T.sql(this.hashedSQL),this.hashedSQL=` SELECT * FROM (\n ${l} \n ) t LIMIT 0`;const{fields:e}=await T.sql(this.hashedSQL),n=(t||[]).filter((t=>e[t.key])).map((e=>`${e.key+1}`+([1,!0].includes(e.asc)?" ASC ":" DESC "))).join(", ")||" TRUE::BOOLEAN ";try{const e=(S-1)*(null!=a?a:100);await T.sql(` SELECT * FROM (\n ${l} \n ) t ORDER BY ${n} LIMIT 0`),l=` SELECT * FROM (\n ${l} \n ) t ORDER BY ${n} LIMIT ${a} OFFSET ${e}`}catch(e){return l=` SELECT * FROM (\n ${l} \n ) t LIMIT ${a}`,C.$update({sort:[]}),void this.setState({error:e})}}this._queryHashAlias="--prostgles-"+function(e,t,n){var a,l,o=void 0===n?2166136261:n;for(a=0,l=e.length;a<l;a++)o^=e.charCodeAt(a),o+=(o<<1)+(o<<4)+(o<<7)+(o<<8)+(o<<24);if(t)return("0000000"+(o>>>0).toString(16)).substr(-8);return o>>>0}(l+Date.now(),!0),this.hashedSQL=this._queryHashAlias+" \n"+l;let o="";this.setState({queryStartDate:I});const i=await T.sql(this.hashedSQL,void 0,{returnType:"arrayMode",allowListen:!0,hasParams:!1});let s=[],r=[],d=.001,h="LISTEN",g=0;if(x=x||"SELECT"===h,"addListener"in i){const e={dataType:"json",format:"json",udt_name:"json",tsDataType:"any"};r=[{...e,name:"payload"},{...e,name:"received"}],s=[],L=await i.addListener((e=>(console.log(e),this.notifEventListener(e))))}else({rows:s,fields:r,duration:d=.001,command:h}=i),g=x&&null!==a?+await T.sql(`${this._queryHashAlias} \n SELECT COUNT(*) FROM (\n ${_} \n) t`,{},{returnType:"value",hasParams:!1}):i.rowCount,r&&r.length||(o=`${h} command finished successfully!  ${null!==(m=i.rowCount)&&void 0!==m?m:0} rows affected`);const f={...O,loading:!1,onRowClick:null,sqlError:void 0,rowCount:null!=g?g:s.length,sql:e,rows:s,duration:d,isSelect:x,downloadDuration:Math.max(1e-5,Date.now()-I.getTime()),commandResult:o,notifEventSub:L,sqlResult:!0,sort:t,queryEnded:Date.now(),cols:r.map(((e,t)=>({...e,idx:t,key:e.name,subLabel:e.dataType,sortable:x&&!["xml","json"].includes(e.dataType)})))},E=s.map((e=>e.reduce(((e,t,n)=>({...e,[n]:t})),{})));f.cols=(null===(p=f.cols)||void 0===p?void 0:p.length)?fn(f.cols,E,"idx",null===(u=this.ref)||void 0===u?void 0:u.getBoundingClientRect().width):[],this.setState(f),C.$update({options:{sqlResultCols:f.cols,lastSQL:x?_:""}},{deepMerge:!0})}catch(t){let n=(null==t?void 0:t.err_msg)||t.toString();const a=((e,t)=>{var n,a;let l,o=null===(a=(n=(null==e?void 0:e.err_msg)||e.toString()).toLowerCase)||void 0===a?void 0:a.call(n);if("string"!=typeof o);else if("error: syntax error at end of input"===o)l="more commands expected at end of query";else if(o.startsWith("error: function")&&o.endsWith("does not exist")&&"42883"===e.err.code&&t){const e=o.slice(16,-15).split("(")[0];if(e){const n=t.filter((t=>"function"===t.type&&t.name===e));l=n.length?". Ensure enough arguments of correct types are supplied. \nSimilar functions:\n\n"+n.map((e=>{var t;return`${e.name}(${null===(t=e.args)||void 0===t?void 0:t.map((e=>e.data_type)).join(", ")})`})).join("\n"):". Check name or ensure the required extension is enabled"}}else o.includes("type")&&o.match("geometry|geography")&&o.includes("does not exist")?l="Might need postgis for this: CREATE EXTENSION postgis;":o.includes("cannot be dropped because some objects depend on it")&&(l=`Try reassigning objects: \nREASSIGN OWNED BY ${o.split('"')[1]||"your_user"} TO postgres;`);if(l)return o+`\nHint: ${l}`})(t,null===(h=this.props.suggestions)||void 0===h?void 0:h.suggestions);if(a)n=a;else{const e=null===(g=null==t?void 0:t.err)||void 0===g?void 0:g.hint,a=null===(f=null==t?void 0:t.err)||void 0===f?void 0:f.detail,l=null===(E=null==t?void 0:t.err)||void 0===E?void 0:E.where;n+=(e?" \n "+e:"")+(a?" \n "+a:"")+(l?" \n where: "+l:"")}const l=(this.hashedSQL||"").indexOf(e.trimEnd().slice(0,-1));let o=null!==(b=+(null===(v=null==t?void 0:t.err)||void 0===v?void 0:v.position))&&void 0!==b?b:0;const i=Math.max(0,o-l),s=1e5,r=Math.max(s,(null===(y=null==t?void 0:t.err)||void 0===y?void 0:y.position)?+(null===(N=null==t?void 0:t.err)||void 0===N?void 0:N.length):e.trimEnd().length);this.setState({...O,isSelect:!1,notifEventSub:void 0,rows:[],cols:[],commandResult:"",duration:Math.max(1e-5,Date.now()-I.getTime()),downloadDuration:0,sort:[],queryEnded:Date.now(),sqlError:{code:U(t)&&U(t.err)?t.err.code:"",message:n,severity:d.ZL.Error,position:i,length:r},sqlResult:!1}),C.$update({options:{sqlResultCols:[]}},{deepMerge:!0})}}var vn=n(46381),bn=n.n(vn);const yn=e=>{const t="button"in e?e.button:a.createElement(Btn_Btn,{...e.btnProps});return a.createElement(M,{positioning:"beneath-left",contentStyle:{padding:0,borderRadius:0},clickCatchStyle:{opacity:0},rootStyle:{borderRadius:0},button:t},a.createElement(MenuList,{style:{borderRadius:0,...e.listStyle},items:e.items}))};let Nn=[];const wn="localSettings",Sn=()=>{const e={};try{const t=window.localStorage.getItem(wn);if(t){const n=JSON.parse(t);if(n){const t=n.centeredLayout;t&&t.enabled&&Number.isInteger(t.maxWidth)&&(e.centeredLayout=t)}return e}}catch(e){console.error("localSettings error: ",e)}return{}};window.addEventListener("storage",(function(e){if(e.storageArea===localStorage){const e=Sn();Nn.forEach((t=>t(e)))}}),!1);const Tn=()=>({...Sn(),$set:e=>{localStorage.setItem(wn,JSON.stringify({...Sn(),...e}))}}),Cn=()=>{const[e,t]=(0,a.useState)(Tn());return e},_n=()=>a.createElement("div",{className:"flex-col ai-start gap-p5  mt-1",color:"info"},a.createElement("h4",{className:"flex-row ai-center gap-1 font-16 m-0"},a.createElement(c(),{path:s.ese,size:1}),"Hotkeys:"),a.createElement(un,{label:"Search all data",keys:["ctrl","shift","f"]}),a.createElement(un,{label:"Find and open a table or script",keys:["ctrl","p"]}),a.createElement(un,{label:"Open an SQL File",keys:["ctrl","o"]})),xn=(e,t)=>{(0,a.useEffect)((()=>{e()}),t)},An=({workspace:e,dbsMethods:t,user:n,dbs:l})=>{const[o,i]=(0,a.useState)("");xn((async()=>{t.getDBSize&&i(await t.getDBSize(e.connection_id))}),[]);const r=Cn();return a.createElement(M,{button:a.createElement(Btn_Btn,{iconPath:s.Shd,title:"Show settings",className:""}),positioning:"top-center",title:"Workspace settings",render:t=>{var n,l,i,s;return a.createElement("div",{className:"flex-col gap-1 p-1"},a.createElement("div",null,a.createElement(Checkbox,{label:"Hide all counts",checked:!!(null===(n=e.options)||void 0===n?void 0:n.hideCounts),onChange:t=>{e.$update({options:{hideCounts:t.target.checked}},{deepMerge:!0})}}),a.createElement("p",{className:"text-gray-600 ta-left"},"This will disable counts for the dashboard menu and table headers. Usefull when there is a performance downgrade")),a.createElement("div",null,a.createElement(Checkbox,{label:"Show all my queries",checked:!!(null===(l=e.options)||void 0===l?void 0:l.showAllMyQueries),onChange:t=>{e.$update({options:{showAllMyQueries:t.target.checked}},{deepMerge:!0}),setTimeout((()=>{window.location.reload()}),500)}}),a.createElement("p",{className:"text-gray-600 ta-left"},"Will allow using queries from all your connections and not just the current one. Requires a page refresh")),a.createElement(FormField,{label:"Default layout type",asColumn:!0,options:["tab","col","row"],value:null===(i=e.options)||void 0===i?void 0:i.defaultLayoutType,onChange:t=>{e.$update({options:{defaultLayoutType:t}},{deepMerge:!0})}}),a.createElement(FormField,{label:"Centered layout",hint:"Sets dashboard maximum width. Useful for wide screens. Will refresh page when changed",asColumn:!0,type:"checkbox",value:null===(s=r.centeredLayout)||void 0===s?void 0:s.enabled,onChange:e=>{var t,n;r.$set({centeredLayout:{enabled:e,maxWidth:null!==(n=null===(t=r.centeredLayout)||void 0===t?void 0:t.maxWidth)&&void 0!==n?n:1200}}),window.location.reload()}}),r.centeredLayout&&a.createElement(FormField,{label:"Centered layout maximum width in pixels",asColumn:!0,type:"number",inputProps:{min:500,max:1e4,step:1},value:r.centeredLayout.maxWidth||700,onChange:e=>{if(!Number.isInteger(+e))return;const t=Math.round(.9*window.innerWidth);+e>t?alert(`Cannot set a value higher than 90% (${t}) of your current screen width`):(r.$set({centeredLayout:{enabled:!0,maxWidth:+e||1200}}),window.location.reload())}}),a.createElement("div",{className:"flex-col gap-1"},a.createElement(_n,null)),o&&a.createElement("div",null,"Database total size: ",o))}})},Rn=({cols:e,rows:t,sql:n})=>{if(!e.length)return null;const[l,o]=(0,a.useState)();return xn((async()=>{const a=await Promise.all(e.map((async(e,a)=>{const l=await(async(e,t)=>t("SELECT format('%I', $1); ",[e],{returnType:"value"}))(e.name,n),o=t.map((e=>e[a]));return{...e,name:l,nullable:o.includes(null)?" | null":"",undef:o.includes(void 0)?" | undefined":""}}))),l=`type Result = { \n${a.map((e=>`  ${e.name}: ${e.tsDataType}${e.nullable}${e.undef};`)).join("\n")} \n}`,i=[e.map((e=>JSON.stringify(e.name))),...t].map((e=>e.join("\t"))).join("\n"),r=bn().unparse([e.map((e=>e.name)),...t],{quotes:!0,header:!1,columns:e.map((e=>e.name))}),c=JSON.stringify(t.map((t=>t.reduce(((t,n,a)=>({...t,[e[a].name]:n})),{}))));o([{val:i,label:"Copy as TSV",iconPath:s.e_F,fileName:"result.tsv"},{val:r,label:"Copy as CSV",iconPath:s.e_F,fileName:"result.csv"},{val:c,label:"Copy as JSON",iconPath:s.UgG,fileName:"result.json"},{val:l,label:"Copy Typescript definition",iconPath:s.fmA,fileName:"result.d.ts"}])}),[e,t]),(null==l?void 0:l.length)?a.createElement(yn,{button:a.createElement(Btn_Btn,{title:`Copy result (${t.length} rows)`,size:"small",iconPath:s.a0Z}),listStyle:{color:"var(--gray-600)",flex:1,display:"flex"},items:l.map((e=>({leftIconPath:e.iconPath,label:e.label,title:Gl(e.val,100),iconStyle:{color:"var(--gray-400)"},labelStyle:{width:"100%",flex:1},onPress(){navigator.clipboard.writeText(e.val)},contentRight:a.createElement(Btn_Btn,{className:"show-on-parent-hover",iconPath:s.OGU,title:"Download file",onClick:()=>{On(e.val,e.fileName,"text")}})})))}):a.createElement(Loading,null)},Ln="Your prostgles account is not allowed to run SQL";class ProstglesSQL extends RTComp{constructor(){super(...arguments),this.state={runningQuery:!1,sql:"",loading:!1,page:1,isSelect:!1,sort:[],joins:[],filter:{},rowCount:0,duration:0,downloadDuration:0,error:"",hideTable:!0,onRowClick:null,commandResult:"",loadingSuggestions:!0},this.d={w:void 0,dataAge:0,wSync:void 0},this.calculatedColWidths=!1,this.saveFunc=e=>{"s"===e.key&&e.ctrlKey&&document.activeElement&&this.editorContainer&&this.editorContainer.contains(document.activeElement)&&(e.preventDefault(),this.saveQuery())},this.currentDataRequestSignature="",this.dataAge=0,this.onDelta=async(e,t,n)=>{var a,l,o,i;const s={...e,...t,...n},{db:r}=this.props,{w:c}=this.d||{};let d,{table_name:m,sort:p,filter:u}=c||{},h=p;if(!c)return;Array.isArray(h)||(h=[]),!r||this.state.cols&&!vo(s,"w.columns")||(d={cols:[],onSort:async e=>this.setState({sort:e}),joins:[],loading:!1}),1===Eo(s).length&&["pageSize","page"].some((e=>s&&e in s))&&En.bind(this)(void 0,void 0,!0);((null===(a=null==s?void 0:s.w)||void 0===a?void 0:a.options)&&"hideTable"in(null===(l=null==s?void 0:s.w)||void 0===l?void 0:l.options)||(null==s?void 0:s.w)&&"limit"in(null==s?void 0:s.w)||(null===(o=null==s?void 0:s.w)||void 0===o?void 0:o.sql)&&!(null===(i=s.w.options)||void 0===i?void 0:i.sqlChanged))&&(d=d||{}),d&&(m&&(d.runningQuery=!1),this.setState(d))},this.killQuery=async()=>{const{db:e}=this.props;if(!!this.state.queryStartDate&&e&&this._queryHashAlias&&e.sql){const t="SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE pid <>  pg_backend_pid() AND (query ilike $1 OR query = $2)";await e.sql(t,[this._queryHashAlias+"%",this.hashedSQL])}return!0},this.noticeEventListener=e=>{const{notices:t=[]}=this.state;this.setState({notices:[{...e,received:(new Date).toISOString().replace("T"," ")},...t]})},this.notifEventListener=e=>{const{rows:t=[]}=this.state;this.setState({rows:[[e,(new Date).toISOString().replace("T"," ")],...t]})},this.runSQL=async(e,t)=>{var n,a,l;return void 0===e&&(e=null!==(l=this.state.selected_sql||(null===(a=null===(n=this.d)||void 0===n?void 0:n.w)||void 0===a?void 0:a.sql))&&void 0!==l?l:""),void 0===t&&(t=[]),En.bind(this)(e,t)}}async onMount(){const{db:e,dbs:t,w:n}=this.props;if(e&&!this.d.wSync){let e=n.$cloneSync(((e,t)=>{this.setData({w:e},{w:t})}));this.setData({wSync:e})}window.addEventListener("keydown",this.saveFunc,!1)}async onUnmount(){var e,t,n,a,l,o,i;window.removeEventListener("keydown",this.saveFunc,!1),null===(n=null===(t=null===(e=this.d)||void 0===e?void 0:e.wSync)||void 0===t?void 0:t.$unsync)||void 0===n||n.call(t);const{notifEventSub:s,noticeSub:r}=this.state;null===(a=null==s?void 0:s.removeListener)||void 0===a||a.call(s),null===(l=null==r?void 0:r.removeListener)||void 0===l||l.call(r),await(null===(i=null===(o=this.dataSub)||void 0===o?void 0:o.unsubscribe)||void 0===i?void 0:i.call(o))}saveQuery(){var e;this.d&&this.d.w&&(null===(e=this.d.w.sql)||void 0===e?void 0:e.trim())&&On(this.d.w.sql,`${this.d.w.name||"Query"}.sql`,"text/sql")}static getDataRequestSignature(e){if("sql"in e)return e.sql;const{filter:t,select:n,limit:a,offset:l}=e;return JSON.stringify({filter:t,select:n,limit:a,offset:l})}render(){var e,t,n,l,o,i,r,d;const{loading:m,duration:p,downloadDuration:u,rows:h=[],rowCount:g,joins:f,cols:E,popup:v,runningQuery:b,sqlError:y,sqlResult:N,sort:w,commandResult:S,queryStartDate:T,isSelect:C,page:_,notifEventSub:x,notices:A,noticeSub:R,queryEnded:L,error:O}=this.state,{w:I}=this.d,{db:D,onAddChart:k,dbs:M,suggestions:F,tables:P,setLinkMenu:H,dbsTables:B}=this.props;if(m||!I||!D)return a.createElement(Loading,{className:"m-auto"});const W=E||[],$=I.options||{},U=(e,t={})=>{var n,a,l;let o={...(null===(l=null===(a=null===(n=this.d)||void 0===n?void 0:n.w)||void 0===a?void 0:a.$get())||void 0===l?void 0:l.options)||{},...e};I.$update({...t,options:o},{deepMerge:!0})},q=e=>`${(e/1e3).toFixed(3)||0}s`,{user:j}=this.props;let z=null;!j||(null===(e=null==j?void 0:j.options)||void 0===e?void 0:e.viewedSQLTips)||window.isMobileDevice||(z=a.createElement("div",{className:"p-2 flex-col ai-center jc-center gap-1 absolute ",style:{inset:0,background:"#00000040",zIndex:1}},a.createElement("div",{className:"SQLHotkeysWrapper min-s-0 bg-white p-1 rounded max-s-fit flex-col gap-1"},a.createElement("div",{color:"info",className:"bg-white o-auto"},a.createElement("h4",{className:"flex-row ai-center gap-1 font-16 mt-0"},a.createElement(c(),{path:s.ese,size:1})," Hotkeys:"),a.createElement(hn,null)),a.createElement(Btn_Btn,{color:"action",variant:"filled",onClick:async()=>{const e={...j.options,viewedSQLTips:!0};await M.users.update({id:j.id},{options:e})}},"Ok, don't show again"))));const Y=a.createElement(a.Fragment,null,a.createElement("div",{className:"flex-col f-1 min-h-0 min-w-0 relative ",ref:e=>{e&&(this.ref=e)}},z,a.createElement("div",{ref:e=>{e&&(this.editorContainer=e)},className:"f-1 min-h-0 min-w-0 flex-col relative pt-1"},O&&a.createElement(ErrorComponent,{error:O,className:"m-2"}),a.createElement(SQLEditor,{value:null!==(n=null===(t=this.d.w)||void 0===t?void 0:t.sql)&&void 0!==n?n:"",sql:D.sql,suggestions:{...F,onLoaded:()=>{this.setState({loadingSuggestions:!1})}},onMount:e=>{this.sqlRef=e},onUnmount:(e,t)=>{U({cursorPosition:t})},cursorPosition:null===(o=null===(l=this.d.w)||void 0===l?void 0:l.options)||void 0===o?void 0:o.cursorPosition,onChange:(e,t)=>{var n;if(!this.d.w)throw new Error("this.d.w missing");let a={sql:e},l=this.d.w.options||{};l.sqlChanged||(l.sqlChanged=!0),l={...l,cursorPosition:t},a.options=l,null===(n=this.d.w)||void 0===n||n.$update(a,{deepMerge:!0}),y&&this.setState({sqlError:void 0}),this.state.commandResult&&this.setState({commandResult:void 0,sqlResult:!1,rows:[]})},onRun:async(e,t)=>{this.setState({selected_sql:t?e:""}),await this.runSQL(e)},onStopQuery:this.killQuery,error:y,getFuncDef:D.sql?(e,t)=>Be({db:D,name:e,minArgs:t}):void 0,sqlOptions:I.sql_options}),a.createElement("div",{className:"flex-row text-gray-400 ai-center text-sm o-auto ",style:{borderTop:"1px solid #0000000d"}},T?a.createElement(a.Fragment,null,a.createElement(Btn_Btn,{size:"medium",title:"Kill query (Esc)",iconPath:s.TpM,onClick:this.killQuery}),a.createElement(Counter,{className:"p-p5 mr-1 noselect",title:"Query running time",from:T})):a.createElement(a.Fragment,null,x?a.createElement(Btn_Btn,{title:"Stop LISTEN",iconPath:s.TpM,onClick:async()=>{await x.removeListener(),this.setState({notifEventSub:void 0})},fadeIn:!0}):a.createElement(Btn_Btn,{title:"Run query (CTRL+E, ALT+E)",disabledInfo:D.sql?void 0:Ln,size:"medium",iconPath:s.g3n,onClick:()=>{var e,t;const n=null===(t=null===(e=this.sqlRef)||void 0===e?void 0:e.getCurrentCodeBlock())||void 0===t?void 0:t.text;n&&this.setState({selected_sql:n}),this.runSQL(n)},fadeIn:!0}),!y&&a.createElement("div",{className:"p-p5 mr-1 noselect fade-in",title:`Query running time: ${q(p)} \nTotal duration: ${q(u)}`},x?"LISTEN...":q(p))),!y&&a.createElement("div",{ref:e=>{e&&(this.refRowCount=e)},className:"flex-row gap-p5 ai-center p-p5 noselect",style:{marginRight:"1em"}},a.createElement("div",null,(g||0).toLocaleString()," rows"),a.createElement(Rn,{cols:W,rows:h,sql:D.sql})),this.state.loadingSuggestions&&a.createElement(Loading,{message:"Loading suggestions"}),"tooltip"!==(null===(i=this.d.w)||void 0===i?void 0:i.sql_options.errorMessageDisplay)&&a.createElement(ErrorComponent,{error:vo(y,"message"),style:{padding:"1em"}}),a.createElement("div",{className:"ml-auto p-p5 flex-row ai-center ",style:{marginRight:"1em"},title:"Clear value to show all rows"},a.createElement(Btn_Btn,{title:"Toggle limit",color:null!==I.limit?"action":void 0,className:"noselect",onClick:()=>{I.$update({limit:null===I.limit?100:null})}},"limit"),null!==I.limit&&a.createElement("input",{id:"dd"+I.limit,type:"number",style:{width:"55px"},min:0,step:1,defaultValue:null!==(r=I.limit)&&void 0!==r?r:"",onChange:({target:{value:e}})=>{const t=e.length?+e:null;(Number.isInteger(t)||null===t)&&I.$update({limit:t})}})),a.createElement(Btn_Btn,{title:"Show/Hide table",iconPath:s._sG,className:"mr-1",onClick:e=>{var t;const n=null!==(t=this.d.w.options)&&void 0!==t?t:{};n.hideTable&&!g?this.refRowCount&&(this.refRowCount.classList.remove("rubberBand"),this.refRowCount.offsetWidth,this.refRowCount.classList.add("rubberBand")):I.$update({options:{...n,hideTable:!n.hideTable}})}}),a.createElement(Btn_Btn,{title:"Show/Hide notices",iconPath:s.O8k,color:R?"action":void 0,className:"mr-1",disabledInfo:D.sql?void 0:Ln,onClick:async e=>{if(R)await R.removeListener(),this.setState({notices:void 0,noticeSub:void 0});else if(D.sql){const e=(await D.sql("",{},{returnType:"noticeSubscription"})).addListener(this.noticeEventListener);this.setState({noticeSub:e})}}}))),a.createElement("div",{className:"flex-col oy-auto relative bt b-gray-300 "+(S?" f-0 ":" f-1 ")+($.hideTable&&!A&&!x||!(null==h?void 0:h.length)&&!N?" hidden ":"")},b?a.createElement(Loading,{variant:"cover",delay:100}):null,A?a.createElement("div",{className:"p-1 ws-pre text-gray-600"},A.slice(0).map((e=>JSON.stringify(e,null,2))).join("\n")):S?a.createElement("div",{className:"p-1 text-gray-400"},S):"JSON"===(null==I?void 0:I.sql_options.renderMode)?a.createElement(CodeEditor,{language:"json",value:JSON.stringify(h.map((e=>W.reduce(((t,n,a)=>({...t,[n.name]:e[a]})),{}))),null,2)}):a.createElement(Table,{maxCharsPerCell:1e3,sort:w,onSort:e=>{this.runSQL(void 0,e)},showSubLabel:!0,cols:W.map(((e,t)=>({...e,key:t,label:e.name,filter:!1,onResize:async t=>{const n=W.map((n=>(n.key===e.key&&(n.width=t),n)));this.setState({cols:n})}}))),rows:h,style:{flex:1,boxShadow:"unset"},tableStyle:{borderRadius:"unset",border:"unset"},pagination:C?{page:_,pageSize:null!==(d=I.limit)&&void 0!==d?d:h.length,totalRows:g,onPageChange:e=>{this.setState({page:e})},onPageSizeChange:e=>{I.$update({limit:e})}}:void 0}))),v?a.createElement(Popup,{rootStyle:v.style,anchorEl:v.anchorEl,positioning:v.positioning,clickCatchStyle:{opacity:0},onClose:()=>{this.setState({popup:void 0})},open:!0,contentClassName:""},v.content):null);return a.createElement(Window,{w:I,quickMenuProps:{dbs:M,onAddChart:k,tables:P,setLinkMenu:H},getMenu:e=>a.createElement(ProstglesSQLMenu,{tables:P,db:D,dbs:M,onAddChart:k,w:e,dbsTables:B,joins:f})},Y)}}function On(e,t,n){var a=new Blob([e],{type:n});const l=window.navigator;if(l.msSaveOrOpenBlob)l.msSaveOrOpenBlob(a,t);else{let e=document.createElement("a"),n=URL.createObjectURL(a);e.href=n,e.download=t,document.body.appendChild(e),e.click(),setTimeout((function(){document.body.removeChild(e),window.URL.revokeObjectURL(n)}),0)}}class Counter extends RTComp{constructor(){super(...arguments),this.state={sec:0}}onMount(){const{from:e}=this.props;setInterval((()=>{this.mounted&&this.setState({sec:Math.round((Date.now()-+e)/1e3)})}),1e3)}render(){const{sec:e}=this.state,{className:t,title:n}=this.props;return a.createElement("div",{title:n,className:"text-gray-400 "+t},e.toFixed(3),"s")}}class SilverGridChild extends RTComp{constructor(){super(...arguments),this.state={zIndex:1,fullscreen:!1},this.loaded=!1,this.onClickClose=async()=>{const{onClose:e,layout:t}=this.props;e&&await e(t.id)},this.hasSiblingFullScreened=()=>{const{getRoot:e}=this.props;return Boolean(this.ref&&e()&&e().querySelector('[data-box-type="item"].fullscreen')&&e().querySelector('[data-box-type="item"].fullscreen')!==this.ref)},this.getSiblingTabs=()=>{const{siblingTabs:e,onClickSibling:t}=this.props;return t&&e&&e.length?a.createElement("div",{className:"f-1 flex-row o-auto no-scroll-bar",style:{gap:"2px"},onWheel:e=>{e.currentTarget.scrollLeft+=e.deltaY}},e.map(((e,n)=>{const l=e.title||e.id;return a.createElement("div",{key:n,onClick:()=>{t(e.id)},style:{height:"37px",marginTop:"4px",padding:".5em .75em",lineHeight:"24px",maxWidth:"40%"},title:l+"",className:"f-0 min-w-0 ws-nowrap text-ellipsis bg-gray-200 p-p5  "},l)}))):null}}onUpdated(){var e;const{header:t,setTarget:n,moveTo:a,hideButtons:l}=this.props,o=null===(e=this.ref)||void 0===e?void 0:e.closest(".silver-grid-component");if(this.loaded||!o||!this.ref||l.pan)return;this.loaded=!0;const i=this.refHeader||this.ref.querySelector("."+(null==t?void 0:t.move));if(!i)throw"Header missing";Nl(i,{onPress:()=>{this.props.hasSiblings&&Qa(15)},onPanStart:()=>{this.props.hasSiblings&&(this.ref.style.display="none")},onPanEnd:()=>{if(this.props.hasSiblings){try{this.ref.style.display="flex",n({display:"none"}),this.ref.style.opacity="";const{position:e,node:t}=this.target;let l="col",o=!0;"tabDist"===e?(l="tab",o=!0):"leftDist"===e?(l="row",o=!0):"rightDist"===e?(l="row",o=!1):"topDist"===e?(l="col",o=!0):"bottomDist"===e&&(l="col",o=!1);const i=t.dataset.boxId;a(this.props.layout.id,i,l,o)}catch(e){console.error(e)}this.target=void 0}},onPan:e=>{if(!this.props.hasSiblings)return;const{x:t,y:a}=e,l=Array.from(o.querySelectorAll("[data-box-type]")).map((e=>{var n;const l=e.getBoundingClientRect();let o,i=1/0;e.classList.contains("silver-grid-item")&&(o=null===(n=e.querySelector(":scope > .silver-grid-item-header"))||void 0===n?void 0:n.getBoundingClientRect(),i=Math.hypot(t-(o.x+o.width/2),a-(o.y+o.height/2)));const s=Math.hypot(t-(l.x+.25*l.width),a-(l.y+.5*l.height)),r=Math.hypot(t-(l.x+.75*l.width),a-(l.y+.5*l.height)),c=Math.hypot(t-(l.x+.5*l.width),a-(l.y+.25*l.height)),d=Math.hypot(t-(l.x+.5*l.width),a-(l.y+.75*l.height));return{node:e,rect:l,hr:o,tabDist:i,leftDist:s,rightDist:r,topDist:c,bottomDist:d,minDist:Math.min(i,s,r,c,d)}})).sort(((e,t)=>e.minDist-t.minDist));this.ref.style.opacity="0.3";const i=o.getBoundingClientRect(),s=l[0],r=null==s?void 0:s.rect;if(!r)return void console.warn("onPan fail, closest not found");let c=r.x-i.x,d=r.y-i.y,m=r.width/2,p=r.height;this.target={node:s.node,position:"leftDist"},s.leftDist===s.minDist?(c=r.x-i.x,d=r.y-i.y,m=r.width/2,p=r.height,this.target.position="leftDist"):s.rightDist===s.minDist?(c=r.x-i.x+r.width/2,d=r.y-i.y,m=r.width/2,p=r.height,this.target.position="rightDist"):s.topDist===s.minDist?(c=r.x-i.x,d=r.y-i.y,m=r.width,p=r.height/2,this.target.position="topDist"):s.bottomDist===s.minDist?(c=r.x-i.x,d=r.y-i.y+r.height/2,m=r.width,p=r.height/2,this.target.position="bottomDist"):s.tabDist===s.minDist&&(c=s.hr.x-i.x,d=s.hr.y-i.y,m=s.hr.width,p=s.hr.height,this.target.position="tabDist");const u=this.ref.getBoundingClientRect();s.node===this.ref||c-2>=u.x-i.x&&c+m+2<=u.x-i.x+u.width&&d-2>=u.y-i.y&&d+p+2<=u.y-i.y+u.height||n({display:"block",width:`${m}px`,height:`${p}px`,transform:`translate(${c}px, ${d}px)`,border:"2px dashed #2d81ff"})}})}render(){var e;const{children:t,header:n,layout:l,headerIcon:o,minimize:i,onClose:r,hideButtons:c}=this.props,{zIndex:d,fullscreen:m}=this.state,p=null!==(e=null==i?void 0:i.value)&&void 0!==e?e:this.state.minimized;let u=t;const h=window.isMobileDevice?32:40,g=window.isMobileDevice?16:24,f=!i&&p;if(!u)return null;n||(u=a.createElement(a.Fragment,null,a.createElement("div",{className:"silver-grid-item-header flex-row  bg-gray-100 pointer f-0 noselect relative ai-center"},a.createElement("div",{className:"silver-grid-item-header--icon flex-row f-0 o-hidden f-1 ai-center",style:{maxWidth:"fit-content"}},o),a.createElement("div",{className:" flex-row f-1 min-w-0 ws-nowrap ai-center text-ellipsiss"},a.createElement("div",{ref:e=>{e&&(this.refHeader=e)},className:"silver-grid-item-header--title p-p5 f-1 max-w-fit text-ellipsis bg-gray-100 noselect ",style:{height:`${h}px`,lineHeight:`${g}px`,marginTop:"2px"}}),this.getSiblingTabs()),!(null==c?void 0:c.minimize)&&a.createElement(Btn_Btn,{className:"f-0",iconPath:p?s.VYU:s.f1y,onClick:e=>{i?i.toggle():this.setState({minimized:!p})}}),!(null==c?void 0:c.fullScreen)&&a.createElement(Btn_Btn,{className:"f-0",iconPath:m?s.v2$:s.h40,onClick:e=>{this.setState({fullscreen:!m})}}),r&&!(null==c?void 0:c.close)&&a.createElement(Btn_Btn,{className:"f-0",iconPath:s.r5M,onClick:this.onClickClose})),f?null:t));const E=e=>{this.hasSiblingFullScreened()||this.setState({zIndex:e?2:1})};return a.createElement("div",{ref:e=>{e&&(this.ref=e)},className:"silver-grid-box silver-grid-item bg-white f-1 flex-col min-w-0 min-h-0 "+(m?" fullscreen ":" "),"data-box-id":l.id,"data-box-type":"item",onClick:()=>{E(!0)},onBlur:()=>{E(!1)},style:{flex:l.size,overflow:"hidden",zIndex:m?3:d,...f&&{height:`${h+8}px`,flex:"none",flexShrink:1}}},u)}}const In=(e,t)=>{const n=e.x+e.width/2,a=e.y+e.height/2,l=t.x+t.width/2,o=t.y+t.height/2;return Math.hypot(l-n,o-a)};class CardView extends RTComp{constructor(){super(...arguments),this.state={}}render(){var e;const{props:t,state:n,w:l,paginationProps:o,className:i="",style:s,onEditClickRow:r,onDataChanged:c}=this.props,{rows:d=[],cols:m}=n,p=d.map(((e,t)=>({data:e,index:t}))),{joinFilter:u,activeRowColor:h,activeRow:g,db:f,tables:E}=t,v=f[null==l?void 0:l.table_name],b=null===(e=E.find((e=>e.name===(null==l?void 0:l.table_name))))||void 0===e?void 0:e.columns;if(!b)return a.createElement("div",null,"Cols missing");if(!v)return a.createElement("div",null,"db.",null==l?void 0:l.table_name," tableHandler missing");const y=b.find((e=>e.name===(null==l?void 0:l.options.cardGroupBy)&&e.update)),{cardRows:N=1,hideCardFieldNames:w,maxCardWidth:S="100%",hideEmptyCardCells:T,maxCardRowHeight:C,cardCellMinWidth:_=""}=(null==l?void 0:l.options)||{},x=N>1?".5em":"auto",A=1===N&&"100%"!==S?"auto":"",R=e=>{let t={};var n,a;return(u||g&&(n=g.row_filter,a=e,n&&a&&!Object.keys(n).some((e=>n[e]!==a[e]))))&&(t={boxShadow:`inset 0 0 10px ${h}`}),t},L=e=>{const n=window.isMobileDevice?".5em":"1em";return a.createElement("div",{className:"CardView_Column"+(N>1?" flex-row-wrap ":" flex-col ")+" p-p25 o-auto no-scroll-bar f-1 min-w-0 min-h-0 px-p5 pt-p5",style:{placeContent:N>1?"flex-start":void 0}},e.map(((e,l)=>{var o,i;const s=e.data;return a.createElement("div",{key:e.index,"data-row-index":e.index,className:"CardView_Item card jc-start flex-row-wrap  f-0 min-w-0 "+(N>1?" h-fit w-fit ":""),style:{flexFlow:"row-reverse wrap",gap:n,background:(null===(i=null===(o=this.state.isMoving)||void 0===o?void 0:o.target)||void 0===i?void 0:i.index)===e.index?"var(--blue-100)":"white",padding:n,..."100%"!==S?{width:S}:{width:N>1?`calc(${99/N}% - .5em)`:""},margin:`.5em ${x} 0 ${A}`,...R(s)},onClick:e=>{var n,a;(null===(n=window.getSelection())||void 0===n?void 0:n.toString())||null===(a=t.onClickRow)||void 0===a||a.call(t,s,e)}},y&&a.createElement(DragHeader,{padding:n,tableHandler:v,isMoving:this.state.isMoving,onChange:e=>{this.setState({isMoving:e})},groupByColumn:y,allIndexedRows:p,columns:b,onDataChanged:c,onEditClickRow:r,indexedRow:e}),a.createElement("div",{style:{flex:1,display:"flex",justifyContent:"end",marginTop:`calc( -${n} + 4px)`,marginRight:`calc( -${n} + 4px)`}},se(b,v,0,((...e)=>{this.state.isMoving||r(...e)})).onRender({value:"",renderedVal:"",row:s,prevRow:p[l-1],nextRow:p[l+1],rowIndex:l})),null==m?void 0:m.filter((e=>{var t;return!(e.hidden||T&&[null,void 0,""].includes(`${null!==(t=s[e.name])&&void 0!==t?t:""}`.trim()))})).map(((e,t)=>{var n,o,i;return a.createElement("div",{key:t,title:e.udt_name,className:"flex-col min-w-0 "+(N>1?" h-fit w-fit ":""),style:{minWidth:_}},!w&&a.createElement("div",{className:" text-gray-400 pointer noselect",onContextMenu:e.onContextMenu},e.name),a.createElement("div",{className:" o-auto font-18",title:"string"!=typeof s[e.name]||"Date"!==e.tsDataType&&"number"!==e.tsDataType?"":s[e.name],style:{lineHeight:1.33,...(null===(n=e.getCellStyle)||void 0===n?void 0:n.call(e,s,s[e.name],s[e.name]))||{},maxHeight:`${C||800}px`}},null!==(i=null===(o=e.onRender)||void 0===o?void 0:o.call(e,{row:s,value:s[e.name],renderedVal:s[e.name],rowIndex:l,nextRow:p[l+1],prevRow:p[l-1]}))&&void 0!==i?i:SmartFormField.renderValue(e,s[e.name])))})))})))};let O=null;if(null==l?void 0:l.options.cardGroupBy){const e=null==l?void 0:l.options.cardGroupBy,t=Array.from(new Set(p.map((({data:t})=>t[e]))));O=a.createElement("div",{className:"flex-row f-1 min-s-0 mt-1 o-auto"},t.map((t=>a.createElement("div",{key:t,className:"flex-col "},a.createElement("div",{title:e,className:"f-0 p-p5 px-1 font-18",style:{fontWeight:700}},t),a.createElement("div",{className:"min-s-0 o-auto f-1"},L(p.filter((({data:n})=>n[e]===t))))))))}else O=L(p);return a.createElement("div",{className:"CardView o-auto min-s-0 flex-col f-1 bg-gray-200  "+i,style:s},O,a.createElement(Pagination,{...o}))}}class DragHeader extends RTComp{render(){const e=e=>{var t;const n=e.parentElement,a=e.closest(".CardView"),l=Array.from(null!==(t=null==a?void 0:a.querySelectorAll("[data-row-index]"))&&void 0!==t?t:[]).filter((e=>{const t=parseInt(e.dataset.rowIndex);return Number.isInteger(t)&&t!==this.props.indexedRow.index})),o=e.getBoundingClientRect(),i=l.map((e=>{const t=e.getBoundingClientRect();return{n:e,d:In(o,t)}})).sort(((e,t)=>e.d-t.d))[0];return{pNode:n,siblings:l,targetSibling:i,rootView:a}},{padding:t}=this.props;return a.createElement(Pan,{className:"w-full sshow-on-parent-hover",style:{height:"30px",cursor:"move",margin:`-${t}`,marginTop:`calc( -${t} - 10px)`},onPanStart:({node:e},t)=>{t.preventDefault(),t.stopPropagation();const n=e.getBoundingClientRect(),a=e.parentElement.parentElement.getBoundingClientRect();n&&a&&this.props.onChange({top:n.top-a.top,left:n.left-a.left,...this.props.indexedRow})},onPan:({xDiff:t,yDiff:n,x:a,y:l,node:o},i)=>{var s;const r=this.props.isMoving;if(!r)return;const{targetSibling:c,siblings:d,pNode:m}=e(o);m.style.width=m.offsetWidth+"px",m.style.position="absolute",m.style.zIndex="22",m.style.transform=`translate(${r.left+t}px, ${r.top+n}px)`,i.preventDefault(),i.stopPropagation();const p=c?parseInt(c.n.dataset.rowIndex):void 0,u=this.props.allIndexedRows.find((e=>e.index===p));r&&(null===(s=null==r?void 0:r.target)||void 0===s?void 0:s.index)!==p&&this.props.onChange({...r,target:u})},onPanEnd:({node:t},n)=>{const a=this.props.isMoving;if(!a)return;n.preventDefault(),n.stopPropagation();const{pNode:l}=e(t);return(async()=>{if(null==a?void 0:a.target){const{error:e,filter:t}=await ce(a.data,this.props.columns,this.props.tableHandler);if(e)alert(e);else if(t){const e={nextRow:void 0,nextRowFilter:void 0,prevRow:void 0,prevRowFilter:void 0},n={[this.props.groupByColumn.name]:null==a?void 0:a.target.data[this.props.groupByColumn.name]};try{const e=Vl(t);await this.props.tableHandler.update(e,n),this.props.onDataChanged()}catch(a){this.props.onEditClickRow(t,e,this.props.indexedRow.index,n)}}}l.style.opacity="0",setTimeout((()=>{l.style.opacity="",l.style.position="",l.style.zIndex="",l.style.width="",l.style.transform=""}),2),this.props.onChange(void 0)})(),!1}})}}class ProstglesTable extends RTComp{constructor(){var e;super(...arguments),this.state={barchartVals:{},runningQuery:!1,sql:"",loading:!1,totalRows:0,sort:[],joins:[],filter:{},rowCount:0,duration:0,error:"",hideTable:!0,rowDelta:null,onRowClick:null,filterPopup:!1,joinFilterStr:void 0},this.d={page:1,pageSize:null!==(e=Yt(Math.round(1.2*window.innerHeight/55)||25,jt))&&void 0!==e?e:25,w:void 0,dataAge:0,wSync:void 0},this.calculatedColWidths=!1,this.currentDataRequestSignature="",this.onClickEditRow=(e,t,n,a)=>{this.setState({rowPanel:{type:"update",rowIndex:n,filter:e,siblingData:t,fixedUpdateData:a}})},this.dataAge=0,this.onDelta=async(e,t,n)=>{var a,l,o,i,s,r,c,d,m,p,u,h,g,f,E,v,b,y,N,w,S,T,C,_,x,A;const R={...e,...t,...n},{rows:L,sql:O}=this.state,{db:I,dbs:D,onClose:k,onClickRow:M,joinFilter:F,externalFilters:P,workspace:H,tables:B}=this.props,{w:W,pageSize:$}=this.d||{};let U,{table_name:q,table_oid:j,sort:z,filter:Y}=W||{},V=z,G={...Y};if(!W)return;const J=Object.keys((null===(a=null==R?void 0:R.w)||void 0===a?void 0:a.options)||{});Object.keys((null==R?void 0:R.w)||{}),Object.keys(R||{});I&&q&&(G=Vl(Y||[],void 0,"OR"===W.options.filterOperand?"or":void 0));const X=I[q];if(!X)return;if(I&&q&&!X){if(!j)return alert("Table not found. Removing..."),void k();{let e=[];await Promise.all(Object.keys(I).map((async t=>{I[t].getInfo&&e.push({name:t,...await I[t].getInfo()})})));const t=e.find((e=>e.oid===j));if(t)return void await W.$update({table_name:t.name})}}Array.isArray(V)||(V=[]),(null==R?void 0:R.w)&&"filter"in R.w&&this.props.onFilter(),R.db&&console.log(Object.keys(R.db)),["showSubLabel","maxRowHeight"].some((e=>{var t,n;return(null===(t=null==R?void 0:R.w)||void 0===t?void 0:t.options)&&e in(null===(n=null==R?void 0:R.w)||void 0===n?void 0:n.options)}))&&(U=U||{}),(null===(l=null==R?void 0:R.w)||void 0===l?void 0:l.columns)&&W.$update({sort:[]}),(null===(o=null==R?void 0:R.w)||void 0===o?void 0:o.filter)&&!(null===(i=null==R?void 0:R.w)||void 0===i?void 0:i.id)&&W&&!(null==W?void 0:W.options.showFilters)&&W.$update({options:{showFilters:!0}},{deepMerge:!0}),(null===(s=null==R?void 0:R.w)||void 0===s?void 0:s.filter)&&W&&this.setData({page:1}),(null===(r=null==R?void 0:R.w)||void 0===r?void 0:r.options)&&"hideCount"in(null===(c=null==R?void 0:R.w)||void 0===c?void 0:c.options)&&(null===(d=this.state.rows)||void 0===d?void 0:d.length)&&(U={...U,dataAge:Date.now()});const K=!(null===(m=H.options)||void 0===m?void 0:m.hideCounts)&&!W.options.hideCount||(null===(p=H.options)||void 0===p?void 0:p.hideCounts)&&!1===W.options.hideCount;if(I&&this.state.rows&&(R.tables||R.db||!this.state.cols||(null===(u=null==R?void 0:R.w)||void 0===u?void 0:u.columns)||(null==R?void 0:R.w)&&"filter"in(null==R?void 0:R.w)||["cardRows","hideEditRow"].some((e=>J.includes(e))))&&(U={onSort:async e=>this.setState({sort:e}),loading:!1,cols:await ue({data:(null==U?void 0:U.rows)||this.state.rows,windowWidth:null===(h=this.ref)||void 0===h?void 0:h.getBoundingClientRect().width,db:I,dbs:D,tables:B,w:this.d.w,onClickEditRow:this.onClickEditRow,onSetColumnPopup:e=>{this.setState({popup:e})},onSetFilterPopup:()=>{this.setState({filterPopup:!0})},barchartVals:this.state.barchartVals}),totalRows:K?+(null!==(f=await(null===(g=X.count)||void 0===g?void 0:g.call(X)))&&void 0!==f?f:0):0,onRowClick:(e,t)=>{var n,a;e&&(null===(a=null===(n=this.d.w)||void 0===n?void 0:n.columns)||void 0===a?void 0:a.find((t=>!t.computedConfig&&!t.format&&Object.keys(e).includes(t.name))))?null==M||M(e,t):null==M||M(void 0,t)}}),W&&q&&I&&X&&X.find&&(!L&&X||(null===(v=null===(E=R.w)||void 0===E?void 0:E.options)||void 0===v?void 0:v.refresh)||(null==R?void 0:R.dataAge)||["pageSize","page","sort","filter","joinFilter","externalFilters","limit","cols","dataAge","db","activeRow","columns"].some((e=>e in R||R.w&&e in R.w)))){let e=Yl({$and:[G&&!yo(G)?G:void 0,this.props.joinFilter,...this.props.externalFilters].filter(Co)});const t=JSON.stringify(e),n=()=>{var e,t;return null===(t=null===(e=this.dataSub)||void 0===e?void 0:e.unsubscribe)||void 0===t?void 0:t.call(e)},a=()=>{this.autoRefresh&&(clearTimeout(this.autoRefresh),this.autoRefresh=null)},l=async(l=0)=>{var o;this.dataSubFilter!==t&&(await n(),a(),this.dataSubFilter=t,this.dataSub=await(null===(o=X.subscribe)||void 0===o?void 0:o.call(X,e,{select:"",throttle:1e3*l},(()=>{this.setData({dataAge:Date.now()})}))))};if("Realtime"===(null===(y=null===(b=null==W?void 0:W.options)||void 0===b?void 0:b.refresh)||void 0===y?void 0:y.type)&&X.subscribe&&this.dataSubFilter!==t&&l(null===(w=null===(N=null==W?void 0:W.options)||void 0===N?void 0:N.refresh)||void 0===w?void 0:w.throttleSeconds),"refresh"in((null===(S=null==R?void 0:R.w)||void 0===S?void 0:S.options)||{})){await n(),a();const{type:e="None",throttleSeconds:t=0,intervalSeconds:o=3}=(null===(T=null==W?void 0:W.options)||void 0===T?void 0:T.refresh)||{};"Realtime"===e?l(t):"Interval"===e&&o>0&&(this.autoRefresh=setInterval((()=>{this.setState({dataAge:Date.now()})}),1e3*o))}try{const{select:t,barchartVals:n}=await ql(W,B,I,e);n&&(U=U||{},U.barchartVals={...this.state.barchartVals,...n});const a=jl(B,W),{limit:l,offset:o}=this.getPagination(),i=ProstglesTable.getDataRequestSignature({select:t,orderBy:a,limit:l,offset:o,joinFilter:F,filter:e});if((null==R?void 0:R.dataAge)||this.currentDataRequestSignature!==i){if(this.currentDataRequestSignature=i,this.setState({runningQuery:!0}),Object.keys(t).length){const n=await(null===(C=X.count)||void 0===C?void 0:C.call(X,e));let i=[];const s={select:t,orderBy:a,limit:l,offset:o};if(W.options.cardGroupBy){const t=W.options.cardGroupBy,n=await X.find(e,{select:{[W.options.cardGroupBy]:1},groupBy:!0,returnType:"values"});i=(await Promise.all(n.map((n=>X.find({$and:[e,{[t]:n}]},s))))).flat()}else i=null!==(x=await(null===(_=X.find)||void 0===_?void 0:_.call(X,e,s)))&&void 0!==x?x:[];this.activeRowStr=JSON.stringify(F||{});let r=i.map((e=>({...e})));if(!(null===(A=W.columns)||void 0===A?void 0:A.some((e=>Number.isFinite(e.width))))){U=U||{},U.localCols=$l(B,W,r);const e=Ul(U.localCols);W.$update({columns:e})}const c=K?`${W.table_name} - ${(null!=n?n:"??").toLocaleString()} records`:W.table_name;c!==W.name&&W.$update({name:c}),U={...U,rows:r,rowCount:n},U.joinFilterStr=F?JSON.stringify(F):void 0}else U={...U,rows:[],rowCount:0};U.error=void 0,this.dataAge=Date.now()}}catch(e){console.error(e),U={...U,error:e,cols:[]}}}!U&&J.length&&["viewAsCard","hideCardFieldNames","cardRows","hideEditRow","showFilters"].some((e=>J.includes(e)))&&(null!=U||(U={})),U&&(U.runningQuery=!1,this.setState(U))},this.getWCols=()=>{const{w:e}=this.d,{tables:t}=this.props,{rows:n}=this.state;return e?$l(t,e,n):[]},this.getPaginationProps=()=>{const{page:e,pageSize:t}=this.d,{rowCount:n}=this.state;return{page:e,pageSize:t,totalRows:n,onPageChange:e=>{this.setData({page:e})},onPageSizeChange:e=>{this.setData({pageSize:e})}}},this.getMenu=(e,t)=>{const{db:n,onLinkTable:l,onAddChart:o,dbs:i,tables:s}=this.props,r=e.columns;return r?a.createElement(ProstglesTableMenu,{db:n,dbs:i,tableName:e.table_name,workspace:this.props.workspace,cols:r.filter((e=>!e.computed)),tables:s,onAddChart:o,w:e,onLinkTable:l,onClose:t}):null}}async onMount(){const{db:e,dbs:t,w:n,tables:a}=this.props;if(n&&!Array.isArray(n.filter)&&n.$update({filter:[]}),e&&!this.d.wSync){let e=n.$cloneSync(((e,t)=>{this.setData({w:e},{w:t})}));this.setData({wSync:e})}}async onUnmount(){var e,t;await(null===(t=null===(e=this.dataSub)||void 0===e?void 0:e.unsubscribe)||void 0===t?void 0:t.call(e))}static getDataRequestSignature(e){if("sql"in e)return e.sql;const{filter:t,joinFilter:n,externalFilters:a,select:l,limit:o,offset:i,orderBy:s}=e;return JSON.stringify({filter:t,joinFilter:n,externalFilters:a,select:l,limit:o,offset:i,orderBy:s})}getPagination(){const{pageSize:e,page:t}=this.d;return{limit:e,offset:this.props.joinFilter?0:(t-1)*e}}render(){var e,t,n,l,o;const{loading:i,totalRows:r,rows:d,cols:m,popup:p,runningQuery:u,rowPanel:h,filterPopup:g,error:f}=this.state,{page:E,pageSize:v,w:b}=this.d;if(!b||!d)return null;const{db:y,setLinkMenu:N,joinFilter:w,activeRow:S,onAddChart:T,dbs:C,activeRowColor:_,tables:x}=this.props,A=this.activeRowStr===JSON.stringify(w||{})?{background:_}:{},R="update"===(null==h?void 0:h.type)&&Object.values(h.siblingData).some((e=>e));let L=null;if((null==b?void 0:b.table_name)&&!y[b.table_name])L=a.createElement("div",{className:" p-2 flex-row ai-center text-red-700"},a.createElement(c(),{path:s.O8k,size:1,className:"mr-p5 "}),"Table ",JSON.stringify(b.table_name)," not found");else if(!i&&b&&y&&(!b.table_name||y[b.table_name]&&m)){const i=m||[],{table_name:r}=b;let c=-1;(null==S?void 0:S.row_filter)&&(c=d.findIndex((e=>kn(S.row_filter,e))));const g=y[r],E=Boolean(null==g?void 0:g.insert);L=a.createElement(a.Fragment,null,a.createElement("div",{className:"flex-col f-1 min-h-0 min-w-0 ",ref:e=>{e&&(this.ref=e)}},(null===(e=null==b?void 0:b.options)||void 0===e?void 0:e.showFilters)?a.createElement("div",{className:" ai-center p-p5 bg-gray-200",title:"Edit filters"},a.createElement(SmartFilterBar,{rowCount:this.state.rowCount,db:y,w:b,tables:x,className:"",extraFilters:this.props.externalFilters,hideSort:!(null==b?void 0:b.options.viewAsCard),showInsertUpdateDelete:{onSuccess:()=>{this.setState({dataAge:Date.now()})}}})):null,a.createElement("div",{className:"flex-col oy-auto f-1 relative "},u?a.createElement(Loading,{variant:"cover",delay:100}):null,f&&a.createElement(ErrorComponent,{withIcon:!0,style:{flex:"unset",padding:"2em"},error:f}),(null==b?void 0:b.options.viewAsCard)?a.createElement(CardView,{state:this.state,props:this.props,w:this.d.w,paginationProps:{...this.getPaginationProps()},onEditClickRow:this.onClickEditRow,onDataChanged:()=>{this.setState({dataAge:Date.now()})}}):a.createElement(Table,{style:{flex:1,boxShadow:"unset"},maxCharsPerCell:null!==(n=null===(t=null==b?void 0:b.options)||void 0===t?void 0:t.maxCellChars)&&void 0!==n?n:500,maxRowHeight:null===(l=null==b?void 0:b.options)||void 0===l?void 0:l.maxRowHeight,rowStyle:w?A:{},onSort:async e=>{try{const t=jl(x,{...b,sort:e});await(null==g?void 0:g.find({},{limit:0,orderBy:t})),b.$update({sort:e})}catch(e){this.setState({error:e})}},onColumnReorder:e=>{var t,n;const a=e.filter((e=>!(e.computed&&"edit_row"===e.key))).map((e=>e.name)),l=null===(n=null===(t=this.d.w)||void 0===t?void 0:t.columns)||void 0===n?void 0:n.slice(0).sort(((e,t)=>a.indexOf(e.name)-a.indexOf(t.name)));null==b||b.$update({columns:l})},cols:i.filter((e=>{const t=this.getWCols();if(t&&Array.isArray(t)){const n=t.find((t=>t.name===e.name));if(n)return Boolean(n.show)}return!e.hidden})).sort(((e,t)=>{const n=this.getWCols();if(n&&Array.isArray(n)){const a=n.findIndex((t=>t.name===e.name)),l=n.findIndex((e=>e.name===t.name));if(a>-1&&l>-1)return a-l}return 0})).map((e=>({...e,headerClassname:"number"===e.tsDataType?" jc-end  ":" ",className:"number"===e.tsDataType?" ta-right ":" ",onResize:async t=>{const n=this.getWCols();if(!Array(n))return;const a=n.map((n=>{if(n.name===e.key)try{n.width=t}catch(e){console.error(e)}return n}));b.$update({columns:a})}}))),rows:d,sort:b.sort,tableStyle:{borderRadius:"unset",border:"unset"},pagination:this.getPaginationProps(),showSubLabel:null===(o=null==b?void 0:b.options)||void 0===o?void 0:o.showSubLabel,activeRowStyle:A,activeRowIndex:c,onRowClick:this.state.onRowClick}),E&&a.createElement(Btn_Btn,{iconPath:s.qX5,title:"Insert row",className:"shadow w-fit h-fit bg-white",color:"action",variant:"outline",style:{position:"absolute",right:"15px",bottom:"15px"},onClick:async()=>{this.setState({rowPanel:{type:"insert"}})}}))),p?a.createElement(Popup,{key:p.key,anchorEl:p.anchorEl,positioning:p.positioning,clickCatchStyle:{opacity:.25,backdropFilter:"blur(1px)"},onClose:()=>{this.setState({popup:void 0})},open:!0,contentClassName:""},p.content):null,h&&a.createElement(SmartForm,{asPopup:!0,confirmUpdates:!0,hideChangesOptions:!0,db:y,tables:x,tableName:r,fixedData:"update"===h.type?h.fixedUpdateData:void 0,rowFilter:"update"===h.type?h.filter:void 0,onPrevOrNext:R?async e=>{var t;let n;const a=h.rowIndex+e,l=1===e?h.siblingData.nextRowFilter:h.siblingData.prevRowFilter;if(!l)return;const o=null===(t=x.find((e=>e.name===r)))||void 0===t?void 0:t.columns;if(!o)return;n={type:"update",rowIndex:a,filter:l,siblingData:await re(d,a,o,g)},this.setState({rowPanel:n})}:void 0,onSuccess:()=>{this.setState({dataAge:Date.now()})},onAddTable:this.props.onAddTable,onClose:()=>{this.setState({rowPanel:void 0})}}))}else L=a.createElement(Loading,{className:"m-auto absolute"});return a.createElement(Window,{w:b,quickMenuProps:{tables:x,dbs:C,setLinkMenu:N,onAddChart:T},getMenu:this.getMenu},L)}}function Dn(e){let t=Math.abs(e);return t>999999?Math.sign(e)*+(Math.abs(e)/1e6).toFixed(1)+"m":t>999?Math.sign(e)*+(Math.abs(e)/1e3).toFixed(1)+"k":e}function kn(e,t){return!(!e||!t)&&!Object.keys(e).some((n=>e[n]!==t[n]))}var Mn=n(3301);const Fn=[{key:"all",label:"All tables"},{key:"relations",label:"With relations"},{key:"leaf",label:"Without relations"}];class SchemaGraph extends RTComp{constructor(){super(...arguments),this.state={nodes:[],links:[],displayMode:"all"},this.loaded=!1,this.onDelta=(e,t)=>{(null==t?void 0:t.displayMode)&&this.setChart()},this.setChart=()=>{if(!this.svgRef)return;const{displayMode:e,nodes:t,links:n}=this.state;let a=t.map((e=>({...e}))),l=n.map((e=>({...e})));"leaf"===e?(a=a.filter((e=>!e.hasLinks)),l=[]):"relations"===e&&(a=a.filter((e=>e.hasLinks))),function(e){var t,n;const{svgNode:a,data:l,onClickNode:o}=e,i=a;i.d3Sim&&(null===(n=(t=i.d3Sim).stop)||void 0===n||n.call(t));const s=30,r=5,c=Mn.Ys(a),d=+c.attr("width"),m=+c.attr("height"),p=240,u=60,h=(Math.sqrt(p*p+u*u),c.select("g.everything")),g=h.select("g.links"),f=h.select("g.nodes"),E=g.selectAll("path.link").data(l.links,(e=>e.id)),v=E.enter().append("path").attr("class","link").attr("stroke-width",2).attr("fill","none").attr("stroke",(e=>e.color)).merge(E);E.exit().remove();var b=f.selectAll("g.node").data(l.nodes,(e=>e.id));const y=b.enter().append("g").attr("class","node").merge(b);b.exit().remove(),y.on("click",(function(e,t){o(t.id)})),y.on("mouseover",(function(e){Mn.Ys(this).select("rect").style("fill","#f3f3f3")})).on("mouseout",(function(e){Mn.Ys(this).select("rect").style("fill","white")}));y.append("rect").attr("x",(e=>-e.width/2)).attr("y",(e=>-e.height/2)).attr("width",(e=>e.width)).attr("height",(e=>e.height)).attr("fill","white").attr("stroke","grey"),y.append("rect").attr("x",(e=>-e.width/2)).attr("y",(e=>-e.height/2)).attr("width",(e=>e.width)).attr("height",(e=>s)).attr("fill","#e1e1e1"),y.append("text").attr("x",(e=>r+-e.width/2)).attr("y",(e=>0)).style("text-anchor","start").each((function(e){const{width:t,height:n,id:a}=e;Mn.Ys(this).selectAll("tspan").data([e.header,...e.text]).enter().append("tspan").attr("x",r+-t/2).attr("y",((e,t)=>Pn(t,n))).text((e=>e.label)).style("dominant-baseline","hanging").style("fill",((e,t)=>e.color)).style("font-size",((e,t)=>t?14:18))}));function N(e){const t=[];l.nodes.forEach((e=>{t[e.cluster]?(t[e.cluster].width<e.width&&(t[e.cluster].width=e.width),t[e.cluster].height<e.height&&(t[e.cluster].height=e.height)):t[e.cluster]=e}));var n=Mn.A4v().nodes(l.nodes);e.d3Sim=n;var a=Mn.Fsl(l.links).id((function(e){return e.id})).distance((e=>Math.max(e.sourceNode.width,e.sourceNode.height)/2+Math.max(e.targetNode.width,e.targetNode.height)/2)).strength(1),o=Mn.q5i().strength((e=>e.hasLinks?-1200:-200)),i=Mn.wqt(d/2,m/2);n.force("charge_force",o).force("center_force",i).force("links",a).force("x",Mn.Mrm(((e,t)=>e.hasLinks?d/2:d/(t+1))).strength(.1)).force("y",Mn.Mrm((e=>e.hasLinks?m/2:0)).strength(.1)).force("collide",function(){let e;function t(t){const n=95,a=Mn.TJp(e,(e=>e.x),(e=>e.y));for(const t of e)a.visit(((e,a,l,o,i)=>{let s=!1;if(e.data&&e.data!==t){let a,l,o,i=t.x-e.data.x,r=t.y-e.data.y,c=n+(e.data.width+t.width)/2,d=n+(e.data.height+t.height)/2,m=Math.abs(i),p=Math.abs(r);m<c&&p<d&&(a=Math.sqrt(i*i+r*r),l=(m-c)/a,o=(p-d)/a,Math.abs(l)>Math.abs(o)?l=0:o=0,t.x-=i*=l,t.y-=r*=o,e.data.x+=i,e.data.y+=r,s=!0)}return s}))}return t.initialize=t=>e=t,t}()),e.style("opacity",.5),e.attr("transform",(function(e){return"translate("+e.x+","+e.y+")"}));const s=Mn.ohM().on("start",p).on("drag",u).on("end",g);e.call(s);const r=Mn.sPX().on("zoom",f);function p(e){e.active||n.alphaTarget(.3).restart(),e.fx=e.x,e.fy=e.y}function u(e){e.fx=e.x,e.fy=e.y}function g(e){e.active||n.alphaTarget(0),e.fx=null,e.fy=null}function f(e){h.attr("transform",e.transform)}function E(){e.attr("transform",(function(e){const{x:t,y:n}=e;return"translate("+t+","+n+")"}));const t=Mn.h5h().source((e=>{const t=e.source.x<e.target.x;return{x:e.source.x+(t?.5:-.5)*e.source.width,y:e.source.y+25+Pn(e.sourceColIndex,e.source.height)}})).target((e=>{const t=e.source.x<e.target.x;return{x:e.target.x-(t?.5:-.5)*e.target.width,y:e.target.y+30+Pn(e.targetColIndex,e.target.height)}})).x((e=>e.x)).y((e=>e.y));Mn.rRh().x((e=>e.x)).y((e=>e.y));v.attr("d",(e=>t(e)))}r(c),n.on("tick",E),n.on("end",(()=>{r.scaleTo(c,.5)}));const{nodes:b}=l}N(y)}({svgNode:this.svgRef,data:{nodes:a,links:l},onClickNode:this.props.onClickTable})}}async onMount(){const{db:e}=this.props;if(!this.loaded&&this.svgRef){this.loaded=!0;let t={nodes:[],links:[]};const n={};await Promise.all(Object.keys(e).map((async t=>{const a=e[t];if("getColumns"in a&&a.getColumns){const e=await a.getColumns();e.length&&(n[t]=e)}})));const a=Object.keys(n);a.map((e=>{let a={id:e,header:{label:e,color:"black"},text:n[e].map((e=>({color:"gray",label:`${e.name} ${e.udt_name.toUpperCase()}`}))),height:0,width:0,hasLinks:!1,cluster:0};a.height=Math.max(80,Pn(a.text.length+1,0)),a.width=Math.min(400,10+10*Math.max(a.header.label.length,...a.text.map((e=>e.label.length)))),t.nodes.push(a)})),a.map((e=>{const l=n[e].filter((e=>{var t;return null===(t=e.references)||void 0===t?void 0:t.some((e=>a.includes(e.ftable)))}));l.map(((a,l)=>{var o;null===(o=a.references)||void 0===o||o.map((l=>{const o=l.ftable,i=l.fcols[0];t.links.find((t=>[t.source,t.target].sort()===[e,o].sort()))||t.links.push({color:"blue",id:[o,e].sort().join(),source:o,target:e,sourceNode:t.nodes.find((e=>e.id===o)),targetNode:t.nodes.find((t=>t.id===e)),text:{label:a.name,color:"black"},sourceColIndex:n[o].findIndex((e=>e.name===i)),targetColIndex:n[e].findIndex((e=>e.name===a.name)),sourceCol:i,targetCol:a.name})}))}))})),t.nodes.forEach((e=>{t.links.filter((t=>[t.source,t.target].includes(e.id))).length&&(e.hasLinks=!0,e.cluster=1)})),this.svgRef.setAttribute("width",this.svgRef.clientWidth+""),this.svgRef.setAttribute("height",this.svgRef.clientHeight+""),this.setState(t,(()=>{this.setChart()}))}}render(){return a.createElement("div",{className:"flex-col f-1",style:{minWidth:"80vw",minHeight:"80vh"}},a.createElement(Select_Select,{value:this.state.displayMode,label:"Display",fullOptions:Fn,style:{top:"10px",left:"10px",position:"absolute"},onChange:e=>{this.setState({displayMode:e})}}),a.createElement("svg",{className:"f-1",style:{width:"100%",height:"100%"},ref:e=>{e&&(this.svgRef=e)}},a.createElement("g",{className:"everything pointer"},a.createElement("g",{className:"nodes"}),a.createElement("g",{className:"links"}))))}}function Pn(e,t){return(e?16:8)+20*e-t/2}const Hn=["Single text value","JSONB Rows","Properties with Geometry"];class FileImporter extends RTComp{constructor(){super(...arguments),this.state={streamColumnDataType:"TEXT",streamBatchMb:10,insertAs:"JSONB Rows",bytesPerRow:0,config:{header:!0},destination:{newTable:!0,newTableName:void 0,existingTable:void 0},open:!0,reCreateTable:!1,headerType:"First row",results:void 0,colNo:"",streamColDelimiter:"_$_"},this.getExitMessage=()=>this.isImporting?`Currently importing into table ${this.isImporting.table}. Data might be lost`:void 0,this.onBeforeUnload=e=>{const t=this.getExitMessage();if(t)return(e||window.event).returnValue=t,t},this.onDelta=async(e,t,n)=>{const{selectedFile:a}=this.state,{db:l,tables:o}=this.props,i={...e,...t,...n};window.__prglIsImporting=Boolean(this.state.importing),a&&i&&(i.customHeaders||i.headerType)},this.rowsToJson=e=>{const{config:t,headerType:n,customHeaders:a=""}=this.state,l={...e},o=l.data;let i=[],s=[];if(o&&o.length)if("Custom"===n){const e=Object.keys(l.data[0]),t=new Array(e.length).fill(null).map(((e,t)=>`c${t+1}`)).join(", ");a||this.setState({customHeaders:t});const n=a.split(", ").map((e=>e.trim()));let r={colNo:` (${e.length})`,customHeadersError:""};e.length!==n.length?r.customHeadersError="Extra/missing column names":Array.from(new Set(n)).length!==n.length?r.customHeadersError="Duplicate column names":(i=n.map((e=>({key:e,label:e,dataType:"text",escapedName:(0,m.asName)(e),sortable:!1}))),s=o.map((e=>{let t={};return(Array.isArray(e)?e:Object.values(e)).map(((e,a)=>{t[n[a]]=e})),t}))),this.setState(r)}else"First row"===n?(i=l.meta.fields.map((e=>({key:e,label:e,dataType:"text",escapedName:(0,m.asName)(e),sortable:!1}))),s=l.data):(i=new Array(o[0].length).fill(null).map(((e,t)=>({key:`c${t}`,label:`Column ${t}`,dataType:"text",escapedName:(0,m.asName)(`c${t}`),sortable:!1}))),s=o.map((e=>{let t={};return e.map(((e,n)=>{t[`c${n}`]=e})),t})));return{cols:i,rows:s}},this.parseFiles=async e=>{let t=[];for await(const n of e){this.setState({loadingFileName:n.name,importing:void 0});const e=await gn(n);t.push({fileName:n.name,content:e})}return this.setState({loadingFileName:void 0}),t},this.setFiles=async e=>{if(e.length>1){const t=["txt","svg","html","json"],n=Array.from(e);if(n.every((e=>t.find((t=>e.name.toLowerCase().endsWith(`.${t}`)))&&e.size<1e6))){this.setState({files:e});const t=await this.parseFiles(n.slice(0,40));this.setState({files:n,multiImport:t,selectedFile:{file:n[0],type:"csv",rowsPerBatch:1e3,preview:{cols:[{key:"fileName",dataType:"TEXT",escapedName:"fileName",label:"fileName",sortable:!1},{key:"content",dataType:"TEXT",escapedName:"content",label:"content",sortable:!1}],rows:t.slice(0,40)}},loadingFileName:void 0})}else alert(`Multi import is only allowed for text files (${t}) less than 1Mb each`)}else e.length&&this.setFile(e[0])},this.setFile=e=>{const t=e.name.toLowerCase(),n=t.endsWith(".geojson")?"geojson":t.endsWith(".json")?"json":"csv",{headerType:a,customHeaders:l,streamColumnDataType:o,streamBatchMb:i}=this.state;this.setState({loadingFileName:e.name,importing:void 0});if(e.size>5e7){let t=[];Un(e,i,((a,l)=>{t=t.concat(a),t.length>100&&(t=t.map(((e,t)=>({id:t+1,value:e}))),l.abort(),this.setState({loadingFileName:void 0,selectedFile:{fileTooBig:!0,file:e,type:n,rowsPerBatch:10,preview:{rows:t,cols:[{key:"id",label:"id",dataType:"BIGSERIAL",subLabel:"BIGSERIAL",sortable:!1,escapedName:"id",width:50},{key:"value",label:"value",dataType:o,subLabel:o,sortable:!1,escapedName:"value"}]}}}))}),console.log,this.state.streamColDelimiter)}else if(n.endsWith("json"))(async function(e){let t="json";const n=await gn(e),a=JSON.parse(n);let l,o=[],i={},s=0;const r=e=>{const t=e=>"number"==typeof e?"numeric":"text";Eo(e).map((n=>{const a=t(e[n]),l=i[n];(!l||"numeric"===l&&"text"===a)&&(i[n]=a)}))};if("FeatureCollection"===a.type&&a.features&&Array.isArray(a.features)){t="geojson",i={geometry:"geometry"};let e=!1;a.features.map(((t,n)=>{if("Feature"!==t.type)console.warn(`Could not import feature number ${n}. Feature.type is not "Feature"`,t);else{let n=t.properties;e=e||void 0!==t.id,e&&(n={...n,dI:t.id}),r(n)}}));const n=Eo(i);o=a.features.map(((t,a)=>{var o,i,r,c,d;if("Feature"===t.type){l=l||(null===(d=null===(c=null===(r=null===(i=null===(o=t.geometry)||void 0===o?void 0:o.crs)||void 0===i?void 0:i.type)||void 0===r?void 0:r.name)||void 0===c?void 0:c.properties)||void 0===d?void 0:d.name)||"EPSG:4326";let a={};return n.map((n=>{var l,o,i;"id"===n&&e?a[n]=null!==(l=t.id)&&void 0!==l?l:null:"geometry"===n?a[n]=null!==(o=t.geometry)&&void 0!==o?o:null:t.properties&&(a[n]=null!==(i=t.properties[n])&&void 0!==i?i:null)})),s=Math.max(s,JSON.stringify(a).length),a}console.warn(`Could not import feature number ${a}. Feature.type is not "Feature"`,t)}))}else if(Array.isArray(a)){a.forEach((e=>{r(e)}));const e=Object.keys(i);o=a.map((t=>(e.map((e=>{var n;t[e]=null!==(n=t[e])&&void 0!==n?n:null})),s=Math.max(s,JSON.stringify(t).length),t)))}return{type:t,rows:o,srid:l,cols:Object.keys(i).map((e=>({key:e,escapedName:(0,m.asName)(e),dataType:i[e]}))),rowsPerBatch:Bn(s)}})(e).then((({rows:t,cols:n,srid:a,type:l,rowsPerBatch:o})=>{this.setState({loadingFileName:void 0,selectedFile:{file:e,type:l,srid:a,rowsPerBatch:o,preview:{allRows:t,cols:n.map((e=>({...e,label:e.key,subLabel:e.dataType,sortable:!1}))),rows:t.slice(0,50).map((e=>({...e})))}}})})).catch((e=>{this.setState({error:e})}));else{const{config:t}=this.state;try{const n=!("First row"===a)&&l;(async function(e,t){return new Promise((async(n,a)=>{try{bn().parse(e,{header:!1,worker:!0,preview:4,skipEmptyLines:!0,complete:({data:l})=>{let o=!0;const i=l[0],s=l[1];(null==l?void 0:l.length)?(o=i.some(((e,t)=>{if(!s)return!1;const n=To(e).map((e=>e.type)).join(),a=To(s[t]).map((e=>e.type)).join();return e&&n!==a})),bn().parse(e,{...t,header:o,worker:!0,skipEmptyLines:!0,complete:async e=>{var t;let l=e.data||[];if(l.length){let e=[];const t=l[0].length;l=l.filter(((n,a)=>n.length===t||(e.push({row_number:a,row_value:n}),!1))),e.length&&console.error("Some rows have been ommited due to the number of columns not coinciding with first row:",e)}let i=[];if(o)i=((null===(t=e.meta)||void 0===t?void 0:t.fields)||[]).map((e=>({key:e,dataType:"text",escapedName:(0,m.asName)(e)})));else{if(!l.length)return void a("Could not import: No data to import");i=l[0].map(((e,t)=>({key:`c${t+1}`,dataType:"text",escapedName:(0,m.asName)(`c${t+1}`)}))),l=l.map((e=>i.reduce(((t,n,a)=>({...t,[n.key]:e[a]})),{})))}let s=0;l.map((e=>{s=Math.max(s,JSON.stringify(e).length)})),n({rows:l,cols:i,rowsPerBatch:Bn(s)})}})):a("File is empty or could not be parsed")}})}catch(e){a(e)}}))})(e,{...t,header:!n}).then((({rows:t,cols:a,rowsPerBatch:o})=>{const i=n?l.split(",").map((e=>{const t=e.trim();return{key:t,dataType:"text",escapedName:(0,m.asName)(t)}})):a;this.setState({loadingFileName:void 0,selectedFile:{file:e,type:"csv",rowsPerBatch:o,preview:{allRows:t,cols:i.map((e=>({...e,label:e.key,subLabel:e.dataType,sortable:!1}))),rows:t.slice(0,50).map((e=>({...e})))}}})})).catch((e=>{this.setState({error:e})}))}catch(e){console.error(e)}}},this.createTable=()=>{const{selectedFile:e,config:t,destination:n,reCreateTable:a,insertAs:l}=this.state;return new Promise((async(t,l)=>{try{if(!(null==e?void 0:e.preview))throw"selectedFile missing";const{db:l}=this.props;if(!l||!l.sql)throw"Cannot create new table";let o=n.newTableName||e.file.name;const i=await l.sql("$1:name",[o],{returnType:"statement"});a&&l[o]&&await l.sql("DROP TABLE IF EXISTS "+i);const s="CREATE TABLE "+i+" ( \n";let r=e.preview.cols;const c=s+r.map(((e,t)=>e.escapedName+" "+e.dataType)).join(",\n")+" \n);",d=r.filter((e=>"BIGSERIAL"!==e.dataType)).map(((e,t)=>e.escapedName)),m=await l.sql("INSERT INTO "+i+" (${colTypes:raw}) VALUES ",{colTypes:d.join(", ")},{returnType:"statement"});let p=await l.sql(c);console.log(p),t({tableName:o,escapedTableName:i,insertQueryPrefix:m})}catch(e){l(e)}}))},this.canceled=!1,this.importFile=async()=>{var e,t,n,a,l;const{selectedFile:o,insertAs:i,destination:s,streamBatchMb:r,streamColumnDataType:c}=this.state,{db:d}=this.props;let m,p;this.canceled=!1;try{if(!(null==o?void 0:o.file))throw"No file to import";if(!(null==o?void 0:o.preview))throw"Preview missing";let u={};if(null==s?void 0:s.newTable){const{escapedTableName:e,insertQueryPrefix:t}=await this.createTable();p=e;const n=o.preview.cols,a=n.map(((e,t)=>e.escapedName));u={importing:{table:e},escapedColnames:a,error:void 0},m=async a=>{var l;if("Single text value"===i)return this.props.db.sql(`INSERT INTO ${e} ( all_data ) VALUES ($1) `,[a[0].all_data]);const o=null===(l=this.state.selectedFile)||void 0===l?void 0:l.srid;o&&(a=a.map((e=>{let t={...e},n=t;return n.geometry.crs=n.geometry.crs||{},n.geometry.crs.type=n.geometry.crs.type||{},n.geometry.crs.type.name=n.geometry.crs.type.name||{},n.geometry.crs.type.name.properties=n.geometry.crs.type.name.properties||{},n.geometry.crs.type.name.properties.name=o,t.geometry=n.geometry,t})));let s={};const r=n.filter((e=>"BIGSERIAL"!==e.dataType));a.forEach(((e,t)=>r.map(((n,a)=>{n.key in e&&void 0!==e[n.key]?"BIGSERIAL"===n.dataType&&(e[n.key]=null):e[n.key]=null;const l=`r${t}`,o=`c${a}`;s[l]=s[l]||{},s[l][o]=e[n.key]}))));const c=a.map(((e,t)=>`(${r.map(((e,n)=>{const a="${r"+t+".c"+n+"}";return"geometry"===e.dataType?` ST_GeomFromGeoJSON(${a}) `:a})).join(", ")}) `));return c.length?this.props.db.sql(t+c.join(", "),s):[]}}else s.existingTable&&(p=s.existingTable,u={importing:{table:s.existingTable},error:void 0},m=e=>{var t;return null===(t=d[s.existingTable])||void 0===t?void 0:t.insert(e)});this.setState(u),this.isImporting=u.importing,this.elapsedCounter||(this.elapsedCounter={timeStarted:Date.now(),interval:setInterval((()=>{if(!(this.mounted&&this.elapsedCounter&&this.elapsedCounter.timeStarted&&this.isImporting))return void(this.elapsedCounter&&clearInterval(this.elapsedCounter.interval));const e=this.elapsedCounter.timeStarted,t=Math.round((Date.now()-e)/1e3),n=Math.floor(t/60);this.state&&this.state.importing&&this.setState({importing:{...this.state.importing,timeElapsed:[n,t-60*n].map((e=>e.toString().padStart(2,"0"))).join(":")}})}),1e3)});const h=null!==(t=null===(e=this.state.selectedFile)||void 0===e?void 0:e.rowsPerBatch)&&void 0!==t?t:0;this.setState({importing:{...this.state.importing,progress:0,progressRows:0}});let g,f=0;try{if(h<=0)throw"Bad stepSize";if(o.fileTooBig){let e=0,t=0,n=[];Un(o.file,r,(async(a,l)=>{if(n=a.map((e=>({value:"TEXT"!==c?JSON.parse(e):e}))),!this.mounted||this.state.error)l.abort();else{l.pause();try{await m(n)}catch(e){this.setState({error:e}),console.error(e)}t+=4*n.join("").length,e+=n.length,this.setState({importing:{...this.state.importing,progress:100*t/o.file.size,progressRows:e}}),n=[],l.resume()}}),(()=>{this.setState({importing:{...this.state.importing,progress:100,imported:p,importedRows:e,finished:!0}})}),this.state.streamColDelimiter)}else{const e=this.state.files?await this.parseFiles(this.state.files):null!==(l=null===(a=null===(n=this.state.selectedFile)||void 0===n?void 0:n.preview)||void 0===a?void 0:a.allRows)&&void 0!==l?l:[],t=e.length;do{g=e.slice(f,f+h),await m(g),this.setState({importing:{table:p,...this.state.importing,progress:Math.round(100*(f+h)/t),progressRows:f+h}}),f+=h}while((!f||f<t)&&!this.canceled);this.setState({importing:{...this.state.importing,progress:100,imported:p,importedRows:null==e?void 0:e.length,finished:!0}})}}catch(e){throw console.log(g),{startRow:f,batchSize:h,err:e}}this.isImporting=void 0}catch(e){console.error(e),this.isImporting=void 0,this.setState({error:e,importing:void 0})}},this.cancel=async()=>{this.canceled=!0;const{onClose:e,db:t}=this.props,{importing:n}=this.state;n&&!n.finished&&await t.sql("DROP TABLE IF EXISTS "+n.table),this.setState({importing:void 0,open:!1,selectedFile:void 0}),e()}}onMount(){window.addEventListener("beforeunload",this.onBeforeUnload)}onUnmount(){const e=this.getExitMessage();e?window.confirm(e):window.removeEventListener("beforeunload",this.onBeforeUnload),window.__prglIsImporting=!1}render(){var e,t,n,l;const{selectedFile:o,colNo:i,destination:r,importing:d,headerType:m,error:p,open:u,reCreateTable:h,customHeadersError:g,customHeaders:f,insertAs:E,loadingFileName:v,streamColDelimiter:b,streamBatchMb:y,files:N}=this.state,{openTable:w,parentDiv:S,db:T}=this.props,{newTableName:C}=r;let _=C;!C&&o&&(_=o.file.name);const x=Boolean(d&&!d.finished);return a.createElement(Popup,{title:(null==o?void 0:o.file)?N?`Import ${N.length} files`:`Import ${o.file.name}`:"Import data from file",open:u,onClose:this.cancel,positioning:"as-is",rootStyle:{top:window.isMobileDevice?0:"2em",left:window.isMobileDevice?0:"2em",maxHeight:window.isIOSDevice?"calc(100vh - 100px)":"calc(100% - 3em)",maxWidth:window.isIOSDevice?"calc(100vw - 2em)":"100%"},contentClassName:"p-1",footer:a.createElement(a.Fragment,null,a.createElement("div",{className:"p-1 ai-center flex-row f-1",style:{justifyContent:"sspace-between"}},a.createElement(Btn_Btn,{onClick:this.cancel,className:"mr-auto",style:{border:"1px solid var(--gray-300)",padding:"8px 16px"}},"Cancel"),!o||(null==d?void 0:d.progress)?null:a.createElement(Btn_Btn,{className:"ml-auto",onClick:this.importFile,disabledInfo:g,style:{background:"var(--blue-600)",color:"white",padding:"8px 16px"}},"Import"),(null==d?void 0:d.finished)?a.createElement("div",{className:"ml-1 f-1"},a.createElement("span",{style:{color:"var(--green-500)"}},d.importedRows)," rows imported into ",a.createElement("span",{style:{color:"var(--yellow-500)"}},d.table)):null,(null==d?void 0:d.imported)&&T[d.imported]?a.createElement(Btn_Btn,{className:"ml-1",onClick:async()=>{w(d.imported),this.cancel()},disabledInfo:g,style:{background:"var(--blue-600)",color:"white",padding:"8px 16px"}},"Open table"):null,p||!d||d.progress?null:a.createElement("div",{className:"flex-row ai-center ml-auto ta-right"},"Loading file ..."),!d||d.finished||p?null:a.createElement("div",{className:"flex-row ai-center ml-auto ta-right"},a.createElement("div",{className:"mr-1 flex-col "+(d.progress||d.progressRows?"":" hidden ")},a.createElement("div",{style:{fontSize:"1.5em"}},null===(e=d.progress)||void 0===e?void 0:e.toFixed(0),"%"),a.createElement("div",null,(d.progressRows||0).toLocaleString()," rows")),a.createElement("div",{className:"flex-col ai-center"},a.createElement(Loading,{key:"elapsed-loader"}),a.createElement("div",{className:"text-gray-500 mt-p5",style:{fontSize:"1em"}},d.timeElapsed)))),p?a.createElement(ErrorComponent,{error:p.err_msg||p,pre:!0}):null)},a.createElement("div",{className:"flex-col o-auto"},v&&!p?a.createElement("div",{className:"flex-row mt-2"},a.createElement(Loading,{className:"mr-1"}),a.createElement("div",{className:"text-gray-500 mt-p5",style:{fontSize:"1em"}},"Loading ",v)):null,d&&!d.finished||v?null:a.createElement(FormField,{asColumn:!0,className:"mb-1 ",label:"File (csv/txt/json/geojson)",type:"file",inputProps:{multiple:!0},accept:"text/*, .csv, .txt, .json, .geojson, .tsv",onChange:e=>{this.setFiles(e)}}),o?a.createElement(a.Fragment,null,a.createElement(FormField,{asColumn:!0,key:"new-table-name",readOnly:x,className:"mb-1 ",label:"Table name",value:_,onChange:x?void 0:e=>{this.setState({destination:{...r,newTableName:e}})},rightIcons:x?void 0:a.createElement(Btn_Btn,{iconPath:s.H3X,onClick:()=>{return this.setState({destination:{...r,newTableName:(e=_,(e=>{let t="";const n=e.trim().split("");return n.map(((e,a)=>{!a||"_"===t.slice(-1)||n[a-1].match(/[A-Z]/)&&!e.match(/[\W_]+/)||(t+="_"),e.match(/[\W_]+/)||(t+=e.toLowerCase())})),t})(e))}});var e},title:"Transform name to snake case"})}),(null==d?void 0:d.finished)?null:a.createElement(a.Fragment,null,a.createElement(FormField,{asColumn:!0,className:"mb-1 ",label:"Drop table if exists",type:"checkbox",value:h,onChange:e=>{this.setState({reCreateTable:e})}}),"csv"===o.type?null:a.createElement(FormField,{asColumn:!0,className:"mb-1 ",label:"Insert as",value:E,options:Hn,onChange:e=>{this.setState({insertAs:e})}}),"geojson"===o.type?a.createElement(FormField,{asColumn:!0,className:"mb-1 ",label:"SRID",value:o.srid,type:"text",onChange:e=>{this.setState({selectedFile:{...this.state.selectedFile,srid:e}})}}):null,o.fileTooBig&&a.createElement("div",{className:"f-1 flex-col ai-start p-1 ta-left"},a.createElement(c(),{className:"f-0 mt-p5 text-yellow-400",path:s.EaN,size:1.25}),a.createElement("div",null,a.createElement("p",null," The file you have selected is over the 50Mb limit. "),a.createElement("p",null," It can only be imported as a stream into a TEXT column. "),a.createElement("p",null," An incrementing BIGSERIAL column will be added ")),a.createElement("div",{className:"f-1 flex-row ai-center mt-1 ta-left"},a.createElement(FormField,{asColumn:!0,inputProps:{min:1,max:Math.round(o.file.size/1048576)},className:"mb-1 mr-1",label:"Stream batch size in Megabytes",type:"number",value:y,onChange:e=>{e>o.file.size/1048576?alert("Must be less than file size"):this.setState({streamBatchMb:e})}}),a.createElement(FormField,{asColumn:!0,className:"mb-1 mr-1",label:"Delimiter",type:"text",value:b,onChange:e=>{this.setState({streamColDelimiter:e})}}))))):null,!o||d&&!d.finished?null:a.createElement("div",{className:"f-1 flex-col",style:{maxHeight:"400px",maxWidth:"900px"}},v?a.createElement(Loading,{key:"preview-loader"}):a.createElement("div",{className:"flex-col f-1 min-w-0 min-h-0"},a.createElement("div",{className:"divider-h"}),o.fileTooBig?a.createElement("div",{className:"f-0 mb-1 noselect"},"File size: ",Math.round(o.file.size/1e6).toLocaleString()," Megabytes"):a.createElement("div",{className:"f-0 mb-1 noselect"},"TotalRows: ",null===(n=null===(t=o.preview)||void 0===t?void 0:t.allRows)||void 0===n?void 0:n.length),a.createElement("div",{className:"f-0 mb-1 noselect"},"Preview"),(null===(l=o.preview)||void 0===l?void 0:l.rows)&&a.createElement(Table,{maxCharsPerCell:500,className:"f-1 o-auto b-gray-400 ",...o.preview,cols:o.preview.cols})))))}}function Bn(e){let t=1;const n=4*(e+100)*8;if(n>Wn)throw"100Mb row size limit exceeded. Cannot send upload data";return t=Math.floor(Math.min(1500,Math.max($n/n,Wn/n))),t}const Wn=1e8,$n=2e7;if($n>Wn)throw"preferredBatchBitSize must be less than batchMaxBitSize";function Un(e,t=1,n,a,l){return bn().parse(e,{chunkSize:1048576*t,chunk:function(e,t){n(e.data.map((e=>Array.isArray(e)?e.join(l):e)),t)},error:console.error,complete:function(){a()}})}const qn=e=>a.createElement("div",{className:"flex-row-wrap ai-center "+(e.className||""),style:e.style,title:e.title},a.createElement("div",{className:"flex-row gap-p5 text-gray-600 ai-center"},e.icon&&a.createElement(W,{path:e.icon,className:"text-gray-400"}),e.label),a.createElement("div",{className:"px-p5 font-medium"},e.children)),jn=({db:e,tables:t,loadTable:n})=>{var l,o,i,s;const[r,c]=(0,a.useState)({}),d=null===(l=r.cols)||void 0===l?void 0:l.find(((e,t)=>{var n;return null===(n=r.cols)||void 0===n?void 0:n.some(((n,a)=>e.name===n.name&&t!==a))})),m=t.find((e=>e.name===r.name))?"A table with this name already exists":d?`Cannot have two columns with the same name (${d})`:"";return a.createElement(Popup,{open:!0,title:"Create table",positioning:"top-center",contentClassName:"flex-col gap-1 p-1"},a.createElement(FormField,{label:"Table name",value:r.name,onChange:e=>c((t=>({...t,name:e})))}),a.createElement(qn,null,null===(o=null==r?void 0:r.cols)||void 0===o?void 0:o.map(((e,t)=>a.createElement(zn,{key:t,opts:e,onChange:e=>{c((n=>{var a;return{...n,cols:(null!==(a=n.cols)&&void 0!==a?a:[]).map(((n,a)=>a===t?e:n))}}))}})))),a.createElement(Btn_Btn,{onClick:()=>{c((e=>{var t;return{...e,cols:(null!==(t=e.cols)&&void 0!==t?t:[]).concat([{name:"",dataType:""}])}}))}},"Add column"),m?a.createElement(ErrorComponent,{error:m}):(null===(i=r.cols)||void 0===i?void 0:i.length)?a.createElement(en,{sql:e.sql,query:`CREATE TABLE ${r.name} ( \n${null===(s=r.cols)||void 0===s?void 0:s.map((e=>`${e.name} ${e.dataType}`)).join(", \n")} \n)`}):null)},zn=({opts:e,onChange:t})=>{const{name:n,dataType:l}=e;return a.createElement("div",{className:"flex-row-wrap ai-end gap-1"},a.createElement(FormField,{label:"Name",value:n,onChange:n=>t({...e,name:n})}),a.createElement(Select_Select,{label:"Data type",variant:"div",value:l.toUpperCase(),fullOptions:kl,onChange:n=>t({...e,dataType:n})}))},Yn=[{key:"From scratch"},{key:"From file"}],Vn=e=>{const{db:t,tables:n,loadTable:l}=e;if(!t.sql)return null;const[o,i]=(0,a.useState)();return"From file"===o?a.createElement(FileImporter,{tables:n,db:t,onClose:()=>{i(void 0)},openTable:e=>{l({type:"table",table:e})}}):"From scratch"===o?a.createElement(jn,{...e}):a.createElement(Select_Select,{emptyLabel:"Create table",iconPath:"",btnProps:{iconPath:s.qX5,iconPosition:"left",iconClassname:"",color:"action",variant:void 0,style:{},className:"",children:"Create table"},fullOptions:Yn,onChange:e=>{i(e)}})};class _DashboardMenu extends RTComp{constructor(){super(...arguments),this.state={loading:!0,showSchemaDiagram:!1,queries:[]},this.d={},this.fileSelected=async e=>{const t=e.target.files[0];t&&this.props.loadTable({sql:await gn(t),type:"sql"})},this.onkeyDown=e=>{var t,n;const a=null===(n=null===(t=window.getSelection())||void 0===t?void 0:t.toString())||void 0===n?void 0:n.trim();"o"===e.key&&e.ctrlKey?(e.preventDefault(),this.inptRef&&this.inptRef.click(),console.log(this.inptRef)):"p"===e.key&&e.ctrlKey?(e.preventDefault(),this.setState({showSearchAll:{mode:"views and queries",term:a}})):"k"===e.key&&e.ctrlKey?(e.preventDefault(),this.setState({showSearchAll:{mode:"commands",term:a}})):"F"===e.key&&e.shiftKey&&e.ctrlKey?(e.preventDefault(),this.setState({showSearchAll:{mode:"rows",term:a}})):"Escape"===e.key&&this.setState({showSearchAll:void 0})},this.renderMainContent=e=>{const{queries:t,dbSize:n}=this.state,{user:l,db:o,tables:i,loadTable:r,workspace:d,localSettings:m}=this.props,p=t.filter((e=>e.closed)),u=window.innerHeight<1200,h=d.options.pinnedMenu&&!window.isLowWidthScreen,{centeredLayout:g}=m,f=(null==g?void 0:g.enabled)?(window.innerWidth-g.maxWidth)/2+"px":"20vw";return a.createElement("div",{className:"flex-col f-1 min-h-0 "+(window.isMobileDevice?" p-p25 ":" p-1  "),style:{...h&&{minWidth:"200px",background:"white",maxWidth:f,width:"fit-content",height:"100%"}},onKeyDown:t=>{"Escape"===t.key&&e()}},a.createElement("div",{className:"flex-row f-0"},o&&o.sql?a.createElement(Btn_Btn,{key:"sql",title:"SQL Query",style:{marginLeft:"6px"},onClick:t=>{r({type:"sql",name:"SQL Query"}),e()},color:"action","data-command":"sql-editor",variant:"filled",iconPath:s.eY2},h?null:"SQL Editor"):null,a.createElement(Btn_Btn,{iconPath:s.RSU,title:"Show quick search menu (CTRL + P)",className:"ml-auto",onClick:()=>{this.setState({showSearchAll:{mode:"views and queries",term:void 0}}),e()}}),a.createElement(An,{dbsMethods:this.props.dbsMethods,workspace:d,user:l,dbs:this.props.dbs}),a.createElement(Btn_Btn,{iconPath:d.options.pinnedMenu?s.NRb:s.Wzl,disabledInfo:window.isLowWidthScreen?"Cannot be used in a low width device":void 0,title:"Pin/Unpin",className:"ml-p25",onClick:()=>{d.$update({options:{pinnedMenu:!d.options.pinnedMenu}},{deepMerge:!0}),e()}})),p.length?a.createElement(SearchList,{id:"search-list-queries",className:" mt-p5 ",style:{minHeight:"120px",maxHeight:"30vh"},placeholder:"Search "+p.length+" saved queries",noSearchLimit:0,items:p.sort(((e,t)=>+t.last_updated-+e.last_updated)).map(((t,n)=>{var l;return{key:n,contentLeft:a.createElement("div",{className:"flex-col ai-start f-0 mr-p5 text-gray-500"},a.createElement(c(),{path:s.eY2,size:1})),label:t.name,contentRight:a.createElement("span",{className:"text-gray-400 ml-auto italic"},null===(l=t.sql)||void 0===l?void 0:l.trim().slice(0,10),"..."),onPress:()=>{var n;null===(n=t.$update)||void 0===n||n.call(t,{closed:!1,workspace_id:d.id}),e()}}}))}):null,i.length?a.createElement(SearchList,{limit:100,noSearchLimit:0,className:"search-list-tables b-t f-1 min-h-0 "+(u?" mt-p5 ":" mt-1 "),style:{minHeight:"120px"},placeholder:"Search "+i.length+" tables and views",items:i.sort(((e,t)=>{var n;return(null===(n=null==d?void 0:d.options)||void 0===n?void 0:n.hideCounts)?e.name.localeCompare(t.name):+t.count-+e.count})).map(((t,n)=>{var l;return{contentLeft:a.createElement("div",{className:"flex-col ai-start f-0 mr-p5 text-gray-500"},a.createElement(c(),{path:t.info.is_media?s.iA5:(null===(l=null==o?void 0:o[t.name])||void 0===l?void 0:l.insert)?s.CKH:s._sG,size:1})),key:t.name,label:t.name,contentRight:+t.count>0?a.createElement("span",{className:"text-gray-400 ml-auto"},Dn(+t.count)):null,onPress:()=>{r({type:"table",table:t.name}),e()}}}))}):a.createElement("div",{className:"text-gray-500 p-1"},"0 tables/views"),a.createElement("div",{className:"flex-row-wrap f-0 my-p5"},!i.length&&!o.sql&&a.createElement(Zt,null,"You have not been granted any permissions. Check with system administrator "),a.createElement(Vn,{...this.props}),i.length>1&&a.createElement(Btn_Btn,{iconPath:s.CWw,className:"fit ml-2",size:"small",style:{opacity:.05},title:"Show schema diagram","data-command":"schema-diagram",variant:"outline",onClick:()=>{this.setState({showSchemaDiagram:!0}),e()}},"Schema diagram")))}}onMount(){window.addEventListener("keydown",this.onkeyDown,!0)}onUnmount(){var e;window.removeEventListener("keydown",this.onkeyDown,!0),null===(e=this.windowsSync)||void 0===e||e.$unsync()}async onDelta(e,t){var n;const{dbs:a,workspace:l,dbsMethods:o}=this.props;if(l&&!this.windowsSync){const e=(null===(n=null==l?void 0:l.options)||void 0===n?void 0:n.showAllMyQueries)?{}:{workspace_id:l.id};this.windowsSync=await a.windows.sync(e,{handlesOnData:!0,select:"*",patchText:!1},((e,t)=>{if(!this.mounted)return;const n=e.sort(((e,t)=>+e.last_updated-+t.last_updated)).filter((e=>"sql"===e.type&&!e.deleted));this.setState({queries:n})}))}}render(){const{showSchemaDiagram:e,showSearchAll:t,queries:n}=this.state,{searchAll:l,db:o,dbs:i,tables:s,loadTable:r,workspace:c,connection:d,user:m}=this.props;if(!i.workspaces.insert)return null;let p;e&&(p=a.createElement(Popup,{open:!0,title:"Schema diagram",positioning:"top-center",onClose:()=>this.setState({showSchemaDiagram:!1})},a.createElement(SchemaGraph,{db:o,onClickTable:e=>{r({type:"table",table:e,name:e}),this.setState({showSchemaDiagram:!1})}})));const u=c.options.pinnedMenu&&!window.isLowWidthScreen,h=u?this.renderMainContent((()=>{})):a.createElement(M,{key:"main menu",title:" ",onClickClose:!1,rootStyle:{},positioning:"beneath-left",button:a.createElement(Jn,null),contentStyle:{overflow:"hidden",padding:0},autoFocusFirst:{selector:".search-list-tables input"},render:e=>this.renderMainContent(e)});return a.createElement(a.Fragment,null,p,!!t&&a.createElement(SearchAll,{db:o,tables:s,searchType:t.mode,defaultTerm:t.term,suggestions:l,queries:n,loadTable:r,onOpenDBObject:e=>{if("function"===e.type)r({type:"sql",sql:e.definition,name:e.name});else{if("table"!==e.type)throw e;o[e.name]?r({type:"table",table:e.name,name:e.name}):r({type:"sql",sql:`SELECT *\nFROM ${e.escapedIdentifier}\nLIMIT 25`,name:e.name})}},onOpen:({filter:e,table:t})=>{r({type:"table",table:t,filter:e})},onClose:()=>{this.setState({showSearchAll:void 0})}}),a.createElement("input",{ref:e=>{e&&(this.inptRef=e)},type:"file",accept:"text/*, .sql, .txt",className:"hidden",onChange:this.fileSelected}),h,!u&&a.createElement(Gn,{user:m,connection:d}))}}const Gn=({user:e,connection:t})=>{Gl(t.name||t.db_host||"",15);return a.createElement("div",{className:"ml-1 h-full flex-col gap-p25 ai-start text-gray-400"},"admin"===(null==e?void 0:e.type)?a.createElement(Btn_Btn,{title:"Configure server",size:"small",style:{color:"var(--gray-100)",background:"var(--gray-700)"},className:"ConnectionConfigBtn bg-gray-700 text-white b g-gray-700",iconPath:s.YlK,href:`/connection-config/${t.id}`,asNavLink:!0,disabledInfo:t.is_state_db?"Not allowed for state database":void 0,children:window.isLowWidthScreen?void 0:""}):!window.isLowWidthScreen&&a.createElement(a.Fragment,null,a.createElement("div",{className:"text-gray-300  text-ellipsis"}," ")))},Jn=({pinnedProps:e,...t})=>{const n=a.createElement(Btn_Btn,{title:"Menu",...t,style:{border:"1px solid #00d0ff",background:"rgb(240 254 255)",borderRadius:"4px",padding:"2px",...null==t?void 0:t.style},"data-command":"menu"},a.createElement("img",{src:"/prostgles-logo.svg"}));return e?a.createElement("div",{className:"flex-row"},n,a.createElement(Gn,{...e})):n},Xn=e=>{const t=Cn();return a.createElement(_DashboardMenu,{...e,localSettings:t})},Kn=({dbs:e,w:t,activeWorkspaceId:n})=>{const[l,o]=(0,a.useState)(),[i,r]=(0,a.useState)("");return xn((async()=>{const t=await e.workspaces.getColumns({rule:"update",data:{id:"f6c03e9b-d66c-432b-b82c-e959bcbabf16"}});r(t.some((e=>e.delete))?"":"Not allowed to delete this workspace")}),[]),a.createElement(M,{style:{height:"100%"},onClickClose:!1,button:a.createElement(Btn_Btn,{title:"Delete this workspace",iconPath:s.x9U,className:"delete-workspace",disabledInfo:i,color:"danger"}),content:a.createElement("div",{className:"flex-col gap-p5"},a.createElement("div",null,"Are you sure you want to delete this workspace and all related data (windows, links)?"),l&&a.createElement(ErrorComponent,{error:l})),footerButtons:[{color:"danger",label:"Delete workspace",variant:"filled",onClick:async a=>{a.preventDefault(),a.stopPropagation();try{if(await e.workspaces.update({id:t.id},{deleted:!0}),t.id===n){const e=["/connections",t.connection_id].filter((e=>e)).join("/");window.location.href=e}else window.location.reload()}catch(e){o(l)}}},{label:"Cancel",onClickClose:!0}]})},Qn=({dbs:e,connection_id:t,setWorkspace:n,closePopup:l,btnProps:o,className:i})=>{const[r,c]=(0,a.useState)(),[d,p]=(0,a.useState)("");return a.createElement(M,{style:{},onClickClose:!1,className:i,title:"Create new workspace",button:a.createElement(Btn_Btn,{title:"Add new workspace",iconPath:s.qX5,size:"small",variant:"filled",color:"action",...o}),content:a.createElement("div",null,a.createElement(FormField,{label:"Workspace name",asColumn:!0,value:d,onChange:e=>{p(e),c(void 0)},error:r})),footerButtons:[{color:"action",label:"Add workspace",variant:"filled",onClickPromise:async()=>{var a,o;try{const a=await e.workspaces.insert({name:d,connection_id:t},{returning:"*"});n(a),l()}catch(e){(0,m.isObject)(e)&&(null===(o=null===(a=e.columns)||void 0===a?void 0:a.join)||void 0===o?void 0:o.call(a))===["user_id","connection_id","name"].join()?c("Already exists"):c(e)}}},{label:"Cancel",onClickClose:!0}]})},Zn=({dbs:e,dbsTables:t,w:n})=>{const[l,o]=(0,a.useState)();return a.createElement(M,{style:{height:"100%"},onClickClose:!1,button:a.createElement(Btn_Btn,{title:"Workspace settings",iconPath:s.Shd,className:"workspace-settings"}),contentStyle:{padding:0},render:l=>a.createElement("div",{className:"flex-col gap-p5  min-h-0"},a.createElement(SmartForm,{db:e,showJoinedTables:!1,tableName:"workspaces",label:"Workspace settings",tables:t,hideChangesOptions:!0,confirmUpdates:!0,columns:["name","published"],disabledActions:["clone","delete"],rowFilter:[{fieldName:"id",value:n.id}],onClose:l}))})},ea=(e,t)=>`/connections/${e}`+(t?`?workspaceId=${t}`:""),ta=e=>{const{c:t,isAdmin:n,dbs:l,dbsMethods:o}=e;if(!t.workspaces.length&&!e.dbs.workspaces.insert)return a.createElement(Zt,{className:"shadow bg-white"},a.createElement("strong",null,t.id),a.createElement("div",null,"Issue with connection permissions: No published workspace and not allowed to create workspaces"));const r=t.workspaces.length&&"default"!==t.workspaces.map((e=>e.name)).join(""),c=n&&t.access_control.length>0;return a.createElement("div",{key:t.id,className:"CONNECTION flex-col bg-white text-black shadow1 parent-hover ",style:{minWidth:"250px"}},a.createElement("div",{className:"TOP-CONNECTION-INFO_ACTIONS flex-row  "},a.createElement(i.OL,{key:t.id,className:"LEFT-CONNECTIONINFO no-decor flex-col min-w-0 text-ellipsis f-1 text-active-hover ",to:ea(t.id)},a.createElement("div",{className:"flex-col gap-p5 p-1 h-full"},a.createElement("div",{className:"text-ellipsis font-20"},n?t.name:t.name||t.id),n&&t.is_state_db&&a.createElement(Zt,{variant:"naked",iconPath:"",color:"warning"},"All Prostgles connection and dashboard data is stored here. Edit at your own risk"))),a.createElement("div",{className:"RIGHT-ACTIONBAR flex-col gap-p5 p-p25"},a.createElement("div",{className:"flex-row ai-center c--fit  show-on-parent-hover"},n&&!t.is_state_db&&a.createElement(Btn_Btn,{disabledInfo:t.isConnected?void 0:"Not connected",title:"Connected. Click to disconnect",color:t.isConnected?"green":void 0,iconPath:s.Fyt,onClickPromise:async()=>o.disconnect(t.id)}),a.createElement(Btn_Btn,{title:"Close all windows",className:" text-gray-300",iconPath:s.K0K,onClick:async()=>{const e=await l.workspaces.findOne({name:t.id});e&&(l.windows.update({workspace_id:e.id},{closed:!0}),alert("Windows have been closed"))}}),n&&!t.is_state_db&&a.createElement(Btn_Btn,{href:"/connection-config/"+t.id,title:"Configure",className:" ",iconPath:s.Shd,asNavLink:!0,color:"action"}),n&&a.createElement(Btn_Btn,{href:"/edit-connection/"+t.id,title:"Edit connection",className:"  ",iconPath:s.r9,asNavLink:!0,color:"action"})))),(r||c)&&a.createElement("div",{className:"BOTTOM-WORKSPACELIST pl-2 flex-row-wrap p-p25 pt-0 ai-center",title:"Workspace",style:{}},r&&a.createElement(a.Fragment,null,t.workspaces.map((e=>a.createElement(Btn_Btn,{key:e.id,className:"w-fit",color:"action",asNavLink:!0,href:ea(t.id,e.id)},e.name||a.createElement("em",null,"Workspace"))))),c&&a.createElement(Btn_Btn,{className:"as-end ml-auto",title:`Access granted to ${na(t.allowedUsers,"user")} `,iconPath:s.zr,iconPosition:"right",color:"action",asNavLink:!0,href:`/connection-config/${t.id}?section=access_control`},t.allowedUsers)))},na=(e,t)=>`${e} ${aa(e,t)}`,aa=(e,t)=>(e>1||0===e)&&!t.toLowerCase().endsWith("s")?t+"s":t,la=({rule:e})=>{const t={i:"text-green-400",s:"text-gray-600",u:"text-yellow-300",d:"text-red-500"};if("Run SQL"===e.type)return a.createElement("span",{className:"bold"},"Full database access");if("All views/tables"===e.type)return a.createElement("div",{className:"flex-row-wrap gap-p25"},a.createElement("div",{className:"flex-row gap-p25"},["insert","select","update","delete"].filter((t=>(e.allowAllTables||[]).includes(t))).map((e=>a.createElement("div",{key:e,className:t[e[0]].replace("text","bb-2 b")},e)))),"actions allowed to",a.createElement("div",{className:"bold"},"all tables/views"),"within public schema of the database");if("Custom"===e.type){const n=e.customTables.filter((e=>e.select||e.delete||e.insert||e.update)).map((e=>({tableName:e.tableName,s:e.select?"■":"",u:e.update?"■":"",i:e.insert?"■":"",d:e.delete?"■":""}))),l=e=>a.createElement("div",{className:"pl-2 pt-p5 flex-row-wrap gap-p5 o-auto no-scroll-bar",style:{maxHeight:"200px",overflow:"auto"}},e.map(((e,n)=>a.createElement(Chip,{key:n},a.createElement("div",{className:"flex-row-wrap gap-p5"},e.tableName,a.createElement("div",{className:"flex-row gap-p25 ai-center"},e.i&&a.createElement("span",{title:"Insert/add data",className:t.i},e.i),e.s&&a.createElement("span",{title:"Select/view data",className:t.s},e.s),e.u&&a.createElement("span",{title:"Update/edit data",className:t.u},e.u),e.d&&a.createElement("span",{title:"Delete/remove data",className:t.d},e.d)))))));return a.createElement("div",{className:"flex-col gap-1"},a.createElement(qn,{icon:s.$lx,label:"Tables/views: ("+n.length+")"},l(n)))}return a.createElement(a.Fragment,null)},oa=({rules:e,onSelect:t,workspaces:n})=>{const l=e.flatMap((e=>e.access_control_user_types.flatMap((e=>e.ids))));return a.createElement(a.Fragment,null,a.createElement(Zt,{variant:"naked",color:"info",style:{alignItems:"center"},iconPath:""},a.createElement("p",null,l.length?"Users":"Only users"," of type ",a.createElement("strong",null,'"admin"')," have full access to this database."),!!l.length&&a.createElement("p",null,"Users of ",aa(l.length,"type")," ",a.createElement("strong",null,l.map((e=>JSON.stringify(e))).join(", "))," can access according to the rules below:")),!!e.length&&a.createElement(a.Fragment,null,a.createElement("h3",{className:"m-0 mt-1"},"Existing rules ",e.length>5?`(${e.length})`:""),a.createElement("div",{className:"flex-col gap-1 w-fit max-w-full"},e.map(((e,l)=>{var o,i,r;const c=n.filter((t=>{var n,a;return null===(a=null===(n=e.rule.dbsPermissions)||void 0===n?void 0:n.viewPublishedWorkspaces)||void 0===a?void 0:a.workspaceIds.includes(t.id)})).map((e=>e.name)),d=null===(i=null===(o=e.access_control_user_types)||void 0===o?void 0:o[0])||void 0===i?void 0:i.ids;return a.createElement("div",{key:l,className:"flex-col active-shadow-hover gap-p5 pointer rounded p-p5 bg-white shadow b b-gray-300 o-auto",style:{opacity:(null==d?void 0:d.length)?1:0},onClick:()=>t(e)},a.createElement(qn,{icon:s.rI3,title:"User types",className:"ai-center"},a.createElement("span",{className:"text-black font-20 bold"},null==d?void 0:d.join(", "))),a.createElement("div",{className:"mt-p5"},a.createElement(la,{rule:e.rule.dbPermissions})),!!(null===(r=e.rule.dbsPermissions)||void 0===r?void 0:r.createWorkspaces)&&a.createElement("div",{className:"ws-pre"},"Create Workspaces"),!!c.length&&a.createElement(qn,{icon:s.ssP,label:"Workspaces",className:"ai-center"},a.createElement("div",{className:"pl-2"},c.map(((e,t)=>a.createElement(Chip,{title:"Published workspace",color:"blue",key:t},e))))))})))))},ia=s.ssP;class WorkspaceMenu extends RTComp{constructor(){super(...arguments),this.state={loading:!0,queries:[],workspaces:[],showSettings:!1,showExpanded:!0},this.d={},this.onUnmount=()=>{var e;null===(e=this.workspacesSync)||void 0===e||e.$unsync()},this.setWorkspace=e=>{if((null==e?void 0:e.id)&&e.id===this.props.workspace.id)return;const t=["/connections",`${null==e?void 0:e.connection_id}?workspaceId=${null==e?void 0:e.id}`].filter((e=>e)).join("/");window.location.href=t},this.onDelta=async e=>{var t,n;const{dbs:a,workspace:l}=this.props;l&&!this.workspacesSync&&(this.workspacesSync=await(null===(n=(t=a.workspaces).sync)||void 0===n?void 0:n.call(t,{connection_id:l.connection_id,deleted:!1},{handlesOnData:!0,select:"*",patchText:!1},((e,t)=>{this.mounted&&(this.setState({workspaces:e}),setTimeout((()=>{var e,t;null===(t=null===(e=this.listRef)||void 0===e?void 0:e.querySelector("li.active"))||void 0===t||t.scrollIntoView()}),100))}))))}}onMount(){}render(){const{workspaces:e,showExpanded:t}=this.state,{workspace:n,dbsTables:l,dbs:o}=this.props,i=a.createElement(M,{title:"Workspaces",rootStyle:{maxHeight:"100%",marginRight:"1em"},positioning:"beneath-left",button:a.createElement(Btn_Btn,{title:"Manage Workspaces",iconPath:ia,className:"ml-1 text-gray-300",style:{borderRadius:0,padding:"8px"}}),contentStyle:{overflow:"hidden",padding:0,borderRadius:0},render:t=>a.createElement("div",{className:"flex-col f-1 min-h-0 "+(window.isMobileDevice?" pp-p25 ":" pp-1  "),style:{paddingTop:0},onKeyDown:e=>{"Escape"===e.key&&t()}},e.length?a.createElement(SearchList,{id:"search-list-queries",className:" b-t f-1 min-h-0 ",style:{minHeight:"120px",maxHeight:"30vh"},placeholder:"Workspaces",items:e.sort(((e,t)=>+t.last_updated-+e.last_updated)).map(((e,o)=>({key:o,label:e.name,labelStyle:{},rowStyle:n.id===e.id?{border:"1px solid rgb(0, 183, 255)",background:"rgb(155 227 255)"}:{},contentLeft:a.createElement("div",{className:"flex-col ai-start f-0 mr-p5 text-gray-500"},a.createElement(c(),{path:s.ssP,size:1})),contentRight:a.createElement("div",{className:"flex-row gap-p5 pl-1"},e.published&&a.createElement(Btn_Btn,{title:"Published",iconPath:s.zr,color:"action",asNavLink:!0,href:`/connection-config/${e.connection_id}?section=access_control`}),a.createElement(Kn,{w:e,dbs:this.props.dbs,activeWorkspaceId:n.id}),a.createElement(Zn,{w:e,dbs:this.props.dbs,dbsTables:l})),onPress:n=>{var a,l,o,i,s,r;e.id===this.props.workspace.id||(null===(l=null===(a=n.target)||void 0===a?void 0:a.closest)||void 0===l?void 0:l.call(a,".delete-workspace"))||(null===(i=null===(o=n.target)||void 0===o?void 0:o.closest)||void 0===i?void 0:i.call(o,".workspace-settings"))||(null===(r=null===(s=n.target)||void 0===s?void 0:s.closest)||void 0===r?void 0:r.call(s,".clickcatchcomp"))||(this.setWorkspace(e),t())}})))}):a.createElement("div",{className:"text-gray-400"},"No other workspaces")),footer:e=>a.createElement(Qn,{dbs:this.props.dbs,connection_id:n.connection_id,setWorkspace:this.setWorkspace,closePopup:e})});if(t){const t=window.isLowWidthScreen?e.filter((e=>e.id===n.id)):e;return a.createElement("div",{ref:e=>{e&&(this.listRef=e)},className:"flex-row jc-center text-white ai-start f-1  min-w-0 o-auto ml-2",style:{gap:"1px"}},i,a.createElement("ul",{className:"o-auto f-1 min-w-0 max-w-fit flex-row no-scroll-bar "},t.map((e=>a.createElement("li",{key:e.id,className:"workspace-list-item relative "+(n.id===e.id?"active":"")},a.createElement(Btn_Btn,{style:{...n.id!==e.id?{color:"var(--gray-300)",background:"var(--gray-700)"}:{color:"white",fontWeight:600,background:"var(--gray-600)"},borderRadius:0,whiteSpace:"nowrap"},onClick:()=>{this.setWorkspace(e)}},e.name))))),!!o.workspaces.insert&&a.createElement("div",{key:"add-btn",className:"add-wsp-btn flex-col ai-center h-full",style:{}},a.createElement(Qn,{dbs:this.props.dbs,connection_id:n.connection_id,setWorkspace:this.setWorkspace,closePopup:()=>{},className:"flex-col f-1 ai-center",btnProps:{variant:"default",color:void 0,style:{flex:1,borderRadius:0,color:"white"}}})))}}}var sa=n(94656),ra=n(3149),ca=n(46791),da=n(95252),ma=n(4881),pa=n(30641),ua=n(26471),ha=n(99992);class Slider extends RTComp{constructor(){super(...arguments),this.state={ready:!1},this.onDeltaCombined=(e,t)=>{}}onMount(){}render(){var e;const{style:t={},className:n="",min:l,max:o,value:i,label:s,onChange:r,step:c,defaultValue:d}=this.props;return a.createElement("div",{className:"slidecontainer flex-col"+n,style:t},s&&a.createElement("div",{className:"slider-label mb-p25 text-gray-400 noselect",onDoubleClick:Number.isFinite(d)?()=>{r(d)}:void 0},s),a.createElement("input",{type:"range",min:l,max:o,value:null!==(e=null!=i?i:l)&&void 0!==e?e:o,step:Math.min(1,null!=c?c:Math.abs(l-o)/60),className:"slider pointer",onChange:e=>r(+e.target.value,e)}))}}function ga({basemap:e,onBaseMapChange:t,dataOpacity:n,onDataOpacityChange:l,options:o,autoZoom:i,onFitBounds:r,onOptionsChange:c,onAutoZoomChange:d,cursorCoords:m}){return a.createElement("div",{className:"map-controls-right ",style:{position:"absolute",right:0,top:0,bottom:0}},window.isMobileDevice&&a.createElement(Btn_Btn,{iconPath:s.gAv,style:{marginLeft:"-4em"}}),a.createElement(Slider,{label:`Basemap opacity ${e.opacity.toFixed(1)}`,min:0,max:1,value:e.opacity,onChange:n=>{t({...e,opacity:n})}}),a.createElement(Slider,{label:`Basemap desaturate ${e.desaturate.toFixed(1)}`,min:-15,max:15,value:e.desaturate,onChange:n=>{t({...e,desaturate:n})}}),a.createElement(Slider,{label:"Data opacity",min:.001,max:1,value:n,onChange:e=>{l(e)}}),a.createElement("div",{className:"w-full"},a.createElement(Btn_Btn,{title:"Zoom to data extent",iconPath:s.lZ7,style:{background:"white"},className:"b b-gray-200 mt-1",disabledInfo:i?"Must disable Auto zoom to data extent":o.filterExtent?"Must disable 'Auto Filter map extent'":void 0,onClick:r},"Zoom to data extent"),a.createElement(Btn_Btn,{title:"Auto zoom to data extent",iconPath:s.lZ7,color:i?"action":void 0,style:{background:"white"},className:"b b-gray-200 mt-1",disabledInfo:o.filterExtent?"Must disable 'Auto Filter map extent'":void 0,onClick:async e=>{d(!i)}},"Auto Zoom to data extent"),a.createElement(Btn_Btn,{title:"Auto Filter map extent ",iconPath:s.Qbm,color:o.filterExtent?"action":void 0,style:{background:"white"},className:"b b-gray-200 mt-1",disabledInfo:i?"Must disable 'Auto Zoom to data extent'":void 0,onClick:async e=>{c({filterExtent:!o.filterExtent})}},"Auto Filter map extent"),a.createElement(Btn_Btn,{title:"Show cursor coords",iconPath:s.Vdu,color:m.show?"action":void 0,style:{background:"white"},className:"b b-gray-200 mt-1",onClick:async e=>{m.onChange(!m.show)}},"Show cursor coords")))}var fa=n(74692),Ea=n(73362),va=n(52284),ba=n(77380),ya=n(73791);function Na(e){const{width:t=1,height:n=1,bounds:a,minExtent:l=0,maxZoom:o=24,offset:i=[0,0]}=e,[[s,r],[c,d]]=a,m=function(e=0){if("number"==typeof e)return{top:e,bottom:e,left:e,right:e};return e}(e.padding),p=[s,d],u=[c,r],h=[Math.max(Math.abs(u[0]-p[0]),l),Math.max(Math.abs(u[1]-p[1]),l)],g=[t-m.left-m.right-2*Math.abs(i[0]),n-m.top-m.bottom-2*Math.abs(i[1])],f=g[0]/h[0],E=g[1]/h[1],v=(m.right-m.left)/2/f,b=(m.top-m.bottom)/2/E;return{target:[(u[0]+p[0])/2+v,(u[1]+p[1])/2+b],zoom:Math.min(o,Math.log2(Math.abs(Math.min(f,E)))),extent:a}}class DeckWrapped{constructor(e,t){var n,a,l,o,i;this.transitioning=!1,this.onViewStateChangeDebounced=e=>{var t,n;const a=this.getExtent();a&&(null===(n=(t=this.opts).onViewStateChange)||void 0===n||n.call(t,e,a))},this.zoomTo=e=>{var t,n,a;const l=null===(a=null===(n=null===(t=this.deck)||void 0===t?void 0:t.getViewports)||void 0===n?void 0:n.call(t))||void 0===a?void 0:a[0];if(l)try{let t;const n={padding:20};if("2D"!==this.opts.type){const{longitude:a,latitude:o,zoom:i}="fitBounds"in l?l.fitBounds(e,n):new pa.Z({}).fitBounds(e,n);t=DeckWrapped.getViewState(this.opts.type,{longitude:a,latitude:o,zoom:Math.min(i,15)})}else t={...Na({padding:50,bounds:e,width:l.width,height:l.height})};let a={...t,transitionInterpolator:"2D"!==this.opts.type?new fa.Z({speed:2}):new Ea.Z(["target","zoom"]),transitionDuration:800,onTransitionStart:()=>{this.transitioning=!0},onTransitionEnd:()=>{this.transitioning=!1,this.onViewStateChangeDebounced(a)}};this.deck.setProps({initialViewState:a})}catch(e){this.transitioning=!1,console.log(e)}},this.getExtent=()=>{var e,t;const n=null===(t=null===(e=this.deck.getViewports())||void 0===e?void 0:e[0])||void 0===t?void 0:t.getBounds();if(n)return[n.slice(0,2),n.slice(2)]},this.opts=t;const{type:s,initialViewState:r}=this.opts,c="mercator"===s?{latitude:null!==(n=r.latitude)&&void 0!==n?n:0,longitude:null!==(a=r.longitude)&&void 0!==a?a:50,zoom:null!==(l=r.zoom)&&void 0!==l?l:0,...r&&wo(r,["bearing","pitch","zoom","extent"],!0)}:{target:null!==(o=r.target)&&void 0!==o?o:[1,1,0],zoom:null!==(i=r.zoom)&&void 0!==i?i:0,...r&&wo(r,["extent"],!0)};this.deck=new va.Z({initialViewState:c,parent:e,views:DeckWrapped.getViews(t.type),controller:!0,...No(t,["type","onHoverItem","onHover","onClickQuick","onViewStateChange","initialViewState"]),onHover:t.onHover||t.onHoverItem||t.onClickQuick?(e,n)=>{var a,l,o;this.currHover=e,t.onHoverItem&&JSON.stringify(null!==(a=e.object)&&void 0!==a?a:{})!==this.currHoverObjectStr&&(this.currHoverObjectStr=JSON.stringify(null!==(l=e.object)&&void 0!==l?l:{}),t.onHoverItem(e.object,{x:e.x,y:e.y,coordinates:e.coordinate,screenCoordinates:e.pixel})),null===(o=t.onHover)||void 0===o||o.call(t,e,n)}:void 0,onViewStateChange:e=>{this.transitioning||this.onViewStateChangeDebounced(e.viewState)}}),t.onClickQuick&&e.addEventListener("pointerdown",(e=>{var n;this.currHover&&(null===(n=t.onClickQuick)||void 0===n||n.call(t,this.currHover))})),this.onViewStateChangeDebounced=function(e,t){let n;return(...a)=>{clearTimeout(n),n=setTimeout((()=>{e(...a)}),t)}}(this.onViewStateChangeDebounced.bind(this),200)}static get2DState(e,t=0){const[[n,a],[l,o]]=e;return{zoom:t,extent:e,target:[(l-n)/2,(o-a)/2,0]}}render(e){var t,n;if(!(null===(t=this.deck)||void 0===t?void 0:t.isInitialized))return;const a=(null===(n=this.deck)||void 0===n?void 0:n.isInitialized)?this.deck.getViews().map((e=>null==e?void 0:e.constructor.name)):[],l=a.includes("OrthographicView"),o=null==e?void 0:e.map((e=>null==e?void 0:e.constructor.name)).filter(Co),i=null==o?void 0:o.includes("BitmapLayer");if(a.length&&l!==i){const t=i?"2D":"mercator";this.deck.setProps({views:DeckWrapped.getViews(t),initialViewState:DeckWrapped.getViewState(t),layers:e})}else this.deck.setProps({layers:e})}}DeckWrapped.getViews=e=>"2D"===e?[new ba.Z({id:"2d-scene",controller:!0,flipY:!1})]:[new ya.Z({})],DeckWrapped.getViewState=(e,t)=>"2D"===e?{target:[1,1,0],zoom:0,...t}:{longitude:0,latitude:51,zoom:0,...wo(t,["zoom","bearing","pitch","latitude","longitude"])};"undefined"!=typeof window&&window.devicePixelRatio;const wa=300;class DeckGLMap extends RTComp{constructor(){super(...arguments),this.state={basemap:{opacity:.2,desaturate:0},dataOpacity:.5,initialView:{target:[1,1,0],latitude:51.47,longitude:.45,zoom:4,bearing:0,pitch:0},mouseDown:!1,autoZoom:!1,showCursorCoords:!1},this.onDelta=(e,t)=>{var n;if((null==e?void 0:e.geoJsonLayers)&&this.state.autoZoom&&this.deckW&&this.fitBounds(),this.refRoot&&!this.rootResizeObserver){this.rootResizeObserver=new ResizeObserver((()=>{this._rootSizeKey!==this.rootSizeKey&&(this.forceUpdate(),this._rootSizeKey=this.rootSizeKey)})),this.rootResizeObserver.observe(this.refRoot);const{projection:e="mercator",initialState:t}=this.props;this.deckW=new DeckWrapped(this.refRoot,{initialViewState:t,type:e,onLoad:()=>{var e,t;null===(t=(e=this.props).onLoad)||void 0===t||t.call(e,{fitBounds:this.fitBounds,getExtent:()=>{const e=this.deckW.getExtent();if(e)return[e.slice(0,2),e.slice(2)]}})},onViewStateChange:(t,n)=>{var a,l;const o=n.flat();let i={...wo(t,"2D"===e?["target","zoom","extent"]:["latitude","longitude","bearing","pitch","zoom"]),extent:o};null===(l=(a=this.props).onMapStateChange)||void 0===l||l.call(a,i)},onClickQuick:e=>{var t,n;return null===(n=(t=this.props).onClick)||void 0===n?void 0:n.call(t,e)},onHoverItem:(e,t)=>{var n,a;null===(a=(n=this.props).onHover)||void 0===a||a.call(n,e,t)},onHover:e=>{var t,n,a;this.state.showCursorCoords&&this.refCursor&&(this.refCursor.innerText=`${null===(t=e.coordinate)||void 0===t?void 0:t.join("\n")}`),null===(a=(n=this.props).onPointerMove)||void 0===a||a.call(n,{...e,coordinates:e.coordinate,screenCoordinates:e.pixel})},layers:this.getLayers()})}this.deckW&&((null==e?void 0:e.geoJsonLayers)&&this.props.geoJsonLayers||(null==t?void 0:t.dataOpacity)||(null==t?void 0:t.basemap))&&(null===(n=this.deckW)||void 0===n||n.render(this.getLayers()))},this._rootSizeKey="",this.fitBounds=async e=>{var t;const{projection:n}=this.props,a=await this.props.onGetFullExtent();if(!a)return;const l="2D"===n?a:[[Math.max(a[0][0],-179.9),Math.max(a[0][1],-89.9)],[Math.min(a[1][0],179.9),Math.min(a[1][1],89.9)]];null===(t=this.deckW)||void 0===t||t.zoomTo(l)},this.isHovering=!1,this.mouseDown=!1,this.getLayers=()=>{const{basemap:e,dataOpacity:t=1}=this.state,{geoJsonLayers:n=[],tileURLs:a,tileSize:l,projection:o="mercator",basemapImage:i}=this.props,s=n.map((e=>new ca.Z({id:e.id,data:{type:"FeatureCollection",features:e.features},filled:!0,pointRadiusMinPixels:2,pointRadiusScale:1,getPointRadius:e=>{var t,n;return null!==(n=null===(t=e.properties)||void 0===t?void 0:t.radius)&&void 0!==n?n:1},extruded:Boolean(e.elevation),getElevation:e.elevation||0,getFillColor:t=>{var n;return(null===(n=t.properties)||void 0===n?void 0:n.fillColor)||e.fillColor||[200,0,80,255]},getLineColor:t=>{var n;return(null===(n=t.properties)||void 0===n?void 0:n.lineColor)||e.lineColor||[200,0,80,255]},lineWidthMinPixels:2,widthScale:22,lineWidth:e=>{var t,n;return null!==(n=null===(t=e.properties)||void 0===t?void 0:t.lineWidth)&&void 0!==n?n:1},pickable:!0,autoHighlight:!0,onClick:e.onClick,opacity:t})));return[..."mercator"===o?[Ta({...e,tileURLs:a,tileSize:l})]:i?[Ca(i.url,i.bounds,e.opacity,e.desaturate)]:[],...s]}}get rootSizeKey(){var e,t;return`${null===(e=this.refRoot)||void 0===e?void 0:e.offsetWidth}.${null===(t=this.refRoot)||void 0===t?void 0:t.offsetHeight}`}onUnmount(){var e;null===(e=this.rootResizeObserver)||void 0===e||e.unobserve(this.refRoot)}onViewStateChange(e){const{onMapStateChange:t,mapStateChangeDebounce:n=wa,projection:a}=this.props;!this.transitioning&&t&&e&&(this.viewStateDebounce&&window.clearTimeout(this.viewStateDebounce),this.viewStateDebounce=setTimeout((()=>{if("2D"===a)t({...e});else{const n=new pa.Z(e),a=n.unproject([0,0]),l=n.unproject([n.width,n.height]),o=[a[0],l[1]],i=[l[0],a[1]];t({...e,extent:[...o,...i]})}this.viewStateDebounce=null}),n))}render(){var e,t;const{tileAttribution:n,options:l,onOptionsChange:o}=this.props,{basemap:i,dataOpacity:s=1,showCursorCoords:r,autoZoom:c}=this.state;null===(e=this.refRoot)||void 0===e||e.offsetWidth,null===(t=this.refRoot)||void 0===t||t.offsetHeight;return a.createElement("div",{className:"relative flex-col f-1",style:{overscrollBehavior:"contain"},onMouseDown:()=>{this.mouseDown=!0},onMouseUp:()=>{this.mouseDown=!1}},r&&a.createElement("div",{ref:e=>{e&&(this.refCursor=e)},className:"absolute bg-white rounded p-p25",style:{bottom:0,left:0,zIndex:1}}," "),(null==n?void 0:n.title)&&a.createElement("div",{className:"text-ellipsis noselect rounded font-14",style:{position:"absolute",right:0,bottom:0,maxHeight:"1.5em",zIndex:1,backdropFilter:"blur(6px)",padding:"4px"}},a.createElement("a",{href:n.url,target:"_blank"},null==n?void 0:n.title)),a.createElement("div",{ref:e=>{e&&(this.refRoot=e)}}),a.createElement(ga,{autoZoom:c,basemap:i,dataOpacity:s,onAutoZoomChange:e=>this.setState({autoZoom:e}),onBaseMapChange:e=>this.setState({basemap:e}),onDataOpacityChange:e=>this.setState({dataOpacity:e}),onFitBounds:this.fitBounds,onOptionsChange:o,options:l,cursorCoords:{show:r,onChange:e=>{this.setState({showCursorCoords:e})}}}))}}const Sa=["https://a.tile.openstreetmap.org/{z}/{x}/{y}.png","https://b.tile.openstreetmap.org/{z}/{x}/{y}.png","https://c.tile.openstreetmap.org/{z}/{x}/{y}.png"];function Ta({opacity:e=1,desaturate:t=22,tileURLs:n=Sa,onTilesLoad:a,showBorder:l=!1,tileSize:o=256,asMVT:i=!1}={}){return n&&Array.isArray(n)&&n.find((e=>"string"==typeof e))||(n=Sa),new sa.Z({id:"basemap",TilesetClass:ra.ZP,opacity:e,desaturate:t,transparentColor:[255,255,255,255],data:n,maxRequests:20,pickable:!0,onViewportLoad:a,autoHighlight:l,highlightColor:[60,60,60,40],minZoom:0,maxZoom:19,tileSize:o,renderSubLayers:e=>{const{bbox:{west:t,south:n,east:a,north:o}}=e.tile;return[new da.Z(e,{data:null,image:e.data,bounds:[t,n,a,o]}),l&&new ma.Z({id:`${e.id}-border`,visible:e.visible,data:[[[t,o],[t,n],[a,n],[a,o],[t,o]]],getPath:e=>e,getColor:[255,0,0],widthMinPixels:4})]}})}function Ca(e,t,n=1,a=0,l=!1){return new da.Z({opacity:n,transparentColor:[255,255,255,255],desaturate:a,id:"bitmap-layer",bounds:t,image:e,textureParameters:l?{[ha.Z.TEXTURE_MIN_FILTER]:ha.Z.NEAREST,[ha.Z.TEXTURE_MAG_FILTER]:ha.Z.NEAREST}:void 0,coordinateSystem:ua.Df.CARTESIAN})}class SmartTable extends RTComp{constructor(){super(...arguments),this.state={rows:[],tableCols:[],page:1,pageSize:25,totalRows:0,filteredRows:0,sort:[],loadedData:!1},this.getData=async(e,t,n,a)=>{var l;void 0===e&&(e=null!==(l=this.state.filter)&&void 0!==l?l:[]),void 0===t&&(t=this.state.sort),void 0===n&&(n=this.state.page),void 0===a&&(a=this.state.pageSize);try{const{tableName:l,db:o}=this.props,i=o[l];if(!i)return;const s=Vl(e,void 0,this.props.filterOperand),r=await i.count(),c=await i.count(s),d=await i.find(s,{limit:a,orderBy:t,offset:(n-1)*a});this.setState({rows:d,filter:e,sort:t,page:n,pageSize:a,totalRows:r,filteredRows:c,loadedData:!0,error:void 0})}catch(e){this.setState({error:e,loadedData:!0})}}}async onMount(){var e,t;const{filter:n,tableName:a,db:l,tableCols:o,tables:i,allowEdit:s,realtime:r}=this.props,c=l[a];let d=null!=o?o:[];if(!o){const n=null!==(t=null===(e=i.find((e=>e.name===a)))||void 0===e?void 0:e.columns)&&void 0!==t?t:[];d=n.filter((e=>e.select)).map((e=>({key:e.name,sortable:!0,subLabel:e.data_type,...e}))),s&&c&&d.unshift(se(n,c,0,(e=>{this.setState({editRowFilter:e})})))}this.setState({filter:n,tableCols:d},(()=>this.getData()))}async onUnmount(){var e;await(null===(e=this.realtime)||void 0===e?void 0:e.sub.unsubscribe())}onDelta(e,t,n){const{filter:a,tableName:l,db:o,realtime:i}=this.props;(async()=>{var t,n;const s=o[l];!i||!(null==s?void 0:s.subscribe)||this.realtime&&JSON.stringify(a)===JSON.stringify(null===(t=this.realtime)||void 0===t?void 0:t.filter)?(null==e?void 0:e.filter)&&this.getData():(await(null===(n=this.realtime)||void 0===n?void 0:n.sub.unsubscribe()),this.realtime={sub:await s.subscribe(null!=a?a:{},{select:"",limit:0},(()=>{this.getData()})),filter:a})})()}render(){var e;const{tableName:t,db:n,tables:l,onClickRow:o,onClosePopup:i,showInsert:s,className:r,noDataComponent:c,titlePrefix:d,title:m}=this.props,{tableCols:p,filter:u,rows:h,sort:g,page:f,pageSize:E,filteredRows:v,totalRows:b,editRowFilter:y,loadedData:N,error:w}=this.state,S="function"==typeof m?m({filteredRows:v,totalRows:b}):null!=m?m:a.createElement("span",{className:"text-gray-400 bg-gray-100 px-1 py-p5"},null!=d?d:t," ",a.createElement("span",null,`(${v.toLocaleString()}/${b.toLocaleString()})`));if(w)return a.createElement(ErrorComponent,{error:w});if(!N)return a.createElement(Loading,null);if(c&&N&&!(null===(e=this.state.filter)||void 0===e?void 0:e.length)&&!h.length)return c;const T=a.createElement("div",{className:"flex-col f-1 min-h-0 relative "+(i?"":r)},!i&&S,y&&a.createElement(SmartForm,{asPopup:!0,confirmUpdates:!0,hideChangesOptions:!0,db:n,tables:l,tableName:t,rowFilter:y,onSuccess:()=>{this.getData()},onClose:()=>{this.setState({editRowFilter:void 0})}}),a.createElement(SmartFilterBar,{className:"py-1 bg-gray-100 min-h-fit",rowCount:b,db:n,table_name:t,tables:l,filter:u,onChange:e=>{var t,n;null===(n=(t=this.props).onFilterChange)||void 0===n||n.call(t,e),this.getData(e)},hideSort:!0,showInsertUpdateDelete:{onSuccess:()=>this.getData()}}),a.createElement(Table,{rows:h,cols:p,className:"pb -1 ",onRowClick:o,sort:g,onSort:e=>{this.getData(void 0,e)},pagination:{page:f,pageSize:10,totalRows:b,onPageChange:e=>{this.getData(void 0,void 0,e)},onPageSizeChange:e=>{this.getData(void 0,void 0,void 0,e)}}}));return i?a.createElement(Popup,{open:!0,title:S,positioning:"right-panel",onClose:i,contentStyle:{maxWidth:"calc(100vw - 20px)",padding:".5em 0 0 0"},contentClassName:r},T):T}}const _a=["mercator","2D"];function xa(e){var t,n,l,o,i,r,c,d,m,p,u,h,g,f;const{layerQueries:E=[],w:v,tileURL:b,setTileURL:y,layerExtras:N,setLayerExtras:w,tables:S,db:T}=e;let C=[];Array.isArray(v.columns)&&(C=v.columns.filter((e=>{var t;return"None"!==(null===(t=e.style)||void 0===t?void 0:t.type)})));let _={};C.length&&(_={Color:{leftIconPath:s.sc6,content:a.createElement(Select_Select,{label:"Bin size",variant:"div",className:"w-fit b b-gray-300 mb-1",options:C.map((({name:e})=>e)),value:null===(t=v.options)||void 0===t?void 0:t.colorField,onChange:e=>{v.$update({options:{colorField:e}},{deepMerge:!0})}})}});const x=async e=>{const t=(t=100,n=100)=>{v.$update({options:{basemapImage:{url:e,bounds:[0,0,n,t]}}},{deepMerge:!0})};try{const n=new Image;n.onload=function(){const e=n.height,a=n.width;t(e,a)},n.onerror=e=>{console.error(e),t()},n.src=e}catch(e){t(),console.error(e)}},A=S.find((e=>e.info.is_media)),R=(null===(l=null===(n=v.options)||void 0===n?void 0:n.tileURLs)||void 0===l?void 0:l.length)?null===(o=v.options)||void 0===o?void 0:o.tileURLs:Sa,L=null!==(i=v.options.projection)&&void 0!==i?i:"mercator";return a.createElement(Tabs,{variant:"vertical",compactMode:window.isMobileDevice,contentClass:"p-1",items:{"Auto Refresh":{leftIconPath:s.jcD,content:an(v)},Basemap:{leftIconPath:s.dfL,content:a.createElement("div",{className:"flex-col gap-1"},a.createElement(ButtonGroup,{options:_a,value:L,onChange:e=>{v.$update({options:{projection:e}},{deepMerge:!0})}}),"mercator"!==L?a.createElement(a.Fragment,null,a.createElement(FormField,{type:"text",label:"Basemap Image URL",autoComplete:"off",asColumn:!0,value:null===(c=null===(r=null==v?void 0:v.options)||void 0===r?void 0:r.basemapImage)||void 0===c?void 0:c.url,onChange:x,rightIcons:A&&a.createElement(M,{button:a.createElement(Btn_Btn,{iconPath:s.RSU,title:"From data",size:"small"}),render:e=>a.createElement(SmartTable,{title:"Click row to select",db:T,tableName:A.name,tables:S,filter:[{fieldName:"content_type",type:"$ilike",value:"%image%",minimised:!0}],onClickRow:t=>{t&&(x(t.url),e())}})})})):a.createElement(a.Fragment,null,a.createElement(FormField,{type:"text",label:"Attribution",autoComplete:"off",asColumn:!0,value:null===(m=null===(d=null==v?void 0:v.options)||void 0===d?void 0:d.tileAttribution)||void 0===m?void 0:m.title,onChange:e=>{var t;v.$update({options:{tileAttribution:{...(null===(t=null==v?void 0:v.options)||void 0===t?void 0:t.tileAttribution)||{},title:e}}},{deepMerge:!0})}}),a.createElement(FormField,{type:"url",label:"Attribution URL",autoComplete:"off",asColumn:!0,value:null===(u=null===(p=null==v?void 0:v.options)||void 0===p?void 0:p.tileAttribution)||void 0===u?void 0:u.url,onChange:e=>{var t;v.$update({options:{tileAttribution:{...(null===(t=null==v?void 0:v.options)||void 0===t?void 0:t.tileAttribution)||{},url:e}}},{deepMerge:!0})}}),a.createElement("div",{className:"ta-left text-gray-600 font-medium mt-1"},"Tile URLs"),R.map(((e,t)=>a.createElement("div",{key:t,className:"flex-row ai-center py-p5 o-auto"},a.createElement(Btn_Btn,{iconPath:s.x9U,color:"danger",onClick:()=>{v.$update({options:{tileURLs:R.filter((t=>t!==e))}},{deepMerge:!0})}}),a.createElement(Chip,{variant:"naked",value:e})))),a.createElement("div",{className:"ta-left text-gray-400"},"Delete all tiles to restore default"),a.createElement("div",{className:"flex-row mt-1"},a.createElement(FormField,{type:"text",asTextArea:!0,value:b,onChange:y}),a.createElement(Btn_Btn,{iconPath:s.qX5,color:"action",onClick:()=>{const e=Array.from(new Set([...R,b])).filter(Co);v.$update({options:{tileURLs:e}},{deepMerge:!0}),y("")}})),a.createElement(FormField,{className:" mt-1",label:"Tile size",asColumn:!0,value:(null===(h=null==v?void 0:v.options)||void 0===h?void 0:h.tileSize)||256,options:[16,32,64,128,256,512,1024],onChange:e=>{v.$update({options:{tileSize:e}},{deepMerge:!0})}})))},Layers:{leftIconPath:s.i$7,content:a.createElement("div",{className:"flex-col"},E.map(((e,t)=>{var n,l;let o;return"sql"in e&&e.sql?o=a.createElement(a.Fragment,null,a.createElement(Chip,{className:"mt-p25",variant:"naked",label:"SQL",value:e.sql}),a.createElement(Chip,{className:"mt-p25",variant:"naked",label:"Column",value:e.geomColumn})):"tableName"in e&&(o=a.createElement(a.Fragment,null,a.createElement(Chip,{className:"mt-p25",variant:"naked",label:"Table",value:e.tableName}),a.createElement(Chip,{className:"mt-p25",variant:"naked",label:"Column",value:e.geomColumn}))),a.createElement("div",{key:t,className:"flex-col ta-left p-1 b b-gray-300 rounded m-1"},a.createElement(Chip,{className:"mt-p25",variant:"naked",label:"ID",value:e.wid}),o,a.createElement(ColorPicker,{style:{flex:"none"},label:"Layer color",className:"w-fit mt-p5",value:null!==(l=null===(n=null==N?void 0:N[e.wid])||void 0===n?void 0:n.colorStr)&&void 0!==l?l:e.color,onChange:(t,n)=>{w({...N,[e.wid]:{color:n,colorStr:t}})}}))})))},..._,Settings:{leftIconPath:s.Shd,content:a.createElement("div",{className:"flex-col gap-1"},a.createElement("div",null,a.createElement(Chip,{className:"w-fit",variant:"naked",label:"Approximate current connection speed (MB/s)",value:(e.bytesPerSec/1e3).toFixed(1)}),a.createElement(FormField,{className:"mt-1",asColumn:!0,type:"number",label:"Wait time in seconds",hint:"Will aggregate/simplify if data load takes longer than this",value:null!==(f=null===(g=null==v?void 0:v.options)||void 0===g?void 0:g.secondWaitTime)&&void 0!==f?f:2,inputProps:{min:0},onChange:e=>{v.$update({options:{secondWaitTime:e}},{deepMerge:!0})}})),a.createElement(Btn_Btn,{variant:"outline",color:v.options.showAddShapeBtn?"action":void 0,onClick:()=>{v.$update({options:{showAddShapeBtn:!v.options.showAddShapeBtn}},{deepMerge:!0})}},v.options.showAddShapeBtn?"Hide":"Show"," Add shape button"))}}})}class ShapeEditor extends RTComp{constructor(){super(...arguments),this.state={},this.addPoint=e=>{var t;const{shape:n,isEditing:a}=this.state;if(a){const{type:l}=a,o=null!==(t=null==n?void 0:n.coords)&&void 0!==t?t:[];return{type:l,coords:"point"===l?e.coordinates:[...o,e.coordinates]}}},this.removeLastPoint=()=>{const{shape:e,isEditing:t}=this.state;t&&e&&"multiline"===e.type&&this.setState({shape:{...e,coords:e.coords.slice(0,-1)}})},this.keyListener=e=>{"Enter"===e.key&&this.state.isEditing&&this.finishShape()},this.finishShape=async(e=!1)=>{const{isEditing:t,shape:n}=this.state;if(t&&n){if(e)try{await this.props.dbProject[null==t?void 0:t.tableName].insert({[t.geomColumn]:Aa(n)}),this.resetDrawing()}catch(e){this.setState({err:e})}else this.setState({isEditing:{...t,shape:n}});this.props.onStateChange({isDrawing:!1})}},this.resetDrawing=()=>{this.setState({isEditing:void 0,shape:void 0}),this.props.setShape()},this.onDelta=(e,t)=>{const{setShapeEvents:n}=this.props;(null==e?void 0:e.setShapeEvents)&&n({onClick:e=>{const{isEditing:t}=this.state;if(t&&e.coordinates){const t=this.addPoint(e);this.setState({shape:t})}},onPointerMove:e=>{const{shape:t,isEditing:n}=this.state;if(n&&e.coordinates&&t&&"point"!==t.type){const n={...t,coords:[...t.coords,e.coordinates]};this.props.setShape(n)}}}),(null==t?void 0:t.shape)&&this.props.setShape(this.state.shape)}}onMount(){document.body.addEventListener("keydown",this.keyListener)}onUnmount(){document.body.removeEventListener("keydown",this.keyListener)}render(){var e;const{className:t,dbProject:n,style:l,layerQueries:o,dbTables:i,onStateChange:r}=this.props,c={className:t,style:l},{isEditing:d}=this.state;let m;if(d)m=d.shape?a.createElement(SmartForm,{tableName:d.tableName,asPopup:!0,db:n,tables:i,defaultData:{[d.geomColumn]:Aa(d.shape)},onSuccess:this.resetDrawing,onClose:this.resetDrawing}):a.createElement("div",{className:"flex-col gap-1"},a.createElement(Zt,null,"Adding shape"),a.createElement("div",{className:"flex-col gap-1"},a.createElement(Btn_Btn,{variant:"filled",color:"action",onClick:()=>this.finishShape()},"Done"),a.createElement(Btn_Btn,{variant:"filled",color:"action",onClick:()=>this.finishShape(!0)},"Done and insert"),a.createElement(Btn_Btn,{onClick:this.removeLastPoint},"Remove last point"),a.createElement(Btn_Btn,{onClick:this.resetDrawing},"Cancel")));else{const e=null==o?void 0:o.filter((e=>{var t;return"tableName"in e&&(null===(t=n[e.tableName])||void 0===t?void 0:t.update)})),t=e=>{this.setState({isEditing:{tableName:e.tableName,geomColumn:e.geomColumn,type:"multiline"}}),r({isDrawing:!0})};1===(null==e?void 0:e.length)?m=a.createElement(Btn_Btn,{iconPath:s.qX5,title:"Add row",variant:"filled",color:"action",size:"small",onClick:()=>t(e[0])}):(null==e?void 0:e.length)&&(m=a.createElement(M,{...c,button:a.createElement(Btn_Btn,{iconPath:s.qX5,variant:"filled",color:"action",size:"small",title:"Add row"})},e.map((e=>"tableName"in e&&a.createElement(Btn_Btn,{key:e.tableName,onClick:()=>t(e)},e.tableName)))))}return a.createElement("div",{...c,className:(null!==(e=c.className)&&void 0!==e?e:"")+" p-1 "+(d?"bg-white shadow":"")},m)}}function Aa(e,t){let n="";return n="multiline"===e.type?`LINESTRING(${e.coords.map((([e,t])=>`${e} ${t}`)).join(", ")})`:"point"===e.type?`POINT(${e.coords[0]} ${e.coords[1]})`:`POLYGON((${e.coords.map((([e,t])=>`${e} ${t}`)).join(", ")}))`,{ST_GeomFromEWKT:[`${t?`SRID=${t};`:""}${n}`]}}function Ra(e,t){return{id:"1",type:"Feature",properties:{},geometry:"multiline"===e.type?{type:"LineString",coordinates:e.coords}:"point"===e.type?{type:"Point",coordinates:e.coords}:{type:"Polygon",coordinates:[e.coords]}}}const La='md5(((t.*))::text) as "$rowhash"',Oa=({sql:e},t,n)=>{let a=e.trim()+"";return a.endsWith(";")&&(a=a.slice(0,a.length-1)),`SELECT ${t}, ST_AsGeoJSON(ST_SetSRID(\${geomColumn:name}, 4326))::json as l FROM ( \n`+a+"\n ) t  "+("number"==typeof n?` LIMIT ${n} `:"")};class ProstglesMap extends RTComp{constructor(){super(...arguments),this.state={loadingLayers:!1,loading:!1,wSync:null,minimised:!1,lqs:[],error:null,showError:!1,hoverObj:void 0,hoverCoords:void 0,hovData:void 0,layerExtras:{},bytesPerSec:0},this.goToDataExtent=async()=>{var e,t,n;let a;try{a=await this.getDataExtent(),a&&(null===(e=this.d.w)||void 0===e||e.$update({options:{extent:a.flat()}},{deepMerge:!0}),null===(t=this.map)||void 0===t||t.fitBounds(a))}catch(e){return(null===(n=this.state.error)||void 0===n?void 0:n.toString())!==e.toString()&&this.setState({error:e,showError:!0}),void console.error(e)}},this.gettingExtent=!1,this.onDelta=async(e,t,n)=>{var a,l,o,i,s;const r={...e,...t,...n};let c={};if(this.d.w){this.gettingExtent||(null===(a=this.d.w.options)||void 0===a?void 0:a.extent)||!(null===(l=this.props.layerQueries)||void 0===l?void 0:l.length)||(this.gettingExtent=!0,setTimeout((()=>{this.mounted&&(this.goToDataExtent(),this.gettingExtent=!1)}),600));const e=null!==(i=null===(o=r.w)||void 0===o?void 0:o.options)&&void 0!==i?i:{},t=Object.keys(e||{});Object.keys(r.w||{});if(r&&((null==r?void 0:r.layerExtras)||r.layerQueries||r.joinFilter||t.length||t.includes("refresh"))&&(this.setLayerData(),t.includes("refresh"))){const{refresh:e}=this.d.w.options;this.autoRefreshInterval&&(clearInterval(this.autoRefreshInterval),this.autoRefreshInterval=void 0),"Interval"===(null==e?void 0:e.type)&&(null==e?void 0:e.intervalSeconds)&&(this.autoRefreshInterval=setInterval((()=>{this.setLayerData()}),1e3*e.intervalSeconds))}((null===(s=this.d.w.options)||void 0===s?void 0:s.filterExtent)&&t.includes("extent")||t.includes("filterExtent"))&&this.props.onFilter()}nl(c)||this.setState(c)},this.layerSubs=[],this.getFilter=(e,t)=>{const{geomColumn:n,tableFilter:a,joinFilter:l,externalFilters:o}=e,i={$and:[a,...o].filter(Co)},s=ProstglesMap.extentToFilter(t,n);return{finalFilter:{$and:[...i.$and,l||s].filter(Co)},finalFilterWOextent:i}},this.getSQL=(e,t,n=1e3)=>{var a;if(!e.sql)throw"No SQL";let l=(null===(a=e.sql)||void 0===a?void 0:a.trim())+"";return l.endsWith(";")&&(l=l.slice(0,l.length-1)),l=`SELECT ${t} FROM ( \n  ${l} \n ) t LIMIT ${n}`,{sql:l,args:{...e.parameters,geomColumn:e.geomColumn}}},this.getDataExtent=async(e=!1)=>{var t,n,a,l,o,i,s;const{db:r,layerQueries:c=[]}=this.props;let d,m,p,u,h;for await(const g of c){if("tableName"in g){const{tableName:e,geomColumn:o}=g,{finalFilterWOextent:i}=this.getFilter(g,[]);if(!(null===(t=r[e])||void 0===t?void 0:t.findOne))throw`db.${e}.find not allowed`;h=null!==(l=await(null===(a=null===(n=r[e])||void 0===n?void 0:n.findOne)||void 0===a?void 0:a.call(n,i,{select:{e:{$ST_Extent:[o]}}})))&&void 0!==l?l:[]}else{if(!r.sql)throw"SQL not allowed";const e=this.getSQL(g,"ST_Extent(${geomColumn:name}::geometry) as e");try{h=null!==(o=await r.sql(e.sql,e.args,{returnType:"row"}))&&void 0!==o?o:void 0}catch(e){console.error(e)}}if(!(null==h?void 0:h.e))return void(e&&alert("No data to zoom to"));const[[c,f],[E,v]]=null===(s=null===(i=null==h?void 0:h.e)||void 0===i?void 0:i.slice(4,-1))||void 0===s?void 0:s.split(",").map((e=>e.split(" ").map((e=>+e))));d=Math.min(null!=d?d:c,c),p=Math.max(null!=p?p:E,E),m=Math.min(null!=m?m:f,f),u=Math.max(null!=u?u:v,v)}if(void 0!==d)return[[d,m],[p,u]]},this.dataSignature="",this.lastDataRequest=Date.now(),this.loadAgain=!1,this.setLayerData=async(e=!1)=>{var t,n;const{db:a,layerQueries:l=[],tables:o}=this.props,{w:i}=this.d;let s,r=(null===(t=null==i?void 0:i.options)||void 0===t?void 0:t.extent)||[-180,-90,180,90],c={};const d=1e5;let{bytesPerSec:m}=this.state;if(this.state.loadingLayers)this.loadAgain=!0;else{if(a&&i&&(null===(n=null==i?void 0:i.options)||void 0===n?void 0:n.extent))try{this.setState({loadingLayers:!0}),this.lastDataRequest=Date.now(),this.layerSubs.filter((e=>!l.find((t=>"tableName"in t&&t.tableName===e.tableName)))).map((e=>{e.sub.unsubscribe()}));const e=[];await Promise.all(l.map((async(t,n)=>{var l,s,c,p,u,h,g,f,E,v,b,y,N,w,S,T;let C,_,x,A,R="",L={},O={},{geomColumn:I,sourceW:D}=t,k=!1;const M="l";if("tableName"in t){const{tableName:n,geomColumn:w}={...t};x=n,A=w;if(!(null===(l=o.find((e=>e.name===n)))||void 0===l?void 0:l.columns))return void this.setState({error:"Could not find columns for table: "+n});const S=a[n];if(!(null==S?void 0:S.find)||!S.findOne||!S.size)throw`db.${n} handler is missing one of the required permissions: find, findOne, size`;const T=(null===(s=null==i?void 0:i.options)||void 0===s?void 0:s.zoom)||1,I=this.getFilter(t,r);L=I.finalFilterWOextent;const D=L,F=JSON.stringify(D);if(S.subscribe&&"Realtime"===(null===(p=null===(c=i.options)||void 0===c?void 0:c.refresh)||void 0===p?void 0:p.type)&&!this.layerSubs.find((e=>e.filter===F&&e.tableName===n)))try{const e=await S.subscribe(D,{limit:2,throttle:1e3*(null!==(g=null===(h=null===(u=i.options)||void 0===u?void 0:u.refresh)||void 0===h?void 0:h.throttleSeconds)&&void 0!==g?g:0)},(()=>{this.setLayerData()}));this.layerSubs.push({tableName:n,filter:F,sub:e})}catch(e){console.error(e),alert("Could not subscribe. Check logs ")}const P=Date.now();let H=[];H.length||(H=["$rowhash"]);let B={};H.forEach((e=>{if(B[e]=1,M===e)throw`Unexpected. geoJsonCol === idColKey === ${e}`}));const W=await S.findOne(I.finalFilter,{select:{[M]:{$ST_AsGeoJSON:[w]}}}),$=(Date.now()-P)/1e3;if(m=4*JSON.stringify(W||{}).length/$,O={select:{...B,[M]:{$ST_AsGeoJSON:[w]}},limit:d},!W||!this.ref)return void e.push({dataSignature:R,id:"tbl"+Date.now(),features:[],pickable:!0,stroked:!0,filled:!0});const U=Math.abs(r[0]-r[2]),q=Math.abs(r[1]-r[3]),j=this.ref.offsetWidth,z=this.ref.offsetHeight,Y=(Math.min(j,z),Math.min(U,q));if(!(null===(f=null==W?void 0:W.l)||void 0===f?void 0:f.type.endsWith("Point"))){const e=(T>7?Mn.BYU().range([0,.005]).domain([9,7]).clamp(!0):Mn.BYU().range([.005,.05]).domain([7,1]).clamp(!0))(T);e>0&&(O={select:{...B,[M]:{$ST_Simplify:[w,e]}},limit:d})}const V=this.getDataSignature({filter:I.finalFilter,...O});if(R=V.signature,V.cachedLayer)return void e.push(V.cachedLayer);const G=+await S.size(I.finalFilter)/1e3/m;if(k="Point"===(null===(E=null==W?void 0:W.l)||void 0===E?void 0:E.type)&&G>(null!==(N=null===(y=null===(b=null===(v=this.d)||void 0===v?void 0:v.w)||void 0===b?void 0:b.options)||void 0===y?void 0:y.secondWaitTime)&&void 0!==N?N:2),k){const e=Mn.BYU().range([20,300]).domain([.001,.1]),t=Mn.BYU().range([.07,5e-4]).domain([.886,.007166])(Y),n={select:{c:{$countAll:[]},[M]:{$ST_SnapToGrid:[w,t]}},limit:d},a=await S.find(I.finalFilter,n);let l,o;null==a||a.forEach((({c:e})=>{l=Math.min(null!=l?l:+e,+e),o=Math.max(null!=o?o:+e,+e)}));const i=e(Y),s=Mn.BYU().range([1,i]).domain([l,o]);_=null==a?void 0:a.map((e=>({...e,radius:s(+e.c)})))}else{const e=Mn.BYU().range([1,10,80,100]).domain([20,14,10,1]).clamp(!0);C=await S.find(I.finalFilter,O);const t=e(T);C=null==C?void 0:C.map((e=>({...e,radius:t})))}_&&(_=_.filter((e=>{var t,n;return null===(n=null===(t=e.l)||void 0===t?void 0:t.coordinates)||void 0===n?void 0:n.length}))),C&&(C=C.filter((e=>{var t,n;return null===(n=null===(t=e.l)||void 0===t?void 0:t.coordinates)||void 0===n?void 0:n.length})))}else if("sql"in t){if(!a.sql)return console.error("Not enough privileges to run query"),void alert("Could not show data: sql privilege not allowed for current user");const{sql:n,parameters:l}=t,o=this.getDataSignature({sql:n});if(R=o.signature,o.cachedLayer)return void e.push(o.cachedLayer);C=await(async(e,t,n)=>{const{parameters:a,geomColumn:l}=e,o=Oa(e,[La,"ST_AsGeoJSON(ST_SetSRID(${geomColumn:name}, 4326))::json as l"].join(", "),n);return await t.sql(o,{...a,geomColumn:l},{returnType:"rows"})})(t,a,d)}let F=C||_||[];F=F.filter((e=>e.l));const P=F.find((e=>"object"!=typeof e.l));P&&(console.error("Bad GeoJSON data. Expecting type object but got -> "+typeof P.l,P),F=[]);const{layerExtras:H}=this.state,B=(null===(w=null==H?void 0:H[t.wid])||void 0===w?void 0:w.color)||t.fillColor,W=(null===(S=null==H?void 0:H[t.wid])||void 0===S?void 0:S.color)||t.lineColor,$=(null===(T=null==H?void 0:H[t.wid])||void 0===T?void 0:T.color)||t.lineColor;e.push({id:"layer-"+Date.now(),dataSignature:R,features:F.map((e=>({type:"Feature",geometry:e.l,properties:{radius:+e.radius||1,...e,layer:t,tableName:x,geomColumn:A,fillColor:(()=>{var t,n;if(!k&&D.table_name&&D.columns){D.columns.filter((e=>{var t,n;return(null===(t=e.style)||void 0===t?void 0:t.type)&&"None"!==(null===(n=e.style)||void 0===n?void 0:n.type)}))}const{clickedItem:a}=this.state;return(null===(n=null===(t=e.l)||void 0===t?void 0:t.type)||void 0===n?void 0:n.includes("Polygon"))?null==B?void 0:B.slice(0,3).concat([200]):B})()}}))),pickable:!0,stroked:!0,filled:!0,elevation:t.elevation,fillColor:B,lineColor:W,getLineWidth:e=>1211,layerColor:$,lineWidth:1222})}))),c={layers:e}}catch(e){s=e}(null==c?void 0:c.layers)||delete c.layers,this.loadAgain&&(this.loadAgain=!1,setTimeout((()=>this.setLayerData()),0)),this.setState({...c,loadingLayers:!1,error:s,bytesPerSec:m})}},this.onHover=async(e,t)=>{const{db:n,tables:a}=this.props;if(!e&&!this.hovering&&!this.state.hoverObj)return;this.hoveredObj=e;const l=JSON.stringify(e);if(this.hovering){if(this.hovering.hoverObjStr===l)return;clearTimeout(this.hovering.timeout)}e?this.hovering={hoverObj:{...e},hoverObjStr:l,timeout:setTimeout((async()=>{var o,i,s,r;if((null===(o=this.hovering)||void 0===o?void 0:o.hoverObjStr)===l){const{tableName:l,$rowhash:o,layer:c,c:d}=e.properties;let m;if("table"===c.type){if(d)m={Count:d};else if(l){const e=a.find((e=>e.name===l));if(e){const t=e.columns.filter((e=>["geography","geometry"].includes(e.udt_name))).reduce(((e,t)=>({...e,[t.name]:0})),{});m=await(null===(s=null===(i=n[l])||void 0===i?void 0:i.findOne)||void 0===s?void 0:s.call(i,{$rowhash:o},{select:t}))}}}else"sql"===c.type&&o&&(m=null===(r=await(async(e,t,n)=>{const{parameters:a,geomColumn:l}=e,o=`SELECT * FROM (\n ${Oa(e,[La,"row_to_json((t.*)) as d"].join(", "))} \n ) tt WHERE "$rowhash" =  \${$rowhash} `;return await t.sql(o,{...a,geomColumn:l,$rowhash:n},{returnType:"row"})})(c,n,o))||void 0===r?void 0:r.d);this.hovering=void 0,this.setState({hoverObj:e,hoverCoords:t,hovData:m})}}),300)}:(this.hovering=void 0,this.setState({hoverObj:e,hoverCoords:t,hovData:void 0}))},this.getMenu=e=>{const{layerExtras:t,tileURL:n,bytesPerSec:l}=this.state;return a.createElement(xa,{layerQueries:this.props.layerQueries,tables:this.props.tables,db:this.props.db,w:e,tileURL:n,setLayerExtras:e=>this.setState({layerExtras:e}),layerExtras:t,setTileURL:e=>this.setState({tileURL:e}),bytesPerSec:l})}}getDataSignature(e){var t;const n=ProstglesTable.getDataRequestSignature(e);let a;return a=null===(t=this.state.layers)||void 0===t?void 0:t.find((e=>e.dataSignature===n)),{signature:n,cachedLayer:a}}onMount(){var e;const{db:t,w:n}=this.props;if(t&&!this.state.wSync){let t=null===(e=n.$cloneSync)||void 0===e?void 0:e.call(n,((e,t)=>{this.setData({w:e},{w:t})}));this.setState({wSync:t})}}onUnmount(){var e,t;null===(t=null===(e=this.state.wSync)||void 0===e?void 0:e.$unsync)||void 0===t||t.call(e),this.layerSubs.map((e=>{e.sub.unsubscribe()}))}render(){var e,t,n,l;const{minimised:o=!1,layers:i=[],loadingLayers:r,error:c,showError:d,clickedItem:m,hoverCoords:p,hovData:u,drawingShape:h,isDrawing:g}=this.state,{w:f}=this.d,{onClickRow:E,db:v,tables:b,layerQueries:y}=this.props;if(!f)return null;const N=h?[...i,{dataSignature:"drawingSHAPE",features:[h],filled:!0,id:"drawingSHAPE",fillColor:[131,56,236,255],getLineWidth:e=>1211,layerColor:[131,56,236,255],lineColor:[131,56,236,255],lineWidth:1222,pickable:!0,stroked:!0}]:i;let w;d&&(w=a.createElement(Popup,{open:!0,onClose:()=>{this.setState({showError:!1})}},a.createElement("div",{className:"bg-white"},a.createElement(ErrorComponent,{error:c}))));let S,T=null;if(u&&p){const{screenCoordinates:e=[20,20]}=p;T=a.createElement(Popup,{open:!0,clickCatchStyle:{display:"none"},anchorXY:{x:e[0],y:e[1]},positioning:"tooltip",contentClassName:"p-p5"},a.createElement("div",{className:"bg-white o-auto flex-col"},Object.keys(u).map((e=>{let t=["string","number"].includes(typeof u[e])?`${u[e]}`:JSON.stringify(u[e],null,2);return t.length>20&&(t=t.slice(0,30)+"..."),a.createElement("div",{key:e,className:"flex-row ai-center",style:{marginBottom:"4px"}},a.createElement("div",{className:"text-medium text-gray font-12",style:{color:"var(--gray-400)",fontWeight:"bold"}},e,":"),a.createElement("div",{className:"ml-p5"},t))}))))}(r||c)&&(S=a.createElement("div",{className:"flex-row relative",style:{position:"absolute",top:"1em",left:"1em",zIndex:22}},r?a.createElement(Loading,{delay:100}):null,c?a.createElement(Btn_Btn,{className:"text-red-500",iconPath:s._gM,onClick:()=>{this.setState({showError:!0})}}):null));let C=N||[];C=C.map((e=>(e.features=e.features.map((t=>{var n,a;return(null===(n=null==m?void 0:m.properties)||void 0===n?void 0:n.$rowhash)&&t.properties.$rowhash===(null===(a=null==m?void 0:m.properties)||void 0===a?void 0:a.$rowhash)?(t.properties.fillColor=[0,0,0,255],t.properties.lineColor=[0,0,0,255]):(t.properties.fillColor=e.layerColor,t.properties.lineColor=e.layerColor),t})),e)));let _=a.createElement(a.Fragment,null,T,w,o?null:a.createElement("div",{className:"relative f-1 flex-col o-hidden",ref:e=>{e&&(this.ref=e)},onPointerLeave:()=>{this.onHover()},style:g?{cursor:"crosshair"}:{}},!!f.options.showAddShapeBtn&&a.createElement(ShapeEditor,{style:{zIndex:232,top:"12px",left:"12px"},className:"absolute ",dbProject:v,dbTables:b,layerQueries:y,onStateChange:({isDrawing:e})=>{this.setState({isDrawing:e})},setShape:e=>{this.setState({drawingShape:e?Ra(e):void 0})},setShapeEvents:e=>{this.shapeEvents=e}}),S,a.createElement(DeckGLMap,{onLoad:e=>{this.setLayerData(),this.map=e},basemapImage:f.options.basemapImage,projection:f.options.projection,onClick:e=>{var t,n,a,l,o;null===(t=this.shapeEvents)||void 0===t||t.onClick({...e,coordinates:e.coordinate,screenCoordinates:e.pixel});const i=null===(a=null===(n=null==e?void 0:e.object)||void 0===n?void 0:n.properties)||void 0===a?void 0:a.$rowhash;E(i?{$rowhash:i}:void 0,null===(o=null===(l=null==e?void 0:e.object)||void 0===l?void 0:l.properties)||void 0===o?void 0:o.tableName),this.setState({clickedItem:null==e?void 0:e.object})},tileURLs:((null===(e=null==f?void 0:f.options)||void 0===e?void 0:e.tileURLs)||[]).map((e=>e.replaceAll("{Z}","{z}").replaceAll("{X}","{x}").replaceAll("{Y}","{y}"))),tileSize:(null===(t=null==f?void 0:f.options)||void 0===t?void 0:t.tileSize)||256,tileAttribution:null===(n=null==f?void 0:f.options)||void 0===n?void 0:n.tileAttribution,initialState:(null==f?void 0:f.options)||{},geoJsonLayers:C,options:{filterExtent:null===(l=null==f?void 0:f.options)||void 0===l?void 0:l.filterExtent},onOptionsChange:e=>{f.$update({options:e},{deepMerge:!0})},onMapStateChange:({extent:e,latitude:t,longitude:n,zoom:a,pitch:l,bearing:o,target:i})=>{var s;(null===(s=null==f?void 0:f.options)||void 0===s?void 0:s.extent)&&f.$update({options:{target:i,extent:e,latitude:t,longitude:n,zoom:a,pitch:l,bearing:o}},{deepMerge:!0})},onHover:this.onHover,onPointerMove:e=>{var t;return e?null===(t=this.shapeEvents)||void 0===t?void 0:t.onPointerMove(e):void 0},onGetFullExtent:this.getDataExtent})));return a.createElement(Window,{w:f,getMenu:this.getMenu},_)}}ProstglesMap.extentToFilter=(e,t)=>({[`${t}.&&.st_makeenvelope`]:e});const Ia=(e,t,n)=>{const a=t[t.length-1],l=t.length>1?t.slice(-1).map((e=>[e.w1_id,e.w2_id])).flat():[];return e.filter((e=>[e.w1_id,e.w2_id].some((e=>[a.w1_id,a.w2_id].filter((e=>!l.includes(e))).includes(e)))&&!t.some((t=>t.id===e.id))&&!n.some((t=>t.id===e.id))))},Da=(e,t,n,a)=>{if(e.id===t.wid)return[];const l=a.filter((e=>!e.closed&&"table"===e.type)),o=n.filter((e=>![e.w1_id,e.w2_id].find((e=>!l.some((t=>t.id===e)))))),i=((e,t)=>{const n=e.filter((e=>[e.w1_id,e.w2_id].includes(t.id)));let a=n.map((e=>[e])),l=!1,o=20;do{let t=!1,i=[];const s=a.length;for(let l=0;l<s;l++){let o=a[l];const s=Ia(e,o,n);t=t||Boolean(s.length),s.length>1&&s.slice(1).map((e=>{i.push([...o,e])})),s.length&&(a[l]=[...o,s[0]])}a=a.concat(i),l=!t,o--}while(!l&&o);return a})(o,e),s=i.map((t=>((e,t,n)=>{let a=[];return t.map(((l,o)=>{const i=n.find((e=>l.w1_id===e.id)),s=n.find((e=>l.w2_id===e.id)),r=o===t.length-1;if(!(null==i?void 0:i.table_name)||!(null==s?void 0:s.table_name))return;let c=Boolean(!o&&l.w1_id===e.id||o&&[t[o-1].w1_id,t[o-1].w2_id].includes(l.w1_id)),d=[];"tablePath"in l.options&&l.options.tablePath&&(d=[...l.options.tablePath.slice(0)],c||d.reverse()),d=d.filter((e=>![i.table_name,s.table_name].includes(e))),a=[...a,c?i.table_name:s.table_name,...d],r&&(a=[...a,c?s.table_name:i.table_name])})),a})(e,t,l))),r=i.map((e=>e.flatMap((e=>[e.w1_id,e.w2_id])))).findIndex((n=>n.includes(e.id)&&n.includes(t.wid)));if(r>-1){const n=s[r].slice(1,s[r].lastIndexOf(t.table_name)+1);return 1===n.length&&n[0]===e.table_name?[]:n}},ka=(e,t,n)=>{let a=[];if("table"!==e.type)throw"Must be table";return n.map((n=>{var l;if(el(n,"map")||el(n,"timechart")){const o=t.find((t=>[t.w1_id,t.w2_id].sort().join()===[e.id,n.id].sort().join()));if(o){let e;el(n,"map")&&(null===(l=n.options)||void 0===l?void 0:l.filterExtent)&&n.options.extent&&(e=ProstglesMap.extentToFilter(n.options.extent,o.options.geomColumn)),a.push({chart:n,link:o,filter:e})}}})),a},Ma=(e,t,n,a,l)=>{const o=a.map((e=>e.$get()));let i,s=[];if(el(e,"table")){const a=ka(e,n,o),r=a.map((e=>e.filter));s=o.filter((t=>el(t,"table")&&t.id!==e.id)).map((t=>{if(!el(t,"table"))throw 1;const a=ka(t,n,o).map((e=>e.filter)).filter(Co),l=Vl(t.filter||[],{filters:a});return Fa(e,{window_id:t.id,table_name:t.table_name,row_filter:l},n,o)})).concat(r).filter(Co),i=!l&&t&&a.find((e=>e.chart.id===t.window_id))&&e.table_name===t.table_name||l&&(null==t?void 0:t.window_id)===e.id?t.row_filter:Fa(e,t,n,o)}else console.error("Not implemented");return{activeRowFilter:i,crossFilters:s,all:[i,...s].filter(Co)}},Fa=(e,t,n,a)=>{if(e.id!==(null==t?void 0:t.window_id)&&t){const l=Da(e,{wid:t.window_id,table_name:t.table_name},n,a);if(e.id===(null==t?void 0:t.window_id)||0===(null==l?void 0:l.length))return t.row_filter;if(l)return{$existsJoined:{[l.join(".")]:t.row_filter}}}};class JoinTableMenu extends RTComp{constructor(){super(...arguments),this.state={},this.d={}}render(){const{onLinkTable:e,w:t,tables:n}=this.props,{linkTablePath:l}=this.state;null==l||l[l.length-1];return a.createElement("div",{className:"flex-col ai-start"},a.createElement(JoinPathSelector,{className:"w-full",tableName:t.table_name,tables:n,onLinkTable:e,onSelect:e=>{this.setState({linkTablePath:e})}}))}}class LinkMenu extends RTComp{constructor(){super(...arguments),this.state={loading:!0,shapes:[],chartRef:void 0},this.onDelta=async(e,t,n)=>{var a,l;null===(l=null===(a=this.state.chartRef)||void 0===a?void 0:a.render)||void 0===l||l.call(a,this.state.shapes||[])}}async onMount(){var e,t;const{w:n,db:a,links:l,gridRef:o,windows:i,tables:s}=this.props;let r=[];if(n.table_name){const e=LinkMenu.getMyLinks(l,n,i),t=(i.filter((t=>!t.closed&&!t.deleted&&e.some((e=>[e.w1_id,e.w2_id].includes(t.id))))),s.find((e=>e.name===n.table_name)),[]);let a;o.querySelectorAll("[data-box-id][data-box-type='item']").forEach((e=>{const n=e.dataset.boxId,a=e.getBoundingClientRect(),l=i.find((e=>e.id===n));t.push({id:n,rect:a,w:l})}));const c=e.find((e=>{var t;return null===(t=null==e?void 0:e.options)||void 0===t?void 0:t.color}));if(c){const e=Xa[c.options.colorKey];e&&(a=e)}e.forEach((e=>{var n,o,c,d,m;const p=t.find((t=>t.id===e.w1_id)),u=t.find((t=>t.id===e.w2_id)),h=e=>[e.rect.x+e.rect.width/2,e.rect.y+e.rect.height/2];if(p&&u){const t=t=>{var n,a;return t?el(t,"table")?t.table_name:el(t,"map")?`(${null===(n=null==e?void 0:e.options)||void 0===n?void 0:n.geomColumn})`:el(t,"timechart")?`(${null===(a=null==e?void 0:e.options)||void 0===a?void 0:a.dateColumn})`:"":""},g={font:"20px Arial",textAlign:"center",elevation:12,background:{fillStyle:"white",borderRadius:12,padding:12}};r.push({type:"multiline",coords:[h(p),h(u)],lineWidth:6,strokeStyle:a.get(1)}),r.push({id:1,type:"text",coords:h(p),fillStyle:"black",text:t(p.w),...g}),r.push({id:3,type:"text",coords:h(u),fillStyle:"black",text:t(u.w),...g});let f=[];const E=i.find((e=>e.id===p.id)),v=i.find((e=>e.id===u.id));if(!E||!v)return;const b=null===(n=window.document.body.querySelector(`[data-box-id='${E.id}']`))||void 0===n?void 0:n.getBoundingClientRect(),y=null===(o=window.document.body.querySelector(`[data-box-id='${v.id}']`))||void 0===o?void 0:o.getBoundingClientRect();if(!b||!y)return;const N=Boolean(b&&y&&b.y<y.y),w=Boolean(b&&y&&b.x>y.x),S=Math.abs(b.y-y.y)>Math.abs(b.x-y.x)?"y":"x";let T=[];el(E,"table")&&el(v,"table")?(T=null!==(c=Da(E,{wid:v.id,table_name:v.table_name},l,i))&&void 0!==c?c:[],(null==T?void 0:T.length)||(T=null!==(m=null===(d=Da(v,{wid:E.id,table_name:E.table_name},l,i))||void 0===d?void 0:d.slice(0).reverse())&&void 0!==m?m:[]),E.table_name&&(T=[E.table_name,...T]),f=T.flatMap(((e,t)=>{if(T&&t<T.length-1){const n=s.find((t=>t.name===e));if(n){const a=n.joins.find((e=>e.tableName===(null==T?void 0:T[t+1])));if(a){const n={text:"("+a.on.join(", ")+")",color:"blue"},l={text:e,color:"black"};return T.length>2&&t?[l,n]:n}}}})).filter(Co)):T=[];let C=!1;if(N||"y"!==S?w&&"x"===S&&(f=f.slice(0).reverse()):C=!0,C&&(f=f.slice(0).reverse()),null==f?void 0:f.length){const e=h(p),t=h(u),n=16;f.map((({text:a,color:l},o)=>{r.push({id:22+o,type:"text",coords:[Math.round((e[0]+t[0])/2),Math.round((e[1]+t[1])/2+2.5*o*n)],fillStyle:l,font:n+"px Arial",textAlign:"center",elevation:12,background:{fillStyle:"white",borderRadius:12,padding:10,strokeStyle:null!=l?l:"gray",lineWidth:1},text:a})}))}}}))}null===(t=null===(e=this.chartRef)||void 0===e?void 0:e.render)||void 0===t||t.call(e,r),this.setState({loading:!1,shapes:r})}render(){const{loading:e,shapes:t}=this.state,{onClose:n,anchorEl:l,onLinkTable:o,tables:i,w:s}=this.props;if(e)return a.createElement(Loading,null);const r=i.some((e=>e.name===s.table_name&&e.joins.length));return a.createElement(a.Fragment,null,a.createElement(Popup,{open:!0,onClose:n,title:r?"Add referenced table":void 0,collapsible:!0,anchorEl:l,clickCatchStyle:{opacity:0,zIndex:14},contentStyle:r?{paddingTop:0}:{display:"none"},rootStyle:{zIndex:14}},r&&a.createElement(JoinTableMenu,{w:s,tables:i,onLinkTable:(e,t)=>{o(e,t),n()}})),a.createElement(Chart,{className:"h-full w-full",style:{position:"absolute",inset:0,zIndex:14,backdropFilter:"blur(1px)",backgroundColor:"#80808030"},setRef:e=>{this.chartRef=e,this.setState({chartRef:e})}}))}}LinkMenu.getMyLinks=(e,t,n)=>{const a=(e,t)=>t.filter((t=>[t.w1_id,t.w2_id].some((t=>e.some((e=>[e.w1_id,e.w2_id].includes(t))))))),l=e.filter((e=>[e.w1_id,e.w2_id].every((e=>n.some((t=>e===t.id&&!t.closed&&!t.deleted))))));let o=l.filter((e=>[e.w1_id,e.w2_id].includes(t.id))),i=o,s=[...o];do{o=a(i,l.filter((e=>!s.find((t=>t.id===e.id))))),i=o,s=s.concat(o)}while(o.length);return s};const Pa=(e=[],t)=>{let n=t;if(t&&e){n=t.slice(0);const a=n.findIndex((e=>"*"===e));a>-1&&n.splice(a,0,...e.map((e=>e.name)));const l=n.findIndex((e=>"**"===e));l>-1&&n.splice(l,0,...e.filter((e=>{var t;return null===(t=e.references)||void 0===t?void 0:t.length})).flatMap((e=>e.references.map((e=>({name:e.ftable,fieldConfigs:["*"]})))))),n=n.filter((e=>!["*","**"].includes(e)))}const l=e=>({name:e.name,label:e.label,renderValue:"uuid"===e.udt_name?e=>a.createElement("div",{className:"pointer",title:"Click to copy ID",onClick:()=>{navigator.clipboard.writeText(e)}},e?e.slice(0,5):e,"..."):["postcode","post_code"].includes(e.name)?t=>t?a.createElement("a",{className:"flex-col",target:"_blank",href:`https://www.google.com/maps/search/${t}`},a.createElement("span",null,SmartFormField.renderValue(e,t))):SmartFormField.renderValue(e,t):"boolean"===e.tsDataType?e=>a.createElement(Checkbox,{title:(e||"NULL").toString(),checked:!!e,className:"no-pointer-events",readOnly:!0}):void 0});return n?n.map((t=>{if("string"!=typeof t)return t;{const n=e.find((e=>e.name===t));if(n)return l(n);console.error(`Could not find column ${t}. Incorrect name or not allowed`)}})).filter((e=>e)):e.map((e=>l(e)))};class SmartCard extends RTComp{constructor(){super(...arguments),this.state={editMode:!1,columns:void 0,variant:void 0},this.onDelta=async()=>{var e;const{tableName:t,db:n,columns:a,rowFilter:l}=this.props,o=n[t];if(!this.state.columns){let t=a;a?this.setState({columns:a}):t=await(null===(e=null==o?void 0:o.getColumns)||void 0===e?void 0:e.call(o)),this.setState({columns:t})}if(l&&JSON.stringify(l!==this._rowFilter)&&(null==o?void 0:o.find)){const e=await o.find(l,{limit:2});1!==e.length?console.error("Expected exactly one item"):this.setState({item:e[0]})}}}render(){var e;const{tableName:t,db:n,onChange:l,className:o="",style:i={},disableVariantToggle:r=!1,hideColumns:c,fieldConfigs:d,footer:m=null,enableInsert:p=!1,includeMedia:u,title:h,showViewEditBtn:g=!0,smartFormProps:f={},excludeNulls:E,tables:v,onChanged:b}=this.props,{columns:y,editMode:N,item:w}=this.state,S=null!==(e=this.props.defaultData)&&void 0!==e?e:this.state.item,T="row-wrap",C=this.state.variant||this.props.variant||T;if(!y)return a.createElement(Loading,null);let _=this.props.rowFilter;const x=y.some((e=>e.is_pkey)),A=y.filter((e=>{var t;return(x?e.is_pkey:null===(t=e.references)||void 0===t?void 0:t.length)&&S[e.name]}));!_&&A.some((e=>S[e.name]))&&(_=A.map((e=>({fieldName:e.name,value:S[e.name]}))));const R=null==n?void 0:n[t];let L=g&&Boolean((null==R?void 0:R.find)&&_),O=g&&Boolean((null==R?void 0:R.delete)&&_),I=g&&(Boolean(l)||Boolean((null==R?void 0:R.update)&&_));Boolean(null==R?void 0:R.insert);const D="row-wrap"===C?"flex-row-wrap ai-start":"row"===C?"flex-row ai-start":"flex-col ai-start ";let k;N&&(k=a.createElement(SmartForm,{db:n,asPopup:!0,tables:v,tableName:t,onChange:l,rowFilter:_,confirmUpdates:!0,hideChangesOptions:!0,enableInsert:p,includeMedia:u,onSuccess:b,...f,onClose:()=>{this.setState({editMode:!1})}}));let M=c?y.filter((e=>c.includes(e.name))):y;const F=(SmartCard.parseFieldConfigs(d)||Pa(M||this.props.columns)).filter((e=>!e.hide)).map((e=>({name:e.name,col:M.find((t=>e.name===t.name)),fc:e}))).filter((({name:e,fc:t})=>{var n;return!(null===(n=null==t?void 0:t.hideIf)||void 0===n?void 0:n.call(t,S[e],S))&&((null==t?void 0:t.render)||!E||null!==S[e])})).map((({name:e,fc:t,col:n},l)=>{var o,i,s;return a.createElement("div",{key:l,className:"flex-col p-p5 o-auto ai-start ta-left "+((null==t?void 0:t.className)||""),style:null==t?void 0:t.style},a.createElement("div",{className:"font-12 text-gray-400 noselect",title:(null==n?void 0:n.udt_name)||""},(null==t?void 0:t.label)||(null==n?void 0:n.label)),(null===(o=null==t?void 0:t.render)||void 0===o?void 0:o.call(t,S[e],S))||a.createElement("div",{className:"font-16 text-gray-800 mt-p5"},null!==(s=null===(i=null==t?void 0:t.renderValue)||void 0===i?void 0:i.call(t,S[e],S))&&void 0!==s?s:n&&SmartFormField.renderValue(n,S[e])))}));return a.createElement(a.Fragment,null,k,a.createElement("div",{className:"card bg-white relative "+D+` ${o} `+(r?"":" pointer "),style:{padding:".25em",paddingRight:"1em",...i},onClick:r?void 0:()=>{const e=this.state.variant||"row";this.setState({variant:"row"===e?"col":"col"===e?T:"row"})}},I||O||L?a.createElement(Btn_Btn,{className:"f-0 absolute show-on-parent-hover",style:{top:"0.25em",right:"0.25em"},iconPath:I||O?s.r9:s.xdR,onClick:e=>{e.preventDefault(),e.stopPropagation(),this.setState({editMode:!0})}}):null,a.createElement("div",{className:"flex-col min-w-0 min-h-0 f-1"},a.createElement("div",{className:"f-0"},h),a.createElement("div",{className:"o-auto f-1 min-w-0 min-h-0 gap-p5 "+D},F),null==m?void 0:m(S))))}}SmartCard.parseFieldConfigs=(e,t)=>{if(e){if("*"===e&&(e=["*"]),!Array.isArray(e))throw"Expecting an array of fieldConfigs";let n=[];e.slice(0).forEach((e=>{"string"==typeof e?t?n=n.concat(Pa(t,[e])):n.push({name:e}):n.push(e)}));const a=n.find(((e,t)=>n.find(((n,a)=>e.name===n.name&&t!==a))));return a&&console.log("Duplicate field config name found: "+a.name),n}};class SmartCardView extends RTComp{constructor(){super(...arguments),this.state={items:[],tableInfo:void 0,joinedInfo:{},tableColumns:void 0,insertMode:!1,detailedFilter:[]},this.loaded=!1,this.onDataChanged=()=>{this.setData()},this.setData=async(e=this.state.fieldConfigs,t=this.state.tableInfo,n=this.state.tableColumns)=>{var a,l,o;if(!e)return;const{tableName:i,db:s,dataItems:r,select:c,limit:d,disableSubscribe:m}=this.props,{detailedFilter:p=[]}=this.state,{orderByKey:u,orderAsc:h}=this.getSort(),g=Vl((null===(a=this.props.detailedFilter)||void 0===a?void 0:a.value)||p);if(!r&&(null==s?void 0:s[i])){const a=JSON.stringify(g),r=JSON.stringify({orderByKey:u,orderAsc:h});this.dataRequest={filterStr:a,orderByStr:r};let p=c;const f=async(e,n,a)=>{var l,o,i,r,c;let d=e.slice(0),m={};for await(const e of d)if("fieldConfigs"in e){if(e.name===t.media_table_name)m[e.name]={id:1,name:1,url:1,content_type:1};else if(m[e.name]=e.select,!e.select){const t=await(null===(l=s[e.name])||void 0===l?void 0:l.getColumns());m[e.name]=await f(SmartCard.parseFieldConfigs(e.fieldConfigs,t),t,e.name)}}else e.select?m[e.name]=e.select:n.find((t=>t.name===e.name&&t.select))&&(m[e.name]=1);if((null===(o=s[a])||void 0===o?void 0:o.update)||(null===(i=s[a])||void 0===i?void 0:i.insert)||(null===(r=s[a])||void 0===r?void 0:r.delete)||(null===(c=s[a])||void 0===c?void 0:c.find)){n.filter((e=>e.is_pkey)).map((e=>{e.is_pkey&&!m[e.name]&&(m[e.name]=1)}))}return m};let E={};u&&(E={orderBy:{[u]:Boolean(h)}}),Number.isFinite(d)&&d>0&&(E={...E,limit:d}),!p&&e&&(p=await f(e,n,i));const v=e=>{this.dataRequest.filterStr===a&&this.dataRequest.orderByStr===r&&this.setState({items:e})};if(!m&&s[i].subscribe)this.setState({loadingData:!0}),(null===(l=this.itemsSub)||void 0===l?void 0:l[i])&&await(null===(o=this.itemsSub)||void 0===o?void 0:o[i].unsubscribe()),this.itemsSub[i]=await s[i].subscribe(g,{select:p,...E},(e=>{v(e),this.setState({loadingData:!1})})),await Promise.all(e.map((async e=>{var t;"fieldConfigs"in e&&e.fieldConfigs&&!(null===(t=this.itemsSub)||void 0===t?void 0:t[e.name])&&(this.itemsSub[e.name]=await s[e.name].subscribe({},{limit:0},(()=>{this.setData(),this.setState({loadingData:!1})})))})));else{this.setState({loadingData:!0});const e=await s[i].find(g,{select:p,...E});this.setState({items:e,loadingData:!1})}}else r&&this.setState({items:r})},this.itemsSub={},this.onDelta=async(e,t,n)=>{const{tableName:a,db:l,dataItems:o,fieldConfigs:i,detailedFilter:s}=this.props;if(a&&l&&!l[a]&&console.error("Invalid/Dissallowed tableName given to SmartCardView -> "+a),this.loaded&&(e&&"detailedFilter"in e||e&&"fieldConfigs"in e||(null==e?void 0:e.dataItems)||(null==e?void 0:e.select)||t&&("orderByKey"in t||"orderAsc"in t||"filter"in t||"detailedFilter"in t)))this.setData();else if((null==l?void 0:l[a])&&!this.loaded){let e=this.props.tableInfo||this.state.tableInfo,t={},n=this.state.tableColumns;if(!this.loaded){this.loaded=!0,e=e||await l[a].getInfo(),n=this.props.columns||await l[a].getColumns();let o={};const s=SmartCard.parseFieldConfigs(i||["*"],n);s&&await Promise.all(s.map((async e=>{var t,n;if("fieldConfigs"in e){const a=await(null===(t=l[e.name])||void 0===t?void 0:t.getInfo()),i=await(null===(n=l[e.name])||void 0===n?void 0:n.getColumns());o={...o,[e.name]:{tableInfo:a,tableColumns:i}}}}))),this.setData(s,e,n),t={tableInfo:e,tableColumns:n,joinedInfo:o,fieldConfigs:s},this.setState(t)}}},this.renderMedia=e=>{const{file:t,i:n,onDelete:l,style:o={},onClick:i}=e,{type:r="",url:c,name:d}=t;let m=null;if(c){const e={maxWidth:"100%",maxHeight:"100%"};r.startsWith("image")?m=a.createElement("img",{loading:"lazy",src:c,style:e}):r.startsWith("video")?m=a.createElement("video",{style:e,controls:!0,src:c}):r.startsWith("audio")&&(m=a.createElement("audio",{style:e,controls:!0,src:c}))}return a.createElement("div",{key:n,className:"m-p5 relative flex-col b b-gray-300 ",style:{width:"150px",height:"150px",...o}},i?a.createElement("div",{className:"absolute w-full h-full pointer",style:{zIndex:1},onClick:e=>{e.stopPropagation(),e.preventDefault(),i()}}):null,l?a.createElement(Btn_Btn,{style:{position:"absolute",top:"10px",right:"10px",zIndex:2,backgroundColor:"white"},className:"shadow",iconPath:s.r5M,title:"Remove file",onClick:()=>{l()}}):null,a.createElement("div",{className:"f-1 min-w-0 min-h-0 flex-row ai-center"},m),d?a.createElement("div",{className:"f-0 noselect p-p5 text-gray-500 font-14 absolute w-full",style:{position:"absolute",zIndex:1,bottom:0,color:"white",background:"linear-gradient(to bottom, rgb(255 255 255 / 0%) 0%,#00000075 70%)"}},d):null)},this.getSort=()=>{const{fieldConfigs:e}=this.state,{sortableFields:t}=this.props,{orderByKey:n=(null==t?void 0:t[0]),orderAsc:a=!0}=this.state;return e?n&&!(null==e?void 0:e.find((e=>e.name===n)))?{}:{orderByKey:n,orderAsc:a}:{}}}onUnmount(){Object.values(this.itemsSub).map((e=>null==e?void 0:e.unsubscribe()))}render(){var e,t;const{tableName:n,depth:l=0,footer:o,db:i,includeMedia:r,title:c,smartFormProps:d={},variant:m="row-wrap",sortableFields:p,smartCardProps:u,filterFields:h,tables:g,w:f}=this.props,{items:E,joinedInfo:v,tableInfo:b,tableColumns:y,insertMode:N,fieldConfigs:w,loadingData:S}=this.state,T=(null===(e=this.props.detailedFilter)||void 0===e?void 0:e.value)||this.state.detailedFilter||[],{orderByKey:C,orderAsc:_}=this.getSort();if(!b||!w)return null;const x=null==y?void 0:y.find((e=>e.is_pkey&&w.find((t=>t.name===e.name&&!t.select)))),A=e=>({...e,id:e.id,url:e.url,content_type:e.content_type,name:e.original_name});if(null==b?void 0:b.is_media)return a.createElement(a.Fragment,null,undefined,a.createElement("div",{className:"flex-row f-1 o-auto min-w-0 min-h-o",style:{maxHeight:"500px"}},a.createElement(FileInput,{media:E.map(A)})));const R=((e={},t={})=>l?{...e,boxShadow:"unset",borderRadius:"unset",...t}:e)(this.props.style,{border:"unset"});let L;if(N&&(null==d?void 0:d.enableInsert)){let e;L=a.createElement(SmartForm,{asPopup:!0,db:i,tables:g,tableName:n,hideChangesOptions:!0,defaultData:e,includeMedia:r,...d,onClose:e=>{var t;e&&((null===(t=this.props)||void 0===t?void 0:t.onDataChanged)?this.props.onDataChanged():this.setData()),this.setState({insertMode:!1})}})}const O=[];w.forEach((e=>{const t=null==p?void 0:p.includes(e.name);return t&&"fieldConfigs"in e?(console.error("Cannot sort by a joined table field: "+e.name),!1):(t&&O.push({name:e.name,label:e.label}),t)})),y.map((e=>{(null==p?void 0:p.includes(e.name))&&!O.some((t=>t.name===e.name))&&O.push({name:e.name,label:e.label})}));let I=(null==d?void 0:d.enableInsert)&&(null===(t=null==i?void 0:i[n])||void 0===t?void 0:t.insert)?a.createElement(Btn_Btn,{className:"f-0 mr-2 shadow mt-p5 absolute b b-active",style:{backgroundColor:"white",right:"1em",bottom:"1em",zIndex:2},iconPath:s.qX5,onClick:()=>{this.setState({insertMode:!0})},variant:"outline",color:"action"}):null,D=O.length?a.createElement("div",{className:"ml-auto flex-row min-h-0 f-0 relative ai-center pl-p5"},a.createElement(Select_Select,{id:"orderbycomp",buttonClassName:"shadow bg-white",label:"Sort by",asRow:!0,value:C,fullOptions:O.map((e=>({key:e.name,label:e.label||e.name}))),onChange:e=>{this.setState({orderByKey:e})}}),a.createElement(Btn_Btn,{iconPath:_?s.O0z:s.q5T,onClick:()=>{this.setState({orderAsc:!_})}})):null;const k=(w||[]).filter((e=>!("fieldConfigs"in e)||e.render)),M=(w||[]).filter((e=>"fieldConfigs"in e&&!e.render));return a.createElement("div",{className:"flex-col min-h-0 f-1 relative  ",style:{}},a.createElement(SmartFilterBar,{table_name:n,db:i,onChange:e=>{this.setState({detailedFilter:e})},filter:T,tables:g,leftContent:L,rightContent:D}),I,a.createElement("div",{className:"flex-col o-auto f-1 relative p-1 pt-0 min-h-0"},S&&a.createElement(Loading,{variant:"cover",delay:1}),E.length&&l?a.createElement("div",{className:"bottom-fader"}):null,E.map(((e,t)=>a.createElement("div",{key:x&&e[x.name]||t,className:"flex-col "+(t?" mt-1 ":"")+(parent?"":" card ")+(l?" b b-gray-300 ":""),style:{}},a.createElement(SmartCard,{tables:g,db:i,tableName:n,style:R,defaultData:e,variant:m,disableVariantToggle:!0,includeMedia:r,title:c&&c(e,y),fieldConfigs:k,...u,smartFormProps:d,footer:()=>{var t;return a.createElement("div",{className:"flex-col "},M.map(((t,n)=>{var o,s,c;return a.createElement("div",{key:"j"+n,className:"flex-col mt-p5 "+(parent?"":"p-1")},a.createElement("div",{className:"mb-p25 mt-p5 p-p5 font-bold noselect"},t.label||t.name),a.createElement(SmartCardView,{db:i,tableName:t.name,style:{border:"unset",padding:0},dataItems:e[t.name],fieldConfigs:t.fieldConfigs,columns:null===(o=null==v?void 0:v[t.name])||void 0===o?void 0:o.tableColumns,depth:l+1,includeMedia:r,smartFormProps:t.smartFormProps,excludeNulls:null===(s=null==t?void 0:t.smartCardProps)||void 0===s?void 0:s.excludeNulls,smartCardProps:null==t?void 0:t.smartCardProps,onDataChanged:(null===(c=this.props)||void 0===c?void 0:c.onDataChanged)||this.onDataChanged}))})),null===(t=null==u?void 0:u.footer)||void 0===t?void 0:t.call(u,e))}}),null==o?void 0:o(e,y))))))}}class ProstglesCard extends RTComp{constructor(){super(...arguments),this.state={loading:!1,wSync:null,error:null,showError:!1},this.onDelta=async(e,t,n)=>{const a={...e,...t,...n};console.log(a);const{db:l,w:o}=this.props;if(l&&!this.state.wSync){let e=o.$cloneSync(((e,t)=>{this.d.w;this.setData({w:e},{w:t}),this.setState({w:e})}));this.setState({wSync:e})}},this.getMenu=e=>{const{db:t,table:n,tables:l,dbs:o}=this.props,{nested_tables:i}=e;let s;return i&&(s={},Object.entries(i).map((([n,o])=>{s[n]={content:a.createElement("div",{className:"flex-col p-1"},a.createElement("div",{className:"flex-col p-p5 text-gray-400 ta-left"},"Nested table (",n,")"),a.createElement(Btn_Btn,{onClick:()=>{const t={...e.nested_tables};delete t[n],e.$update({nested_tables:{...t}})}}),a.createElement(ColumnsMenu,{w:e,db:t,tableName:e.table_name,tables:l,nestedTable:n,onClose:()=>{}}))}}))),a.createElement(Tabs,{compactMode:!0,variant:"vertical",items:{Title:{content:a.createElement("div",{className:"flex-col p-1"},a.createElement(FormField,{value:e.name,onChange:t=>{e.$update({name:t})}}))},Columns:{content:a.createElement("div",{className:"flex-col p-1"},a.createElement("div",{className:"flex-col p-p5 text-gray-400 ta-left"},"Root table (",e.table_name,")"),a.createElement(ColumnsMenu,{w:e,db:t,tableName:e.table_name,tables:l,onClose:()=>{}}))}}})}}onMount(){}onUnmount(){var e,t;null===(t=null===(e=this.state.wSync)||void 0===e?void 0:e.$unsync)||void 0===t||t.call(e)}render(){const{loading:e,error:t,showError:n}=this.state,{w:l}=this.state,{db:o,table:i,tables:r,dbs:c}=this.props;if(!l)return a.createElement("div",{className:"relative"},a.createElement(Loading,{variant:"cover"}));let d,m;t&&(d=a.createElement("div",{className:"flex-row relative",style:{position:"absolute",top:"1em",left:"1em",zIndex:22}},t?a.createElement(Btn_Btn,{className:"text-red-500",iconPath:s._gM,onClick:()=>{this.setState({showError:!0})}}):null)),n&&(m=a.createElement(Popup,{open:!0,onClose:()=>{this.setState({showError:!1})}},a.createElement("div",{className:"bg-white"},a.createElement(ErrorComponent,{error:t}))));const p=(l.columns||[]).filter((e=>e.show)).map((e=>e.computedConfig?{name:e.computedConfig.column,label:e.name,select:{[e.computedConfig.funcName]:[e.computedConfig.column]},renderValue:e=>e}:e.name)),u=Object.keys(l.nested_tables||{}).map((e=>{const t=r.find((t=>t.name===e));return{name:e,tableInfo:t.info,tableColumns:t.columns,fieldConfigs:l.nested_tables[e].cols.map((e=>e.computedConfig?{name:e.computedConfig.column,label:e.name,select:{[e.computedConfig.funcName]:[e.computedConfig.column]},renderValue:e=>e}:e.name))}}));let h=a.createElement(a.Fragment,null,m,a.createElement("div",{className:"relative f-1 flex-col min-h-0 min-w-0 o-auto bg-gray-200",ref:e=>{e&&(this.ref=e)}},d,a.createElement(SmartCardView,{db:o,w:l,tableName:l.table_name,tables:r,style:{padding:"1em"},fieldConfigs:[...p,...u],sortableFields:i.columns.map((e=>e.name)),filterFields:i.columns.map((e=>e.name)),smartFormProps:{enableInsert:!0},detailedFilter:{value:l.filter||[],onChange:e=>{var t;null===(t=this.d.w)||void 0===t||t.$update({filter:e})}}})));return a.createElement(Window,{w:l,getMenu:this.getMenu},h)}}var Ha=n(20560);const Ba=36e5,Wa=864e5;function $a(e){const{leftDate:t,rightDate:n,getX:a,leftX:l,rightX:o,height:i,measureText:s,getScreenXY:r}=e;if(!t||!n)return[];let c=[];const d=((e,t,n)=>{const a=+t-+e,l=a/31536e6,o=a/2592e6,i=a/Wa,s=a/Ba,r=a/6e4,c=a/1e3;return n&&!0===n?{years:l,months:o,days:i,hours:s,minutes:r,seconds:c}:l>=1?{years:l,months:o}:o>=1?{months:o,days:i}:i>=1?{days:i,hours:s}:s>=1?{hours:s,minutes:r}:{minutes:r,seconds:c}})(+t,+n,!0),m=e=>({type:"text",font:"12px Arial",fillStyle:"black",textAlign:"center",...e}),p=[{id:"100 Year",getStart:e=>new Date(Cl(e.getFullYear(),100,3e3),0,1),dateDelta:100*sl*12,getLabel:e=>pl(e,{year:"numeric"})},{id:"10 Year",getStart:e=>new Date(Cl(e.getFullYear(),10,3e3),0,1),dateDelta:10*sl*12,getLabel:e=>pl(e,{year:"numeric"})},{id:"Yearly",getStart:e=>new Date(e.getFullYear(),0,1),dateDelta:12*sl,getLabel:e=>pl(e,{year:"numeric"})},{id:"Quarter Yearly",getStart:e=>new Date(e.getFullYear(),0,1),dateDelta:3*sl,getLabel:e=>pl(e,{month:"short"})},{id:"Monthly",getStart:e=>new Date(e.getFullYear(),e.getMonth(),1),dateDelta:sl,getLabel:e=>pl(e,{month:"short"})},{id:"Weekly",getStart:e=>new Date(e.getFullYear(),e.getMonth(),1),dateDelta:7*il,getLabel:e=>pl(e,{day:"numeric"})},{id:"Daily",dateDelta:il,getStart:e=>new Date(e.getFullYear(),e.getMonth(),e.getDate()),getLabel:e=>pl(e,{day:"numeric"})},{id:"Quarter Daily",dateDelta:il/4,getStart:e=>new Date(e.getFullYear(),e.getMonth(),e.getDate()),getLabel:e=>pl(e,{hour:"2-digit",minute:"2-digit"})},{id:"Hourly",dateDelta:ol,getStart:e=>new Date(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours()),getLabel:e=>pl(e,{hour:"2-digit",minute:"2-digit"})},{id:"Quarter Hourly",dateDelta:ol/4,getStart:e=>new Date(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours()),getLabel:e=>pl(e,{hour:"2-digit",minute:"2-digit"})},{id:"5 Minute",dateDelta:5*ll,getStart:e=>new Date(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours()),getLabel:e=>pl(e,{hour:"2-digit",minute:"2-digit"})},{id:"Minute",dateDelta:ll,getStart:e=>new Date(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours(),e.getMinutes()),getLabel:e=>pl(e,{hour:"2-digit",minute:"2-digit"})},{id:"Quarter Minute",dateDelta:ll/4,getStart:e=>((e=new Date(+e)).setSeconds(0),new Date(+e)),getLabel:e=>pl(e,{hour:"2-digit",minute:"2-digit",second:"2-digit"})},{id:"Second",dateDelta:al,getStart:e=>((e=new Date(+e)).setSeconds(0),new Date(+e)),getLabel:e=>pl(e,{hour:"2-digit",minute:"2-digit",second:"2-digit"})},{id:"250 Millisecond",dateDelta:al/4,getStart:e=>{const t=(e=new Date(+e)).getMilliseconds();return e.setMilliseconds(Cl(t,250,750)),new Date(+e)},getLabel:e=>pl(e,{hour:"2-digit",minute:"2-digit",second:"2-digit"})+"."+e.toISOString().slice(20,-1)},{id:"100 Millisecond",dateDelta:al/10,getStart:e=>{const t=(e=new Date(+e)).getMilliseconds();return e.setMilliseconds(Cl(t,100,900)),new Date(+e)},getLabel:e=>pl(e,{hour:"2-digit",minute:"2-digit",second:"2-digit"})+"."+e.toISOString().slice(20,-1)},{id:"10 Millisecond",dateDelta:al/100,getStart:e=>{const t=(e=new Date(+e)).getMilliseconds();return e.setMilliseconds(Cl(t,10,900)),new Date(+e)},getLabel:e=>pl(e,{hour:"2-digit",minute:"2-digit",second:"2-digit"})+"."+e.toISOString().slice(20,-1)},{id:"Millisecond",dateDelta:al/1e3,getStart:e=>{const t=(e=new Date(+e)).getMilliseconds();return e.setMilliseconds(Cl(t,1,999)),new Date(+e)},getLabel:e=>pl(e,{hour:"2-digit",minute:"2-digit",second:"2-digit"})+"."+e.toISOString().slice(20,-1)}],u={type:"text",font:"12px Arial",fillStyle:"black",textAlign:"center"};if(Number.isFinite(+t)&&+t==+n){const e=pl(t,{hour:"2-digit",minute:"2-digit",second:"2-digit"}),n=cl(t);return[{...u,font:"16px Arial",id:"t1",text:e,coords:[a(+t),i-28]},{...u,font:"600 14px Arial",id:"t2",text:n,coords:[a(+t),i-10]}]}let h=p.map((e=>{const n=e.getStart(new Date(+t)),l=new Date(+n+e.dateDelta),o=new Date(+l+e.dateDelta),i=s(m({text:e.getLabel(new Date(2001,1,1))})).width,c=r(a(+l),0)[0],d=r(a(+o),0)[0]-c-i;return{inc:e,spacing:d,diffFromIdeal:Math.abs(d-30)}}));if(h=h.filter((e=>e.spacing>20)),!h.length)return[];const g=h.sort(((e,t)=>e.diffFromIdeal-t.diffFromIdeal))[0].inc;let f=g.getStart(t);do{let e=+f;c.push({v:e,x:a(e),label:g.getLabel(f)}),f=new Date(+f+g.dateDelta)}while(f&&+f<+n);const E=i-20,v=i-5;let b=m({id:"lt",textAlign:"start",text:pl(t,{month:"short"}),coords:[l,E]}),y=m({id:"lb",textAlign:"start",text:pl(t,{year:"numeric"}),font:"600 14px Arial",coords:[l,v]}),N=m({id:"lt",textAlign:"end",text:pl(n,{month:"short"}),coords:[o,E]}),w=m({id:"lb",textAlign:"end",text:pl(n,{year:"numeric"}),font:"600 14px Arial",coords:[o,v]});void 0!==d.seconds&&d.seconds<10?(b.text=pl(t,{hour:"2-digit",minute:"2-digit",second:"2-digit"})+"."+t.getMilliseconds(),N.text=pl(n,{hour:"2-digit",minute:"2-digit",second:"2-digit"})+"."+n.getMilliseconds(),y.text=`${t.getDate()} ${pl(t,{month:"short"})} ${t.getFullYear()}`,w.text=`${n.getDate()} ${pl(n,{month:"short"})} ${n.getFullYear()}`):void 0!==d.days&&d.days<3&&(b.text=`${t.getDate()} ${b.text}`,N.text=`${n.getDate()} ${N.text}`);const S=Math.max(s(b).width,s(y).width)+10,T=Math.max(s(N).width,s(w).width)+10,C=Math.max(r(l,0)[0]+S),_=Math.max(r(o,0)[0]-T);return[b,y,...c.map(((e,t)=>({id:"midTicks"+t,...u,text:e.label,coords:[e.x,i-10]}))).filter((e=>{const t=r(e.coords[0],0)[0],n=s(e).width;return t-n/2>C&&t+n/2<_})),N,w]}const Ua={second:"2-digit",hour:"2-digit",minute:"2-digit"},qa=Ha.Z;class TimeChart extends RTComp{constructor(){super(...arguments),this.d={},this.getMargins=()=>{const{w:e,h:t}=this.chart.getWH();return{xMin:50,xMax:e-10,yMin:60,yMax:t-50,xForYLabels:6}},this.parseData=()=>{var e;const{w:t,h:n}=this.chart.getWH(),{layers:a,xExtent:l}=this.props;if(!a.length)return;let o=null,i=null,s=null,r=null;l&&(o=+l[0],i=+l[1]);let c=[];const{xMin:d,xMax:m,yMin:p,yMax:u,xForYLabels:h}=this.getMargins();let g=a.map(((e,t)=>{const n=e.data.map((e=>{const t=+new Date(e.date),n=+e.value;return{...e,date:t,value:n,x:0,y:0}})).sort(((e,t)=>+e.date-+t.date));return e._data=n,n.length&&n.map(((e,t)=>{l||(null!=o||(o=e.date),null!=i||(i=e.date),o=Math.min(o,e.date),i=Math.max(i,e.date)),null!=s||(s=e.value),null!=r||(r=e.value),s=Math.min(s,e.value),r=Math.max(r,e.value)})),e}));if(null===o||null===i||null===r||null===s)throw"Null vals";const f=qa().domain([o,i]).range([d,m]).clamp(!0),E=qa().domain([o,i]).range([h,m]).clamp(!0),v=qa().domain([r,s]).range([p,u]).clamp(!0);if(g=g.map((e=>{var t;return e._data=null===(t=e._data)||void 0===t?void 0:t.map((e=>{const t=f(e.date);return c.find((e=>e.v===+e.date))||c.push({x:t,v:e.date,date:new Date(e.date)}),{...e,x:t,y:v(e.value)}})),e})),null===(e=this.chart)||void 0===e?void 0:e.opts){const e=(+i-+o)/1e3,n=70;this.chart.opts.maxXScale=n/(t/e)}this.data={layers:g,dates:c,xScale:f,yScale:v,xScaleYLabels:E,minDate:o,maxDate:i,minVal:s,maxVal:r}},this.mainShapes=[],this.tooltipShapes=[],this.panning=!1}onMount(){}getIntersections(e){var t;let n,a=[];if(!this.chart)return;const[l]=this.chart.getDataXY(e,0);return null===(t=this.lineLayers)||void 0===t||t.map((t=>{t.coords.find((([o,i],s)=>{let r=!0;if(s<t.coords.length-1){const[c,d]=t.coords[s+1];if(!this.chart)return;const[m]=this.chart.getScreenXY(o),[p]=this.chart.getScreenXY(c),u=Math.abs(e-m),h=Math.abs(e-p);if(u<=2)n=o,a.push({...t,y:i,snapped_data:t.data[s]});else if(h<=2)n=c,a.push({...t,y:d,snapped_data:t.data[s+1]});else if(l>=o&&l<c||l>=c&&l<o){const e=d-i,n=(l-o)/(c-o);a.push({...t,y:i+n*e})}else r=!1}return r}))})),{layers:a,snapped_x:n}}onDelta(e,t,n){var a;const l={...e,...t,...n};if(this.ref&&!this.chart&&this.canv){const{onExtentChange:e,chartRef:t}=this.props;this.chart=new CanvasChart({node:this.ref,canvas:this.canv,yScaleLocked:!0,yPanLocked:!0,minXScale:1,events:{onExtentChange:t=>{e&&this.data&&e({leftDate:new Date(this.data.xScale.invert(t.leftX)),rightDate:new Date(this.data.xScale.invert(t.rightX))}),this.setData({extent:t})},onPan:()=>{this.panning=!0},onPanEnd:()=>{this.panning=!1}}}),t&&t(this.chart)}if(!this.chart)return;let o=!1;const{w:i,h:s}=this.chart.getWH(),{xMin:r,xMax:c,yMin:d,yMax:m}=this.getMargins();if(l&&l.layers){if(o=!0,this.mainShapes=[],this.lineLayers=[],this.parseData(),!this.data)return;const{layers:e}=this.data;e.map(((e,t)=>{var n;const{_data:a}=e;if(null==a?void 0:a.length){const t=a.filter((e=>{const[t,n]=this.chart.getScreenXY(e.x,e.y);return t>=r&&t<=c&&n>=d&&n<=m})).map(((t,n)=>({id:n,type:"circle",coords:[t.x,t.y],fillStyle:e.color,strokeStyle:e.color,lineWidth:0,r:3,data:t}))),l=t.map((e=>e.coords)),o=[{id:1,type:"multiline",strokeStyle:e.color,lineWidth:2,coords:l}];null===(n=this.lineLayers)||void 0===n||n.push({...e,coords:l});let i=0;l.map(((e,t)=>{t&&(i+=Math.hypot(e[0]-l[t-1][0],e[1]-l[t-1][1]))}));let s=i<4?t:o;this.mainShapes=this.mainShapes.concat([...s])}}))}if(n||"layers"in l){o=!0;const{xCursor:e,yCursor:t}=this.d;if(!e||this.panning||(null!=t?t:0)>m-14)this.tooltipShapes=[];else{let[n]=this.chart.getDataXY(e,null!=t?t:0);const{layers:l,snapped_x:o}=null!==(a=this.getIntersections(e))&&void 0!==a?a:{};if(!(null==l?void 0:l.length)||!this.data)return[];o&&(n=o);const i=new Date(this.data.xScale.invert(n));let r;const{leftX:c,rightX:p}=this.chart.getExtent(),u=this.data.xScale.invert(p)-this.data.xScale.invert(c);r=u<al?pl(i,Ua)+"."+i.getMilliseconds():pl(i,u<il?Ua:u<sl?{hour:"2-digit",minute:"2-digit",day:"numeric",month:"short",year:"2-digit"}:{day:"numeric",month:"short",year:"2-digit"});let h={id:"2111r",type:"text",fillStyle:"black",textAlign:"center",text:r,background:{fillStyle:"white",strokeStyle:"#cecece",lineWidth:1,padding:6,borderRadius:3},coords:[n,s-10]};const g=this.chart.measureText(h),{xMin:f,xMax:E}=this.getMargins();e-g.width/2<f+5?h.textAlign="start":e+g.width/2>E-5&&(h.textAlign="end");const v=e+14;let b,y,N=l.map((e=>{var t,n;return{id:"2111r"+Date.now(),type:"text",fillStyle:"black",text:e.getYLabel&&this.data?e.getYLabel({value:+(null!==(n=null===(t=e.snapped_data)||void 0===t?void 0:t.value)&&void 0!==n?n:this.data.yScale.invert(e.y)),min:this.data.yScale.invert(d),max:this.data.yScale.invert(m),prev:this.data.yScale.invert(e.y),next:this.data.yScale.invert(e.y)}):"",textAlign:"left",background:{fillStyle:"white",strokeStyle:e.color,lineWidth:1,padding:6,borderRadius:3},coords:[this.chart.getDataXY(v,0)[0],e.y+5]}})),w=!1;N.map((e=>{if(void 0===b&&(b=e.coords[1],y=e.coords[1]),b=Math.min(b,e.coords[1]),y=Math.max(y,e.coords[1]),!w){const t=this.chart.measureText(e);w=v+t.width>E-5}return e}));const S=b<s-y,T=N.sort(((e,t)=>S?e.coords[1]-t.coords[1]:t.coords[1]-e.coords[1]));N=[],T.map(((e,t)=>{let n=e.coords[1];if(t){const e=N[t-1].coords[1];n=S?Math.max(n,e+22):Math.min(n,e-22)}N.push({...e,coords:[e.coords[0],n],...w?{coords:[this.chart.getDataXY(v-28,0)[0],n],textAlign:"end"}:{}})})),this.tooltipShapes=[{id:"21111r",type:"multiline",lineWidth:1,strokeStyle:"#cecece",coords:[[n,0],[n,s-30]]},...l.map((e=>({id:Date.now(),type:"circle",coords:[n,e.y],fillStyle:"white",strokeStyle:"white",lineWidth:0,r:5}))),...l.map((e=>({id:Date.now(),type:"circle",coords:[n,e.y],fillStyle:e.color,strokeStyle:e.color,lineWidth:0,r:3}))),...N,h]}}if(o){if(!this.data)return;const e=()=>{if(!this.data||!this.chart)throw"No data";const{xMin:e,xMax:t,xForYLabels:n}=this.getMargins();let[a,l]=this.chart.getDataXY(e,0),[o]=this.chart.getDataXY(n,0),[i,r]=this.chart.getDataXY(t,0);const{minDate:c,maxDate:d,dates:m,xScale:p,yScale:u,xScaleYLabels:h,minVal:g,maxVal:f}=this.data;if(!m.length)return[];p(c)>a&&(a=p(c)),p(d)<i&&(i=p(d));const E=$a({leftDate:new Date(p.invert(a)),rightDate:new Date(p.invert(i)),leftX:a,rightX:i,getX:p,height:s,measureText:this.chart.measureText,getScreenXY:this.chart.getScreenXY});return[...function(e){const{min:t,max:n,steps:a}=e;let l=[],o=ja(t,n);const i=(n-t)/a,s=1/a*i;let r=ja(i-s,i+s);l=[o];for(;l[0]-r>t;)l=[l[0]-r,...l];for(;l[l.length-1]+r<n;)l=[...l,l[l.length-1]+r];return l}({min:g,max:f,steps:6}).map(((e,t)=>({id:`y${t}`,text:`${So(e,1)}`,type:"text",coords:[o,Math.round(u(e))],fillStyle:"black",background:{fillStyle:"white"},font:"14px Arial "}))),...E]};this.chart.render([...this.mainShapes,e,...this.tooltipShapes])}}render(){const{className:e="",style:t={}}=this.props,n=e=>{if(e){const t=e.currentTarget.getBoundingClientRect();this.setData({xCursor:e.clientX-t.x,yCursor:e.clientY-t.y})}else this.setData({xCursor:void 0,yCursor:void 0})};return a.createElement("div",{ref:e=>{e&&(this.ref=e)},style:t,className:"charts-comp flex-col f-1 h-fit min-h-0 min-w-0 relative bg-white noselect "+e,onPointerMove:n,onPointerUp:n,onPointerCancel:()=>{n()}},a.createElement("canvas",{ref:e=>{e&&(this.canv=e)},className:"f-1 noselect"}))}}function ja(e,t){const n=t+"";let a=t;const l=n=>{let a=Number(n.split("").concat("0").join("")),l=Number(n.split("").concat("5").join(""));const o=Number(n.split("").slice(0,-1).pop());return[a,l,Number(n.split("").slice(0,-1).concat([""+(o-1)]).join("")+"0")].find((n=>Number.isFinite(n)&&n>=e&&n<=t))};for(let e=n.length;e>=0;e--){const t=l(n.slice(0,e));void 0!==t&&(a=t)}return a}const za=[{key:"auto",label:"Auto"},{key:"year",label:"1 Year"},{key:"month",label:"1 Month"},{key:"week",label:"1 Week"},{key:"day",label:"1 Day"},{key:"8hour",label:"8 Hours"},{key:"4hour",label:"4 Hours"},{key:"2hour",label:"2 Hours"},{key:"hour",label:"1 Hour"},{key:"30minute",label:"30 Minutes"},{key:"15minute",label:"15 Minutes"},{key:"5minute",label:"5 Minutes"},{key:"minute",label:"1 Minute"},{key:"30second",label:"30 Seconds"},{key:"15second",label:"15 Seconds"},{key:"5second",label:"5 Seconds"},{key:"second",label:"1 Second"},{key:"millisecond",label:"1 Millisecond"},{key:"5millisecond",label:"5 Milliseconds"},{key:"10millisecond",label:"10 Milliseconds"},{key:"100millisecond",label:"100 Milliseconds"},{key:"250millisecond",label:"250 Milliseconds"},{key:"500millisecond",label:"500 Milliseconds"}],Ya=[{label:"Count All",func:"$countAll"},{label:"Min",func:"$min"},{label:"Max",func:"$max"},{label:"Sum",func:"$sum"},{label:"Avg",func:"$avg"}];class ProstglesTimeChart extends RTComp{constructor(){super(...arguments),this.state={resetExtent:0,xExtent:void 0,extent:void 0,loadingLayers:!1,loading:!1,wSync:null,layers:[],error:null,columns:[]},this.onDelta=async(e,t,n)=>{var a,l;const o=Object.keys({...e,...t,...n});let i={};((null===(l=null===(a=null==n?void 0:n.w)||void 0===a?void 0:a.options)||void 0===l?void 0:l.binSize)||o&&["layerQueries","joinFilter","w","statType","statColumn","resetExtent","extent","db","dataAge"].find((e=>o.includes(e))))&&this.setLayerData(o),nl(i)||this.setState(i)},this.getBin=(e,t)=>{const n=+new Date(t)-+new Date(e),a=n/31536e6,l=365*a,o=24*l,i=60*o,s=60*i,r=1e3*s,c={year:a,month:12*a,week:52*a,day:l,"8hour":o/8,"4hour":o/4,"2hour":o/2,hour:o,"30minute":i/30,"15minute":i/15,"5minute":i/5,minute:i,"30second":s/30,"15second":s/15,"5second":s/5,second:s,millisecond:r,"5millisecond":r/5,"10millisecond":r/10,"100millisecond":r/100,"250millisecond":r/250,"500millisecond":r/500},d=Object.keys(c).map((e=>({key:e,delta:c[e]-900,absDelta:Math.abs(c[e]-900)}))).filter((e=>e.delta<0)).sort(((e,t)=>e.absDelta-t.absDelta));let m="hour";return d.length&&(m=d[0].key),n<=0&&(m="millisecond"),m},this.d={lCols:{},w:void 0,extent:void 0,dataAge:0},this.setDataAge=e=>{this.dataAge=e,this.settingDataAge||(this.settingDataAge=setTimeout((()=>{this.setData({dataAge:this.dataAge}),this.settingDataAge=null}),300))},this.setLayerData=async(e=[])=>{var t;const{db:n,layerQueries:a=[]}=this.props,{extent:l}=this.state,{w:o}=this.d;if(!o||!n)return;if(!(null===(t=o.options)||void 0===t?void 0:t.statType))return void o.$update({options:{statType:"Count All"}},{deepMerge:!0});const{statType:i}=o.options;let s,r,c={};try{this.setState({loadingLayers:!0});const e=(await Promise.all(a.map((async e=>{var t,a,o,r,c,d,p,u;let h=[],g=[];if("table"===e.type){const{dateColumn:s,tableName:c,externalFilters:d,statColumn:m,tableFilter:p}=e;let u,f={$countAll:[]};if(m&&i&&"Count All"!==i){const e=Ya.find((e=>e.label===i));e&&(f={[e.func]:[m]})}const E=36e5;if(l){const{leftDate:e,rightDate:t}=l;u={$and:[{[s]:{$gte:new Date(+e-E)}},{[s]:{$lte:new Date(+t+E)}}]}}const v=n[c];if(!(null==v?void 0:v.findOne)||!(null==v?void 0:v.find))throw`Cannot query table ${c}: Missing or disallowed`;const b=JSON.stringify(d);let y={$and:[...d,p].filter(Co)};!v.subscribe||this.dataSub&&this.dataSubFilter===b||(this.dataSubFilter=b,this.dataSub&&await this.dataSub.unsubscribe(),this.dataSub=await v.subscribe(y||{},{select:"",throttle:500},(()=>{this.setDataAge(Date.now())})));const N={$and:[y,u].filter((e=>e))},{min:w,max:S}=await v.findOne(N,{select:{min:{$min:[s]},max:{$max:[s]}}}).catch(console.error),T=null===(o=null===(a=null===(t=this.d)||void 0===t?void 0:t.w)||void 0===a?void 0:a.options)||void 0===o?void 0:o.binSize,C=T?1e3:void 0,_={value:f,date:{["$date_trunc_"+(T||(l?this.getBin(l.leftDate,l.rightDate):this.getBin(w,S)))]:[s]}},x=await v.findOne(y,{select:_,orderBy:{date:1}}).catch(console.error),A=await v.findOne(y,{select:_,orderBy:{date:-1}}).catch(console.error);if(h=await v.find(N,{select:_,orderBy:{date:1},limit:null!=C?C:905}),h.length){const e=h[0],t=h[h.length-1];x&&e.date!==x[s]&&(x.value=e.value,h.unshift(x)),A&&t.date!==A[s]&&(A.value=t.value,h.push(A))}h.map((e=>({...e,value:+e.value})));const R=null===(r=this.props.tables.find((e=>e.name===c)))||void 0===r?void 0:r.columns;if(!R)throw`Columns not found for table ${c}`;g=R}else if("sql"===e.type){const{dateColumn:t,sql:a,statColumn:l}=e;if(!n.sql)return void console.error("Not enough privileges to run query");let o="",r=null===(p=null===(d=null===(c=this.d)||void 0===c?void 0:c.w)||void 0===d?void 0:d.options)||void 0===p?void 0:p.binSize,f=a.trim()+"";f.endsWith(";")&&(f=f.slice(0,f.length-1));let E=(0,m.asName)(t);if(!r){const e=`SELECT MIN(${E}) as min, MAX(${E}) as max FROM (\n`+f+"\n ) t",a=await n.sql(e,{dateColumn:t},{returnType:"rows"});a.length||console.warn("No min max");const{min:l,max:o}=null!==(u=a[0])&&void 0!==u?u:{};s=[new Date(l),new Date(o)],r=this.getBin(new Date(l),new Date(o))}let v="COUNT(*)";if(l&&i&&"Count All"!==i){const e=Ya.find((e=>e.label===i));e&&(v=`${e.label}(${(0,m.asName)(l)})`)}r=(r||"day").replace(/[0-9]/g,"");g=(await n.sql(" SELECT * FROM (\n"+f+"\n ) t LIMIT 0 ")).fields.map((e=>({...e,key:e.name,label:e.name,subLabel:e.dataType,udt_name:e.dataType})));const b=`SELECT date_trunc(\${bin}, ${E}) as "date", ${v} as "value" \nFROM (\n`+f+"\n ) t \n"+o+"\nGROUP BY date_trunc(${bin}, "+E+" ) \n ORDER BY date ";h=await n.sql(b,{dateColumn:t,bin:r,statField:v},{returnType:"rows"})}return{color:e.color||"red",getYLabel:({value:e,min:t,max:n})=>t===n?`${e}`:`${e.toFixed(Math.max(2,2-Math.round(Math.log10(Math.abs(n-t)))))}`,data:h,cols:g}})))).filter(Co);c={layers:e}}catch(e){r=e,console.error(e)}this.setState({...c,xExtent:s,loadingLayers:!1,error:r})},this.getMenu=e=>{var t;const{statType:n,binSize:l="auto"}=null!==(t=e.options)&&void 0!==t?t:{},{layers:o=[]}=this.state,{layerQueries:i=[]}=this.props;return a.createElement("div",{className:"flex-col w-full f-1 p-1"},i.map(((e,t)=>{let i=(o&&o[t]?o[t].cols:[]).map((e=>({...e,label:e.name})));const{groupByColumn:s}=e;let r;i=i.filter((t=>t.label!==e.dateColumn&&"number"===t.tsDataType)),i&&i.length&&"Count All"!==n&&(r=a.createElement(Select_Select,{label:"Numeric field",variant:"div",className:"w-fit mb-1  mt-1",options:i.map((e=>e.label)),value:e.statColumn,onChange:t=>{console.log(t),e.updateOptions({statColumn:t})}}));let c,d=i.filter((t=>t.name!==e.statColumn&&t.name!==e.dateColumn&&["string","boolean","number"].includes(t.tsDataType)));return d.length&&(c=a.createElement(Select_Select,{label:"Group by field",variant:"div",className:"w-fit mb-1  mt-1",options:d.map((e=>e.label)),value:s,onChange:t=>{console.log(c),console.log("This should update the link"),e.updateOptions({groupByColumn:t})}})),a.createElement("div",{key:t,className:"flex-col gap-1"},a.createElement(ColorPicker,{value:e.color,onChange:t=>e.updateOptions({color:t})}),a.createElement(Select_Select,{label:"Bin size",variant:"div",className:"w-fit ",fullOptions:za,value:l,onChange:e=>{var t;null===(t=this.d.w)||void 0===t||t.$update({options:{binSize:e}},{deepMerge:!0})}}),a.createElement(Select_Select,{label:"Aggregation type",variant:"div",className:"w-fit",fullOptions:Ya.map((e=>({key:e.label,disabledInfo:i.length||"$countAll"===e.func?void 0:"Requires a numeric column"}))),value:n,onChange:e=>{var t;let n={options:{statType:e}};null===(t=this.d.w)||void 0===t||t.$update(n,{deepMerge:!0})}}),r,c)})))},this.chartRef={}}async onMount(){const{db:e,dbs:t,w:n}=this.props;if(e&&!this.state.wSync){const e=await n.$cloneSync(((e,t)=>{this.setData({w:e},{w:t})}));this.setState({wSync:e})}}onUnmount(){var e,t;null===(t=null===(e=this.state.wSync)||void 0===e?void 0:e.$unsync)||void 0===t||t.call(e)}setExt(e){this.ext=e,this.settingExtent&&clearTimeout(this.settingExtent),this.settingExtent=setTimeout((()=>{this.setState({extent:this.ext}),this.settingExtent=null}),500)}render(){const{layers:e=[],loadingLayers:t,error:n,xExtent:l,extent:o}=this.state,{w:i}=this.d;if(!i)return a.createElement(Loading,{className:"m-auto f-1"});let r,c;n&&(r=a.createElement(M,{button:a.createElement(Btn_Btn,{className:"text-red-500",iconPath:s._gM}),open:!0,onClose:()=>{this.setState({showError:!1})}},a.createElement("div",{className:"bg-white"},a.createElement(ErrorComponent,{error:n})))),(t||n)&&(c=a.createElement("div",{className:"flex-row relative f-1 m-auto ",style:{position:"absolute",top:"1em",left:"1em",zIndex:22}},t?a.createElement(Loading,{className:"m-auto f-1",delay:100}):null,r));const d=Boolean(o&&l&&Object.values(o).join()!==l.join()),m=a.createElement(a.Fragment,null,a.createElement("div",{ref:e=>{e&&(this.menuAnchor=e)},style:{width:"1px",height:"1px"}}),a.createElement("div",{className:"relative f-1 flex-col min-h-0 min-w-0 noselect "},c,d?a.createElement(Btn_Btn,{title:"Zoom out to data extent",style:{position:"absolute",right:0,top:0,zIndex:1},iconPath:s.uQd,onClick:()=>{this.chartRef&&(this.chartRef.setView({xO:0,xScale:1,yO:0,yScale:1}),this.setState({extent:void 0}))}}):null,a.createElement(TimeChart,{layers:e,chartRef:e=>{this.chartRef=e},onExtentChange:e=>{this.setExt(e)}})));return a.createElement(Window,{w:i,getMenu:this.getMenu},m)}}const Va=(e,t)=>{let n=null;for(let a in e){(null===n||e[a]<e[n])&&!t.includes(a)&&(n=a)}return n};class SilverGridResizer extends RTComp{onDelta(){const{onChange:e}=this.props,t=this.ref;t&&!(null==t?void 0:t._hasListeners)&&(t._hasListeners=!0,Nl(this.ref,{onPanEnd:()=>{const{prev:t,next:n}=this.sizes;e(t,n),this.sizes=void 0},onPanStart:()=>{},onRelease:()=>{this.ref.style.background="transparent"},onPress:()=>{this.ref.style.background="#00e1cc",Qa(15)},onPan:e=>{if(!this.ref)throw"ref missing";const{type:t}=this.props,{nextElementSibling:n,previousElementSibling:a,parentElement:l}=this.ref,o=n,i=a,s=i.getBoundingClientRect(),r=o.getBoundingClientRect(),c=s.x,d=(r.x,r.width,s.y);r.y,r.height;let m,p;const u=this.ref.getBoundingClientRect().width/2,h=this.ref.getBoundingClientRect().height/2,g=+getComputedStyle(i).flexGrow+ +getComputedStyle(o).flexGrow;if("row"===t){const t=(s.width+r.width)/g;m=(e.x-c-u)/t,p=g-m}else{const t=(s.height+r.height)/g;m=(e.y-d-h)/t,p=g-m}i.style.flex=`${m}`,o.style.flex=`${p}`,this.sizes={prev:{id:i.dataset.boxId,size:m},next:{id:o.dataset.boxId,size:p}}}}))}render(){const e=Ga()?"20px":"4px",{type:t}=this.props,n={width:"col"===t?"100%":e,height:"col"===t?e:"100%",cursor:"col"===t?"ns-resize":"ew-resize",opacity:.4,zIndex:2,margin:Ga()?"col"!==t?"0 -8px":"-8px 0":""};return a.createElement("div",{ref:e=>{e&&(this.ref=e)},style:n,className:"silver-grid-resizer noselect "})}}class TreeBuilder{constructor(e,t){this.onChange=e=>{},this.makeTree=(e,t)=>{let n=e;return t?(delete n.isRoot,n.parent=t):n.isRoot=!0,e.items&&e.items.map((e=>{this.makeTree(e,n)})),n},this.remove=(e,t=!1)=>{this._filter((t=>t.id===e&&t.parent)).map((e=>{e.parent.items=e.parent.items.filter((t=>t!==e))})),t||this.onChange(this.getLayout())},this.getLayout=()=>{const e=t=>(delete t.parent,t.items&&(t.items=t.items.map(e)),t);let t=e({...this.tree});return this.build(JSON.parse(JSON.stringify(t))),JSON.parse(JSON.stringify(t))},this._filter=e=>{const t=n=>{let a=[];return e(n)&&a.push(n),n.items&&n.items.map((e=>{a=a.concat(t(e))})),a};return t(this.tree)},this.refresh=(e=!1)=>{this.build(this.getLayout());let t=this._filter((e=>"item"===e.type));t.concat(t.map((e=>e.parent))).filter(Co).map((e=>{let t={...e};for(;t.parent&&!t.parent.isRoot&&t.parent.items&&1===t.parent.items.length;)t=t.parent;t.parent&&(t.parent.items=t.parent.items.map((n=>n===t?e:n)))}));const n=this.getLayout();this.build(n);const a=()=>this._filter((e=>Boolean(e.parent&&e.parent.type===e.type)));for(;a().length;)a().map((e=>{if(e.parent&&e.parent.type===e.type){const t=e.parent.items.findIndex((t=>t===e));e.parent.items.splice(t,1,...e.items)}this.build(this.getLayout())}));const l=()=>this._filter((e=>"item"!==e.type&&e.parent&&e.items&&0===e.items.length));for(;l().length;){l().map((e=>{e.parent.items=e.parent.items.filter((t=>t.id!=e.id))}));const e=this.getLayout();this.build(e)}e||this.onChange(this.getLayout())},this.update=e=>{e.map((e=>{let t=this._filter((t=>t.id==e.id)),n=t[0];1===t.length?Object.keys(e).map((t=>{n[t]=e[t]})):console.log("Found duplicate items. will not update")})),this.onChange(this.getLayout())},this.find=e=>this._filter((t=>t.id==e))[0],this.getLeafs=(e=(()=>!0))=>this._filter((e=>!("items"in e)||!e.items.length&&e.parent)).filter(e),this.findFunc=e=>this._filter(e)[0],this.moveTo=(e,t,n,a)=>{let l=this.find(e);this.build(this.getLayout()),this.remove(e,!0);let o=this.find(t);if(l&&o)if(o.parent){const e=o.parent.items.findIndex((e=>e.id==t));o.parent.type===n?(o.parent.items.splice(a?e:e+1,0,l),o.parent.items=o.parent.items.map((e=>(e.size=100/Math.max(1,o.parent.items.length),e)))):(l.size=50,o.size=50,o.parent.items[e]={id:Date.now(),type:n,size:Math.min(...o.parent.items.map((e=>e.size)))||50,items:a?[l,o]:[o,l]},o={id:Date.now(),size:o.size||50,type:n,items:a?[l,o]:[o,l]})}else o.type===n&&o.items?(l.size=o&&o.items&&o.items.length?o.items[0].size:50,a?o.items.unshift(l):o.items.push(l)):(l.size=50,o.size=50,o.isRoot=!1,o={id:Date.now(),size:100,isRoot:!0,type:n,items:a?[l,o]:[o,l]},this.layout=o,this.tree=this.makeTree(o));this.refresh()},this.build(e),this.onChange=t}build(e){let t=JSON.parse(JSON.stringify({...e}));this.layout=t,this.tree=this.makeTree(t)}}class SilverGridReact extends RTComp{constructor(){super(...arguments),this.state={layout:void 0,targetStyle:{display:"none"}},this.onDelta=e=>{const{layout:t,children:n=[],defaultLayoutType:a="col"}=this.props;if(e&&("layout"in e||"children"in e)){if(t&&(this.treeLayout=new TreeBuilder({...t},this.onChange)),(!t||t.items&&0===t.items.length)&&n.length)return setTimeout((()=>{this.onChange({id:1,type:a,size:100,items:n.map(((e,t)=>({id:e.props["data-key"]||t,title:e.props["data-title"],type:"item",size:20})))})}),0),null;const e=this.getItems(t).map((e=>e.id)),l=n.filter((t=>!e.includes(t.props["data-key"]))),o=Array.from(new Set(e.filter((e=>!n.find((t=>t.props["data-key"]==e))))));if(t&&"items"in t&&this.treeLayout){const e=this.treeLayout.getLeafs((e=>"items"in e&&!e.items.length));if(e.length)return void e.map((e=>{var t;let n=e;for(;n;){let e=n.parent;null===(t=this.treeLayout)||void 0===t||t.remove(n.id),n=e&&"items"in e&&!e.items.length&&!e.isRoot?e:void 0}}))}if(t&&l.length&&setTimeout((()=>{let e={...t};if(e.type===a){const t=e.items.reduce(((e,t)=>e+t.size),0);e.items=[...l.map(((e,n)=>({id:e.props["data-key"]||n,title:e.props["data-title"],type:"item",size:t/l.length}))),...e.items]}else e.size=50,e={id:1,type:a,size:100,isRoot:!0,items:l.map(((e,t)=>({id:e.props["data-key"]||t,title:e.props["data-title"],type:"item",size:50/l.length}))).concat(e)};this.onChange(e)}),0),t&&n.length&&o.length&&this.treeLayout)return void o.map((e=>{var t;null===(t=this.treeLayout)||void 0===t||t.remove(e)}))}},this.setTarget=e=>{this.setState({targetStyle:e})},this.getRoot=()=>{if(!this.ref)throw"Unexpected";return this.ref},this.onChange=(e,t=!1)=>{const{onChange:n}=this.props;n&&!t?(n({...e}),this.setState({layout:void 0})):this.setState({layout:e})},this.getItems=(e=this.state.layout)=>{let t=[];if(e){if("item"===e.type)return[e];t=t.concat(...e.items.map(this.getItems))}else;return t},this.renderGrid=(e=this.props.layout,t=0)=>{const{children:n,header:l,headerIcons:o=[],onClose:i,_ref:s,hideButtons:r}=this.props,{minimized:c}=this.state,d=a.Children.toArray(n);let m=null;if(!e||!d.length)return null;const p=e=>d.find((t=>t.props["data-key"]==e));if("item"===e.type){const n=p(e.id),s=d.find((t=>t.props["data-key"]==e.id&&"header-icons"===t.props["data-type"]))||o.find((t=>t.props["data-key"]==e.id));return a.createElement(SilverGridChild,{key:t,title:n?n.props["data-title"]:"",hideButtons:null!=r?r:{},layout:e,header:l,headerIcon:s,setTarget:this.setTarget,getRoot:this.getRoot,onClose:i,moveTo:(e,t,n,a)=>{var l;null===(l=this.treeLayout)||void 0===l||l.moveTo(e,t,n,a)},onChange:e=>{this.onChange(e)},hasSiblings:d.some((t=>t.props["data-key"]!=(null==e?void 0:e.id)))},n)}if(m=[],"tab"===e.type){let n=e;n.items[0]||(m=null);const s=n.items;if(!s||!s.length)return null;const u=s[0].id,h=p(u),g=o.find((e=>e.props["data-key"]==u));h||(m=null);const f=n.items.filter((e=>e.id!=u)).map((e=>{var t;return{...e,title:null===(t=p(e.id))||void 0===t?void 0:t.props["data-title"]}}));m=a.createElement(SilverGridChild,{key:t,title:h?h.props["data-title"]:"",headerIcon:g,siblingTabs:f,onClickSibling:t=>{var n;null===(n=this.treeLayout)||void 0===n||n.moveTo(t,e.id,"tab",!0)},hasSiblings:d.some((t=>t.props["data-key"]!=e.id)),layout:e.items[0],header:l,setTarget:this.setTarget,getRoot:this.getRoot,onClose:i,moveTo:(e,t,n,a)=>{var l;null===(l=this.treeLayout)||void 0===l||l.moveTo(e,t,n,a)},onChange:e=>{this.onChange(e)},minimize:{value:!!c,toggle:()=>{this.setState({minimized:!c})}},hideButtons:null!=r?r:{}},h)}else{let t=e.items.map(((e,t)=>this.renderGrid(e,t)));t.map(((n,l)=>{m.push(n),l<t.length-1&&m.push(a.createElement(SilverGridResizer,{key:"resizer"+l,type:e.type,onChange:(e,t)=>{var n;null===(n=this.treeLayout)||void 0===n||n.update([e,t])}}))}))}const u=c&&"tab"===e.type;return a.createElement("div",{ref:e=>{e&&(this.ref=e,s&&s(e))},key:t,"data-box-type":e.type,"data-box-id":e.id,className:" flex-"+e.type+" silver-grid-box min-w-0 min-h-0",style:{flex:e.size,display:"flex",...u&&{height:"48px",flex:"none",flexShrink:1}}},m)}}render(){const{targetStyle:e}=this.state,{style:t={},className:n="",overlay:l}=this.props;return a.createElement("div",{ref:e=>{e&&(this.ref=e)},className:"silver-grid-component relative  "+n,style:{display:"flex",flex:1,height:"100%",width:"100%",...t}},this.renderGrid(),a.createElement("div",{key:"silver-grid-target",ref:e=>{e&&(this.refTarget=e)},className:" absolute silver-grid-target b",style:{...e,zIndex:232,transition:".2s all ease-in-out",background:"#dcffffb3"}}),l)}}function Ga(){return"ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0}class ViewRenderer extends RTComp{constructor(){super(...arguments),this.state={},this.getTableChain=(e,t)=>{const n=this.getLinkChain(e,t);if(n){const{windows:e}=this.props;let t=n.map((t=>{var n;return null===(n=e.find((e=>e.id===t)))||void 0===n?void 0:n.table_name}));if(t.every(m.isDefined))return t}},this.getWindowPermissions=async e=>{var t,n,a;return(null!==(a=await(null===(n=(t=this.props.dbs.windows).getColumns)||void 0===n?void 0:n.call(t,"en",{rule:"update",filter:{id:e},data:{}})))&&void 0!==a?a:[]).reduce(((e,t)=>({...e,[t.name]:wo(t,["select","filter","orderBy"])})),{})}}getLinkChain(e,t){const{links:n}=this.d,a=((e,t,n)=>{let a={};a[n]="Infinity",a=Object.assign(a,e[t]);let l={endNode:null};for(let n in e[t])l[n]=t;let o=[],i=Va(a,o);for(;i;){let n=a[i],s=e[i];for(let e in s)if(String(e)!==String(t)){let t=n+s[e];(!a[e]||a[e]>t)&&(a[e]=t,l[e]=i)}o.push(i),i=Va(a,o)}let s=[n],r=l[n];for(;r;)s.push(r),r=l[r];return s.reverse(),{distance:a[n],path:s}})((e=>{let t={};return e.map((([e,n])=>{t[e]=t[e]||{},t[e][n]=1,t[n]=t[n]||{},t[n][e]=1})),t})(n.map((e=>[e.w1_id,e.w2_id]))),e,t);return a.distance<1/0?a.path:void 0}getOpenedLinksAndWindows(){const e=this.props.windows.filter((e=>!e.deleted&&!e.closed));return{links:this.props.links.filter((t=>[t.w1_id,t.w2_id].every((t=>e.some((e=>e.id===t)))))),windows:e}}render(){const{workspace:e,db:t,dbs:n,tables:l,suggestions:o,dbsTables:i,isReadonly:s,searchParams:r,setSearchParams:c,user:d,auth:p}=this.props,{links:u,windows:h}=this.getOpenedLinksAndWindows(),{linkMenuWindow:g}=this.state;if(!e||!l)return;const f=async(t,a=[])=>{const{type:l,table_name:o,options:i={},name:s}=t,r=await n.windows.insert({name:s,type:l,table_name:o,options:i,filter:a,layout:Ka("111"),fullscreen:!1,workspace_id:e.id},{returning:"*"});return setTimeout((()=>{document.querySelector(`[data-box-id="${r.id}"]`)||(console.log("SYNC FAIL BUG, REFRESHING"),location.reload())}),1e3),r},E=a=>{var l,o,i,s,r,c,d,m;const{links:p,windows:u}=this.getOpenedLinksAndWindows(),{w1_id:h,w2_id:g,linkOpts:f}=a,{geomColumn:E,dateColumn:v,fromSelected:b,tablePath:y,sql:N}=f,w=p.filter((e=>u.find((t=>[e.w1_id,e.w2_id].includes(t.id))))),S=(C=[...Object.keys(Xa).sort((()=>.5-Math.random())),...w.map((e=>vo(e,"options.colorKey"))).filter((e=>e))],C.reduce(((e,t)=>({...e,[t]:(e[t]||0)+1})),{})),T=Object.keys(S).pop();var C;const _=p.filter((e=>[e.w1_id,e.w2_id].find((e=>[h,g].includes(e))))),x=_.find((e=>vo(e,"options.color")));let A;x&&(A={color:null===(l=null==x?void 0:x.options)||void 0===l?void 0:l.color,colorKey:null===(o=null==x?void 0:x.options)||void 0===o?void 0:o.colorKey});let R={colorKey:null!==(i=null==A?void 0:A.colorKey)&&void 0!==i?i:T,color:null!==(c=null!==(s=null==A?void 0:A.color)&&void 0!==s?s:null===(r=Xa[T])||void 0===r?void 0:r.get())&&void 0!==c?c:"black",tablePath:y,sql:N};if(E&&(R={...R,geomColumn:E}),v&&(R={...R,dateColumn:v,fromSelected:b}),!e||!t)throw"no workspace or db";return null===(m=(d=n.links).insert)||void 0===m?void 0:m.call(d,{w1_id:h,w2_id:g,workspace_id:e.id,options:R},{returning:"*"})},v=async(e,t,n)=>{const a=await this.props.loadTable({type:"table",table:t,fullscreen:!1});await E({w1_id:e.id,w2_id:a,linkOpts:{tablePath:n}}),e.fullscreen&&e.$update({fullscreen:!1})},b=n.windows.insert?async(e,t)=>{const{type:n,name:a,linkOpts:l}=e;let o={};"map"===n&&(o={options:{tileAttribution:{title:"© OpenStreetMap",url:"https://www.openstreetmap.org/"}}});const i=await f({name:a,type:n,...o});E({w1_id:t.id,w2_id:i.id,linkOpts:l})}:void 0,y=async(e,t,n)=>{var a,o,i,s;if(!e||!t||this.state.active_row&&(null===(a=this.state.active_row)||void 0===a?void 0:a.window_id)!==n)return void(this.state.active_row&&this.setState({active_row:void 0}));let r={};const c=null!==(i=null===(o=l.find((e=>e.name===t)))||void 0===o?void 0:o.columns)&&void 0!==i?i:[],d=c.filter((e=>e.is_pkey));d.length&&d.every((t=>t.name in e))?d.map((t=>{r[t.name]=e[t.name]})):"$rowhash"in e?r.$rowhash=e.$rowhash:c.map((t=>{("number"===t.tsDataType||"string"===t.tsDataType||t.is_pkey)&&(r[t.name]=e[t.name])}));const m=u.filter((e=>[e.w1_id,e.w2_id].includes(n)&&h.filter((e=>e.id!==n)).find((t=>[e.w1_id,e.w2_id].includes(t.id)))));let p=e&&m.length?{window_id:n,table_name:t,row_filter:r}:void 0;e&&p&&!nl(this.state.active_row)&&(null===(s=this.state.active_row)||void 0===s?void 0:s.window_id)===p.window_id&&kn(this.state.active_row.row_filter,p.row_filter)&&(p=void 0),this.state.active_row!==p&&this.setState({active_row:p})},w=h.map(((g,E)=>{const w=async()=>{var e,t,a;(null==(g=g.$get())?void 0:g.$get)||console.error(this.d.windows),this.setState({active_row:void 0}),"sql"===g.type&&(null===(e=g.options)||void 0===e?void 0:e.sqlWasSaved)?await g.$update({closed:!0}):(null===(t=g.sql)||void 0===t?void 0:t.trim().length)&&"sql"===g.type&&!(null===(a=g.options)||void 0===a?void 0:a.sqlWasSaved)?N.some((e=>e.sql.trim()===g.sql.trim()))?await g.$update({closed:!0,deleted:!0}):this.props.onCloseUnsavedSQL(g):(await g.$update({closed:!0,deleted:!0}),await n.links.update({$or:[{w1_id:g.id},{w2_id:g.id}]},{closed:!0,deleted:!0}))},S={key:g.id+g.fullscreen,"data-key":g.id,"data-title":Window.getTitle(g),w:g,db:t,dbs:n,tables:l,onClose:w,onFilter:()=>{u.find((e=>h.find((t=>!t.closed&&t.id!==g.id&&[e.w1_id,e.w2_id].sort().join()===[g.id,t.id].sort().join()))))&&setTimeout((()=>this.forceUpdate()),1)},user:d,auth:p,searchParams:r,setSearchParams:c,isReadonly:!!s},T=s?void 0:e=>this.setState({linkMenuWindow:e});let C=null,_=null;if("sql"===g.type)C=a.createElement(ProstglesSQL,{dbsTables:i,titleIcon:_,suggestions:o,onAddChart:b?e=>b(e,g):void 0,setLinkMenu:T,...S});else if("card"===g.type)C=a.createElement(ProstglesCard,{table:l.find((e=>e.name===g.table_name)),titleIcon:_,...S,w:g});else{const{links:t,windows:n}=this.getOpenedLinksAndWindows(),l=t.filter((e=>[e.w1_id,e.w2_id].includes(g.id)));let o;const i=l.find((e=>vo(e,"options.color")));if(i){const e=Xa[i.options.colorKey];e&&(o=e)}if("map"===g.type){let e=[];t&&(e=l.map((e=>{var a;const l=n.find((t=>(el(t,"table")||el(t,"sql"))&&t.id!==g.id&&[e.w1_id,e.w2_id].includes(t.id)));if(!("geomColumn"in e.options)||!e.options.geomColumn)throw"geomColumn missing from link";if(null==l?void 0:l.table_name){const o=Ma(l,this.state.active_row,t,n,g),i=null!==(a=Xa[e.options.colorKey])&&void 0!==a?a:Xa.c5;return{wid:l.id,type:"table",tableName:l.table_name,geomColumn:e.options.geomColumn,externalFilters:o.all,tableFilter:Vl(l.filter||[]),...e.options,joinFilter:o.activeRowFilter,fillColor:i.get(1,"deck"),lineColor:i.get(1,"deck"),color:i.get(1,"css"),sourceW:l}}if("sql"===(null==l?void 0:l.type)){const t=Xa.c5,n={wid:l.id,type:"sql",geomColumn:e.options.geomColumn,...e.options,sql:e.options.sql,fillColor:t.get(1,"deck"),lineColor:t.get(1,"deck"),color:t.get(1,"css"),sourceW:l};if(!n.sql)return;return n}console.error("Why tbl is missing?")})).filter(m.isDefined));const{active_row:o}=this.state;C=a.createElement(ProstglesMap,{activeRow:o,titleIcon:_,layerQueries:e,onClickRow:(e,t)=>y(e,t,g.id),...S})}else if("timechart"===g.type){let e=[];t&&(e=l.map((e=>{const a=e,l=n.find((e=>("table"===e.type||"sql"===e.type)&&e.id!==g.id&&[a.w1_id,a.w2_id].includes(e.id))),o=Xa[a.options.colorKey]||Xa.c1,i={groupByColumn:void 0,...a.options,dateColumn:a.options.dateColumn,updateOptions:e=>a.$update({options:{...a.options,...e}})};if("table"===l.type){const e=Ma(l,this.state.active_row,t,n,g);return{type:"table",sql:a.options.fromSelected?l.selected_sql:l.sql,tableName:l.table_name,...i,tableFilter:Vl(l.filter||[]),externalFilters:e.all,color:o.get(1,"css")}}if("sql"===l.type){return{type:"sql",sql:a.options.fromSelected?l.selected_sql:l.sql,...i,color:o.get(1,"css")}}console.log("Why tbl is missing?")})).filter(m.isDefined)),C=a.createElement(ProstglesTimeChart,{layerQueries:e,...S,w:g})}else if("table"===g.type){const l=this.state.active_row;let i=Ma(g,l,t,n);C=a.createElement(ProstglesTable,{workspace:e,setLinkMenu:T,activeRowColor:o?o.get(.1):void 0,activeRow:(null==l?void 0:l.window_id)===g.id?l:void 0,onAddChart:b?e=>b(e,g):void 0,onAddTable:(e,t)=>f({...e,type:"table"},t),onLinkTable:this.props.isReadonly?void 0:async(e,t)=>{v(g,e,t)},joinFilter:i.activeRowFilter,externalFilters:i.all,onClickRow:e=>y(e,g.table_name,g.id),...S,w:g})}}return{id:g.id,title:g.name||g.table_name||g.id,linkIcon:_,onClose:s?void 0:w,q:g,elem:C}})).filter(m.isDefined);return a.createElement("div",{className:"min-h-0 f-1 flex-row relative",ref:e=>{e&&(this.gridWrapperRef=e)}},g&&this.gridWrapperRef&&a.createElement(LinkMenu,{w:g.w,tables:l,links:u,windows:h,anchorEl:g.anchorEl,db:t,dbs:n,onClose:()=>this.setState({linkMenuWindow:void 0}),gridRef:this.gridWrapperRef,onLinkTable:(e,t)=>v(g.w,e,t)}),a.createElement(SilverGridReact,{_ref:e=>{e&&(this.gridRef=e)},defaultLayoutType:e.options.defaultLayoutType,className:"min-h-0 relative",layout:e.layout,onChange:t=>{JSON.stringify(t)!==JSON.stringify(e.layout)&&e.$update({layout:t})},hideButtons:s?{minimize:!0,close:!0,pan:!0}:void 0,onClose:async e=>{var t;const n=w.find((t=>t.id===e));return n&&await(null===(t=n.onClose)||void 0===t?void 0:t.call(n)),1}},w.map((e=>e.elem))))}}const Ja=e=>{const t=Cn(),[n,l]=(0,i.lr)();return a.createElement(ViewRenderer,{...e,localSettings:t,searchParams:n,setSearchParams:l})};const Xa={c1:{get:(e=1,t="css")=>{const n=[0,129,167,"css"===t?e:Math.round(255*e)];return"deck"===t?n:`rgba(${n.join(", ")})`}},c2:{get:(e=1,t="css")=>{const n=[240,113,103,"css"===t?e:Math.round(255*e)];return"deck"===t?n:`rgba(${n.join(", ")})`}},c3:{get:(e=1,t="css")=>{const n=[58,134,255,"css"===t?e:Math.round(255*e)];return"deck"===t?n:`rgba(${n.join(", ")})`}},c4:{get:(e=1,t="css")=>{const n=[131,56,236,"css"===t?e:Math.round(255*e)];return"deck"===t?n:`rgba(${n.join(", ")})`}},c5:{get:(e=1,t="css")=>{const n=[203,149,0,"css"===t?e:Math.round(255*e)];return"deck"===t?n:`rgba(${n.join(", ")})`}}};function Ka(e){return{i:e,x:1,y:0,w:4,h:2}}const Qa=(e=15)=>{try{navigator.vibrate(e)}catch(e){console.error(e)}},Za=e=>"table"===(null==e?void 0:e.type),el=(e,t)=>e.type===t;class _Dashboard extends RTComp{constructor(){super(...arguments),this.state={loading:!0,minimised:!1,imported:0},this.d={closedWindows:[],allWindows:[],windows:[],links:[],linksSync:null},this.loadSchema=async()=>{var e;const{db:t,connectionId:n,dbKey:a,dbSchemaTables:l}=this.props,o=this.d.workspace;if(o&&(null===(e=this.loadingSchema)||void 0===e?void 0:e.dbKey)!==a&&n){this.loadingSchema={dbKey:a,settingSuggestions:[],connectionId:n,suggestions:[]};const e={tables:await _Dashboard.getTables(l,o,t),loading:!1,suggestions:void 0};try{if(null==t?void 0:t.sql){const{sql:l}=t,o=await Fe({sql:l}),i={...o,connectionId:n,dbKey:a,searchAll:null==o?void 0:o.suggestions.filter((e=>["table","function"].includes(e.type)))};this.loadingSchema={...i},e.suggestions={...i}}}catch(e){this.loadingSchema=void 0,console.error("Issue with getSuggestions:",e)}this.setState(e)}},this.loadingTables=!1,this.syncsSet=!1,this.onDelta=async(e,t,n)=>{var a,l,o,i,s,r,c,d;const m={...e,...t,...n},{db:p,dbs:u,workspaceId:h,connectionId:g,dbSchemaTables:f}=this.props,{workspace:E}=this.d,{tables:v}=this.state;let b={};const y=u.workspaces;if(p&&(null==y?void 0:y.syncOne)&&!this.syncsSet&&g){this.syncsSet=!0;const e={connection_id:g,deleted:!1};if(!+await y.count(e)){const e={connection_id:g,name:+await y.count({connection_id:g,name:"default",deleted:!0})?`default ${Date.now()}`:"default",options:{hideCounts:!0}};await y.insert(e,{returning:"*"}),window.location.reload()}let t;try{t=await y.findOne(h?{id:h,...e}:e)}catch(e){return void this.setState({wspError:e})}if(!t)return void this.setState({wspError:!0});const n=(null!==(o=await(null===(l=(a=this.props.dbs.workspaces).getColumns)||void 0===l?void 0:l.call(a,"en",{rule:"update",filter:{id:t.id},data:{name:""}}).catch(console.error)))&&void 0!==o?o:[]).every((e=>!e.update));this.setState({isReadonly:n});const{connection:d}=this.props;window.document.title=`Prostgles UI - ${d.name||d.db_host}`;const m=await y.syncOne({id:t.id,deleted:!1},{handlesOnData:!0},((e,t)=>{this.mounted&&this.setData({workspace:e},{workspace:t})})),p=await(null===(s=(i=u.links).sync)||void 0===s?void 0:s.call(i,{workspace_id:t.id},{handlesOnData:!0},((e,t)=>{this.mounted&&this.setData({links:e},{links:t})}))),f=await(null===(c=(r=u.windows).sync)||void 0===c?void 0:c.call(r,{workspace_id:t.id},{handlesOnData:!0,select:"*",patchText:!1},((e,t)=>{const n=e;if(!this.mounted)return;let a=n.sort(((e,t)=>+e.last_updated-+t.last_updated));const l=a.filter((e=>e.closed&&!e.table_name&&e.name)),o=a.filter((e=>!e.closed));if(this.d.windows){const e=e=>`${e.id} ${e.type} ${e.fullscreen} ${JSON.stringify(e.filter||{})} `;if(this.d.windows.map(e).sort().join()===o.map(e).sort().join())return}this.setData({allWindows:a,windows:o,closedWindows:l},{windows:t})})));this.setData({windowsSync:f,workspaceSync:m,linksSync:p},{windowsSync:f,workspaceSync:m,linksSync:p})}this.checkIfNoOpenWindows();const N=m.workspace&&"hideCounts"in m.workspace,w=this.props.dbKey!==(null===(d=this.loadingSchema)||void 0===d?void 0:d.dbKey),S=!!m.imported;p&&E&&(w||N||S)&&this.loadSchema(),n&&(["windows","workspace","links"].map((e=>{n[e]&&(b[e]={...n[e]})})),nl(b)&&n.windowsSync&&(b={reRender:Date.now()})),nl(b)||this.setState(b)},this.loadTable=async e=>{const{db:t,dbs:n}=this.props,{workspace:a}=this.d,{type:l,table:o=null,filter:i=[],sql:s="",name:r}=e;let c,d={hideTable:!0};if(o&&t){const e=t[o];if(!(null==e?void 0:e.getInfo)){const e=t[o]?"Not allowed to view data from this table":"Table not found";throw alert(e),e}if("getInfo"in e){c=(await e.getInfo()).oid}d={maxCellChars:500}}return(await n.windows.insert({sql:s,filter:i,options:d,type:l,table_name:o,table_oid:c,name:r,layout:Ka("111"),fullscreen:!1,workspace_id:null==a?void 0:a.id},{returning:"*"})).id},this.checkedIfNoOpenWindows=!1,this.checkIfNoOpenWindows=async()=>{const{workspaceId:e,dbs:t}=this.props;if(e&&t){this.checkedIfNoOpenWindows=!0;if(!await t.windows.findOne({workspace_id:e,closed:!1})){const e=document.querySelector('[data-command="menu"]');null==e||e.click()}}}}onUnmount(){const{workspaceSync:e,windowsSync:t,linksSync:n}=this.d;[e,t,n].map((e=>{e&&e.unsync&&e.unsync()}))}getNamePopupWindow(){const e=this.state.namePopupWindow,t=e?this.d.windows.find((t=>t.id===e.id)):null;if(t){const e=()=>this.setState({namePopupWindow:void 0});return{title:"Save query?",onClose:e,content:a.createElement("div",{className:"flex-col"},a.createElement(FormField,{type:"text",asColumn:!0,label:"Name",defaultValue:t.name,required:!0,onChange:e=>{t.$update({name:e,options:{...t.options||{},sqlWasSaved:!0}})}}),a.createElement("div",{className:"flex-row-wrap w-full mt-2 gap-1"},a.createElement(Btn_Btn,{className:"mr-2",variant:"outline",color:"danger",iconPath:s.x9U,onClick:async()=>{t.$update({closed:!0,deleted:!0}),e()}},"Delete"),a.createElement(Btn_Btn,{variant:"outline",color:"action",iconPath:s.Tls,onClick:()=>{t.name?t.$update({closed:!0,deleted:!1,options:{...t.options||{},sqlWasSaved:!0}}):alert("Cannot have an empty name"),setTimeout((()=>{e()}),500)}},"Save")))}}}render(){var e;const{db:t,dbs:n,topRightControls:l,connectionId:o,dbsTables:i,dbsMethods:s,localSettings:r,user:c,connection:d,auth:m}=this.props,{tables:p,loading:u,isReadonly:h,suggestions:g,wspError:f}=this.state,{centeredLayout:E}=r;if(f)return a.createElement("div",{className:"flex-col p-1 text-white"},"Workspace not found ",a.createElement("a",{className:"text-white",href:`/connections/${this.props.connectionId}`},"Go back"));const{windowsSync:v,workspace:b}=this.d;if(!v||!b)return a.createElement(Loading,{className:"mt-4 mx-auto"});let y;if(!p)return a.createElement("div",{className:"absolute flex-row",style:{inset:0}},a.createElement(Loading,{message:"Loading schema",className:"text-white m-auto"}));o&&(y=a.createElement(Ja,{isReadonly:h,db:t,dbs:n,dbsTables:i,workspace:b,loadTable:this.loadTable,links:this.d.links,windows:this.d.windows,tables:p,onCloseUnsavedSQL:e=>{this.setState({namePopupWindow:e})},suggestions:g,user:c,auth:m}));let N=this.getNamePopupWindow();const w=b.options.pinnedMenu&&!window.isLowWidthScreen,S=a.createElement(Xn,{db:t,dbs:n,searchAll:null!==(e=null==g?void 0:g.searchAll)&&void 0!==e?e:[],loadTable:this.loadTable,tables:p,workspace:b,dbsMethods:s,connection:d,user:c}),T=w?S:null,C=T?a.createElement(Jn,{disabledInfo:"Pinned below",pinnedProps:{user:c,connection:d}}):S,_=(null==E?void 0:E.enabled)?{flex:T?.5:0,minWidth:T?"200px":0,width:`calc((100% - ${E.maxWidth}px)/2)`,overflow:"hidden",display:"flex"}:void 0,x=(null==E?void 0:E.enabled)?E.maxWidth+"px":void 0,A=x?{flex:1e3,minWidth:0,width:x,maxWidth:x,margin:"0 auto"}:void 0;return a.createElement("div",{className:"flex-col f-1 min-w-0 min-h-0 w-full ",style:{maxWidth:"100vw",opacity:o?1:0,transition:"opacity .5s",...E&&{"--centered-width":E.maxWidth}}},a.createElement("div",{className:"f-0 flex-row  min-h-0 min-w-0 o-hidden  "+(window.isMobileDevice?" p-p25 ":" p-p5 ")},a.createElement(a.Fragment,null,C,a.createElement(WorkspaceMenu,{dbs:n,workspace:b,dbsTables:i})),l),N&&a.createElement(Popup,{open:!0,onClose:N.onClose,title:N.title,anchorEl:N.anchorEl,clickCatchStyle:N.clickCatchStyle},N.content),a.createElement("div",{className:"min-h-0 f-1 flex-row relative",style:{gap:"1px"}},a.createElement("div",{style:_},T),a.createElement("div",{style:A,className:"f-1 flex-row"},y),a.createElement("div",{style:{..._,...!!T&&{minWidth:0}}})),u?a.createElement(Loading,{className:"p-2"}):null)}}_Dashboard.getTables=(e,t,n)=>Promise.all(e.map((async a=>{var l,o,i,s,r;return{...a,count:t&&!(null===(l=null==t?void 0:t.options)||void 0===l?void 0:l.hideCounts)&&(null===(o=null==n?void 0:n[a.name])||void 0===o?void 0:o.count)&&null!==(r=await(null===(s=null===(i=n[a.name])||void 0===i?void 0:i.count)||void 0===s?void 0:s.call(i)))&&void 0!==r?r:"",joins:zl(e,a.name,n)}}))).catch((e=>{throw console.error(e),e}));const tl=e=>{const t=Cn();return a.createElement(_Dashboard,{...e,localSettings:t})};function nl(e){for(const t in e)return!1;return!0}const al=1e3,ll=60*al,ol=60*ll,il=24*ol,sl=30*il,rl=e=>e.toString().padStart(2,"0"),cl=e=>`${e.getFullYear()}-${rl(e.getMonth())}-${rl(e.getDate())}`;function dl(e,t,n){var a;let l=window.devicePixelRatio;const o=Math.max(30,t),i=Math.max(30,n);return e.width=o*l,e.height=i*l,e.style.width=o+"px",e.style.height=i+"px",l>1&&(null===(a=e.getContext("2d"))||void 0===a||a.scale(l,l)),e}const ml={},pl=(e=new Date,t)=>{const n=JSON.stringify({d:Math.round(+e),opts:t});return ml[n]||(ml[n]=e.toLocaleString(navigator.language,t)),ml[n]};class CanvasChart{static clampScale(e){return Math.min(122e5,Math.max(1e-6,e))}constructor(e){this.currViewStateValid=!1,this.shapes=[],this.view={xScale:1,yScale:1,xO:0,yO:0},this.getDataXY=(e,t)=>{const{view:{xScale:n,yScale:a,xO:l,yO:o}}=this;return[(e-l)/n,(t-o)/a]},this.getScreenXY=(e,t)=>{const{view:{xScale:n,yScale:a,xO:l,yO:o}}=this;let i;return void 0!==t&&(i=t*a+o),[e*n+l,i]},this.getExtent=()=>{const{w:e,h:t}=this.getWH(),[n,a]=this.getDataXY(0,0),[l,o]=this.getDataXY(e,t);return{leftX:n,topY:a,rightX:l,bottomY:o,...this.view}},this.measureText=e=>{var t;const{ctx:n}=this;if(!n)throw"No ctx";n.fillStyle=e.fillStyle,n.textAlign=null!==(t=e.textAlign)&&void 0!==t?t:n.textAlign,n.font=e.font;let a=n.measureText(e.text),l=a.fontBoundingBoxAscent+a.fontBoundingBoxDescent,o=a.actualBoundingBoxAscent+a.actualBoundingBoxDescent;return{width:a.width,fontHeight:l,actualHeight:o}},this.rawShapes=[],this.opts=e;const{node:t,canvas:n,events:a}=e;this.init();new ResizeObserver((e=>{if(this.ctx){const{offsetHeight:e,offsetWidth:a}=t;dl(n,a,e),this.render()}})).observe(t);let l=null;Nl(t,{onPanStart:(e,t)=>{l={...this.view},a&&a.onPanStart&&a.onPanStart(e,t)},onPan:(e,t)=>{l&&(this.setView({...this.view,xO:l.xO+e.xDiff,yO:l.yO+e.yDiff}),n.style.cursor="move",a&&a.onPan&&a.onPan(e,t))},onPanEnd:(e,t)=>{n.style.cursor="default",a&&a.onPanEnd&&a.onPanEnd(e,t)},onDoubleTap:({x:e,y:t})=>{const n=this.view.xScale*Math.sign(1)*2,a=this.view.yScale*Math.sign(1)*2,l=CanvasChart.clampScale(this.view.xScale+n),o=CanvasChart.clampScale(this.view.yScale+a),i=l/this.view.xScale,s=o/this.view.yScale,r=e-i*(e-this.view.xO),c=t-s*(t-this.view.yO);this.setView({...this.view,xScale:l,yScale:o,xO:r,yO:c})},onSinglePinch:({delta:e,x:t,y:n,w:a,h:l})=>{const o=this.view.xScale*Math.sign(e)*.1,i=this.view.yScale*Math.sign(e)*.1,s=CanvasChart.clampScale(this.view.xScale+o),r=CanvasChart.clampScale(this.view.yScale+i),c=s/this.view.xScale,d=r/this.view.yScale,m=t-c*(t-this.view.xO),p=n-d*(n-this.view.yO);this.setView({...this.view,xScale:s,yScale:r,xO:m,yO:p})}})}setView(e){var t;if(!this.opts)throw"No opts";const{yScaleLocked:n=!1,yPanLocked:a=!1,minXScale:l,maxXScale:o,events:i}=this.opts,s={...this.view};this.view={...this.view,...e},n&&(this.view.yScale=1),a&&(this.view.yO=s.yO),("number"==typeof l&&this.view.xScale<l||"number"==typeof o&&this.view.xScale>o)&&(this.view.xO=s.xO,this.view.xScale=s.xScale),null===(t=null==i?void 0:i.onExtentChange)||void 0===t||t.call(i,{...this.getExtent()}),JSON.stringify(this.view)!==JSON.stringify(s)&&this.render(this.rawShapes)}init(){if(!this.opts)return;const{node:e,canvas:t}=this.opts,{w:n,h:a}=this.getWH();this.ctx=t.getContext("2d"),this.ctx.canvas.width=n,this.ctx.canvas.height=a,dl(t,e.offsetWidth,e.offsetHeight),this.ctx.imageSmoothingEnabled=!0,e.onwheel=t=>{t.preventDefault(),t.preventDefault();let{xScale:n,yScale:a,xO:l,yO:o}=this.view;const i=e.getBoundingClientRect(),s=t.pageX-i.left,r=t.pageY-i.top,c=function(e){var t=0,n=0,a=0,l=0;"detail"in e&&(n=e.detail);"wheelDelta"in e&&(n=-e.wheelDelta/120);"wheelDeltaY"in e&&(n=-e.wheelDeltaY/120);"wheelDeltaX"in e&&(t=-e.wheelDeltaX/120);"axis"in e&&e.axis===e.HORIZONTAL_AXIS&&(t=n,n=0);a=10*t,l=10*n,"deltaY"in e&&(l=e.deltaY);"deltaX"in e&&(a=e.deltaX);(a||l)&&e.deltaMode&&(1==e.deltaMode?(a*=40,l*=40):(a*=Tl,l*=Tl));a&&!t&&(t=a<1?-1:1);l&&!n&&(n=l<1?-1:1);return{spinX:t,spinY:n,pixelX:a,pixelY:l}}(t),d=c.pixelY,m=c.pixelX,p=(u=d,.004*Math.abs(u));var u;let h=a*Math.exp(-Math.sign(d)*p),g=n*Math.exp(-Math.sign(d)*p);g=CanvasChart.clampScale(g),h=CanvasChart.clampScale(h);l=-m+s-g/n*(s-l),o=r-h/a*(r-o),this.setView({xO:l,yO:o,yScale:h,xScale:g})}}getWH(){const{canvas:e}=this.opts;return{w:e.offsetWidth,h:e.offsetHeight}}parseData(e){let t=[];const n=this.getExtent();return e.map((e=>{"function"==typeof e?t=t.concat(e(n)):t.push(e)})),t}render(e){let t=[];e?(this.rawShapes=[...e],t=this.parseData(e),this.shapes=t):this.shapes&&(t=[...this.shapes]);const{w:n,h:a}=this.getWH(),{ctx:l}=this;l&&(l.clearRect(0,0,n,a),t.map((e=>{var t,n;const a=e=>{if(Array.isArray(e[0]))return e.map((e=>a(e)));const t=e,[n,l]=this.getScreenXY(t[0],t[1]);return[n,l]},o=a(e.coords);var i;if(o)if(l.lineJoin="bevel","rectangle"===e.type)l.fillStyle=e.fillStyle,l.lineWidth=e.lineWidth,l.strokeStyle=e.strokeStyle,e.borderRadius?Sl(l,o[0],o[1],e.w,e.h,e.borderRadius):(l.beginPath(),l.rect(o[0],o[1],e.w,e.h)),l.fill(),l.stroke();else if("circle"===e.type)l.fillStyle=e.fillStyle,l.lineWidth=e.lineWidth,l.strokeStyle=e.strokeStyle,l.beginPath(),l.arc(o[0],o[1],e.r,0,2*Math.PI),l.fill(),l.stroke();else if("multiline"===e.type)l.lineWidth=e.lineWidth,l.strokeStyle=e.strokeStyle,o.map((([e,t],n)=>{n?l.lineTo(e,t):(l.beginPath(),l.moveTo(e,t))})),l.stroke();else if("polygon"===e.type)l.fillStyle=e.fillStyle,l.lineWidth=e.lineWidth,l.strokeStyle=e.strokeStyle,l.beginPath(),o.map((([e,t],n)=>{n?l.lineTo(e,t):(l.beginPath(),l.moveTo(e,t))})),l.closePath(),l.stroke(),l.fill();else{if("text"!==e.type)throw"Unexpected shape type: "+e.type;{const{textAlign:a="start"}=e;if(e.background){const s=this.measureText(e),r=e.background.padding||6;l.fillStyle=null!==(t=e.background.fillStyle)&&void 0!==t?t:l.fillStyle,e.background.strokeStyle&&(l.strokeStyle=e.background.strokeStyle),l.lineWidth=null!==(n=e.background.lineWidth)&&void 0!==n?n:l.lineWidth;let c=o[0]-s.width/2-r,d=o[1]-((i=e.text)&&i.toLowerCase(),1*s.actualHeight)-r;["left","start"].includes(a)?c=o[0]-r:["right","end"].includes(a)&&(c=o[0]-s.width-r),Sl(l,c,d,s.width+2*r,s.actualHeight+2*r,e.background.borderRadius||0),l.closePath(),e.background.strokeStyle&&l.stroke(),l.fill()}l.fillStyle=e.fillStyle,l.textAlign=a,l.font=e.font,l.fillText(e.text,o[0],o[1])}}})))}}class Chart extends RTComp{constructor(){super(...arguments),this.d={xCursor:null,yCursor:null},this.panning=!1}onMount(){const{setRef:e,onExtentChange:t}=this.props;this.ref&&this.canv&&(this.chart=new CanvasChart({node:this.ref,canvas:this.canv,yScaleLocked:!0,yPanLocked:!0,minXScale:1,events:{onExtentChange:e=>{null==t||t(e),this.setData({extent:e})},onPan:()=>{this.panning=!0},onPanEnd:()=>{this.panning=!1}}}),e(this.chart))}render(){const{className:e="",style:t={}}=this.props;return a.createElement("div",{ref:e=>{e&&(this.ref=e)},style:t,className:"charts-comp flex-col f-1 min-h-0 min-w-0 relative "+e,onMouseMove:e=>{const t=e.currentTarget.getBoundingClientRect();this.setData({xCursor:e.clientX-t.x,yCursor:e.clientY-t.y})},onMouseOut:()=>{this.setData({xCursor:null,yCursor:null})}},a.createElement("canvas",{ref:e=>{e&&(this.canv=e)},className:"f-1"}))}}let ul,hl,gl,fl,El=!1,vl=[],bl=null,yl=null;function Nl(e,t){const n=t=>{var n,a;if(hl=vl.find((e=>e.node.contains(t.target))),!hl)return;if(fl={ev:t,started:Date.now()},t.button&&"touch"!==t.pointerType)return;null===(a=(n=hl.events).onPress)||void 0===a||a.call(n,t),t.preventDefault(),t.stopPropagation();const l=e.getBoundingClientRect(),{clientX:o,clientY:i}=t,[s,r]=[o,i],[c,d]=[l.x,l.y],m=o-c,p=i-d,u=o-l.left,h=i-l.top,[g,f]=[0,0],[E,v]=[0,0];bl={node:e,x:o,y:i,xStart:s,yStart:r,xNode:m,yNode:p,xNodeStart:u,yNodeStart:h,xDiff:g,yDiff:f,xOffset:c,yOffset:d,xTravel:E,yTravel:v,triggered:!1}},a=t=>{var n;if(!hl)return;const{onSinglePinch:a,onDoubleTap:l,onRelease:o,onPanEnd:i}=hl.events;if(a||l)if(l&&gl&&gl.duration<200&&Date.now()-gl.ended<400){const n=e.getBoundingClientRect();l({x:t.clientX-n.x,y:t.clientY-n.y}),gl=void 0}else gl={duration:Date.now()-(null!==(n=null==fl?void 0:fl.started)&&void 0!==n?n:0),ended:Date.now()};null==o||o(t),bl&&bl.triggered&&yl&&(t.preventDefault(),null==i||i({...yl},t),hl=void 0,ul=void 0),bl=null},l=t=>{if(!hl||!fl)return;const{onSinglePinch:n,onPinch:a,onPanStart:l,onPan:o,threshold:i=15}=hl.events;if(n&&ul&&gl&&bl&&((null==fl?void 0:fl.onSinglePinch)||gl.duration<200&&Date.now()-gl.ended<400)){fl.onSinglePinch=!0,t.preventDefault(),t.stopPropagation();const a=e.getBoundingClientRect(),l=Math.hypot(t.clientX-ul.clientX,t.clientY-ul.clientY);n({x:fl.ev.clientX-a.x,y:fl.ev.clientY-a.y,w:a.width,h:a.height,totalDelta:Math.hypot(t.clientX-fl.ev.clientX,t.clientY-fl.ev.clientY),delta:(t.clientY<ul.clientY?1:-1)*l,goingUp:t.clientY<ul.clientY}),Qa(15)}else if(bl){t.preventDefault(),t.stopPropagation();const{xOffset:e,yOffset:n,xStart:a,yStart:s,xDiff:r,yDiff:c,xTravel:d,yTravel:m}=bl,{clientX:p,clientY:u}=t;yl={...bl,x:p,y:u,xNode:p-e,yNode:u-n,xDiff:p-a,yDiff:u-s},yl.xTravel=d+Math.abs(yl.xDiff),yl.yTravel=m+Math.abs(yl.yDiff),!bl.triggered&&(yl.xTravel>=i||yl.yTravel>i)?(bl.triggered=!0,null==l||l({...yl},t)):bl.triggered&&(null==o||o({...yl},t))}ul=t};e.style.touchAction="none",El||(El=!0,window.document.body.style.touchAction="none",window.document.documentElement.style.overscrollBehavior="none",wl(window.document.body,"pointerup",a),wl(window.document.body,"pointermove",l));let o=wl(e,"pointerdown",n);return vl.push({node:e,events:t,handlers:{_onPress:n,_onRelease:a,onMove:l}}),function(){o(),vl=vl.filter((n=>n.events.onPan!==t.onPan&&n.node!==e))}}function wl(e,t,n){const a=function(l){e.isConnected?n(l):e.removeEventListener(t,a)};return e.removeEventListener(t,a),e.addEventListener(t,a,{passive:!1}),function(){e.removeEventListener(t,a)}}function Sl(e,t,n,a,l,o){if(void 0===o&&(o=5),"number"==typeof o)o={tl:o,tr:o,br:o,bl:o};else{var i={tl:0,tr:0,br:0,bl:0};for(var s in i)o[s]=o[s]||i[s]}e.beginPath(),e.moveTo(t+o.tl,n),e.lineTo(t+a-o.tr,n),e.quadraticCurveTo(t+a,n,t+a,n+o.tr),e.lineTo(t+a,n+l-o.br),e.quadraticCurveTo(t+a,n+l,t+a-o.br,n+l),e.lineTo(t+o.bl,n+l),e.quadraticCurveTo(t,n+l,t,n+l-o.bl),e.lineTo(t,n+o.tl),e.quadraticCurveTo(t,n,t+o.tl,n),e.closePath()}var Tl=800;function Cl(e,t,n){return Math.min(n,Math.ceil(e/t)*t)}let _l;var xl;be._m.config({paths:{vs:"/vs"}});const Al="sql",Rl=["table","view","mview","column","function","dataType","extension","keyword","schema","setting","role","database","folder","file","snippet","policy","publication","subscription","index","operator","constraint"],Ll={column:"A set of data values of a particular type. Is part of a table or a view",constraint:"A way to limit the kind of data that can be stored in a table",table:"A table is a collection of related data held in a table format within a database",view:"A view is similar to a table but it can also show data from multiple tables",database:"A place to store all data",dataType:"A set of possible values and a set of allowed operations on it",extension:"A script that creates new SQL objects such as functions, data types, operators and index support methods",file:"",folder:"",function:"A set of SQL and procedural commands such as declarations, assignments, loops, flow-of-control etc. stored on the database server and can be involved using the SQL interface. ",index:"An index is a pointer to data in a table. A common way to enhance database performance.",keyword:"SQL command",mview:"Materialized view. Similar to views with the exception that the underlying data is saved",operator:"Used in comparing values",policy:"A row-level security policy for a table",publication:"A publication is a set of changes generated from a table or a group of tables, and might also be described as a change set or replication set. Each publication exists in only one database. Publications are different from schemas and do not affect how the table is accessed.",role:"PostgreSQL manages database access permissions using the concept of roles. A role can be thought of as either a database user, or a group of database users, depending on how the role is set up. Roles can own database objects (for example, tables) and can assign privileges on those objects to other roles to control who has access to which objects. Furthermore, it is possible to grant membership in a role to another role, thus allowing the member role use of privileges assigned to the role it is a member of.",schema:"A database contains one or more named schemas, which in turn contain tables. Schemas also contain other kinds of named objects, including data types, functions, and operators. ",setting:"Server configuration parameters. Can be specified for SYSTEM, DATABASE or ROLE",snippet:"A prostgles snippet",subscription:"A subscription represents a replication connection to the publisher. Hence, in addition to adding definitions in the local catalogs, this command normally creates a replication slot on the publisher."},Ol=(Rl.reduce(((e,t)=>({...e,[t]:"mview"===t?"materialized view":t})),{}),e=>({storageService:{get(){},remove(e,t){},getBoolean:t=>"expandSuggestionDocs"===t&&!1!==(null==e?void 0:e.expandSuggestionDocs),store(){},onWillSaveState(){},onDidChangeStorage(){}}})),Il="myCustomTheme";null===(xl=null===be._m||void 0===be._m?void 0:be._m.init)||void 0===xl||xl.call(be._m).then((e=>{e.editor.defineTheme(Il,{base:"vs",inherit:!0,colors:{},rules:[{token:`string.${Al}`,foreground:"#ce0000"},{token:"identifier",foreground:"#6c06ab"},{token:"complexIdentifiers",foreground:"#6c06ab"}]})})).catch((e=>console.error("An error occurred during initialization of Monaco: ",e)));const Dl=e=>e.getModel().getValueInRange(e.getSelection());class SQLEditor extends RTComp{constructor(e){var t;super(e),this.getMonaco=async()=>{var e;return null!==(e=this._monaco)&&void 0!==e||(this._monaco=await be._m.init()),this._monaco},this.scrollToLineIfNeeded=e=>{if(!this.editor)return;const[t]=this.editor.getVisibleRanges();!t||t.startLineNumber-1<=e&&t.endLineNumber+1>=e||this.editor.revealLineInCenterIfOutsideViewport(e)},this.loadedActions=!1,this.loadedFuncs=!1,this.onDelta=async()=>{var e,t,n;const{error:a,getFuncDef:l,value:o,sql:i,autoFocus:s=!1,sqlOptions:r}={...this.props},c=await this.getMonaco();o&&!this.curVal&&(this.curVal=o,this.setState({value:o})),!this.resizeObserver&&this.rootRef&&(this.resizeObserver=new ResizeObserver((e=>{var t,n,a;null===(t=this.editor)||void 0===t||t.revealLineInCenterIfOutsideViewport(null!==(a=null===(n=this.editor.getPosition())||void 0===n?void 0:n.lineNumber)&&void 0!==a?a:o.split("/n").length)})),this.resizeObserver.observe(this.rootRef)),this.editor&&!this.loadedActions&&(this.loadedActions=!0,this.editor.addAction({id:"googleSearch",label:"Search with Google",contextMenuGroupId:"navigation",run:e=>{window.open("https://www.google.com/search?q="+Dl(e))}}),this.editor.addAction({id:"googleSearchPG",label:"Search with Google Postgres",contextMenuGroupId:"navigation",run:e=>{window.open("https://www.google.com/search?q=postgres+"+Dl(e))}}));const{suggestions:d}=this.props;if(d&&(null===(e=this.loadedSuggestions)||void 0===e?void 0:e.dbKey)!==(null==d?void 0:d.dbKey)&&this.editor&&(this.loadedSuggestions={...d},function(e){const{monaco:t,suggestions:n,settingSuggestions:a,sql:l}=e,o=n;null==$t||$t.dispose(),$t=t.languages.registerHoverProvider(Al,{provideHover:async function(e,n){const a=e.getWordAtPosition(n);if(a&&o&&o.length){const e=o.find((e=>"keyword"===e.type&&e.name===a.word.toUpperCase()));return e?{range:new t.Range(n.lineNumber,a.startColumn,n.lineNumber,a.endColumn),contents:[{value:`**${e.detail}**`},{value:e.documentation||e.type}]}:{contents:[]}}}}),null==Ut||Ut.dispose(),Ut=t.languages.registerCompletionItemProvider(Al,{triggerCharacters:["."," ","/","?","\\",...window.isMobileDevice?[" ",","]:[]],provideCompletionItems:async(e,n,i,s)=>{var r,c,d,m,p,u;const h=t.languages.CompletionItemKind,g=e=>"function"===e?h.Function:"column"===e?h.Field:"table"===e||"view"===e||"mview"===e?h.Value:"dataType"===e?h.Variable:"keyword"===e?h.Keyword:"extension"===e?h.Module:"schema"===e?h.Folder:"setting"===e?h.Property:"folder"===e?h.Folder:"file"===e?h.File:"snippet"===e?h.Snippet:"database"===e?h.Struct:h.Keyword;function f(e){return e.map(((e,n)=>{let a={...e,range:void 0,kind:g(e.type),insertText:(e.insertText||e.name)+("function"!==e.type?" ":""),detail:e.detail||`(${e.type})`,type:e.type,escapedParentName:e.escapedParentName,documentation:{value:e.documentation||`${e.type} ${e.detail||""}`},sortText:"",insertTextRules:t.languages.CompletionItemInsertTextRule.InsertAsSnippet};const l=(e=>{if("ENUM"===e.toUpperCase())return"Enumerated (enum) types are data types that comprise a static, ordered set of values\n```sql\n\nCREATE TYPE mood AS ENUM ('sad', 'ok', 'happy');\n\n```\n"})(e.name);return l&&(a.documentation={value:l}),a}))}let E=f(o),v=f(a);function b(t){if(t&&t.column>=1&&t.lineNumber>=1){const n=e.getWordUntilPosition({...t,column:t.column-1});return n&&!n.word&&n.endColumn>-1&&n.startColumn>-1?b({...t,column:t.column-1}):n}}let y,N,w,S=e.getWordUntilPosition(n),T=!1,C=b({...S,...n});if(C&&(N=b({...S,...n,column:C.startColumn}),N&&(w=b({...S,...n,column:N.startColumn}))),S&&S.word){y=S.word;let e=null==y?void 0:y[0];T=e===e.toUpperCase()&&e!==e.toLowerCase()}const _=e.getOffsetAt(n),x=e.getValue(),A=(x.split("\n"),x.slice(0,_-(y||"").length).split("\n")),R=A.slice(-28).join("\n"),L=((A.slice(-2,-1)[0]||"").toLowerCase().trim(),A.slice(-1)[0]," "+R+" "),O=x.slice(_).split("\n").slice(0,8).join("\n");let I,D="any";const k=qt(L);O.replaceAll(")"," ").replaceAll("("," ");const M=" "+k.toLowerCase();let F=((t=Number.MAX_SAFE_INTEGER,n=3)=>we.map((t=>{let n=M.lastIndexOf(" "+t.toLowerCase()+" ");n>1&&n--;const a=e.getPositionAt(n),{lineNumber:l}=a;return{value:t,idx:n,line:e.getLineContent(l),lineNumber:l}})).filter((e=>e.idx>-1&&e.idx<=t)).sort(((e,t)=>t.idx-e.idx)).slice(0,n))(_);null===(r=F[0])||void 0===r||r.value,null===(c=F[1])||void 0===c||c.value,null===(d=F[0])||void 0===d||d.idx,null===(m=null==w?void 0:w.word)||void 0===m||m.trim().toLowerCase(),null===(p=null==N?void 0:N.word)||void 0===p||p.trim().toLowerCase(),null===(u=null==C?void 0:C.word)||void 0===u||u.trim().toLowerCase(),F[0],F[1],F[2];const P=!L.trim()||L.endsWith("\n\n ")||R.trim().endsWith(";"),H=Ne(e,n),B=[ot,Ht,Xe,Lt,Nt,ut,It,xt,Pt,kt,Wt,gt],W=await bt(H,E,v,0,g);if(W)return W;const $=B.find((e=>e.match(H)));if($)return $.result(H,E,v,l,g);const U=x.slice(0,_).at(-1);if(U&&(q=U)==q.toUpperCase()&&q!=q.toLowerCase())return{suggestions:E.filter((e=>"keyword"===e.type&&e.topKwd)).map((e=>({...e,sortText:e.topKwd?"a":"b"})))};var q;if(P||L.toLowerCase().includes("explain")){const e=E.filter((e=>{var t;return null===(t=e.topKwd)||void 0===t?void 0:t.start_kwd})).map((e=>{var t;return{...e,sortText:`a${null!==(t=e.topKwd.priority)&&void 0!==t?t:99}`}}));return{suggestions:e}}if(R.toLowerCase().endsWith(" as ")||"join"===R.toLowerCase().trim().split(" ").slice(-2)[0]){if("as"!==(null==C?void 0:C.word.toLowerCase())||"type"!==(null==w?void 0:w.word.toLowerCase()))return{suggestions:[]};I=["ENUM","RANGE"],D="command"}if(I&&I.length)return{suggestions:E.filter((e=>"keyword"===e.type&&I.find((t=>t.toLowerCase()===e.name.toLowerCase())))).map((e=>(e.sortText=(I.findIndex((t=>t.toLowerCase()===e.name.toLowerCase()))+"").padStart(5,"0")+"a",e.insertText="values"!==e.name.toLowerCase()?e.name+" ":e.name,e)))};let j;return E.some((e=>e.type===D.toLowerCase()))?{suggestions:E.filter((e=>e.type===D.toLowerCase()))}:(E=E.map(((e,t)=>{var n,a,l;let o={...e};return o.sortText="yy",e.topKwd&&(o.sortText="xx"),("command"!==D||(null===(n=e.topKwd)||void 0===n?void 0:n.start_kwd))&&("command"===D&&(null===(a=e.topKwd)||void 0===a?void 0:a.start_kwd)?(o.sortText=null!==(l="a"+(Ue.findIndex((e=>e.label===o.label))+"").padStart(2,"0"))&&void 0!==l?l:"z",j="aZ"):"data type"===D&&"dataType"===e.type&&(o.sortText="a")),o.filterText=o.name.toLowerCase(),"command"!==D&&"keyword"===e.type&&(o.filterText=o.name),"keyword"!==o.type&&"table"!==o.type||(o.insertText+=" "),o})),!T&&j&&(E=E.filter((e=>e.sortText<=j))),{suggestions:E})}})}({monaco:c,...d,sql:i,editor:this.editor}),this.editor&&l&&!this.loadedFuncs&&d&&(!function(e,t,n){null==_l||_l.dispose(),_l=e.languages.registerSignatureHelpProvider(Al,{signatureHelpTriggerCharacters:["(",","],provideSignatureHelp:async function(e,a){var l,o,i,s,r,c,d,m=e.getValueInRange({startLineNumber:1,startColumn:1,endLineNumber:a.lineNumber,endColumn:a.column});const p=Ne(e,a),u=p.getPrevTokensNoParantheses(!0),h=m.split("\n").slice(0).reverse(),g=m.lastIndexOf("(");if(m.lastIndexOf(")")>g)return null;const f=null===(l=e.getWordUntilPosition(e.getPositionAt(g)))||void 0===l?void 0:l.word.trim();if(!f)return null;const E=m.slice(g+1).split(",").length-1;let v={value:{activeParameter:E,activeSignature:0,signatures:[]},dispose:()=>{}},b=v.value;const y=u.findIndex((e=>"values"===e.textLC&&"keyword.sql"===e.type)),N=u.slice(0,y),w=u.slice(y).map((e=>e.textLC)).join(""),S=(w.includes("(")&&!w.includes(")")||(null===(o=p.currToken)||void 0===o?void 0:o.textLC.includes("(")))&&p.prevTokens.some(((e,t,n)=>{var a;return"insert"===e.textLC&&"into"===(null===(a=n[t+1])||void 0===a?void 0:a.textLC)&&n.some((e=>"values"===e.textLC))}));if(S){const e=null===(i=p.prevTokens.find(((e,t,n)=>{var a,l;return t>1&&"insert"===(null===(a=n[t-2])||void 0===a?void 0:a.textLC)&&"into"===(null===(l=n[t-1])||void 0===l?void 0:l.textLC)})))||void 0===i?void 0:i.text,a=null==h?void 0:h.map((e=>{const t=e.replace(/\s\s+/g," ").trim();if(t.toUpperCase().includes("INSERT INTO"))return t})).find((e=>e)),l=n.find((t=>"table"===t.type&&t.escapedIdentifier===e));let o=null!==(d=null===(c=null===(r=null===(s=null==a?void 0:a.replace("VALUES(","").split("(")[1])||void 0===s?void 0:s.split(")"))||void 0===r?void 0:r[0])||void 0===c?void 0:c.split(","))&&void 0!==d?d:[];o.length||N.some((e=>e.textLC.includes("(")))||!(null==l?void 0:l.cols)||(o=l.cols.sort(((e,t)=>e.ordinal_position-t.ordinal_position)).map((e=>e.escaped_identifier)));let m=o.map((e=>{const t=null==l?void 0:l.cols.find((t=>t.escaped_identifier===e.trim()));return{label:e.trim(),data_type:null==t?void 0:t.udt_name,documentation:{value:ke(`${null==t?void 0:t.definition}`)}}}));if(m.length)return b.signatures=["VALUES"].map((e=>({label:`${e}(${m.map((e=>e.label)).join(", ")})`,documentation:{value:"**hint**: Columns that are nullable or have default values and can be filled with *NULL* or *DEFAULT*"},parameters:m}))),{value:b,dispose:()=>{}};const u=await t(f,E);return b.signatures=u.map((e=>({label:`${e.name}(${e.arg_list_str})`,documentation:e.description,parameters:e.args}))),v}}})}(c,l,d.suggestions),null===(t=d.onLoaded)||void 0===t||t.call(d),this.loadedFuncs=!0,s&&this.editor.focus())),c&&this.editor&&JSON.stringify(this.error||{})!==JSON.stringify(a||{})){this.error=a;const e=this.editor.getModel();if(!e)return;if(a){let t={};if("number"==typeof a.position){let l=a.position-1||0,o=a.length||10,i=0,s=e.getValue().length,r=0;const c=this.editor.getSelection();if(c){const t=null===(n=this.editor.getModel())||void 0===n?void 0:n.getValueInRange(c);t&&(i=e.getOffsetAt({column:c.startColumn,lineNumber:c.startLineNumber}),r=t.length)}if(!r){const t=this.getCurrentCodeBlock();t&&(i=e.getOffsetAt({column:1,lineNumber:t.startLine}),r=t.text.length)}r&&(s=r,l+=i),o=Math.max(1,Math.min(o,i+s-l));const d=e.getPositionAt(l),m=e.getPositionAt(l+o);t={startLineNumber:d.lineNumber,startColumn:d.column,endLineNumber:m.lineNumber,endColumn:m.column},this.scrollToLineIfNeeded(d.lineNumber)}if("bottom"!==(null==r?void 0:r.errorMessageDisplay)){this.editor.getContribution("editor.contrib.messageController").showMessage(a.message,{...this.editor.getPosition(),lineNumber:t.startLineNumber,column:t.endColumn})}c.editor.setModelMarkers(e,"test",[{startLineNumber:0,startColumn:0,endLineNumber:0,endColumn:5,code:"error.code",...a,...t}])}else c.editor.setModelMarkers(e,"test",[])}},this.onKeyDown=e=>{var t,n,a;const{onStopQuery:l}=this.props,o=e.altKey&&"e"===e.key.toLowerCase(),i=e.ctrlKey&&"Enter"===e.key;if("Escape"===e.key&&l)e.preventDefault(),l();else if(("F5"===e.key||o||i)&&(null===(n=null===(t=this.editor)||void 0===t?void 0:t.getDomNode())||void 0===n?void 0:n.contains(e.target)))e.preventDefault(),this.onRun();else if(e.ctrlKey&&"b"===e.key){const e=this.getCurrentCodeBlock();e&&this.editor&&this.editor.setSelection({startLineNumber:e.startLine,startColumn:0,endColumn:((null===(a=e.lines.at(-1))||void 0===a?void 0:a.v.length)||122)+1,endLineNumber:e.endLine})}},this.onChange=e=>{const{value:t="",onChange:n,debounce:a=300}=this.props;this.curVal=e,this.inDebounce&&window.clearTimeout(this.inDebounce),this.inDebounce=setTimeout((()=>{var t;n(e,null===(t=this.editor)||void 0===t?void 0:t.getPosition()),this.inDebounce=null}),a)},this.deltaDecorations=[],this.getCurrentCodeBlock=()=>{var e,t,n;if("full"!==(null===(e=this.props.sqlOptions)||void 0===e?void 0:e.executeOptions)){const e=null===(t=this.editor)||void 0===t?void 0:t.getModel(),a=null===(n=this.editor)||void 0===n?void 0:n.getPosition();return e&&a?Ne(e,a):void 0}},this.onRun=()=>{var e,t;const n=Dl(this.editor),a=this.getCurrentCodeBlock(),l=n||(null==a?void 0:a.text);l?this.props.onRun(l,!0):this.props.onRun(null!==(t=null===(e=this.editor)||void 0===e?void 0:e.getValue())&&void 0!==t?t:"",!1)},this.state={value:null!==(t=e.value)&&void 0!==t?t:"",editorMounter:!1}}onMount(){document.addEventListener("keydown",this.onKeyDown,!1),window.addEventListener("beforeunload",(async e=>{await this.componentWillUnmount()}),!1)}async onUnmount(){var e,t,n,a;document.removeEventListener("keydown",this.onKeyDown,!1),await(null===(t=(e=this.props).onUnmount)||void 0===t?void 0:t.call(e,this.editor,null===(n=this.editor)||void 0===n?void 0:n.getPosition())),this.rootRef&&(null===(a=this.resizeObserver)||void 0===a||a.unobserve(this.rootRef))}render(){const{value:e="",editorMounter:t}=this.state,{onMount:n,style:l={},className:o="",sqlOptions:i,onChange:s}=this.props;return a.createElement("div",{className:"sqleditor f-1 min-h-0 min-w-0 flex-col relative "+o,ref:e=>{e&&(this.rootRef=e)},style:{opacity:t?void 0:0,...l},onDragOver:e=>(e.preventDefault(),!1),onDrop:e=>{var t;let n=e.dataTransfer.getData("text");n&&(n=` ${n} `,null===(t=this.editor)||void 0===t||t.trigger("keyboard","type",{text:n}))}},a.createElement(be.ZP,{className:"f-1 min-h-0",language:Al,value:e,overrideServices:Ol(i),options:{acceptSuggestionOnEnter:"off",fixedOverflowWidgets:!0,theme:Il,folding:!0,parameterHints:{enabled:!window.isMobileDevice},...i?wo(i,["tabSize","lineNumbers","acceptSuggestionOnEnter"]):{}},onMount:e=>{if(!e)return;n&&n({editor:e,getSelectedText:()=>Dl(e),getCurrentCodeBlock:this.getCurrentCodeBlock}),this.editor=e,e.onDidChangeModelContent((t=>{this.onChange(e.getValue())})),this.setState({editorMounter:!0}),e.onDidChangeCursorPosition((async e=>{var t;if(this.editor){const e=this.getCurrentCodeBlock();this.deltaDecorations=null!==(t=((e,t,n,a)=>{var l;const o=!a||(null===(l=t.getModel())||void 0===l?void 0:l.getValueInRange(null==t?void 0:t.getSelection()));return t.deltaDecorations(n,o?[]:[{range:new e.Range(a.startLine,1,a.endLine,1),options:{isWholeLine:!1,linesDecorationsClassName:"myLineDecoration"}}])})(await this.getMonaco(),this.editor,this.deltaDecorations,e))&&void 0!==t?t:[]}}));const{cursorPosition:t}=this.props;t&&!yo(t)&&(this.editor.setPosition(t),setTimeout((()=>{this.mounted&&this.editor&&this.scrollToLineIfNeeded(t.lineNumber||1)}),al/2))}}))}}const kl=[{key:"BOOLEAN"},{key:"DATE"},{key:"DECIMAL (4,4)"},{key:"FLOAT"},{key:"GEOMETRY"},{key:"INTEGER"},{key:"JSON"},{key:"JSONB"},{key:"NUMERIC"},{key:"TEXT"},{key:"TIME"},{key:"TIMESTAMP"},{key:"TIMESTAMPZ"},{key:"TSVECTOR"},{key:"UUID"}];class AlterColumn extends a.Component{constructor(){super(...arguments),this.state={query:"",error:"",hint:"",field:"",editableQuery:!0,running:!1,onSuccess:()=>{}},this.onNewDataType=async e=>{const{table:t,db:n}=this.props;let a=this.state.field||this.props.field;const l=t.columns.find((e=>e.name===a)),o=t.name,{dataType:i,defaultValue:s,notNull:r}={...this.state,...e},c=JSON.stringify(a),d=` NULLIF(${c}::TEXT, '') `,m=JSON.stringify(o);let p=`USING  ${d}::${i}`;const u=`ALTER TABLE ${m} \nALTER COLUMN ${c} \n`;let h="";if("string"==typeof i&&i!==(null==l?void 0:l.data_type.toUpperCase())){if(i.startsWith("TIMESTAMP")||"DATE"===i){p=`USING to_timestamp(${d}, 'YYYY-MM-DD HH:MI:SS')::${i}`;const e=await n.sql(`SELECT ${c} FROM ${m} WHERE  ${c} IS NOT NULL LIMIT 1`,{},{returnType:"value"});if(e)if(g=e,"string"!=typeof(g+="")||isNaN(g)||isNaN(parseFloat(g))){const t=To(e),n=[{format:"NN NN NNNN",pg_format:"DD MM YYYY HH24:MI:SS"},{format:"NN NN NNNN NN:NN:NN",pg_format:"DD MM YYYY HH24:MI:SS"},{format:"NN NN NNNN NN:NN:NN.NNNZ",pg_format:"DD MM YYYY HH24:MI:SS.MSZ"},{format:"NNNN-NN-NN NN:NN:NN",pg_format:"YYYY-MM-DD HH24:MI:SS"},{format:"NNNN-NN-NNTNN:NN:NN",pg_format:"YYYY-MM-DDTHH24:MI:SS"},{format:"NNNN-NN-NN NN:NN:NN.NNNZ",pg_format:"YYYY-MM-DD HH24:MI:SS.MSZ"},{format:"NNNN-NN-NNTNN:NN:NN.NNNZ",pg_format:"YYYY-MM-DDTHH24:MI:SS.MSZ"}],a=n.find((e=>t.map((e=>"n"===e.type?"N".repeat(e.len):" ")).join("")===e.format));p=`USING to_timestamp(${d}, '${(null!=a?a:n[0]).pg_format}')::${i}`}else p=`USING to_timestamp(cast(${d} as BIGINT))::${i}`;"TIMESTAMPZ"===i&&(p+="at time zone 'utc'")}else i.startsWith("GEOMETRY")&&(p=`USING st_transform( \n st_setsrid( \n   st_geometryfromtext( \n        'POINT' || replace(${d}, ',', ' ')  \n   ), \n   27700 \n ), \n 4326 \n)`);h=u+`TYPE ${i} \n`+p+";"}var g;"boolean"==typeof r&&!r!==(null==l?void 0:l.is_nullable)&&(h+="\n\n"+u+(r?"SET NOT NULL;":"DROP NOT NULL;")),void 0!==s&&(h+="\n\n"+u+`SET DEFAULT ${"string"===(null==l?void 0:l.tsDataType)?`'${s}'`:s};`),this.setState({edited:{dataType:i},editableQuery:!0,query:h,error:void 0})}}componentDidMount(){}render(){var e,t,n,l,o,i,r;const{table:c,db:d,tables:p}=this.props;let u=this.state.field||this.props.field;const h=c.columns.find((e=>e.name===u)),{edited:g,query:f="",editableQuery:E=!0,error:v,hint:b,running:y}=this.state,N=c.name,w=!!(null!==(t=null===(e=this.state.edited)||void 0===e?void 0:e.notNull)&&void 0!==t?t:!(null==h?void 0:h.is_nullable)),S=async(e=this.state.query)=>{var t;try{this.setState({running:!0}),await d.sql(e),this.setState({error:"",hint:"Success!"})}catch(e){this.setState({error:(0,m.isObject)(e)&&null!==(t=e.err_msg)&&void 0!==t?t:e})}this.setState({running:!1})},T=JSON.stringify(N),C=JSON.stringify(u),_=`ALTER TABLE ${T} \n`,x=`${_}ALTER COLUMN ${C}\n`,A=null!==(l=null===(n=this.state.edited)||void 0===n?void 0:n.defaultValue)&&void 0!==l?l:null==h?void 0:h.column_default,R=()=>{this.setState({edited:void 0,query:""})},L=async e=>{const t=await((e,t,n)=>n("SELECT c.table_name, c.column_name, c.data_type, trim(constraint_type) as constraint_type, constraint_name\n  FROM information_schema.table_constraints tc \n  JOIN information_schema.constraint_column_usage AS ccu USING (constraint_schema, constraint_name) \n  JOIN information_schema.columns AS c ON c.table_schema = tc.constraint_schema\n    AND tc.table_name = c.table_name AND ccu.column_name = c.column_name\n  WHERE tc.table_name = $1 AND c.column_name = $2\n  --WHERE constraint_type = 'PRIMARY KEY' --and tc.table_name = 'mytable';",[e,t],{returnType:"rows"}))(N,null==h?void 0:h.name,d.sql),n=t.find((t=>t.constraint_type===("p"===e?"PRIMARY KEY":"FOREIGN KEY")));n&&this.setState({edited:"p"===e?{isPkey:!1}:{references:void 0},query:`${_}DROP CONSTRAINT ${(0,m.asName)(n.constraint_name)};`})};return a.createElement("div",{className:"f-1 "+(window.isMobileDevice?" flex-col ":"flex-row "),style:{}},a.createElement("div",{className:"ALTERCONTAINER f-1 flex-col p-1 o-auto"},a.createElement("div",{className:"flex-col gap-2"},a.createElement(FormField,{className:"mb-1",asColumn:!0,label:"Column name",value:null!==(o=null==g?void 0:g.newName)&&void 0!==o?o:null==h?void 0:h.name,onChange:e=>{this.setState({edited:{newName:e},editableQuery:!1,query:`ALTER TABLE ${JSON.stringify(N)} \nRENAME COLUMN ${JSON.stringify(u)} \nTO ${JSON.stringify(e)} `})}}),a.createElement("div",{className:"flex-row gap-1"},a.createElement(Select_Select,{label:"Data type",variant:"div",value:null!==(i=null==g?void 0:g.dataType)&&void 0!==i?i:null==h?void 0:h.data_type.toUpperCase(),fullOptions:kl,onChange:e=>this.onNewDataType({dataType:e})}),a.createElement(FormField,{asColumn:!0,id:"notnull",label:"NOT NULL",type:"checkbox",value:w,onChange:e=>{"boolean"==typeof e&&!e!==(null==h?void 0:h.is_nullable)?this.setState({edited:{notNull:e},query:x+(e?"SET NOT NULL;":"DROP NOT NULL;")}):R()}})),a.createElement(FormField,{asColumn:!0,id:"defval",label:"Default value",type:"text",autoComplete:"off",value:A,hint:"Added to all new records if no other value is specified",onChange:e=>{e!==(null==h?void 0:h.has_default)?this.setState({edited:{defaultValue:e},query:x+`SET DEFAULT ${"string"===(null==h?void 0:h.tsDataType)?`'${e}'`:e};`}):R()},rightIcons:!!(null==h?void 0:h.has_default)&&a.createElement(Btn_Btn,{iconPath:s.r5M,onClick:()=>{this.setState({query:`${_}ALTER COLUMN ${C}\nDROP DEFAULT;`})}})}),a.createElement(FormField,{asColumn:!0,id:"pkey",label:"Primary key",type:"checkbox",value:null==h?void 0:h.is_pkey,onChange:async e=>{e?this.setState({edited:{isPkey:e},query:`${_}ADD PRIMARY KEY (${C}) \n`}):L("p")}}),a.createElement("div",{className:"flex-col gap-p5"},a.createElement("div",{className:"ta-left noselect text-gray-500"},"References"),null===(r=null==h?void 0:h.references)||void 0===r?void 0:r.map(((e,t)=>a.createElement(Chip,{key:t,label:e.ftable,value:e.fcols.join(),onDelete:()=>{L("f")}}))),a.createElement(Select_Select,{iconPath:s.qX5,emptyLabel:"Add reference",value:null==g?void 0:g.references,fullOptions:p.map((e=>{const t=e.columns.filter((t=>(e.name!==N||t.name!==(null==h?void 0:h.name))&&t.is_pkey&&t.udt_name===(null==h?void 0:h.udt_name))).map((e=>`${e.name}: ${e.data_type.toUpperCase()}`)).join(", ");return{key:e.name,label:e.name,subLabel:t,disabledInfo:t?void 0:"No suitable columns (unique and same data type)"}})),onChange:e=>{var t;(null===(t=null==h?void 0:h.references)||void 0===t?void 0:t.some((t=>t.ftable===e)))?R():this.setState({edited:{references:e},query:`${_}ADD FOREIGN KEY (${C}) \nREFERENCES ${e};`})}})),a.createElement(Btn_Btn,{color:"danger",onClick:()=>{this.setState({query:`${_}DROP COLUMN ${C}\n"delete this line to confirm"`})}},"DROP ...")),!!f&&a.createElement("div",{className:"flex-col gap-1 mt-1"},a.createElement("div",null,"Alter query"),a.createElement(SQLEditor,{key:f,className:"b b-gray-300 rounded o-hidden ",autoFocus:!1,value:f,sqlOptions:{lineNumbers:"off",minimap:{enabled:!1}},style:{minHeight:"200px",minWidth:"350px"},onChange:e=>{this.setState({query:e})},onRun:S}),a.createElement(Btn_Btn,{style:{alignSelf:"flex-end"},color:"action",iconPath:s._86,variant:"outline",title:"Run rename query",loading:y,onClick:()=>S()},"RUN"),v&&a.createElement(ErrorComponent,{error:v}),!!b&&a.createElement(Zt,{color:"info"},b))))}}const Ml={allowedHTMLTags:1,computedConfig:1,contentConfig:1,format:1,name:1,noSanitize:1,show:1,style:1,width:1},Fl=[{key:"fixed",label:"Fixed"},{key:"fromColumn",label:"From column"},{key:"fromUrlEnding",label:"From URL extension"}],Pl=[{key:"img",label:"Image"},{key:"video",label:"Video"},{key:"audio",label:"Audio"},{key:"svg",label:"SVG"},{key:"apth",label:"Path (SVG)"}],Hl=[{key:"first",label:"First"},{key:"last",label:"Last"},{key:null,label:"None"}];class ColumnMenu extends RTComp{constructor(){super(...arguments),this.state={},this.d={},this.onDelta=async(e,t,n)=>{var a;const l={...e,...t,...n},{db:o,tableName:i,colName:s,tables:r}=this.props,c=this.d.w||this.props.w;if(c&&c.$cloneSync&&!this.wSub&&(this.wSub=await c.$cloneSync(((e,t)=>{this.setData({w:e},{w:t}),this.mounted&&this.forceUpdate()}))),c)if(c.columns&&Array.isArray(c.columns)){if(s&&(null===(a=null==l?void 0:l.w)||void 0===a?void 0:a.columns)){const e=$l(r,c).find((e=>e.name===s));e?this.setState({column:e}):console.warn(`Column (${s}) was not found, delete?!`)}}else c.$update({columns:await ProstglesTableMenu.getWCols(o[i],c,!0)})},this.onUpdate=e=>{var t;const{w:n}=this.d,{column:a}=this.state;if(!n||!a)return;let l=null===(t=n.columns)||void 0===t?void 0:t.map(((t,n)=>t.name===a.name?{...t,...e}:t));n.$update({columns:l})}}render(){var e,t,n,l,o,i,r,c,d,m,p,u,h,g,f,E,v,b,y,N,w,S;const{w:T}=this.d,{column:C,l1Key:_,addComputedColname:x}=this.state,{db:A,onAddFilter:R,tableName:L,onClose:O,colName:I,tables:D}=this.props;if(!T||!C)return null;const k=(T.sort||[]).find((e=>e.key===C.name))||{key:C.name,asc:null},M=e=>{let t=!1,n=(T.sort||[]).map((n=>n.key===C.name?(t=!0,{...n,...e}):{...n}));null===e.asc?n=n.filter((t=>t.key!==e.key)):t||n.push(e),T.$update({sort:n})},F=D.find((e=>e.name===T.table_name)),P=null==F?void 0:F.columns.find((e=>e.name===I)),{format:H="NONE",contentConfig:B={fromUrlEnding:!0}}=C,W="string"===(null===(e=C.info)||void 0===e?void 0:e.tsDataType)||"string"===(null===(t=C.computedConfig)||void 0===t?void 0:t.funcDef.outType.tsDataType),$=C.format&&"NONE"!==C.format||C.computedConfig,U={Sort:{leftIconPath:s.qe5,disabledText:(null==P?void 0:P.orderBy)?void 0:"Not permitted",style:"boolean"==typeof k.asc?{color:"var(--blue-600)"}:{},content:a.createElement("div",{className:"flex-col"},a.createElement(Select_Select,{label:"Sort",value:!0===(null==k?void 0:k.asc)?"Ascending":!1===k.asc?"Descending":null,variant:"div",emptyLabel:"None",fullOptions:[{key:!0,label:"Ascending"},{key:!1,label:"Descending"},{key:null,label:"None"}],onChange:e=>{M({...k,asc:e})}}),"boolean"!=typeof k.asc?null:a.createElement(a.Fragment,null,a.createElement(Select_Select,{label:"Nulls",className:"mt-1",value:(null==k?void 0:k.nulls)||null,variant:"div",fullOptions:Hl,onChange:e=>{M({...k,nulls:e})}}),W&&a.createElement(FormField,{type:"checkbox",label:"Null empty text",className:"mt-1",asColumn:!0,value:k.nullEmpty,onChange:e=>{M({...k,nullEmpty:e})}})))},Style:{leftIconPath:s.gUZ,disabledText:"Media"===C.format?"Cannot style a media format column":void 0,style:(null===(n=C.style)||void 0===n?void 0:n.type)&&"None"!==(null===(l=C.style)||void 0===l?void 0:l.type)?{color:"var(--blue-600)"}:{},content:a.createElement(StyleColumn,{db:A,tableName:L,tables:D,column:C,onUpdate:this.onUpdate,tsDataType:(null===(o=C.info)||void 0===o?void 0:o.tsDataType)||(null===(i=C.computedConfig)||void 0===i?void 0:i.funcDef.outType.tsDataType)||"any"})},"Display format":{style:C.format?{color:"var(--blue-600)"}:{},leftIconPath:s.H3X,disabledText:Wl(C.info||(null===(r=C.computedConfig)||void 0===r?void 0:r.funcDef.outType)).length<=1?"Only text columns can have custom formats at the moment":void 0,content:a.createElement("div",{className:"flex-col"},a.createElement(Select_Select,{label:"Display format",value:H,variant:"div",fullOptions:Wl(C.info||(null===(c=C.computedConfig)||void 0===c?void 0:c.funcDef.outType)).map((e=>({key:e.label,subLabel:e.info}))),onChange:e=>{const t={format:e};"Media"!==t.format?t.contentConfig=void 0:t.contentConfig={fromUrlEnding:!0},"NONE"===t.format&&(t.format=void 0),this.onUpdate(t)}}),"HTML"===H&&a.createElement(a.Fragment,null,a.createElement(Checkbox,{className:"pt-1",checked:!Boolean(C.noSanitize),label:"Sanitize HTML. Leave unchecked if you understand the risks",onChange:e=>{this.onUpdate({noSanitize:!e.target.checked})}}),!C.noSanitize&&a.createElement(Select_Select,{label:"Allowed tags",className:"mt-1",value:C.allowedHTMLTags||[],variant:"div",fullOptions:Pl,multiSelect:!0,onChange:e=>{this.onUpdate({allowedHTMLTags:e})}})),"Media"===H&&a.createElement(a.Fragment,null,a.createElement(Select_Select,{label:"Content type",className:"mt-1",value:null!==(m=null===(d=Object.keys(B||{}))||void 0===d?void 0:d[0])&&void 0!==m?m:"fromUrlEnding",variant:"div",fullOptions:Fl,onChange:e=>{"fixed"===e?this.onUpdate({contentConfig:{fixed:"image"}}):"fromColumn"===e?this.onUpdate({contentConfig:{fromColumn:""}}):this.onUpdate({contentConfig:{fromUrlEnding:!0}})}}),"fromColumn"in B&&a.createElement(Select_Select,{label:"Content type",className:"mt-1",value:null!==(u=null===(p=Object.keys(B||{}))||void 0===p?void 0:p[0])&&void 0!==u?u:"fixed",variant:"div",options:null!==(h=null==F?void 0:F.columns.filter((e=>e.name!==B.fromColumn&&"string"===e.tsDataType)).map((e=>e.name)))&&void 0!==h?h:[],onChange:e=>{this.onUpdate({contentConfig:{fromColumn:e}})}}),"fixed"in B&&a.createElement(Select_Select,{label:"Content type",className:"mt-1",value:B.fixed,variant:"div",options:["image","video","audio"],onChange:e=>{this.onUpdate({contentConfig:{fixed:e}})}})))},Filter:{leftIconPath:s.k0z,disabledText:(null==P?void 0:P.filter)?$?"Cannot filter a computed column":void 0:"Not permitted",style:(null===(g=T.filter)||void 0===g?void 0:g.some((e=>"fieldName"in e&&e.fieldName===C.name)))?{color:"var(--blue-600)"}:{}},Columns:{leftIconPath:s.B9t,content:a.createElement(ColumnsMenu,{w:T,db:A,tableName:L,tables:D,onClose:O})},"Add Computed Column":{disabledText:$?"Not allowed on computed columns":void 0,leftIconPath:s.W1W},Alter:{leftIconPath:s.cl8,disabledText:A.sql?$?"Cannot alter a computed column":void 0:"Not enough privileges",content:!!F&&a.createElement(AlterColumn,{db:A,table:F,field:C.name,tables:D})},Hide:{leftIconPath:s.DqW,hide:(null!==(v=null===(E=null===(f=this.d.w)||void 0===f?void 0:f.columns)||void 0===E?void 0:E.filter((e=>e.show)).length)&&void 0!==v?v:0)<2},"Hide Others":{leftIconPath:s.DqW,hide:(null!==(N=null===(y=null===(b=this.d.w)||void 0===b?void 0:b.columns)||void 0===y?void 0:y.filter((e=>e.show)).length)&&void 0!==N?N:0)<2},"Unhide all":{leftIconPath:s.rgx,hide:!(null===(S=null===(w=this.d.w)||void 0===w?void 0:w.columns)||void 0===S?void 0:S.some((e=>!e.show)))}};return x?a.createElement(ColumnsMenu,{w:T,db:A,tableName:L,tables:D,onClose:()=>{this.setState({addComputedColname:void 0})},showAddCompute:{colName:x}}):a.createElement("div",{className:"f-1 flex-col"},a.createElement("div",{className:"f-1 flex-col p-p5 bg-gray-100 ta-left noselect"},I),a.createElement(Tabs,{compactMode:window.isMobileDevice,variant:"vertical",contentClass:" flex-col ml-p25 "+("Alter"===_?" o-auto ":" p-1 "),activeKey:_,items:U,onChange:async e=>{var t,n,a,l,o,i,s;if(this.d.w){if("Add Computed Column"===e)this.setState({addComputedColname:I});else if("Filter"===e){let e=await SmartFilter.getDefaultFilter(C,A);(null===(t=this.d.w.filter)||void 0===t?void 0:t.length)?this.d.w.$update({filter:[e,...this.d.w.filter]}):this.d.w.$update({filter:[e]}),O(),R()}else if("Hide"===e){const e=(null!==(a=null===(n=this.d.w)||void 0===n?void 0:n.columns)&&void 0!==a?a:[]).map((e=>({...e,show:C.name!==e.name&&e.show})));this.d.w.$update({columns:e}),O()}else if("Hide Others"===e){const e=(null!==(o=null===(l=this.d.w)||void 0===l?void 0:l.columns)&&void 0!==o?o:[]).map((e=>({...e,show:C.name===e.name})));this.d.w.$update({columns:e}),O()}else if("Unhide all"===e){const e=(null!==(s=null===(i=this.d.w)||void 0===i?void 0:i.columns)&&void 0!==s?s:[]).map((e=>({...e,show:!0})));this.d.w.$update({columns:e}),O()}this.setState({l1Key:e})}}}))}}const Bl=[{label:"NONE",info:"Display data as is",tsDataType:void 0},{label:"Email",info:"Email link",tsDataType:"string"},{label:"Tel",info:"Telephone number link",tsDataType:void 0},{label:"Media",info:"Display media (video/image/audio) from URL",tsDataType:"string"},{label:"URL",info:"Display string as a clickable URL",tsDataType:"string"},{label:"QR Code",info:"Display a URL as an image",tsDataType:"string"},{label:"HTML",info:"Display string as sanitised HTML",tsDataType:"string"},{label:"UNIX Timestamp",info:"Display unix timestamp as datetime",tsDataType:"number"}];function Wl(e){return e?Bl.filter((t=>!t.tsDataType||t.tsDataType===e.tsDataType)):[]}const $l=(e,t,n,a)=>{var l;try{const{columns:o,table_name:i}=t,s=e.find((e=>e.name===i));let r=on(e,t);(null==s?void 0:s.info.is_media)&&(r=r.map((e=>({...e,contentConfig:e.contentConfig&&!e.format&&"url"===e.name?{fromUrlEnding:!0}:e.contentConfig}))));try{r=fn(r,n,"name",a).map((e=>{var t;return{...e,width:"uuid"===(null===(t=e.info)||void 0===t?void 0:t.udt_name)?150:e.width}}))}catch(e){console.error(e)}const c=e.find((e=>e.name===t.table_name));if(t&&!(null===(l=t.columns)||void 0===l?void 0:l.length)&&(null==c?void 0:c.info.is_media)){r=structuredClone(r);const e=r.findIndex((e=>"url"===e.name)),t=r.splice(e,1)[0],n=r.findIndex((({name:e})=>"original_name"===e));n&&r.unshift(r.splice(n,1)[0]),t&&(t.format="Media",t.contentConfig={fromUrlEnding:!0},r.unshift(t))}return r.slice(0)}catch(e){throw console.error(e),e}},Ul=e=>{const t=(0,m.getKeys)(Ml);return e.map((e=>wo(e,t)))},ql=async(e,t,n,a)=>{let l,o={};return e.columns&&Array.isArray(e.columns)?await Promise.all($l(t,e).map((async t=>{var i,s,r,c,d,p,u;if(t.show){if(t.style&&["Barchart","Scale"].includes(t.style.type)){if(t.computedConfig)throw"Cannot use Scale/Barchart styling on a computed column";l=l||{};const o=await(null===(s=null===(i=n[e.table_name])||void 0===i?void 0:i.findOne)||void 0===s?void 0:s.call(i,a,{select:{minValue:{$min:[t.name]},maxValue:{$max:[t.name]}}})),c="Date"===(null===(r=t.info)||void 0===r?void 0:r.tsDataType);o&&(l[t.name]={minValue:c?+new Date(o.minValue):+o.minValue,maxValue:c?+new Date(o.maxValue):+o.maxValue})}if(null==t?void 0:t.computedConfig){let e=t.computedConfig.funcDef.key,n=[t.computedConfig.column].filter(m.isDefined);if(t.computedConfig.column||t.computedConfig.args){const{args:a}=t.computedConfig;(null===(c=null==a?void 0:a.$duration)||void 0===c?void 0:c.otherColumn)?(n=[t.computedConfig.column,null===(d=null==a?void 0:a.$duration)||void 0===d?void 0:d.otherColumn],e="$age"):(null===(p=null==a?void 0:a.$string_agg)||void 0===p?void 0:p.separator)?n=[t.computedConfig.column,null===(u=null==a?void 0:a.$string_agg)||void 0===u?void 0:u.separator]:(null==a?void 0:a.$template_string)&&(n=[null==a?void 0:a.$template_string])}o[t.name]={[e]:n}}else o[t.name]=1}}))):o={"*":1},{barchartVals:l,select:o}},jl=(e,t)=>{var n;const{sort:a}=t;if(!a)return[];let l=a.map((e=>({...e})));const o=null===(n=e.find((e=>e.name===t.table_name)))||void 0===n?void 0:n.columns;if(!o)return[];const i=t.columns;return l=l.filter((e=>{if(i){const t=i.find((t=>t.name===e.key));return o.some((e=>{var n,a;return(null==t?void 0:t.computedConfig)?!(null===(n=t.computedConfig)||void 0===n?void 0:n.column)||(null===(a=t.computedConfig)||void 0===a?void 0:a.column)===e.name:t?t.name===e.name:void 0}))}return o.some((t=>t.name===e.key))})),l},zl=(e,t,n)=>{var a;const l=null===(a=e.find((e=>e.name===t)))||void 0===a?void 0:a.columns,o=(e,t)=>{if(!n[t.tableName])return;let a=!1;e.forEach((e=>{e.tableName===t.tableName&&(a=!0,e.on=[...e.on,...t.on])})),a||e.push(t)},i=[];null==l||l.filter((e=>e.references)).forEach((e=>{var t;null===(t=e.references)||void 0===t||t.forEach((({ftable:t,fcols:n})=>{o(i,{tableName:t,on:[[e.name,n[0]]]})}))}));const s=[];return e.filter((e=>e.name!==t)).forEach((({name:e,columns:n})=>{n.forEach((n=>{var a;const l=null===(a=n.references)||void 0===a?void 0:a.filter((({ftable:e})=>e===t));(null==l?void 0:l.length)&&l.forEach((({fcols:t})=>{o(s,{tableName:e,hasFkeys:!0,on:[[t[0],n.name]]})}))}))})),[...i,...s]},Yl=e=>{var t,n,a,l;let o=e;if(o){for(;o&&"$and"in o&&Array.isArray(o.$and)&&o.$and.length<2||o&&"$or"in o&&Array.isArray(o.$or)&&o.$or.length<2;)o.$and&&(o=null!==(n=null===(t=o.$and)||void 0===t?void 0:t[0])&&void 0!==n?n:{}),o.$or&&(o=null!==(l=null===(a=o.$or)||void 0===a?void 0:a[0])&&void 0!==l?l:{});null!=o||(o={})}return o};const Vl=(e=[],t,n)=>{let a=e;(null==t?void 0:t.detailed)&&(a=[...e,...t.detailed]);let l=a.map((e=>k(e)));return(null==t?void 0:t.filters)&&(l=l.concat(t.filters)),Yl({[`$${n||"and"}`]:l.filter(Co)})};class SmartFilter extends RTComp{constructor(){super(...arguments),this.state={searchTerm:""},this.onChange=e=>{this.props.onChange(e)}}render(){var e;const{db:t,tableName:n,detailedFilter:l=[],className:o="",style:i={},tables:s,operand:r="AND",onOperandChange:c,contextData:d,hideToggle:m}=this.props,p=this.onChange,u=null===(e=s.find((e=>e.name===n)))||void 0===e?void 0:e.columns,h=(null==u?void 0:u.length)?a.createElement("div",{key:"o",style:i,className:"SmartFilter flex-row-wrap ai-center min-w-0 min-h-0 gap-p5 "+o},l.map(((e,o)=>{var i,h,g,f;let E,v,b,y=n;if(O(e)){({fieldName:v}=e.filter);const t=e.path[e.path.length-1];if(!t)return a.createElement(a.Fragment,null,"Filter path ",t," missing");y=t,E=null===(i=s.find((e=>e.name===t)))||void 0===i?void 0:i.columns.find((e=>e.name===v)),b=e.path.join(" > ")+"."+v}else({fieldName:v}=e),E=u.find((e=>e.name===v));E||(E={comment:"",name:v,data_type:"text",delete:!1,element_type:"",element_udt_name:"",filter:!0,has_default:!1,insert:!1,udt_name:"text",is_nullable:!0,is_pkey:!1,label:v,ordinal_position:-1,select:!0,orderBy:!0,tsDataType:"string",update:!0});const N=null!==(g=null===(h=this.props.detailedFilter)||void 0===h?void 0:h.filter(((e,t)=>t!==o)))&&void 0!==g?g:[],w={className:`${null!==(f=this.props.filterClassName)&&void 0!==f?f:""} shadow min-w-0 min-h-0`,style:this.props.filterStyle,key:o+v,db:t,label:b,tableName:y,column:E,tables:s,contextData:d,hideToggle:m,filter:O(e)?e.filter:e,otherFilters:O(e)?N.filter(I).map((t=>({type:e.type,path:[...e.path.slice(0).reverse().slice(1),this.props.tableName],filter:t}))):N,onChange:t=>{let n=[...l];t?O(e)?n[o].filter={...t}:n[o]={...t}:n=n.filter(((e,t)=>t!==o)),p(n)}};let S=a.createElement(Filter,{...w,tables:s});return l.length>1&&o<l.length-1?a.createElement(a.Fragment,{key:"o"+o},S,a.createElement(Btn_Btn,{className:"OPERAND text-active hover",title:c?"Press to toggle":"Operand",onClick:c?()=>{null==c||c("AND"===r?"OR":"AND")}:void 0},r)):S}))):null;return h}}SmartFilter.getDefaultFilter=async(e,t)=>{var n,a;const l=["number","Date"].includes((null===(n=e.info)||void 0===n?void 0:n.tsDataType)||(null===(a=e.computedConfig)||void 0===a?void 0:a.funcDef.tsDataTypeCol));return{fieldName:e.name,type:l?"$between":"$in"}};class Filter extends RTComp{render(){var e,t,n,l;const{column:o,tables:i,onChange:s,db:r,tableName:c,contextData:d}=this.props,{error:m}=this.state,p=r[c],u=async(e,t)=>{var n;let a,l=e;if(l)try{await(null===(n=null==p?void 0:p.findOne)||void 0===n?void 0:n.call(p,k(l),{select:""}))}catch(e){l={...l,disabled:!0},a=e}!!this.state.error!=!!a&&this.setState({error:a}),s(l)},h={...this.props.filter,fieldName:null!==(t=null===(e=this.props.filter)||void 0===e?void 0:e.fieldName)&&void 0!==t?t:o.name,type:null!==(l=null===(n=this.props.filter)||void 0===n?void 0:n.type)&&void 0!==l?l:"="},g=this.props.filter;let f;return f=AgeFilter.TYPES.includes(null==g?void 0:g.type)?a.createElement(AgeFilter,{...this.props,error:m}):"not null"===(null==g?void 0:g.type)||"null"===(null==g?void 0:g.type)?null:ListFilter.TYPES.includes(null==g?void 0:g.type)?a.createElement(ListFilter,{...this.props,error:m}):["$ilike","$like"].includes(h.type)||_.some((e=>e.key===h.type))?a.createElement(FormField,{asColumn:!0,className:"m-p5",type:"text",autoComplete:"off",value:h.value,onChange:e=>{u({...h,disabled:!1,value:`${e}`})}}):"$between"===h.type?a.createElement(NumberOrDateFilter,{...this.props,type:o.tsDataType.toLowerCase(),inputType:SmartFormField.getInputType(o)}):a.createElement(SmartSearch,{className:" ",db:r,tableName:c,style:{padding:".5em"},variant:"search-no-shadow",tables:i,defaultValue:h.value,column:h.fieldName,onPressEnter:e=>{let t={...h};t.value=e,t.disabled=!1,u(t)},onChange:(e,{columnValue:t,term:n})=>{let a={...h};a.value=t||n,a.disabled=!1,u(a)}}),a.createElement(FilterWrapper,{...this.props,filter:h},m&&a.createElement(ErrorComponent,{error:m}),(e=>{if(d){null==g||g.contextValue;if(d.flatMap((e=>e.columns.filter((e=>e.tsDataType===o.tsDataType)).map((t=>({id:e.name+"."+t.name,tableName:e.name,...t}))))).length&&["=","!=","<>"].includes(h.type))return a.createElement("div",{className:"flex-row ai-center mr-p5"},(null==g?void 0:g.contextValue)?null:e,a.createElement(P,{className:"m-p5",value:null==g?void 0:g.contextValue,column:o,contextData:d,onChange:e=>{u(e?{...h,contextValue:e}:No({...h},["contextValue"]))}}))}return e})(f),null==d?void 0:d.some((e=>e.columns.some((e=>e.tsDataType===o.tsDataType)))))}}function Gl(e,t,n="...",a=!1){return e.length>t?a?`${e.slice(0,t/2)}${n}${e.slice(e.length-t/2+3)}`:`${e.slice(0,t)}${n}`:e}const Jl=e=>{const{tables:t,tableName:n,excludeTables:a=[]}=e,l=t.find((e=>e.name===n));if(!l)throw"Table info not found";const o=[],i=e=>{a.includes(e.table)||o.find((t=>t.table===e.table&&JSON.stringify(t.on)===JSON.stringify(e.on)))||o.push(e)};l.columns.forEach((e=>{var t;null===(t=e.references)||void 0===t||t.forEach((e=>{const t={table:e.ftable,on:e.cols.map(((t,n)=>[t,e.fcols[n]]))};i(t)}))})),t.forEach((e=>{e.name!==n&&e.columns.forEach((t=>{var a;null===(a=t.references)||void 0===a||a.forEach((t=>{if(t.ftable===n){const n={table:e.name,on:t.fcols.map(((e,n)=>[e,t.cols[n]]))};i(n)}}))}))}));let s=o.map((e=>({...e,joins:Jl({tableName:e.table,tables:t,excludeTables:[n,...a,e.table]})})));return s=s.map((e=>({...e}))),s};class Select_Select extends RTComp{constructor(){super(...arguments),this.state={popupAnchor:null,defaultSearch:void 0},this.onDelta=(e,t,n)=>{const{onSearch:a}=this.props}}render(){var e,t,n,l,o;const{onChange:i,className:r="",title:d="",value:m,id:p="select-"+Date.now(),style:u={},required:h,label:g,variant:f="div",onSearch:E,multiSelect:v,labelAsValue:b,emptyLabel:y="Select...",asRow:N,iconPath:w,buttonClassName:S="",size:T,limit:C,btnProps:_}=this.props,x=null!==(e=this.state.multiSelection)&&void 0!==e?e:m,A=(e,t)=>{JSON.stringify(x)!==JSON.stringify(e)&&(Array.isArray(e)?this.setState({multiSelection:e}):null==i||i(e,t))},R=a.createElement(c(),{path:s.iW9,size:1,style:{color:"#cacaca",pointerEvents:"none",touchAction:"none"}});let L=[];"options"in this.props?L=this.props.options.map((e=>({key:e,label:e,...v?{checked:Boolean(x&&x.includes(e))}:{}}))):(x&&this.props.fullOptions.some((e=>"boolean"==typeof e.checked))&&console.warn("fullOptions checked AND value provided to Select",this.props.fullOptions),L=this.props.fullOptions.map((e=>{var t,n;return{...e,label:null!==(t=e.label)&&void 0!==t?t:null===(n=e.key)||void 0===n?void 0:n.toString(),...v&&!("checked"in e)?{checked:Boolean(x&&x.includes(e.key))}:{}}}))),L=L.map((e=>{var t;return{...e,label:null!==(t=e.label)&&void 0!==t?t:null===e.label?"NULL":""}}));const O=L.map((({key:e})=>e)),I=g?{}:u,D=(e,t)=>{if(v){const n=L.filter((e=>e.checked)).map((e=>e.key));n.includes(e)?A(n.filter((t=>t!==e)),t):A([...n,e],t)}else A(e,t)};let k=null;if("pill"===f)k=a.createElement("div",{className:"flex-row rounded bg-gray-200 o-hidden b b-gray-300",style:I},L.map(((e,t)=>{var n;return a.createElement(Btn_Btn,{key:t,color:"inherit",style:{borderRadius:0,color:"var(--gray-600)",...x===e.key?{color:"white",background:"rgb(0, 183, 255)"}:{}},onClick:t=>{D(e.key,t)}},null!==(n=e.label)&&void 0!==n?n:e.key)})));else if("div"===f||E||v){const{popupAnchor:e,defaultSearch:c,fixedBtnWidth:m}=this.state,u=e=>{this.state.multiSelection&&i&&i(this.state.multiSelection,e),this.setState({popupAnchor:null,multiSelection:void 0,fixedBtnWidth:void 0,defaultSearch:""}),setTimeout((()=>{var e;document.activeElement!==document.body&&(null===(e=this.btnRef)||void 0===e||e.focus())}),2)};let h="Select...";if(Array.isArray(x)){if(x.length){const e=L.filter((e=>x.includes(e.key))).map((e=>e.label||e.key)),t=3;h=e.map((e=>Gl((null===e?"NULL":e).toString(),5))).slice(0,t).join(", ")+(e.length>t?" + "+(e.length-t):"")}}else h=null!==(n=null===(t=L.find((e=>e.key===x)))||void 0===t?void 0:t.label)&&void 0!==n?n:x;const f=!(null==O?void 0:O.length)||1===(null==O?void 0:O.length)&&x===(null==O?void 0:O[0]);k=a.createElement(a.Fragment,null,a.createElement(Btn_Btn,{title:f?"No other option":d,style:{borderRadius:"6px",position:"relative",width:g?"auto":"fit-content",minHeight:"32px",...I,...m&&{width:`${m}px`}},size:T,variant:"faded",color:"default",className:(g?"  ":r)+" Select f-0 select-button "+S,iconPath:null!=w?w:s.iW9,iconPosition:"right",iconClassname:"text-gray-400",..._,onClick:f?void 0:e=>{const t=e.currentTarget.getBoundingClientRect().width;this.setState({popupAnchor:e.currentTarget,fixedBtnWidth:t})},_ref:e=>{e&&(this.btnRef=e)},onKeyDown:f?void 0:t=>{if(1!==t.key.length||e){if(["ArrowUp","ArrowDown"].includes(t.key)){const e="ArrowUp"===t.key?-1:1;let n=O.indexOf(x)+e;n<0?n=O.length-1:n>O.length-1&&(n=0),A(O[n],t),t.preventDefault()}}else{const e=t.currentTarget.getBoundingClientRect().width;this.setState({popupAnchor:t.currentTarget,fixedBtnWidth:e,defaultSearch:t.key})}}},w||void 0!==(null==_?void 0:_.children)?null!==(l=null==_?void 0:_.children)&&void 0!==l?l:null:a.createElement(a.Fragment,null,a.createElement("div",{className:" text-ellipsis "+(x?"":" text-gray-600")},null!==(o=b?SmartFormField.renderValue(void 0,h,!f):h)&&void 0!==o?o:y))),e?a.createElement(Popup,{open:!0,rootStyle:{padding:0},anchorEl:e,positioning:"beneath-left-minfill",clickCatchStyle:{opacity:0},onClose:u,contentClassName:"rounded"},a.createElement(SearchList,{id:p,placeholder:"Search...",defaultSearch:c,noSearchLimit:15,autoFocus:!0,onSearch:E,onMultiToggle:v?(e,t)=>{A(e.filter((e=>e.checked)).map((e=>e.key)),t)}:void 0,onChange:v?void 0:A,limit:C,items:L.map((({key:e,label:t,subLabel:n,checked:a,disabledInfo:l})=>({key:e,label:t,subLabel:n,onPress:t=>{D(e,t),v||u(t)},selected:t===x,checked:a,disabledInfo:l})))})):null)}else k=a.createElement("div",{className:"select-wrapper relative rounded-md "+(g?" f-1 ":r)},a.createElement("select",{id:p,title:d,style:{appearance:"none",paddingRight:"2em",background:"transparent",...I},value:x,required:h,onChange:A?e=>{A(e.target.value,e)}:void 0},L.map((({key:e,label:t},n)=>a.createElement("option",{key:n,value:e},t)))),R);return g?a.createElement("div",{className:"SELECT_ROOT w-fit "+(N?" flex-row ai-center ":" flex-col ")+r,style:u},a.createElement("label",{htmlFor:p,className:"noselect f-0 text-gray-500 ta-left "+(N?" mr-p5 ":" mb-p5 ")},g),k):k}}class List extends a.Component{render(){const{className:e="",style:t={},items:n,onReorder:l,onClose:o,selectedValue:i,checkedValues:s,anchorRef:r,anchorContent:c}=this.props,d=a.createElement("ul",{className:"list-comp f-1 o-auto min-h-0 min-w-0 no-scroll-bar"+e,role:"list",ref:e=>{e&&(this.refList=e)},style:{padding:0,...t}},n.length?n.map(((e,t)=>a.createElement("li",{key:t,role:"listitem",draggable:Boolean(l),onDrag:l?e=>{const t=e.currentTarget,n=t.parentElement;t.style.display="none";Array.from(n.children).map(((t,a)=>{const l=t.getBoundingClientRect();let o=e.clientY>l.y&&e.clientY<l.y+l.height;const i=o?"35px":"";i!==t.style.paddingTop&&(t.style.paddingTop=i),o&&(n._targetIdx=a)}));const a=n.getBoundingClientRect();e.clientY>a.y+a.height?n.scrollTop+=10:e.clientY<a.y&&(n.scrollTop-=10)}:void 0,onDragEnd:l?async e=>{const a=e.currentTarget,o=a.parentElement;let i=o._targetIdx,s=n.slice(0);var r,c,d;r=t,c=i,d=s.splice(r,1)[0],s.splice(c,0,d),await l(s),setTimeout((()=>{Array.from(o.children).map((e=>{e.style.paddingTop=""})),a.style.display="flex"}),1)}:void 0,className:"flex-row  p-p5 pointer "+(e.key===i?" selected ":""),onClick:e.onPress?t=>e.onPress(t):void 0,onKeyUp:e.onPress?t=>{"Enter"===t.key&&e.onPress(t)}:void 0},e.content||a.createElement(a.Fragment,null,e.contentLeft||null,a.createElement("label",{className:"mr-p5 f-1 flex-row pointer noselect",style:e.style},e.node||e.label||e.key),e.contentRight||null,s?a.createElement(Checkbox,{className:"f-0",checked:s.includes(e.key),style:{marginRight:"12px"}}):null)))):a.createElement("div",{className:"p-p5"},"No results"));let m,p;return r&&(m=r,p=d),c&&(m=this.popupAnchor,p=a.createElement("div",{className:"list-comp w-fit flex-col bg-white",style:{padding:0,margin:0,textDecoration:"none",listStyle:"none"}},a.createElement("div",{ref:e=>{e&&(this.popupAnchor=e)},className:"f-0 min-h-0 min-w-0 m-p5 flex-row jc-start "},p),d)),m&&p?a.createElement(Popup,{open:!0,rootStyle:{padding:0},anchorEl:m,positioning:"beneath-left",clickCatchStyle:{opacity:0},onClose:o,contentClassName:"rounded",focusTrap:!1},p):m||p?null:d}}const Xl=["End","PageDown","Clear","Home","PageUp","Insert"];class FormField extends a.Component{constructor(){super(...arguments),this.state={},this.setResizer=()=>{const{asTextArea:e,autoResize:t=!0}=this.props;if(this.rootDiv&&e&&t&&!this.textArea){const e=this.rootDiv.querySelector("textarea");e&&(this.textArea=e,e.addEventListener("input",this.resize,!1),setTimeout((()=>{this.resize()}),10))}},this.resize=()=>{if(this.textArea){const e=this.textArea,t=Math.min(100,e.scrollHeight),n=e.scrollWidth;let a=e.offsetWidth;a=Number.isFinite(a)&&a>=e.offsetWidth?a:e.offsetWidth;let l=e.offsetHeight;l=Number.isFinite(l)&&l>=e.offsetWidth?l:e.offsetHeight,a<n&&(e.style.width="",e.style.width=n+"px"),l<t&&(e.style.height="",e.style.height=t+"px")}},this.searchOptions=e=>{this.props.onSearchOptions&&this.props.onSearchOptions(e).then((e=>{this.setState({options:e})}))},this.mounted=!1,this.focus=e=>{},this.blur=e=>{},this.onChange=e=>{const{onChange:t,onSuggest:n}=this.props;if(!t)return;const a="file"===e.type?e.files:"checkbox"===e.type?e.checked:e.value;if(t(a),!n)return;this.changing&&clearTimeout(this.changing.timeout);const l=this.changing?100:0;this.changing={value:a,timeout:setTimeout((async()=>{if(this.mounted&&this.changing){const{onSuggest:e}=this.props,{value:t}=this.changing;if(e){const n=await e(this.changing.value);this.setState({suggestions:1===n.length&&n[0]===t?void 0:n})}this.changing=void 0}}),l)}},this.cursorPosition=0}componentDidMount(){this.mounted=!0,this.setResizer()}componentWillUnmount(){this.mounted=!1,this.textArea&&this.textArea.removeEventListener("input",this.resize,!1)}componentDidUpdate(e){const t=this.props.error,n=e.error;this.rootDiv&&e&&this.props&&(t||n)&&t!==n&&(this.rootDiv.scrollIntoViewIfNeeded?this.rootDiv.scrollIntoViewIfNeeded({block:"end",behavior:"smooth"}):this.rootDiv.scrollIntoView({block:"end",behavior:"smooth"})),this.setResizer(),e.value!==this.props.value&&(this.resize(),this.inputRef&&/text|password|search|tel|url/.test(this.inputRef.type)&&void 0!==this.cursorPosition&&(this.inputRef.selectionStart=this.cursorPosition,this.inputRef.selectionEnd=this.cursorPosition))}render(){var e,t,n,l,o,i,r,d;const{onChange:m,label:p,value:u,defaultValue:h,id:g=("checkbox"===this.props.type?v():void 0),options:f,required:E=!1,readOnly:b=!1,type:y="text",autoComplete:N="on",error:w,hint:S,placeholder:T,className:C="",inputClassName:_="",style:x={},inputStyle:A={},asTextArea:R=!1,asJSON:L,accept:O,onInput:I,asColumn:D=!0,rightIcons:k=null,rightContent:M=null,title:F,nullable:P=!1,multiSelect:H,labelAsValue:B,onSuggest:W,options:$=(null===(e=this.state)||void 0===e?void 0:e.options),fullOptions:U,name:q=(null===(t=this.props)||void 0===t?void 0:t.type),inputProps:j={},hideNullBtn:z=!1,maxWidth:Y="400px",rawValue:V,labelClass:G="",labelStyle:J={},showNumLockAlert:X=!0,inputContent:K}=this.props,{suggestions:Q,activeSuggestionIdx:Z=0,numLockAlert:ee}=this.state,te=[V,h,u].find((e=>void 0!==e));let ne=$?{width:"fit-content",minWidth:0}:{};const ae={pointerEvents:"none",touchAction:"none"};($||"checkbox"===y)&&b&&(ne={...ne,backgroundColor:"var(--gray-100)",...ae});let le={value:[void 0,null].includes(u)?"":u};b&&(le={value:u}),h&&(le={defaultValue:h});let oe=" font-semibold ";"checkbox"!==y&&(oe+=" bg-white ",ne={...ne}),y.startsWith("file")&&(oe+=" pointer ");let ie={};"color"===y&&u&&(ne={...ne,backgroundColor:u||"white",cursor:"pointer"},ie={opacity:0}),"checkbox"===y&&(le={checked:Boolean(u||h)},ne={...ne,minWidth:0,width:"fit-content",border:"none",overflow:"visible"}),(R||K)&&(ne={...ne,border:"none",overflow:"visible"}),oe+=" "+_;const se={id:g,key:g,ref:e=>{e&&(this.inputRef=e)},required:E,readOnly:b,className:oe,type:y,accept:O,..."file"!==y?le:void 0,autoComplete:N,onInput:I,placeholder:T,name:q,..."username"===y&&{autoCorrect:"off",autoCapitalize:"off"},...j,style:{...ie,...A,...j.style},onChange:({currentTarget:e})=>(this.cursorPosition=e.selectionStart,this.onChange(e)),onKeyDown:"number"===y&&X?e=>{var t;const n=!e.getModifierState("NumLock")&&(Xl.includes(e.key)||!e.currentTarget.value&&["ArrowRight","ArrowLeft"].includes(e.key));n!==this.state.numLockAlert&&this.setState({numLockAlert:n}),null===(t=null==j?void 0:j.onKeyDown)||void 0===t||t.call(j,e);const a=e.target;a.placeholder||/^-?\d+$/.test(u)||(a.placeholder="Numbers only")}:void 0,onFocus:(null==j?void 0:j.onFocus)?e=>{var t;null===(t=null==j?void 0:j.onFocus)||void 0===t||t.call(j,e)}:void 0,...y.startsWith("file")?{onDragOver:e=>{e.currentTarget.classList.toggle("active-drop-target",!0)},onDrop:e=>{e.currentTarget.classList.toggle("active-drop-target",!1)},onDragEnd:e=>{e.currentTarget.classList.toggle("active-drop-target",!1)},onDragExit:e=>{e.currentTarget.classList.toggle("active-drop-target",!1)},onDragLeave:e=>{e.currentTarget.classList.toggle("active-drop-target",!1)}}:{}},re=e=>{null==m||m(e),this.setState({suggestions:void 0})},ce=async()=>{if(W){const e=await W(u);this.setState({suggestions:e})}},de={width:"100%",minWidth:"5em",minHeight:"2em",whiteSpace:"pre-line",borderRadius:".5em",...se.style},me={..."file"!==se.type?{padding:window.isMobileDevice?"2px 6px":".5em .5em 4px .5em"}:{paddingBottom:"4px"},minHeight:window.isLowWidthScreen?"28px":"42px",...se.style,...null===V&&{fontStyle:"italic"}},pe=K||(L?a.createElement(CodeEditor,{key:(null===(n=L.schemas)||void 0===n?void 0:n.length)?L.schemas[0].id:void 0,className:se.className,style:{minHeight:(null===(l=se.value)||void 0===l?void 0:l.toString().length)?"100px":"26px",minWidth:"200px",borderRadius:".5em",flex:1,resize:"vertical",overflow:"auto",...se.style},options:{tabSize:2,minimap:{enabled:!1},lineNumbers:"off",automaticLayout:!0},value:u,language:"json",jsonSchemas:L.schemas,onChange:b?void 0:this.props.onChange}):"file"===y?a.createElement(Ro,{...se}):"checkbox"===y?a.createElement(Checkbox,{...se}):b?a.createElement("div",{className:"px-p5 py-p5 font-16 ",style:{fontWeight:500}},se.value):R?a.createElement("textarea",{...se,style:de}):a.createElement("input",{...se,...null===V&&{placeholder:"NULL"},style:me}));let ue,he;return k&&(ue=k),!b&&m&&P&&!z&&(he=a.createElement(Btn_Btn,{style:{borderRadius:0},color:null===te?"action":void 0,disabledInfo:null!==te?void 0:"Value is already NULL",title:"Set to NULL",onClick:e=>{null!==te&&m(null,e)}},"NULL")),a.createElement("div",{className:"form-field min-w-0 "+C,style:x,ref:e=>{e&&(this.rootDiv=e)},onBlur:()=>{Q&&this.setState({suggestions:void 0})},onKeyDown:e=>{var t,n;if(["text","search"].includes(y)&&"INPUT"===(null===(t=document.activeElement)||void 0===t?void 0:t.nodeName)&&(null===(n=this.refWrapper)||void 0===n?void 0:n.contains(document.activeElement)))if("Enter"===e.key)(null==Q?void 0:Q.length)&&Z>-1?re(Q[Z]):Q&&this.setState({suggestions:void 0});else if(["ArrowUp","ArrowDown"].includes(e.key)){if(null==Q?void 0:Q.length){let t=-1;["ArrowDown"].includes(e.key)&&(t=1);let n=Number.isFinite(Z)?Math.max(0,Z+t):0;n>Q.length-1&&(n=0),this.setState({activeSuggestionIdx:n})}else if(["ArrowDown"].includes(e.key)&&!u&&W)ce();else{const t=document.activeElement;if("number"!=typeof t.selectionStart)return;this.cursorPosition=t.selectionStart;const n=To(t.value),a=t.selectionStart,l=n.find((e=>"n"===e.type&&e.idx<=a&&e.idx+e.len>=a));if(l){this.inputSelStart=a;const o="ArrowUp"===e.key;t.value=n.map((t=>{if(t.idx===l.idx){let t=e.altKey?.1:e.ctrlKey?10:1,n=e.altKey?1:0,a=+l.val.split(".").map(((e,n,a)=>n<a.length-1?e:+e+(o?t:-t))).join(".");a=Math.max(a,0);let i=a.toFixed(l.decimalPlaces||n).padStart(l.len,"0");return l.decimalPlaces&&i.endsWith("."+new Array(l.decimalPlaces).fill("0").join(""))&&(i=i.slice(0,-l.decimalPlaces-1)),i}return t.val})).join(""),this.onChange(t)}else this.inputSelStart=void 0}e.preventDefault(),e.stopPropagation()}}},a.createElement("div",{className:("checkbox"===y||D?" ":" ai-center ")+(D?" flex-col ":" flex-row-wrap "),title:F,style:L?{minWidth:"400px"}:{}},p?a.createElement("label",{htmlFor:g,className:"main-label ta-left noselect text-gray-500 pl-p5 "+(g?" pointer ":" ")+G,style:{flex:.5,...b&&ae,...J}},p):null,a.createElement("div",{className:" flex-row f-1 ai-center min-w-0 "+(b?"":"pl-p5")},a.createElement("div",{className:Kl+" "+("checkbox"!==y?"flex-col":"flex-row")+" gap-p5 f-1 min-w-0 ",style:{maxWidth:"100%"}},a.createElement("div",{className:Ql+(K||"checkbox"===y?" ":" focus-border  ")+" h-fit flex-row relative  f-0 "+($||U?"w-fit":"w-full")+(w?" error ":""),ref:e=>{e&&(this.refWrapper=e)},style:{...ne,maxWidth:R?"100%":Y,...b&&{border:"unset",boxShadow:"unset"}}},Array.isArray(null!=$?$:U)?a.createElement(Select_Select,{className:"FormField_Select noselect f-1 bg-white",style:{background:"white",fontSize:"16px",fontWeight:600,paddingLeft:"6px"},fullOptions:null!==(i=null!==(o=null==$?void 0:$.map((e=>({key:e}))))&&void 0!==o?o:U)&&void 0!==i?i:[],onSearch:(null===(r=this.props)||void 0===r?void 0:r.onSearchOptions)?e=>this.searchOptions(e):void 0,onChange:m?e=>{m(e)}:void 0,value:te,required:E,multiSelect:H,labelAsValue:B}):pe,(null===(d=this.props)||void 0===d?void 0:d.onSuggest)&&Q?a.createElement(List,{anchorRef:this.refWrapper,selectedValue:Q[Z],items:Q.map((e=>({key:e,node:null===e?a.createElement("i",null,"NULL"):""===e.trim()?a.createElement("i",null,"Empty"):null,onPress:t=>{re(e)}}))),onClose:()=>{this.setState({suggestions:void 0})}}):null,ue||he?a.createElement("div",{className:"flex-row ai-start jc-center "+("checkbox"===y||R||K?" ":"  bl b-gray-300 "),style:{right:"2px",top:0,bottom:0,background:"white"}},ue,he):null,w?a.createElement(c(),{className:"text-red-500 absolute bg-white",path:s._gM,style:{width:"1.5rem",top:"2px",bottom:"2px",height:"calc(100% - 4px)",right:"6px"}}):null),(S||w||ee)&&a.createElement("div",{className:"flex-col jc-center"},ee&&a.createElement(Zt,{variant:"naked",className:"font-10",iconSize:.75},"NumLock is off"),w?a.createElement(ErrorComponent,{error:w,style:{padding:0},findMsg:!0}):null,S&&a.createElement("p",{className:"pointer ta-left text-gray-400 m-0 text-sm noselect ws-pre-line",onClick:e=>{var t,n;const a=null===(t=e.currentTarget.closest(`.${Kl}`))||void 0===t?void 0:t.querySelector(`.${Ql} > *`);null===(n=null==a?void 0:a.click)||void 0===n||n.call(a)}},S))),M?a.createElement("div",{className:"f-0"},M):null)))}}const Kl="input-hint-wrapper",Ql="input-wrapper",Zl=({inputType:e,elemTsType:t,values:n,onChange:l})=>a.createElement("div",{className:"flex-row-wrap gap-p5 ptd-p25 ai-center"},n.map(((o,i)=>{var s;const r=Math.max(2,(null!==(s=null==o?void 0:o.toString())&&void 0!==s?s:"").length)+2;return a.createElement(Chip,{key:i,className:"focus-border",style:{background:"transparent"},onDelete:()=>(e=>{const t=[...n];t.splice(e,1),l(t)})(i)},a.createElement("input",{className:"bg-transparent b b-b",value:o,type:e,style:{width:`${r}ch`,minWidth:"Date"===t?"250px":"50px",maxWidth:"300px",minHeight:"boolean"===t?"20px":void 0},onChange:({target:{value:e}})=>{l(n.map(((t,n)=>n===i?e:t)))}}))})),a.createElement(Btn_Btn,{color:"action",variant:"outline",iconPath:s.qX5,onClick:()=>{l([...n,"number"===t?1:"Date"===t?new Date:"boolean"===t||""])}})),eo=[["years","y"],["months","mo"],["weeks","w"],["days","d"],["hours","h"],["minutes","min"],["seconds","s"],["milliseconds","ms"]],to=(e,t=!1,n)=>{let a=!1;const l=eo.map((([l,o])=>{let i=(e||{})[l];if(Number.isFinite(i))return a=i<0,n&&(i=Math.abs(i)),`${i}${t?o:" "+l}`})).filter((e=>e)).join(" ")||"0 seconds";return n?`${a?"In ":""}${l}${a?"":" ago"}`:l},no=e=>{const t=nl(e)?["",""]:"years"in e?[`${e.years}y`,"-red-500"]:"months"in e?[`${e.months}mo`,"-red-500"]:"weeks"in e?[`${e.weeks}w`,"-yellow-500"]:"days"in e?[`${e.days}d`,"-yellow-500"]:"hours"in e?[`${e.hours}h`,"-green-500"]:"minutes"in e?[`${e.minutes}min`,"-green-500"]:"seconds"in e?[`${e.seconds}s`,"-green-500"]:"milliseconds"in e?[`${e.milliseconds}ms`,"-green-500"]:[(0,m.getKeys)(e).map((t=>`${e[t]} ${t}`)).join(","),"-gray-500"];return a.createElement("span",{title:JSON.stringify(e).slice(1,-1),className:`text${t[1]}`},t[0]||"0s"," ago")},ao=({guid:e})=>{const[t,n]=(0,a.useState)(!1);return a.createElement("div",{className:"flex-row gap-1 ai-center"},e?a.createElement(a.Fragment,null,a.createElement("div",{className:"guid-text f-1",style:{color:oo({tsDataType:"string",udt_name:"uuid"})}},e.substring(0,8),"...",e.substring(e.length-8)),a.createElement(Btn_Btn,{className:"guid-button f-0 show-on-parent-hover",size:"micro",color:"action",variant:"outline",onClick:()=>{navigator.clipboard.writeText(e),n(!0)}},t?"Copied!":"Copy")):a.createElement("i",null,"NULL"))};class SmartFormField extends RTComp{constructor(){super(...arguments),this.state={showDateInput:!0,insertMode:!1,loaded:!1},this.wasChanged=!1,this.onDelta=async(e,t,n)=>{var a,l,o,i;const{tableName:s,db:r,column:c,showSuggestions:d,tables:m,action:p}=this.props,{columnName:u}=this.state;let h={};if(r&&c&&u!==c.name){const e=async e=>{const{term:t,col:n,table:a}=e;return SmartFormField.getSuggestions({db:r,table:a,col:n,term:t})};let t,n;if((null===(a=c.references)||void 0===a?void 0:a.length)&&"view"!==p){const{fcols:a,ftable:i}=c.references[0];if(i&&1===a.length&&(null===(l=null==r?void 0:r[i])||void 0===l?void 0:l.find)){const l=a[0],s=null===(o=m.find((e=>e.name===i)))||void 0===o?void 0:o.columns.find((e=>e.name===l));t=await e({term:"",col:s,table:i}),t.length>1&&t.length>=20&&(n=async t=>{const n=await e({term:t,col:s,table:i});this.setState({options:n})})}}else"string"===c.tsDataType&&d&&s&&(null===(i=r[s])||void 0===i?void 0:i.find)&&(this.onSuggest=async t=>await e({term:t,col:c,table:s}));h={columnName:c.name,options:t,onSearchOptions:n}}this.state.loaded||(h.loaded=!0),h&&this.setState(h)},this.onChange=async e=>{const{column:t,tableInfo:n,onChange:a}=this.props;if(this.wasChanged=!0,!t&&!n)return;let l=e;(null==n?void 0:n.has_media)&&console.error("What/why was supposed to happen here?"),""===e&&["Date","number","boolean","Object"].includes(null==t?void 0:t.tsDataType)&&(null==t?void 0:t.is_nullable)&&(l=null);let o=null;if(t)try{l=SmartFormField.parseValue(t,e,!0)}catch(e){o=e}t&&!(null==n?void 0:n.has_media)&&("number"==typeof t.min&&"number"==typeof l&&l<t.min?l=Math.max(l,t.min):"number"==typeof t.max&&"number"==typeof l&&l>t.max&&(l=Math.min(l,t.max)));try{await(null==a?void 0:a(l))}catch(e){o=e.toString()}this.setState({error:o,newValue:l})}}static getInputType(e){return e.udt_name.startsWith("timestamp")?"datetime-local":"time"===e.udt_name?"time":"boolean"===e.tsDataType?"checkbox":["email"].includes(e.name)?"email":["phone","telephone","phone_number","tel"].includes(e.name)?"tel":["zip_code","zipcode","post_code","postcode"].includes(e.name)?"postal-code":["given-name","first_name","first-name"].includes(e.name)?"given-name":["family-name","last_name","last-name"].includes(e.name)?"family-name":["address_line1","address_line"].includes(e.name)?"address-line1":["address_line2"].includes(e.name)?"address-line2":"string"===e.tsDataType?"text":e.tsDataType}static getInputAutocomplete(e){const t=["address-line1","address-line2","address-line3","street_address","street","address","address-level1","address-level2","address-level3","address-level4","organization","organization-title","country","country-name","postal-code","tel","given-name","family-name","email"];return t.concat(t.map((e=>e.replaceAll("-","_")))).includes(e.name.toLowerCase())?e.name.replaceAll("_","-").toLowerCase():"on"}static renderValue(e,t="",n=!0,l){var o;if([null,void 0].includes(t))return a.createElement("i",{className:"text-gray-400  noselect",title:n?"NULL":void 0},"NULL");const i=(e,t)=>l?Gl(null==e?void 0:e.toString(),null!=t?t:l):e;if("uuid"===(null==e?void 0:e.udt_name)&&t)return a.createElement(ao,{guid:t});if("number"===(null==e?void 0:e.tsDataType)&&t)return a.createElement("span",{style:{color:oo(e)}},i((+t).toLocaleString()));if("interval"===(null==e?void 0:e.udt_name))return to(t);if(t&&["geography","geometry"].includes(null!==(o=null==e?void 0:e.udt_name)&&void 0!==o?o:""))return"object"!=typeof t||Array.isArray(t)?i(t):i(JSON.stringify(t));if(t&&"Date"===(null==e?void 0:e.tsDataType)){let n=t,l={day:"2-digit",month:"2-digit",year:"numeric",weekday:"short"};try{e.udt_name.startsWith("timestamp")&&(l={dateStyle:"short",timeStyle:"short"});n=(e=>cl(e)+` ${rl(e.getHours())}:${rl(e.getMinutes())}:${rl(e.getSeconds())}`)(new Date(t))}catch(e){console.error(e)}return a.createElement("span",{style:{color:oo(e)}},n)}return t&&((null==e?void 0:e.udt_name.startsWith("json"))||(0,m.isObject)(t))?a.createElement("span",{style:{color:oo(e)}},i(JSON.stringify(t))):"boolean"==typeof t?a.createElement("span",{style:{color:oo({...e,tsDataType:"boolean",udt_name:"bool"})}},t.toString()):"string"==typeof t?""===t?a.createElement("i",{className:"text-gray-400 noselect",title:n?"&quot;&quot;":void 0},"Empty String"):a.createElement(a.Fragment,null,i(t)):Array.isArray(t)?a.createElement("div",{className:"flex-row-wrap gap-p25"},t.map(((e,t)=>a.createElement("span",{key:t,className:"chip gray font-14"},i(e))))):a.createElement(a.Fragment,null,i(t))}static parseValue(e,t,n=!1){if(n)return t;if(t){if("interval"===(null==e?void 0:e.udt_name)&&"string"!=typeof t)return to(t);const a=(e,t=!1)=>{let n=new Date(e).toISOString();return t?n:n.slice(0,-5)};if((null==e?void 0:e.udt_name.startsWith("json"))||(null==e?void 0:e.udt_name.startsWith("geo"))){if("string"==typeof t)return t;if(n)return"object"==typeof t?t:JSON.parse(t);try{return JSON.stringify("object"==typeof t?t:JSON.parse(t),null,2)}catch(e){return"string"==typeof t?t:t+""}}if(e.udt_name.startsWith("geo")&&"object"==typeof t&&!Array.isArray(t))return JSON.stringify(t);let l="string"==typeof t?t:+t;if("date"===e.udt_name)return new Date(l).toISOString().split("T")[0];if(e.udt_name.startsWith("timestamp"))return a(l,"timestamptz"===e.udt_name);if(Array.isArray(t)&&e.udt_name.includes("timestamp"))return t.filter((e=>""!==e)).map((t=>a(t,e.udt_name.endsWith("z"))))}return t}static parseDefaultValue(e,t,n){if(!e||n)return t;if(![null,void 0].includes(t))return t;if(e.is_nullable&&null===t)return t;if(e.has_default&&"string"==typeof e.column_default){if(e.column_default.endsWith("::text"))return e.column_default.slice(1,-7);if(["now()","CURRENT_TIMESTAMP"].includes(e.column_default))return"date"===e.udt_name?(new Date).toISOString().split("T")[0]:(new Date).toISOString().slice(0,-5);if("number"===e.tsDataType)return Number(e.column_default)}else if(t)return SmartFormField.parseValue(e,t);return t}render(){var e,t,n;const{action:l,value:o,inputStyle:i={},placeholder:r="",variant:c,multiSelect:d,column:m,tableInfo:p,rightContent:u,hideNullBtn:h,sectionHeader:g,style:f,tableName:E,maxWidth:v="100vw"}=this.props,b="rawValue"in this.props?this.props.rawValue:o,{error:y,options:N,showDateInput:w,onSearchOptions:S,loaded:T,collapsed:C}=this.state;if(!m&&!p)return a.createElement(Loading,null);if(!m)return a.createElement(Loading,null);let _,x=null,A=null;try{_=SmartFormField.parseValue(m,o)}catch(e){_=o,A=e.toString()}const R="geometry"===(null==m?void 0:m.udt_name)||"geography"===(null==m?void 0:m.udt_name);"Date"===(null==m?void 0:m.tsDataType)?x=a.createElement(Btn_Btn,{title:w?"Edit as text":"Edit with picker",iconPath:w?s.H3X:s.xnT,className:"h-full",onClick:()=>this.setState({showDateInput:!w}),size:"small"}):R&&(x=a.createElement(M,{style:{height:"100%",borderRight:"1px solid var(--gray-300)"},button:a.createElement(Btn_Btn,{title:"Use my current location",iconPath:s.jlh,className:"h-full",onClick:()=>this.setState({showDateInput:!w}),size:"small"}),content:a.createElement("p",null,"You will have to allow your browser to use your location data"),footerButtons:[{color:"action",label:"OK",onClick:()=>{try{navigator.geolocation.getCurrentPosition((e=>{var t=e.coords.latitude,n=e.coords.longitude;null==t?alert("GPS not activated!"):this.onChange({ST_GeomFromEWKT:[`SRID=4326;POINT(${n} ${t})`]})}))}catch(e){alert("Something went wrong: "+e.toString())}}},{label:"No thanks",onClickClose:!0}]}));const L="compact"===c;const O=lo(l,m);O&&(x=null);let I=m.hint;if(!O&&m.has_default&&m.is_pkey&&"insert"===l&&(I=I||"Column has default value. Can leave empty",!C))return a.createElement(Btn_Btn,{className:"mt-1",title:"Expand",iconPath:s.XMI,onClick:()=>{this.setState({collapsed:!C})}});let D=SmartFormField.getInputType(m).toLowerCase();D.startsWith("date")&&!w&&(D="text");const k=SmartFormField.getInputAutocomplete(m),F=O&&"update"===l,P=(null===(e=m.udt_name)||void 0===e?void 0:e.startsWith("json"))?m.jsonSchema?{schemas:[{id:`${E}_${m.name}`,schema:m.jsonSchema}]}:{}:void 0,H=g?a.createElement("h4",{className:"noselect",style:{marginBottom:"0.5em"}},g):null;let B=null;if(m.tsDataType.endsWith(">")&&!m.tsDataType.includes("Object")){const e=null!==(n=null===(t=m.tsDataType.split("<")[1])||void 0===t?void 0:t.split(">")[0])&&void 0!==n?n:"string";let l=SmartFormField.getInputType({name:m.name,udt_name:m.udt_name.slice(1),tsDataType:e}).toLowerCase();B=a.createElement(Zl,{elemTsType:e,inputType:l,values:_||[],onChange:this.onChange})}return a.createElement(a.Fragment,null,H,!T&&a.createElement(Loading,{variant:"cover"}),a.createElement(FormField,{id:E+"-"+m.name,style:f,className:(F?" cursor-default ":"")+(L?"":"mt-1"),inputClassName:F?" cursor-default ":"",maxWidth:v,inputStyle:{...i,minWidth:0,..."checkbox"===D?{padding:"1px"}:L?{padding:"2px 6px"}:{}},key:m.name,placeholder:r,type:D,autoComplete:k,label:L?void 0:m.label,value:_,rawValue:b,options:N,title:F?"You are not allowed to update this field":"",asJSON:P,asTextArea:"string"===m.tsDataType&&"string"==typeof o&&(o.length>50||o.split("\n").length>1),readOnly:O,multiSelect:d,onChange:this.onChange,error:this.props.error||y,inputContent:B,rightIcons:x,rightContent:u,labelAsValue:!0,onSearchOptions:S,onSuggest:this.onSuggest,nullable:m.is_nullable,inputProps:{min:m.min,max:m.max},hint:I,hideNullBtn:h,asColumn:"column"===c}))}}SmartFormField.getSuggestions=async e=>{var t,n,a;const{db:l,table:o,term:i,col:s,groupBy:r=!0,filter:c}=e,d=l[o];if(!(null==d?void 0:d.find))return console.error("Invalid column provided"),[];const m=(i||"").trimStart();try{let e={$and:[c,m?{[s.name]:{$ilike:`%${m}%`}}:{}].filter((e=>e))};const l=await d.find(e,{select:{[s.name]:1},groupBy:r,returnType:"values",limit:20});if(!l.includes("")&&"string"===s.tsDataType&&"uuid"!==s.udt_name){await(null===(t=d.findOne)||void 0===t?void 0:t.call(d,{[s.name]:""},{select:{[s.name]:"$trim"}}))&&l.unshift("")}if(!l.includes(null)){+(null!==(a=await(null===(n=d.count)||void 0===n?void 0:n.call(d,{[s.name]:null})))&&void 0!==a?a:"0")&&l.unshift(null)}return l}catch(e){return console.error(e),[]}};const lo=(e,t)=>"view"===e||"update"===e&&!t.update||"insert"===e&&!t.insert,oo=(e,t)=>{var n;if("uuid"===(null==e?void 0:e.udt_name))return"#57083f";if("json"===(null==e?void 0:e.udt_name)||"jsonb"===(null==e?void 0:e.udt_name)||"any"===(null==e?void 0:e.tsDataType))return"#0451a5";return null!==(n=(null==e?void 0:e.tsDataType)?{number:"rgb(0 110 0)",Date:"rgb(25 91 239)",boolean:"#0000ff"}[e.tsDataType]:void 0)&&void 0!==n?n:t};class Success extends a.Component{render(){const{className:e=""}=this.props;return a.createElement("div",{...this.props,className:"custom-animations success-checkmark "+e},a.createElement("div",{className:"check-icon"},a.createElement("span",{className:"icon-line line-tip"}),a.createElement("span",{className:"icon-line line-long"}),a.createElement("div",{className:"icon-circle"}),a.createElement("div",{className:"icon-fix"})))}}class SuccessSVG extends a.Component{render(){const{className:e=""}=this.props;return React.createElement("svg",{...this.props,className:"custom-animations checkmark "+e,xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 52 52"},React.createElement("circle",{className:"checkmark__circle",cx:"26",cy:"26",r:"25",fill:"none"}),React.createElement("path",{className:"checkmark__check",fill:"none",d:"M14.1 27.2l7.1 7.2 16.7-16.8"}))}}const io=({message:e,className:t="",...n})=>a.createElement("div",{...n,className:"SuccessMessage text-green-600 p-1 flex-col jc-center ai-center "+t},a.createElement("div",{className:"text-green-600 p-1 flex-col mb-p5 capitalize"},e),a.createElement(Success,null)),so=({setData:e,action:t,enableInsert:n,column:l,tables:o,db:i,hideNullBtn:r,referencedInsertData:c,setReferencedInsertData:d})=>{var p,u,h,g,f,E,v,b,y,N;const w=lo(t,l),[S,T]=(0,a.useState)(),[C,_]=(0,a.useState)(!1),x=null===(u=null===(p=l.references)||void 0===p?void 0:p[0])||void 0===u?void 0:u.ftable,A=x?null===(h=o.find((e=>e.name===x)))||void 0===h?void 0:h.columns:void 0,R=x&&1===(null===(E=null===(f=null===(g=l.references)||void 0===g?void 0:g[0])||void 0===f?void 0:f.fcols)||void 0===E?void 0:E.length)?null==i?void 0:i[x]:void 0,L=null===(b=null===(v=l.references)||void 0===v?void 0:v[0])||void 0===b?void 0:b.fcols[0],O=n&&(null==R?void 0:R.insert)?x:void 0;let I=null;if(O)if(l.file&&"insert"===t){let e={};"acceptedContent"in l.file&&Array.isArray(l.file.acceptedContent)&&l.file.acceptedContent.length?e.accept=l.file.acceptedContent.map((e=>`${e}/*`)).join()+","+l.file.acceptedContent.flatMap((e=>(0,m.getKeys)(m.CONTENT_TYPE_TO_EXT).filter((t=>t.startsWith(e))).flatMap((e=>m.CONTENT_TYPE_TO_EXT[e])).flat())).map((e=>`.${e}`)).join(","):"acceptedContentType"in l.file&&Array.isArray(l.file.acceptedContentType)&&l.file.acceptedContentType.length?e.accept=l.file.acceptedContentType.flatMap((e=>(0,m.getKeys)(m.CONTENT_TYPE_TO_EXT).filter((t=>t===e)).flatMap((e=>m.CONTENT_TYPE_TO_EXT[e])).flat())).map((e=>`.${e}`)).join(","):"acceptedFileTypes"in l.file&&Array.isArray(l.file.acceptedFileTypes)&&l.file.acceptedFileTypes.length&&(e.accept=`${l.file.acceptedFileTypes.map((e=>`.${e}`)).join(",")}`),I=a.createElement("div",{className:"w-fit h-fit"},a.createElement(Btn_Btn,{iconPath:s.v5N,color:"action",title:"Attach file",onClick:e=>{var t,n;const a=null===(n=null===(t=e.currentTarget)||void 0===t?void 0:t.parentElement)||void 0===n?void 0:n.querySelector("input");a&&a.click()}}),a.createElement("input",{...e,type:"file",className:"m-0 p-0 hidden",style:{width:0,height:0,opacity:0},onChange:e=>{var t;const n=null===(t=e.currentTarget.files)||void 0===t?void 0:t[0];d(l,n?{name:n.name,data:n}:void 0)}}))}else I=a.createElement(Btn_Btn,{iconPath:s.qX5,onClick:()=>{T(O)}});let D=null;if("view"!==t&&(null==R?void 0:R.find)&&A){D=A.length>1?a.createElement(Btn_Btn,{iconPath:s.RSU,title:"Find record",onClick:()=>_(!0)}):null}let k=null;(I||D)&&(k=a.createElement("div",{className:"flex-row"},D,I));let M=null;if(C){const t=x,n=null===(N=null===(y=null==l?void 0:l.references)||void 0===y?void 0:y[0])||void 0===N?void 0:N.fcols;M=a.createElement(SmartTable,{allowEdit:!0,title:`Find ${t} record`,db:i,tables:o,tableName:t,onClickRow:t=>{t&&(w?alert("Cannot change value. This field is read only"):e(l,t[n[0]]),_(!1))},onClosePopup:()=>{_(!1)}})}return a.createElement(a.Fragment,null,M,k,S&&a.createElement(SmartForm,{key:"referenced-insert",asPopup:!0,tables:o,db:i,hideNullBtn:r,tableName:S,hideChangesOptions:!0,onClose:()=>{T(void 0)},onInserted:t=>{const n=Array.isArray(t)?t[0]:t;n&&e(l,n[L])},..."insert"===t?{defaultData:null==c?void 0:c.data,onBeforeInsert:e=>{const t=Array.isArray(e)?e[0]:e;d(l,t),T(void 0)}}:{}}))};const ro=function({onChange:e,columns:t,value:n,fields:l,style:o={},className:i="",buttonClassName:r="",btnProps:c}){const d=(t,n=!0)=>{if(!t)return;e({key:t,asc:null==n||n})};if(null==l?void 0:l.length){const e=l.filter((e=>t.every((t=>t.name!==e))));(null==e?void 0:e.length)&&console.warn("Bad fields provided for SortByControl: ",e)}const m=t.filter((e=>e.filter&&(!l||l.includes(e.name)))),p=!!(null==n?void 0:n.asc),u=null==n?void 0:n.key;return a.createElement("div",{className:"Select flex-row gap-p25 min-h-0 f-0 relative ai-center "+i,style:o},a.createElement(Select_Select,{id:"orderbycomp",buttonClassName:"shadow "+r,btnProps:c,emptyLabel:"Sort by...",asRow:!0,value:null==n?void 0:n.key,fullOptions:m.map((e=>({key:e.name,label:e.label||e.name}))),onChange:e=>{d(e,p)}}),u&&a.createElement(Btn_Btn,{color:"action",iconPath:p?s.O0z:s.q5T,onClick:()=>{d(u,!p)}}))},co=(e,t)=>e?e.filter((e=>!t||(!!t.some((t=>"string"==typeof e?t.name===e:e.select||e.name===t.name))||(console.warn("Bad/invalid column name provided: ",e),!1)))).reduce(((e,t)=>({...e,["string"==typeof t?t:t.name]:"string"!=typeof t&&t.select?t.select:1})),{}):"*";class SmartCardList extends RTComp{constructor(){super(...arguments),this.state={items:[],loading:!0},this.onDelta=async()=>{var e,t,n;const{tableName:a,db:l,columns:o}=this.props,i=l[a];let s=null!=o?o:this.state.columns;if(this.state.columns||(null!=s||(s=await(null===(e=null==i?void 0:i.getColumns)||void 0===e?void 0:e.call(i))),this.setState({columns:s})),"data"in this.props)this.setState({items:this.props.data});else{const{filter:e={},limit:a=20,fieldConfigs:l}=this.props,o=null!==(t=this.state.orderBy)&&void 0!==t?t:this.props.orderBy,r=async()=>{this.setState({loading:!0});try{if(!(null==i?void 0:i.find))throw new Error("tableHandler.find missing");const t=await i.find(e,{limit:a,orderBy:o,select:co(l,s)});this.setState({items:t,loading:!1,loaded:!0})}catch(e){this.setState({error:e,loading:!1})}},c=ProstglesTable.getDataRequestSignature({filter:e,orderBy:o});if(c!==this.dataSignature&&(null==i?void 0:i.find))if(this.dataSignature=c,this.props.realtime){if(await(null===(n=this.sub)||void 0===n?void 0:n.unsubscribe()),!(null==i?void 0:i.subscribe))throw new Error("tableHandler.subscribe missing");this.sub=await i.subscribe(e,{limit:a,select:""},(()=>{r()}))}else r()}}}render(){var e,t,n;const{tableName:l,db:o,className:i="",style:r={},disableVariantToggle:c=!0,popupFixedStyle:d,fieldConfigs:p,footer:u,excludeNulls:h,tables:g,noDataComponent:f,noDataComponentMode:E,title:v}=this.props,{columns:b,loading:y,items:N,error:w,loaded:S}=this.state;if(w)return a.createElement(ErrorComponent,{error:w});this.state.variant||this.props.variant;if(!b||!N)return a.createElement(Loading,null);let T=N.map(((e,t)=>{let n=null;return"onChange"in this.props&&(n=a.createElement(Btn_Btn,{iconPath:s.x9U,color:"danger",className:"absolute",style:{top:"5px",right:"5px"},onClick:()=>{"onChange"in this.props&&this.props.onChange&&this.props.onChange(this.props.data.filter(((e,n)=>n!==t)))}})),a.createElement("div",{className:"relative",key:t},a.createElement(SmartCard,{db:o,tableName:l,defaultData:e,tables:g,columns:b,disableVariantToggle:c,excludeNulls:h,popupFixedStyle:d,fieldConfigs:p,onChanged:()=>{this.dataSignature="z",this.forceUpdate()},footer:u,showViewEditBtn:"showEdit"in this.props?this.props.showEdit:void 0}),n)}));if(!S)return null;if(f&&!y&&!N.length&&(T=f,"hide-all"===E))return f;const C="data"in this.props?void 0:null!==(e=this.state.orderBy)&&void 0!==e?e:this.props.orderBy,_=!("data"in this.props)&&(null===(t=this.props.tables.find((e=>e.name===this.props.tableName)))||void 0===t?void 0:t.columns.some((e=>e.insert))),x=a.createElement("div",{className:"flex-row-wrap gap-p5 ai-end py-p25",style:{justifyContent:"space-between"}},"string"==typeof v?a.createElement("h4",{className:"m-0"},v):v,!("data"in this.props)&&0!==(null===(n=this.props.orderByfields)||void 0===n?void 0:n.length)&&a.createElement(ro,{btnProps:"gray"===this.props.btnColor?{color:"default",variant:"faded"}:{},fields:this.props.orderByfields,columns:b,value:C?{key:(0,m.getKeys)(C)[0],asc:Object.values(C)[0]}:void 0,onChange:e=>{this.setState({orderBy:{[e.key]:!!e.asc}})}}),_&&a.createElement(dn,{buttonProps:{},db:o,tables:g,tableName:this.props.tableName}));return a.createElement("div",{className:"SmartCardList flex-col o-auto p-p25 gap-p5 relative "+i,style:r},y&&a.createElement(Loading,{variant:"cover"}),x,T)}}class JoinedRecords extends RTComp{constructor(){super(...arguments),this.state={sections:[],expanded:!1},this.getDataSignature=()=>{const{tableName:e,rowFilter:t}=this.props;return JSON.stringify({tableName:e,rowFilter:t})},this.getNestedInsertPopup=()=>{var e;const{tables:t,tableName:n,db:l,onSetNestedInsertData:o}=this.props,{nestedInsertTable:i}=this.state;if(this.isInsert&&i&&o){const s=null===(e=t.find((e=>e.name===i)))||void 0===e?void 0:e.columns;return a.createElement(Popup,{open:!0,title:`Insert ${i} record`,positioning:"right-panel",onClose:()=>{this.setState({nestedInsertTable:void 0})},contentStyle:{padding:0},footerButtons:[{label:"Add",variant:"filled",color:"action",onClick:()=>{var e;null===(e=this.refNestedForm)||void 0===e||e.getErrors((e=>{var t,n;console.log(e);const a=null!==(n=null===(t=this.state.nestedInsertData)||void 0===t?void 0:t[i])&&void 0!==n?n:[];a.push(e),this.setState({nestedInsertData:{...this.state.nestedInsertData,[i]:a},nestedInsertTable:void 0},(()=>{o(this.state.nestedInsertData)}))}))}},{label:"Remove",color:"danger",onClick:()=>{var e;null===(e=this.refNestedForm)||void 0===e||e.getErrors((e=>{console.log(e)}))}}]},a.createElement(SmartForm,{getRef:e=>{e&&(this.refNestedForm=e)},label:" ",tableName:i,db:l,tables:t,onChange:()=>{},columns:null==s?void 0:s.filter((e=>{var t;return!(null===(t=e.references)||void 0===t?void 0:t.some((e=>e.ftable===n)))})).map((e=>e.name))}))}}}getDetailedFilter(e){const{tableName:t,rowFilter:n=[]}=this.props;return n.map((({fieldName:n,type:a,value:l})=>{const o={fieldName:n,value:l,type:a,minimised:!0};return e===t?o:{type:"$existsJoined",path:[t],filter:o,minimised:!0}}))}getJoinFilter(e){return Vl(this.getDetailedFilter(e))}async onDelta(e,t,n){const{tables:a,db:l,tableName:o,showLookupTables:i=!0}=this.props,s=a.find((e=>e.name===o)),r=this.getDataSignature();if(s&&r!==this.dataSignature){this.dataSignature=r;const e=s.joins.slice(0,0);s.joins.forEach((t=>{var n,l;(null===(l=null===(n=a.find((e=>e.name===t.tableName)))||void 0===n?void 0:n.columns)||void 0===l?void 0:l.every((e=>t.on.some((t=>t[1]===e.name)))))?i&&e.push(t):e.unshift(t)}));const t=await Promise.all(e.map((async e=>{var t,n,a,o,i,s;const r=this.isInsert?0:parseInt(null!==(o=null===(a=await(null===(n=null===(t=l[e.tableName])||void 0===t?void 0:t.count)||void 0===n?void 0:n.call(t,this.getJoinFilter(e.tableName))))||void 0===a?void 0:a.toString())&&void 0!==o?o:"0");let c=(null===(i=l[e.tableName])||void 0===i?void 0:i.insert)&&e.hasFkeys;return{label:e.tableName,tableName:e.tableName,existingDataCount:r,canInsert:c,expanded:null===(s=this.state.sections.find((t=>t.tableName===e.tableName)))||void 0===s?void 0:s.expanded}})));this.setState({sections:t})}}get isInsert(){return!Boolean(this.props.rowFilter)}get tableHandler(){const{db:e,tableName:t}=this.props;return e[t]}getAddButton(e){const{rowFilter:t,tables:n,db:l,onSetNestedInsertData:o}=this.props,i=!!o&&!Boolean(t),r=n.some((t=>{var n;return t.columns.some((t=>{var n;return null===(n=t.references)||void 0===n?void 0:n.some((t=>t.ftable===e.tableName))}))&&(null===(n=l[t.name])||void 0===n?void 0:n.insert)}));if(i&&r)return l[e.tableName]?a.createElement(Btn_Btn,{key:e.tableName,title:"Add referenced record",color:"action",iconPath:s.qX5,onClick:()=>{this.setState({nestedInsertTable:e.tableName})}}):null;const{tableName:c}=this.props;return a.createElement(Btn_Btn,{iconPath:s.qX5,title:"Add new record",disabledInfo:e.canInsert?void 0:`Cannot reference more than one ${JSON.stringify(c)}`,onClick:async()=>{var t,a;const l=await(null===(a=null===(t=this.tableHandler)||void 0===t?void 0:t.findOne)||void 0===a?void 0:a.call(t,Vl(this.props.rowFilter))),o=n.find((e=>e.name===c)),i=null==o?void 0:o.joins.find((t=>t.tableName===e.tableName));if(l&&i){let t={};i.on.map((([e,n])=>{t[n]=l[e]})),this.setState({insert:{table:e.tableName,data:t}})}}})}render(){var e;const{sections:t,insert:n,quickView:l,expanded:o,nestedInsertData:i}=this.state,{db:r,tables:c,tableName:d,onAddTable:m,onSetNestedInsertData:p,showRelated:u,style:h,className:g="",action:f}=this.props;let E=null;l&&(E=a.createElement(SmartTable,{db:r,tableName:l.tableName,tables:c,filter:this.getDetailedFilter(l.tableName),onClosePopup:()=>{this.setState({quickView:void 0})}}));let v=null;if(n&&(null===(e=r[n.table])||void 0===e?void 0:e.insert)){const e=()=>{this.dataSignature=void 0,this.setState({insert:void 0})};v=a.createElement(SmartForm,{db:r,label:`Insert ${n.table} record`,hideChangesOptions:!0,showLocalChanges:!1,tableName:n.table,asPopup:!0,tables:c,defaultData:n.data,onInserted:e,onClose:e})}if(!t.length)return null;if("insert"===f&&t.every((e=>!e.canInsert)))return null;const b=c.filter((e=>e.columns.some((e=>{var t;return null===(t=e.references)||void 0===t?void 0:t.some((e=>e.ftable===d))})))),y=b.filter((e=>{var t;return null===(t=r[e.name])||void 0===t?void 0:t.insert})).map((e=>e.name));return a.createElement("div",{className:"flex-col b-top min-h-0 "+g,style:h},a.createElement("h4",{title:"Toggle section",onClick:()=>this.setState({expanded:!o}),className:"m-0 pointer noselect ta-left f-0 ws-pre flex-row ai-center gap-1 p-1 text-gray-500"},a.createElement("div",{className:""},"Referenced data "),t.length>1&&a.createElement("span",{className:"text-gray-500 font-18",style:{fontWeight:"lighter"}},t.reduce(((e,t)=>e+t.existingDataCount),0))),E,v,this.getNestedInsertPopup(),o&&a.createElement("div",{className:"flex-col o-auto f-1 px-1 "},t.filter((e=>!u||b.some((t=>t.name===e.tableName)))).map(((e,n)=>{var l,o,d;const u=null!==(o=this.isInsert?null===(l=null==i?void 0:i[e.tableName])||void 0===l?void 0:l.length:e.existingDataCount)&&void 0!==o?o:0,h=u?void 0:"No records to show";let g=a.createElement("span",{className:"ws-pre text-gray-500 font-18",style:{fontWeight:"normal"}},"  ",u.toLocaleString());this.isInsert&&!u&&(g=null);let f=null;if(this.isInsert&&p){if(!y.includes(e.tableName))return null;{const{nestedInsertData:t}=this.state;f=a.createElement(SmartCardList,{key:e.tableName,db:r,tableName:e.tableName,tables:c,className:"px-1",data:null!==(d=null==t?void 0:t[e.tableName])&&void 0!==d?d:[],onChange:t=>{this.setState({nestedInsertData:{...this.state.nestedInsertData,[e.tableName]:t},nestedInsertTable:void 0},(()=>{p(this.state.nestedInsertData)}))}})}}else f=a.createElement("div",{className:"flex-col py-1"},u>20&&a.createElement("div",null,"Showing top ",20," records"),a.createElement(SmartCardList,{key:e.tableName,db:r,tableName:e.tableName,tables:c,filter:this.getJoinFilter(e.tableName),className:"px-1",fieldConfigs:c.some((t=>t.info.is_media&&t.name===e.tableName))?[{name:"url",render:(e,t)=>a.createElement(MediaViewer,{style:{maxWidth:"300px"},url:e,allowedContentTypes:[MediaViewer.getMimeFromURL(e)]})}]:void 0}));return a.createElement("div",{key:e.tableName+this.dataSignature,className:"flex-col min-h-0 f-0 relative"},a.createElement("div",{className:"flex-row ai-center noselect pointer f-0 bg-white",style:e.expanded?{position:"sticky",top:0,zIndex:432432,borderBottom:"1px solid #cecece",marginBottom:".5em"}:void 0},a.createElement(Btn_Btn,{className:"f-1 p-p5 ta-left font-20 bold jc-start",variant:"text",title:"Expand section",disabledInfo:h,color:"action",onClick:()=>{const n=t.map((t=>({...t,expanded:t.tableName===e.tableName?!t.expanded:t.expanded})));this.setState({sections:n})},iconPath:e.expanded?s.CW:s.zrb,iconClassname:"show-on-parent-hover"},e.tableName,g),m&&a.createElement(Btn_Btn,{iconPath:s.rgx,title:"Open in table",disabledInfo:h,onClick:async()=>{this.setState({quickView:{tableName:e.tableName}})}}),this.getAddButton(e)),e.expanded&&f)}))))}}const mo=e=>{const{onChange:t,rowFilter:n,tableName:l,db:o,onAddTable:i,tables:r,showJoinedTables:c=!0,onSetNestedInsertData:d,columns:p,onRemoveUpdate:u,state:h}=e,{newRow:g,tableInfo:f,action:E}=h,[v,b]=(0,a.useState)(!1),y=t&&"update"===E.type&&Object.keys(g||{}).length,{currentRow:N}=E;if(!c&&!y)return null;const w=r.find((e=>e.name===l));return!c||y||(null==w?void 0:w.joins.length)?a.createElement("div",{className:"SmartFormUpperFooter flex-col o-auto min-h-0 min-w-0 w-full f-0 ",style:{boxShadow:"0px 3px 9px 0px #404040",clipPath:"inset(-10px 1px 0px 1px)",minHeight:"1px",maxHeight:"30%"}},c&&a.createElement(JoinedRecords,{action:E.type,db:o,onAddTable:i,rowFilter:n,tableName:l,tables:r,onSetNestedInsertData:d}),y?a.createElement(a.Fragment,null,a.createElement("div",{className:"noselect flex-row ai-center pointer  "+(v?" ":"  mb-p5 "),style:{borderTop:"1px solid #cecece"},onClick:()=>b(!v)},a.createElement("h4",{className:"noselect  f-1 px-1"},"Changes (",Object.keys(g||{}).length,"):"),a.createElement(Btn_Btn,{className:"f-0 ",iconPath:v?s.VYU:s.f1y,title:"Collapse/Expand changes",size:"small"})),!v&&a.createElement("div",{className:"flex-col w-full ai-start "+(y?" p-1 ":" ")},(0,m.getKeys)(null!=g?g:{}).map((e=>{if(!g||!N)return null;const t=null==p?void 0:p.find((t=>t.name===e));let n=null,l=null;return!t&&(null==f?void 0:f.media_table_name)===e&&Array.isArray(g[e])?(l=JSON.stringify([N[e].map((e=>e.name))]).slice(1,-1),n=JSON.stringify([g[e].map((e=>e.name))]).slice(1,-1)):(l=SmartFormField.renderValue(t,N[e]),n=SmartFormField.renderValue(t,g[e])),a.createElement("div",{key:e,className:"flex-row mb-p5 ai-center w-full"},a.createElement("div",{className:"flex-col mb-p5 ta-left o-auto "},a.createElement("div",{className:"text-gray-500 font-14 mb-p25"},(null==t?void 0:t.label)||e,": "),a.createElement("div",{title:"Old value",className:" text-red-500 o-auto",style:{maxHeight:"100px"}},l),a.createElement("div",{title:"New value",className:" text-green-500 o-auto",style:{maxHeight:"100px"}},n)),a.createElement(Btn_Btn,{iconPath:s.x9U,title:"Remove update",onClick:()=>u(e)}))})))):null):null};class ConfirmationDialog extends RTComp{constructor(){super(...arguments),this.state={}}render(){const{onClose:e,onAccept:t,acceptBtn:n,message:l,title:o,asPopup:i,positioning:s,className:r="",style:d,iconPath:m}=this.props,p=a.createElement("div",{className:"flex-col "+r,style:d},a.createElement("div",{className:"flex-row  ai-start p-1 gap-1"},m&&a.createElement(c(),{path:m,size:1,className:"f-0 text-gray-400"}),a.createElement("div",{className:""},l)),a.createElement("div",{className:"flex-row-wrap p-p5 f-0 bt b-gray-400 jc-end "},a.createElement(Btn_Btn,{className:"mr-1",onClick:()=>e()},"Cancel"),a.createElement(Btn_Btn,{color:n.color,variant:"filled",onClick:async()=>{await t()}},n.text)));return i?a.createElement(Popup,{open:!0,positioning:"positioning"in this.props?s:"right-panel",rootStyle:{padding:0},contentClassName:"flex-col ai-center",onClose:e,title:o},p):p}}const po=e=>{const{props:t,state:n,action:l,columns:o}=e,{newRow:i,error:s}=n,{db:r,tableName:c,disabledActions:d,onClose:m,onBeforeInsert:p,confirmUpdates:u,onChange:h}=t,g=r[c],f=(0,a.useState)(),[v,b]=f,y=Io(),N={...e,useConfirmPopup:f,getIsMounted:y};if(n.action.success)return a.createElement(a.Fragment,null);let w=a.createElement(a.Fragment,null);if(v)w=a.createElement(a.Fragment,null,a.createElement(ConfirmationDialog,{className:"bg-white",style:{zIndex:2},onClose:()=>{b(void 0)},onAccept:async()=>{await v.onAccept(),b(void 0)},message:v.message,acceptBtn:v.acceptBtn}));else if(!h){const e="update"===l&&i,n={update:!(!u||!(null==g?void 0:g.update)||!i||(null==d?void 0:d.includes("update"))),delete:!e&&!!(null==g?void 0:g.delete)&&!(null==d?void 0:d.includes("delete")),insert:!e&&!!(null==g?void 0:g.insert),clone:!e&&!!(null==g?void 0:g.insert)&&!(null==d?void 0:d.includes("clone"))},o="view"===l?null:"update"===l&&(n.update||n.delete||n.clone)?a.createElement(a.Fragment,null,n.update&&a.createElement(Btn_Btn,{color:"action",className:"",variant:"filled",disabledInfo:Object.keys(i||{}).length?void 0:"No data to update",onClick:()=>ho(N)},"Update"),n.delete&&a.createElement(Btn_Btn,{color:"danger",variant:"outline",title:"Remove this row from table",className:" bg-white",onClick:()=>fo(N)},"Delete"),n.clone&&a.createElement(Btn_Btn,{color:"action",variant:"outline",title:"Prepare a duplicate insert that excludes primary key fields",className:" bg-white",onClick:()=>go(N)},"Clone")):"insert"===l?a.createElement(a.Fragment,null,n.insert?a.createElement(Btn_Btn,{color:"action",className:" ",variant:"filled",onClick:()=>uo(N)},p?"Add":"Insert"):a.createElement("div",null,"Cannot insert: not allowed")):null,r=!(!o||l.success&&!s);w=r||m?a.createElement(E,null,t.onClose&&a.createElement(Btn_Btn,{className:" bg-white mr-auto",variant:"outline",onClick:()=>null==m?void 0:m(!0)},"view"===l?"Close":"Cancel"),r&&o):a.createElement(a.Fragment,null)}return w},uo=async({state:e,props:t,getThisRow:n,columns:a,getErrors:l,parseError:o,setAction:i,setError:s,getIsMounted:r})=>{const{db:c,tableName:d,includeMedia:m=!0,onInserted:p,onSuccess:u,onBeforeInsert:h}=t,{tableInfo:g,referencedInsertData:f={},action:E}=e,v=c[d];"insert"===E.type&&l((async e=>{var l;if(e&&a)try{i({...E,loading:!0});let e,o=[];if((null==g?void 0:g.has_media)&&m&&g.media_table_name){o=[g.media_table_name]}if((null==g?void 0:g.is_media)?e=null!==(l=n()[d])&&void 0!==l?l:t.defaultData:(e=wo(n(),a.filter((e=>e.insert)).map((e=>e.name)).concat(o)),e={...e,...f}),h)h(e);else{const t=await(null==v?void 0:v.insert(e,p||u?{returning:"*"}:{}));null==u||u("insert",t),null==p||p(t)}s(void 0),i({...E,loading:!1,success:"inserted"}),setTimeout((()=>{var e;r()&&(i({type:"view"}),null===(e=null==t?void 0:t.onClose)||void 0===e||e.call(t,!0))}),2e3)}catch(e){o(e),console.error(e)}}))},ho=async({state:e,props:t,getErrors:n,parseError:a,getValidatedRowFilter:l,useConfirmPopup:o,setAction:i,setError:s,getIsMounted:r})=>{const{db:c,tableName:d,onSuccess:m}=t,{tableInfo:p,action:u}=e,h=c[d],[g,f]=o;"update"===u.type&&n((async e=>{e&&f({message:"Are you sure you want to update?",acceptBtn:{text:"Update row!",color:"action"},onAccept:async()=>{f(void 0),i({...u,loading:!0});const n=e,o=(null==p?void 0:p.is_media)&&n?n[d][0]:n;let c;try{c=await l();const e=await(null==h?void 0:h.update(c,o,{returning:"*"}));null==m||m("update",e),s(void 0),i({...u,success:"updated",loading:!1}),setTimeout((()=>{var e;r()&&(null===(e=null==t?void 0:t.onClose)||void 0===e||e.call(t,!0))}),2e3)}catch(e){a(e),console.error(e,c,o)}},onClose:()=>f(void 0)})}))},go=async({parseError:e,props:t,getRowFilter:n,setAction:a,setError:l})=>{const{db:o,tableName:i,tables:s}=t,r=o[i];try{const e=n(),t=await(null==r?void 0:r.find(e));if(1===(null==t?void 0:t.length)){const e=s.find((e=>e.name===i));let n=t[0];null==e||e.columns.map((e=>{e.is_pkey&&(null==n||delete n[e.name])})),a({type:"insert",data:{},clonedRow:n})}else l("Could not clone row because the row filter refers to more than 1 row")}catch(t){e(t),console.error(t)}},fo=async({props:e,parseError:t,getValidatedRowFilter:n,useConfirmPopup:a,state:l,setAction:o,setError:i,getIsMounted:s})=>{const{db:r,tableName:c,onSuccess:d}=e,m=r[c],{action:p}=l;if("insert"===p.type)throw"Cannot delete an insert!";const[u,h]=a;h({message:"Are you sure you want to delete this?",acceptBtn:{text:"Delete!",color:"danger"},onAccept:async()=>{h(void 0),o({...p,loading:!0});try{await(null==m?void 0:m.delete(await n())),null==d||d("delete"),i(void 0),o({...p,loading:!1,success:"deleted"}),setTimeout((()=>{var t;s()&&(null===(t=null==e?void 0:e.onClose)||void 0===t||t.call(e,!0))}),2e3)}catch(e){t(e),console.error(e)}},onClose:()=>{h(void 0)}})};class SmartForm extends RTComp{constructor(){super(...arguments),this.state={error:void 0,newRow:void 0,confirmUpdates:void 0,showLocalChanges:void 0,rowFilter:void 0,localChanges:[],errors:void 0,tableInfo:void 0,defaultColumnData:{},referencedInsert:void 0,action:{type:"view"}},this.setColumns=e=>{},this.onMount=async()=>{var e,t;const{tableName:n,db:a,lang:l,rowFilter:o,tables:i}=this.props,s=a[n],r=i.find((e=>e.name===n)),c=null==r?void 0:r.info;if(!(null==s?void 0:s.getInfo)||!(null==s?void 0:s.getColumns)||!c)return void this.setState({error:"Table getInfo/getColumns hooks not available/published: "+n});let d,m={type:"view",loading:!0};o&&(this.tableHandler.update||this.tableHandler.delete)?(this.props.fixedData&&this.setState({newRow:{...this.props.fixedData}}),m={type:"update",loading:!0,data:{}}):this.tableHandler.insert&&!o&&(m={type:"insert",data:{}}),(null===(e=c.dynamicRules)||void 0===e?void 0:e.update)&&"update"===m.type&&(d={rule:"update",filter:Vl(o),data:{thisIsBad:1}});let p=d?await s.getColumns(l,d):r.columns;this.setState({action:m,dynamicValidatedColumns:p,tableInfo:c,error:"columns"in this.props&&(null===(t=this.props.columns)||void 0===t?void 0:t.length)&&this.props.columns.some((e=>!p.some((t=>t.name===e))))?"Some requested columns not found in the table":void 0})},this.getErrors=async e=>{const{defaultData:t={},rowFilter:n,cannotBeNullMessage:a="Must not be empty"}=this.props,{newRow:l={},defaultColumnData:o={},tableInfo:i,referencedInsertData:s={}}=this.state;let r,c={...o,...t,...l,...s};const{columns:d}=this;if(this.getDisplayedColumns().filter((e=>e.insert||e.update)).forEach((e=>{var t,l;const o=null==c?void 0:c[e.name];if(!e.is_nullable){const s=e=>[void 0,null].includes(e),d=(null==i?void 0:i.has_media)&&i.media_table_name&&(null===(t=e.references)||void 0===t?void 0:t.some((e=>e.ftable===i.media_table_name)))&&(null===(l=c[i.media_table_name])||void 0===l?void 0:l.length);(n||!s(o)||e.has_default||d)&&null!==o||(null!=r||(r={}),r[e.name]=a)}if(e.udt_name.startsWith("json")&&"string"==typeof o)try{c={...c,[e.name]:JSON.parse(o)}}catch(t){null!=r||(r={}),r[e.name]="Must be a valid json"}})),r)this.setState({errors:r});else{let t;this.props.onValidateValue&&d?await Promise.all(d.map((async e=>{var n,a;const l=await(null===(a=(n=this.props).onValidateValue)||void 0===a?void 0:a.call(n,c[e.name],c,e));l&&(t=t||{},t={...t,[e.name]:l})}))):this.props.onValidate&&d&&(t=await this.props.onValidate(c,d));const n=t||await e(c);n&&!yo(n)&&this.setState({errors:n})}},this.onDelta=async(e,t,n)=>{var a,l;const{tableName:o,db:i,getRef:s}=this.props,{action:r}=this.state;s&&s({getErrors:this.getErrors});const c=this.getRowFilter();if(("view"===r.type||"update"===r.type)&&((null==e?void 0:e.rowFilter)||(null==t?void 0:t.rowFilter))&&JSON.stringify((null===(a=this.rowSub)||void 0===a?void 0:a.filter)||"")!==JSON.stringify(c||"")){if(!c)return void console.error("rowFilter missing");await(null===(l=this.rowSub)||void 0===l?void 0:l.unsubscribe());const e=i[o],t=async()=>{var t;this.setState({action:{...r,loading:!1,currentRow:await(null===(t=null==e?void 0:e.findOne)||void 0===t?void 0:t.call(e,c,{select:await this.getSelect()}))}})};if(null==e?void 0:e.subscribeOne)try{const t={select:await this.getSelect()};e.find&&await e.find(c,{...t,limit:0}),this.rowSub=await e.subscribeOne(c,t,(e=>{e&&this.setState({action:{...r,loading:!1,currentRow:e}})}))}catch(e){console.error("Could not subscribe",{tableName:o,rowFilter:c,error:e,select:await this.getSelect()}),t()}else t()}},this.onUnmount=async()=>{this.rowSub&&await this.rowSub.unsubscribe()},this.getSelect=async()=>{var e,t;const{tableName:n,db:a,includeMedia:l=!0}=this.props,{tableInfo:o}=this.state;let i=o;o||(i=await(null===(t=null===(e=a[n])||void 0===e?void 0:e.getInfo)||void 0===t?void 0:t.call(e)),this.setState({tableInfo:i}));let s={$rowhash:1,"*":1};return l&&(null==i?void 0:i.media_table_name)&&i.media_table_name!==n&&i.has_media&&(s[i.media_table_name]="*"),s},this.getRowFilter=()=>{var e,t;const n=(null===(e=this.state)||void 0===e?void 0:e.rowFilter)||(null===(t=this.props)||void 0===t?void 0:t.rowFilter);if(n)return Vl(n)},this.getRow=async()=>{var e,t;const{tableName:n,db:a,includeMedia:l=!0}=this.props;return null===(t=null===(e=a[n])||void 0===e?void 0:e.find)||void 0===t?void 0:t.call(e,this.getRowFilter(),{select:await this.getSelect()})},this.getValidatedRowFilter=async()=>{const e=this.getRowFilter();await this.getRow();return e},this.setReferencedInsertData=(e,t)=>{const{referencedInsertData:n={}}=this.state;this.setState({errors:void 0,error:void 0,referencedInsertData:{...n,[e.name]:t}})},this.setData=async(e,t)=>{var n,a,l,o;this.wasChanged=!0;const{db:i,tableName:s,rowFilter:r,onChange:c,onSuccess:d}=this.props,{localChanges:m,confirmUpdates:p=null!==(n=this.props.confirmUpdates)&&void 0!==n&&n,errors:u,action:h}=this.state,{currentRow:g={}}=h;let f,E={...this.state.newRow||{},[e.name]:t},v=Object.keys(E).reduce(((e,t)=>({...e,[t]:g[t]})),{}),b={};if("update"===h.type&&g&&Eo(E).forEach((e=>{E[e]===g[e]&&e in g&&delete E[e]})),""===E[e.name]&&"string"!==e.tsDataType&&delete E[e.name],c||!r||p)b={...b,newRow:E};else try{const n=await this.getValidatedRowFilter();if(!n)throw"No update filter provided";const o=await(null===(l=null===(a=i[s])||void 0===a?void 0:a.update)||void 0===l?void 0:l.call(a,n,{[e.name]:t},{returning:"*"}));null==d||d("update",o)}catch(e){return void this.parseError(e)}!p&&r&&e.is_pkey&&(b={...b,rowFilter:{...(null===(o=this.props)||void 0===o?void 0:o.rowFilter)||{},[e.name]:t}}),null==c||c(E),u&&(f={...u},delete f[e.name],b={...b,errors:f}),this.setState({...b,localChanges:m.slice(0).concat([{oldRow:v,newRow:E}])})},this.closed=!1,this.wasChanged=!1,this.onClose=()=>{const{onClose:e,rowFilter:t}=this.props;null==e||e(!0)},this.getThisRow=()=>{const{newRow:e,defaultColumnData:t={},action:n}=this.state,{defaultData:a={},fixedData:l}=this.props;return"insert"===n.type?{...n.clonedRow,...e,...l}:{...n.currentRow,...t,...a,...e,...l}},this.parseError=e=>{let t={error:e.message||e.txt};if(Object.keys(e||{}).length&&e.constraint){let n=[],a={};e.columns?n=e.columns:e.column&&(n=[e.column]),n.forEach((t=>{var n;if(null===(n=this.columns)||void 0===n?void 0:n.find((e=>e.name===t))){let n=e.constraint;"unique_violation"===e.code_info&&(n="Value already exists. \nConstraint: "+e.constraint),a[t]=n}})),Object.keys(a).length&&(t={errors:a})}this.setState({...t,action:{...this.state.action,loading:!1}})},this.getDisplayedColumns=()=>{const{tableInfo:e,action:t}=this.state,{hideNonUpdateableColumns:n=!1}=this.props;if((null==e?void 0:e.is_media)&&"insert"===t.type)return[];return this.columns.slice(0).filter((e=>"view"===t.type&&e.select||"update"===t.type&&(e.update||!n&&e.select)||"insert"===t.type&&e.insert))}}get table(){const{tableName:e,tables:t}=this.props;return t.find((t=>t.name===e))}get mediaTableInfo(){var e,t;const{includeMedia:n=!0,tables:a}=this.props,l=null===(e=this.table)||void 0===e?void 0:e.info;if((null==l?void 0:l.has_media)&&l.media_table_name&&n)return null===(t=a.find((e=>e.info.is_media)))||void 0===t?void 0:t.info}get tableHandler(){const{db:e,tableName:t}=this.props,n=e[t];if(!n)throw`${t} handler missing`;return n}get columns(){var e;const{fixedData:t}=this.props;let n=(0,de.quickClone)(this.state.dynamicValidatedColumns||(null===(e=this.table)||void 0===e?void 0:e.columns)||[]);if(t){const e=Eo(t);n=n.map((t=>({...t,insert:!e.includes(t.name)&&t.insert})))}let a=n;if("columns"in this.props){const{columns:e}=this.props;e&&(a=e.map((e=>{if("string"==typeof e)return n.find((t=>t.name===e));{const t=n.find((t=>t.name===e.name));if(!t)return;return e.sectionHeader?{...t,...e}:{...t}}})).filter(Co))}if("columnFilter"in this.props&&this.props.columnFilter){const{columnFilter:e}=this.props;a=a.filter(e)}return a}render(){var e,t,n,l,o;const{db:i,tableName:r,onChange:c,showSuggestions:d,label:p,hideChangesOptions:u=!1,includeMedia:h=!0,asPopup:g,enableInsert:f=!0,onSuccess:E,tables:v,className:b="",onPrevOrNext:y}=this.props,{error:N,newRow:w,errors:S={},tableInfo:T,confirmUpdates:C=null!==(e=this.props.confirmUpdates)&&void 0!==e&&e,showLocalChanges:_=null===(t=this.props.showLocalChanges)||void 0===t||t,action:x}=this.state;let A="view"===x.type||this.props.hideNullBtn;const R=this.getThisRow();let L=null,O=null;const I=(null==T?void 0:T.is_media)?r:null==T?void 0:T.media_table_name;if(((null==T?void 0:T.has_media)||(null==T?void 0:T.is_media))&&h&&I){const{is_media:e}=T;let t=[];t=e?"insert"===x.type?this.props.defaultData&&(0,m.isObject)(this.props.defaultData)&&!w?[this.props.defaultData]:null!==(n=this.getThisRow()[I])&&void 0!==n?n:[]:null!==(l=null==w?void 0:w[r])&&void 0!==l?l:[R]:(null==R?void 0:R[I])||[];const s=!(null==T?void 0:T.is_media)&&(null==T?void 0:T.media_table_name)&&!v.some((e=>e.name!==r&&(2===e.columns.length&&e.columns.some((e=>{var t;return null===(t=e.references)||void 0===t?void 0:t.some((e=>e.ftable===r))}))&&e.columns.some((e=>{var t;return null===(t=e.references)||void 0===t?void 0:t.some((e=>e.ftable===(null==T?void 0:T.media_table_name)))}))||e.name==(null==T?void 0:T.media_table_name)&&e.columns.some((e=>{var t;return null===(t=e.references)||void 0===t?void 0:t.some((e=>e.ftable===r))}))))),c=s||x.loading?null:a.createElement(FileInput,{key:r,className:"mt-p5 f-0 "+((null==T?void 0:T.is_media)?"mt-2":""),label:e?"":(null===(o=this.mediaTableInfo)||void 0===o?void 0:o.comment)||I,media:t,minSize:e?470:void 0,maxFileCount:e?1:void 0,onAdd:e=>{var t;const n=[...(null==w?void 0:w[I])||[],...(null===(t=x.currentRow)||void 0===t?void 0:t[I])||[]].filter(Co);this.setData({name:I,is_pkey:!1,tsDataType:"Array<Object>"},[...n,...e])},onDelete:async e=>{var t,n;if("id"in e&&e.id){if("update"===x.type&&T.is_media)this.setState({newRow:{[r]:[]}});else if(null===(t=i[I])||void 0===t?void 0:t.update){const t=await(null===(n=i[I])||void 0===n?void 0:n.update({id:e.id},{deleted:!0},E?{returning:"*"}:{}));null==E||E("update",t)}}else{const t=(null==w?void 0:w[I])||[];this.setData({name:I,is_pkey:!1,tsDataType:"Array<Object>"},t.filter((t=>t.name!==e.name)))}}});(null==T?void 0:T.is_media)?L=c:O=c}const D="max-w-650";if(!T)return null;const k=this.getRowFilter(),M=k?Gl(" ("+Object.keys(k).map((e=>`${e}: ${JSON.stringify(k[e])}`)).join(" AND ")+")",100):"",F=null!=p?p:("insert"===x.type&&x.clonedRow?"[Cloned row] ":"")+((null==T?void 0:T.comment)||r),P=g||!p&&"label"in this.props?null:F?a.createElement("h4",{className:"font-20",style:{margin:0,padding:"1em",paddingBottom:".5em"}},F):null;let H=a.createElement("div",{className:"SMARTFORM "+(g?"":D)+" fade-in flex-col f-1 min-h-0 relative "+(x.loading?" no-pointer-events noselect ":" ")+b},x.loading&&a.createElement(Loading,{variant:"cover"}),P,a.createElement("div",{className:"SMARTFORM_CONTENT flex-col f-1 o-auto min-h-0 min-w-0 p-1",style:{paddingTop:0}},L,this.getDisplayedColumns().map(((e,t)=>{var n;const l=(R||{})[e.name],o=e.sectionHeader?{marginTop:"1em"}:{},c=null===(n=this.state.referencedInsertData)||void 0===n?void 0:n[e.name];return c?e.file?a.createElement(FileInput,{key:t,className:"mt-p5 f-0 "+((null==T?void 0:T.is_media)?"mt-2":""),label:e.label,media:[c],minSize:470,maxFileCount:1,onAdd:t=>{this.setReferencedInsertData(e,t[0])},onDelete:async t=>{this.setReferencedInsertData(e,void 0)}}):a.createElement("div",{key:t,className:"form-field flex-col min-w-0 mt-1",style:o},a.createElement("label",{className:" main-label ta-left noselect text-gray-500  pointer ",style:{flex:"0.5 1 0%"}},e.label),a.createElement("div",{className:"flex-row gap-1 ai-center  f-1"},a.createElement(Btn_Btn,{className:"mr-auto  bg-white",variant:"outline",color:"action",title:"View insert data",onClick:()=>{this.setState({referencedInsert:{col:e,data:c}})}},"New data"),a.createElement(Btn_Btn,{title:"Remove nested insert",iconPath:s.r5M,onClick:()=>{this.setReferencedInsertData(e,void 0)}}))):a.createElement(SmartFormField,{key:t,tableInfo:T,tables:v,db:i,tableName:r,action:x.type,column:e,value:l||"",rawValue:l,onChange:t=>this.setData(e,t),showSuggestions:d,error:S[e.name],rightContent:a.createElement(so,{action:x.type,column:e,db:i,tableInfo:T,tables:v,enableInsert:f,hideNullBtn:A,referencedInsertData:this.state.referencedInsertData,setData:this.setData,setReferencedInsertData:this.setReferencedInsertData}),hideNullBtn:A,sectionHeader:e.sectionHeader,style:o,variant:"column"})})),O),u||"view"===x.type?null:a.createElement(a.Fragment,null,c||"insert"===x.type?null:a.createElement(Checkbox,{label:"Confirm updates",checked:C,onChange:({currentTarget:e})=>{this.setState({confirmUpdates:e.checked})}}),c?null:a.createElement(Checkbox,{label:"Show local changes",checked:_,onChange:({currentTarget:e})=>{this.setState({showLocalChanges:e.checked})}})),a.createElement(mo,{...this.props,columns:this.columns,onSetNestedInsertData:e=>{this.setState({newRow:{...this.state.newRow,...e}})},state:this.state,onRemoveUpdate:e=>{this.setState({newRow:bo({...this.state.newRow},void 0,[e])})}}),a.createElement(ErrorComponent,{className:"f-0 b rounded",style:{flex:"none",padding:"1em"},withIcon:!0,error:N||(S?(B=No(S,this.getDisplayedColumns().map((e=>e.name))),W=void 0,yo(B)?W:B):void 0)}),x.success&&!N?a.createElement(io,{message:`${x.success}!`}):null,a.createElement(po,{state:this.state,props:this.props,action:x.type,columns:this.columns,getThisRow:this.getThisRow,getErrors:this.getErrors,parseError:this.parseError,getRowFilter:this.getRowFilter,getValidatedRowFilter:this.getValidatedRowFilter,setError:e=>{this.setState({error:e})},setAction:e=>{this.setState({action:e})}}));var B,W;if(g){const e="smartformprevnext",t=y?{onKeyDown:(e,t)=>{"header"===t&&("ArrowLeft"===e.key&&y(-1),"ArrowRight"===e.key&&y(1))},headerRightContent:a.createElement("div",{className:"flex-row mx-1 "+e},a.createElement(Btn_Btn,{iconPath:s.gAv,onClick:({currentTarget:e})=>{e.focus(),y(-1)}}),a.createElement(Btn_Btn,{iconPath:s.zrb,onClick:({currentTarget:e})=>{e.focus(),y(1)}}))}:{};return a.createElement(Popup,{title:F,subTitle:M,open:!0,autoFocusFirst:y?"header":"content",...t,contentClassName:g?D:"",positioning:"right-panel",onClose:this.onClose,showFullscreenToggle:{getStyle:e=>e?{}:{maxWidth:"600px"}}},H)}return H}}const Eo=Object.keys,vo=(e,t)=>("string"==typeof t&&(t=t.split(".")),t.reduce(((e,t)=>e&&"undefined"!==e[t]?e[t]:void 0),e));function bo(e,t=[],n=[]){if(!t.length&&!n.length)return{};let a=Object.keys(e);if(e&&a.length){let l={};return a.forEach((a=>{(t.length&&t.includes(a)||n.length&&!n.includes(a))&&(l[a]=e[a])})),l}return e}function yo(e){return 0===Object.keys(null!=e?e:{}).length}function No(e,t){return wo(e,Eo(null!=e?e:[]).filter((e=>!t.includes(e))))}function wo(e,t=[],n=!1){let a=t;if(!a.length)return{};if(e&&a.length){let t={};return a.forEach((a=>{n&&void 0===e[a]||(t[a]=e[a])})),t}return e}function So(e,t){var n,a=[{value:1,symbol:""},{value:1e3,symbol:"k"},{value:1e6,symbol:"M"},{value:1e9,symbol:"G"},{value:1e12,symbol:"T"},{value:1e15,symbol:"P"},{value:1e18,symbol:"E"}];for(n=a.length-1;n>0&&!(e>=a[n].value);n--);return(e/a[n].value).toFixed(t).replace(/\.0+$|(\.[0-9]*[1-9])0+$/,"$1")+a[n].symbol}function To(e){if(e&&"string"==typeof e){let t,n=[];return e.split("").map(((a,l)=>{const o=a.match(/[A-Za-z]/)?"c":a.match(/[0-9.]/)?"n":"s",i={idx:l,len:1,val:a,type:o,decimalPlaces:0};if(t){const e=t.type!==o,s=!e&&"."===a&&t.val.includes(".");e||s?(n.push(t),s?(n.push(i),t=void 0):t=i):(t.len=l-t.idx+1,t.val+=a)}else t=i;t&&l===e.length-1&&(t.len=l-t.idx+1,n.push(t))})),n.map((e=>("n"===e.type&&e.val.includes(".")&&(e.decimalPlaces=e.len-1-e.val.indexOf(".")),e)))}return[]}const Co=e=>null!=e;function _o(e){if(void 0!==window&&"structuredClone"in window&&"function"==typeof window.structuredClone)return window.structuredClone(e);if((0,m.isObject)(e)){let t={};return Eo(e).map((n=>{t[n]=_o(e[n])})),t}return Array.isArray(e)?e.slice(0).map((e=>_o(e))):e}const xo=(e,t,n)=>typeof e==typeof t&&!(null!=n?n:Eo({...e,...t})).some((n=>typeof e[n]!=typeof t[n]||JSON.stringify(e[n])!==JSON.stringify(t[n]))),Ao=["iconPath","children","disabledInfo","title","onClick","loading","color","fadeIn","_ref","ref","style","size","exactClassName","iconProps","iconPosition","iconClassname","onClickMessage","onClickPromise","asNavLink"];class Btn_Btn extends RTComp{constructor(){super(...arguments),this.state={show:!0},this.clickMessage=(e,t)=>{var n;if(!this.mounted)return;const a="err"in e;a?this.setState({clickMessage:{type:"err",msg:ErrorComponent.parsedError(e.err,!0)}}):"ok"in e?this.setState({clickMessage:{type:"ok",msg:e.ok,replace:e.replace}}):"loading"in e&&this.setState({clickMessage:{type:"loading",msg:""}}),this.timeOut&&clearTimeout(this.timeOut),this.timeOut=setTimeout((()=>{this.mounted&&this.setState({clickMessage:void 0},t)}),null!==(n=e.duration)&&void 0!==n?n:a?5e3:2e3)},this.setPromise=async e=>{this.clickMessage({loading:1});try{await e,this.clickMessage({ok:""})}catch(e){this.clickMessage({err:e})}}}render(){var e,t;const{iconPath:n,iconPosition:l="left",className:o="",style:r={},disabledInfo:c,title:d,fadeIn:m,exactClassName:p,variant:u="default",iconProps:h={},iconClassname:g=""}=this.props,{clickMessage:f}=this.state;let E={};const v=null!==(e="err"===(null==f?void 0:f.type)?"danger":"ok"===(null==f?void 0:f.type)?"action":this.props.color)&&void 0!==e?e:"default",b="loading"===(null==f?void 0:f.type)||null!==(t=this.props.loading)&&void 0!==t&&t,y=(null==f?void 0:f.msg)||this.props.children;if(null==f?void 0:f.replace)return f.msg;const N=c||b;let w=p||"";const{size:S=(window.isLowWidthScreen?"small":void 0)}=this.props;if(!p){const e=(o+"").includes("bg-");w=" f-0 flex-row gap-p5 ai-center  "+("href"in this.props?" button-css ":"  ")+("outline"===u?" b ":""),y?("outline"===u&&(e||(w=w.replace("bg-transparent","")+" bg-white "),E={borderColor:"currentcolor"}),S||(E.padding=n?"8px 12px":"12px"),"small"===S&&(E.padding="5px 8px"),"large"===S&&(E.padding="12px 16px"),"text"===u&&(E.paddingLeft=0)):(E={padding:"7px"},"icon"!==u&&"outline"!==u||(null!=E||(E={}),E.padding="0.5em"),"small"===S&&(E.padding="4px"))}w+=(m?" fade-in ":"")+(n&&!y?"  ":"rounded")+(N?" disabled ":" "),w=o+w;const T="micro"===S?.5:"small"===S?.75:"medium"===S?.85:1,C=null===y||""===y?null:b?a.createElement("div",{className:"min-w-0 ws-nowrap text-ellipsis f-1 o-hidden",style:b?{opacity:.5}:{}},y):y,_=a.createElement(a.Fragment,null,"right"===l&&C,n&&!b&&h?a.createElement(W,{path:"err"===(null==f?void 0:f.type)?s.jZI:"ok"===(null==f?void 0:f.type)?s.oL1:n,size:T,className:g+" f-0 ",...h}):null,b?a.createElement(Loading,{className:"mr-p5 ",style:{margin:"-2px 1em -2px -6px"},sizePx:12,delay:0,colorAnimation:!1}):null,"left"===l&&C);let x=this.props.onClick;if("onClickPromise"in this.props&&this.props.onClickPromise){const{onClickPromise:e}=this.props;x=t=>{this.setPromise(e(t))}}if("onClickMessage"in this.props&&this.props.onClickMessage){const{onClickMessage:e}=this.props;x=t=>{e(t,this.clickMessage)}}"small"===S&&(E.minHeight="32px",E.minWidth="32px");const A={...No(this.props,Ao),onClick:N||b?void 0:x,title:c||d,style:{...E,display:"flex",lineHeight:"1em",width:"fit-content",...r,fontSize:{large:"16px",medium:"16px",small:"14px",micro:"12px"}[null!=S?S:"medium"]},onMouseDown:e=>e.preventDefault(),className:`${w} btn btn-${u} btn-size-${S} btn-color-${v} ws-nowrap w-fit `,ref:this.props._ref};return"href"in this.props&&this.props.href?this.props.asNavLink?a.createElement("button",{...A,onClick:c?void 0:e=>{var t;return null===(t=e.currentTarget.querySelector("a"))||void 0===t?void 0:t.click()}},a.createElement(i.OL,{to:this.props.href,tabIndex:-1,className:"absolute no-decor btn-anchor "}),_):a.createElement("a",{...A,target:this.props.target,onClick:c?void 0:()=>!1},_):a.createElement("button",{...A},_)}}const Ro=a.forwardRef((({iconPath:e=s.xyB,onChange:t,children:n="Choose file",id:l=v(),style:o={},className:i="",...r},c)=>{const[d,m]=(0,a.useState)(null);return a.createElement("div",{className:"flex-row  gap-p25 ai-center "+i,style:o},a.createElement(Btn_Btn,{title:"Choose file",color:"action",iconPath:e,style:{borderRadius:0},onClick:e=>{var t;null===(t=e.currentTarget.querySelector("input"))||void 0===t||t.click()}},n,a.createElement("input",{id:l,ref:c,style:{width:0,height:0,position:"absolute"},...r,onChange:e=>{m(e.target.files),null==t||t(e)},type:"file"})),a.createElement("div",{className:"flex-row-wrap gap-p5 text-gray-500 px-1"},(null==d?void 0:d.length)?Array.from(d).map((e=>a.createElement(Chip,null,e.name))):"No file chosen"))}));function Lo({selectedId:e,onChange:t,dbs:n,dbsTables:l,pickFirst:o}){const[i,r]=(0,a.useState)(),[m,p]=(0,a.useState)([]),u=Io();return(0,a.useEffect)((()=>{(async()=>{if(u())r(await n.credentials.subscribe({type:"s3"},{},(n=>{u()&&(p(n),o&&n.length&&!e&&t(n[0].id))})))})()}),[]),a.createElement("div",{className:"flex-row-wrap ai-end gap-1"},a.createElement(Select_Select,{className:" ",label:"S3 credentials",fullOptions:m.map((e=>({key:e.id,label:`${e.name||e.id}`,subLabel:`${e.key_id}`}))),value:e,onChange:e=>{t(e)}}),a.createElement(M,{button:a.createElement(Btn_Btn,{title:"Add credential",size:"small",className:"mt-1",color:"action",variant:"filled",iconPath:s.qX5}),positioning:"top-center",contentStyle:{padding:0},render:e=>a.createElement(SmartForm,{db:n,label:"Add Cloud credentials",tableName:"credentials",tables:l,showJoinedTables:!1,hideChangesOptions:!0,defaultData:{type:"s3"},onClose:e,onValidate:(e,t)=>{if("s3"!==e.type)return{type:"The only allowed value is: s3"}}})}),a.createElement(M,{className:"",button:a.createElement(Btn_Btn,{size:"small",iconPath:s.npK,variant:"outline"},"Example bucket policy"),positioning:"top-center",title:a.createElement("div",{className:"flex-row ai-center p-p5  w-full gap-1"},a.createElement(c(),{path:s.EaN,size:1}),a.createElement("h4",{className:"m-0 ta-center "},"Suggested bucket policy")),contentStyle:{width:"650px",minWidth:0,maxWidth:"100vw",height:"450px",minHeight:0,maxHeight:"100vh",flex:"none"},render:e=>a.createElement("div",{className:"flex-col gap-p1 f-1 b b-gray-400 rounded o-hidden"},a.createElement(CodeEditor,{value:Oo,language:"json",style:{minHeight:"200px"},className:"p-p5 o-hidden",options:{tabSize:2,minimap:{enabled:!1},lineNumbers:"off"},markers:[{startColumn:12,endColumn:66,startLineNumber:8,endLineNumber:8,severity:d.ZL.Error,message:"Replace with your AWS IAM user"},{startColumn:30,endColumn:46,startLineNumber:17,endLineNumber:17,severity:d.ZL.Error,message:"Replace with your AWS Bucket name"}]}))}))}const Oo='\n{\n\t"Version": "2012-10-17",\n\t"Statement": [\n\t\t{\n\t\t\t"Effect": "Allow",\n\t\t\t"Principal": {\n\t\t\t\t"AWS": "arn:aws:iam::123456789012:user/your_iam_user"\n\t\t\t},\n\t\t\t"Action": [\n\t\t\t\t"s3:PutObject",\n\t\t\t\t"s3:GetObject",\n\t\t\t\t"s3:GetObjectVersion",\n\t\t\t\t"s3:DeleteObject",\n\t\t\t\t"s3:DeleteObjectVersion"\n\t\t\t],\n\t\t\t"Resource": "arn:aws:s3:::your_bucket_name/*"\n\t\t}\n\t]\n}';function Io(){const e=(0,a.useRef)(!0),t=(0,a.useCallback)((()=>e.current),[]);return(0,a.useEffect)((()=>()=>{e.current=!1}),[]),t}const Do=function(){const[e,t]=(0,a.useState)(!1),n=Io();return(0,a.useEffect)((()=>{setTimeout((()=>{n()&&t(!0)}),1e3)}),[]),e?a.createElement("div",{className:"bg-white ta-center p-2 f-1 flex-col"},a.createElement("div",{className:"p-1"},"404 page not found"),a.createElement(i.OL,{to:"/"},"Home")):null};class Register extends a.Component{constructor(){super(...arguments),this.state={name:"",email:"",password:"",passwordConfirmation:"",registered:!1,registering:!1,acceptedTOS:!1,acceptedTOSErr:"",error:"",name_err:"",email_err:"",password_err:"",passwordConfirmation_err:""},this.submit=async()=>{const{name:e,email:t,password:n,passwordConfirmation:a,registered:l=!1,registering:o=!1,acceptedTOS:i=!1,acceptedTOSErr:s="",error:r="",name_err:c,email_err:d,password_err:m,passwordConfirmation_err:p}=this.state,{db:u,methods:h}=this.props;let g=!0;if(i?this.setState({acceptedTOSErr:""}):(g=!1,this.setState({acceptedTOSErr:"You must agree to our terms"})),g){this.setState({registering:!0});try{await h.register({name:e,email:t,password:n,acceptedTOS:i});this.setState({registering:!1,registered:"Registration has been received. You will soon be contacted to attend an interview. Thank you!"})}catch(e){this.setState({error:vo(e,"err")||e,registering:!1})}}}}render(){const e="card my-1 flex-col max-w m-auto bg-white",{name:t,email:n,password:l,passwordConfirmation:o,registered:s=!1,registering:r=!1,acceptedTOS:c=!1,acceptedTOSErr:d="",error:m="",name_err:p,email_err:u,password_err:h,passwordConfirmation_err:g}=this.state,{db:f,methods:E}=this.props;return s?a.createElement("div",{className:e},a.createElement("p",{className:"text-lg font-bold text-gray-600"},"Thank you, registration has been received!"),a.createElement("p",{className:"text-lg font-bold text-gray-600"},"You will soon be contacted to schedule an interview"),a.createElement(i.OL,{to:"/"},"Home")):a.createElement("form",{className:e+(r?" no-interaction ":" "),onSubmit:e=>{e.preventDefault(),this.submit()}},a.createElement("h1",{style:{marginTop:"12px"}},"Register"),a.createElement(FormField,{label:"Name",id:"name",className:"mt-1",type:"name",error:p,onChange:e=>{this.setState({name:e})}}),a.createElement(FormField,{label:"Email",id:"email",className:"mt-1",type:"email",error:u,onChange:e=>{this.setState({email:e})}}),a.createElement(FormField,{label:"Password",id:"password",className:"mt-1",type:"password",error:h,onChange:e=>{this.setState({email:e})}}),a.createElement(FormField,{label:"Repeat password",id:"repeat_password",className:"mt-1",type:"password",error:g,onChange:e=>{this.setState({passwordConfirmation:e})}}),a.createElement("h4",{className:"mt-2 mb-0"},"Terms"),a.createElement("div",{className:"mt-1"},a.createElement("div",{className:"flex  pointer pt-2"},a.createElement("input",{checked:c,onChange:e=>{const t=e.target.checked?{}:{acceptedTOSErr:""};this.setState({acceptedTOS:e.target.checked,...t})},id:"tos",type:"checkbox",className:"pointer"}),a.createElement("label",{htmlFor:"tos",className:"ml-p5 pointer noselect"},"I've read and accepted your ",a.createElement(i.OL,{to:"/tos",className:"link-anchor"},"terms and conditions")," and ",a.createElement(i.OL,{to:"/privacy",className:"link-anchor"},"privacy policy"))),a.createElement("p",{className:"mt-2 text-sm text-red-600 "+(d?" block ":" hidden "),id:"tos-error"},d)),a.createElement("p",{className:"mt-2 text-sm text-red-600 "+(m?" block ":" hidden ")},m),a.createElement("div",{className:"flex-row-wrap",style:{justifyContent:"flex-end",marginTop:"2em"}},a.createElement("button",{type:"button",className:"secondary mt-1 mr-1"},"Cancel"),a.createElement("button",{type:"submit",className:"mt-1"},r?a.createElement(Loading,{style:{margin:"-4px 10px"}}):"Submit")))}}class Connections extends RTComp{constructor(){super(...arguments),this.state={},this.loaded=!1,this.onDelta=async()=>{var e;const{dbs:t,user:n,dbsMethods:a}=this.props;t&&n&&!this.loaded&&(this.loaded=!0,t.connections.find({},{orderBy:[{created:-1},{db_conn:1}],select:{"*":1,access_control:{count:{$countAll:[]}},workspaces:"*"}}).then((async e=>{var n;const l=await(null===(n=a.getConnectedIds)||void 0===n?void 0:n.call(a)),o=await Promise.all(e.map((async e=>{var n;return e.allowedUsers=0,(null===(n=e.access_control[0])||void 0===n?void 0:n.count)&&t.users.count&&(e.allowedUsers=await t.users.count({$existsJoined:{"user_types.access_control_user_types.access_control":{connection_id:e.id}}})),e})));this.mounted&&this.setState({connections:o.map((e=>({...e,isConnected:!l||l.includes(e.id)})))})})),null!==(e=this.userSub)&&void 0!==e||(this.userSub=await t.users.subscribeOne({id:n.id},{},(e=>{this.setState({user:e})}))))}}onUnmount(){var e;null===(e=this.userSub)||void 0===e||e.unsubscribe()}render(){var e;const{dbs:t,dbsMethods:n}=this.props,{connections:l,showStateConfirm:o,user:i}=this.state;if(!i||!l)return null;const r="admin"===i.type,c=null===(e=i.options)||void 0===e?void 0:e.showStateDB,d=!!l.length&&l.some((e=>"is_state_db"in e&&e.is_state_db));if(!this.loaded)return a.createElement(Loading,null);let m;o&&(m=a.createElement(ConfirmationDialog,{positioning:"top-center",iconPath:s.jZI,message:"Editing state data directly may break functionality. Proceed at your own risk!",onClose:()=>{this.setState({showStateConfirm:!1})},onAccept:async()=>{await t.users.update({id:i.id},{options:{showStateDB:!0}}),this.setState({showStateConfirm:!1})},acceptBtn:{color:"action",text:"OK"},asPopup:!0}));const p=l.filter((e=>c||!e.is_state_db));let u=[];if(r){const e=[],t=e=>{var t,n;return{db_host:null!==(t=e.db_host)&&void 0!==t?t:"localhost",db_port:null!==(n=e.db_port)&&void 0!==n?n:5432,db_user:e.db_user}},n=(e,n)=>{const a=t(e),l=t(n);return[a.db_host,a.db_port,a.db_user].join()===[l.db_host,l.db_port,l.db_user].join()};p.map((t=>{e.some((e=>n(e,t)))||e.push(wo(t,["db_host","db_port","db_user"]))})),u=e.map((e=>{var t;return{title:a.createElement("h4",{title:"Server info",className:"m-0 flex-row gap-p5 p-p5 ai-center text-gray-500 jc-end",style:{fontWeight:400}},a.createElement("div",null,e.db_user,"@",null!==(t=e.db_host)&&void 0!==t?t:"localhost",":",e.db_port)),conns:p.filter((t=>n(t,e)))}}))}else u.push({title:null,conns:p});return a.createElement("div",{className:"CONNECTIONS flex-col  f-1 w-full min-h-0"},m,a.createElement("div",{className:"flex-row as-center w-full gap-p5 mt-1 p-p5  max-w-800"},r&&a.createElement(Btn_Btn,{href:"/new-connection",asNavLink:!0,title:"Create a new connection",iconPath:s.qX5,variant:"outline",color:"action"},"New connection"),d&&a.createElement(cn,{className:"ml-auto ",label:"",iconPath:s.XMI},a.createElement(Checkbox,{className:"ml-auto ",inputClassname:"bg-white",checked:!!c,label:"Show state connection",onChange:e=>{e.target.checked?this.setState({showStateConfirm:!0}):t.users.update({id:i.id},{options:{showStateDB:!1}})}}))),!l.length&&a.createElement(Zt,{color:"info"},"No connections available/permitted"),a.createElement("div",{className:"flex-col o-auto min-h-0 p-p5 pb-1 mt-1 gap-2 ai-center"},u.map((({title:e,conns:t},n)=>a.createElement("div",{key:n,className:" max-w-800 w-full"},e,a.createElement("div",{className:"flex-col gap-p5 "},t.map((e=>a.createElement(ta,{key:e.id,...this.props,c:e,isAdmin:r})))))))))}}const ko=e=>{var t,n;return`${null!==(t=e.db_host)&&void 0!==t?t:"localhost"}:${null!==(n=e.db_port)&&void 0!==n?n:"5432"}/${e.db_name}`},Mo=e=>a.createElement("div",{className:"flex-col gap-p1 f-1 b b-gray-400 rounded o-hidden "+(e.className||"")},a.createElement(CodeEditor,{style:{minWidth:"200px",minHeight:"100px"},...e,className:"f-1 ",options:{tabSize:2,minimap:{enabled:!1},lineNumbers:"off",...e.options}})),Fo=[{key:"disable",subLabel:"only try a non-SSL connection"},{key:"allow",subLabel:"first try a non-SSL connection; if that fails, try an SSL connection"},{key:"prefer",subLabel:"(Default) first try an SSL connection; if that fails, try a non-SSL connection"},{key:"require",subLabel:"only try an SSL connection. If a root CA file is present, verify the certificate in the same way as if verify-ca was specified"},{key:"verify-ca",subLabel:"only try an SSL connection, and verify that the server certificate is issued by a trusted certificate authority (CA)"},{key:"verify-full",subLabel:"only try an SSL connection, verify that the server certificate is issued by a trusted CA and that the requested server host name matches that in the certificate"}],Po=({c:e,updateConnection:t,nameErr:n,warning:l,test:o,mode:i,isForStateDB:r,...c})=>{var d;const m="db_ssl"in e?e.db_ssl||"disable":"disabled",{dbs:p,dbsTables:u,dbsMethods:h,dbProject:g,origCon:f}="dbs"in c?c:{},E=null==u?void 0:u.find((e=>"connections"===e.name)),{type:v}=e;return a.createElement(a.Fragment,null,!r&&a.createElement(FormField,{label:"Connection name",hint:"Optional",type:"text",error:n,value:e.name,asColumn:!0,onChange:e=>{t({name:e})}}),a.createElement("div",{className:"flex-col gap-p5 ta-left"},a.createElement("label",{className:"m-0 text-gray-500 "},"Connection type"),a.createElement(ButtonGroup,{value:v,options:["Standard","Connection URI"],onChange:e=>{t({type:e})}})),"Prostgles"===v?a.createElement(a.Fragment,null,a.createElement(FormField,{label:"Socket URL",type:"url",required:!0,value:e.prgl_url,onChange:e=>{t({prgl_url:e})}}),a.createElement(FormField,{label:"Socket params (JSON)",type:"text",required:!0,value:e.prgl_params,onChange:e=>{t({prgl_params:e})},hint:'{ "path": "/socket" } '})):"Connection URI"===v?a.createElement(a.Fragment,null,a.createElement(FormField,{label:"Connection URI",type:"text",required:!0,asColumn:!0,value:e.db_conn,onChange:e=>{t({db_conn:e})},hint:"postgres://user:pass@host:port/database?sslmode=require"})):a.createElement(a.Fragment,null,a.createElement(FormField,{asColumn:!0,id:"u",value:e.db_user,label:"User",type:"text",autoComplete:"off",onChange:e=>t({db_user:e})}),a.createElement(FormField,{asColumn:!0,id:"pass",value:e.db_pass,label:"Password",type:"text",autoComplete:"off",onChange:e=>t({db_pass:e})}),a.createElement(FormField,{asColumn:!0,id:"d",value:e.db_name,label:"Database",type:"text",autoComplete:"off",onChange:e=>{t({db_name:e})},rightIcons:"clone"===i&&e.db_name&&(null==f?void 0:f.db_name)&&f.db_name!==e.db_name&&(null==g?void 0:g.sql)&&a.createElement(M,{title:"Create database",positioning:void 0,button:a.createElement(Btn_Btn,{iconPath:s.qX5,title:"Create this database as a clone from "+f.db_name}),initialState:{query:"",action:"create"},render:(t,{query:n,action:l},o)=>{if("clone"===l)Ho(f.db_name,e.db_name,g.sql).then((e=>{e!==n&&o({query:e})}));else{const t=`CREATE DATABASE ${e.db_name}; `;t!==n&&o({query:t})}return a.createElement("div",{className:"flex-col gap-1"},a.createElement(ButtonGroup,{value:l,options:["create","clone"],onChange:e=>o({action:e})}),"clone"===l&&a.createElement(Zt,null,"You are about to clone the current database ",f.db_name," into ",e.db_name,". This will close all existing connections to the current database!"),"create"===l&&a.createElement(Zt,{color:"action"},"You are about to create a new database: ",e.db_name),a.createElement(Mo,{value:n,language:"sql",style:{minHeight:"400px"}}),a.createElement(Btn_Btn,{variant:"filled",color:"action",onClickPromise:()=>g.sql(n).then(t)},"Run"))}})}),a.createElement(FormField,{asColumn:!0,id:"h",value:e.db_host,label:"Host",type:"text",autoComplete:"off",onChange:e=>t({db_host:e})}),a.createElement(FormField,{asColumn:!0,id:"p",value:e.db_port,label:"Port",type:"number",autoComplete:"off",onChange:e=>t({db_port:e})})),l&&a.createElement(Chip,{color:"yellow",value:l}),"Prostgles"!==v&&a.createElement(a.Fragment,null,a.createElement(cn,{label:"SSL options"},a.createElement(FormField,{asColumn:!0,id:"s",label:"SSL Mode",fullOptions:Fo,required:!0,value:e.db_ssl,onChange:async e=>{t({db_ssl:e,type:"Standard"})}}),["verify-ca","verify-full","require","prefer","allow"].includes(m)&&a.createElement(a.Fragment,null,a.createElement(FormField,{asColumn:!0,id:"ssl_cert",label:"CA Certificate",type:"file",labelStyle:{flex:"unset"},onChange:async e=>{var n;const a=e[0];t({ssl_certificate:null!==(n=await(null==a?void 0:a.text()))&&void 0!==n?n:void 0})}}),a.createElement(FormField,{asColumn:!0,id:"ssl_client_cert",label:"Client Certificate",type:"file",labelStyle:{flex:"unset"},onChange:async e=>{var n;const a=e[0];t({ssl_client_certificate:null!==(n=await(null==a?void 0:a.text()))&&void 0!==n?n:void 0})}}),a.createElement(FormField,{asColumn:!0,id:"ssl_client_cert_key",label:"Client Key",type:"file",labelStyle:{flex:"unset"},onChange:async e=>{var n;const a=e[0];t({ssl_client_certificate_key:null!==(n=await(null==a?void 0:a.text()))&&void 0!==n?n:void 0})}}),a.createElement(FormField,{asColumn:!0,id:"ssl_rejectUnauthorized",label:"Reject unauthorized",type:"checkbox",labelStyle:{flex:"unset"},value:e.ssl_reject_unauthorized,onChange:e=>{t({ssl_reject_unauthorized:e})},hint:null===(d=null==E?void 0:E.columns.find((e=>"ssl_reject_unauthorized"===e.name)))||void 0===d?void 0:d.hint}))),!r&&a.createElement(FormField,{asColumn:!0,id:"swatch",className:"mt-1",label:"Watch schema",hint:"Will reload on schema change. Requires superuser for best experience",required:!0,type:"checkbox",labelStyle:{flex:"unset"},value:e.db_watch_shema,onChange:e=>{t({db_watch_shema:e})}}),a.createElement("div",{className:"flex-col my-1 gap-1"},o.onTest&&a.createElement(Btn_Btn,{variant:"text",size:"small",iconPath:s.Fyt,onClickPromise:o.onTest},"Test connection"),!!o.status&&a.createElement("div",{style:{padding:"1em",borderRadius:"8px"},className:"chip flex-col p-1 "+(o.statusOK?"green":"red")},a.createElement("span",{className:"ws-pre"},o.status)))))},Ho=(e,t,n)=>n("/* originaldb must be idle/not accessed by other users */ \n   CREATE DATABASE ${newDb} WITH TEMPLATE ${oldDb} OWNER current_user; \n   \n   /* To make originaldb idle */ \n    SELECT pg_terminate_backend(pg_stat_activity.pid)   \n    FROM pg_stat_activity  \n    WHERE pg_stat_activity.datname = ${newDb}   \n    AND pid <> pg_backend_pid(); \n    ",{oldDb:e,newDb:t},{returnType:"statement"}),Bo={id:void 0,name:null,type:"Standard",db_user:"",db_pass:"",db_name:"",db_host:"",db_port:5432,db_ssl:"prefer",prgl_url:"",prgl_params:"",db_conn:"",db_watch_shema:!0};class NewConnection extends a.Component{constructor(){super(...arguments),this.state={conNotFound:!1,nameErr:"",connection:Bo,wasEdited:!1,status:"",statusOK:!1},this.componentDidMount=async()=>{const{dbs:e}=this.props;if(this.conId&&e){const t=await e.connections.findOne({id:this.conId});t?this.setState({originalConnection:t,connection:{...t},mode:"edit"}):this.setState({conNotFound:!0})}else!this.conId&&e&&this.setState({mode:"insert"})},this.testConnection=async()=>{const{connection:e}=this.state,{dbsMethods:t}=this.props;this.setState({status:""});try{await t.testDBConnection(e),this.setState({status:"OK",statusOK:!0})}catch(e){this.setState({status:e.err_msg,statusOK:!1})}},this.onClickDelete=async()=>{const{connection:e}=this.state,{onDeleted:t,dbsMethods:n}=this.props;try{await n.deleteConnection(e.id),null==t||t()}catch(e){this.setState({error:vo(e,"err.err_msg")||vo(e,"err.constraint")||vo(e,"err.txt")||e.err_msg||e})}},this.addedName=!1}get conId(){var e;return null===(e=this.props)||void 0===e?void 0:e.connectionId}render(){const{nameErr:e,connection:t,status:n,statusOK:l,conNotFound:o,mode:r,validationWarning:d,error:m,originalConnection:p}=this.state,{dbs:u,dbsMethods:h,onUpserted:g,contentOnly:f,dbProject:E,dbTables:v,dbsTables:b}=this.props;if(!r)return a.createElement(Loading,null);if(!h.createConnection||!h.deleteConnection)return a.createElement(Zt,{color:"warning",className:"mt-2"},"You do not have sufficient privileges to access this");if(o)return a.createElement("div",null,a.createElement("p",null,"Connection not found"),a.createElement(i.OL,{to:"/"},"Go back"));const y=async e=>{"edit"!==r&&void 0!==e.db_name&&(this.addedName=!0);let t={...this.state.connection,...e},{connection:n,warning:a}=t.db_host&&t.db_user&&t.db_name||t.db_conn||"edit"===r?await h.validateConnection(t):{connection:t,warning:void 0};"edit"===r||this.addedName||n.name||(n.name=n.db_name);const l=this.state.wasEdited||"type"!==Object.keys(e).join("");l||(n={...n,db_conn:""},a=void 0),this.setState({nameErr:"",validationWarning:a,status:"",statusOK:!1,connection:n,wasEdited:l})};return a.createElement("div",{className:"flex-col w-fit min-h-0 "+(f?" ":" mx-auto "),style:{maxWidth:"100%",maxHeight:"100vh"}},!f&&a.createElement(i.OL,{className:"p-1  b-gray-400 round flex-row ai-center",to:"/connections"},a.createElement(c(),{path:s.J3k,size:1}),a.createElement("div",{className:"ml-p5"},"Connections")),a.createElement("div",{className:" pt-1 flex-col bg-white  min-h-0 "+(f?"":" card p-1 "),style:{maxWidth:"100%"}},a.createElement("div",{className:"flex-col gap-1 f-1 o-auto min-h-0 p-p5"},"clone"===r&&p&&a.createElement(Zt,{color:"action"},"Cloning connection: ",a.createElement("strong",null,(e=>{var t,n;return a.createElement(a.Fragment,null,a.createElement("div",{className:"shrink-label"},null!==(t=e.db_host)&&void 0!==t?t:"localhost",":",null!==(n=e.db_port)&&void 0!==n?n:"5432","/",e.db_name))})(p))),a.createElement(Po,{...this.props,c:t,nameErr:e,updateConnection:y,mode:r,test:{onTest:this.testConnection,status:n,statusOK:l}})),m&&a.createElement(ErrorComponent,{error:m}),a.createElement("div",{className:"flex-row-wrap ai-center mt-1 gap-1 "},"edit"===r&&a.createElement(sn,{button:a.createElement(Btn_Btn,{iconPath:s.vTx,color:"danger",variant:"outline"},"Delete..."),title:"Delete connection",message:a.createElement("div",{className:"flex-col h-fit gap-1"},a.createElement(Zt,{variant:"naked",iconPath:""},"Related dashboard content will also be deleted"),a.createElement(cn,{label:"Related data"},a.createElement(JoinedRecords,{style:{padding:0},db:u,rowFilter:[{fieldName:"id",value:this.conId}],showRelated:"descendants",tableName:"connections",tables:b}))),confirmButton:e=>a.createElement(Btn_Btn,{color:"danger",variant:"outline",iconPath:s.vTx,onClickPromise:()=>this.onClickDelete().then(e)},"Delete")}),"edit"===r&&a.createElement(Btn_Btn,{title:"Clone connection",className:"f-0 mx-1 w-fit ",variant:"outline",color:"action",iconPath:s.RDO,onClick:async e=>{t.name&&y({name:t.name+" (copy)"}),this.setState({mode:"clone"})}},"Clone"),a.createElement(Btn_Btn,{className:"ml-auto w-fit",variant:"filled",color:"action",iconPath:"edit"===r?s.oL1:s.qX5,disabledInfo:"edit"===r&&JSON.stringify(t)===JSON.stringify(p)?"Nothing to update":void 0,onClickMessage:async(e,n)=>{try{const e={...t};if("edit"!==r&&delete e.id,n({loading:1}),t.name&&await u.connections.findOne({name:t.name,"id.<>":e.id}))return void this.setState({nameErr:"Already exists. Chose another name"});await h.createConnection(e),null==g||g(),n({ok:"edit"!==r?"Created!":"Updated!"})}catch(e){console.log(e);const t=vo(e,"err_msg")||vo(e,"err.err_msg")||vo(e,"err.constraint")||vo(e,"err.txt")||e.err_msg||JSON.stringify(e);this.setState({status:t,statusOK:!1})}}},"edit"!==r?"Create":"Update"))))}}const Wo=e=>{var t;const n=(0,o.UO)();return a.createElement(NewConnection,{...e,connectionId:null!==(t=e.connectionId)&&void 0!==t?t:n.id})};class Login extends RTComp{constructor(){super(...arguments),this.state={password:"",username:"",passErr:"",remember_me:!1,forgotPassword:!1,resetusername:"",didReset:!1}}async signIn(){const{username:e,password:t,remember_me:n,totp_token:a,totp_recovery_code:l,showTOTP:o}=this.state;if("token"===o&&!a||"recovery"===o&&!l)return void this.setState({error:"Must provide a token/recovery code"});const i={error:"Provided credentials are not correct"};if(e&&t)try{const{pathname:o,search:s}=window.location,r=await $o(o+s,{username:e,password:t,remember_me:n,totp_token:a,totp_recovery_code:l});if(r&&200===r.status)window.location.href=r.url;else{const e=await r.json();"Token missing"===e.err?this.setState({showTOTP:"token"}):"inactive"===e.err?this.setState({error:"Your account is not active"}):"no match"===e.err?this.setState(i):this.setState({error:e.err})}}catch(e){console.error(e),e&&e.content&&"pending"===e.content.reason?this.setState({error:"Your account has not been approved yet"}):this.setState(i)}else this.setState({error:"Username/password cannot be empty"})}onDelta(e,t,n){}render(){const{username:e,password:t,error:n,forgotPassword:l,resetusername:o,didReset:i,showTOTP:s,totp_token:r,totp_recovery_code:c}=this.state,d=a.createElement(ErrorComponent,{error:n,className:"my-1"});return a.createElement("div",{className:"Login  pb-2 card m-auto w-fit bg-white flex",style:{paddingBottom:"4em"}},a.createElement("div",{style:{maxWidth:"400px"},className:"flex-col "},a.createElement("div",{className:" "},a.createElement("div",null,a.createElement("h2",{className:"mt-0"},"Sign in")),a.createElement("form",{onSubmit:e=>{e.preventDefault()}},"token"===s?a.createElement(a.Fragment,null,a.createElement("p",null,"Open your authentication app and enter the code for Prostgles UI"),a.createElement(FormField,{id:"totp_token",value:r,type:"number",label:"6-digit code",asColumn:!0,onChange:e=>{this.setState({totp_token:e,error:""})}}),a.createElement("div",{className:"flex-row ai-center mt-p25"},a.createElement("div",{className:"text-gray-500"},"Or"),a.createElement(Btn_Btn,{type:"button",color:"action",size:"small",onClick:()=>{this.setState({showTOTP:"recovery"})}},"Enter recovery code"))):"recovery"===s?a.createElement(a.Fragment,null,a.createElement("p",null,"Open your authentication app and enter the code for Prostgles UI"),a.createElement(FormField,{id:"totp_recovery_code",value:c,type:"text",label:"2FA Recovery code",asColumn:!0,onChange:e=>{this.setState({totp_recovery_code:e,error:""})}}),a.createElement(Btn_Btn,{type:"button",color:"action",size:"small",onClick:()=>{this.setState({showTOTP:"token"})}},"Cancel")):a.createElement(a.Fragment,null,a.createElement(FormField,{id:"username",value:e,type:"username",label:"Username",asColumn:!0,onChange:e=>{this.setState({username:e,error:""})}}),a.createElement(FormField,{id:"password",value:t,type:"password",label:"Password",asColumn:!0,onChange:e=>{this.setState({password:e,error:""})}})),d,a.createElement(Btn_Btn,{type:"submit",onClickMessage:(e,t)=>{t({loading:1}),this.signIn().catch((e=>{t({err:e})}))},className:"mt-2 w-full text-sm font-medium rounded-md",variant:"filled",color:"indigo",style:{width:"100%"}},"Sign in")))),(()=>{if(!l)return null;const e=[];return i&&e.push({label:"Reset Password",onClick:async()=>{if(!i)if(o&&o.trim())try{this.setState({didReset:!0})}catch(e){console.error(e),this.setState({error:"Something went wrong"})}else this.setState({error:"Username is required"})},color:"action"}),e.push({label:"Cancel",onClickClose:!0}),a.createElement(Popup,{open:!0,title:"Forgot your password?",footerButtons:e,onClose:()=>{this.setState({forgotPassword:!1,didReset:!1,resetusername:""})}},a.createElement("div",{className:"mb-1"},a.createElement(FormField,{id:"username-reset-pwd",type:"username",label:"Enter the username address associated with your account, and we'll send you a link to reset your password.",asColumn:!0,onChange:e=>{this.setState({resetusername:e,error:""})}}),d,i&&a.createElement("div",{className:"mt-1 text-green-600"},"Thanks, we've sent you a password reset link to this username address (unless there is no account associated with it)")))})())}}async function $o(e,t){return await fetch(e,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(t)})}var Uo=n(79139),qo=n.n(Uo),jo=n(42992);const zo=({userTypes:e})=>(null==e?void 0:e.length)?a.createElement("div",{className:"flex-row-wrap gap-p5"},e.map((e=>a.createElement(Chip,{key:e,value:e,className:"bg-white shadow",style:{background:"white"}})))):null;class UserTypeSelect extends RTComp{constructor(){super(...arguments),this.state={loading:!1,tables:[],allUserTypes:[],existingACUserTypes:[]},this.d={},this.loaded=!1}async onDelta(e,t,n){const{dbs:a,connectionId:l}=this.props;this.loaded||(this.loaded=!0,this.ugSub=await a.user_types.subscribe({},{select:{id:1},returnType:"values"},(e=>{this.setState({allUserTypes:e})})),this.conUTypesSub=await a.access_control_user_types.subscribe({$existsJoined:{access_control:{connection_id:l}}},{select:{user_type:1},returnType:"values"},(e=>{this.setState({existingACUserTypes:e})})))}async onUnmount(){var e;null===(e=this.ugSub)||void 0===e||e.unsubscribe()}render(){const{allUserTypes:e,existingACUserTypes:t,noExactSearchMatch:n}=this.state,{dbs:l,userTypes:o=[],fromEditedRule:i,onChange:r}=this.props;return a.createElement(M,{button:a.createElement("div",{className:"flex-row-wrap gap-1 relative  ai-center"},!e.length&&a.createElement(Loading,{variant:"cover"}),a.createElement(zo,{userTypes:o}),1===o.length&&"admin"===o[0]?a.createElement("div",{className:"flex-row gap-1 text-yellow-600 ai-center "},a.createElement(c(),{path:s._gM,size:1}),a.createElement("div",null,"There are no unnassigned user types left. Update existing rules to free up user types or create new user types")):a.createElement("div",{className:"flex-row gap-1"},a.createElement(Btn_Btn,{iconPath:s.r9,className:" ",color:"action"},"Select"))),title:"User types",footerButtons:[n?{label:"Create",variant:"outline",iconPath:s.qX5,color:"action",onClickPromise:()=>l.user_types.insert({id:n})}:void 0,{label:"Done",variant:"filled",color:"action",onClickClose:!0,className:"ml-auto"}],onClickClose:!1,contentStyle:{padding:0}},a.createElement(SearchList,{onMultiToggle:e=>{r(e.filter((e=>e.checked)).map((e=>e.key)))},style:{maxHeight:"500px"},onType:t=>{const n=t&&e.includes(t)?void 0:t;this.state.noExactSearchMatch!==n&&this.setState({noExactSearchMatch:n})},autoFocus:!0,noSearchLimit:0,id:"targetUserGroups",items:e.map((e=>{let n="",a="";if("admin"===e)a="Cannot change admin",n="Can always access everything";else{!(null==i?void 0:i.includes(e))&&t.includes(e)&&(a="Need to remove from existing access rule first",n="Already assigned permissions")}return{key:e,checked:o.includes(e),disabledInfo:a,subLabel:n,onPress:()=>{r(o.includes(e)?o.filter((t=>t!==e)):o.concat([e]))}}})).sort(((e,t)=>+!!e.disabledInfo-+!!t.disabledInfo)),onNoResultsContent:e=>a.createElement("div",{className:"flex-row bg-white ai-center"},a.createElement("div",{className:"p-p5"},"Not found"))}))}}const Yo=function({dbs:e,dbsTables:t}){const[n,l]=(0,a.useState)([]),o=Io();(0,a.useEffect)((()=>{(async()=>{o()&&l(await e.users.find({},{select:{type:1,count:{$countAll:[]}},orderBy:{count:-1}}))})()}),[]);const[i,r]=(0,a.useState)(!1);return a.createElement(M,{className:"ml-auto",button:a.createElement(Btn_Btn,{iconPath:s._sG,color:"action",size:"small",variant:"outline"},"User type stats"),onClickClose:!1,contentStyle:{padding:0},positioning:"top-center",title:i?"All users":"User type stats",footerButtons:i?void 0:[{label:"View/Edit users",iconPath:s._sG,color:"action",variant:"filled",onClick:()=>r(!0)}],onClose:()=>{r(!1)},render:()=>a.createElement("div",{className:"UserStats flex-col gap-1 pb -1 o-auto",style:{minWidth:"250px"}},i?a.createElement(SmartTable,{key:"selectedRuleId",db:e,tableName:"users",tables:t,allowEdit:!0,showInsert:!0}):a.createElement(Table,{cols:[ie("type","User type","string",!1),ie("count","User count","string",!0)],rows:n}))})},Vo=({action:{rule:e},onChange:t,db:n,connection:l,dbsConnection:o})=>{var i;if("Run SQL"!==(null===(i=e.dbPermissions)||void 0===i?void 0:i.type))return null;const[s,r]=(0,a.useState)();xn((async()=>{r(await n.sql("\n      SELECT r.rolname, r.rolsuper, r.rolinherit, r.rolcreaterole, r.rolcreatedb, r.rolcanlogin, r.rolconnlimit, r.rolvaliduntil, r.rolreplication, r.rolbypassrls\n      FROM pg_catalog.pg_roles r\n      WHERE r.rolname = current_user\n      ",{},{returnType:"row"}))}),[]);const{dbPermissions:c,dbsPermissions:d}=e,m=xo(l,o,["db_host","db_port"]);return a.createElement(a.Fragment,null,a.createElement("div",{className:"PRunSQL my-1 ws-pre flex-col"},a.createElement("span",null,"The selected user groups will be allowed to run SQL queries."),a.createElement("span",null,"This is the same level of access as to the database as the current admin user. "),a.createElement("div",{className:"flex-col gap-p5  my-2"},(null==s?void 0:s.rolsuper)&&m?a.createElement(Zt,{color:"danger"},"This rule will allow ",a.createElement("strong",null,"superuser")," access to state database server ",a.createElement("strong",null,o.db_host,":",o.db_port),". ",a.createElement("br",null),"Can escalate to same level of access as a type ",a.createElement("strong",null,'"admin"')," user "):(null==s?void 0:s.rolsuper)?a.createElement(Zt,{color:"warning"},"Superuser access (Bypasses all permission checks, except the right to log in. This is a dangerous privilege and should not be used carelessly)"):a.createElement(qn,{label:"PG Role Attributes",className:"ws-wrap"},[(null==s?void 0:s.rolsuper)&&"Superuser",(null==s?void 0:s.rolcreatedb)&&"CreateDB",(null==s?void 0:s.rolcreaterole)&&"CreateRole",(null==s?void 0:s.rolinherit)&&"Inherit",(null==s?void 0:s.rolbypassrls)&&"BypassRLS",(null==s?void 0:s.rolcanlogin)&&"Login",(null==s?void 0:s.rolvaliduntil)&&"Valid Until"+s.rolvaliduntil].filter((e=>e))))),a.createElement(FormField,{asColumn:!0,type:"checkbox",label:"Run SQL",value:c.allowSQL,onChange:n=>{t({...e,dbPermissions:{type:"Run SQL",allowSQL:!0},dbsPermissions:d})}}))};const Go=({info:e,iconPath:t,label:n,htmlFor:l,title:o="Information"})=>{let i=a.createElement(c(),{path:t,size:1,className:"text-gray-400 mr-1"});return e&&(i=a.createElement(M,{title:o,positioning:"beneath-left",clickCatchStyle:{},button:a.createElement("div",{className:"relative",title:"Click for more information"},a.createElement(c(),{path:s.HET,className:"show-on-parent-hover absolute text-gray-500",size:.75,style:{top:"-12px",left:0}}),a.createElement(Btn_Btn,{iconPath:t,className:"text-gray-400 "}))},a.createElement("div",{className:"flex-row ws-pre ta-left"},a.createElement(c(),{path:s.EaN,size:1,className:"text-gray-400 mr-1"}),e))),a.createElement(a.Fragment,null,i,a.createElement("label",{className:"mr-1 noselect",htmlFor:l},n))},Jo=(e,t,n=!0)=>{if(e&&(0,m.isObject)(e)){const a=e,l=Eo(a);if(!l.length&&n)return"Must select at least a field";const o=l.filter((e=>!t.some((t=>t.name===e))));if(o.length)return`Invalid/disallowed columns found: ${o}`;const i=Object.values(a);if(i.some((e=>!0===e))&&i.some((e=>!1===e)))return"Cannot combine included and excluded fields"}},Xo=function({value:e,columns:t,onChange:n,label:l,excluded:o,info:i,iconPath:r=s.k0z,expectAtLeastOne:c=!1,title:d}){var p;const u=[{key:"only these fields",label:"only these fields"},{key:"all EXCEPT these fields",label:"ALL FIELDS EXCEPT"},{key:"all fields",label:"ALL FIELDS",disabledInfo:(null===(p=null==o?void 0:o.fields)||void 0===p?void 0:p.length)?o.message:void 0}],h=(0,m.isObject)(e)&&Object.values(e).some((e=>!e)),g="*"===e?u[2].key:h?u[1].key:u[0].key,f=(e,a)=>{const l=!0===e?"*":e.filter((e=>t.some((t=>t.name===e)))).reduce(((e,t)=>({...e,[t]:!!a})),{});n(l)},E=t.map((e=>{var t;return{key:e.name,disabledInfo:(null===(t=null==o?void 0:o.fields)||void 0===t?void 0:t.includes(e.name))?o.message:void 0}})),v=Array.isArray(e)?e:(0,m.isObject)(e)?Eo(null!=e?e:{}):[];(0,a.useEffect)((()=>{E.some((e=>e.disabledInfo&&v.includes(e.key)))&&f(E.filter((e=>!e.disabledInfo)).map((e=>e.key)),!0)}),[v,E]);const b=Jo(e,t,c);return a.createElement("div",{className:"flex-row ai-center"},a.createElement(Go,{iconPath:r,label:l,info:i,title:d}),a.createElement(Select_Select,{className:"mr-p5",fullOptions:u,value:g,onChange:e=>{"all fields"===e?f(!0,!0):f(v.length?v:t.map((e=>e.name)),e===u[0].key)}}),"all fields"!==g&&a.createElement(Select_Select,{id:"Select",value:v,fullOptions:E,multiSelect:!0,onChange:e=>{f(e,!h)}}),b&&a.createElement(ErrorComponent,{error:b}))},Ko=e=>!("$and"in e||"$or"in e),Qo=e=>!Ko(e),Zo=["all data","filtered data"];const ei=function(e){const{onChange:t,contextData:n,detailedFilter:l,iconPath:o=s.YgE,label:i,info:r,title:c,containerClassname:d="  "}=e,m=_o(l),[p,u]=(0,a.useState)(m?"filtered data":"all data");(0,a.useEffect)((()=>{u(m?"filtered data":"all data")}),[m]);const h=m&&"$and"in m,g=m?h?m.$and:m.$or:[];return a.createElement("div",{className:"ForcedFilterControl flex-col gap-p5",style:{minWidth:"500px"}},a.createElement("div",{className:"flex-row ai-center"},a.createElement(Go,{iconPath:o,label:i,info:r,title:c}),a.createElement(Select_Select,{options:Zo,value:p,onChange:e=>{t("all data"===e?void 0:{$and:[]})}}),"all data"!==p&&a.createElement(a.Fragment,null,a.createElement(SmartAddFilter,{...wo(e,["db","tableName","tables"]),defaultType:"=",style:{boxShadow:"unset"},className:"ml-p5 text-active",variant:"full",onChange:e=>{const n=[...g,...e];t(h?{$and:n}:{$or:n})}}))),"all data"!==p&&a.createElement(a.Fragment,null,g.length?a.createElement("div",{className:"FilterList flex-row-wrap gap-1 p-1 ml-2 "+d},((t,l)=>{if("$and"in t||"$or"in t){const o="$and"in t,i=o?t.$and:t.$or,s=i.filter(Ko),r=i.filter(Qo);return a.createElement(a.Fragment,null,a.createElement(SmartFilter,{contextData:n,filterClassName:(null==i?void 0:i.some((e=>e.minimised)))?" ":" rounded  b b-blue-500",...wo(e,["db","tableName","tables"]),operand:o?"AND":"OR",detailedFilter:s,onOperandChange:e=>{l("AND"===e?{$and:i}:{$or:i})},onChange:e=>{const n=[...e,...r];o?t.$and=n:t.$or=n,l(t)},hideToggle:!0}))}})(m,t)):a.createElement(Zt,{className:"mt-2 ",color:"danger"},"No filters added. At least one filter required")),!!g.length&&a.createElement("div",{className:"ml-2  flex-row "},a.createElement(Btn_Btn,{title:"Toggle filter section",className:"ml-1",iconProps:{style:{transition:".3s all",transform:"rotate(180deg)"},path:s.CW},onClick:()=>{const e=mn(g);t(h?{$and:e}:{$or:e})}},"Minimise"),a.createElement(M,{title:"Filtered records",contentStyle:{padding:0},className:"ml-auto",positioning:"center",button:a.createElement(Btn_Btn,{iconPath:s.hU3,color:"action"},"Preview filtered data"),render:t=>a.createElement(SmartTable,{title:({filteredRows:e,totalRows:t})=>a.createElement("div",{className:"flex-row ai-center gap-p25 ws-pre jc-center bg-gray-100 p-1"},a.createElement("div",{className:"bold"},e.toLocaleString()," records"),"from a total of",a.createElement("div",null,t.toLocaleString())),db:e.db,tableName:e.tableName,tables:e.tables,filterOperand:h?"and":"or",filter:g,onFilterChange:t=>{e.onChange({$and:t})}})})))},ti=({tableRules:e,onChange:t,table:n,db:l,tables:o,contextDataSchema:i})=>{var r,c,d,p;const u=e.select,h=(0,m.isObject)(u)?u:{fields:"*"},g=ni({table:n,tableRules:e,tables:o});return a.createElement("div",{className:"flex-col gap-2"},a.createElement(Xo,{iconPath:s.$lx,title:"SELECT fields",label:"Can view/select",info:a.createElement("div",{className:"flex-col gap-1"},a.createElement("div",null,"List of fields that can be viewed/selected"),a.createElement(Mo,{language:"sql",style:{minWidth:"400px",minHeight:"200px"},value:`\nSELECT --user defined fields\nFROM ( \n  SELECT --allowed fields\n  FROM ${JSON.stringify(n.name)} \n) t \n`})),columns:n.columns,value:h.fields,onChange:e=>{t({...h,fields:e})}}),a.createElement(ei,{label:"From",title:"SELECT filter",info:a.createElement("div",{className:"flex-col gap-1"},a.createElement("div",null,"Filter used in each select to ensure other records cannot be viewed"),a.createElement(Mo,{language:"sql",style:{minWidth:"400px",minHeight:"200px"},value:`\nSELECT * \nFROM ( \n  SELECT * \n  FROM ${JSON.stringify(n.name)} \n  WHERE --forced filter \n) t \nWHERE --user defined filter `})),db:l,tables:o,detailedFilter:h.forcedFilterDetailed,tableName:n.name,contextData:i,onChange:e=>{t({...h,forcedFilterDetailed:e})}}),a.createElement(cn,{expanded:!(!h.orderByFields&&!h.filterFields)},a.createElement(a.Fragment,null,a.createElement(Xo,{title:"SELECT order by fields",label:"Can order by",info:"List of fields allowed to be used in the ORDER BY",expectAtLeastOne:!1,iconPath:s.O0z,columns:n.columns,value:null!==(c=null!==(r=h.orderByFields)&&void 0!==r?r:h.fields)&&void 0!==c?c:"*",onChange:e=>{t({...h,orderByFields:e})}}),a.createElement(Xo,{iconPath:s.k0z,title:"SELECT filter by fields",label:"Can filter by",info:"List of fields allowed to be used in the filter condition",expectAtLeastOne:!1,columns:n.columns,value:null!==(p=null!==(d=h.filterFields)&&void 0!==d?d:h.fields)&&void 0!==p?p:"*",onChange:e=>{t({...h,filterFields:e})}}))),g&&a.createElement(ErrorComponent,{error:g}))},ni=({table:e,tables:t,tableRules:n})=>{if(n.select){const e=n.select;if((0,m.isObject)(e)&&(0,m.isObject)(e.fields)&&!(0,m.getKeys)(e.fields).length)return"Must select at least one field"}},ai=({table:e,rule:t,tables:n,onChange:l,contextData:o,db:i,info:r,title:c})=>{const d=structuredClone(null==t?void 0:t.forcedDataDetail),p=(null!=d?d:[]).map((e=>e.fieldName)),u=e=>{l({...t,forcedDataDetail:(null!=d?d:[]).filter((t=>!e.includes(t.fieldName)))})},h=e=>{l({...t,forcedDataDetail:(null!=d?d:[]).filter((t=>t.fieldName!==e.fieldName)).concat(e)})},g=e.columns.filter((e=>e.insert&&(null==d?void 0:d.some((t=>t.fieldName===e.name))))).sort(((e,t)=>p.indexOf(e.name)-p.indexOf(t.name))),f=e.columns.filter((e=>e.insert&&!(null==g?void 0:g.some((t=>t.name===e.name))))),E=v(),[b,y]=(0,a.useState)(!1);return a.createElement("div",{className:"ForcedDataControl flex-col"},a.createElement("div",{className:"flex-row  ai-center noselect"},a.createElement(Go,{htmlFor:E,iconPath:s.sNl,label:"Forced data",info:r,title:c}),a.createElement(Btn_Btn,{iconPath:(null==d?void 0:d.length)?s.r9:s.qX5,color:"action",variant:"filled",size:"small",onClick:()=>y((e=>!e))})),b&&a.createElement("div",{className:"flex-col gap-2 p-1 ml-p5 rounded bg-gray-50 shadow"},g.map((t=>{const l=null==d?void 0:d.find((e=>e.fieldName===t.name));if("context"===(null==l?void 0:l.type))return a.createElement("div",{key:t.name,className:"flex-col gap-p25 w-fit"},a.createElement("div",{className:"flex-row gap-p5 ai-center"},a.createElement(Chip,{label:t.label,variant:"naked"}),a.createElement(P,{className:"ml-auto",value:l,column:t,contextData:o,onChange:e=>{e?h({fieldName:t.name,type:"context",...e}):u([t.name])}})));const r=o.find((e=>"user"===e.name)),c=null==r?void 0:r.columns.filter((e=>e.tsDataType===t.tsDataType));return a.createElement(SmartFormField,{variant:"column",style:{marginRight:"1em",width:t.udt_name.startsWith("json")?void 0:"fit-content"},key:t.name,db:i,column:t,hideNullBtn:!0,tableName:e.name,tableInfo:n.find((t=>t.name===e.name)).info,tables:n,action:"insert",rightContent:!!(null==c?void 0:c.length)&&a.createElement("div",{className:"flex-row gap-p5 ml-1 ai-center as-end"},a.createElement(P,{value:void 0,column:t,contextData:o,onChange:e=>{e?h({fieldName:t.name,type:"context",...e}):u([t.name])}}),a.createElement(Btn_Btn,{onClick:()=>u([t.name]),iconPath:s.r5M})),value:(0,m.isObject)(null==l?void 0:l.value)||null==l?void 0:l.value,onChange:e=>{h({fieldName:t.name,type:"fixed",value:e})}})})),!!f.length&&a.createElement(Select_Select,{emptyLabel:"Add column",className:"ml-auto",btnProps:{color:"action",iconPath:s.qX5,style:{color:"var(--action)"}},style:{maxHeight:"unset"},fullOptions:f.map((e=>({key:e.name,label:e.name,subLabel:e.udt_name}))),onChange:e=>{h({fieldName:e,type:"fixed",value:void 0})}})),!b&&!!(null==d?void 0:d.length)&&a.createElement("div",{className:"flex-col gap-p5 ai-start ",style:{paddingLeft:"2em"}},d.map(((e,t)=>a.createElement("div",{key:t},a.createElement("strong",{className:"mr-p5"},e.fieldName,":"),"context"===e.type?`{{${e.objectName}:${e.objectPropertyName}}}`:JSON.stringify(e.value))))))},li=({rule:e,onChange:t,table:n,db:l,tables:o,tableRules:i,contextDataSchema:r})=>{var c;const d=(0,m.isObject)(e)?e:{fields:"*"};return a.createElement("div",{className:"flex-col gap-2"},a.createElement(Xo,{iconPath:s.exU,label:"Fields",title:"INSERT fields",info:"Fields that can be used in inserting data. \nCannot insert fields that are found in the forced data rule",columns:n.columns,excluded:{fields:null===(c=d.forcedDataDetail)||void 0===c?void 0:c.map((e=>e.fieldName)),message:"Cannot insert a field that has forced data"},value:d.fields,onChange:e=>{t({...d,fields:e})}}),a.createElement(ai,{title:"INSERT forced data",info:a.createElement("div",{className:"flex-col gap-1"},a.createElement("div",null,"Data added to each insert. These fields cannot be inserted by the user"),a.createElement(Mo,{language:"sql",style:{minWidth:"400px",minHeight:"200px"},value:`\nINSERT INTO ${JSON.stringify(n.name)} (\n  ...user_provided_columns,\n  --forced_column \n) \nVALUES(\n  ...user_provided_data,\n  --forced_data\n)`})),table:n,db:l,tableRules:i,tables:o,contextData:r,rule:d,onChange:t}),null)},oi=({rule:e,contextDataSchema:t,table:n,onChange:l,db:o,tables:i,contextData:r})=>{var c;const d=!0!==e&&e?e:{fields:"*"},m=(e,t)=>{var n,a,o;l({...d,dynamicFields:void 0===e?null===(n=d.dynamicFields)||void 0===n?void 0:n.filter(((e,n)=>n!==t)):void 0===t?[...null!==(a=d.dynamicFields)&&void 0!==a?a:[],e]:null===(o=d.dynamicFields)||void 0===o?void 0:o.map(((n,a)=>a===t?e:n))})},[p,u]=(0,a.useState)();return(0,a.useEffect)((()=>{(async()=>{const e=await(async(e,t,n,a)=>{var l,o,i,s,r,c,d,m;if(!e)return{};try{for(var p,u=!0,h=$(e.entries());!(l=(p=await h.next()).done);){s=p.value,u=!1;try{const[l,o]=s,i=await j(o.filterDetailed,n,a);if(!i)throw new Error("dynamicFields.filter cannot be empty: "+JSON.stringify(o));await t.find(i,{limit:0});try{for(var g,f=!0,E=(c=void 0,$(e.entries()));!(r=(g=await E.next()).done);){m=g.value,f=!1;try{const[e,s]=m;if(l!==e){const e=await j(s.filterDetailed,n,a);if(await t.findOne({$and:[i,e]},{select:""}))return{error:`dynamicFields.filter cannot overlap each other. \n\n          Overlapping dynamicFields rules:\n              ${JSON.stringify(o)} \n              AND\n              ${JSON.stringify(s)} \n          `}}}finally{f=!0}}}catch(e){c={error:e}}finally{try{f||r||!(d=E.return)||await d.call(E)}finally{if(c)throw c.error}}}finally{u=!0}}}catch(e){o={error:e}}finally{try{u||l||!(i=h.return)||await i.call(h)}finally{if(o)throw o.error}}return{}})(d.dynamicFields,o[n.name],r);u(e.error)})()}),[d.dynamicFields]),a.createElement("div",{className:"flex-col gap-p5 min-s-0"},a.createElement("div",{className:"flex-row ai-center"},a.createElement(Go,{label:"Dynamic fields",iconPath:s.YgE,info:"Any update targeting records from these filters will be allowed to update the custom fields provided\n\nExample use case: allow updating message.content if user.id = message.user_id. \n\nBy default only message.seen can be updated",title:"UPDATE dynamic fields rule"}),a.createElement(Btn_Btn,{iconPath:s.qX5,variant:"filled",color:"action",size:"small",onClick:()=>{m({fields:d.fields,filterDetailed:{$and:[]}},void 0)}})),!!p&&a.createElement(ErrorComponent,{error:p}),a.createElement("div",{className:"flex-col gap-p5 o-auto  f-1 min-s-0"},null===(c=d.dynamicFields)||void 0===c?void 0:c.map((({fields:e,filterDetailed:l},r)=>a.createElement("div",{key:r,className:"p-1 ml-1 shadow flex-row gap-p5 "+(r%2?" bg-gray-50 ":" bg-gray-100 ")},a.createElement("div",{className:"flex-col gap-p5"},a.createElement(Xo,{label:"Fields",columns:n.columns,value:e,onChange:e=>{m({fields:e,filterDetailed:l},r)}}),a.createElement(ei,{db:o,tableName:n.name,tables:i,detailedFilter:l,label:"Filter",onChange:t=>{m(t?{fields:e,filterDetailed:t}:void 0,r)},contextData:t,containerClassname:""})),a.createElement(Btn_Btn,{iconPath:s.r5M,onClick:()=>{m(void 0,r)}}))))))},ii=e=>{var t;const{rule:n,onChange:l,table:o,db:i,tables:r,tableRules:c,contextDataSchema:d,contextData:p}=e,u=(0,m.isObject)(n)?n:{fields:"*"},h=(({rule:e,table:t,tableRules:n})=>{var a;const l=(0,m.isObject)(e)?e:{fields:"*"};let o=(0,m.isObject)(l.fields)&&!(0,m.getKeys)(l.fields).length?"Must select at least one field":void 0;if(!o){const e=t.columns.filter((e=>e.is_pkey)).map((e=>e.name));if(e.length&&(!n.select||(0,m.isObject)(n.select)&&"*"!==n.select.fields&&q({columns:e,fieldFilter:n.select.fields}).length!==e.length))o=`Primary key fields must be allowed in Select to allow Update through the dashboard. Primary key fields: ${e}`;else{const e="Filter fields must be allowed in Select to allow Update through the dashboard";if(!n.select||(0,m.isObject)(n.select)&&"*"!==n.select.fields&&"*"!==n.select.filterFields)if(n.select&&(0,m.isObject)(n.select)){const l=t.columns.map((e=>e.name)),i=q({columns:l,fieldFilter:n.select.fields});!q({columns:l,fieldFilter:null!==(a=n.select.filterFields)&&void 0!==a?a:"*"}).filter((e=>i.includes(e))).length&&(o=e)}else n.select||(o=e)}}return o})(e);return a.createElement("div",{className:"flex-col gap-2 min-h-0"},a.createElement(Xo,{iconPath:s.UKB,label:"Can update",info:"List of fields that can be edited/updated. \nFields from forced data take precedence and cannot be updated by the user",columns:o.columns,value:u.fields,onChange:e=>{l({...u,fields:e})}}),a.createElement(ei,{label:"From",info:a.createElement("div",{className:"flex-col gap-1"},a.createElement("div",null,"Filter added to each update to ensure other records cannot be updated"),a.createElement(Mo,{language:"sql",style:{minWidth:"400px",minHeight:"200px"},value:`\nUPDATE ${JSON.stringify(o.name)}\nSET ...\nWHERE \n  forced_filter_condition\n  AND\n  user_provided_condition\n`})),db:i,tables:r,contextData:d,detailedFilter:u.forcedFilterDetailed,tableName:o.name,onChange:e=>{l({...u,forcedFilterDetailed:e})}}),a.createElement(ai,{info:a.createElement("div",{className:"flex-col gap-1"},a.createElement("div",null,"Data added to each update. These fields cannot be updated by the user"),a.createElement(Mo,{language:"sql",style:{minWidth:"400px",minHeight:"200px"},value:`\nUPDATE ${JSON.stringify(o.name)} \nSET \n  ...user_provided,\n  forced_column = force_data \n`})),table:o,db:i,tableRules:c,tables:r,contextData:d,rule:u,onChange:l}),a.createElement(cn,{expanded:!!(null===(t=u.dynamicFields)||void 0===t?void 0:t.length)},a.createElement(oi,{...e,contextDataSchema:d,contextData:p})),h&&a.createElement(ErrorComponent,{error:h}))},si=({rule:e,onChange:t,table:n,db:l,tables:o,contextDataSchema:i})=>{var s;const r=(0,m.isObject)(e)?e:{filterFields:"*"},c=(0,m.isObject)(r.filterFields)&&!(0,m.getKeys)(r.filterFields).length?"Must select at least one field":void 0;return a.createElement("div",{className:"flex-col gap-2"},a.createElement(ei,{title:"DELETE required condition",label:"Records from",info:a.createElement("div",{className:"flex-col gap-1"},a.createElement("div",null,"If specified, a filter is added to each delete to ensure no other records can be deleted"),a.createElement(Mo,{language:"sql",style:{minWidth:"400px",minHeight:"200px"},value:`\nDELETE FROM ${JSON.stringify(n.name)} \nWHERE \n  forced_filter_condition\n  AND\n  user_provided_condition\n`})),db:l,tables:o,contextData:i,detailedFilter:r.forcedFilterDetailed,tableName:n.name,onChange:e=>{t({...r,forcedFilterDetailed:e})}}),a.createElement(cn,null,a.createElement(Xo,{title:"DELETE filter fields",label:"Can filter by",info:"Fields that can be used in the delete filter",columns:n.columns,value:null!==(s=r.filterFields)&&void 0!==s?s:"*",onChange:e=>{t({...r,filterFields:e})}})),c&&a.createElement(ErrorComponent,{error:c}))},ri=(e={})=>(0,m.getKeys)(e).reduce(((t,n)=>({...t,[n]:Boolean(e[n])})),{}),ci={select:{label:{micro:"S",mini:"Select",default:"Select/View all records"},title:"View records"},insert:{label:{micro:"I",mini:"Insert",default:"Insert/Add new records"},title:"Insert/Add records"},update:{label:{micro:"U",mini:"Update",default:"Update/Edit records"},title:"Edit data"},delete:{label:{micro:"D",mini:"Delete",default:"Delete/Remove records"},title:"Remove records"}},di=e=>{var t,n,l,o;const{tableRules:i,onChange:r,className:c="",table:d,db:p,tables:u,dbsTables:h,contextData:g,errors:f,style:E}=e,v=(null!==(t=e.variant)&&void 0!==t?t:window.isLowWidthScreen)?"micro":"mini",[b,y]=(0,a.useState)(),[N,w]=(0,a.useState)(),S=null!==(n=null!=N?N:i)&&void 0!==n?n:{},[T,C]=(0,a.useState)(),_=null!=T?T:f;let x;if((0,a.useEffect)((()=>{if(!d||!(null==g?void 0:g.user)||!N)return;const e=d.columns.map((e=>e.name));(async()=>{const t=await Q(No(S,["tableName"]),e,g);console.log(g),C(t)})()}),[S,d,g]),b&&d){const e=null!==(l=null==_?void 0:_[b])&&void 0!==l?l:null==_?void 0:_.all,t=[{name:"user",columns:null===(o=h.find((e=>"users"===e.name)))||void 0===o?void 0:o.columns}],n=(e,t)=>{w({...i,[b]:e})},s={db:p,table:d,tables:u,contextDataSchema:t,dbsTables:h};x=a.createElement(Popup,{open:!0,title:`${b.toLocaleUpperCase()} rule for table ${d.name}`,focusTrap:!0,onClose:()=>{y()},footerButtons:[{label:"Cancel",onClick:()=>{y()}},{label:"OK",color:"action",variant:"filled",disabledInfo:JSON.stringify(i[b])===JSON.stringify(null==S?void 0:S[b])?"Nothing to change":void 0,onClick:()=>{S&&d&&(r(S),y())}}]},"select"===b?a.createElement(ti,{...{...s,tableRules:S,onChange:e=>n(e,"select")}}):"insert"===b?a.createElement(li,{...{...s,rule:S[b],onChange:e=>n(e,"insert")},tableRules:S}):"update"===b&&g?a.createElement(ii,{...{...s,rule:S[b],onChange:e=>n(e,"update"),contextData:g},tableRules:S}):"delete"===b?a.createElement(si,{...{...s,rule:S[b],onChange:e=>n(e,"delete")}}):null,e&&a.createElement(ErrorComponent,{error:e,className:"m-1"}))}return a.createElement("div",{className:"TablePermissionControls gap-1 "+(v?" flex-row ai-center ":" flex-col ")+c,style:E},x,(0,m.getKeys)(ci).map((e=>{const t=null==_?void 0:_[e],n=!!(null==i?void 0:i[e]);return a.createElement("div",{key:e,className:"flex-row ai-center gap-p25"},a.createElement(Btn_Btn,{className:" ",variant:n?"filled":void 0,color:n?"action":void 0,style:{padding:".5em .75em"},onClick:()=>{r({[e]:!i[e]})}},ci[e].label[null!=v?v:"default"].toUpperCase()),!!d&&a.createElement(Btn_Btn,{className:(0,m.isObject)(i[e])||t?"":"show-on-parent-hover",style:{visibility:d&&(null==i?void 0:i[e])?void 0:"hidden"},iconPath:t?s._gM:s.Shd,color:t?"danger":(0,m.isObject)(i[e])?"action":void 0,size:"small",onClick:()=>{y(e)}}))})))},mi=({action:{rule:e},onChange:t,tables:n,dbsTables:l,contextData:o,db:i})=>{var s,r;if("All views/tables"!==(null===(s=e.dbPermissions)||void 0===s?void 0:s.type))return null;const{dbPermissions:c,dbsPermissions:d}=e;return a.createElement(a.Fragment,null,a.createElement("h4",{className:"my-1"},"Allowed on ",n.length," tables:"),a.createElement(di,{dbsTables:l,db:i,tables:n,contextData:o,errors:{},tableRules:ri(null===(r=c.allowAllTables)||void 0===r?void 0:r.reduce(((e,t)=>({...e,[t]:!0})),{})),onChange:n=>{var a;let l=[...null!==(a=c.allowAllTables)&&void 0!==a?a:[]];const o=(0,m.getKeys)(n)[0];o&&(l=n[o]?Array.from(new Set(l.concat(o))):l.filter((e=>e!==o))),t({...e,dbPermissions:{type:"All views/tables",allowAllTables:l}})}}))},pi=({action:{rule:e},onChange:t,tables:n,dbsTables:l,contextData:o,db:i,tableErrors:s})=>{var r;if("Custom"!==(null===(r=e.dbPermissions)||void 0===r?void 0:r.type))return null;const{dbPermissions:c}=e;return a.createElement("div",{className:"PCustomTables flex-col min-h-0 h-fit",style:{maxHeight:"60vh"}},a.createElement("div",{className:"flex-row-wrap gap-p5 ai-center p-p5 py-1 "},a.createElement("div",{className:"mr-auto bold text-gray-400"},"Toggle All (",n.length," tables)"),a.createElement(di,{dbsTables:l,db:i,tables:n,contextData:o,className:" pr-2",style:{gap:"3em"},errors:{},tableRules:(null==c?void 0:c.customTables)?{select:c.customTables.length===n.length&&c.customTables.every((e=>!0===e.select)),insert:c.customTables.length===n.length&&c.customTables.every((e=>!0===e.insert)),update:c.customTables.length===n.length&&c.customTables.every((e=>!0===e.update)),delete:c.customTables.length===n.length&&c.customTables.every((e=>!0===e.delete))}:{},onChange:a=>{var l;const o={...c,customTables:null!==(l=c.customTables)&&void 0!==l?l:[]};o.customTables=n.map((e=>{const t=o.customTables.find((t=>t.tableName===e.name)),n=null!=t?t:{tableName:e.name},l=(0,m.getKeys)(a)[0];return n[l]=!!a[l]||void 0,n})),t({...e,dbPermissions:o})}})),a.createElement(SearchList,{id:"custom-tables",className:"shadow",placeholder:`Search ${n.length} tables & views`,limit:200,items:n.sort(((e,t)=>e.name.localeCompare(t.name))).map((r=>{var d,p;const u=null===(d=c.customTables)||void 0===d?void 0:d.find((e=>e.tableName===r.name)),h=null!=u?u:{tableName:r.name};return{key:r.name,styles:{labelWrapper:{minWidth:"60px"}},rowStyle:{border:"1px solid var(--gray-200)"},contentRight:a.createElement(di,{className:"ml-1",dbsTables:l,db:i,tables:n,contextData:o,errors:null!==(p=null==s?void 0:s[r.name])&&void 0!==p?p:{},table:r,tableRules:h,onChange:n=>{(n=>{var a;if(n){(0,m.getKeys)(n).forEach((e=>{h[e]=n[e]}));const l={customTables:null!==(a=c.customTables)&&void 0!==a?a:[],...c};u?l.customTables=l.customTables.map((e=>e.tableName===r.name?h:e)):l.customTables.push(h),t({...e,dbPermissions:l})}})(n)}})}}))}))},ui=[{key:"Create workspaces",subLabel:"Will be able to create and view own workspaces/dashboards"},{key:"Access published workspaces",subLabel:"Access published workspaces/dashboards"}],hi=({dbs:e,connectionId:t,dbsPermissions:n,onChange:l,dbPermissions:o,className:i="",style:s,onSetError:r,wspError:c})=>{var d,p;const[u,h]=(0,a.useState)(),[g,f]=(0,a.useState)(),E=Io();(0,a.useEffect)((()=>(g||(async()=>{f(await e.workspaces.subscribe({published:!0,connection_id:t},{},(e=>{h(e)})))})(),()=>{null==g||g.unsubscribe()})),[g]),xn((async()=>{var t,a,l,i;let s;const c=null!==(a=null===(t=null==n?void 0:n.viewPublishedWorkspaces)||void 0===t?void 0:t.workspaceIds)&&void 0!==a?a:[];if(c.length){const t=await e.workspaces.find({"id.$in":c});if(!E())return;const n=c.filter((e=>!t.some((t=>t.id===e))));if(n.length)return void r(`${n.length} Published workspaces not found: \n  ${n.join("\n ")}`);const a=await e.windows.find({"workspace_id.$in":c});if(!E())return;const l=a.map((e=>"table"===e.type&&e.table_name?e.table_name:void 0)).filter(m.isDefined);let i=[];if(o&&"Run SQL"!==(null==o?void 0:o.type))if("All views/tables"===(null==o?void 0:o.type)){const e=o.allowAllTables;(null==e?void 0:e.includes("select"))&&(i=l)}else if("Custom"===(null==o?void 0:o.type)){const{customTables:e}=o;i=l.filter((t=>!(null==e?void 0:e.some((e=>e.tableName===t)))))}i.length&&(s=`Must allow SELECT on all tables from the published workspaces. Missing tables: ${i}`)}s||(null==n?void 0:n.createWorkspaces)||(null===(i=null===(l=null==n?void 0:n.viewPublishedWorkspaces)||void 0===l?void 0:l.workspaceIds)||void 0===i?void 0:i.length)||(s="Must allow 'Create workspaces' or select at least one workspace within 'Access published workspaces' "),r(s)}),[o,n]);const v=null===(d=null==n?void 0:n.viewPublishedWorkspaces)||void 0===d?void 0:d.workspaceIds,b=!(!(null==u?void 0:u.length)&&!(null==v?void 0:v.length));let y=null!==(p=null==u?void 0:u.map((e=>({key:e.id,label:e.name}))))&&void 0!==p?p:[];null==v||v.map((e=>{y.some((t=>t.key===e))||y.push({key:e,label:`Deleted - ${e}`})}));const[N,w]=ui;return a.createElement("div",{className:"mt-1 flex-col gap-1 "+i,style:s},a.createElement("h3",{className:" mb-p5 mt-2 flex-row gap-p5  ai-center"},a.createElement(W,{path:ia}),a.createElement("div",null,"Workspace access:")),a.createElement("div",{className:"relative bg-white rounded shadow flex-col gap-1 ml-2 p-1 b b-gray-200"},!u&&a.createElement(Loading,{variant:"cover"}),a.createElement(FormField,{label:N.key,hint:N.subLabel,asColumn:!0,type:"checkbox",value:!!(null==n?void 0:n.createWorkspaces),onChange:e=>{l({createWorkspaces:e})}}),b&&a.createElement(Select_Select,{label:w.key+` (${(null==v?void 0:v.length)||0})`,emptyLabel:"None",btnProps:b?void 0:{disabledInfo:"No published workspaces"},value:v,fullOptions:y,multiSelect:!0,onChange:e=>{l({viewPublishedWorkspaces:{workspaceIds:e}})}})))},gi=["Custom","All views/tables","Run SQL"],fi=({action:e,dbs:t,dbsTables:n,connection:l,dbsConnection:o,onChange:i,onCancel:r,db:c,tables:d,onUpsert:p})=>{var u,h,g,f,E;if(!e)return null;const{selectedRuleId:v}="edit"===(null==e?void 0:e.type)?e:{},[b,y]=(0,a.useState)(),[N,w]=(0,a.useState)(),{rule:S}=e,{userGroupNames:T=[],dbPermissions:C={},dbsPermissions:_={}}=S,x=Io();(0,a.useEffect)((()=>{(async()=>{if("edit"===e.type&&e.selectedRuleId!==(null==N?void 0:N.id)){const n=await t.access_control.findOne({id:e.selectedRuleId});if(!x())return;if(!n)return void y("Existing rule not found");w(structuredClone({...null==n?void 0:n.rule,id:e.selectedRuleId})),i(structuredClone(null==n?void 0:n.rule))}else"create"===e.type&&N&&w(void 0)})()}),[e.type]);const[A,R]=(0,a.useState)(),[L,O]=(0,a.useState)(),[I,D]=(0,a.useState)(),[k,M]=(0,a.useState)("");L&&console.log(L);const F="string"==typeof L?L:(0,m.getKeys)(null!=L?L:{}).length?Object.entries(L).map((([e,t])=>`${e}: ${t.all||`${[t.select&&`select: ${t.select}`,t.insert&&`select: ${t.insert}`,t.update&&`select: ${t.update}`,t.delete&&`select: ${t.delete}`].filter((e=>e)).join("\n")}`}`)).join("\n"):"";(0,a.useEffect)((()=>{(async()=>{var e;const n=await t.users.findOne({type:{$in:T}});if(!x())return;const a={user:n};if(R(a),a.user&&"Custom"===(null===(e=null==S?void 0:S.dbPermissions)||void 0===e?void 0:e.type)&&S.dbPermissions.customTables){let e={};await Promise.all(S.dbPermissions.customTables.map((async t=>{var n,l,o,i;const s=t.tableName;if(d.some((e=>e.name===s))){if(!(null===(l=e[s])||void 0===l?void 0:l.all)){const n=null===(i=null===(o=d.find((e=>e.name===s)))||void 0===o?void 0:o.columns)||void 0===i?void 0:i.map((e=>e.name)),l=await Q(t,n,a);if(!x())return;(0,m.isEmpty)(l)||(e[s]=l)}}else null!==(n=e[s])&&void 0!==n||(e[s]={}),e[s].all=`Table ${s} could not be found`}))),O(e)}})()}),[T.join(),null===(h=null===(u=null==S?void 0:S.dbPermissions)||void 0===u?void 0:u.customTables)||void 0===h?void 0:h.join()]);const P="edit"===e.type&&Boolean(S&&N&&!xo(S,N,["dbPermissions","dbsPermissions","userGroupNames"])),{type:H}=C,B=v?`Edit rule ${v}`:"Create new rule",$={action:e,onChange:i,db:c,dbsTables:n,tables:d,contextData:A,dbsConnection:o,connection:l};return a.createElement("div",{className:"UserGroupRuleEditor f-1 flex-col px-1 gap-1 min-s-0"},a.createElement("div",{className:"flex-row ai-center bt b-gray-300 mb-2 text-gray-500"},a.createElement("div",{className:"py-1 font-20 bold noselect f-1 ws-nowrap text-ellipsis"},B),a.createElement(Btn_Btn,{className:"ml-auto f-0",iconPath:s.r5M,onClick:r})),a.createElement(ErrorComponent,{error:b,className:"f-0"}),a.createElement("div",{className:"flex-row ai-center"},a.createElement("h4",{className:" m-0 mr-auto flex-row gap-p5 ai-center"},a.createElement(W,{path:s.rI3}),a.createElement("div",null,"Target user types: ")),a.createElement(Yo,{dbs:t,dbsTables:n})),a.createElement("div",{className:"pl-2"},a.createElement(UserTypeSelect,{connectionId:l.id,userTypes:null!==(g=S.userGroupNames)&&void 0!==g?g:[],fromEditedRule:"edit"===e.type&&null!==(E=null===(f=e.initialRule)||void 0===f?void 0:f.userGroupNames)&&void 0!==E?E:[],dbs:t,onChange:e=>{i({...S,userGroupNames:e})}})),a.createElement("div",{className:"flex-col  "+(T.length?"":" hidden ")},a.createElement("h3",{className:" mb-p5 mt-2 flex-row gap-p5  ai-center"},a.createElement(W,{path:s.NQi}),a.createElement("div",null,"Permission type:")),a.createElement("div",{className:"pl-2 mt-p5"},a.createElement(ButtonGroup,{value:H,options:gi,className:"mb-1",onChange:e=>{i("Run SQL"===e?{userGroupNames:T,dbPermissions:{type:e,allowSQL:!1},dbsPermissions:_}:"All views/tables"===e?{userGroupNames:T,dbPermissions:{type:e,allowAllTables:[]},dbsPermissions:_}:{userGroupNames:T,dbPermissions:{type:e,customTables:[]},dbsPermissions:_})}}))),a.createElement("div",{className:" flex-col  "+(T.length&&H?"":" hidden ")+("Custom"===C.type?" f-1 ":" f-0 ")},a.createElement("div",{className:"pl-2 f-0 flex-col min-h-0 h-fit",style:{maxHeight:"60vh"}},"Run SQL"===C.type?a.createElement(Vo,{...$}):"All views/tables"===C.type?a.createElement(mi,{...$}):"Custom"===C.type?a.createElement(pi,{...$,tableErrors:"string"==typeof L?void 0:L}):null),a.createElement(hi,{className:"mt-1",dbs:t,connectionId:l.id,dbsPermissions:_,onSetError:e=>{D(e)},wspError:I,dbPermissions:C,onChange:e=>{i({...S,dbsPermissions:{...S.dbsPermissions,...e}})}}),(L&&!!Object.keys(L).length||I)&&a.createElement(Zt,{color:"danger",className:"ACCESSRULERRORS mt-2 ws-pre ml-2"},a.createElement(ErrorComponent,{style:{color:"inherit"},error:I||F})),k?a.createElement(ClickCatch,{style:{zIndex:1}},a.createElement(io,{message:k,className:"absolute-centered bg-white rounded",style:{padding:"4em"}})):a.createElement("div",{className:"flex-row-wrap py-1 mt-1 "+(window.isMobileDevice?"gap-1":"gap-2")},a.createElement(Btn_Btn,{variant:"outline",onClick:r,size:"large"},"Cancel"),a.createElement(Btn_Btn,{variant:"filled",color:"action",size:"large",disabledInfo:I?"Must fix errors first":P||!N?void 0:"Nothing to update",onClickMessage:async(t,n)=>{try{const t=(()=>{var e,t;const{dbPermissions:n}=S;if(n&&"Run SQL"!==(null==n?void 0:n.type)&&!("Custom"===n.type?null===(e=n.customTables)||void 0===e?void 0:e.filter((e=>e.select||e.update||e.insert||e.delete)).length:"All views/tables"===n.type&&(null===(t=n.allowAllTables)||void 0===t?void 0:t.length)))return"Empty rule. Must allow at least one table"})()||(e=>{var t;if("Run SQL"===(null===(t=e.rule.dbPermissions)||void 0===t?void 0:t.type)&&!e.rule.dbPermissions.allowSQL)return'Must tick "Enabled" checkbox'})(e);if(t)return void O(t);await p(),M(N?"Rule updated!":"Rule created!"),setTimeout(r,1e3)}catch(e){n({err:`Failed: ${e.toString()}`})}}},N?"Update rule":"Create rule"),v&&a.createElement(a.Fragment,null,a.createElement(Btn_Btn,{className:"ml-auto w-fit",color:"danger",onClickMessage:async(e,n)=>{n({loading:1});try{await t.access_control_user_types.delete({access_control_id:v}),await t.access_control.delete({id:v}),i({...S,userGroupNames:[]}),r()}catch(e){y(e)}}},"Remove rule")))))};const Ei="editRuleId",vi="createRule";class AccessControl extends RTComp{constructor(){super(...arguments),this.state={loading:!1,tables:[],rules:[],existingACUserTypes:[]},this.d={},this.loaded=!1,this.upsertRule=async()=>{const{dbs:e,db:t,tables:n,connectionId:a}=this.props,{rule:l}=this.state,{action:o}=this;if(!o||!l)return;if(!await e.connections.findOne({id:a})||!a)throw`Connection not found (id = ${a})`;{const t=t=>e.access_control_user_types.insert(l.userGroupNames.map((e=>({access_control_id:t,user_type:e}))));if("edit"===o.type){const{selectedRuleId:n}=o;await e.access_control.update({id:n},{rule:l}),await e.access_control_user_types.delete({access_control_id:n}),await t(n)}else{const n=await e.access_control_user_types.find({$existsJoined:{"**.connections":{id:a}},user_type:{$in:l.userGroupNames}},{select:{user_type:1},returnType:"values"});if(n.length)throw`Cannot have rules with overlapping user group names: ${n.flat().join(", ")}.\nRemove these group names from this rule or from the other rules`;{const n=await e.access_control.insert({connection_id:a,rule:l},{returning:"*"});await t(n.id)}}this.setState({ruleUpdated:!0})}}}get action(){var e,t,n,a;const{searchParams:l}=this.props,o=l.get(Ei),i=l.get(vi);return o?{type:"edit",selectedRuleId:+o,rule:null!==(e=this.state.rule)&&void 0!==e?e:null===(t=this.state.rules.find((e=>e.id===+o)))||void 0===t?void 0:t.rule,initialRule:null===(n=this.state.rules.find((e=>e.id===+o)))||void 0===n?void 0:n.rule}:i?{type:"create",rule:null!==(a=this.state.rule)&&void 0!==a?a:{}}:void 0}set action(e){const{setSearchParams:t,searchParams:n}=this.props;e?"create"===e.type?(n.delete(Ei),n.set(vi,"true"),t(n)):(n.delete(vi),n.set(Ei,e.selectedRuleId.toString()),t(n)):(n.delete(vi),n.delete(Ei),t(n))}async onDelta(e,t,n){var a;const{connectionId:l,dbs:o}=this.props;if(l&&!this.acSub&&(null===(a=o.access_control_user_types)||void 0===a?void 0:a.subscribe)){const e=async()=>{const e=await AccessControl.getRules(o,{connection_id:l});this.setState({rules:e})};this.acSub=await o.access_control.subscribe({connection_id:l},{select:""},(t=>{e()})),this.conUTypesSub=await o.access_control_user_types.subscribe({},{select:""},(t=>{e()})),this.setState({connection:await o.connections.findOne({id:l}),dbsConnection:await o.connections.findOne({is_state_db:!0})}),this.setState({workspaces:await o.workspaces.find()})}}async onUnmount(){var e,t,n;null===(e=this.ugSub)||void 0===e||e.unsubscribe(),null===(t=this.acSub)||void 0===t||t.unsubscribe(),null===(n=this.conUTypesSub)||void 0===n||n.unsubscribe()}render(){var e;const{workspaces:t,connection:n,rules:l,dbsConnection:o}=this.state,{className:i,dbs:s}=this.props,{action:r}=this;return(null===(e=s.access_control_user_types)||void 0===e?void 0:e.subscribe)?n&&o?a.createElement("div",{className:"flex-col f-1 "+i},a.createElement("div",{className:"f-1 flex-row min-h-0 "},r&&a.createElement(fi,{...this.props,action:r,onChange:e=>{this.setState({rule:e})},connection:n,dbsConnection:o,onCancel:()=>{this.action=void 0,this.setState({rule:void 0})},onUpsert:this.upsertRule}),!r&&a.createElement("div",{className:"f-1 flex-col gap-1 m-1 relative"},a.createElement("div",{className:"flex-row gap-2 ai-center"},a.createElement(Btn_Btn,{variant:"filled",color:"action",onClick:()=>{this.action={type:"create",rule:{}}}},"Create new rule")),a.createElement(oa,{workspaces:null!=t?t:[],rules:l,onSelect:e=>{this.action={type:"edit",selectedRuleId:e.id,rule:e.rule,initialRule:(0,de.quickClone)({...e.rule})},this.setState({rule:{...e.rule}})}})))):a.createElement(Loading,null):a.createElement(Zt,null,"Must be admin")}}function bi(e){var t;const{children:n,title:l,className:o="",disabledInfo:i,contentClassName:r="",contentStyle:c={},buttonStyle:d={},open:m,titleRightContent:p,titleIconPath:u,...h}=e,[g,f]=(0,a.useState)(m);return a.createElement("div",{className:"flex-col min-h-0 f-0 relative "+o,style:"getStyle"in h?null===(t=h.getStyle)||void 0===t?void 0:t.call(h,!!g):"style"in h?h.style:void 0},a.createElement("div",{className:"flex-row ai-center noselect pointer f-0 bg-white",style:g?{position:"sticky",top:0,zIndex:1,borderBottom:"1px solid #cecece",marginBottom:".5em"}:void 0},a.createElement(Btn_Btn,{className:(p?"":"f-1")+" p-p5 ta-left font-20 bold jc-start mr-1",title:"Expand section",disabledInfo:i,style:d,onClick:()=>f(!g),iconPath:null!=u?u:g?s.CW:s.zrb},l),p),g&&a.createElement("div",{style:c,className:r},n))}AccessControl.ACCESS_CONTROL_SELECT={select:{"*":1,access_control_user_types:{ids:{$array_agg:["user_type"]}}}},AccessControl.getRules=async(e,t)=>await e.access_control.find(t,AccessControl.ACCESS_CONTROL_SELECT);const yi=function({dbsMethods:e,connectionId:t}){const[n,l]=(0,a.useState)({loaded:!1,isSU:!1});return(0,a.useEffect)((()=>{(async()=>{if((null==e?void 0:e.getIsSuperUser)&&t){const n=await e.getIsSuperUser(t);l({loaded:!0,isSU:n})}})()}),[e,t]),n.loaded&&!n.isSU?a.createElement(Zt,null,"Using non superuser postgres account. This action might not be fully successful"):null},Ni=[{key:"Local",subLabel:"Saved locally (server in address bar)"},{key:"Cloud",subLabel:"Saved to Amazon S3"}],wi=[{key:"p",label:"Plain",subLabel:"Output a plain-text SQL script file"},{key:"c",label:"Custom",subLabel:"(Preferred) Output a custom-format archive suitable for input into pg_restore. This format is also compressed by default"},{key:"t",label:"Tar",subLabel:"Output a tar-format archive suitable for input into pg_restore"}],Si=[{key:"pg_dump",label:"This database",subLabel:"Backup this database only - pg_dump"},{key:"pg_dumpall",label:"This server",subLabel:"Backup this server (all databases and global data) - pg_dumpall"}],Ti={command:"pg_dump",format:"c",destination:"Local",clean:!0,ifExists:!0,keepLogs:!0};function Ci({dbs:e,dbsTables:t,opts:n,onReadyButton:l,onChange:o,dbsMethods:i,connectionId:s}){const[r,c]=(0,a.useState)(null!=n?n:Ti),d=e=>{e.clean?e.dataOnly=!1:e.dataOnly&&(e.clean=!1,e.ifExists=!1);const t={...r,...e};c(t),null==o||o(t)},m="Cloud"!==r.destination||r.credentialID?null:"Must select an S3 credential first",p="pg_dumpall"===r.command;return a.createElement("div",{className:"DumpOptions flex-col gap-1 min-s-0 o-auto",style:{maxHeight:"800px"}},a.createElement(yi,{dbsMethods:i,connectionId:s}),a.createElement(Select_Select,{className:"mr-1",label:"Data from",fullOptions:Si,value:r.command,onChange:e=>{d({command:e})}}),a.createElement(Select_Select,{className:"mr-1",label:"Destination",fullOptions:Ni,value:r.destination,onChange:e=>{d({destination:e,credentialID:r.credentialID})}}),"Cloud"===r.destination&&a.createElement(Lo,{dbs:e,dbsTables:t,selectedId:r.credentialID,onChange:e=>{d({destination:r.destination,credentialID:e})}}),a.createElement(bi,{title:"More options...",titleIconPath:"",contentClassName:"DumpOptionsMoreOptions flex-col p-1 gap-1 f-1 min-s-0",buttonStyle:{background:"white"}},"pg_dump"===r.command?a.createElement(a.Fragment,null,a.createElement(Select_Select,{label:"File format",value:r.format,fullOptions:wi,onChange:e=>{d({format:e})}}),a.createElement(Select_Select,{label:"Number of jobs",value:r.numberOfJobs,options:[1,2,3,4,5,6,7,8,9,10],onChange:e=>{d({numberOfJobs:e})}}),a.createElement(Select_Select,{label:"Compression level",value:r.compressionLevel,options:[0,1,2,3,4,5,6,7,8,9],onChange:e=>{d({compressionLevel:e})}}),a.createElement(FormField,{asColumn:!0,value:r.noOwner,type:"checkbox",label:"No owner",onChange:e=>{d({noOwner:e})},hint:"Do not output commands to set ownership of objects to match the original database"}),a.createElement(FormField,{asColumn:!0,value:r.create,type:"checkbox",label:"Create",onChange:e=>{d({create:e})},hint:"Create the database before restoring into it. If --clean is also specified, drop and recreate the target database before connecting to it."})):a.createElement(a.Fragment,null,a.createElement(FormField,{asColumn:!0,value:r.globalsOnly,type:"checkbox",label:"Globals only",onChange:e=>{d({globalsOnly:e})},hint:""}),a.createElement(FormField,{asColumn:!0,value:r.rolesOnly,type:"checkbox",label:"Roles only",onChange:e=>{d({rolesOnly:e})},hint:""}),a.createElement(FormField,{asColumn:!0,value:r.schemaOnly,type:"checkbox",label:"Schema only",onChange:e=>{d({schemaOnly:e})},hint:""})),a.createElement(FormField,{asColumn:!0,value:r.encoding,type:"text",label:"Encoding",onChange:e=>{d({encoding:e})},hint:""}),a.createElement(FormField,{asColumn:!0,value:r.clean,type:"checkbox",label:"Clean",onChange:e=>{d({clean:e})},hint:"Drop and Create commands for database objects. Will not delete objects that don't exist in the dump file"}),a.createElement(FormField,{asColumn:!0,value:r.dataOnly,type:"checkbox",label:"Data only",onChange:e=>{d({dataOnly:e})},hint:""}),a.createElement(FormField,{asColumn:!0,value:r.ifExists,type:"checkbox",label:"If exists",onChange:e=>{d({ifExists:e})},hint:"Add an IF EXISTS clause to clean commands to reduce errors. Will not work for extensions"}),a.createElement(FormField,{asColumn:!0,value:r.keepLogs,type:"checkbox",label:"Keep logs",onChange:e=>{d({keepLogs:e})},hint:"Save dump logs to the backup record. Useful for debugging"}),a.createElement(Zt,{color:"info",className:"noselect"},"For more info on options visit ",a.createElement("a",{target:"_blank",href:"https://www.postgresql.org/docs/current/"+(p?"app-pg-dumpall.html":"app-pgdump.html")},"this site"))),m?a.createElement(ErrorComponent,{error:m}):null==l?void 0:l(r))}const _i={clean:!0,create:!1,dataOnly:!1,noOwner:!1,command:"pg_restore",ifExists:!0,format:"c",keepLogs:!1};function xi(e){const{defaultOpts:t,button:n,dbs:l,backupId:o,connectionId:i,dbsMethods:r}=e,[c,d]=(0,a.useState)(),[m,p]=(0,a.useState)(null!=t?t:_i),{numberOfJobs:u,format:h,clean:g,create:f,dataOnly:E,noOwner:v,ifExists:b,keepLogs:y}=m;(0,a.useEffect)((()=>{c&&p({...m,format:(null==c?void 0:c.name.toLowerCase().endsWith(".sql"))?"p":"c"})}),[c]);const N="fromFile"in e?e.fromFile:void 0;let w=wi.slice(0).map((e=>{let t={...e};return N||t.key===h||(t.disabledInfo="Can only use the same format as the dump file"),t}));const[S,T]=(0,a.useState)(),C=Io();(0,a.useEffect)((()=>{(async()=>{o&&C()&&T(await l.backups.findOne({id:o}))})()}),[o,i]),(0,a.useEffect)((()=>{if(S){let e="pg_dumpall"===S.options.command?"p":S.options.format;h!==e&&p({...m,format:e})}}),[S]);let _=a.createElement("div",{className:"flex-col gap-1"},!!N&&a.createElement(FormField,{type:"file",asColumn:!0,label:"File",onChange:e=>{const t=e[0];d(t)}}),(!N||!!c)&&a.createElement(a.Fragment,null,a.createElement(Select_Select,{label:"File format",value:h,fullOptions:w,onChange:e=>{p({...m,format:e})}}),"p"!==h&&a.createElement(a.Fragment,null,a.createElement(Select_Select,{label:"Number of jobs",value:u,options:[1,2,3,4,5,6,7,8,9,10],onChange:e=>{p({...m,numberOfJobs:e})}}),a.createElement(FormField,{value:g,label:"Clean",hint:"Drop and Create commands for database objects. Will not delete objects that don't exist in the dump file",asColumn:!0,type:"checkbox",onChange:e=>{p({...m,clean:e})}}),a.createElement(FormField,{value:f,label:"Create",hint:"Create the database before restoring into it. If --clean is also specified, drop and recreate the target database before connecting to it. Set to false if restoring into a different database.",asColumn:!0,type:"checkbox",onChange:e=>{p({...m,create:e})}}),a.createElement(FormField,{value:E,label:"Data only",hint:"Restore only the data, not the schema (data definitions). Table data, large objects, and sequence values are restored, if present in the archive.",asColumn:!0,type:"checkbox",onChange:e=>{p({...m,dataOnly:e})}}),a.createElement(FormField,{value:v,label:"No owner",hint:"Do not output commands to set ownership of objects to match the original database",asColumn:!0,type:"checkbox",onChange:e=>{p({...m,noOwner:e})}}),a.createElement(FormField,{value:b,label:"If exists",hint:"Use conditional commands (i.e., add an IF EXISTS clause) to drop database objects. This option is not valid unless --clean is also specified.",asColumn:!0,type:"checkbox",onChange:e=>{p({...m,ifExists:e})}})),a.createElement(FormField,{asColumn:!0,value:y,type:"checkbox",label:"Keep logs",onChange:e=>{p({...m,keepLogs:e})},hint:"Save restore logs to the backup record. Useful for debugging"}),"p"!==h&&a.createElement(Zt,{color:"info",className:"noselect"},"For more info on options visit ",a.createElement("a",{target:"_blank",href:"https://www.postgresql.org/docs/current/app-pgrestore.html"},"this site"))));const x="p"===h&&a.createElement(Zt,{color:"warning"},"Data from this entire server (including user data) may be affected because this is a restore from a plain SQL file.");let A;return N?(A=a.createElement(Zt,{variant:"naked",iconPath:s.EeS,color:"action",className:"text-medium font-20 ",style:{fontWeight:400}},"Restore database from ",a.createElement("strong",null,c?Gl(null==c?void 0:c.name,44,void 0,!0):"local file"," ")),_=a.createElement(a.Fragment,null,A,a.createElement(yi,{dbsMethods:r,connectionId:i}),x,_)):(A=a.createElement(Zt,{variant:"naked",iconPath:s.EeS,color:"action",className:"text-medium font-20 ",style:{fontWeight:400}},"Restore ","pg_dumpall"===(null==S?void 0:S.options.command)?"server ":"database ","using backup from ",a.createElement("strong",null,new Date(null==S?void 0:S.created).toLocaleString())),_=a.createElement(a.Fragment,null,A,a.createElement(yi,{dbsMethods:r,connectionId:i}),x,a.createElement(bi,{title:"Options",className:"w-full",contentClassName:"p-1",buttonStyle:{background:"white"}},_))),a.createElement(sn,{contentStyle:{maxWidth:"700px"},message:a.createElement(Zt,{color:"warning"},"If you continue the current database and/or server information might be lost. This process is not reversible"),button:n,confirmButton:t=>"onReadyButton"in e?e.onReadyButton(m,t):a.createElement(Btn_Btn,{iconPath:s.EeS,size:"small",color:"action",variant:"filled",onClick:()=>(async e=>{if(!r.streamBackupFile)return;const{streamBackupFile:t}=r,n=c;if(!n)return;const a=n.stream(),l=await t("start",n.name,i,null,n.size,m),o=new WritableStream({start(e){},async write(e,n){try{await t("chunk",l,null,e,void 0)}catch(e){console.error(e),n.error(e),o.abort(e)}},async close(){(async()=>{await t("end",l,null,void 0,void 0)})()},abort(e){console.error("[abort]",e)}});null==a||a.pipeTo(o),e()})(t)},"Restore"),hideConfirm:!(!N||c),topContent:e=>_})}const Ai=[{key:"Local",subLabel:"Saved locally (server in address bar)"},{key:"Cloud",subLabel:"Saved to Amazon S3"}],Ri=[{key:"hourly",label:"Hourly"},{key:"daily",label:"Daily"},{key:"weekly",label:"Weekly"},{key:"monthly",label:"Monthly"}],Li=[{key:1,label:"Monday"},{key:2,label:"Tuesday"},{key:3,label:"Wednesday"},{key:4,label:"Thursday"},{key:5,label:"Friday"},{key:6,label:"Saturday"},{key:7,label:"Sunday"}];const Oi=function({dbs:e,dbsTables:t,dbsMethods:n,connectionId:l}){var o;const[i,r]=(0,a.useState)(),[c,d]=(0,a.useState)(),[m,p]=(0,a.useState)(Ti),u=Io();(0,a.useEffect)((()=>{(async()=>{if(u())r(await e.connections.subscribeOne({id:l},{},(e=>{u()&&d(e)})))})()}),[]);const h=(t,n=!0)=>{var a;return e.connections.update({id:l},{backups_config:n?{...null!==(a=null==c?void 0:c.backups_config)&&void 0!==a?a:{},...t}:t})},g=null==c?void 0:c.backups_config,f=(null==g?void 0:g.err)&&!(null===(o=g.cloudConfig)||void 0===o?void 0:o.credential_id)&&g.enabled;return a.createElement(M,{button:a.createElement(Btn_Btn,{iconPath:s.MbM,variant:(null==g?void 0:g.enabled)?"filled":"outline",color:f?"danger":"action",className:"mr-1"},(null==g?void 0:g.enabled)?`Automatic backups: ${g.frequency}`:"Enable automatic backups"),positioning:"beneath-left",render:o=>{var i,s,r,d;return a.createElement("div",{className:"flex-col gap-1"},f&&a.createElement(Zt,{color:"danger"},g.err),a.createElement(Select_Select,{className:"mr-1",label:"Destination",fullOptions:Ai,value:(null===(i=null==c?void 0:c.backups_config)||void 0===i?void 0:i.cloudConfig)?"S3":"Local",onChange:e=>{h({cloudConfig:"Cloud"===e?{}:null})}}),!!(null===(s=null==c?void 0:c.backups_config)||void 0===s?void 0:s.cloudConfig)&&a.createElement(Lo,{dbs:e,dbsTables:t,selectedId:(null===(r=null==c?void 0:c.backups_config)||void 0===r?void 0:r.cloudConfig.credential_id)||void 0,onChange:e=>{e&&h({cloudConfig:{credential_id:e}})}}),a.createElement(Select_Select,{label:"Frequency",fullOptions:Ri,value:null===(d=null==c?void 0:c.backups_config)||void 0===d?void 0:d.frequency,onChange:e=>{h({frequency:e})}}),(null==g?void 0:g.frequency)&&a.createElement(a.Fragment,null,a.createElement(FormField,{asColumn:!0,type:"number",inputProps:{min:1,max:200},label:"Keep last",hint:"Will delete older automatic backups except top N. 0 means nothing will get deleted",value:null==g?void 0:g.keepLast,onChange:e=>{h({keepLast:+e})}}),"hourly"!==(null==g?void 0:g.frequency)&&a.createElement(Select_Select,{label:"Hour of day for backup",options:new Array(24).fill(1).map(((e,t)=>t)),value:null==g?void 0:g.hour,onChange:e=>{h({hour:e})}}),"weekly"===(null==g?void 0:g.frequency)&&a.createElement(Select_Select,{label:"Day of week for backup",fullOptions:Li,value:null==g?void 0:g.dayOfWeek,onChange:e=>{h({dayOfWeek:e})}}),"monthly"===(null==g?void 0:g.frequency)&&a.createElement(Select_Select,{label:"Day of month for backup",options:new Array(31).fill(1).map(((e,t)=>t+1)),value:null==g?void 0:g.dayOfMonth,onChange:e=>{h({dayOfMonth:e})}}),a.createElement(Ci,{connectionId:l,dbsMethods:n,dbs:e,dbsTables:t,opts:m,onChange:p})),a.createElement("div",{className:"flex-row-wrap gap-1"},a.createElement(Btn_Btn,{onClick:o,variant:"outline"},"Close"),a.createElement(Btn_Btn,{variant:"filled",color:(null==g?void 0:g.enabled)?"warn":"action",onClickMessage:(e,t)=>{var n;h({enabled:!(null==g?void 0:g.enabled),dump_options:null!==(n=null==g?void 0:g.dump_options)&&void 0!==n?n:Ti}).then((()=>t({ok:"Success!"}))).catch((e=>t({err:e})))}},(null==g?void 0:g.enabled)?"Disable":"Enable")))}})},Ii=({message:e,value:t,totalValue:n})=>{const l=n>t?Math.round(100*t/n):-1,o=a.createElement("div",{className:" ",style:{borderRadius:"2px",height:"4px",width:"200px",animation:l>-1?void 0:"indeterminateAnimation 1s infinite linear",backgroundImage:l>-1?`linear-gradient(90deg,  #05b0df 0%, #05b0df ${l}%, #ddf8ff ${l}%, #ddf8ff)`:"linear-gradient(90deg,  #05b0df 40%,  #ddf8ff 40%, #ddf8ff)"}});return a.createElement("div",{className:"flex-col gap-p25"},o,e)},Di=[{key:"This connection"},{key:"Deleted connections"},{key:"All connections"}];const ki=function({dbs:e,dbsTables:t,dbsMethods:n,connectionId:l,serverState:o}){const i=l,[r,c]=(0,a.useState)(),[d,m]=(0,a.useState)(),[p,u]=(0,a.useState)(Di[0].key),[h,g]=(0,a.useState)(Ti),f=Io();(0,a.useEffect)((()=>{(async()=>{if(f())c(await e.connections.subscribeOne({id:i},{},(e=>{f()&&m(e)})))})()}),[]);const E=(e,t)=>{var n,l,o,i,s,r;const c={padding:0,background:"unset",border:"unset"},d=+((null===(n=null==e?void 0:e.loading)||void 0===n?void 0:n.total)||t.sizeInBytes||+t.dbSizeInBytes||0);return e?"ok"in e?a.createElement(Chip,{style:c,className:"font-12",color:"green",value:"Completed"}):"err"in e?a.createElement(Chip,{style:c,color:"red",value:ErrorComponent.parsedError(e.err)}):(null==e?void 0:e.loading)?a.createElement("div",{className:"text-gray-500"},a.createElement(Ii,{message:e.loading.loaded?`Processed ${Mi(null!==(l=e.loading.loaded)&&void 0!==l?l:0)}/${d?Mi(d):"unknown"}`:"Preparing...",value:null!==(i=null===(o=e.loading)||void 0===o?void 0:o.loaded)&&void 0!==i?i:0,totalValue:null!==(r=null===(s=e.loading)||void 0===s?void 0:s.total)&&void 0!==r?r:0})):null:null},v=no,b=({logs:e,completed:t,type:n})=>a.createElement(M,{showFullscreenToggle:{},title:"Logs",button:e?a.createElement(Btn_Btn,{className:"w-full",variant:"outline",size:"small"},t?"...":Gl((e||"").split("\n").at(-1).slice("dump"===n?22:26),40,"...")):a.createElement("div",null),onClickClose:!1,positioning:"top-center"},a.createElement(CodeEditor,{style:{minWidth:"80vw",minHeight:"80vh"},value:e,language:"bash"})),y={name:"restore_logs",renderValue:(e,t)=>{var n;return b({logs:e,completed:!(null===(n=t.restore_status)||void 0===n?void 0:n.loading),type:"restore"})}},N={name:"dump_logs",renderValue:(e,t)=>{var n;return b({logs:e,completed:!(null===(n=t.status)||void 0===n?void 0:n.loading),type:"dump"})}};if(!o.canDumpAndRestore)return a.createElement("div",{className:"flex-col p-1 gap-1 f-1 min-h-0 w-fit"},a.createElement(Zt,null,"This feature is not available. The following commands are not available to the server pg_dump, pg_restore and psql "));const w="Stopped by user",S="This connection"===p?{connection_id:i}:"Deleted connections"===p?{connection_id:null}:{};return a.createElement("div",{className:"flex-col p-1 gap-2 f-1 min-h-0 w-fit"},a.createElement("div",{className:"flex-row-wrap ai-center gap-p5"},a.createElement(M,{button:a.createElement(Btn_Btn,{variant:"filled",color:"action",iconPath:s.XDJ},"Create backup"),positioning:"beneath-left",render:l=>a.createElement("div",{className:"flex-col gap-1 f-1 min-s-0"},a.createElement(Ci,{connectionId:i,dbsMethods:n,dbs:e,dbsTables:t,opts:h,onChange:g}),a.createElement("div",{className:"flex-row gap-1"},a.createElement(Btn_Btn,{variant:"outline",onClick:l},"Cancel"),a.createElement(Btn_Btn,{variant:"filled",color:"action",onClickPromise:async()=>{try{await n.pgDump(i,"Cloud"===h.destination?h.credentialID:null,h)}catch(e){throw console.error(e),e}l()}},"Start backup")))}),o.isElectron?a.createElement(a.Fragment,null):a.createElement(Oi,{dbs:e,dbsTables:t,connectionId:i,dbsMethods:n}),a.createElement(xi,{dbs:e,connectionId:i,dbsMethods:n,fromFile:1,button:a.createElement(Btn_Btn,{color:"action",iconPath:s.weJ},"Restore from file...")}),a.createElement(sn,{className:"",button:a.createElement(Btn_Btn,{iconPath:s.x9U,title:"Will need to confirm"},"Delete all..."),message:a.createElement(Zt,{style:{alignItems:"center"},color:"danger"},"Will delete ALL backup files from storage for this connection. This action is not reversible!"),confirmButton:t=>a.createElement(a.Fragment,null,a.createElement(Btn_Btn,{iconPath:s.x9U,variant:"outline",color:"danger",onClickPromise:async()=>{let a;do{a=await e.backups.findOne({connection_id:i}),a&&await n.bkpDelete(a.id,!0)}while(a);t()}},"Force delete all backups"))})),a.createElement(SmartCardList,{db:e,tableName:"backups",btnColor:"gray",style:{minHeight:"250px"},title:"Restore in progress:",tables:t,filter:{$and:[S,{"restore_status.<>":null},{"restore_status->loading.<>":null},{$or:[{"restore_status->err":null},{"restore_status->>err.<>":w}]}]},realtime:!0,className:"mt-2",orderBy:{created:!1},excludeNulls:!0,fieldConfigs:[{name:"id",hide:!0},{name:"restore_status",renderValue:E},{name:"restore_start",label:"Started",select:{$ageNow:["restore_start",null,"second"]},renderValue:v},y],footer:t=>a.createElement("div",{className:"flex-row-wrap gap-1 jc-end ai-center"},a.createElement(Btn_Btn,{iconPath:s.fUz,variant:"outline",onClickPromise:()=>e.backups.update({id:t.id},{restore_status:{err:w}})},"Stop")),noDataComponent:a.createElement(a.Fragment,null),noDataComponentMode:"hide-all"}),a.createElement(SmartCardList,{db:e,tableName:"backups",btnColor:"gray",style:{minHeight:"250px"},title:"Backup in progress:",tables:t,filter:{$and:[S,{"status->ok":null}]},realtime:!0,className:"mt-2",orderBy:{created:!1},excludeNulls:!0,fieldConfigs:[{name:"id",hide:!0},{name:"status",label:"Dump status",renderValue:E},{name:"created_ago",label:"Started",select:{$ageNow:["created",null,"second"]},renderValue:v},N],footer:e=>a.createElement("div",{className:"flex-row-wrap gap-1 jc-end ai-center"},a.createElement(Btn_Btn,{iconPath:s.fUz,variant:"outline",color:"danger",onClickPromise:()=>n.bkpDelete(e.id,!0)},"Stop & delete")),noDataComponent:a.createElement(a.Fragment,null),noDataComponentMode:"hide-all"}),a.createElement(SmartCardList,{btnColor:"gray",title:a.createElement("div",{className:"mt-1 flex-col gap-1"},a.createElement("label",{className:"font-16 bold"},"Completed backups"),a.createElement("div",{className:"flex-row ai-center gap-p5"},a.createElement(ButtonGroup,{variant:"select",options:Di.map((e=>e.key)),value:p,onChange:e=>u(e)}))),db:e,tableName:"backups",tables:t,filter:{$and:[S,{"status->ok":{"<>":null}}]},realtime:!0,orderBy:{created:!1},excludeNulls:!0,fieldConfigs:[{name:"id",hide:!0},{name:"initiator",label:" ",renderValue:e=>a.createElement("div",{title:e},"automatic_backups"===e?a.createElement(W,{path:s.MbM,size:1}):"manual_backup"===e?a.createElement(W,{path:s.B8W}):e)},{name:"uploaded_",label:"Created",select:{$ageNow:["created",null,"second"]},renderValue:v},"destination",{name:"uploaded",hide:!0},{name:"sizeInBytes",renderValue:e=>a.createElement("span",{title:(+e||0).toLocaleString()+" Bytes"},Mi(+e||0))},{name:"status",label:"Dump status",renderValue:E},N,{name:"restored_",label:"Last restored",select:{$ageNow:["restore_end",null,"second"]},renderValue:v},y],footer:t=>a.createElement("div",{className:"flex-row-wrap gap-1 jc-end ai-center show-on-parent-hoverdd"},a.createElement(sn,{show:t.uploaded?void 0:"confirmButton",button:a.createElement(Btn_Btn,{iconPath:s.x9U,title:"Will need to confirm"},"Delete"),message:a.createElement(Zt,{color:"warning"},"Will delete the backup file from storage. This action is not reversible!"),confirmButton:e=>a.createElement(a.Fragment,null,a.createElement(Btn_Btn,{iconPath:s.x9U,variant:"outline",color:"danger",onClickPromise:()=>n.bkpDelete(t.id).then(e)},"Delete"),a.createElement(Btn_Btn,{iconPath:s.x9U,variant:"outline",color:"danger",onClickPromise:()=>n.bkpDelete(t.id,!0).then(e)},"Force delete"))}),a.createElement(Btn_Btn,{iconPath:s.OGU,href:"/prostgles_backups/"+t.id,color:"action",title:"Right click and 'Save link as...' to download"},"Download"),a.createElement(xi,{dbs:e,backupId:t.id,connectionId:i,dbsMethods:n,button:a.createElement(Btn_Btn,{iconPath:s.EeS,title:"Will need to confirm",variant:"filled",color:"action"},"Restore"),onReadyButton:(e,o)=>a.createElement(Btn_Btn,{iconPath:s.EeS,variant:"filled",color:"action",onClickPromise:()=>n.pgRestore({bkpId:t.id,connId:l},e).then(o)},"Restore")})),noDataComponent:a.createElement(Zt,{className:"",variant:"filled",color:"info",iconPath:"",style:{padding:"2em 2em",background:"var(--gray-200)"}},"No completed backups")}))};function Mi(e){if(0==e)return"0 Byte";var t=parseInt(Math.floor(Math.log(e)/Math.log(1024))+"");return Math.round(e/Math.pow(1024,t))+" "+["Bytes","KB","MB","GB","TB"][t]}const Fi=[{key:"local",label:"Local",subLabel:"Files stored within the docker volume"},{key:"S3",label:"Amazon S3",subLabel:"Files stored in the cloud"}],Pi=e=>{var t,n;const{canCreateTables:l,connection:o,dbTables:i,dbs:r,dbsTables:c,dbsMethods:d}=e,[m,p]=(0,a.useState)(!1),[{projectFolderSize:u,totalFileFolderSize:h},g]=(0,a.useState)({projectFolderSize:0,totalFileFolderSize:0}),f=Io();(0,a.useEffect)((()=>{(async()=>{var e,t,n,a,l,i;try{if(!f())return;g({projectFolderSize:"local"===(null===(t=null===(e=o.table_config)||void 0===e?void 0:e.storageType)||void 0===t?void 0:t.type)?await(null===(n=d.getFileFolderSizeInBytes)||void 0===n?void 0:n.call(d,o.id)):0,totalFileFolderSize:"local"===(null===(l=null===(a=o.table_config)||void 0===a?void 0:a.storageType)||void 0===l?void 0:l.type)?await(null===(i=d.getFileFolderSizeInBytes)||void 0===i?void 0:i.call(d)):0})}catch(e){console.error(e)}})()}),[]);const E=o.table_config,[v,b]=(0,a.useState)(null==E?void 0:E.fileTable),[y,N]=(0,a.useState)(null===(t=null==E?void 0:E.storageType)||void 0===t?void 0:t.type),[w,S]=(0,a.useState)((null==E?void 0:E.storageType)&&"credential_id"in E.storageType?E.storageType.credential_id:void 0),T=i.some((e=>e.name===v&&!e.columns.some((e=>"signed_url_expires"===e.name)))),C=!(null==E?void 0:E.fileTable)&&y&&("local"===y||"S3"===y&&w),[_,x]=(0,a.useState)(!1);return a.createElement(a.Fragment,null,!!m&&a.createElement(Hi,{...wo(e,["connection","dbsMethods"]),onClose:()=>p(!1)}),a.createElement("div",{className:" "},a.createElement("p",null,"Files can be uploaded and viewed by configuring a local or remote (Amazon S3) storage and also designating a table within this database to store all related metadata"),a.createElement("p",null,"Access to the files is controlled through the designated table: only users that are allowed to view/insert/delete the data within the file table can interact with the files "),l?null:a.createElement(Zt,null,"Cannot use this feature: Your account needs CREATE privilege")),a.createElement("div",{className:"flex-col gap-1p5"},a.createElement(FormField,{asColumn:!0,type:"checkbox",label:"Enabled",value:!!v,onChange:e=>{e?(b("files"),N("local")):(null==E?void 0:E.fileTable)?p(!0):(b(void 0),N(void 0))}}),!!v&&a.createElement(a.Fragment,null,a.createElement(FormField,{asColumn:!0,type:"text",label:"File table name",readOnly:!!(null==E?void 0:E.fileTable),title:(null==E?void 0:E.fileTable)?"Cannot be updated":"",value:v,onChange:b,error:T?"There is a table with this name in the database. Choose another name":void 0,hint:(null==E?void 0:E.fileTable)?"Contains file metadata":"Used for file metadata. Table created in the current database"})),!!y&&a.createElement(a.Fragment,null,(null==E?void 0:E.fileTable)?a.createElement(FormField,{asColumn:!0,type:"text",label:"Storage type",readOnly:!0,title:"Cannot be updated",value:y,className:"w-fit"}):a.createElement(Select_Select,{fullOptions:Fi,label:"Storage type",value:y,onChange:N}))),"S3"===y?a.createElement("div",{className:"flex-row-wrap gap-2 h-fit"},a.createElement(Lo,{dbs:r,dbsTables:c,selectedId:w,pickFirst:!0,onChange:e=>{void 0!==e&&(N("S3"),S(e))}})):"local"===y?a.createElement("div",{className:"flex-col gap-p5 h-fit"},!!(null==E?void 0:E.fileTable)&&a.createElement(a.Fragment,null,a.createElement(Chip,{variant:"naked",label:"Connection files folder size",value:Math.round((null!=u?u:0)/1e3).toLocaleString()+" MB"}),a.createElement(Chip,{variant:"naked",label:"Total files folder size",value:(null===(n=Math.round((null!=h?h:0)/1e3))||void 0===n?void 0:n.toLocaleString())+" MB"}))):null,C&&a.createElement("div",{className:"flex-col gap-1 mt-2 "},a.createElement(Zt,null,"Enabling file storage will restart the server and reload the page"),a.createElement(Btn_Btn,{color:"action",variant:"filled",iconPath:s.cU4,onClickMessage:async(e,t)=>{try{if(t({loading:1,duration:1e4}),!y||"S3"===y&&!w)throw"storageType missing";await d.setFileStorage(o.id,{fileTable:v,storageType:"local"===y?{type:y}:{type:y,credential_id:w}}),setTimeout((()=>{f()&&location.reload()}),1e3)}catch(e){t({err:e})}}},"Enable file storage")))},Hi=({dbsMethods:e,connection:t,onClose:n})=>{var l,o;const[i,s]=(0,a.useState)(!1),[r,c]=(0,a.useState)(!1),[d,m]=(0,a.useState)(!1),[p,u]=(0,a.useState)(),h="local"===(null===(l=t.table_config)||void 0===l?void 0:l.storageType.type);return a.createElement(Popup,{open:!0,title:"Disable file storage",onClose:n,footerButtons:[{label:"Cancel",onClick:n,variant:"outline"},{node:a.createElement(Btn_Btn,{color:"danger",variant:"filled",disabledInfo:d?void 0:"Must code confirm first",onClickMessage:async(a,l)=>{try{l({loading:1}),await e.setFileStorage(t.id,void 0,{keepS3Data:i,keepFileTable:r}),l({ok:"Disabled!"}),setTimeout((()=>{n(),location.reload()}))}catch(e){u(e)}}},"Disable File storage")}],contentClassName:"flex-col gap-1  p-1"},a.createElement(FormField,{type:"checkbox",label:`Keep the ${null===(o=t.table_config)||void 0===o?void 0:o.fileTable} table`,value:r,onChange:c,asColumn:!1}),a.createElement(FormField,{type:"checkbox",label:"Keep existing files",value:i&&!h,hint:h?"Local files cannot be kept":void 0,onChange:h?void 0:s,asColumn:!1}),a.createElement(Zt,{color:"warning",variant:"filled"},"File storage will be disabled "),a.createElement(rn,{className:"ai-start",onChange:m}),p&&a.createElement(ErrorComponent,{error:p}))},Bi=[{key:"By basic content type",subLabel:"image, video, audio ..."},{key:"By content type",subLabel:"image/jpeg, text/plain ..."},{key:"By extension type",subLabel:".pdf, .svg, .mp4 ..."}],Wi=e=>{const{refsConfig:t={},tables:n,onChange:l}=e,o=n.filter((e=>e.columns.some((e=>e.file))&&(e.columns.length>2||e.columns.some((e=>{var t;return!(null===(t=e.references)||void 0===t?void 0:t.length)})))));return a.createElement("div",{className:"flex-col min-h-0 f-1 mt-1"},a.createElement(Tabs,{variant:"vertical",style:{padding:0},className:"min-h-0 f-1",contentClass:"f-1 min-h-0 flex-col",items:o.reduce(((e,n)=>({...e,[n.name]:{leftIconPath:s._sG,style:{color:"var(--blue-500)"},content:a.createElement(Tabs,{variant:"vertical",className:"min-h-0 f-1",style:{display:"flex"},contentClass:"px-2 min-h-0 f-1 flex-col",items:n.columns.filter((e=>e.file)).reduce(((e,o)=>{var i,r,c;const d=null!==(c=null===(r=null===(i=t[n.name])||void 0===i?void 0:i.referenceColumns)||void 0===r?void 0:r[o.name])&&void 0!==c?c:{acceptedContent:"*"};return{...e,[o.name]:{leftIconPath:s.Giz,style:{color:"var(--blue-500)"},content:a.createElement($i,{colConfig:d,updateMergeColConfig:e=>{var a,i,s;const r=t[n.name],c=(0,m.isObject)(r)?r:{referenceColumns:{}};l({...t,[n.name]:{...c,referenceColumns:{...null!==(a=c.referenceColumns)&&void 0!==a?a:{},[o.name]:{...null!==(s=null===(i=c.referenceColumns)||void 0===i?void 0:i[o.name])&&void 0!==s?s:{},...e}}}})}})}}}),{})})}})),{})}))},$i=({colConfig:e,updateMergeColConfig:t})=>{var n;let l=Bi[0].key;const o=(e,t)=>"*"===t||Array.isArray(t)&&t.includes(e)||(0,m.isObject)(t)&&t[e];let i=[],s=e=>{};if(!e||(0,m.getKeys)(e).every((e=>"maxFileSizeMB"===e))||"acceptedContent"in e&&e.acceptedContent){l="By basic content type";i=["audio","video","image","text","application"].map((t=>({key:t,checked:o(t,"acceptedContent"in e?e.acceptedContent:"*")}))),s=e=>{t({acceptedContent:e.length===i.length?"*":e,acceptedFileTypes:void 0,acceptedContentType:void 0})}}else"acceptedContentType"in e&&e.acceptedContentType?(l="By content type",i=(0,m.getKeys)(m.CONTENT_TYPE_TO_EXT).map((t=>({key:t,checked:o(t,e.acceptedContentType)}))),s=e=>{t({acceptedContentType:e.length===i.length?"*":e,acceptedContent:void 0,acceptedFileTypes:void 0})}):"acceptedFileTypes"in e&&e.acceptedFileTypes&&(l="By extension type",i=Object.values(m.CONTENT_TYPE_TO_EXT).flat().flatMap((t=>({key:t,subLabel:(0,m.getKeys)(m.CONTENT_TYPE_TO_EXT).find((e=>{var n;return null===(n=m.CONTENT_TYPE_TO_EXT[e])||void 0===n?void 0:n.includes(t)})),checked:o(t,e.acceptedFileTypes)}))),s=e=>{t({acceptedFileTypes:e.length===i.length?"*":e,acceptedContent:void 0,acceptedContentType:void 0})});const r=i.filter((e=>e.checked));return a.createElement("div",{className:"flex-col gap-1 f-1 min-h-0"},a.createElement(FormField,{asColumn:!0,type:"number",label:"Max file size in MegaBytes",value:null!==(n=e.maxFileSizeMB)&&void 0!==n?n:1,onChange:n=>{t({...e,maxFileSizeMB:+n})}}),a.createElement(ButtonGroup,{className:"mt-1",options:Bi.map((e=>e.key)),value:l,onChange:e=>{t("By basic content type"===e?{acceptedContent:"*",acceptedFileTypes:void 0,acceptedContentType:void 0}:"By content type"===e?{acceptedContentType:"*",acceptedFileTypes:void 0,acceptedContent:void 0}:{acceptedFileTypes:"*",acceptedContent:void 0,acceptedContentType:void 0})}}),a.createElement(SearchList,{label:`Allowed types (${r.length}/${i.length})`,className:"w-fit f-1 min-h-0",style:{maxHeight:"30vh",minHeight:"300px"},items:i.map((e=>({...e,onPress:()=>{const t=i.filter((t=>t.key===e.key?!t.checked:t.checked)).map((e=>e.key)).filter(m.isDefined);s(t)}}))),onMultiToggle:e=>{const t=e.filter((e=>e.checked)).map((e=>e.key)).filter(m.isDefined);s(t)}}))},Ui=({db:e,tables:t,connection:n})=>{const l=null==n?void 0:n.table_config;return l?a.createElement(a.Fragment,null,a.createElement("p",null,"The following tables have columns that reference the file table ",a.createElement("strong",null,l.fileTable)),a.createElement("p",null,"Specify allowed file types and sizes as desired. By default any file type is allowed "),a.createElement(M,{button:a.createElement(Btn_Btn,{variant:"filled",color:"action"},"Add referenced column"),initialState:{optional:!0},render:(n,o,i)=>{const s=`ALTER TABLE ${(0,m.asName)(o.table||"empty")} ADD COLUMN ${(0,m.asName)(o.col||"empty")} UUID ${o.optional?"":" NOT NULL "} REFERENCES ${l.fileTable} (id)`;return a.createElement("div",{className:"flex-col gap-1"},a.createElement(Select_Select,{options:t.filter((e=>!e.info.is_media)).map((e=>e.name)),label:"Table",value:o.table,onChange:e=>i({table:e})}),o.table&&a.createElement(FormField,{asColumn:!0,label:"New column name",value:o.col,type:"text",onChange:e=>i({col:e})}),o.table&&o.col&&a.createElement(a.Fragment,null,a.createElement(Checkbox,{label:"Optional",onChange:e=>i({optional:e.target.checked}),checked:!!o.optional}),a.createElement(Zt,{iconPath:""},s),a.createElement(Btn_Btn,{variant:"filled",color:"action",onClickMessage:async(t,a)=>{var l;try{if(a({loading:1}),!e.sql)throw"Not enough privileges. Must be allowed to run SQL queries";await(null===(l=e.sql)||void 0===l?void 0:l.call(e,s)),a({ok:"Created!"},n)}catch(e){a({err:e})}}},"Create")))}})):null},qi=({canCreateTables:e,connection:t,tables:n,db:l,dbsMethods:o})=>{const i=null==t?void 0:t.table_config;if(!(null==i?void 0:i.fileTable)||!t)return null;const[s,r]=(0,a.useState)(i.referencedTables),c=JSON.stringify(i.referencedTables)!==JSON.stringify(s);return a.createElement(bi,{title:"Referenced tables",className:"f-1 mt-2",disabledInfo:(null==i?void 0:i.fileTable)?e?void 0:"Your account does not have CREATE privileges":"Need to configure file table first",contentClassName:"pl-1 f-1 min-h-0 flex-col pb-2"},a.createElement(Ui,{db:l,tables:n,connection:t}),a.createElement(Wi,{tables:n,refsConfig:s,onChange:r}),c&&a.createElement("div",{className:"my-1"},a.createElement(Btn_Btn,{variant:"filled",color:"action",onClickMessage:async(e,n)=>{n({loading:1});try{await o.setFileStorage(t.id,{referencedTables:s}),n({ok:"Updated!"}),setTimeout((()=>{location.reload()}),500)}catch(e){n({err:e})}}},"Update column configurations")))};class TableConfigControls extends RTComp{constructor(){super(...arguments),this.state={}}async setConnection(){const{dbs:e,connectionId:t,db:n}=this.props,a=await e.connections.findOne({id:t});if(!a)throw new Error("Connection not found");this.setState({tableConfig:a.table_config,connection:a,canCreateTables:!!n.sql&&await ji(n.sql)})}async onMount(){this.setConnection()}async updateConfig(e){const{dbs:t,connectionId:n,dbsMethods:a}=this.props;if(!n)throw"connectionId missing";await this.setConnection()}render(){const{canCreateTables:e,connection:t}=this.state,{tables:n,db:l,dbs:o,dbsTables:i,dbsMethods:s}=this.props;return t?a.createElement("div",{className:"flex-col gap-1 pl-1 f-1 min-h-0 o-auto "},a.createElement(Pi,{canCreateTables:e,connection:t,dbTables:n,dbsMethods:s,dbs:o,dbsTables:i}),a.createElement(qi,{dbsMethods:s,canCreateTables:!!e,connection:t,tables:n,db:l})):a.createElement(Loading,null)}}const ji=e=>e("SELECT has_database_privilege(current_database(), 'create') as yes",{},{returnType:"value"}),zi=({dbs:e,dbsTables:t,user:n,displayType:l})=>{if(!n)return null;const o="api_token"===l?"API tokens":"Sessions";return a.createElement(SmartCardList,{db:e,style:{maxHeight:"40vh"},tableName:"sessions",tables:t,filter:{$and:[{user_id:n.id},{type:"api_token"===l?"api_token":"web"}]},realtime:!0,className:"mt-2 min-h-0 f-1",title:o+":",noDataComponent:a.createElement(Zt,{color:"info",style:{alignItems:"center"}},"No ",o),noDataComponentMode:"hide-all",orderBy:{created:!1},limit:10,showEdit:!1,fieldConfigs:[{name:"active",label:" ",render:e=>a.createElement("div",{title:e?"Active":"Not active",className:"shadow",style:{borderRadius:"100%",width:"12px",height:"12px",background:`var(--${e?"green":"red"}-500)`}})},{name:"last_usedd",select:{$ageNow:["last_used",null,"second"]},label:"Last used",renderValue:e=>no(e)},{name:"ip_address",hide:"api_token"===l},{name:"is_connected",hide:!0},{name:"user_agent",hide:"api_token"===l,render:(e,t)=>a.createElement(M,{title:"User agent",button:a.createElement(Btn_Btn,{title:t.is_connected?"User is connected":"User is offline",style:{color:t.is_connected?"green":void 0},iconPath:Yi(e)?s.i2F:s.Bcb}),render:t=>a.createElement("div",{className:""},e)})},{name:"createdd",select:{$ageNow:["created",null,"second"]},label:"Created",renderValue:e=>to(e,!0,!0)},{name:"expiress",select:{$ageNow:["expires",null,"hour"]},label:"Expires",renderValue:e=>to(e,!0,!0)},{name:"id_num",label:" ",style:{marginLeft:"auto"},render:t=>!!t&&a.createElement(Btn_Btn,{title:"Disable",variant:"filled",color:"danger",iconPath:s.x9U,onClickPromise:()=>e.sessions.delete({id_num:t})})}]})};function Yi(e){return[/Android/i,/webOS/i,/iPhone/i,/iPad/i,/iPod/i,/BlackBerry/i,/Windows Phone/i].some((t=>e.match(t)))}const Vi=({projectPath:e,dbsMethods:t,dbs:n,dbsTables:l,user:o,connectionId:i})=>{const[r,c]=(0,a.useState)(""),[d,m]=(0,a.useState)(),p=async()=>{var e;const a=(await n.sessions.find({type:"api_token","expires.>":Date.now(),active:!0})).find((e=>"electron"===e.user_agent));a&&c(a.id),t.getAPITSDefinitions&&i&&m(await(null===(e=t.getConnectionDBTypes)||void 0===e?void 0:e.call(t,i)))};xn((async()=>{p()}),[]);const{htmlExample:u,tsExample:h}=function({token:e,projectPath:t}){const n=e?`auth: { sid_token: ${JSON.stringify(e)} },`:"",a=`const socket = io(${JSON.stringify(window.location.origin)}, { \n    ${n}\n    path: ${JSON.stringify(t)} \n  });`;return{htmlExample:`\n<!DOCTYPE html>\n<html>\n\t<head>\n\t\t<title> Prostgles </title>\n\n\t\t<meta name="viewport" content="width=device-width, initial-scale=1">\n\t\t<script src="https://unpkg.com/socket.io-client@latest/dist/socket.io.min.js" type="text/javascript"><\/script>\n\t\t<script src="https://unpkg.com/prostgles-client@latest/dist/index.js" type="text/javascript"><\/script>\t\n\t</head>\n\t<body style="white-space: pre">\n\n\t\t<script>\n\n    ${a}\n\nprostgles({\n  socket,\n  onReload: () => {},\n  onReady: async (db, methods, tableSchema, auth) => {\n    console.log(db);\n    document.body.append(JSON.stringify({ db, methods, auth }, null, 2))\n  },\n});\n\n\t\t<\/script>\n\t\t\n\t</body>\n</html>`,tsExample:`\nimport prostgles from "prostgles-client";\nimport io from "socket.io-client";\n\n${a}\n\nprostgles({\n  socket,\n  onReload: () => {},\n  onReady: async (db, methods, tableSchema, auth) => {\n    console.log(db);\n    const info = JSON.stringify({ db, methods, auth }, null, 2);\n    if(typeof document !== 'undefined'){\n    \tconsole.log(typeof document)\n    \tdocument.body.append(info)\n    } else {\n    \tconsole.log(info)\n    }\n  },\n});\n\n`}}({token:r,projectPath:e});return a.createElement("div",{className:"flex-col f-1 px-1 gap-1 min-s-0 o-auto"},a.createElement("h4",null,"Realtime API using ",a.createElement("a",{target:"_blank",href:"https://github.com/prostgles/prostgles-client-js"},"prostgles-client")," library"),a.createElement("div",{className:"flex-row gap-p5"},a.createElement(M,{button:a.createElement(Btn_Btn,{color:"action",variant:"filled",iconPath:s.qX5},"Generate API token"),initialState:{days:100},render:(e,n,l)=>a.createElement("div",{className:"flex-col gap-1"},a.createElement(FormField,{label:"Duration in days",value:n.days,type:"number",inputProps:{step:1,min:1},asColumn:!0,onChange:e=>{l({days:e})}}),a.createElement(Btn_Btn,{variant:"filled",color:"action",onClickPromise:async()=>{var a;const l=await(null===(a=t.generateToken)||void 0===a?void 0:a.call(t,+n.days));c(l),p(),e()}},"Generate"))}),a.createElement(Btn_Btn,{title:"Database typescript schema",disabledInfo:t.getConnectionDBTypes?void 0:"Not permitted",onClick:()=>{On(d,"DBoGenerated.d.ts","text/plain")},iconPath:s.fmA,color:"action"},"DBoGenerated.d.ts"),a.createElement(M,{className:"ml-auto",button:a.createElement(Btn_Btn,{iconPath:s.NAc,color:"action",variant:"filled"},"Active API Tokens"),render:e=>a.createElement(zi,{dbs:n,dbsTables:l,user:o,displayType:"api_token"})})),!!r&&a.createElement("div",{className:"flex-col gap-p5 my-1"},a.createElement("div",null,"This token will not be shown again"),a.createElement("div",{className:"b b-gray-300 flex-row ai-center rounded w-fit"},a.createElement("div",{className:"p-p5 w-fit"},r),a.createElement(Btn_Btn,{iconPath:s.a0Z}))),r?a.createElement(a.Fragment,null,a.createElement(Btn_Btn,{variant:"filled",className:"mb-p5",size:"small",iconPath:s.wLz,color:"action",onClick:()=>{On(h,"index.ts","text/plain")}},"index.ts"),a.createElement(Mo,{value:h,language:"typescript",style:{minHeight:"400px"},onChange:console.log}),a.createElement("div",{className:"my-2 bold"},"OR"),a.createElement(Btn_Btn,{variant:"filled",className:"mb-p5",size:"small",iconPath:s.wLz,color:"action",onClick:()=>{On(u,"index.html","text/html")}},"index.html"),a.createElement(Mo,{value:u,language:"html",style:{minHeight:"400px"}})):a.createElement(Zt,{color:"info",className:"bg-white",style:{alignItems:"center"}},"An API Token is needed to enable this functionality"))};function Gi(e){var t,n;const{className:l="",style:o={},dbs:r,topRightControls:d,dbTables:m,dbProject:p,serverState:u,connectionId:h,connection:g}=e,[f,E]=(0,i.lr)(),v=(null===(t=r.access_control)||void 0===t?void 0:t.update)?void 0:"Must be admin to access this",{isElectron:b}=u,y={details:{label:"Connection details",leftIconPath:s.r9,disabledText:v,content:a.createElement(Wo,{...e,contentOnly:!0,dbProject:p})},access_control:{label:"Access control",leftIconPath:s.zr,disabledText:v||(b?"Not available for desktop":void 0),content:a.createElement(AccessControl,{className:"min-h-0",...e,db:p,tables:m,searchParams:f,setSearchParams:E})},file_storage:{label:"File storage",leftIconPath:s.TaT,disabledText:v||(b?"Not available for desktop":void 0),content:a.createElement(TableConfigControls,{...e,db:p,tables:m})},backups:{label:"Backup/Restore",leftIconPath:s.MPt,disabledText:v,content:a.createElement(ki,{...e})},API:{label:"API",leftIconPath:s.$8O,disabledText:v||(b?"Not available for desktop":void 0),content:a.createElement(Vi,{...e,connectionId:h})}},N=Eo(y);return a.createElement("div",{className:`flex-col f-1 min-s-0 bg-gray-800 ${l}`,style:o},a.createElement("div",{className:"flex-row gap-1 f-0 p-p5 ai-center"},a.createElement("div",null,a.createElement(Btn_Btn,{title:"Dashboard",size:"small",style:{color:"var(--gray-100)",background:"var(--gray-700)"},className:"bg-gray-700 text-white b g-gray-700",iconPath:s._sG,asNavLink:!0,href:`/connections/${h}`},"Dashboard")),a.createElement("div",{className:"f-1 flex-row jc-start gap-2"},a.createElement("h4",{className:" min-s-0 text-white ai-center m-0 p-1 flex-row gap-p5",style:{padding:0}},a.createElement(c(),{path:s.YlK,size:1,className:"f-0"}),a.createElement("div",{className:"f-1 min-s-0 ws-nowrap text-ellipsis"},"Configure "))),d),a.createElement("div",{className:"flex-col bg-white f-1 min-h-0"},a.createElement(Tabs,{variant:{controlsBreakpoint:200,contentBreakpoint:500,controlsCollapseWidth:350},className:"f-1",activeKey:null!==(n=N.find((e=>e===f.get("section"))))&&void 0!==n?n:N[0],onChange:e=>{E({section:e})},items:y,contentClass:"ai-cdenter o-auto flex-row jc-center bg-gray-100 f-1 ",onRender:e=>a.createElement("div",{className:"flex-col f-1 max-w-800 min-w-0 bg-white shadow "},a.createElement("h2",{style:{marginLeft:"32px"}},e.label),a.createElement("div",{className:" f-1 o-auto flex-row "+(window.isLowWidthScreen?"":" p-1  "),style:{alignSelf:"stretch"}},e.content))})))}function Ji(e){const t=Io(),[n,l]=(0,a.useState)(!1),[o,i]=(0,a.useState)({email:"",details:""});return a.createElement(a.Fragment,null,a.createElement(Btn_Btn,{className:" text-white bg-gray-700",title:"Leave feedback",iconPath:s.qYp,size:window.isLowWidthScreen?void 0:"small",style:{color:"var(--gray-100)",background:"var(--gray-700)"},onClick:()=>{l(!0)}},window.isLowWidthScreen?null:"Feedback"),n&&a.createElement(Popup,{open:!0,title:"Send feedback",positioning:"top-center",onClose:()=>{l(!1)}},o.success&&a.createElement("div",{className:"flex-col"},a.createElement(Success,null),a.createElement("p",null,"Feedback was sent! Thanks a lot!")),o.error&&a.createElement(ErrorComponent,{error:o.error}),a.createElement(FormField,{id:"email",type:"email",label:"Email (optional)",asColumn:!0,value:o.email,onChange:e=>{i({...o,email:e})}}),a.createElement(FormField,{id:"text",type:"text",label:"Details",asColumn:!0,className:"mt-1",value:o.details,asTextArea:!0,onChange:e=>{e.length<500&&i({...o,details:e})},hint:500-`${o.details}`.length+"/500"}),a.createElement("p",null,"Other options: ",a.createElement("a",{target:"_blank",href:"https://github.com/prostgles/ui/issues/new/choose"},"open an issue")," or ",a.createElement("a",{href:"mailto:prostgles@protonmail.com"},"email us")),a.createElement("div",{className:"flex-row pt-1 jc-around"},!o.success&&a.createElement(Btn_Btn,{color:"action",variant:"filled",disabledInfo:o.details?void 0:"Must provide some details",onClick:async()=>{try{const e=await $o("https://prostgles.com/feedback",o),n=await e.json();if(n.error)throw n.error;i({...o,success:!0}),setTimeout((()=>{t()&&(i({email:"",details:""}),l(!1))}),3e3)}catch(e){i({...o,error:e})}}},"Send"),a.createElement(Btn_Btn,{variant:"outline",onClick:()=>{i({email:"",details:""}),l(!1)}},"Cancel"))))}const Xi=({connection:e,user:t})=>{const n="admin"===(null==t?void 0:t.type),l=n?Gl(ko(e),40,void 0,!0):e.name||e.id,o=a.createElement("div",{className:"flex-row-wrap ai-center jc-center pl-1 pddd-p5 gap-p5 min-w-0  ws-nowrap o-hidden h-fit w-fit as-start",style:{flexWrap:"nowrap",height:"30px"}},l&&a.createElement("div",{className:"text-gray-400 font-16 text-ellipsis ",title:n?ko(e):"Connection info"},l));return a.createElement("div",{className:"flex-row ai-start gap-1 text-gray-500 w-fit ai-center noselect o-auto no-scroll-bar jc-end",style:{maxWidth:"100%"}},o,a.createElement(Ji,null),a.createElement(Btn_Btn,{title:"Go to Connections",href:"/connections",asNavLink:!0,size:window.isLowWidthScreen?void 0:"small",className:"text-white bg-gray-700 ",style:{color:"var(--gray-100)",background:"var(--gray-700)"},iconPath:s.J3k},window.isLowWidthScreen?null:"Connections"))};class Project extends RTComp{constructor(){super(...arguments),this.state={dbKey:"d",loading:!0,error:"",dbMethods:void 0},this.loaded=!1,this.sub=null,this.getDashboardDB=async e=>{var t;try{this.projectSocket&&this.projectSocket.disconnect();const{dbs:n,dbsMethods:a,dbsTables:l}=this.props,o=await(null===(t=a.startConnection)||void 0===t?void 0:t.call(a,e.id));if(!o)return void this.setState({dbProject:n});this.projectSocket=(0,jo.ZP)({path:o,transports:["websocket"],reconnectionDelay:1e3,reconnection:!0}),console.log("TEST DATA IMPORT TO ENSURE onReconnect does not break things"),await qo()({socket:this.projectSocket,onReady:async(t,a,i,s)=>{var r;const c=(null===(r=null==s?void 0:s.user)||void 0===r?void 0:r.state_db_id)===e.id,d=await _Dashboard.getTables(null!=i?i:[],void 0,t);this.setState({dbProject:c?n:t,dbTables:c?l:d,dbMethods:a,dbKey:"db-onReady-"+Date.now(),projectPath:o}),window.db=t}})}catch(e){this.setState({error:e})}}}onMount(){}async onDelta(e,t,n){var a;const{dbProject:l}=this.state,{dbs:o,dbsMethods:i,user:s}=this.props;if({...e,...t,...n}.dbs&&(this.loaded=!1,this.setState({dbProject:void 0})),o&&Object.keys(i).length>0&&!this.loaded){window.dbs=o,this.loaded=!0;const e=null===(a=this.props.params)||void 0===a?void 0:a.cid;this.props.workspaceId;let t;try{t=await o.connections.findOne({id:e})}catch(t){console.error(t),this.setState({error:`Invalid connection id: ${e}`})}t&&(l||this.getDashboardDB(t)),this.setState({connection:t,loading:!1})}}onUnmount(){var e;null===(e=this.projectSocket)||void 0===e||e.disconnect()}render(){var e,t;const{error:n,loading:l=!0,dbProject:o,dbMethods:i,connection:r,dbTables:c,projectPath:d,dbKey:m}=this.state,{dbs:p,dbsTables:u,showConnectionConfig:h,dbsSocket:g,dbsMethods:f,setTitle:E,auth:v,user:b,serverState:y}=this.props;if(l)return a.createElement("div",{className:"f-1 flex-col bg-gray-800 h-full w-full ai-center jc-center"},a.createElement(Loading,{className:"mt-4 mx-auto"}));if(!r||n)return a.createElement("div",{className:"flex-col w-full h-full ai-center jc-center p-2 gap-1"},!r&&a.createElement("div",{className:"p-1"},"This project was not found or you are not allowed to access it"),!!n&&a.createElement(a.Fragment,null,"Database connection error:",a.createElement(ErrorComponent,{error:n,findMsg:!0})),a.createElement(Btn_Btn,{style:{fontSize:"18px",fontWeight:"bold"},className:"mt-1",variant:"outline",asNavLink:!0,href:"/",iconPath:s.J3k,color:"action"},"Connections"));const N=null===(e=this.props.params)||void 0===e?void 0:e.cid,w=a.createElement(Xi,{connection:r,showConnectionConfig:!!h,user:b});if(!(p&&o&&i&&u&&c))return a.createElement(Loading,{delay:0,className:"m-auto",message:"Connecting to database..."});const S={dbs:p,dbsMethods:f,dbsSocket:g,dbsTables:u,setTitle:E,auth:v,user:b,dbProject:o,dbMethods:i,dbTables:c,projectPath:d,serverState:y};return h&&N?r.is_state_db?a.createElement(Zt,{className:"h-fit w-fit"},"This configuration page is not allowed for Prostgles state database"):a.createElement(Gi,{...S,topRightControls:w,connectionId:N,connection:r}):a.createElement("div",{className:"f-1 flex-col bg-gray-800 h-full w-full min-h-0 min-w-0 relative",style:{maxWidth:"100vw",maxHeight:"100vh"}},a.createElement("div",{className:"f-1 w-full h-full flex-col"},a.createElement(tl,{dbKey:m,db:o,dbSchemaTables:c,dbsSocket:g,dbs:p,dbsTables:u,dbMethods:i,dbsMethods:this.props.dbsMethods,workspaceId:this.props.workspaceId,connectionId:null===(t=this.props.params)||void 0===t?void 0:t.cid,topRightControls:w,user:b,auth:v,connection:r})))}}Project.getConnectionTitle=(e,t=!1)=>t?e.db_conn||`${e.db_user}@${e.db_host}:${e.db_port||"5432"}/${e.db_name}`:e.db_conn||`postgres://${e.db_user}:***@${e.db_host}:${e.db_port||"5432"}/${e.db_name}`;const Ki=e=>{const[t,n]=(0,i.lr)(),l=(0,o.UO)();return a.createElement(Project,{...e,params:l,workspaceId:t.get("workspaceId"),setWorkspaceId:e=>n({workspaceId:e})})},Qi=({user:e,forNavBar:t})=>{var n,l;let r=(0,o.s0)();if(!e)return null;const d="admin"===(null==e?void 0:e.type)?s.j$d:s.jiR,p=e.passwordless_admin;return t?a.createElement(a.Fragment,null,a.createElement(i.OL,{key:"account",to:"/account",className:"ml-auto flex-row ai-center gap-p5  bb font-16 min-w-0"},a.createElement(c(),{className:"f-0",path:d,size:1}),a.createElement("div",{className:"f-1 min-w-0 text-ellipsis ws-no-wrap"},null!==(n=null==e?void 0:e.username)&&void 0!==n?n:"??")),!p&&a.createElement("a",{key:"logout",href:"/logout",className:"font-16 flex-row ai-center gap-p5"},a.createElement(c(),{className:"f-0",path:s.GyE,size:1}),a.createElement("div",{className:"f-1 min-w-0 text-ellipsis ws-no-wrap"},"Logout"))):a.createElement(M,{positioning:"beneath-right",contentStyle:{padding:0,borderRadius:0},rootStyle:{borderRadius:0},button:a.createElement(Btn_Btn,{style:{paddingBottom:0,color:"var(--gray-100)",background:"var(--gray-700)"},size:"medium",title:null!==(l=null==e?void 0:e.username)&&void 0!==l?l:"Account",className:" flex-col text-white b g-gray-700"},a.createElement(c(),{path:d,size:window.isLowWidthScreen?1:.75}),!window.isLowWidthScreen&&a.createElement("div",{className:" text-gray-400 font-12 ws-nowrap"},null==e?void 0:e.username))},a.createElement(MenuList,{style:{borderRadius:0},items:[{label:"Account",leftIconPath:"admin"===(null==e?void 0:e.type)?s.j$d:s.jiR,onPress:()=>{r("/account")}},p?void 0:{label:"Logout",leftIconPath:s.GyE,onPress:()=>{window.location.href="/logout"}}].filter(m.isDefined)}))};const Zi=function(e){const[t,n]=(0,a.useState)(!0),l=(0,o.s0)(),{options:r=[],title:d,user:m,serverState:p}=e,u=!d&&a.createElement("button",{className:"hamburger hidden ml-auto",style:{alignSelf:"flex-end"},onClick:()=>{n(!t)}},t?a.createElement(c(),{path:s.$Qi,size:1.5}):a.createElement(c(),{path:s.r5M,size:1.5}));return a.createElement("nav",{className:"flex-row jc-center noselect w-full text-gray-500 shadow bg-white "+(t?" mobile-collapsed ":""),style:{zIndex:1,boxShadow:"0 1px 6px 0 rgb(32 33 36 / 28%)"}},a.createElement("div",{className:"flex-row f-1",style:{maxWidth:"1100px"}},a.createElement(i.OL,{title:"v2.0.0-alpha",to:"/",className:"prgl-brand-icon flex-col ai-center jc-center"},a.createElement("img",{className:"p-p5 px-1 mr-2 ",src:"/prostgles-logo.svg"})),a.createElement("div",{className:"flex-col f-1"},a.createElement("div",{className:"navwrapper flex-row gap-p5 ",style:{order:2},onClick:()=>{n(!0)}},d?a.createElement("div",{className:"flex-row ai-center ",style:{minHeight:"60px"}},a.createElement("button",{className:"f-0 ml-1",onClick:()=>{l(-1)}},a.createElement(c(),{path:s.J3k,size:1})),a.createElement("div",{className:"f-1 ml-1"},d)):r.map(((e,t)=>e.href?a.createElement("a",{key:t,href:e.href,className:" hover ai-center px-1 pt-1 bb font-16 transition-150 "}," ",e.label," "):a.createElement(i.OL,{key:t,to:e.to,className:" hover gap-p5 flex-row ai-center f-0 px-1 pt-1 bb font-16 f-1 max-s-fit min-w-0 "},e.iconPath&&a.createElement(c(),{size:1,className:"f-0",path:e.iconPath}),a.createElement("div",{className:"f-1 max-s-fit min-w-0 ws-no-wrap text-ellipsis ws-nowrap"},e.label)))),!(null==p?void 0:p.isElectron)&&a.createElement(Qi,{user:m,forNavBar:!0})),u)))};class LeftNavBar extends a.Component{render(){return React.createElement("div",{className:"flex-col"},React.createElement("ul",{className:"plain flex-col"},React.createElement("li",null,React.createElement(NavLink,{to:"/projects",className:"text-gray-800 text-white-hover flex-row  bb text-sm font-medium ml-8 transition-150 "},React.createElement(Icon,{path:mdiServer,size:1}),React.createElement("div",null,"Projects"))),React.createElement("li",null,React.createElement(NavLink,{to:"/account",className:"text-gray-800 text-white-hover flex-row  bb text-sm font-medium ml-8 transition-150 "},React.createElement(Icon,{path:mdiAccount,size:1}),React.createElement("div",null,"Account")))))}}const es=({dbsMethods:e})=>{const[{username:t,password:n,passwordconfirm:l},o]=(0,a.useState)({}),i=e=>{o((t=>({...t,...e})))},s=t?n?l?n!==l?"Passwords do not match":void 0:"Password confirmation not provided":"Password not provided":"Username not provided";return a.createElement("div",{className:"flex-col gap-1 ai-center p-1"},a.createElement("div",null,"Passwordless access"),a.createElement("div",null,"Only this device and browser can access the dashboard"),a.createElement("div",null,"To add users and set access control must first create an admin user with a password. This will disable passwordless access "),a.createElement(M,{title:"Create admin user",positioning:"top-center",button:a.createElement(Btn_Btn,{color:"action",variant:"filled"},"Create admin user"),render:e=>a.createElement("div",{className:"flex-col gap-1"},a.createElement(FormField,{asColumn:!0,label:"Username",value:null!=t?t:"",onChange:e=>i({username:e})}),a.createElement(FormField,{asColumn:!0,autoComplete:"off",label:"Password",type:"password",value:null!=n?n:"",onChange:e=>i({password:e})}),a.createElement(FormField,{asColumn:!0,autoComplete:"false",label:"Confirm password",type:"password",value:null!=l?l:"",onChange:e=>i({passwordconfirm:e})})),footerButtons:[{label:"Create",disabledInfo:s,variant:"filled",color:"action",onClickPromise:async()=>{if(!t||!n)throw"Username or Password missing";await e.disablePasswordless({username:t,password:n}),window.location.reload()}}]}))};class UserManager extends RTComp{constructor(){super(...arguments),this.state={collapsed:!0,loading:!0},this.loaded=!1,this.onDelta=async()=>{const{dbs:e,user:t}=this.props}}onUnmount(){}render(){const{dbs:e,dbsTables:t,user:n,dbsMethods:l}=this.props;if(!t)return null;let o;return o="admin"!==(null==n?void 0:n.type)?a.createElement("div",null,"Must be admin to access this section"):(null==n?void 0:n.passwordless_admin)?a.createElement(es,{...this.props}):a.createElement(SmartTable,{className:"w-full",db:e,titlePrefix:"Prostgles UI users",tableName:"users",tables:t,showInsert:!0,allowEdit:!0,realtime:!0}),a.createElement("div",{className:"flex-col relative w-full f-1 min-h-0 pt-1 "+(window.isLowWidthScreen?"":" px-2 ")},o)}}const ts=({user:e,dbsMethods:t,onChange:n})=>{var l;const[o,i]=(0,a.useState)(),[s,r]=(0,a.useState)(),[c,d]=(0,a.useState)(),[m,p]=(0,a.useState)(!1),u=async e=>{var a;try{await(null===(a=t.enable2FA)||void 0===a?void 0:a.call(t,c+"")),setTimeout((()=>{n(),e()}),1500),p(!0)}catch(e){r(e)}};return(null===(l=null==e?void 0:e["2fa"])||void 0===l?void 0:l.enabled)?a.createElement(Btn_Btn,{color:"danger",variant:"filled",onClickMessage:async(e,a)=>{var l;await(null===(l=t.disable2FA)||void 0===l?void 0:l.call(t)),a({ok:"Disabled!"},n)}},"Disable 2FA"):a.createElement(M,{title:a.createElement("div",{className:"bold"},"Two-factor authentication"),button:a.createElement(Btn_Btn,{variant:"filled",color:"action"},"Enable 2FA"),initialState:{enabled:!1,canvasNode:null},onClose:()=>{d(void 0),i(void 0),r(null)},render:(n,l,r)=>a.createElement("div",{className:"flex-col gap-1 ai-center",style:{maxWidth:"400px"}},a.createElement("div",{className:(null==o?void 0:o.url)?"text-gray-400":""},"Along with your username and password, you will be asked to verify your identity using the code from authenticator app."),!!o&&a.createElement(a.Fragment,null,a.createElement("div",null,"Scan ",a.createElement("a",{href:null==o?void 0:o.url,target:"_blank"},"or tap")," the image below with the two-factor authentication app on your phone. "),a.createElement(cn,{label:"I can't scan the QR Code",buttonProps:{variant:"outline"},iconPath:""},a.createElement("div",{className:"flex-col gap-p5 ai-start jc-start"},a.createElement("div",null,"If you can't use a QR code you can enter this information manually:"),a.createElement("div",{className:"flex-col ml-1 pl-2"},a.createElement(Chip,{variant:"naked",label:"Name",value:e.username}),a.createElement(Chip,{variant:"naked",label:"Issuer",value:"Prostgles UI"}),a.createElement(Chip,{variant:"naked",label:"Base64 secret",value:null==o?void 0:o.secret}),a.createElement(Chip,{variant:"naked",label:"Type",value:"Time-based OTP"}))))),a.createElement(pe,{url:null==o?void 0:o.url,size:400,variant:"href-wrapped"}),(null==o?void 0:o.recoveryCode)&&a.createElement("div",{className:"f-1 flex-col gap-1 p-1",style:{wordBreak:"break-word"}},a.createElement(Zt,{variant:"naked",className:"ai-start"},a.createElement("div",{className:"flex-col gap-1"},a.createElement("div",null,"Save the Recovery code below. It will be used in case you lose access to your authenticator app:"),a.createElement("div",{className:"bold"},o.recoveryCode)))),!o&&a.createElement(Btn_Btn,{variant:"filled",color:"action",onClickPromise:async()=>{var e;const n=await(null===(e=t.create2FA)||void 0===e?void 0:e.call(t));if(!(null==n?void 0:n.url))throw"Something went wrong. OTP URL not received";i(n)}},"Generate QR Code"),m&&a.createElement(Success,null,"2FA Enabled"),o&&!m&&a.createElement("div",{className:"flex-col gap-1 w-full",onKeyDown:e=>{"Enter"===e.key&&u(n)}},a.createElement(FormField,{asColumn:!0,value:c,type:"number",label:"Confirm code",onChange:e=>{d(e)},rightContent:a.createElement(Btn_Btn,{variant:"filled",color:"action",className:"ml-2",onClickMessage:()=>u(n)},"Enable 2FA")})),s&&a.createElement(ErrorComponent,{error:s}))})};class Account extends RTComp{constructor(){super(...arguments),this.state={}}async onDelta(e,t,n){var a;const{dbs:l,dbsTables:o,auth:i,user:s}=this.props;!this.state.dbsConnection&&l&&(null==i?void 0:i.user)&&this.setState({dbsConnection:await l.connections.findOne({id:null===(a=null==i?void 0:i.user)||void 0===a?void 0:a.state_db_id})})}render(){const{dbs:e,dbsTables:t,dbsMethods:n,user:l}=this.props,{dbsConnection:o}=this.state;return e&&t&&l?l.passwordless_admin?a.createElement("div",{className:" f-1 flex-col w-full gap-1 p-p5 o-auto",style:{maxWidth:"700px"}},a.createElement(es,{...this.props})):a.createElement("div",{className:" f-1 flex-col w-full o-auto",style:{maxWidth:"700px"}},a.createElement("div",{className:" flex-row w-full my-1  p-p5 "},a.createElement(ts,{user:l,dbsMethods:n,onChange:console.log}),a.createElement(Btn_Btn,{className:"ml-auto",variant:"outline",href:"/logout"},"Logout")),a.createElement("div",{className:"flex-col o-auto f-0 p-p5"},a.createElement(bi,{title:"Account details",className:"shadow bg-white",buttonStyle:{background:"white"},getStyle:e=>({marginBottom:e?"1em":".25em"}),contentClassName:" bb   b-gray-400 "},a.createElement(SmartForm,{label:"",db:e,tableName:"users",tables:t,rowFilter:[{fieldName:"id",value:l.id}],hideChangesOptions:!0,confirmUpdates:!0,disabledActions:["clone","delete"]})),a.createElement(bi,{title:"Sessions",className:"shadow bg-white",buttonStyle:{background:"white"},getStyle:e=>({marginBottom:e?"1em":".25em"}),contentClassName:" p-1 bg-white"},a.createElement(zi,{displayType:"web_session",...this.props})),a.createElement(bi,{title:"API Access",className:"shadow bg-white",buttonStyle:{background:"white"},getStyle:e=>({marginBottom:e?"1em":".25em"}),contentClassName:" p-1 bg-white"},a.createElement(Vi,{...this.props,projectPath:"/iosckt",connectionId:null==o?void 0:o.id})))):null}}class AccessControlDBS extends RTComp{constructor(){super(...arguments),this.state={loading:!1,userTypes:[],selectedUserTypes:[]},this.d={},this.loaded=!1}async onDelta(e,t,n){const{dbs:a,user:l}=this.props;this.ugSub||(this.conSub=await a.access_control.subscribeOne({connection_id:l.state_db_id},{},(e=>{this.setState({rule:e})})),this.ugSub=await a.user_types.subscribe({},{},(e=>{this.setState({userTypes:e})})))}async onUnmount(){var e,t;null===(e=this.ugSub)||void 0===e||e.unsubscribe(),null===(t=this.conSub)||void 0===t||t.unsubscribe()}render(){var e,t,n,l,o,i;const{userTypes:r,rule:d}=this.state,{dbs:m,user:p}=this.props,u=null!==(n=null!==(e=this.state.userTypesThatCanManageUsers)&&void 0!==e?e:null===(t=null==d?void 0:d.rule)||void 0===t?void 0:t.userTypesThatCanManageUsers)&&void 0!==n?n:[],h=null!==(i=null!==(l=this.state.userTypesThatCanManageConnections)&&void 0!==l?l:null===(o=null==d?void 0:d.rule)||void 0===o?void 0:o.userTypesThatCanManageConnections)&&void 0!==i?i:[];return r.length&&m?a.createElement("div",{className:"flex-col f-1 p-1 gap-2"},a.createElement("div",null,"TO BE REPLACED WITH AccessControl"),a.createElement("div",{className:"flex-row gap-1 text-yellow-600 ai-center mt-1"},a.createElement(c(),{path:s.EaN,size:1}),a.createElement("div",null,"Admin users will always have full access to everything")),a.createElement("div",null,a.createElement("h3",null,"Users create/edit/delete "),a.createElement(UserTypeSelect,{userTypes:u,dbs:m,onChange:e=>{this.setState({userTypesThatCanManageUsers:e})}})),a.createElement("div",null,a.createElement("h3",null,"Connections create/edit/delete"),a.createElement(UserTypeSelect,{userTypes:h,dbs:m,onChange:e=>{this.setState({userTypesThatCanManageConnections:e})}})),a.createElement("div",{className:"flex-row gap-2 mt-2"},a.createElement(Btn_Btn,{color:"action",variant:"filled",onClickMessage:async(e,t)=>{const n={userTypesThatCanManageUsers:u,userTypesThatCanManageConnections:h};d?await m.access_control.update({id:d.id},{rule:n}):await m.access_control.insert({connection_id:p.state_db_id,rule:n}),t({ok:"Updated!"})}},"Update"))):a.createElement(Loading,null)}}const ns=({auth:e,dbsMethods:t,dbs:n,dbsTables:l})=>{var o;const[i,r]=(0,a.useState)({}),[c,d]=(0,a.useState)(),[m,p]=(0,a.useState)();return(0,a.useEffect)((()=>{(async()=>{p(await t.getMyIP())})()}),[]),(0,a.useEffect)((()=>{(async()=>{var e;try{const t=i.cidr,a=t?null!==(e=await n.sql('select   host(${cidr}::cidr) AS "from",    host(broadcast(${cidr}::cidr)) AS "to" ',{cidr:t},{returnType:"row"}))&&void 0!==e?e:{}:void 0;d(a)}catch(e){d({error:e})}})()}),[i]),a.createElement("div",{className:"w-full o-auto"},a.createElement("div",{className:"flex-row jc-center",style:{alignSelf:"stretch"}},a.createElement("div",{className:"flex-col gap-1 mt-2 max-w-800 min-w-0 f-1",style:{alignSelf:"stretch"}},a.createElement(SmartForm,{className:"bg-white shadow ",label:"Network security",db:n,tableName:"global_settings",tables:l,rowFilter:[],hideChangesOptions:!0,showLocalChanges:!1,confirmUpdates:!0,hideNonUpdateableColumns:!0}),a.createElement("div",{className:"flex-col gap-1 p-1 bg-white shadow "},a.createElement(FormField,{label:"Test a CIDR",value:null!==(o=i.cidr)&&void 0!==o?o:"",onChange:e=>{r({cidr:e})},placeholder:"127.1.1.1/32",asColumn:!0,hint:"Enter a value to see the allowed IP ranges",error:null==c?void 0:c.error,rightIcons:!!m&&a.createElement(Btn_Btn,{title:"Add your current IP",iconPath:s.Bcb,onClick:()=>r({cidr:(null==m?void 0:m.ip)+"/128"})})}),!!(null==c?void 0:c.from)&&a.createElement("div",{className:"flex-col gap-1"},c.from===c.to?a.createElement(Chip,{variant:"naked",label:"Allowed IP",value:c.from}):a.createElement(a.Fragment,null,a.createElement(Chip,{variant:"naked",label:"From IP",value:c.from}),a.createElement(Chip,{variant:"naked",label:"To IP",value:c.to})))),a.createElement("div",{className:"shadow bg-white p-1"},a.createElement("h4",{className:"font-20 mt-p25"},"Cloud credentials"),a.createElement(SmartCardList,{db:n,tableName:"credentials",tables:l,filter:{},realtime:!0,noDataComponent:a.createElement(Zt,null,"No cloud credentials")})))))};function as({serverState:e}){const[t,n]=(0,a.useState)(Bo),[l,o]=(0,a.useState)(),[i,r]=(0,a.useState)(!1),{platform:c}=window.navigator,d=c.toLowerCase().includes("linux")?"linux":"windows";(0,a.useEffect)((()=>{n((e=>({...e,..."windows"===d&&{db_ssl:"disable"}})))}),[]);const[m,p]=(0,a.useState)(0),u=(null==e?void 0:e.connectionError)||(null==e?void 0:e.initError);return a.createElement("div",{className:"bg-white ta-center p-2  flex-col gap-2 max-w-700 m-auto o-auto shadow  p-1",style:{width:"500px"}},a.createElement("div",{className:"flex-row gap-1 ai-center m-auto"},a.createElement(Jn,{style:{border:"unset",background:"unset"}}),a.createElement("h2",null,"Prostgles UI Desktop")),m?1===m?a.createElement("div",null,a.createElement("h3",null,"REQUIREMENTS"),a.createElement("section",{className:"ta-left font-18"},a.createElement("strong",null,"Prostgles UI")," requires full access to a postgres database.",a.createElement("p",null,"This database will be used to manage and store all connection and state data."),a.createElement("p",{className:"m-0 mt-p5"},"For best experience we recommend using a locally installed database"),a.createElement("div",{className:"flex-row-wrap gap-2 f-1 jc-center"},a.createElement(M,{title:"Postgres server installation",positioning:"center",className:"mt-1 ",rootStyle:{maxWidth:"750px"},button:a.createElement(Btn_Btn,{size:"small",variant:"outline",color:"action",iconPath:s.gCD},"Installation steps"),render:()=>a.createElement("div",{className:"flex-col p-2 font-18 gap-2 ta-left"},a.createElement("div",null,a.createElement("h3",null,"Official instructions:"),a.createElement("ul",{className:"flex-row gap-1 jc-start"},a.createElement("li",null,a.createElement(Btn_Btn,{href:"https://www.postgresql.org/download/linux/",target:"_blank",color:"action",variant:"linux"===d?"filled":"outline",iconPath:s.yjL},"Linux")),a.createElement("li",null,a.createElement(Btn_Btn,{href:"https://www.postgresql.org/download/windows/",target:"_blank",color:"action",variant:"windows"===d?"filled":"outline",iconPath:s.Ac$},"Windows")))),a.createElement("div",null,a.createElement(Zt,{color:"warning"},"Use a strong password to prevent security issues"),a.createElement("p",{className:"mt-2"},"To setup a new user and database ",a.createElement("strong",null,"(Linux)"),":"),a.createElement("div",{className:"pl-1"},a.createElement("p",null,"Create a new user ",a.createElement("strong",null,"ui"),":"),a.createElement("code",{className:"bg-gray-900 text-white p-1 flex-col ta-left"},"sudo -su postgres createuser -P --superuser ui"),a.createElement("p",{className:"mt-2"},"Create a database ",a.createElement("strong",null,"uidb")," with user ",a.createElement("strong",null,"ui")," as the owner:"),a.createElement("code",{className:"bg-gray-900 text-white p-1 flex-col ta-left"},"createdb uidb -O ui")))),footerButtons:[{onClickClose:!0,label:"Close",variant:"filled",color:"action"}]})))):a.createElement("div",{className:"flex-col gap-1"},a.createElement("h3",null,"STATE DATABASE"),i&&!l?a.createElement(Loading,{className:"m-auto",message:"Connecting to state database"}):a.createElement("div",{className:"px-p25 flex-col gap-1 min-s-0 o-auto"},a.createElement(Po,{mode:"insert",warning:l,c:t,nameErr:"",isForStateDB:!0,updateConnection:async e=>{r(!1);const a={...t,...e};let l=await ls(a,!0);const{connection:i,warning:s}=l;o(s),i&&n(i)},test:{status:"",statusOK:!1}})),u&&a.createElement(ErrorComponent,{className:"rounded bg-red-100 b b-red-400 f-0",withIcon:!0,error:wo(e,["connectionError","initError"],!0)}),!i&&a.createElement(Btn_Btn,{color:"action",variant:"filled",className:"m-auto",onClickMessage:async(e,n)=>{r(!0);try{const e=await ls(t,!1);e.warning?o(e.warning):(await os(3e3),window.location.reload(),r(!1))}catch(e){o(e),r(!1)}}},"Set connection")):a.createElement("div",null,a.createElement("h3",null,"PRIVACY"),a.createElement("section",{className:"ta-left  font-18"},'The only data we collect is the information you send us through the "Send feedback" button.')),m<2&&a.createElement("div",{className:"flex-row f-1 mt-2",style:{justifyContent:"space-between"}},a.createElement(Btn_Btn,{onClick:()=>{p((e=>Math.max(0,e-1)))},iconPath:s.J3k,variant:"outline",style:{opacity:m?1:0}},"Back"),a.createElement(Btn_Btn,{onClick:()=>{p((e=>Math.min(2,e+1)))},iconPosition:"right",iconPath:s.aIO,color:"action",variant:"filled",style:{opacity:m<2?1:0}},"Next")))}const ls=async(e,t=!1)=>{let n=await $o("/dbs",{...e,...t?{validate:!0}:{}});return await n.json()},os=e=>new Promise((t=>{setTimeout((()=>{t(!0)}),e)}));window.isIOSDevice=["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"].includes(navigator.platform)||navigator.userAgent.includes("Mac")&&"ontouchend"in document,window.isMobileDevice=/Mobi/i.test(window.navigator.userAgent),window.isLowWidthScreen=window.innerWidth<700;const is=function(){var e;const[t,n]=(0,a.useState)({dbsKey:"",title:"",dbsMethods:null,auth:void 0,isAdminOrSupport:!1,dbsSocket:{},dbsTables:[],userSub:null});(0,a.useEffect)((()=>{(async()=>{let e;window.document.title="Prostgles UI";try{const t=await fetch("/dbs");e=await t.json()}catch(t){e={ok:!1,clientState:"err",initError:t,isElectron:!1,canDumpAndRestore:void 0},console.error(t)}if(null==e?void 0:e.ok){const a=(0,jo.ZP)({transports:["websocket"],path:"/iosckt",reconnection:!0,reconnectionDelay:2e3,reconnectionAttempts:5});a.on("reconnect",(e=>{console.log("reconnect")})),a.on("pls-restart",(e=>{setTimeout((()=>window.location.reload()),2e3)})),a.on("redirect",(e=>{window.location=e})),qo()({socket:a,onReconnect:()=>{n({...t,dbsKey:"dbs"+Date.now()})},onReady:async(l,o,i,s)=>{window.dbs=l,window.dbsSocket=a,window.dbsMethods=o;const r=vo(s,"user.type");(async()=>{var e,a,o,i;await(null===(e=t.userSub)||void 0===e?void 0:e.unsubscribe());const r=(null===(a=null==s?void 0:s.user)||void 0===a?void 0:a.id)?await(null===(i=null===(o=l.users)||void 0===o?void 0:o.subscribeOne)||void 0===i?void 0:i.call(o,{id:null==s?void 0:s.user.id},{},(e=>{n((t=>({...t,user:e})))}))):null;n((e=>({...e,userSub:r})))})(),n({...t,dbsKey:"dbs"+Date.now(),dbs:l,dbsTables:await _Dashboard.getTables(null!=i?i:[],void 0,l),dbsMethods:o,dbsSocket:a,auth:s,isAdminOrSupport:["admin","support"].includes(r),serverState:{...e,socketConnected:!0,clientState:"ok"}})}}).catch((a=>{n({...t,serverState:{...e,err:a,clientState:"err",ok:!0}})}))}else e.clientState="err";n({...t,serverState:e})})()}),[]);const l=(0,o.s0)(),{isAdminOrSupport:r,dbs:c,dbsTables:d,dbsMethods:m,auth:p,dbsSocket:u,serverState:h,dbsKey:g}=t,f=null==p?void 0:p.user,E=c?{setTitle:e=>{t.title!==e&&n({...t,title:e})},dbs:c,dbsTables:d,dbsSocket:u,dbsMethods:m,user:t.user,auth:p,serverState:h}:void 0;r&&[{label:"Home",href:"/",exact:!0},{label:"Connections",to:"/connections",exact:!0}].push({label:"Dashboard",to:"/dashboard",exact:!1});const v=a.createElement(Zi,{serverState:h,user:f,options:(null==h?void 0:h.isElectron)?[]:[{label:"Connections",to:"/connections",iconPath:s.YlK},{label:"Users",to:"/users",forAdmin:!0,iconPath:s.zr},{label:"Server settings",to:"/server-settings",forAdmin:!0,iconPath:s.kuV}].filter((e=>{var t;return e&&(!e.forAdmin||"admin"===(null===(t=null==E?void 0:E.user)||void 0===t?void 0:t.type))}))}),b=(e,t)=>a.createElement("div",{className:"flex-col ai-center w-full f-1 min-h-0"},v,t&&c&&!(null==E?void 0:E.user)?a.createElement("div",{className:"flex-col jc-center ai-center h-full gap-2 m-2"},a.createElement(i.OL,{to:"login"},"Login"),a.createElement(i.OL,{to:"register"},"Register")):e);if(!(null==h?void 0:h.clientState))return a.createElement("div",{className:"flex-row m-auto ai-center jc-center  p-2"},a.createElement(Loading,{className:"",message:"Connecting to state database..."}));const y=(null==h?void 0:h.connectionError)||(null==h?void 0:h.initError);return(null==h?void 0:h.isElectron)&&!(null==h?void 0:h.socketConnected)?a.createElement(as,{serverState:h}):y?a.createElement("div",{className:"flex-col m-auto ai-center jc-center  p-2"},h.connectionError&&a.createElement("div",{className:"ml-1 text-lg font-bold mb-1 pre"},"Could not connect to state database. Ensure /server/.env file (or environment variables) point to a running and accessible postgres server database"),h.initError&&a.createElement("div",{className:"ml-1 text-lg font-bold mb-1 pre"},"Failed to start Prostgles"),a.createElement(ErrorComponent,{error:y,withIcon:!0})):a.createElement("div",{key:g,className:"flex-col f-1 min-h-0"},"https:"!==location.protocol&&"localhost"!==location.hostname&&"127.0.0.1"!==location.hostname&&!(null===(e=null==f?void 0:f.options)||void 0===e?void 0:e.hideNonSSLWarning)&&a.createElement(Zt,{color:"danger",iconPath:s.ePC,className:"m-p5 bg-white"},"Your are accessing this page over a non-HTTPS connection! You should not enter any sensitive information on this site (passwords, secrets)",!!(null==c?void 0:c.users.update)&&a.createElement(Btn_Btn,{onClickPromise:async()=>{null==c||c.users.update({id:null==f?void 0:f.id},{options:{...null==f?void 0:f.options,hideNonSSLWarning:!0}}),location.reload()}},"Do not show again")),a.createElement(o.Z5,{className:"flex-col f-1"},a.createElement(o.AW,{path:"/",element:a.createElement(o.Fg,{to:"/connections",replace:!0})}),a.createElement(o.AW,{path:"/connections",element:b(a.createElement(Connections,{...E}),!0)}),E&&[a.createElement(o.AW,{key:"1",path:"/users",element:b(a.createElement(UserManager,{...E}))}),a.createElement(o.AW,{key:"2",path:"/account",element:b(a.createElement(Account,{...E}))}),a.createElement(o.AW,{key:"3",path:"/connections/:cid",element:a.createElement(Ki,{...E})}),a.createElement(o.AW,{key:"4",path:"/access-management",element:b(a.createElement(AccessControlDBS,{...E}),!0)}),a.createElement(o.AW,{key:"7",path:"/new-connection",element:a.createElement(Wo,{...E,onUpserted:()=>{l("/connections")}})}),a.createElement(o.AW,{key:"8",path:"/edit-connection/:id",element:a.createElement(Wo,{...E,onDeleted:()=>{l("/")}})}),a.createElement(o.AW,{key:"10",path:"/connection-config/:cid",element:a.createElement(Ki,{...E,showConnectionConfig:!0})}),a.createElement(o.AW,{key:"11",path:"/server-settings",element:b(a.createElement(ns,{...E}),!0)})],a.createElement(o.AW,{path:"/login",element:a.createElement(Login,{...E})}),a.createElement(o.AW,{path:"/register",element:a.createElement(Register,{...E})}),a.createElement(o.AW,{path:"*",element:a.createElement(Do,null)})))};l.render(a.createElement(i.VK,null,a.createElement(is,null)),document.getElementById("root"))},94748:e=>{"use strict";e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAAECAYAAACp8Z5+AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAZdEVYdFNvZnR3YXJlAHBhaW50Lm5ldCA0LjAuMTZEaa/1AAAAHUlEQVQYV2PYvXu3JAi7uLiAMaYAjAGTQBPYLQkAa/0Zef3qRswAAAAASUVORK5CYII="},4768:e=>{"use strict";e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAQAAAC1+jfqAAAAL0lEQVQoz2NgCD3x//9/BhBYBWdhgFVAiVW4JBFKGIa4AqD0//9D3pt4I4tAdAMAHTQ/j5Zom30AAAAASUVORK5CYII="},35555:e=>{"use strict";e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAQAAADZc7J/AAAAz0lEQVRIx2NgYGBY/R8I/vx5eelX3n82IJ9FxGf6tksvf/8FiTMQAcAGQMDvSwu09abffY8QYSAScNk45G198eX//yev73/4///701eh//kZSARckrNBRvz//+8+6ZohwCzjGNjdgQxkAg7B9WADeBjIBqtJCbhRA0YNoIkBSNmaPEMoNmA0FkYNoFKhapJ6FGyAH3nauaSmPfwI0v/3OukVi0CIZ+F25KrtYcx/CTIy0e+rC7R1Z4KMICVTQQ14feVXIbR695u14+Ir4gwAAD49E54wc1kWAAAAAElFTkSuQmCC"},6161:e=>{"use strict";e.exports="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTMiIGhlaWdodD0iMzYiIHZpZXdCb3g9IjAgMCA1MyAzNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGcgY2xpcC1wYXRoPSJ1cmwoI2NsaXAwKSI+CjxwYXRoIGZpbGwtcnVsZT0iZXZlbm9kZCIgY2xpcC1ydWxlPSJldmVub2RkIiBkPSJNNDguMDM2NCA0LjAxMDQySDQuMDA3NzlMNC4wMDc3OSAzMi4wMjg2SDQ4LjAzNjRWNC4wMTA0MlpNNC4wMDc3OSAwLjAwNzgxMjVDMS43OTcyMSAwLjAwNzgxMjUgMC4wMDUxODc5OSAxLjc5OTg0IDAuMDA1MTg3OTkgNC4wMTA0MlYzMi4wMjg2QzAuMDA1MTg3OTkgMzQuMjM5MiAxLjc5NzIxIDM2LjAzMTIgNC4wMDc3OSAzNi4wMzEySDQ4LjAzNjRDNTAuMjQ3IDM2LjAzMTIgNTIuMDM5IDM0LjIzOTIgNTIuMDM5IDMyLjAyODZWNC4wMTA0MkM1Mi4wMzkgMS43OTk4NCA1MC4yNDcgMC4wMDc4MTI1IDQ4LjAzNjQgMC4wMDc4MTI1SDQuMDA3NzlaTTguMDEwNDIgOC4wMTMwMkgxMi4wMTNWMTIuMDE1Nkg4LjAxMDQyVjguMDEzMDJaTTIwLjAxODIgOC4wMTMwMkgxNi4wMTU2VjEyLjAxNTZIMjAuMDE4MlY4LjAxMzAyWk0yNC4wMjA4IDguMDEzMDJIMjguMDIzNFYxMi4wMTU2SDI0LjAyMDhWOC4wMTMwMlpNMzYuMDI4NiA4LjAxMzAySDMyLjAyNlYxMi4wMTU2SDM2LjAyODZWOC4wMTMwMlpNNDAuMDMxMiA4LjAxMzAySDQ0LjAzMzlWMTIuMDE1Nkg0MC4wMzEyVjguMDEzMDJaTTE2LjAxNTYgMTYuMDE4Mkg4LjAxMDQyVjIwLjAyMDhIMTYuMDE1NlYxNi4wMTgyWk0yMC4wMTgyIDE2LjAxODJIMjQuMDIwOFYyMC4wMjA4SDIwLjAxODJWMTYuMDE4MlpNMzIuMDI2IDE2LjAxODJIMjguMDIzNFYyMC4wMjA4SDMyLjAyNlYxNi4wMTgyWk00NC4wMzM5IDE2LjAxODJWMjAuMDIwOEgzNi4wMjg2VjE2LjAxODJINDQuMDMzOVpNMTIuMDEzIDI0LjAyMzRIOC4wMTA0MlYyOC4wMjZIMTIuMDEzVjI0LjAyMzRaTTE2LjAxNTYgMjQuMDIzNEgzNi4wMjg2VjI4LjAyNkgxNi4wMTU2VjI0LjAyMzRaTTQ0LjAzMzkgMjQuMDIzNEg0MC4wMzEyVjI4LjAyNkg0NC4wMzM5VjI0LjAyMzRaIiBmaWxsPSIjNDI0MjQyIi8+CjwvZz4KPGRlZnM+CjxjbGlwUGF0aCBpZD0iY2xpcDAiPgo8cmVjdCB3aWR0aD0iNTMiIGhlaWdodD0iMzYiIGZpbGw9IndoaXRlIi8+CjwvY2xpcFBhdGg+CjwvZGVmcz4KPC9zdmc+Cg=="},51096:e=>{"use strict";e.exports="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTMiIGhlaWdodD0iMzYiIHZpZXdCb3g9IjAgMCA1MyAzNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGcgY2xpcC1wYXRoPSJ1cmwoI2NsaXAwKSI+CjxwYXRoIGZpbGwtcnVsZT0iZXZlbm9kZCIgY2xpcC1ydWxlPSJldmVub2RkIiBkPSJNNDguMDM2NCA0LjAxMDQySDQuMDA3NzlMNC4wMDc3OSAzMi4wMjg2SDQ4LjAzNjRWNC4wMTA0MlpNNC4wMDc3OSAwLjAwNzgxMjVDMS43OTcyMSAwLjAwNzgxMjUgMC4wMDUxODc5OSAxLjc5OTg0IDAuMDA1MTg3OTkgNC4wMTA0MlYzMi4wMjg2QzAuMDA1MTg3OTkgMzQuMjM5MiAxLjc5NzIxIDM2LjAzMTIgNC4wMDc3OSAzNi4wMzEySDQ4LjAzNjRDNTAuMjQ3IDM2LjAzMTIgNTIuMDM5IDM0LjIzOTIgNTIuMDM5IDMyLjAyODZWNC4wMTA0MkM1Mi4wMzkgMS43OTk4NCA1MC4yNDcgMC4wMDc4MTI1IDQ4LjAzNjQgMC4wMDc4MTI1SDQuMDA3NzlaTTguMDEwNDIgOC4wMTMwMkgxMi4wMTNWMTIuMDE1Nkg4LjAxMDQyVjguMDEzMDJaTTIwLjAxODIgOC4wMTMwMkgxNi4wMTU2VjEyLjAxNTZIMjAuMDE4MlY4LjAxMzAyWk0yNC4wMjA4IDguMDEzMDJIMjguMDIzNFYxMi4wMTU2SDI0LjAyMDhWOC4wMTMwMlpNMzYuMDI4NiA4LjAxMzAySDMyLjAyNlYxMi4wMTU2SDM2LjAyODZWOC4wMTMwMlpNNDAuMDMxMiA4LjAxMzAySDQ0LjAzMzlWMTIuMDE1Nkg0MC4wMzEyVjguMDEzMDJaTTE2LjAxNTYgMTYuMDE4Mkg4LjAxMDQyVjIwLjAyMDhIMTYuMDE1NlYxNi4wMTgyWk0yMC4wMTgyIDE2LjAxODJIMjQuMDIwOFYyMC4wMjA4SDIwLjAxODJWMTYuMDE4MlpNMzIuMDI2IDE2LjAxODJIMjguMDIzNFYyMC4wMjA4SDMyLjAyNlYxNi4wMTgyWk00NC4wMzM5IDE2LjAxODJWMjAuMDIwOEgzNi4wMjg2VjE2LjAxODJINDQuMDMzOVpNMTIuMDEzIDI0LjAyMzRIOC4wMTA0MlYyOC4wMjZIMTIuMDEzVjI0LjAyMzRaTTE2LjAxNTYgMjQuMDIzNEgzNi4wMjg2VjI4LjAyNkgxNi4wMTU2VjI0LjAyMzRaTTQ0LjAzMzkgMjQuMDIzNEg0MC4wMzEyVjI4LjAyNkg0NC4wMzM5VjI0LjAyMzRaIiBmaWxsPSIjQzVDNUM1Ii8+CjwvZz4KPGRlZnM+CjxjbGlwUGF0aCBpZD0iY2xpcDAiPgo8cmVjdCB3aWR0aD0iNTMiIGhlaWdodD0iMzYiIGZpbGw9IndoaXRlIi8+CjwvY2xpcFBhdGg+CjwvZGVmcz4KPC9zdmc+Cg=="},96070:()=>{},48706:()=>{},25219:()=>{},39550:()=>{},14029:()=>{},61305:()=>{},16659:()=>{}},a={};function l(e){var t=a[e];if(void 0!==t)return t.exports;var o=a[e]={id:e,loaded:!1,exports:{}};return n[e].call(o.exports,o,o.exports,l),o.loaded=!0,o.exports}l.m=n,l.amdO={},e=[],l.O=(t,n,a,o)=>{if(!n){var i=1/0;for(d=0;d<e.length;d++){for(var[n,a,o]=e[d],s=!0,r=0;r<n.length;r++)(!1&o||i>=o)&&Object.keys(l.O).every((e=>l.O[e](n[r])))?n.splice(r--,1):(s=!1,o<i&&(i=o));if(s){e.splice(d--,1);var c=a();void 0!==c&&(t=c)}}return t}o=o||0;for(var d=e.length;d>0&&e[d-1][2]>o;d--)e[d]=e[d-1];e[d]=[n,a,o]},l.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return l.d(t,{a:t}),t},l.d=(e,t)=>{for(var n in t)l.o(t,n)&&!l.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},l.f={},l.e=e=>Promise.all(Object.keys(l.f).reduce(((t,n)=>(l.f[n](e,t),t)),[])),l.u=e=>"js/bundle."+{13:"d03d953ba3526ec9802f",137:"3eb725c48ff1db6ca260",145:"948c6c29f694d3185a17",189:"2c980657e95ad4966b82",528:"21a923a6a2fb1fd64ecf",644:"9c0ae5d1f4155e301308",736:"340eb79ccb83abe358cf",752:"b5c178307a7fceec911d",904:"c702664306a58f71e09b",1082:"6569e808b5412abd7155",1331:"ddc45a0a86f63f23a658",1522:"c13375a37b477bda2231",1588:"9032daac78405ee64cca",2298:"37e84061c1aebce06239",2525:"490989c662f38474bd00",2781:"13b1611e640b5076d0e2",2914:"e54123bad9b2fa893e6e",3040:"6cf3eb99067f0ec1bf76",3064:"b6337f684dbaa39be50b",3409:"63c63e104ad40797be04",3531:"586897019e0c754465a9",3548:"c77cea542c5602e5b3aa",3861:"25f9609e31796b26a65e",3974:"37a383cfa7229fb902a3",4050:"738ccc20bd3c318ca510",4092:"741bc37a75d5aa9e0d7c",4277:"14cf90d45c2d81500677",4281:"eb9be049fe920ebe1c79",4555:"bb2d5c90102be79d509f",4566:"dc7d9710a0fbc1a79ef8",4628:"3a1ac0a6be1179eb15ea",4639:"d0b996eca2d99e486e49",4876:"b20250f2a28437d2d4a5",4943:"c51c0652730d63125be4",4993:"5f1d7bb5d8422bbf1bf0",5099:"5aac348af86da536a08a",5206:"7bb5ed167a2e45791424",5353:"a05b6139feb51409b1ed",5441:"735420e5677fef548451",5728:"385f844979b89ac87df5",5809:"be43d27f167b6b066ee0",5814:"3cf702a6258cfaf81760",5907:"ed8ef4f97bba2fd8efc1",6066:"67790da8b58936d9bb6b",6257:"6dc38f44e5d8c6a94df7",6278:"a812bca21823aa6b2064",6807:"c967f3544a38cb020f71",6967:"19ad391387196d670b56",7034:"ae01b7038d401e0d3c72",7070:"664199a4f3aed7034ee3",7336:"9d3ecac3b210f574a6cc",7339:"469a4f2e57f9a18a4973",7406:"30e02de18267b5e834e9",7529:"577aa3a733bb01409f21",7646:"978f311047b4239dda89",7689:"9fd2844a8e9d3c7fe3b0",7690:"3b117153a3f1c60d91b9",7742:"50cf26c3f166d4a05bc4",7798:"c408418efd155b50b631",7819:"c483108612cba920f563",7859:"de3a7b6672db5f63f6fc",8018:"0cca480939fc64765f10",8166:"5f4717fd5de591e4f61f",8338:"819707795cdd1b78ccda",8399:"b35754f4f7c2daceac06",8587:"e779670c089ec373e8ef",8659:"12ad6441cfbbca41a9b3",8793:"d93afa8fdfa0e7214a06",8877:"d8874146e76a09906dd7",8890:"27aba58635f13be5fe2b",9016:"9e180eda0e6b13ff8f5c",9076:"414ea27fa4f0cbc08df2",9114:"b3182ff6ebaad201f0aa",9301:"967db7c0326330cca35b",9373:"70f95962cfbca7a04af0",9511:"77c6a33a504e8471ef36",9596:"d7e025383e8b616956da",9706:"45a11f49644b2c8c9192",9744:"e4e40b92d8bf32f5638a",9840:"706c74c01b23e9896ddb"}[e]+".min.js",l.miniCssF=e=>{},l.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),l.hmd=e=>((e=Object.create(e)).children||(e.children=[]),Object.defineProperty(e,"exports",{enumerable:!0,set:()=>{throw new Error("ES Modules may not assign module.exports or exports.*, Use ESM export syntax, instead: "+e.id)}}),e),l.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),t={},l.l=(e,n,a,o)=>{if(t[e])t[e].push(n);else{var i,s;if(void 0!==a)for(var r=document.getElementsByTagName("script"),c=0;c<r.length;c++){var d=r[c];if(d.getAttribute("src")==e){i=d;break}}i||(s=!0,(i=document.createElement("script")).charset="utf-8",i.timeout=120,l.nc&&i.setAttribute("nonce",l.nc),i.src=e),t[e]=[n];var m=(n,a)=>{i.onerror=i.onload=null,clearTimeout(p);var l=t[e];if(delete t[e],i.parentNode&&i.parentNode.removeChild(i),l&&l.forEach((e=>e(a))),n)return n(a)},p=setTimeout(m.bind(null,void 0,{type:"timeout",target:i}),12e4);i.onerror=m.bind(null,i.onerror),i.onload=m.bind(null,i.onload),s&&document.head.appendChild(i)}},l.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},l.p="/",(()=>{l.b=document.baseURI||self.location.href;var e={179:0};l.f.j=(t,n)=>{var a=l.o(e,t)?e[t]:void 0;if(0!==a)if(a)n.push(a[2]);else{var o=new Promise(((n,l)=>a=e[t]=[n,l]));n.push(a[2]=o);var i=l.p+l.u(t),s=new Error;l.l(i,(n=>{if(l.o(e,t)&&(0!==(a=e[t])&&(e[t]=void 0),a)){var o=n&&("load"===n.type?"missing":n.type),i=n&&n.target&&n.target.src;s.message="Loading chunk "+t+" failed.\n("+o+": "+i+")",s.name="ChunkLoadError",s.type=o,s.request=i,a[1](s)}}),"chunk-"+t,t)}},l.O.j=t=>0===e[t];var t=(t,n)=>{var a,o,[i,s,r]=n,c=0;if(i.some((t=>0!==e[t]))){for(a in s)l.o(s,a)&&(l.m[a]=s[a]);if(r)var d=r(l)}for(t&&t(n);c<i.length;c++)o=i[c],l.o(e,o)&&e[o]&&e[o][0](),e[o]=0;return l.O(d)},n=globalThis.webpackChunk=globalThis.webpackChunk||[];n.forEach(t.bind(null,0)),n.push=t.bind(null,n.push.bind(n))})(),l.nc=void 0;var o=l.O(void 0,[9119],(()=>l(51514)));return o=l.O(o)})()));